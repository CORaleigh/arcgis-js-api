// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/pbf","./pbfDehydratedFeatureSet","./pbfOptimizedFeatureSet"],function(e,t,r,a,s,n,i){function l(e){return e>=v.length?null:v[e]}function g(e){return e>=D.length?null:D[e]}function c(e){return e>=x.length?null:x[e]}function o(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function u(e,t,r){for(var a=e.createPointGeometry(t);r.next();)switch(r.tag()){case 3:for(var s=r.getUInt32(),n=r.pos()+s,i=0;r.pos()<n;)e.addCoordinatePoint(a,r.getSInt64(),0,i++);break;case 1:case 2:default:r.skip()}return a}function p(e,t,r){for(var a=e.createGeometry(t),s=2+(t.hasZ?1:0)+(t.hasM?1:0);r.next();)switch(r.tag()){case 2:for(var n=r.getUInt32(),i=r.pos()+n,l=0;r.pos()<i;)e.addLength(a,r.getUInt32(),l++);break;case 3:for(var g=r.getUInt32(),i=r.pos()+g,c=0,o=0;r.pos()<i;)e.addCoordinate(a,r.getSInt64(),o,c),++c===s&&(o++,c=0);break;case 1:default:r.skip()}return a}function y(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function f(e){for(var t={type:l(0)};e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.type=l(e.getEnum());break;case 3:t.alias=e.getString();break;case 4:t.sqlType=g(e.getEnum());break;case 5:case 6:default:e.skip()}return t}function b(e,t,r,a){for(var s=e.createFeature(t),n=0;r.next();)switch(r.tag()){case 1:var i=a[n++].name;s.attributes[i]=y(r.getMessage());break;case 2:s.geometry=p(e,t,r.getMessage());break;case 4:s.centroid=u(e,t,r.getMessage());break;default:r.skip()}return s}function d(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function k(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function T(e){for(var t={originPosition:c(0)};e.next();)switch(e.tag()){case 1:t.originPosition=c(e.getEnum());break;case 2:t.scale=d(e.getMessage());break;case 3:t.translate=k(e.getMessage());break;default:e.skip()}return t}function h(e){for(var t={};e.next();)switch(e.tag()){case 1:t.shapeAreaFieldName=e.getString();break;case 2:t.shapeLengthFieldName=e.getString();break;case 3:t.units=e.getString();break;default:e.skip()}return t}function m(e,t){for(var r=e.createSpatialReference();t.next();)switch(t.tag()){case 1:r.wkid=t.getUInt32();break;case 5:r.wkt=t.getString();break;case 2:case 3:case 4:default:t.skip()}return r}function F(e,t){var r=e.createFeatureResult();r.geometryType=o(e,0);for(var a=!1;t.next();)switch(t.tag()){case 1:r.objectIdFieldName=t.getString();break;case 3:r.globalIdFieldName=t.getString();break;case 4:r.geohashFieldName=t.getString();break;case 5:r.geometryProperties=h(t.getMessage());break;case 7:r.geometryType=o(e,t.getEnum());break;case 8:r.spatialReference=m(e,t.getMessage());break;case 10:r.hasZ=t.getBool();break;case 11:r.hasM=t.getBool();break;case 12:r.transform=T(t.getMessage());break;case 9:var s=t.getBool();r.exceededTransferLimit=s;break;case 13:e.addField(r,f(t.getMessage()));break;case 15:a||(e.prepareFeatures(r),a=!0),e.addFeature(r,b(e,r,t.getMessage(),r.fields));break;case 2:case 6:default:t.skip()}return e.finishFeatureResult(r),r}function q(e,t){for(var r={};t.next();)switch(t.tag()){case 1:r.featureResult=F(e,t.getMessage());break;default:t.skip()}return r}function w(e){return e&&"dehydrated"===e.type?new n.Context(e):new i.Context(e)}function I(e,t){var a=w(t);try{for(var n=new s(new Uint8Array(e),new DataView(e)),i={};n.next();)switch(n.tag()){case 2:i.queryResult=q(a,n.getMessage());break;default:n.skip()}return i}catch(e){var l=new r("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});return S.error(l),{queryResult:{featureResult:a.createFeatureResult()}}}}Object.defineProperty(t,"__esModule",{value:!0});var S=a.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),v=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],D=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],x=["upperLeft","lowerLeft"];t.parseFeatureQuery=I});