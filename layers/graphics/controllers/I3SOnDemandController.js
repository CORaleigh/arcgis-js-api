// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/errors/CancelError","../../../core/Accessor","../../../core/arrayUtils","../../../core/Evented","../../../core/Handles","../../../core/has","../../../core/Logger","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../support/PromiseQueue","../../../views/3d/layers/i3s/I3SFrameTask","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/support/index","../../../views/3d/support/projectionUtils"],function(e,t,r,i,o,a,n,s,d,u,l,h,p,c,_,f,g,y,v,m,b,w,N,x,D,L,C,I){function O(e,t){return e.length===t.length&&e.every(function(e){return V(t,e.name)>=0})}function V(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}function S(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var P=l.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),A=function(e){function t(t){var r=e.call(this)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingPercentage=0,r.leafsReached=!1,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._downloadingNodes=new Set,r._loadingNodes=new Set,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._poi=y.vec3f64.create(),r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r.disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new d,r._idleQueue=new m.PromiseQueue,r._errorCount=0,r}return r(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(C.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return D.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return D.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.getNode(this._rootNodeId);return!e||!this._viewportQueries||(this._updateViewData(),this._viewportQueries.isNodeVisible(e))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new N(this.layerView,function(){return e.updatingChanged()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var r=this._rootNodeUrl.split("/");this._rootNodeId=r[r.length-1],this.disableIDBCache=u("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var i=c.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var t=e.layerView.view;e.setClippingArea(t.clippingArea),e._centerOnSurface=t.pointsOfInterest.centerOnSurfaceFrequent;var r=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),r.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),_.init(e.layerView,"suspended",function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},o=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=o):e._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(i,o)}),b.addTask(e.layerView.view.resourceController.scheduler,function(t,r){return e._frame(t,r),e._index?e._index.getPriority():-1/0}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),t.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("requiredFields",function(){return e._requiredFieldsChange()})]),e._viewportQueries=new L(e.crsIndex,t.renderCoordsHelper,t.state.camera,e._clippingArea,t.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(e.layer),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new w.I3SIndex(e.getBaseUrl(),e._rootNodeUrl,e._rootNodeId,e.streamDataSupplier,e._viewportQueries,P,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t)},function(t){return e._needsUpdate(t)})}});this.addResolvingPromise(i),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,F.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.requiredFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.requiredFields.map(function(r){var i=V(e,r),o=V(t,r);return i>=0&&o>=0?{index:i,name:t[o].name,field:t[o],attributeStorageInfo:e[i]}:null}).filter(function(e){return null!=e&&e.name!==r})},t.prototype._requiredFieldsChange=function(){O(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype.setClippingArea=function(e){var t=v.create();I.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=q.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=y.vec3f64.create();g.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,o=y.vec3f64.create();i.worldUpAtPosition(t,o);var a=g.vec3.angle(o,r)-.5*Math.PI;return g.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,a/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this._cameraDirty=!0,this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this.updatingChanged()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.getNode=function(e){return this._index?this._index.getNode(e):null},t.prototype.updateElevationChanged=function(e,t,r){r.clear();var i=this.getNode(this._rootNodeId);null!=i&&D.findIntersectingNodes(e,t,i,this.crsIndex,this._index,function(e){return r.push(e)});for(var o=0;o<r.length;o++){var a=r.data[o];this._viewportQueries.invalidateCache(a.id),a.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}r.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(){this._viewportQueries.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.updatingChanged()},t.prototype.schedule=function(e,t){var r=this;return this._idleQueue.push(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw new o;return t})},t.prototype.reschedule=function(e,t){var r=this;return this._idleQueue.unshift(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw new o;return t})},Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){if(this.layerView.suspended)return void this._updateView(e);this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty),this.layerView.visible&&this._processLogError(e,t)},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?P.error("Error during processing: "+e):50===this._errorCount&&P.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateView(e),e.run(function(){return r._processIndex(t,e)}),this._updateFeatureLOD(),e.run(function(){return r._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return r._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this.updatingChanged(),this._lodHandling.lodGlobalHandling(e)}},t.prototype._processIndex=function(e,t){var r=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));this._index.update(n.keysOfSet(this._loadingNodes),t);var i=this._index.getFeatureEstimate().leafsReached;return this._index.isLoading()||i===this._get("leafsReached")||this._set("leafsReached",i),this._index.load(r)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0||this._index.updates.add.length>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var o=this.lod,a=this._index.checkFeatureTarget(t,o);a!==o&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processNodes=function(e,t){var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNodeIdLoading,this),i.cancel=[];i.update.length>0&&!e.done;)this._updateLoadedNode(i.update.pop()),e.madeProgress();for(;i.add.length>0&&!e.done&&r>0&&(--r,!i.add.back().notInCache||this._hasNodeLoadToken(t));){var o=i.add.pop();this._loadNode(o),e.madeProgress()}return e.hasProgressed},t.prototype._cancelNodeLoading=function(){var e=this;this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.forEach(function(t,r){return e._updatingNodes.get(r).cancel()}),this._updatingNodes.clear()},t.prototype._cancelNodeIdLoading=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var r=t.numIndexLoading+this._index.getIndexLoading(),i=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*r-2*i)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype.updatingChanged=function(){var e=this._index?this._index.getIndexMissing():0,t=this._index?this._index.updates.add.length:0,r=e+3*t+2*this._loadingNodes.size,i=!(!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),i!==this._get("updating")&&this._set("updating",i);var o=100*r/this._progressMaxNumNodes;o!==this._get("updatingPercentage")&&this._set("updatingPercentage",o)},t.prototype._updateView=function(e){this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1)},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=y.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.progressiveLoadPenalty=q.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){return this.fixedFeatureTarget?1:2*Math.min(this.layerView.view.resourceController.memoryController.memoryFactor,.5)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._viewportQueries.isGeometryVisible(e)},t.prototype.updateVisibility=function(e){return this._viewportQueries.updateNode(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&(!e.obb||this._viewportQueries.isGeometryVisible(e))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return t<1&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.calcCameraDistance(e)>this._viewportQueries.maxDistance*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=x.TextureFormat.Normal;this.layerView.useCompressedTextures?t=x.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=x.TextureFormat.Downsampled);var r=this._defaultGeometrySchema,i={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==r||null==r.ordering};this._nodeLoader=new x(this.streamDataSupplier,P,r,this._requiredAttributes,i);var o=this.layerView.view.renderSpatialReference,a=this.crsIndex.equals(o)||this.crsIndex.isWGS84&&o.equals(I.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!a,this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._viewportQueries.isNodeVisible(t)},function(t){return e._viewportQueries.isGeometryVisible(t)},function(t){return e._index.nodeTraversalState(t)},function(t,r){return e._removeNodes(t,r)},this._index,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel}),this.updatingChanged()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._nodeLoader.cancelAll(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this.updatingChanged())},t.prototype._removeInvisibleNodes=function(e){var t=this.layerView.getLoadedNodeIDs();F.clear();for(var r=0,i=t;r<i.length;r++){var o=i[r],a=this.getNode(o);this._viewportQueries.isGeometryVisible(a)&&!this._shouldDropNode(a)||(this._lodHandling.setLodGlobalDirty(),F.push(a))}return this._removeNodes(F,e),0===F.length||(F.clear(),!1)},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate(),this.layerView.removeNodeData(e,t)},t.prototype._needsUpdate=function(e){if(null==e.featureData||0===e.featureData.length||this._updatingNodes.has(e.id))return!1;var t=this.layerView.getLoadedAttributes(e);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=this.layerView.getLoadedAttributes(e),i=O(r,this._requiredAttributes)?c.resolve(this.layerView.getAttributeData(e)):this._nodeLoader.loadAttributes(e,this._requiredAttributes);this._updatingNodes.set(e.id,i),i.then(function(r){return t.schedule(e.id).then(function(){return t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:r})})}).catch(function(r){r instanceof o||t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.id),t.updatingChanged()}),this.updatingChanged()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id),this.updatingChanged(),this._loadAndAddBundle(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.id),t.updatingChanged()})},t.prototype._loadAndAddBundle=function(e){var t=this;return 1!==e.featureData.length&&P.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded."),e.notInCache?this._loadUncached(e):this._loadCached(e).then(function(r){r||(e.notInCache=!0,t._index.updates.add.push(e))}).catch(function(t){t instanceof o||(e.notInCache=!0)})},t.prototype._enableFromGPUCache=function(e){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var t=this.layerView.loadCachedGPUData(e);return!!(t&&S(t.attributeInfo)&&O(t.attributeInfo.loadedAttributes,this._requiredAttributes))&&(this.layerView.addCachedGPUData(e,t),this._nodeAdded(e),!0)},t.prototype._nodeAdded=function(e){this._index.requestUpdate(),this._lodHandling.lodSwapBundleLoaded(e)},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e))return c.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule(e.id).then(function(){return r.loadCachedNodeData(e,function(e,r){return t._nodeLoader.loadTextures(e,r)})}).then(function(i){if(null==i)return!1;var o=t._requiredAttributes;return S(i)&&O(i.loadedAttributes,o)?t.reschedule(e.id).then(function(){return r.addCachedNodeData(e,i,i)}).then(function(){return t._nodeAdded(e),!0}):t.reschedule(e.id).then(function(){return t._nodeLoader.loadAttributes(e,o)}).then(function(r){return t.reschedule(e.id,{loadedAttributes:o,attributeData:r})}).then(function(t){return r.addCachedNodeData(e,i,t)}).then(function(){return t._nodeAdded(e),!0})}):c.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.id),this._nodeLoader.loadBundleData(e,0).then(function(r){return t._downloadingNodes.delete(e.id),t.schedule(e.id,r)}).then(function(r){return t.layerView.addNodeData(e,r)}).then(function(){t._nodeAdded(e),e.notInCache=!1}).catch(function(r){r instanceof o||(P.error("Failed to load node '"+e.id+"' bundle 0: "+r),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._viewportQueries&&this._viewportQueries.setCameraIdle(e),this.updatingChanged(),e&&this._index&&this._index.resetFailedNodes())},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),i([f.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),i([f.property({readOnly:!0})],t.prototype,"isGraphics3D",null),i([f.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),i([f.property({readOnly:!0})],t.prototype,"crsVertex",null),i([f.property({readOnly:!0})],t.prototype,"crsIndex",null),i([f.property()],t.prototype,"camPos",void 0),i([f.property()],t.prototype,"screenSizeFactor",void 0),i([f.property()],t.prototype,"featureTarget",void 0),i([f.property()],t.prototype,"fixedFeatureTarget",void 0),i([f.property()],t.prototype,"layerView",void 0),i([f.property()],t.prototype,"layer",void 0),i([f.property({readOnly:!0})],t.prototype,"updating",void 0),i([f.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),i([f.property({readOnly:!0})],t.prototype,"leafsReached",void 0),i([f.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),i([f.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),t=i([f.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(f.declared(a,p,s)),F=new h,q={factorIM:.2,factor3dObject:.05,distancePenalty:10};return A});