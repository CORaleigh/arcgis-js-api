// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","@dojo/framework/shim/Set","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils"],function(e,t,r,i,s,a,n,o,u,l,c,m,p,f){Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsMap=r.fieldsMap,this.timeInfo=r.timeInfo}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){var t;if(e.outStatistics){t=e.outStatistics.some(function(e){return"exceedslimit"===e.statisticType})?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(o.isValid(e.outSR)&&!o.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=f.cleanFromGeometryEngine(r({spatialReference:e.outSR},m.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=f.cleanFromGeometryEngine(r({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var r=c.getWhereClause(t.where);if(!r)return a.resolve(this);if(r.isStandardized()){for(var i=0,s=[],n=0,o=this.items;n<o.length;n++){var u=o[n];r.testFeature(u.attributes)&&(s[i++]=u)}var l=new e(s,this.queryGeometry,this);return l.definitionExpression=t.where,a.resolve(l)}return a.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return a.resolve(this);var r=new i.default(t.objectIds);return a.resolve(new e(this.items.filter(function(e){return r.has(e.objectId)}),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var r=p.getTimeOperator(this.timeInfo,t.timeExtent);if(!s.isSome(r))return a.resolve(this);var i=this.items.filter(r);return a.resolve(new e(i,this.queryGeometry,this))},e.prototype.project=function(t){var r=this;return!t||o.equals(this.spatialReference,t)?a.resolve(this):m.projectMany(this.items.map(function(e){return f.getGeometry(r,e)}),this.spatialReference,t).then(function(i){for(var s=[],a=0;a<r.items.length;a++)s[a]={attributes:r.items[a].attributes,geometry:i[a]};var n=[];return u.convertFromFeatures(n,s,r.geometryType,r.hasZ,r.hasM,r.objectIdField),new e(n,r.queryGeometry,{definitionExpression:r.definitionExpression,geometryType:r.geometryType,hasM:r.hasM,hasZ:r.hasZ,objectIdField:r.objectIdField,spatialReference:t,fieldsMap:r.fieldsMap,timeInfo:r.timeInfo})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,r=this.items,i=this,s=i.geometryType,a=i.hasM,o=i.hasZ,u=i.objectIdField,l=i.spatialReference,c=e.outFields,m=e.outSR,p=e.quantizationParameters,h=e.resultRecordCount,y=e.resultOffset,d=!1;if(null!=h&&null!=y){var v=y+h;d=r.length>v,r=r.slice(y,Math.min(r.length,v))}return{exceededTransferLimit:d,features:this._createFeatures(e,r),fields:c&&c.map(function(e){return t.fieldsMap.get(e)}),geometryType:s,hasM:a,hasZ:o,objectIdFieldName:u,spatialReference:f.cleanFromGeometryEngine(m||l),transform:p&&n.toQuantizationTransform(p)||null}},e.prototype._createFeatures=function(e,t){var r=new l.default(e,this.fieldsMap),i=e.quantizationParameters,s=e.returnGeometry,a=e.returnCentroid,o=e.maxAllowableOffset,u=e.orderByFields,c=[],m=0;if(t.length&&u&&u.length){var p=u[0].split(" "),h=p[0],y="DESC"===p[1];t.sort(function(e,t){var i=r.getFieldValue(e,h),s=r.getFieldValue(t,h);if("number"==typeof i&&"number"==typeof s)return y?s-i:i-s;if("string"==typeof i&&"string"==typeof s){var a=i.toUpperCase(),n=s.toUpperCase();return(y?a>n:a<n)?-1:(y?a<n:a>n)?1:0}})}if(s||a){var d=n.toQuantizationTransform(i);if(s&&!a)for(var v=0,g=t;v<g.length;v++){var I=g[v];c[m++]={attributes:r.getAttributes(I),geometry:f.getGeometry(this,I,o,d)}}else if(!s&&a)for(var b=0,T=t;b<T.length;b++){var I=T[b];c[m++]={attributes:r.getAttributes(I),centroid:f.getCentroid(this,I,d)}}else for(var F=0,S=t;F<S.length;F++){var I=S[F];c[m++]={attributes:r.getAttributes(I),centroid:f.getCentroid(this,I,d),geometry:f.getGeometry(this,I,o,d)}}}else for(var x=0,N=t;x<N.length;x++){var I=N[x],R=r.getAttributes(I);R&&(c[m++]={attributes:R})}return c},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=0,n=e.outStatistics;a<n.length;a++){var o=n[a];if("exceedslimit"===o.statisticType){r=null!=o.maxPointCount?o.maxPointCount:Number.POSITIVE_INFINITY,i=null!=o.maxRecordCount?o.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=o.maxVertexCount?o.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>i)t=!0;else{var u=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.items.reduce(function(e,t){return e+(t.geometry&&t.geometry.coords.length||0)},0)/u;t=l>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=new l.default(e,this.fieldsMap),r=e.outStatistics,i=[],s=[],a=e.groupByFieldsForStatistics,n=e.having,o=a&&a.length,u=o&&a[0],c={},m={},p={},f={attributes:{}},h=0,y=r;h<y.length;h++){var d=y[h],v=d.outStatisticFieldName,g=d.statisticType,I="exceedslimit"!==d.statisticType?d.onStatisticField:void 0,b="1"===I;if(o&&(I===u||b)&&"count"===d.statisticType){c[I]||(c[I]=this._calculateUniqueValues(t,b?u:I));var T=c[I];for(var F in T){var S=T[F],x=S.count,N=S.data,R=S.items,_=m[N]||{attributes:{}};n&&!t.validateItems(R,n)||(_.attributes[v]=x,_.attributes[b?"EXPR_1":I]=N,m[N]=_)}s.push({name:v,alias:v,type:"esriFieldTypeString"})}else{if(o){var q=this._calculateUniqueValues(t,u);for(var F in q){var E=q[F],N=E.data,R=E.items;if(!n||t.validateItems(R,n)){var _=m[N]||{attributes:{}},M=this._calculateStatistics(R,t,I),G="var"===g?"variance":g;_.attributes[v]=M[G],_.attributes[u]=N,m[N]=_}}}else{p[I]||(p[I]=this._calculateStatistics(this.items,t,I));var M=p[I],G="var"===g?"variance":g;f.attributes[v]=M[G]}s.push({name:v,alias:v,type:"esriFieldTypeDouble"})}}if(o)for(var j in m)i.push(m[j]);else i.push(f);return{fields:s,features:i}},e.prototype._calculateStatistics=function(e,t,r){for(var i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,a=null,n=null,o=null,u=null,l=[],c=0;c<e.length;c++){var m=e[c],p=t.getFieldValue(m,r);null==p||isNaN(p)||(a+=p,i=Math.min(i,p),s=Math.max(s,p),l.push(p))}var f=l.length;if(f){n=a/f;for(var h=0,y=0,d=l;y<d.length;y++){var p=d[y];h+=Math.pow(p-n,2)}u=f>1?h/(f-1):0,o=Math.sqrt(u)}else i=null,s=null;return{avg:n,count:f,max:s,min:i,stddev:o,sum:a,variance:u}},e.prototype._calculateUniqueValues=function(e,t){for(var r={},i=0,s=this.items;i<s.length;i++){var a=s[i],n=e.getFieldValue(a,t);(null==n||"string"==typeof n&&""===n.trim())&&(n=null),null==r[n]?r[n]={count:1,data:n,items:[a]}:(r[n].count++,r[n].items.push(a))}return r},e}();t.default=h});