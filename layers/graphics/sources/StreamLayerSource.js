// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["../../../core/declare","../../../core/Accessor","../../../core/Promise","../../../core/lang","../../../core/urlUtils","../../../core/promiseUtils","../../../geometry/Extent","../../support/WebSocketConnector","../../../tasks/QueryTask","../../../request"],function(e,r,t,n,i,s,o,a,l,u){return e([r,t],{declaredClass:"esri.layers.graphics.sources.StreamLayerSource",constructor:function(e){var r=e&&e.layer;r&&(this.url=r.url)},initialize:function(){this.addResolvingPromise(this._fetchLayers())},properties:{connectionInfo:{get:function(){if(this.layer.hasMemorySource||this.layer.socketUrl)return{serviceSocketUrls:[this.layer.socketUrl]};if(this.layerDefinition){var e,r,t,n,s={},o=this.layerDefinition,a=[],l=[],u=[];if(o.streamUrls&&o.streamUrls.forEach(function(e){"ws"===e.transport&&(a=e.urls,s.token=e.token)},this),a.forEach(function(e){0===e.lastIndexOf("wss",0)?u.push(e):l.push(e)}),(e="https"===i.appUrl.scheme||0===this.url.lastIndexOf("https:",0)?u:0===l.length?u:l)&&e.length>1)for(r=0;r<e.length-1;r++)t=r+Math.floor(Math.random()*(e.length-r)),n=e[t],e[t]=e[r],e[r]=n;return s.serviceSocketUrls=e,s}}},latestUrl:{get:function(){var e=this.layerDefinition,r=e.keepLatestArchive&&e.keepLatestArchive.featuresUrl;return r=r||null}},latestQueryTask:{get:function(){var e=this.latestUrl;return e?new l(e):null}},layer:{},relatedFeaturesInfo:{get:function(){var e=this.layerDefinition||{},r=e.relatedFeatures;return r=r&&r.featuresUrl?r:null}},relatedFeaturesQueryTask:{get:function(){var e=this.relatedFeaturesInfo,r=e?e.featuresUrl:null;return r?new l(r):null}},parsedUrl:{get:function(){return this.url?i.urlToObject(this.url):null}},url:null},createWebSocketConnector:function(e){var r={};return r.promise=s.create(function(e,t){r.resolve=e,r.reject=t}),this.when(function(){var t,i,s,o,l=this.connectionInfo,u=this.layer.spatialReference,c={};try{t=this.makeFilter()}catch(e){return void r.reject(e)}if(l){if(l.socketUrl?s=[l.socketUrl]:l.serviceSocketUrls&&(s=l.serviceSocketUrls.map(function(e){return e+"/"+this.layer.socketDirection}.bind(this))),c.socketUrls=s,t&&(t.where||t.geometry||t.outFields)){var h=t.geometry;h&&"string"!=typeof h&&(h=h.toJSON?JSON.stringify(h.toJSON()):JSON.stringify(h)),i=n.mixin(i||{},{where:t.where,geometry:h,outFields:t.outFields})}l.token&&(i=n.mixin(i||{},{token:l.token})),e&&u&&e.wkid!==u.wkid&&(i=n.mixin(i||{},{outSR:e.wkid})),c.queryParams=i,c.layerSource=this,o=new a(c),r.resolve(o)}else r.reject(new Error("No web socket urls found"))}.bind(this)),r.promise},getWebSocketToken:function(){return this._fetchStreamLayer().then(function(e){var r=e.data,t=null;return r.streamUrls&&r.streamUrls.some(function(e){if("ws"===e.transport)return t=e.token,!0},this),t}.bind(this))},makeFilter:function(e){var r,t=this.layer,i=null;if(e){var s;if(r={},e.hasOwnProperty("where")&&(r.where=e.where),e.hasOwnProperty("geometry")){if((s=e.geometry)&&!s.hasOwnProperty("xmin"))throw new Error("Cannot make filter. Only Extent is supported for the geometry filter");s&&!s.declaredClass&&(s=new o(s)),r.geometry=s}}else{var a=t.filter||{};r={where:a.where,geometry:a.geometry};var l=this.relatedFeaturesInfo&&this.relatedFeaturesInfo.outFields||t.outFields;if(l&&-1===l.indexOf("*")){var u=t.fields.map(function(e){return e.name});i=l.filter(function(e){return-1!==u.indexOf(e)}).join(","),r=n.mixin(r||{},{outFields:i})}}return r},queryFeatures:function(e,r){return s.reject()},_fetchLayers:function(){return this._fetchStreamLayer().then(function(e){return e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.layerDefinition=e.data,this._fetchArchiveLayer()}.bind(this)).then(function(e){return this.archivedLayerDefinition=e&&e.data,this._fetchRelatedLayer()}.bind(this)).then(function(e){this.relatedLayerDefinition=e&&e.data}.bind(this))},_fetchStreamLayer:function(){return this._requestServiceDefinition({url:this.layer.parsedUrl.path,content:n.mixin({f:"json"},this.layer.parsedUrl.query)})},_fetchArchiveLayer:function(){var e=this.latestUrl;return e?this._requestServiceDefinition({url:e}):s.resolve()},_fetchRelatedLayer:function(){var e=this.relatedFeaturesInfo;return e?this._requestServiceDefinition({url:e.featuresUrl}):s.resolve()},_requestServiceDefinition:function(e){return e&&e.url?u(e.url,{query:n.mixin(e.content||{},{f:"json"}),responseType:"json"}):s.reject(new Error("url is a required options property"))}})});