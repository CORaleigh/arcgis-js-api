// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../geometry","../../../Graphic","../../../core/Accessor","../../../core/Collection","../../../core/Error","../../../core/has","../../../core/Loadable","../../../core/Logger","../../../core/promiseUtils","../../../core/requireUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/typescript","../../../tasks/support/FeatureSet","module"],function(e,t,r,o,n,i,a,u,s,p,l,c,y,d,h,f,g,m,v,_){Object.defineProperty(t,"__esModule",{value:!0});var b=0,F=c.getLogger("esri.layers.graphics.sources.MemorySource"),T=function(t){function a(){var e=null!==t&&t.apply(this,arguments)||this;return e._idToClientGraphic=null,e.type="memory",e}return r(a,t),a.prototype.load=function(){var t,r=this;return t=p("esri-webpack")?y.create(function(t){return e(["./support/MemorySourceWorker"],t)}):y.resolve(),this.addResolvingPromise(t.then(function(){return h.open(d.getAbsMid("./support/MemorySourceWorker",e,_),{strategy:p("esri-workers-for-memory-layers")?"dedicated":"local"}).then(function(e){r._connection=e;var t=r.layer,o=t.fields,i=t.spatialReference,a=t.objectIdField,u=t.hasM,s=t.hasZ,p=t.timeInfo,l="defaults"===r.layer.originOf("spatialReference"),c=r._prepareAddFeatures(r.items);r.on("before-changes",function(e){F.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),e.preventDefault()});var y={features:c.features,fields:o&&o.map(function(e){return e.toJSON()}),geometryType:n.typeKebabDictionary.toJSON(r.workerGeometryType),hasM:u,hasZ:s,objectIdField:a,spatialReference:l?null:i&&i.toJSON(),timeInfo:p?p.toJSON():null};return e.invoke("load",y).then(function(e){for(var t=0,o=e.warnings;t<o.length;t++){var i=o[t];F.warn(i.message,{layer:r.layer})}e.featureErrors.length&&F.warn("Encountered "+e.featureErrors.length+" validation errors while loading features",e.featureErrors);var a=e.layerDefinition;r._geometryTypeRequiresClientGraphicMapping(c.inferredGeometryType)&&(a.geometryType=n.typeKebabDictionary.toJSON(c.inferredGeometryType)),r.layerDefinition=a,r._requiresClientGraphicMapping()&&(r._idToClientGraphic=new Map),c.finish(e.assignedObjectIds)})})})),this.when()},Object.defineProperty(a.prototype,"workerGeometryType",{get:function(){var e=this.layer&&this.layer.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null},enumerable:!0,configurable:!0}),a.prototype.applyEdits=function(e){var t=this;return this.load().then(function(){return t._applyEdits(e)})},a.prototype.openPorts=function(){var e=this;return this.load().then(function(){return e._connection.openPorts()})},a.prototype.queryFeatures=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryFeatures",e?e.toJSON():null)}).then(function(e){var r=v.fromJSON(e);if(!t._requiresClientGraphicMapping())return r;for(var o=t.layer.objectIdField,n=0,i=r.features;n<i.length;n++){var a=i[n],u=a.attributes[o],s=t._idToClientGraphic.get(u);s&&(a.geometry=s.geometry)}return r.geometryType=t.layer.geometryType,r})},a.prototype.queryFeaturesJSON=function(e){var t=this;return this._requiresClientGraphicMapping()?y.reject(new s("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)")):this.load().then(function(){return t._connection.invoke("queryFeatures",e?e.toJSON():null)})},a.prototype.queryFeatureCount=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryFeatureCount",e?e.toJSON():null)})},a.prototype.queryObjectIds=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryObjectIds",e?e.toJSON():null)})},a.prototype.queryExtent=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryExtent",e?e.toJSON():null)}).then(function(e){return{count:e.count,extent:n.Extent.fromJSON(e.extent)}})},a.prototype._applyEdits=function(e){var t=this;if(!this._connection)throw new s("feature-layer-source:edit-failure","Memory source not loaded");var r=this.layer.objectIdField,o=null,n=[],i=[];if(e.addFeatures&&(o=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(var a=0,u=e.deleteFeatures;a<u.length;a++){var p=u[a];"objectId"in p&&null!=p.objectId?n.push(p.objectId):"attributes"in p&&null!=p.attributes[r]&&n.push(p.attributes[r])}if(e.updateFeatures)for(var l=0,c=e.updateFeatures;l<c.length;l++){var p=c[l];i.push(this._serializeFeature(p))}return this._connection.invoke("applyEdits",{adds:o?o.features:[],updates:i,deletes:n}).then(function(e){var r=e.fullExtent,n=e.featureEditResults;if(t.fullExtent=r,o&&o.finish(n.uidToObjectId),t._idToClientGraphic)for(var i=0,a=n.deleteResults;i<a.length;i++){var u=a[i];u.success&&t._idToClientGraphic.delete(u.objectId)}return t._createEditsResult(n)})},a.prototype._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[]}},a.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new s("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},a.prototype._prepareAddFeatures=function(e){for(var t=new Map,r=new Array(e.length),o=null,n=0;n<e.length;n++){var i=e[n],a=this._serializeFeature(i);!o&&i.geometry&&(o=i.geometry.type),r[n]=a,t.set(""+a.uid,i)}var u=this;return{features:r,inferredGeometryType:o,finish:function(e){var r=u.layerDefinition.objectIdField;for(var o in e){var n=e[o],i=t.get(o);i&&(i.attributes||(i.attributes={}),-1===n?delete i.attributes[r]:i.attributes[r]=n,u._addIdToClientGraphic(i))}}}},a.prototype._addIdToClientGraphic=function(e){if(this._idToClientGraphic){var t=this.layerDefinition.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)}},a.prototype._requiresClientGraphicMapping=function(){var e=this.layer.geometryType||this.layerDefinition.geometryType;return this._geometryTypeRequiresClientGraphicMapping(e)},a.prototype._geometryRequiresClientGraphicMapping=function(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)},a.prototype._geometryTypeRequiresClientGraphicMapping=function(e){return"mesh"===e||"multipatch"===e||"extent"===e},a.prototype._serializeFeature=function(e){var t=e.attributes,r=this._geometryForSerialization(e),o=(b++).toString();return r?{uid:o,geometry:r.toJSON(),attributes:t}:{uid:o,attributes:t}},a.prototype._geometryForSerialization=function(e){var t=e.geometry;return t?this._geometryRequiresClientGraphicMapping(t)?n.Polygon.fromExtent(t.extent):t:null},o([m.shared({Type:i,ensureType:g.ensureType(i)})],a.prototype,"itemType",void 0),o([f.property()],a.prototype,"type",void 0),o([f.property({constructOnly:!0})],a.prototype,"layer",void 0),o([f.property({readOnly:!0,dependsOn:["layer.geometryType"]})],a.prototype,"workerGeometryType",null),o([f.property()],a.prototype,"layerDefinition",void 0),a=o([f.subclass("esri.layers.graphics.sources.MemorySource")],a)}(f.declared(a,u,l));t.MemorySource=T,t.default=T});