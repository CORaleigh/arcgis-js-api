// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/awaiterHelper","../../../../request","../../../../core/Error","../../../../core/promiseUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../featureConversionUtils","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./geojson","../support/clientSideDefaults","../../../support/fieldType","../../../support/fieldUtils"],function(e,t,i,r,n,s,a,o,u,l,d,p,f,y,c,h,g,m){Object.defineProperty(t,"__esModule",{value:!0});var b={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}},F=function(){function e(){this.code=null,this.description=null}return e}(),_=function(){function e(e){this.error=new F,this.globalId=null,this.objectId=null,this.success=!1,this.uniqueId=null,this.error.description=e}return e}(),I=function(){function e(e){this.globalId=null,this.success=!0,this.objectId=this.uniqueId=e}return e}(),v=function(){function e(){this._queryEngine=null,this._featuresInfo=null,this._fieldsMap=new Map}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._featuresInfo=this._requiredFieldNames=this._fieldsMap=this._createDefaultAttributes=null},e.prototype.load=function(e){return n(this,void 0,void 0,function(){var t,n,u,F,_,I,v,j,E,T,q,w,x,D,S,R,O,M,S,k,A,C,Q,G,P,Z,U,L;return i(this,function(i){switch(i.label){case 0:return t=[],[4,this._checkProjection(e.spatialReference)];case 1:return i.sent(),n=null,e.url?[4,s(e.url,{responseType:"json"})]:[3,4];case 2:return u=i.sent(),n=u.data,[4,c.validateGeoJSON(n)];case 3:i.sent(),i.label=4;case 4:if(F=c.inferLayerProperties(n,{geometryType:e.geometryType}),_=e.fields||F.fields||[],I=null!=e.hasZ?e.hasZ:F.hasZ,v=F.geometryType,j=e.objectIdField||"OBJECTID",E=e.spatialReference||l.WGS84,T=e.timeInfo,!v)return[2,o.reject(new a("geojson-layer:missing-property","geometryType not set and couldn't be inferred from the provided features"))];for("string"===F.objectIdFieldType&&t.push({type:"geojson-layer:unsupported-id-type",message:"Feature ids are of type string and can't be honored."}),_===F.fields&&F.unknownFields.length>0&&t.push({type:"geojson-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:F.unknownFields}}),j&&(q=null,w=_.some(function(e){return e.name===j&&(q=e,!0)}),w?(q.type="esriFieldTypeOID",q.editable=!1,q.nullable=!1):_.unshift({alias:j,name:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})),x=0,D=_;x<D.length;x++){if(S=D[x],null==S.name&&(S.name=S.alias),null==S.alias&&(S.alias=S.name),!S.name)return[2,o.reject(new a("geojson-layer:invalid-field-name","field name is missing",{field:S}))];if(S.name===j&&(S.type="esriFieldTypeOID"),-1===g.kebabDict.jsonValues.indexOf(S.type))return[2,o.reject(new a("geojson-layer:invalid-field-type",'invalid type for field "'+S.name+'"',{field:S}))]}for(R={},this._requiredFieldNames=[],O=0,M=_;O<M.length;O++)S=M[O],"esriFieldTypeOID"!==S.type&&"esriFieldTypeGlobalID"!==S.type&&(S.editable=null==S.editable||!!S.editable,S.nullable=null==S.nullable||!!S.nullable,k=m.getFieldDefaultValue(S),S.nullable||void 0!==k?R[S.name]=k:this._requiredFieldNames.push(S.name)),this._fieldsMap.set(S.name.trim(),S),this._fieldsMap.set(S.name.trim().toLowerCase(),S);if(T&&(T.startTimeField&&(A=this._fieldsMap.get(T.startTimeField.toLowerCase()),A?(T.startTimeField=A.name,A.type="esriFieldTypeDate"):T.startTimeField=null),T.endTimeField&&(C=this._fieldsMap.get(T.endTimeField.toLowerCase()),C?(T.endTimeField=C.name,C.type="esriFieldTypeDate"):T.endTimeField=null),T.trackIdField&&(Q=this._fieldsMap.get(T.trackIdField.toLowerCase()),Q?T.trackIdField=Q.name:(T.trackIdField=null,t.push({type:"geojson-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:T}}))),T.startTimeField||T.endTimeField||(t.push({type:"geojson-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:T}}),T=null)),G={warnings:t,featureErrors:[],layerDefinition:r({},b,{drawingInfo:h.createDrawingInfo(v),templates:h.createDefaultTemplate(R),extent:null,geometryType:v,objectIdField:j,fields:_,hasZ:!!I,timeInfo:T})},this._queryEngine=new y.default({fields:_,geometryType:v,hasM:!1,hasZ:I,objectIdField:j,spatialReference:E,timeInfo:T,featureStore:new p.default({geometryType:v,hasM:!1,hasZ:I})}),this._createDefaultAttributes=h.createDefaultAttributesFunction(R,j),this._featuresInfo={nextObjectId:F.maxObjectId+1,geometryType:v,hasZ:I,ignoreIds:"string"===F.objectIdFieldType},P=c.createOptimizedFeatures(n,this._featuresInfo),!l.equals(E,l.WGS84))for(Z=0,U=P;Z<U.length;Z++)L=U[Z],L.geometry&&(L.geometry=d.convertFromGeometry(f.project(d.convertToGeometry(L.geometry,v,I,!1),l.WGS84,E)));return this._loadInitialFeatures(G,P),[2,G]}})})},e.prototype.applyEdits=function(e){var t=this,i=this._queryEngine.spatialReference;return f.checkProjectionSupport(e.adds,i).then(function(){return f.checkProjectionSupport(e.updates,i)}).then(function(){return t._applyEdits(e)})},e.prototype.queryFeatures=function(e){return this._queryEngine.executeQuery(e)},e.prototype.queryFeatureCount=function(e){return this._queryEngine.executeQueryForCount(e)},e.prototype.queryObjectIds=function(e){return this._queryEngine.executeQueryForIds(e)},e.prototype.queryExtent=function(e){return this._queryEngine.executeQueryForExtent(e)},e.prototype._loadInitialFeatures=function(e,t){for(var i=this._queryEngine.featureStore,r=[],n=0,s=t;n<s.length;n++){var a=s[n],o=this._createDefaultAttributes(),u=this._mixAttributes(o,a.attributes,!0);u?e.featureErrors.push(u):(this._assignObjectId(o,a.attributes,!0),a.attributes=o,r.push(a))}if(i.addMany(r),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){var l=this._queryEngine.timeExtent,d=l.start,p=l.end;e.layerDefinition.timeInfo.timeExtent=[d,p]}return e},e.prototype._applyEdits=function(e){var t=e.adds,i=e.updates,r=e.deletes,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(n,t),i&&i.length&&this._applyUpdateEdits(n,i),r&&r.length){for(var s=0,a=r;s<a.length;s++){var o=a[s];n.deleteResults.push(new I(o))}this._queryEngine.featureStore.removeManyById(r)}return{fullExtent:this._queryEngine.fullExtent,timeExtent:this._queryEngine.timeExtent,featureEditResults:n}},e.prototype._applyAddEdits=function(e,t){for(var i=e.addResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,a=r.hasZ,o=r.objectIdField,l=r.spatialReference,p=r.featureStore,y=[],c=0,h=t;c<h.length;c++){var g=h[c];if(g.geometry&&n!==u.getJsonType(g.geometry))i.push(new _("Incorrect geometry type."));else{var m=this._createDefaultAttributes(),b=this._mixAttributes(m,g.attributes);if(b)i.push(b);else{if(this._assignObjectId(m,g.attributes),g.attributes=m,null!=g.uid){var F=g.attributes[o];e.uidToObjectId[g.uid]=F}g.geometry&&(g.geometry=f.project(g.geometry,g.geometry.spatialReference,l)),y.push(g),i.push(new I(g.attributes[o]))}}}p.addMany(d.convertFromFeatures([],y,n,a,s,o))},e.prototype._applyUpdateEdits=function(e,t){for(var i=e.updateResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,a=r.hasZ,o=r.objectIdField,l=r.spatialReference,p=r.featureStore,y=0,c=t;y<c.length;y++){var h=c[y],g=h.attributes,m=h.geometry,b=g&&g[o];if(null!=b)if(p.has(b)){var F=d.convertToFeature(p.getFeature(b),n,a,s);if(m){if(n!==u.getJsonType(m)){i.push(new _("Incorrect geometry type."));continue}F.geometry=f.project(m,m.spatialReference,l)}if(g){var v=this._mixAttributes(F.attributes,g);if(v){i.push(v);continue}}p.add(d.convertFromFeature(F,n,a,s,o)),i.push(new I(b))}else i.push(new _("Feature with object id "+b+" missing"));else i.push(new _("Identifier field "+o+" missing"))}},e.prototype._assignObjectId=function(e,t,i){void 0===i&&(i=!1);var r=this._queryEngine.objectIdField;i&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._featuresInfo.nextObjectId++},e.prototype._mixAttributes=function(e,t,i){void 0===i&&(i=!1);for(var r in t){var n=m.sanitizeNullFieldValue(t[r]),s=this._fieldsMap.get(r)||this._fieldsMap.get(r.toLowerCase());if(s&&(i||s.editable)){var a=m.validateFieldValue(s,n);if(a)return new _(m.validationErrorToString(a,s,n));e[s.name]=n}}for(var o=0,u=this._requiredFieldNames;o<u.length;o++){var l=u[o];if(void 0===e[l])return new _('missing required field "'+l+'"')}return null},e.prototype._checkProjection=function(e){return f.checkProjectionSupport(l.WGS84,e).catch(function(){throw new a("geojson-layer","Projection not supported")})},e}();t.default=v});