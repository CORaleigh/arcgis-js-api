// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../core/JSONSupport","../../core/kebabDictionary","../../core/unitUtils","../../core/accessorSupport/decorators","../../core/accessorSupport/ensureType","../../geometry/support/aaBoundingRect","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","./LOD"],function(e,t,r,o,i,n,l,s,a,p,c,u,f,y,v){var d=new s.default({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc"});return function(e){function t(t){var r=e.call(this)||this;return r.dpi=96,r.format=null,r.origin=null,r.minScale=0,r.maxScale=0,r.size=null,r.spatialReference=null,r}o(t,e),l=t,t.create=function(e){void 0===e&&(e={size:256,spatialReference:n.SpatialReference.WebMercator});var t=e.resolutionFactor||1,r=e.scales,o=e.size||256,i=e.spatialReference||n.SpatialReference.WebMercator;if(!f.isValid(i)){for(var s=[],p=5e-4,c=23;c>=0;c--)s.unshift({level:c,scale:p,resolution:p}),p*=2;return new l({dpi:96,lods:s,origin:new n.Point(0,0,i),size:o,spatialReference:i})}var u=f.getInfo(i),y=u?new n.Point(u.origin[0],u.origin[1],i):new n.Point(0,0,i),v=a.getMetersPerUnitForSR(i),d=1/(39.37*v*96),h=[];if(r)for(var c=0;c<r.length;c++){var g=r[c],p=g*d;h.push({level:c,scale:g,resolution:p})}else{var m=f.isGeographic(i)?512/o*591657527.5917094:256/o*591657527.591555,w=Math.ceil(24/t);h.push({level:0,scale:m,resolution:m*d});for(var c=1;c<w;c++){var g=m/Math.pow(2,t),p=g*d;h.push({level:c,scale:g,resolution:p}),m=g}}return new l({dpi:96,lods:h,origin:y,size:o,spatialReference:i})},Object.defineProperty(t.prototype,"isWrappable",{get:function(){var e=this,t=e.spatialReference,r=e.origin;if(t&&r){var o=f.getInfo(t);return t.isWrappable&&Math.abs(o.origin[0]-r.x)<=o.dx}return!1},enumerable:!0,configurable:!0}),t.prototype.readOrigin=function(e,t){return n.Point.fromJSON(r({spatialReference:t.spatialReference},e))},Object.defineProperty(t.prototype,"lods",{set:function(e){var t=this,r=0,o=0,i=[];this._levelToLOD={},e&&(r=-1/0,o=1/0,e.forEach(function(e){i.push(e.scale),r=e.scale>r?e.scale:r,o=e.scale<o?e.scale:o,t._levelToLOD[e.level]=e})),this._set("scales",i),this._set("minScale",r),this._set("maxScale",o),this._set("lods",e),this._initializeUpsampleLevels()},enumerable:!0,configurable:!0}),t.prototype.readSize=function(e,t){return[t.cols,t.rows]},t.prototype.writeSize=function(e,t){t.cols=e[0],t.rows=e[0]},t.prototype.zoomToScale=function(e){var t=this.scales;if(e<=0)return t[0];if(e>=t.length)return t[t.length-1];var r=Math.round(e-.5),o=Math.round(e);return t[o]+(o-e)*(t[r]-t[o])},t.prototype.scaleToZoom=function(e){for(var t=this.scales,r=t.length-1,o=0;o<r;o++){var i=t[o],n=t[o+1];if(i<=e)return o;if(n===e)return o+1;if(i>e&&n<e)return o+1-(e-n)/(i-n)}return o},t.prototype.snapScale=function(e,t){void 0===t&&(t=.95);var r=this.scaleToZoom(e);return r%Math.floor(r)>=t?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))},t.prototype.tileAt=function(e,t,r,o){var i=this.lodAt(e);if(!i)return null;var n,l;if("number"==typeof t)n=t,l=r;else if(f.equals(t.spatialReference,this.spatialReference))n=t.x,l=t.y,o=r;else{var s=y.project(t,this.spatialReference);if(!s)return null;n=s.x,l=s.y,o=r}var a=i.resolution*this.size[0],p=i.resolution*this.size[1];return o||(o={id:null,level:0,row:0,col:0,extent:u.create()}),o.level=e,o.row=Math.floor((this.origin.y-l)/p+.001),o.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(o),o},t.prototype.updateTileInfo=function(e){var t=this.lodAt(e.level);if(t){var r=t.resolution*this.size[0],o=t.resolution*this.size[1];e.id=e.level+"/"+e.row+"/"+e.col,e.extent||(e.extent=u.create()),e.extent[0]=this.origin.x+e.col*r,e.extent[1]=this.origin.y-(e.row+1)*o,e.extent[2]=e.extent[0]+r,e.extent[3]=e.extent[1]+o}},t.prototype.upsampleTile=function(e){var t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)},t.prototype.getTileBounds=function(e,t){var r=this.lodAt(t.level).resolution,o=r*this.size[0],i=r*this.size[1];return e[0]=this.origin.x+t.col*o,e[1]=this.origin.y-(t.row+1)*i,e[2]=e[0]+o,e[3]=e[1]+i,e},t.prototype.lodAt=function(e){return this._levelToLOD&&this._levelToLOD[e]||null},t.prototype.clone=function(){return l.fromJSON(this.write({}))},t.prototype._initializeUpsampleLevels=function(){var e=this.lods;this._upsampleLevels=[];for(var t=null,r=0;r<e.length;r++){var o=e[r];this._upsampleLevels[o.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/o.resolution:0},t=o}};var l;return i([p.property({type:Number,json:{write:!0}})],t.prototype,"compressionQuality",void 0),i([p.property({type:Number,json:{write:!0}})],t.prototype,"dpi",void 0),i([p.property({type:String,json:{read:d.read,write:d.write,origins:{"web-scene":{read:!1,write:!1}}}})],t.prototype,"format",void 0),i([p.property({readOnly:!0,dependsOn:["spatialReference","origin"]})],t.prototype,"isWrappable",null),i([p.property({type:n.Point,json:{write:!0}})],t.prototype,"origin",void 0),i([p.reader("origin")],t.prototype,"readOrigin",null),i([p.property({type:[v],value:null,json:{write:!0}})],t.prototype,"lods",null),i([p.property({readOnly:!0})],t.prototype,"minScale",void 0),i([p.property({readOnly:!0})],t.prototype,"maxScale",void 0),i([p.property({readOnly:!0})],t.prototype,"scales",void 0),i([p.property({cast:function(e){return Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]}})],t.prototype,"size",void 0),i([p.reader("size",["rows","cols"])],t.prototype,"readSize",null),i([p.writer("size",{cols:{type:c.Integer},rows:{type:c.Integer}})],t.prototype,"writeSize",null),i([p.property({type:n.SpatialReference,json:{write:!0}})],t.prototype,"spatialReference",void 0),t=l=i([p.subclass("esri.layers.support.TileInfo")],t)}(p.declared(l))});