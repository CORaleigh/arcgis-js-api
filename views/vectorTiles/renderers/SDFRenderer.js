// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/has","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f32","../../../core/libs/gl-matrix-2/vec2f32","../../../core/libs/gl-matrix-2/vec3f32","../../../core/libs/gl-matrix-2/vec4f32","../GeometryUtils","./rendererUtils","../../webgl/VertexArrayObject"],function(e,t,r,i,a,o,s,n,f,l,h){return function(){function e(e){this._viewProjMat=a.mat4f32.create(),this._offsetVector=s.vec3f32.create(),this._extrudeMat=a.mat4f32.create(),this._scaleVec=s.vec3f32.create(),this._haloColor=n.vec4f32.create(),this._sdfColor=n.vec4f32.create(),this._initialized=!1,this._programOptions={id:!1,dd:!1},this._programCache=e}return e.prototype.dispose=function(){},e.prototype.render=function(e,t,a,s,n,h,_,u,d,m,c,x,v){var g=this;if(!r("esri-vector-tiles-avoid-text")){this._initialized||this._initialize(e);var p=f.degToByte(n),y=u.getLayoutValue("text-rotation-alignment",a);2===y&&(y=1===u.getLayoutValue("symbol-placement",a)?0:1);var V=0===y,D=u.getLayoutValue("text-keep-upright",a)&&V,b=3===s,U=.8*3/x,z=u.hasDataDrivenTextSize?1:u.getLayoutValue("text-size",a),C=u.hasDataDrivenTextColor?[1,1,1,1]:u.getPaintValue("text-color",a),A=u.hasDataDrivenTextOpacity?1:u.getPaintValue("text-opacity",a),M=C[3]*A*v;this._sdfColor[0]=M*C[0],this._sdfColor[1]=M*C[1],this._sdfColor[2]=M*C[2],this._sdfColor[3]=M,this._glyphTextureSize||(this._glyphTextureSize=o.vec2f32.fromValues(d.width/4,d.height/4));var O=_.tileTransform.transform,P=u.getPaintValue("text-translate",a);if(0!==P[0]||0!==P[1]){i.mat4.copy(this._viewProjMat,_.tileTransform.transform);var j=P[0],w=P[1],T=0,S=0,B=_.coordRange/512,L=(1<<_.key.level)/Math.pow(2,a)*B;if(1===u.getPaintValue("text-translate-anchor",a)){var E=-f.C_DEG_TO_RAD*n,I=Math.sin(E),R=Math.cos(E);T=L*(j*R-w*I),S=L*(j*I+w*R)}else T=L*j,S=L*w;this._offsetVector[0]=T,this._offsetVector[1]=S,this._offsetVector[2]=0,i.mat4.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),O=this._viewProjMat}V?i.mat4.copy(this._extrudeMat,m):i.mat4.copy(this._extrudeMat,c),this._scaleVec[0]=1/24,this._scaleVec[1]=1/24,this._scaleVec[2]=1,i.mat4.scale(this._extrudeMat,this._extrudeMat,this._scaleVec);var G=u.hasDataDrivenText,k=this._getSDFVAO(e,_,G);if(k){e.bindVAO(k);var F=(b?1:0)<<1|(G?1:0),q=this._programOptions;q.id=b,q.dd=G;var W=this._programCache.getProgram(6,F,q);if(e.bindProgram(W),W.setUniformMatrix4fv("u_transformMatrix",O),W.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat),W.setUniform2fv("u_normalized_origin",_.tileTransform.displayCoord),W.setUniform1f("u_depth",u.z+1/65536),W.setUniform2fv("u_mosaicSize",this._glyphTextureSize),W.setUniform1f("u_mapRotation",p),W.setUniform1f("u_keepUpright",D?1:0),W.setUniform1f("u_level",10*a),W.setUniform1f("u_fadeSpeed",10*h.fadeSpeed),W.setUniform1f("u_minfadeLevel",10*h.minfadeLevel),W.setUniform1f("u_maxfadeLevel",10*h.maxfadeLevel),W.setUniform1f("u_fadeChange",10*(a+h.fadeChange)),W.setUniform1i("u_texture",6),W.setUniform1f("u_size",z),W.setUniform1f("u_antialiasingWidth",U),b){var H=l.int32To4Bytes(t.layerID);W.setUniform4f("u_id",H[0],H[1],H[2],H[3])}t.glyphPerPageElementsMap.forEach(function(t,r){g._renderGlyphRange(e,t,r,u,d,W,a,A*v,3)}),e.bindVAO()}}},e.prototype._renderGlyphRange=function(e,t,r,i,a,o,s,n,f){a.bind(e,9729,r,6);var l=i.getPaintValue("text-halo-color",s),h=i.getPaintValue("text-halo-width",s);if(l[3]>0&&h>0){var _=l[3]*n;this._haloColor[0]=_*l[0],this._haloColor[1]=_*l[1],this._haloColor[2]=_*l[2],this._haloColor[3]=_;var u=i.getPaintValue("text-halo-blur",s)*f,d=h*f;o.setUniform4fv("u_color",this._haloColor),o.setUniform1f("u_halo",1),o.setUniform1f("u_edgeDistance",d),o.setUniform1f("u_edgeBlur",u),e.drawElements(4,t[1],5125,12*t[0])}this._sdfColor[3]>0&&(o.setUniform4fv("u_color",this._sdfColor),o.setUniform1f("u_halo",0),o.setUniform1f("u_edgeDistance",0),o.setUniform1f("u_edgeBlur",0),e.drawElements(4,t[1],5125,12*t[0]))},e.prototype._initialize=function(e){return!!this._initialized||(this._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]},this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]},this._initialized=!0,!0)},e.prototype._getSDFVAO=function(e,t,r){if(r){if(t.textDDVertexArrayObject)return t.textDDVertexArrayObject;var i=t.textDDVertexBuffer,a=t.textIndexBuffer;return i&&a?(t.textDDVertexArrayObject=new h(e,this._programCache.getProgramAttributes(6),this._vertexAttributesDD,{geometry:i},a),t.textDDVertexArrayObject):null}if(t.textVertexArrayObject)return t.textVertexArrayObject;var i=t.textVertexBuffer,a=t.textIndexBuffer;return i&&a?(t.textVertexArrayObject=new h(e,this._programCache.getProgramAttributes(6),this._vertexAttributes,{geometry:i},a),t.textVertexArrayObject):null},e}()});