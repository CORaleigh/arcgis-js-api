// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/has","../../core/promiseUtils","../../core/libs/gl-matrix-2/mat4","../../core/libs/gl-matrix-2/mat4f32","../../core/libs/gl-matrix-2/vec3f32","../2d/engine/Container","../2d/engine/webgl/enums","./GeometryUtils","./renderers/Renderer"],function(e,t,i,r,a,s,l,n,o,h,d,c){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._renderer=new c,t._tileCoordinateScale=n.vec3f32.create(),t._orientationVec=n.vec3f32.fromValues(0,0,1),t._displayScale=n.vec3f32.create(),t._defaultTransform=l.mat4f32.create(),t._displayWidth=0,t._displayHeight=0,t._pointToCallbacks=new Map,t}return i(t,e),t.prototype.initialize=function(e,t,i,r){this._renderer.initialize(e,t),this._tileInfoView=r,this._tileInfo=i},t.prototype.dispose=function(){this._renderer&&this._renderer.dispose(),e.prototype.dispose.call(this)},t.prototype.hitTest=function(e,t){var i=this,r=[e,t];return a.create(function(e,t){i._pointToCallbacks.set(r,{resolve:e,reject:t}),i.requestRender()},function(){i._pointToCallbacks.has(r)&&i._pointToCallbacks.delete(r)})},t.prototype.renderChildren=function(t){var i=this;if(0!==this.children.length&&this._tileInfoView&&t&&t.state&&(t.drawPhase===h.WGLDrawPhase.MAP||t.drawPhase===h.WGLDrawPhase.HITTEST)){var a=t.state,s=this.stage.context,l=this._renderer;l.initializeProgramCache(this.stage.context),l.setGlobalOpacity(s,t,this.opacity),s.setDepthWriteEnabled(!0),s.setStencilWriteMask(255),s.setClearDepth(1),s.setClearStencil(0),s.clear(s.gl.DEPTH_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),s.setDepthWriteEnabled(!1);var n=t;n.displayLevel=this._tileInfoView.scaleToLevel(a.scale),n.requiredLevel=this._tileInfoView.getSmallestInfoForScale(a.scale).level,n.renderer=this._renderer,this.sortChildren(function(e,t){return e.key.level-t.key.level});for(var o=this.children.length,d=1;d<=o;d++){var c=this.children[d-1];c.attached&&c.visible&&(c.stencilData.reference=d,c.stencilData.mask=255)}if(this._updateTilesTransform(n.state,n.requiredLevel,this.children),s.setDepthWriteEnabled(!0),this._renderer.setStateParams(n.state,n.pixelRatio,n.displayLevel),this._renderer.drawClippingMasks(s,this.children),s.setStencilWriteMask(0),s.setBlendFunctionSeparate(1,771,1,771),s.setStencilOp(7680,7680,7681),s.setDepthFunction(515),s.setBlendingEnabled(!1),s.setStencilTestEnabled(!0),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),n.drawphase=0,e.prototype.renderChildren.call(this,n),s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),n.drawphase=1,e.prototype.renderChildren.call(this,n),n.drawphase=2,e.prototype.renderChildren.call(this,n),s.setStencilTestEnabled(!1),s.setDepthTestEnabled(!1),l.applyGlobalOpacity(s,t,this.opacity),r("esri-vector-tiles-debug"))for(var p=0,_=this.children;p<_.length;p++){var f=_[p];f.attached&&f.visible&&this._renderer.renderTileInfo(s,f)}this._pointToCallbacks.size>0&&(this._pointToCallbacks.forEach(function(e,t){e.resolve(i._hitTest(n,t[0],t[1]))}),this._pointToCallbacks.clear()),this._renderer.needsRedraw()&&this.requestRender()}},t.prototype.removeAllChildren=function(){for(var t=0;t<this.children.length;t++){this.children[t].dispose()}e.prototype.removeAllChildren.call(this)},t.prototype._hitTest=function(e,t,i){var r=this._tileInfoView.getSmallestInfoForScale(e.state.scale).level,a=[0,0];e.state.toMap(a,[t,i]);var s=e.state.clone(),l=s.viewpoint.clone(),n=l.targetGeometry;n.x=a[0],n.y=a[1],l.targetGeometry=n,s.viewpoint=l,s.size=[3,3],this._renderer.setStateParams(s,e.pixelRatio,e.displayLevel);var o={context:this.stage.context,drawPhase:0,pixelRatio:e.pixelRatio,stationary:e.stationary,globalOpacity:e.globalOpacity,displayLevel:e.displayLevel,requiredLevel:e.requiredLevel,renderer:e.renderer,layerOpacity:e.layerOpacity,state:s,drawphase:3},h=this._renderer.hitTest(o,t,i,this.children,r,3,this._updateTilesTransform.bind(this));return h&&0!==h.length?h[0]:null},t.prototype._updateTilesTransform=function(e,t,i){var r=1/e.size[0],a=1/e.size[1],s=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lodAt(t).resolution,e.resolution,e.rotation,this._tileInfo.size[1],4096,e.size[0],e.size[1],this._defaultTransform);for(var l=0,n=i;l<n.length;l++){var o=n[l];e.toScreen(s,o.coords),s[1]=e.size[1]-s[1],o.tileTransform.displayCoord[0]=2*s[0]*r-1,o.tileTransform.displayCoord[1]=2*s[1]*a-1,o.key.level===t&&4096===o.coordRange?o.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfo.lodAt(o.key.level).resolution,e.resolution,e.rotation,this._tileInfo.size[1],o.coordRange,e.size[0],e.size[1],o.tileTransform.transform)}},t.prototype._calculateRelativeViewProjMat=function(e,t,i,r,a,l,n,o){var h=e/t,c=.125;512!==r&&4096!==a&&(c=r/a);var p=c*h;this._tileCoordinateScale.set([p,p,1]),l===this._displayWidth&&n===this._displayHeight||(this._displayScale.set([2/l,-2/n,1]),this._displayWidth=l,this._displayHeight=n),s.mat4.identity(o),s.mat4.scale(o,o,this._tileCoordinateScale),s.mat4.rotate(o,o,-i*d.C_DEG_TO_RAD,this._orientationVec),s.mat4.scale(o,o,this._displayScale),s.mat4.transpose(o,o)},t}(o.Container)});