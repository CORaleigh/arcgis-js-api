// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/compilerUtils","../../../core/Error","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","./cameraUtils","./geometryUtils","./mathUtils","./projectionUtils"],function(e,t,r,n,a,i,o,c,l,s,u,m,f,v,p,g,h,d,x,y,R,b){function w(e){return 360-R.cyclicalDeg.normalize(e)}function T(e){return R.cyclicalDeg.normalize(360-e)}function S(e,t){return e&&(null==t?e.reject():e.resolve(t)),t}function G(e,t,r,a){if(!t)return S(a);var i=e.spatialReference||n.SpatialReference.WGS84;if(t.camera){var o=t.get("camera.position.spatialReference");if(!h.canProject(o,i))return S(a);var c=t.camera.clone();return o.equals(i)||(c.position=h.project(c.position,i)),S(a,c)}var l=t.get("targetGeometry.spatialReference");if(l&&!h.canProject(l,i))return S(a);var s=x.internalToExternal(e,e.state.camera),u=x.OrientationMode.ADJUST;if(null!=t.rotation&&(s.heading=w(t.rotation),u=x.OrientationMode.LOCKED),null!=r&&(s.tilt=r),"point"===t.targetGeometry.type){var m=t.targetGeometry,f=void 0,v=t.targetGeometry.clone();return f=null!=t.scale?x.scaleToDistance(e,t.scale,m.latitude):e.state.camera.distance,x.fromCenterDistance(e,v,f,s,u,a)}var p=t.targetGeometry.extent;return x.fromExtent(e,p,s.heading,s.tilt,u,a)}function M(e,t,n){return n||(n=new i({camera:new r})),x.internalToExternal(e,t,n.camera),C(e,t,n)}function E(e,t,r){return r||(r=new i),r.camera=t.clone(),C(e,null,r)}function O(e,t){var a=J(e,t);if(!a)return l.reject(new c("viewpointutils-create:no-target","Missing target for creating viewpoint"));var o=new i({camera:new r({fov:e.camera.fov})});if(a.target instanceof i)return P(e,a.target,a,o).then(function(e){return K(e)});if(a.target instanceof r)return l.resolve(K(V(e,a,a.target,o)));var s=null!=a.scale||null!=a.zoom;if(a.target instanceof n.Extent){var u=a.target.xmin===a.target.xmax||a.target.ymin===a.target.ymax;return s||u?Z(e,a,a.target.center,o).then(function(e){return K(e)}):_(e,a,a.target,o).then(function(e){return K(e)})}var m={boundingBox:p.empty(),hasZ:!1,screenSpaceObjects:[]},f=s?z(e,a):void 0;return F(e,a.target,f,m).then(function(){if(isFinite(m.boundingBox[0])){p.center(m.boundingBox,H),ne.x=H[0],ne.y=H[1],ne.z=H[2],ne.spatialReference=e.spatialReference;var t=void 0;if(isFinite(ne.z)&&m.hasZ?t=p.isPoint(m.boundingBox):(ne.z=void 0,t=g.isPoint(p.toRect(m.boundingBox,Q))),s||t)return Z(e,a,ne,o);var r=N(e,m.screenSpaceObjects);return q(e,a,ne,m.boundingBox,r,o)}return a.position?k(e,a,o):L(e,a,o)}).then(function(e){return K(e)})}function A(e,t){return null==t.scale&&null!=t.zoom?x.zoomToScale(e,t.zoom):t.scale}function z(e,t){return x.scaleToResolution(e,A(e,t))}function D(e,t){var r=!1;return null!=t.heading?(e.heading=t.heading,r=!0):null!=t.rotation&&(e.heading=w(t.rotation),r=!0),null!=t.tilt&&(e.tilt=t.tilt,r=!0),null!=t.fov&&(e.fov=t.fov),r}function C(e,t,r){var a=e.spatialReference||n.SpatialReference.WGS84;return t=t||x.externalToInternal(e,r.camera),r.targetGeometry=b.vectorToPoint(t.center,e.renderSpatialReference,a),r.scale=x.computeScale(e,t),r.rotation=T(r.camera.heading),r}function j(e,t,r){if(t){if(!h.canProject(t.spatialReference,e.spatialReference))throw new c("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var n=[];if(!t.hasZ&&e.basemapTerrain){var a=void 0;switch(t.type){case"point":a=t;break;case"multipoint":case"polyline":case"mesh":a=t.extent.center;break;case"extent":a=t.center;break;case"polygon":a=t.centroid;break;default:o.neverReached(t)}a&&h.canProject(a,e.basemapTerrain.spatialReference)?H[2]=e.basemapTerrain.getElevation(a)||0:H[2]=0}(0,ae[t.type])(t,function(e){n.push(e[0],e[1],e[2])},H);var i=n.length/3;if(0!==i){var l=new Array(n.length);if(b.bufferToBuffer(n,t.spatialReference,0,l,e.spatialReference,0,i)){t.hasZ&&(r.hasZ=!0);for(var s=0;s<l.length;s+=3)t.hasZ?(H[0]=l[s+0],H[1]=l[s+1],H[2]=l[s+2]):(H[0]=l[s+0],H[1]=l[s+1]),p.expand(r.boundingBox,H)}}}}function B(e,t,r,n){return e.whenViewForGraphic(t).then(function(e){if(e&&e.whenGraphicBounds)return e.whenGraphicBounds(t,{minDemResolution:r})}).then(function(e){var t=e.boundingBox;p.expand(n.boundingBox,t),e.screenSpaceObjects&&e.screenSpaceObjects.forEach(function(e){n.screenSpaceObjects.push(e)}),isFinite(t[2])&&(n.hasZ=!0)}).catch(function(){j(e,t.geometry,n)})}function F(e,t,r,i){if(Array.isArray(t)&&2===t.length){var o=t[0],c=t[1];if("number"==typeof o&&"number"==typeof c)return ne.x=o,ne.y=c,ne.z=void 0,ne.spatialReference=n.SpatialReference.WGS84,j(e,ne,i),l.resolve()}if(t&&"function"==typeof t.map)return l.eachAlways(t.map(function(t){return F(e,t,r,i)}));if(t instanceof n.BaseGeometry)try{j(e,t,i)}catch(e){return l.reject(e)}else if(t instanceof a)return B(e,t,r,i);return l.resolve()}function P(e,t,r,n){if(t.camera)return l.resolve(V(e,r,t.camera,n));n.scale=t.scale,n.rotation=t.rotation,n.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,n.camera=null,null!=r.heading?n.rotation=T(r.heading):null!=r.rotation&&(n.rotation=r.rotation);var a=A(e,r);null!=a&&(n.scale=a);var i=l.createResolver();return G(e,n,r.tilt,i),i.promise.then(function(e){return n.camera=e,n})}function V(e,t,r,n){n.camera=r.clone(),n.camera.fov=e.camera.fov;var a=e.spatialReference,i=n.camera.position.spatialReference;return h.canProject(i,a)?(i.equals(a)||(n.camera.position=h.project(n.camera.position,a)),C(e,null,n)):null}function U(e,t,r,a,i){var o=e.renderSpatialReference;return b.pointToVector(r.position,ee,o),b.pointToVector(t,te,o),i.targetGeometry=new n.Point(t),i.camera.position=new n.Point(r.position),f.vec3.subtract($,te,ee),x.directionToHeadingTilt(e,ee,$,a.up,i.camera),i.scale=x.distanceToScale(e,f.vec3.distance(ee,te),i.targetGeometry.latitude),i.rotation=T(i.camera.heading),i}function Z(e,t,r,n){if(!r)return l.reject();n.targetGeometry=r.clone();var a=d.cameraOnContentAlongViewDirection(e);if(t.position)return l.resolve(U(e,n.targetGeometry,t,a,n));if(t.zoomFactor){var i=a.distance/t.zoomFactor,o=f.vec3.scale(H,a.viewForward,-i);f.vec3.add(a.eye,a.center,o),a.markViewDirty(),n.scale=x.distanceToScale(e,i,r.latitude)}x.internalToExternal(e,a,n.camera);var c=D(n.camera,t)?x.OrientationMode.LOCKED:x.OrientationMode.ADJUST;if(!t.zoomFactor){n.scale=A(e,t),null==n.scale&&(b.pointToVector(r,H,e.renderSpatialReference),y.frustum.intersectsPoint(a.frustum.planes,H)?n.scale=x.distanceToScale(e,f.vec3.distance(a.eye,H),r.latitude):n.scale=x.computeScale(e,a));var s=l.createResolver();return x.fromCenterScale(e,n.targetGeometry,n.scale,n.camera,c,s),s.promise.then(function(e){return n.camera=e,n})}return l.resolve(n)}function k(e,t,r){var a=d.cameraOnContentAlongViewDirection(e);return f.vec3.copy($,a.viewForward),x.directionToHeadingTilt(e,a.eye,$,a.up,re),r.camera.position=new n.Point(t.position),r.camera.heading=null!=t.heading?t.heading:re.heading,r.camera.tilt=null!=t.tilt?t.tilt:re.tilt,C(e,null,r)}function L(e,t,r){var n=d.cameraOnContentAlongViewDirection(e);return Z(e,t,b.vectorToPoint(n.center,e.renderSpatialReference,ne,e.spatialReference),r)}function _(e,t,r,n){n.targetGeometry=r.clone();var a=d.cameraOnContentAlongViewDirection(e);x.internalToExternal(e,a,n.camera);var i=D(n.camera,t)?x.OrientationMode.LOCKED:x.OrientationMode.ADJUST,o=l.createResolver();return x.fromExtent(e,r,n.camera.heading,n.camera.tilt,i,o),o.promise.then(function(e){return n.camera=e,n})}function I(e,t,r,n,a){var i=0;r.hasZ?i=r.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(r)),f.vec3.set(H,r.x,r.y,i),b.computeLinearTransformation(e.spatialReference,H,W,e.renderSpatialReference),s.mat3.fromMat4(Y,W),s.mat3.transpose(Y,Y),p.empty(X);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var l=o[c],u=n[l[2]];isFinite(u)||(u=i),f.vec3.set(H,n[l[0]],n[l[1]],u),b.vectorToVector(H,e.spatialReference,H,e.renderSpatialReference),p.expand(X,f.vec3.transformMat3(H,H,Y))}var m=p.width(X),v=p.height(X),g=p.depth(X),h=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),x=Math.sqrt(m*m+g*g),y=.5*x*Math.max(d,h)+.5*v,R=.5*v*d+.5*Math.max(m,g);return Math.max(y,R)/a}function q(e,t,r,n,a,i){i.targetGeometry=r.clone();var o=d.cameraOnContentAlongViewDirection(e),c=I(e,o,r,n,a);x.internalToExternal(e,o,i.camera);var s=D(i.camera,t)?x.OrientationMode.LOCKED:x.OrientationMode.ADJUST;i.scale=x.distanceToScale(e,c,i.targetGeometry.latitude);var u=l.createResolver();return x.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,s,u),u.promise.then(function(e){return i.camera=e,i})}function J(e,t){if(!t||!e.spatialReference)return null;var r={target:null};if("declaredClass"in t||Array.isArray(t))r.target=t;else{for(var n in t)r[n]=t[n];t.center&&!r.target&&(r.target=t.center)}return r}function K(e){return e&&(e.rotation=T(e.camera.heading)),e}function N(e,r){var n=t.DEFAULT_FRAME_COVERAGE;if(!r.length)return n;for(var a=Number.NEGATIVE_INFINITY,i=0;i<r.length;i++){var o=r[i].screenSpaceBoundingRect;a=Math.max(a,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}return n-a/Math.min(e.width,e.height)*2}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=w,t.headingToRotation=T,t.toCamera=G,t.fromInternalCamera=M,t.fromCamera=E,t.create=O;var H=v.vec3f64.create(),W=m.mat4f64.create(),Y=u.mat3f64.create(),X=p.create(),Q=g.create(),$=v.vec3f64.create(),ee=v.vec3f64.create(),te=v.vec3f64.create(),re={heading:0,tilt:0},ne=new n.Point,ae={point:function(e,t,r){r[0]=e.x,r[1]=e.y,e.hasZ&&(r[2]=e.z),t(r)},polygon:function(e,t,r){for(var n=e.hasZ,a=0;a<e.rings.length;a++)for(var i=e.rings[a],o=0;o<i.length;o++)r[0]=i[o][0],r[1]=i[o][1],n&&(r[2]=i[o][2]),t(r)},polyline:function(e,t,r){for(var n=e.hasZ,a=0;a<e.paths.length;a++)for(var i=e.paths[a],o=0;o<i.length;o++)r[0]=i[o][0],r[1]=i[o][1],n&&(r[2]=i[o][2]),t(r)},multipoint:function(e,t,r){for(var n=e.points,a=e.hasZ,i=0;i<n.length;i++)r[0]=n[i][0],r[1]=n[i][1],a&&(r[2]=n[i][2]),t(r)},extent:function(e,t,r){e.hasZ?(t(f.vec3.set(r,e.xmin,e.ymin,e.zmin)),t(f.vec3.set(r,e.xmax,e.ymin,e.zmin)),t(f.vec3.set(r,e.xmin,e.ymax,e.zmin)),t(f.vec3.set(r,e.xmax,e.ymax,e.zmin)),t(f.vec3.set(r,e.xmin,e.ymin,e.zmax)),t(f.vec3.set(r,e.xmax,e.ymin,e.zmax)),t(f.vec3.set(r,e.xmin,e.ymax,e.zmax)),t(f.vec3.set(r,e.xmax,e.ymax,e.zmax))):(t(f.vec3.set(r,e.xmin,e.ymin,r[2])),t(f.vec3.set(r,e.xmax,e.ymin,r[2])),t(f.vec3.set(r,e.xmin,e.ymax,r[2])),t(f.vec3.set(r,e.xmax,e.ymax,r[2])))},mesh:function(e,t,r){var n=e.vertexAttributes&&e.vertexAttributes.position;if(n)for(var a=0;a<n.length;a+=3)t(f.vec3.set(r,n[a+0],n[a+1],n[a+2]))}}});