// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/Logger","../../../core/MemCache","../layers/support/MemoryManagedLayerView","./Evented"],function(e,t,i,a,r,s){function o(e){return new h(e)}Object.defineProperty(t,"__esModule",{value:!0});var n=i.getLogger("esri.views.3d.support.MemoryController");t.newMemoryController=o;var h=function(){function e(e){this._view=e,this.events=new s.Evented,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new a.Storage,this._updating=!1}return e.prototype.destroy=function(){this.events=null},e.prototype.getMemCache=function(e,t){return new a(e,this._cacheStorage,t)},Object.defineProperty(e.prototype,"maxMemory",{set:function(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"additionalCacheMemory",{set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)},enumerable:!0,configurable:!0}),e.prototype.disableMemCache=function(){this._additionalCacheMemory=-4096},Object.defineProperty(e.prototype,"memoryFactor",{get:function(){return this._quality},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updating",{get:function(){return this._updating},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"usedMemory",{get:function(){return this._memoryUsed},enumerable:!0,configurable:!0}),e.prototype.notifyViewChanged=function(){this._stableQuality=0},e.prototype.update=function(){if(this._updateMemory(),!(this._memoryPredicted<=0)||this._updating){var e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._quality<=.1)return;(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed))}else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;var t=.1*(.75-this._memoryUsed+.1);e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}},e.prototype._updateQuality=function(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),!0)},e.prototype._layersUpdating=function(){var e=this._view.basemapTerrain&&this._view.basemapTerrain.hasPendingUpdates();return this._view.allLayerViews.forEach(function(t){return e=e||t.updating}),!!e},e.prototype._updateMemory=function(){var e=this,t=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());var a=this._view._stage&&this._view._stage.view&&this._view._stage.view.edgeView;a&&(t+=a.getUsedMemory()),this._view.allLayerViews&&this._view.allLayerViews.forEach(function(a){if(r.isMemoryManagedLayerView(a)){var s=a.ignoresMemoryFactor()?e._quality:1;t+=a.getUsedMemory()*s,i+=a.getUnloadedMemory()*s}});var s=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),o=1048576*this._maxMemory;if(t>o&&s){this._warnMemoryUsage=t;var h=function(e){return(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB"},y=Math.round(100*this._quality);n.warn("Memory Limit exceeded! Limit: "+h(o)+" Current: "+h(t)+" Projected: "+h(t+i)+" Quality: "+y+"%")}this._memoryUsed=t/o,this._memoryPredicted=(t+i)/o;var u=o-t;this._cacheStorage.maxSize=Math.max(0,u+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)},Object.defineProperty(e.prototype,"test",{get:function(){return{cacheStorage:this._cacheStorage}},enumerable:!0,configurable:!0}),e}()});