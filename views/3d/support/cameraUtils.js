// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../Camera","../../../config","../../../core/Logger","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./mathUtils","./projectionUtils","../webgl-engine/lib/Camera"],function(e,t,r,n,i,a,o,c,l,s,u,f,v,d,m,p,g,h,T,y){function M(e){return e.spatialReference||u.WGS84}function x(e){return"global"===e.viewingMode?p:m}function S(e,t,r,n,i){return x(e).headingTiltToDirectionUp(t,r,n,i)}function C(e,t){var r=e.renderSpatialReference,n=x(e).headingTiltToDirectionUp,i=l.vec3f64.create();if(!T.pointToVector(t.position,i,r))return null;var a=n(i,t.heading,t.tilt);c.vec3.scale(a.direction,a.direction,e.state.camera.distance),c.vec3.add(a.direction,a.direction,i);var o=d.cameraOnContentAlongViewDirection(e,i,a.direction,a.up);return o.fov=h.deg2rad(t.fov),o}function R(e,t,r){var i=e.renderSpatialReference,a=c.vec3.copy(ie,t.viewForward),o=U(e,t.eye,a,t.up,ae),l=M(e);return T.vectorToVector(t.eye,i,re,l)||(l=u.WGS84,T.vectorToVector(t.eye,i,re,l)),r?(r.position.x=re[0],r.position.y=re[1],r.position.z=re[2],r.position.spatialReference=l,r.heading=o.heading,r.tilt=o.tilt,r.fov=h.rad2deg(t.fov),r):new n(new s(re,l),o.heading,o.tilt,h.rad2deg(t.fov))}function w(e,t,r){var n=e.state.camera,a=n.fovX,o=n.width/2/n.pixelRatio;return"global"===e.viewingMode&&null!=r&&(t*=Math.cos(h.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters,o/(i.screenDPI*Q/t)/Math.tan(a/2)}function b(e,t,r){var n=e.state.camera,a=n.fovX,o=t*Math.tan(a/2),c=n.width/2/n.pixelRatio,l=c/o,s=i.screenDPI*Q,u=s/l;return"global"===e.viewingMode&&(u/=Math.cos(h.deg2rad(r))),u*=e.renderCoordsHelper.unitInMeters}function D(e,t,r,n,i,a){return P(e,t,w(e,r,t.latitude),n,i,a)}function P(e,t,r,n,i,a){if(K(a)){var c=o.createResolver();return H(e,n.heading,n.tilt,t,r,i,c),void c.promise.then(function(t){return a.resolve(X(e,t,n.fov))})}var l=H(e,n.heading,n.tilt,t,r,i);return X(e,l,n.fov,a)}function U(e,t,r,n,i){return x(e).directionToHeadingTilt(t,r,n,i)}function z(e,t,r){return e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,oe,e.spatialReference)&&e.basemapTerrain.getElevation(oe)>oe.z-1}function E(e,t,r){return e.renderCoordsHelper.fromRenderCoords(t,oe,e.spatialReference)?e.elevationProvider.queryElevation(oe).then(function(e){return e>oe.z-10}):o.resolve(!1)}function A(e,t){var r=l.vec3f64.create();if(t)if(t instanceof s){if(T.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain)return e.elevationProvider.queryElevation(t).then(function(t){return null!=t&&e.renderCoordsHelper.setAltitude(t,r),r})}else c.vec3.copy(r,t);else c.vec3.copy(r,e.state.camera.center);return o.resolve(r)}function O(e,t){var r=l.vec3f64.create();if(t&&t instanceof s){if(T.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=e.elevationProvider.getElevation(t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?c.vec3.copy(r,t):c.vec3.copy(r,e.state.camera.center);return r}function H(e,t,r,n,i,a,o){var c=n&&n instanceof s?n:null;if(K(o))return void A(e,n).then(function(n){I(e,t,r,c,n,i,a,o)});var l=O(e,n);return I(e,t,r,c,l,i,a,o)}function I(e,t,r,n,i,a,o,c){if(!n){var s=e.renderSpatialReference,u=M(e);n=T.vectorToPoint(i,s,u)}a=Math.max(a,e.state.constraints.minimumPoiDistance);var f=F(e,t,r,i,a,o),v=x(e).eyeForCenterWithHeadingTilt,d=v(i,a,f.heading,f.tilt);if(o===N.ADJUST&&"global"===e.viewingMode&&r>0){var m=function(){var l=W(e,i,a,J(e,a,r,i));return o=r-l<1?N.LOCKED:N.ADJUST,I(e,t,l,n,i,a,o,c)};if(z(e,d.eye,d.tilt))return m();if(K(c))return void E(e,d.eye,d.tilt).then(function(e){if(e)return m();c.resolve({eye:d.eye,up:d.up,center:l.vec3f64.clone(i),heading:d.heading,tilt:d.tilt})})}var p={center:l.vec3f64.create(),eye:l.vec3f64.create(),up:l.vec3f64.create(),tilt:0,heading:0};return c&&!K(c)&&(p=c),p.eye=d.eye,p.up=d.up,p.center=l.vec3f64.clone(i),p.heading=d.heading,p.tilt=d.tilt,K(c)&&c.resolve(p),p}function L(e,t,r,n,i,a){var c,l=0;null!=t.zmax&&null!=t.zmin&&(c=(t.zmax+t.zmin)/2,l=t.zmax-t.zmin);var f,d,m;if("global"===e.viewingMode){var p=u.WebMercator,h=t.spatialReference||p,T=new s(t.xmin,t.ymin,h),y=new s(t.xmax,t.ymax,h);if(T=v.project(T,p),y=v.project(y,p),null===T||null===y)return void(K(a)&&a.reject());f=new s(ce.center(T.x,y.x),(y.y+T.y)/2,p),null!=c&&(f.z=c);var x=g.getGreatCircleSpanAt(f,T,y);d=x.lon,m=x.lat,ce.diff(T.x,y.x)>ce.range/2&&(d+=g.halfEarthCircumference),d=Math.min(d,g.halfEarthCircumference),m=Math.min(m,g.halfEarthCircumference)}else{var S=M(e);v.canProject(t,S)&&(t=v.project(t,S)),d=t.xmax-t.xmin,m=t.ymax-t.ymin,f=new s({x:t.xmin+.5*d,y:t.ymin+.5*m,z:c,spatialReference:S})}var C=e.state.camera,R=1/Math.tan(C.fovX/2),w=1/Math.tan(C.fovY/2),b=1/Math.tan(C.fov/2),D=Math.max(.5*d*R,.5*m*w,.5*l*b)/$;if(K(a)){var P=o.createResolver();return H(e,r,n,f,D,i,P),void P.promise.then(function(t){return a.resolve(X(e,t,e.camera.fov))})}var U=H(e,r,n,f,D,i);return X(e,U,e.camera.fov,a)}function V(e,t,r,n,i){t||(r||(r=e.state.camera),t=R(e,r,i));var a,o,c=e.renderSpatialReference;if(r)a=T.vectorToPoint(r.center,c,M(e)),o=r.distance;else{if(!(a=e.toMap(e.screenCenter)))return null;o=g.computeCarthesianDistance(t.position,a)}r||(r=e.state.camera);var l=Math.tan(r.fovX/2),s=Math.tan(r.fovY/2),u=2*o*l*$,f=2*o*s*$;return"global"===e.viewingMode?p.toExtent(e,a,u,f,n):m.toExtent(e,a,u,f,n)}function j(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>ee)return!0;var i=e.renderSpatialReference,a=M(e),o=T.vectorToPoint(t,i,a),c=T.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>te}function F(e,t,r,n,i,a){var o=0;return a===N.ADJUST&&j(e,n,i)?(t=0,o=q(e,i,r,n)):o=G(e,n,i,r),o=e.state.constraints.clampTilt(i,o),r=W(e,n,i,o),{heading:t,tilt:r}}function q(e,t,r,n){var i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);var a=i.min*(1-le)+i.max*le,o=G(e,n,t,r);return Math.min(o,a)}function J(e,t,r,n){var i=e.state.constraints.tilt(t),a=G(e,n,t,r);return a=Math.min(a,.5*Math.PI),i.min*(1-le)+a*le}function W(e,t,r,n){return x(e).lookAtTiltToEyeTilt(t,r,n)}function G(e,t,r,n){return x(e).eyeTiltToLookAtTilt(t,r,n)}function X(e,t,r,i){var a=e.renderSpatialReference,o=M(e),c=T.vectorToPoint(t.eye,a,o);return c?i?(i.position=c,i.heading=t.heading,i.tilt=t.tilt,i.fov=r,i):new n(c,t.heading,t.tilt,r):null}function K(e){return e&&e.resolve&&e.reject}function k(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.levelAtScale(t):void B.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Y(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.scaleAtLevel(t):void B.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Z(e,t){return e.spatialReference?f.getResolutionForScale(t,e.spatialReference):void 0}function _(e,t,r){var n=e.renderSpatialReference;t||(t=e.state.camera);var i,a,o=u.WGS84;return t instanceof y?(T.vectorToVector(t.center,n,ne,o),i=ne[1],a=t.distance):(i=t.position.latitude,T.pointToVector(t.position,re,n),T.pointToVector(r,ne,n),a=c.vec3.distance(re,ne)),b(e,a,i)}Object.defineProperty(t,"__esModule",{value:!0});var N,B=a.getLogger("esri.views.3d.support.cameraUtils"),Q=39.37,$=1,ee=8,te=5,re=l.vec3f64.create(),ne=l.vec3f64.create(),ie=l.vec3f64.create(),ae={heading:0,tilt:0},oe=new s,ce=new h.Cyclical(-20037508.342788905,20037508.342788905);!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(N=t.OrientationMode||(t.OrientationMode={})),t.headingTiltToDirectionUp=S,t.externalToInternal=C,t.internalToExternal=R,t.scaleToDistance=w,t.distanceToScale=b,t.fromCenterScale=D,t.fromCenterDistance=P,t.directionToHeadingTilt=U,t.getObserverForPointAtDistance=H,t.fromExtent=L,t.toExtent=V;var le=.7;t.observerToCamera=X,t.scaleToZoom=k,t.zoomToScale=Y,t.scaleToResolution=Z,t.computeScale=_});