// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Set","../../../Graphic","../../../core/arrayUtils","../../../core/Logger","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../geometry/support/aaBoundingBox","../../../layers/support/fieldUtils","../../../tasks/support/Query","./I3SMeshView3D","./LayerView3D","./i3s/I3SGeometryUtil","./i3s/I3SQueryEngine","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/projectionUtils","../../layers/support/FeatureFilter"],function(e,t,r,i,n,o,s,a,u,l,p,c,d,y,h,f,g,_,b,v,F,w,E,I,m,x,q){var S=c.getLogger("esri.views.3d.layers.SceneLayerView3D"),j=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t.lodFactor=1,t.progressiveLoadFactor=1,t._elevationContext="scene",t._isIntegratedMesh=!1,t}return i(t,e),Object.defineProperty(t.prototype,"filter",{set:function(e){if(!e)return void this._set("filter",null);var t=["contains","intersects","disjoint"];e.where||e.distance||e.units||e.timeExtent||-1===t.indexOf(e.spatialRelationship)?(S.warn("Unsupported filter: only geometry filters and spatialRelationships "+t.join(", ")+" are supported"),this._set("filter",null)):this._set("filter",e)},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([d.init(this,["layer.renderer","definitionExpressionFields"],function(){return e._updateRequiredFields()}),d.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),d.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),this.watch(["parsedDefinitionExpression","layer.objectIdFilter","filter"],function(){return e._filterChange()})])},t.prototype.destroy=function(){},t.prototype._updateRequiredFields=function(){return s(this,void 0,void 0,function(){var e,t,r,i,n,s;return o(this,function(o){switch(o.label){case 0:return e=this,t=e.layer,r=t.fields,i=t.renderer,n=e.definitionExpressionFields,s=new u.default,i?[4,i.collectRequiredFields(s,r)]:[3,2];case 1:o.sent(),o.label=2;case 2:return f.collectFields(s,r,n),this._set("requiredFields",a.from(s).sort()),[2]}})})},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&S.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new F(this.layer,{forAll:function(r,i){e._forAllFeatures(function(i,n,o){t.id=i,t.index=n,t.meta=o,e._boundingBoxCornerPoints(n,o.engineObject,t.bbCorners),r(t)},i)},createGraphic:function(t){return e._createGraphic(t.index,t.meta)},requestFields:function(t,r,i){var n=function(r){var i=e._getGraphicIndices(t,r);return[{node:t,indices:i,graphics:r}]};return w.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),i,n,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=h.empty(),i=new Float64Array(24);return{add:function(n){x.bufferToBuffer(n.bbCorners,e,0,i,t,0,8)&&h.expandWithBuffer(r,i,0,8)},getExtent:function(){return h.toExtent(r,t)}}},t.prototype.highlight=function(e,t){void 0===t&&(t={});var r=this._highlights;if(e instanceof g){var i=r.acquireSet(t),n=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return r.setFeatureIds(n,e)}),o}return this.inherited(arguments)},t.prototype._createLayerGraphic=function(e){var t=new l(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)},t.prototype.getFilters=function(){var e=this,t=this.inherited(arguments);if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t){return e._objectIdFilter(r,i,t)})}return this.addSqlFilter(t,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError),this.filter&&this.filter.geometry&&t.push(function(t,r){return e._maskFilter(t,r)}),t},t.prototype._maskFilter=function(e,t){var r=this.filter.geometry,i=r.spatialReference||this.view.spatialReference;x.mbsToMbs(t.node.mbs,this._controller.crsIndex,O,i);var n=this.filter.spatialRelationship,o=v.acquireMaskFilterContext(n,this.view,r,t.engineObject),s=v.intersectMaskWithMbs(o,O);switch(v.getIntersectRelation(o,s)){case 1:return void(e.length=0);case 0:return}t.engineObject.getGeometryRecords()[0].geometry.componentCount===t.featureIds.length&&w.filterInPlace(e,t.featureIds,function(e){return v.filterMask(e,o)})},t.prototype._filterChange=function(){var e=this;this.filter&&!!this.filter.geometry?v.loadGeometryEngine().then(function(){return e._applyFilters(!0)}):this.inherited(arguments)},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){p.binaryIndexOf(e,r[i])>=0===t&&(r[n]=r[i],n++),i++}r.length=n},n([y.property()],t.prototype,"layer",void 0),n([y.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),n([y.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),n([y.property(I.updatingPercentage)],t.prototype,"updatingPercentage",void 0),n([y.property({type:q})],t.prototype,"filter",null),n([y.property({type:[String],readOnly:!0})],t.prototype,"requiredFields",void 0),n([y.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],t.prototype,"lodFactor",void 0),n([y.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),t=n([y.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(y.declared(b,_.I3SMeshView3D,m.PopupSceneLayerView,E.DefinitionExpressionSceneLayerView)),O=[0,0,0,0];return j});