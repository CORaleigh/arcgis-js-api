// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Graphic","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/sql/WhereClause","./BuildingComponentSublayerView3D","./BuildingGroupSublayerView3D","./LayerView3D","./i3s/I3SUtil","./support/layerViewUpdatingProperties"],function(e,r,t,n,o,i,a,s,u,p,c,l,y,d,f,h,g,m,w,v){var V=p.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D");return function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.componentLayerViews=new u,r.groupLayerViews=new u,r._componentPromises=[],r._loadingComponents=0,r}return n(r,e),Object.defineProperty(r.prototype,"parsedFilterExpression",{get:function(){var e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find(function(r){return r.id===e}):null,t=null!=r?r.filterBlocks.find(function(e){return"solid"===e.filterMode.type}):null;if(t)try{var n=f.create(t.filterExpression);return n.isStandardized()?n:(V.error("filterExpression is using non standard function"),null)}catch(e){return V.error("Failed to parse filterExpression: "+e),null}return null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updatingPercentageValue",{get:function(){var e=this.componentLayerViews,r=this._loadingComponents,t=r+e.length;return e.reduce(function(e,r){return e+r.updatingPercentage},100*r)/t},enumerable:!0,configurable:!0}),r.prototype.isUpdating=function(){return this._loadingComponents>0||this.componentLayerViews.some(function(e){return e.updating})},r.prototype.initialize=function(){w.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)},r.prototype.destroy=function(){this.groupLayerViews&&(this.groupLayerViews.forEach(function(e){return e.destroy()}),this.groupLayerViews=null),this.componentLayerViews&&(this.componentLayerViews.forEach(function(e){return e.destroy()}),this.componentLayerViews=null),this._componentPromises&&(this._componentPromises.forEach(function(e){return e.cancel()}),this._componentPromises=null)},r.prototype.initializeSubLayerViews=function(e,r){var t=this,n=this,o=this.view;e.forEach(function(e){if("building-group"===e.type){var i=new g({layer:e,view:o,parent:r});t.groupLayerViews.push(i),t.initializeSubLayerViews(e.sublayers,i)}else{t._loadingComponents++;var a=e.load().then(function(){t._loadingComponents--;var i=new h({layer:e,layerView:n,view:o,parent:r});return t.componentLayerViews.push(i),t.handles.add([y.init(i,"updating",function(){return t.notifyChange("updating")}),y.init(i,"updatingPercentage",function(){return t.notifyChange("updatingPercentageValue")})]),i.when()});t._componentPromises.push(a)}})},r.prototype.getGraphicFromStageObject=function(e,r){var t=this.componentLayerViews.find(function(r){return r.hasStageObject(e)});return t?t.getGraphicFromStageObject(e,r):null},r.prototype.fetchPopupFeatures=function(e,r){return a(this,void 0,void 0,function(){var t;return i(this,function(n){return c.isSome(r)&&r.clientGraphics&&0!==r.clientGraphics.length?(t=this._findComponent(r.clientGraphics[0].sourceLayer),c.isNone(t)?[2]:[2,t.fetchPopupFeatures(e,r)]):[2]})})},r.prototype.whenGraphicBounds=function(e){var r=this._findComponent(e.sourceLayer);return c.isNone(r)?l.reject():r.whenGraphicBounds(e)},r.prototype._findComponent=function(e){return this.componentLayerViews.find(function(r){return e===r.layer})},r.prototype.highlight=function(e,r){void 0===r&&(r={}),e instanceof s?e=[e]:e instanceof u&&(e=e.toArray());var t=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof s){for(var n=e,o=new Map,i=0,a=n;i<a.length;i++){var p=a[i],c=o.get(p.sourceLayer);null==c&&(c=[],o.set(p.sourceLayer,c)),c.push(p)}this.componentLayerViews.forEach(function(e){var r=o.get(e.layer);r&&t.push(e.highlight(r))})}return{remove:function(){return t.forEach(function(e){return e.remove()})},pause:function(){return t.forEach(function(e){return e.pause()})},resume:function(){return t.forEach(function(e){return e.resume()})}}},r.prototype.getUsedMemory=function(){return this.componentLayerViews.reduce(function(e,r){return e+r.getUsedMemory()},0)},r.prototype.getUnloadedMemory=function(){return this.componentLayerViews.reduce(function(e,r){return e+r.getUnloadedMemory()},0)},r.prototype.ignoresMemoryFactor=function(){return!1},o([d.property()],r.prototype,"layer",void 0),o([d.property()],r.prototype,"componentLayerViews",void 0),o([d.property()],r.prototype,"groupLayerViews",void 0),o([d.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],r.prototype,"parsedFilterExpression",null),o([d.property(v.updatingPercentage)],r.prototype,"updatingPercentage",void 0),o([d.property({readOnly:!0})],r.prototype,"updatingPercentageValue",null),r=o([d.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],r)}(d.declared(m))});