// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/generatorHelper","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/now","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../tasks/support/QuantizationParameters","../../../../tasks/support/Query","./featureReference","./FeatureTile","./featureTileQuery3D","../../../../views/support/QueueProcessor"],function(e,t,i,r,s,a,u,n,o,l,c,h,p,d,f,y,m,F,g,v,T,b,x,R){function C(e,t){return null!=e.objectId?e.objectId:e.attributes[t]}function E(e){return"dummy-tile-full-extent"===e.id}function O(e){for(var t=0,i=0,r=e;i<r.length;i++){var s=r[i];s.features&&s.features.length>0&&s.alive&&(t=Math.max(t,s.descriptor.lij[0]))}return t}Object.defineProperty(t,"__esModule",{value:!0});var _=T.SingleFeatureReference,M=T.MultiFeatureReference,w=c.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D"),D=function(e){function t(t){var i=e.call(this,t)||this;return i.useTileCount=!1,i.updating=!1,i.updatingTotal=0,i.updatingRemaining=0,i.expectedFeatureDiff=0,i.maximumNumberOfFeaturesExceeded=!1,i.maximumNumberOfFeaturesExceededThrottle=1e3,i.maximumNumberOfFeaturesExceededNext=0,i._fullRatio=1,i._farRatio=1,i.changes={updates:{adds:[],removes:[]},adds:[],removes:[]},i.handles=new l,i._dirty=!1,i.idToFeatureTile=new Map,i.displayingFeatureReferences=new Map,i.numDisplayingFeatureReferences=0,i.suspended=!0,i.pendingEdits=null,i}return i(t,e),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"memoryForUnusedFeatures",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.estimatedUnusedSize}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalVertices",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.numVertices}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalFeatures",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.numFeatures}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterExtent",{set:function(e){if(e&&this.tilingScheme&&!e.spatialReference.equals(this.tilingScheme.spatialReference))return void w.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");var t=this._get("filterExtent");if(!(t===e||t&&e&&t.equals(e))){var i=e?e.clone():null;this._set("filterExtent",i),this.reclip(i,t)}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.capabilities=this.calculateCapabilities(),this.fetchQueue=this.createFetchQueue();var t=this.layerView.layer;this.handles.add(f.on(this,"tileDescriptors","change",function(){return e.setDirty()},function(){return e.setDirty()})),this.handles.add(t.watch("hasService",function(){return e._initMemCache()})),f.init(t,"hasService",function(){return e._initMemCache()}),this.objectIdField=t.objectIdField,this.FeatureReferenceClass=this.capabilities.supportsMultipleResolutions?M:_,this.featureTileQuery=x.createFeatureTileQuery3D(t);var i=this.layerView.view.resourceController.scheduler;this.handles.add([i.registerTask(2,function(t){return e.update(t)},function(){return e._dirty||e.maximumNumberOfFeaturesExceededNext>0}),i.registerIdleStateCallbacks(function(){return e.unpause()},function(){return e.pause()})]),this.setDirty()},t.prototype.destroy=function(){var e=this;this.handles&&(this.handles.destroy(),this.handles=null),this.forEachFeatureTile(function(t){e.cancelFetchTile(t),e.removeTile(t)}),this.idToFeatureTile.clear(),this.displayingFeatureReferences.clear(),this.fetchQueue.destroy(),this.fetchQueue=null,this.featureTileQuery=null,this.pendingEdits&&(this.pendingEdits.edits.cancel(j),this.pendingEdits=null),this._memCache&&this._memCache.destroy(),this._memCache=null},Object.defineProperty(t.prototype,"paused",{get:function(){return this.suspended||!!this.pendingEdits},enumerable:!0,configurable:!0}),t.prototype.filtersChanged=function(){var e=this;this.fetchQueue.clear(),this._memCache&&this._memCache.clear(),this.forEachFeatureTile(function(t){e.resetFetchTile(t),e.queueFetchTile(t)}),this.setDirty()},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())},t.prototype.pause=function(){this.paused&&(this.fetchQueue.pause(),this.fetchQueue.reset(),this.updated())},t.prototype.unpause=function(){this.paused||(this.setDirty(),this.fetchQueue.resume(),this.updated())},t.prototype.getFeatureTileById=function(e){return this.idToFeatureTile.get(e)||null},t.prototype.forEachFeatureTile=function(e){this.idToFeatureTile.forEach(e)},t.prototype.applyEdits=function(e){var t=this;this.pendingEdits||(this.pendingEdits={edits:p.resolve(),count:0},this.pause()),this.pendingEdits.count++;var i=this.pendingEdits.edits.then(function(){return e.result.catch(function(e){if(e===j)throw e;return null}).then(function(e){return e?(t.applyEditsDeleteFeatures(e.deletedFeatures),o.safeCast(t.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures).then(function(){return e}))):e}).then(function(e){return 0==--t.pendingEdits.count&&(t.pendingEdits=null,t._memCache&&t._memCache.clear(),t.unpause()),e})});return this.pendingEdits.edits=i,i},t.prototype.applyEditsDeleteFeatures=function(e){var t=this;if(0!==e.length){var i=new Set;e.forEach(function(e){return i.add(e.objectId)}),this.forEachFeatureTile(function(e){if(e.features){var r=e.features.filter(function(e){return!i.has(C(e,t.objectIdField))});r.length!==e.features.length&&(e.setFeatures(r,0),t.invalidateCounts())}})}},t.prototype.applyEditsAddUpdateFeatures=function(e,t){return a(this,void 0,void 0,function(){var i,r,s,a=this;return u(this,function(u){switch(u.label){case 0:return i=[],(r=new Set,e.forEach(function(e){return i.push(e.objectId)}),t.forEach(function(e){i.push(e.objectId),r.add(e.objectId)}),0===i.length)?[2]:(s=[],this.forEachFeatureTile(function(e){var t=o.safeCast(a.applyEditsAddUpdateTile(e,i,r));t&&s.push(t)}),[4,p.eachAlways(s)]);case 1:return u.sent(),[2]}})})},t.prototype.applyEditsAddUpdateTile=function(e,t,i){return a(this,void 0,void 0,function(){var r,s,a,n,o,l,c,h=this;return u(this,function(u){switch(u.label){case 0:return e.features?(r=this.createQuery(e),r.resultType=void 0,r.objectIds=t,[4,this.queryFeatures(r)]):[2];case 1:if(s=u.sent(),a=null,i.size>0&&(n=e.features.filter(function(e){return!i.has(C(e,h.objectIdField))}),n.length!==e.features.length&&(a=n)),s.features.length>0)for(a||(a=e.features.slice()),this.verticalScale.adjust(s.features),o=0,l=s.features;o<l.length;o++)c=l[o],a.push(c);return a&&(e.setFeatures(a,0),this.invalidateCounts()),[2]}})})},t.prototype.queryFeatures=function(e){return this.featureTileQuery.queryFeaturesDehydrated(e,{timeout:S})},t.prototype.calculateCapabilities=function(){var e=this.layerView.layer,t=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsPagination),i=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsResultType),r=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization),s=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantizationEditMode),a=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsMaxRecordCountFactor),u=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsFormatPBF);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),supportsPagination:t,supportsResultType:i,supportsQuantization:r,supportsQuantizationEditMode:s,supportsMaxRecordCountFactor:a,supportsFormatPBF:u}},t.prototype.calculateSupportsMultipleResolutions=function(){var e=this.layerView.layer;switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}},t.prototype.createFetchQueue=function(){var e=this;return new R({concurrency:6,priority:2,scheduler:this.layerView.view.resourceController.scheduler,peeker:function(t){return e.highestPriorityTile(t)},process:function(t){return o.safeCast(e.fetchTile(t))}})},t.prototype.highestPriorityTile=function(e){return e.reduce(function(e,t){return e&&e.descriptor.loadPriority<=t.descriptor.loadPriority?e:t},null)},t.prototype._initMemCache=function(){var e=this.layerView.layer;"hasService"in e&&e.hasService?this._memCache||(this._memCache=this.layerView.view.resourceController.memoryController.getMemCache(e.uid)):this._memCache&&(this._memCache.destroy(),this._memCache=null)},t.prototype.setDirty=function(){this._dirty=!0,this.forEachFeatureTile(function(e){e.featureLimit=0}),this.updated()},t.prototype.update=function(e){var t=this;if(this.maximumNumberOfFeaturesExceededNext&&h()>=this.maximumNumberOfFeaturesExceededNext&&this.updateMaximumNumberOfFeaturesExceeded(),this._dirty&&this.constructed){this._dirty=!1;var i=this.getListOfTiles();this.markTilesNotAlive(i),this.addTiles(i),this.filterExtentTiles(i),this.removeTiles(i);var r=this.sortTiles(i);e.run(function(){return t.displayTiles(r,e)})&&e.run(function(){return t.queueFetchTiles(r,e)})||this.setDirty(),this.updated()}},t.prototype.markTilesNotAlive=function(e){for(var t=0,i=e;t<i.length;t++){i[t].alive=!1}},t.prototype.addTiles=function(e){var t=this;this.suspended||this.tileDescriptors.forEach(function(i){var r=t.getFeatureTileById(i.id);r?r.alive=!0:e.push(t.addTile(i))})},t.prototype.filterExtentTiles=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];r.alive&&(r.filtered=!r.intersects(this.filterExtent),r.filtered&&this.clearTile(r))}},t.prototype.removeTiles=function(e){for(var t=e.length-1;t>=0;t--){var i=e[t];i.alive||(this.removeTile(i),t!==e.length-1&&(e[t]=e[e.length-1]),e.pop())}},t.prototype.sortTiles=function(e){return e.sort(function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority}),e},t.prototype.displayTiles=function(e,t){for(var i=this,r=this.updateRatio(e),s=function(e){var t=i._fullRatio<1?r(e)*i._farRatio:1;return e.reduceFeatures(t,i.objectIdField)&&i.setDirty(),i.showTile(e)},a=this,u=0,n=e;u<n.length;u++){var o=n[u];if("break"===function(e){if(!t.run(function(){return s(e)}))return a.setDirty(),"break"}(o))break}return!0},t.prototype.queueFetchTiles=function(e,t){for(var i=this,r=this,s=0,a=e;s<a.length;s++){var u=a[s],n=function(e){if(!t.run(function(){return i.queueFetchTile(e)}))return r.setDirty(),{value:!0}}(u);if("object"==typeof n)return n.value}return!0},t.prototype.reclip=function(e,t){var i=this;this.constructed&&(this.forEachFeatureTile(function(r){r.displayingFeatures&&0!==r.displayingFeatures.length&&(r.intersection(t,q),r.intersection(e,P),m.equals(q,P)||i.hideTileFeatures(r))}),this.forEachFeatureTile(function(e){return i.showTile(e)}),this.updated())},t.prototype.updated=function(){var e=this,t=this._dirty||this.fetchQueue.length>0;if(this._set("updating",t),t){var i=0,r=0,s=0,a=0,u=0,n=0,o=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.forEachFeatureTile(function(t){if(++s,t.isFetching&&t.hasPreciseFeatureCount){var i=e.maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),l=t.displayingFeatures?t.displayingFeatures.length*o:0;n+=i-l}t.needsFetching?++u:t.numFeatures>0&&(++a,r+=t.numFeatures)}),u+=this.fetchQueue?this.fetchQueue.length:0;var l=u;r?(l=u*r/a,i=r+l):i=s,n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",i),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update(),this.updating||(this.maximumNumberOfFeaturesExceededNext=this.maximumNumberOfFeaturesExceededNext||h()+this.maximumNumberOfFeaturesExceededThrottle)},t.prototype.updateMaximumNumberOfFeaturesExceeded=function(){if(!this.updating){var e=!1;this.forEachFeatureTile(function(t){e=e||t.perTileMaximumNumberOfFeaturesExceeded}),this.maximumNumberOfFeaturesExceededNext=0,this._set("maximumNumberOfFeaturesExceeded",e)}},t.prototype.updateRatio=function(e){for(var t=O(e),i=function(e){return 1/(1<<t-e.descriptor.lij[0])},r=0,s=0,a=0,u=e;a<u.length;a++){var n=u[a],o=n.numFeatures;r+=o,s+=o*i(n)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/s,this.scheduleUpdated(),i},t.prototype.maximumFeaturesUpdated=function(e,t){var i=this;e!==t&&(t>e&&this.forEachFeatureTile(function(e){if(e.featuresMissing){var t=i.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(i.cancelFetchTile(e),i.resetFetchTile(e))}}),this.setDirty())},t.prototype.addTile=function(e){var t=new b(e);return this.idToFeatureTile.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t},t.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(e){var t=this,i=e.descriptor.resolution;this.forEachFeatureTile(function(r){if(r.displayingFeatures&&t.tilesAreRelated(e,r)){e.displayingFeatures=e.displayingFeatures||[];for(var s=0,a=r.displayingFeatures;s<a.length;s++){var u=a[s];e.displayingFeatures.push(u);var n=t.displayingFeatureReferences.get(C(u,t.objectIdField));n.ref(i,n.feature),t.numDisplayingFeatureReferences++}}}),e.featureLimit=e.displayingFeatures?e.displayingFeatures.length:0},t.prototype.tilesAreRelated=function(e,t){if(e===t)return!1;var i=e.descriptor.lij,r=t.descriptor.lij;if(!i||!r)return!0;var s=i[0]<r[0],a=s?i:r,u=s?r:i,n=u[0]-a[0];if(0===n)return!1;var o=1<<n;return Math.floor(u[1]/o)===a[1]&&Math.floor(u[2]/o)===a[2]},t.prototype.removeTile=function(e){this.clearTile(e),this.idToFeatureTile.delete(e.id)},t.prototype.resetFetchTile=function(e){e.intersects(this.filterExtent)?(e.fetchStatus=0,e.filtered=!1):(e.needsFetching&&(e.fetchStatus=4),e.filtered=!0)},t.prototype.cancelFetchTile=function(e){var t=e.fetchRequest;t&&(e.fetchRequest=null,e.fetchStatus=0,t.cancel())},t.prototype.fetchTile=function(e){return a(this,void 0,void 0,function(){var t,i,r,s,a,n,o,l,c,h,p;return u(this,function(u){switch(u.label){case 0:if(!this.needsNumFeatures(e))return[3,4];u.label=1;case 1:return u.trys.push([1,3,,4]),t=e,[4,this.fetchCount(e)];case 2:return t.numFeatures=u.sent(),this.updateRatio(this.getListOfTiles()),[3,4];case 3:return i=u.sent(),i&&"cancel"===i.dojoType?[2]:[3,4];case 4:return r=this.maximumFeaturesForTile(e),(s=Math.ceil(r/this.maxRecordCount),E(e)||!this.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=r&&s>v.MAX_MAX_RECORD_COUNT_FACTOR)?[2,this.fetchPagedTile(e)]:(a=this.createQuery(e),a.maxRecordCountFactor=Math.ceil(r/this.maxRecordCount),e.isRefetching&&e.features&&e.features.length>0&&(n=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/this.maxRecordCount),a.maxRecordCountFactor=Math.max(n+1,a.maxRecordCountFactor)),[4,this.queryFeatures(a)]);case 5:return o=u.sent(),l=o.features,c=o.exceededTransferLimit,h=c?a.maxRecordCountFactor>=v.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5,e.featuresMissing=l.length<e.numFeatures||c,p=this._removeEmptyFeatures(l),this.verticalScale.adjust(l),e.setFeatures(l,p),this.invalidateCounts(),[2,h]}})})},t.prototype.fetchCount=function(e){return a(this,void 0,void 0,function(){return u(this,function(t){return[2,this.layerView.layer.queryFeatureCount(this.createQuery(e))]})})},t.prototype.fetchPagedTile=function(e){return a(this,void 0,void 0,function(){var t,i,r,s,a,n,o,l,c,h;return u(this,function(u){switch(u.label){case 0:t=0,i=0,s=0,a=this.maximumFeaturesForTile(e)-s,u.label=1;case 1:return n=this.createQuery(e),o=this.setPagingParameters(n,t,a),[4,this.queryFeatures(n)];case 2:return l=u.sent(),c=l.features,h=l.exceededTransferLimit,t+=n.num,s+=c.length,i+=this._removeEmptyFeatures(c),this.verticalScale.adjust(c),e.featuresMissing=t<e.numFeatures||h,r=r?r.concat(c):c,e.setFeatures(r,i),this.invalidateCounts(),this.setDirty(),a=this.maximumFeaturesForTile(e)-s,!o||!h||a<=0?[2,h?4:5]:[3,1];case 3:return[2]}})})},t.prototype.createQuery=function(e){var t=this.layerView.layer.createQuery();t.outFields=this.layerView.availableFields;var i=this.layerView.layer.capabilities&&this.layerView.layer.capabilities.data;i&&i.supportsZ&&null==t.returnZ&&(t.returnZ=!0);var r=this.tilingScheme.spatialReference;t.outSpatialReference=r;var s=e.descriptor.extent;return s&&(t.geometry=m.toExtent(s,r)),this.setResolutionParams(t,e),this.capabilities.supportsResultType&&(t.resultType="tile"),t},t.prototype.setPagingParameters=function(e,t,i){return!!this.capabilities.supportsPagination&&(e.start=t,i>0&&this.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/this.maxRecordCount),e.num=Math.min(e.maxRecordCountFactor*this.maxRecordCount,i)):e.num=Math.min(this.maxRecordCount),!0)},t.prototype.getEffectiveTileResolution=function(e){if(null==e.descriptor.resolution)return null;var t="global"===this.viewingMode?this.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)*V},t.prototype.setResolutionParams=function(e,t){if(this.capabilities.supportsMultipleResolutions){var i=this.layerView.layer;if("point"!==i.geometryType){var r=this.getEffectiveTileResolution(t);null!=r&&(this.capabilities.supportsQuantization?e.quantizationParameters=new g.default({mode:"view",originPosition:"upper-left",tolerance:r,extent:i.fullExtent}):"polyline"===i.geometryType&&(e.maxAllowableOffset=r))}}},t.prototype._removeEmptyFeatures=function(e){for(var t=e.length,i=0;i<e.length;){var r=e[i];F.hasVertices(r.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length},t.prototype.needsNumFeatures=function(e){return this.useTileCount&&!e.hasPreciseFeatureCount&&!E(e)},Object.defineProperty(t.prototype,"maxRecordCount",{get:function(){var e=this.layerView.layer;if("tileMaxRecordCount"in e){if(this.capabilities.supportsResultType)return e.tileMaxRecordCount;if(e.maxRecordCount)return e.maxRecordCount}return N},enumerable:!0,configurable:!0}),t.prototype.queueFetchTile=function(e){var t=this;if(!e.needsFetching)return!1;var i=this._memCache&&this._memCache.pop(e.id);if(i)return e.loadCache(i),this.setDirty(),this.scheduleUpdated(),!0;e.fetchStatus=e.needsRefetching?3:2;var r=this.fetchQueue.push(e),s=!1,a=r.then(function(t){e.fetchRequest=null,e.fetchStatus=t}).catch(function(i){e.fetchRequest===a&&(e.fetchRequest=null,e.fetchStatus=4),i&&"cancel"===i.dojoType?s=!0:(e.setFeatures([],0),t.invalidateCounts(),e.featuresMissing=!1,w.error("#fetchTile()",t.layerView.layer,i&&i.message?i.message:i))}).then(function(){s||t.setDirty(),t.scheduleUpdated()});return a.isFulfilled()||(e.fetchRequest=a),!0},t.prototype.scheduleUpdated=function(){var e=this;this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(d.schedule(function(){e.handles.remove("scheduleUpdated"),e.updated()}),"scheduleUpdated")},t.prototype.showTile=function(e){if(e.displayingFeatures&&!e.needsDisplayUpdate)return!1;if(0===e.featureLimit||!e.features){var t=e.displayingFeatures&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],t}for(var i=e.descriptor.resolution,r=this.changes.updates,s=this.changes.adds,a=0;a<e.featureLimit;++a){var u=e.features[a],n=C(u,this.objectIdField),o=this.displayingFeatureReferences.get(n);if(o){var l=o.ref(i,u);l.oldVersion!==l.newVersion&&(r.removes.push(l.oldVersion),r.adds.push(l.newVersion))}else this.displayingFeatureReferences.set(n,new this.FeatureReferenceClass(i,u)),s.push(u);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=e.features.slice(0,e.featureLimit),!0},t.prototype.hideTile=function(e){this.cancelFetchTile(e),this.hideTileFeatures(e)},t.prototype.hideTileFeatures=function(e){if(e.displayingFeatures){for(var t=this.changes.updates,i=this.changes.removes,r=0,s=e.displayingFeatures;r<s.length;r++){var a=s[r],u=C(a,this.objectIdField),n=this.displayingFeatureReferences.get(u);if(n){var o=n.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,o?o.oldVersion!==o.newVersion&&(null==o.newVersion?(this.displayingFeatureReferences.delete(u),i.push(o.oldVersion)):(t.adds.push(o.newVersion),t.removes.push(o.oldVersion))):console.error("Hiding unreferenced feature")}}this.applyChanges(),e.displayingFeatures=null}},t.prototype.applyChanges=function(){var e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this.changes.adds,i=this.changes.removes,r=Math.min(t.length,i.length),s=0;s<r;){var a=Math.min(s+Q,r);this.features.addMany(t.slice(s,a)),this.features.removeMany(i.slice(s,a)),s=a}t.length>r&&this.features.addMany(0===s?t:t.slice(s)),i.length>r&&this.features.removeMany(0===s?i:i.slice(s)),t.length=0,i.length=0},t.prototype.clearTile=function(e){if(this.hideTile(e),e.features&&this._memCache){var t=16+e.estimatedSize;this._memCache.put(e.id,e.cacheItem,t)}e.setFeatures(null,0),this.invalidateCounts()},t.prototype.invalidateCounts=function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")},t.prototype.getListOfTiles=function(){var e=new Array(this.idToFeatureTile.size),t=0;return this.forEachFeatureTile(function(i){return e[t++]=i}),e},Object.defineProperty(t.prototype,"storedFeatures",{get:function(){return this.getListOfTiles().reduce(function(e,t){return e+(t.features?t.features.length:0)},0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{update:function(t){e.fetchQueue.test.update(t),e.update(t)}}},enumerable:!0,configurable:!0}),t.prototype.maximumFeaturesForTile=function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(t*i/(1-e.emptyFeatureRatio)),t)},r([y.property({constructOnly:!0})],t.prototype,"features",void 0),r([y.property()],t.prototype,"tileDescriptors",void 0),r([y.property({constructOnly:!0})],t.prototype,"tilingScheme",void 0),r([y.property({value:1/0})],t.prototype,"maximumNumberOfFeatures",null),r([y.property()],t.prototype,"useTileCount",void 0),r([y.property({constructOnly:!0})],t.prototype,"layerView",void 0),r([y.property({readOnly:!0})],t.prototype,"updating",void 0),r([y.property({readOnly:!0})],t.prototype,"updatingTotal",void 0),r([y.property({readOnly:!0})],t.prototype,"updatingRemaining",void 0),r([y.property({readOnly:!0})],t.prototype,"expectedFeatureDiff",void 0),r([y.property({readOnly:!0})],t.prototype,"memoryForUnusedFeatures",null),r([y.property({readOnly:!0})],t.prototype,"maximumNumberOfFeaturesExceeded",void 0),r([y.property({constructOnly:!0})],t.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),r([y.property({readOnly:!0})],t.prototype,"totalVertices",null),r([y.property({readOnly:!0})],t.prototype,"totalFeatures",null),r([y.property()],t.prototype,"filterExtent",null),r([y.property({constructOnly:!0})],t.prototype,"verticalScale",void 0),r([y.property({constructOnly:!0})],t.prototype,"viewingMode",void 0),t=r([y.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],t)}(y.declared(n));t.FeatureTileFetcher3D=D,t.getFeatureId=C;var N=2e3,q=m.create(),P=m.create(),j={},S=6e5,Q=200,V=1/3;t.default=D});