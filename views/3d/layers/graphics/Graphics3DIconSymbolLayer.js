// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","dojo/errors/CancelError","../../../../Color","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../symbols/support/IconSymbol3DLayerResource","../../../../symbols/support/utils","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./sdfPrimitives","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,i,a,s,o,n,l,u,c,h,p,d,_,f,m,y,v,g,b,S,x,z,P,M,V,R,T,U,C,O,A,D,L,I,E,G){function w(e){return!!d.isSome(e)&&("cross"===e||"x"===e)}function F(e){var t,r=q,i=r*N;switch(e){case"circle":t=U.createCircle(r,i);break;case"square":t=U.createSquare(r,i);break;case"kite":t=U.createKite(r,i);break;case"cross":t=U.createCross(r,i);break;case"x":t=U.createX(r,i);break;case"triangle":t=U.createTriangle(r,i);break;default:u.neverReached(e)}return new E(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:q,height:q,components:4,noUnpackFlip:!0})}Object.defineProperty(t,"__esModule",{value:!0});var j=y.mat4f64.create(),H=g.vec3f64.fromValues(0,0,1),k=[0,0,0,0],B=g.vec3f64.fromValues(0,0,0),W=g.vec3f64.fromValues(1,1,1),q=128,N=.5,Z=[N/2,N/2,1-N/2,1-N/2],K=[q*N,q*N],X=function(e){function t(t,r,i,a){var s=e.call(this,t,r,i,a)||this;if(s._size=null,s._symbolTextureRatio=1,s._outlineSize=0,s._texture=null,s._drapedMaterial=null,s._releaseTexture=null,s._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},!s._validate())return s;var o=s._prepareMaterialParameters(),n=s._getPrimitive();return d.isSome(n)?s._prepareResourcesPrimitive(o,n):s._prepareResourcesHref(o),s}return i(t,e),t.prototype.getCachedSize=function(){return{size:this._getIconSize()}},t.prototype._validate=function(){if(this._isPropertyDriven("size"))return!0;var e=T.validateSymbolLayerSize(this._getIconSize());return!e||(this._logWarning(e),this.reject(),!1)},t.prototype._getIconSize=function(){var e=this.symbolLayer,t=Math.round(null!=e.size?f.pt2px(e.size):16);return this._isPropertyDriven("size")?Math.max(t,64):t},t.prototype._prepareMaterialParameters=function(){var e={anchorPos:this._getAnchorPos()},t=this.symbol;if(this._hasVisibleVerticalOffset(t)){var r=t.verticalOffset,i=r.screenLength,a=r.minWorldLength,s=r.maxWorldLength;e.verticalOffset={screenLength:f.pt2px(i),minWorldLength:a||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e},t.prototype._prepareResourcesPrimitive=function(e,t){var r=this,i=this._getOutlineSize();if(w(t)&&0===i)return void this.reject();this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;var a=this._context.sharedResources.textures.fromData(t,function(){return F(t)});this._texture=a.texture,this._releaseTexture=function(){return r._context.sharedResources.textures.release(a.uid)},e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Z,e.textureId=this._texture.id;var s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/N,this._createMaterialsAndAddToStage(e,this._context.stage),this.resolve()},t.prototype._prepareResourcesHref=function(e){return s(this,void 0,void 0,function(){var t,r,i,s,n,r,u,p,d,f,y,v=this;return a(this,function(a){switch(a.label){case 0:return t=x.getIconHref(this.symbol,this.symbolLayer),!h("esri-canvas-svg-support")&&m.isSVG(t)?(r="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)",this._logWarning(r),this.reject(new c("SVG Not Supported",r)),[2]):(this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1,i=this._getIconSize(),s=i*this._context.layerView.view.pixelRatio,[4,l.result(_.when(this._context.sharedResources.textures.fromUrl(t,s)))]);case 1:return n=a.sent(),!1===n.ok?(n.error instanceof o?this.reject():(r="IconSymbol3DLayer failed to load (Request for icon resource failed: "+t+")",this._logWarning(r),this.reject(new c("Request Failed",r))),[2]):(u=n.value,p=u.uid,d=u.texture,this.isRejected()?(this._context.sharedResources.textures.release(p),[2]):(this._releaseTexture=function(){return v._context.sharedResources.textures.release(p)},f=d.params,y=f.width/f.height,this._size=y>1?[i,Math.round(i/y)]:[Math.round(i*y),i],e.textureId=d.id,this._createMaterialsAndAddToStage(e,this._context.stage),this.resolve(),[2]))}})})},t.prototype._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||S.defaultPrimitive},t.prototype._getOutlineSize=function(){var e=0,t=this.symbolLayer;return t.outline&&null!=t.outline.size?Math.max(f.pt2px(t.outline.size),0):(e=w(this._getPrimitive())?1.5:0,Math.max(e,0))},t.prototype._getOutlineColor=function(){var e=this._getLayerOpacity(),t=this.symbolLayer;if(t.outline){if(null!=t.outline.color){var r=n.toUnitRGB(t.outline.color),i=t.outline.color.a*e;return[r[0],r[1],r[2],i]}return[0,0,0,e]}return[0,0,0,e]},t.prototype._getFillColor=function(){return w(this._getPrimitive())?k:this._getMaterialOpacityAndColor()},t.prototype._getAnchorPos=function(){var e=this.symbolLayer.anchor,t=this.symbolLayer.anchorPosition;return"relative"===e?v.vec2f64.fromValues((t.x||0)+.5,.5-(t.y||0)):e in T.namedAnchorToHUDMaterialAnchorPos?T.namedAnchorToHUDMaterialAnchorPos[e]:T.namedAnchorToHUDMaterialAnchorPos.center},t.prototype._createMaterialsAndAddToStage=function(e,t){this._fastUpdates=C.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&p.mixin(e,this._fastUpdates.materialParameters);var i=r({},e);i.verticalOffset=null,i.screenSizePerspective=null,i.occlusionTest=!1,i.slicePlaneEnabled=!1,i.shaderPolygonOffset=0;var a=this._getStageIdHint();this._drapedMaterial=new G(i,a+"_iconDraped"),t.add(A.ModelContentType.MATERIAL,this._drapedMaterial),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,this._material=new G(e,a+"_icon"),t.add(A.ModelContentType.MATERIAL,this._material)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(A.ModelContentType.MATERIAL,this._material.id),this._material=null),this._drapedMaterial&&(this._context.stage.remove(A.ModelContentType.MATERIAL,this._drapedMaterial.id),this._drapedMaterial=null),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)},t.prototype._getScaleFactor=function(e){if(this._isPropertyDriven("size")&&e.size){for(var t=0;t<3;t++){var r=e.size[t];r&&"symbolValue"!==r&&"proportional"!==r&&(e.size[t]=f.pt2px(r))}var i=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/i;if(isFinite(+e.size[2]))return+e.size[2]/i}return 1},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic;if(!this._validateGeometry(r.geometry))return null;var i=V.placePointOnGeometry(r.geometry);if(!i)return this._logWarning("unsupported geometry type for icon symbol: "+r.geometry.type),null;var a="graphic"+r.uid,s=this._getVertexOpacityAndColor(t),o=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(o=this._getScaleFactor(t)),o*=this._symbolTextureRatio;var n=[this._size[0]*o,this._size[1]*o],l=this.getGraphicElevationContext(r);return"on-the-ground"===l.mode?this._createAsOverlay(r,i,s,n,l,a,r.uid,e.layer.uid):this._createAs3DShape(r,i,s,n,l,a,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getFillColor();this._drapedMaterial.setParameterValues({color:e}),this._material.setParameterValues({color:e});var t=this._getOutlineColor();return this._drapedMaterial.setParameterValues({outlineColor:t}),this._material.setParameterValues({outlineColor:t}),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var i=this._elevationContext.mode;if("on-the-ground"===r&&"on-the-ground"===i)return!0;if(r!==i&&("on-the-ground"===r||"on-the-ground"===i))return!1;var a=V.needsElevationUpdates2D(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,function(){return a})},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.pixelRatioChanged=function(e,t){return!!this._getPrimitive()},t.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!C.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.setDrawOrder=function(e,t,r){this.updateSymbolLayerOrder(e,t),this._drapedMaterial&&(this._drapedMaterial.renderPriority=e,r.add(this._drapedMaterial.id))},t.prototype._defaultElevationInfoNoZ=function(){return J},t.prototype._createAs3DShape=function(e,t,r,i,a,s,o){var n=this,l=this.getFastUpdateAttrValues(e),u=l?function(e){return C.evaluateModelTransform(n._fastUpdates.materialParameters,l,e)}:null,c=L.createPointGeometry(H,null,r,i,Q,null,l),h=new D(c,s),p=[h],d=V.createStageObjectForPoint(this._context,t,p,[this._material],null,null,a,s,this._context.layer.uid,o,!0,u);if(null===d)return null;var _=z.perObjectElevationAligner,f=new M(this,d.object,p,null,null,_,a);return f.alignedTerrainElevation=d.terrainElevation,f.needsElevationUpdates=V.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode,f.getScreenSize=this._createScreenSizeGetter(i,u),f.calculateRelativeScreenBounds=function(e){return n._material.calculateRelativeScreenBounds(f.getScreenSize(),1,e)},V.extendPointGraphicElevationContext(f,t,this._context.elevationProvider),f},t.prototype._createAsOverlay=function(e,t,r,i,a,s,o,n){var l=this;this._drapedMaterial.renderPriority=this._symbolLayerOrder;var u=g.vec3f64.create();O.pointToVector(t,u,this._context.overlaySR),u[2]=this._getDrapedZ();var c=this._context.clippingExtent;if(c&&!V.pointInBox2D(u,c))return null;var h=this.getFastUpdateAttrValues(e),p=h?function(e){return C.evaluateModelTransform(l._fastUpdates.materialParameters,h,e)}:null,d=L.createPointGeometry(H,u,r,i,null,null,h),_=new I(d);_.material=this._drapedMaterial,_.center=u,_.bsRadius=0,_.transformation=j,_.name=s,_.uniqueName=s+"#"+d.id,_.data.layerUid=n,_.data.graphicUid=e.uid,_.calculateShaderTransformation=p;var f=new P(this,[_],null);return f.getScreenSize=this._createScreenSizeGetter(i,p),f.calculateRelativeScreenBounds=function(e){return l._drapedMaterial.calculateRelativeScreenBounds(f.getScreenSize(),1,e)},f},t.prototype._createScreenSizeGetter=function(e,t){var r=this._outlineSize+2;if(this._fastUpdates.enabled){var i=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return function(e){void 0===e&&(e=v.vec2f64.create());var s=t(j);return e[0]=s[0]*i+r,e[1]=s[5]*a+r,e}}var s=e[0]/this._symbolTextureRatio+r,o=e[1]/this._symbolTextureRatio+r;return function(e){return void 0===e&&(e=v.vec2f64.create()),e[0]=s,e[1]=o,e}},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=g.vec3f64.fromValues(e,e,e),r=f.px2pt(1),i=e*r;return{modelSize:t,symbolSize:g.vec3f64.fromValues(i,i,i),unitInMeters:r,transformation:{anchor:B,scale:W,rotation:B}}},t.prototype._hasVisibleVerticalOffset=function(e){return this.symbol&&"point-3d"===this.symbol.type&&this.symbol.hasVisibleVerticalOffset()},t.PRIMITIVE_SIZE=K,t}(R.default);t.Graphics3DIconSymbolLayer=X;var J={mode:"relative-to-ground",offset:0},Q=b.vec4f64.fromValues(0,0,0,1);t.default=X});