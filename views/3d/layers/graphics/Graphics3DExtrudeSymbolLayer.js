// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/maybe","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../support/projectionUtils","../../support/buffer/BufferView","../../support/buffer/math/vec3","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,u,f,d,g,h,v,y,m,_,b,E,x,S,A,w,C){function O(e,t,r,a,n,i,o,s,l,c,p,u,f,d){var g=r.length/3,h=0;p+=2*a.count,L(e,t,a.index,a.count,r,0,g,n,i,o,s,l,c,p,u,f,d),l+=2*a.count,p+=2*g,p-=2*a.count+2*g,M(n,i,s,o,h,a.pathLengths[0],a.count,l,c,p,u),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],h+=a.pathLengths[0];for(var v=1;v<a.pathLengths.length;++v)M(n,i,s,o,h,a.pathLengths[v],a.count,l,c,p,u),l+=4*a.pathLengths[v],p+=2*a.pathLengths[v],h+=a.pathLengths[v]}function L(e,t,r,a,n,i,o,s,l,p,u,f,d,g,h,v,y){c.vec3.copy(T,v);for(var m=h>0?1:-1,_=3*r,b=f,E=3*b,x=f+a,S=3*x,A=0;A<a;++A)y&&(T[0]=e[_+0],T[1]=e[_+1],T[2]=e[_+2],c.vec3.normalize(T,T)),s[E+0]=e[_+0],s[E+1]=e[_+1],s[E+2]=e[_+2],l[E+0]=t[_+0],l[E+1]=t[_+1],l[E+2]=t[_+2],p[E+0]=-m*T[0],p[E+1]=-m*T[1],p[E+2]=-m*T[2],u[b]=0,s[S+0]=e[_+0]+h*T[0],s[S+1]=e[_+1]+h*T[1],s[S+2]=e[_+2]+h*T[2],l[S+0]=t[_+0],l[S+1]=t[_+1],l[S+2]=t[_+2],p[S+0]=m*T[0],p[S+1]=m*T[1],p[S+2]=m*T[2],u[x]=h,E+=3,S+=3,_+=3,b+=1,x+=1;_=3*i,E=3*g,S=3*(g+o);E=3*(g+o),S=3*g;var w=R,C=G;h<0&&(w=G,C=R);for(var A=0;A<o;++A)d[E+0]=n[_+w[0]],d[E+1]=n[_+w[1]],d[E+2]=n[_+w[2]],d[S+0]=n[_+C[0]]+a,d[S+1]=n[_+C[1]]+a,d[S+2]=n[_+C[2]]+a,E+=3,S+=3,_+=3}function P(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function M(e,t,r,a,n,i,o,s,l,c,p){var u=n,f=n+1,d=n+o,g=n+o+1,h=s,v=s+1,y=s+2*i,m=s+2*i+1;p<0&&(u=n+o+1,g=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(f=n,g=n+o):(f=n,u=n+o)),D(e,u,f,d,U),P(e,t,a,r,U,h,u),P(e,t,a,r,U,v,f),P(e,t,a,r,U,y,d),P(e,t,a,r,U,m,g),l[c++]=h,l[c++]=y,l[c++]=m,l[c++]=h,l[c++]=m,l[c++]=v,u++,f++,d++,g++,h+=2,v+=2,y+=2,m+=2}function D(e,t,r,a,n){t*=3,r*=3,a*=3,c.vec3.set(F,e[t++],e[t++],e[t++]),c.vec3.set(N,e[r++],e[r++],e[r++]),c.vec3.set(H,e[a++],e[a++],e[a++]),c.vec3.subtract(Y,N,F),c.vec3.subtract(W,H,F),c.vec3.cross(n,W,Y),c.vec3.normalize(n,n)}function V(e,t,r,a){j.spatialReference=r.spatialReference;for(var n=e.getGeometryRecords(),i=n.length,o="absolute-height"!==t.mode,p=0,u=e.objectTransformation,f=s.mat4.invert(l.mat4f64.create(),u),d=0;d<i;d++){var h=n[d].geometry;h.invalidateBoundingInfo();for(var v=h.data.getVertexAttr(),y=v[w.VertexAttrConstants.POSITION].data,m=v[w.VertexAttrConstants.SIZE].data,_=v.mapPos.data,b=y.length/3,E=0,x=0,S=!1,A=0,C=0;C<b;C++){j.x=_[x],j.y=_[x+1],j.z=_[x+2],Z[0]=y[E],Z[1]=y[E+1],Z[2]=y[E+2];var O=g.computeElevation(r,j,t,a,o?I:null);o&&(A+=I.terrainElevation),c.vec3.set(z,y[E+0],y[E+1],y[E+2]),c.vec3.transformMat4(z,z,u),a.setAltitude(O+m[E/3],z),c.vec3.transformMat4(z,z,f),y[E]=z[0],y[E+1]=z[1],y[E+2]=z[2];var L=.01/a.unitInMeters;(Math.abs(Z[0]-y[E])>L||Math.abs(Z[1]-y[E+1])>L||Math.abs(Z[2]-y[E+2])>L)&&(S=!0),x+=3,E+=3}S&&e.geometryVertexAttrsUpdated(d),p+=A/b}return p/i}Object.defineProperty(t,"__esModule",{value:!0});var z=p.vec3f64.create(),T=p.vec3f64.create(),R=[0,2,1],G=[0,1,2],j=f.makeDehydratedPoint(0,0,0,null),I={verticalDistanceToGround:0,terrainElevation:0},B=function(e){function t(t,r,a,n){var i=e.call(this,t,r,a,n)||this;if(i._edgeStageObjects=new Set,!i._isPropertyDriven("size")){var o=v.validateSymbolLayerSize(i._getSymbolSize());if(o)return i._logWarning(o),i.reject(),i}var s=i._getStageIdHint(),l=i._getMaterialOpacityAndColor(),c=p.vec3f64.fromArray(l),u=l[3],f={diffuse:c,ambient:c,opacity:u,transparent:u<1||i._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:i._context.slicePlaneEnabled,castShadows:i.symbolLayer.castShadows};return i._material=new C(f,s+"_3dlinemat"),i._context.stage.add(E.ModelContentType.MATERIAL,i._material),i.resolve(),i}return r(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(E.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,a=r.geometry;if("polygon"!==a.type&&"extent"!==a.type)return this._logWarning("unsupported geometry type for extrude symbol: "+a.type),null;if(!this._validateGeometry(a))return null;var n="graphic"+r.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this.getGraphicElevationContext(r);return this._createAs3DShape(a,t,i,o,n,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getMaterialOpacity(),t=e<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:e,transparent:t}),this._edgeStageObjects.size>0){var r=this._context.stage.view.ensureEdgeView(),a=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){return r.updateAllComponentOpacities(e,[a])})}return!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._edgeStageObjects.size>0){var n=this._context.stage.view.ensureEdgeView(),i=this._createEdgeMaterial(n);if(a.isSome(i)){var o=[i];this._edgeStageObjects.forEach(function(e){return n.updateAllComponentMaterials(e,o,{slicePlaneEnabled:r._context.slicePlaneEnabled},!1)})}}return!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?g.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbolLayer.size||1},t.prototype._createAs3DShape=function(e,t,r,c,f,h){var y=this,E="extent"===e.type?u.fromExtent(e):e,S=E.rings,w=[],C=[],L=[],P=new Array(6),M=this._context.renderSpatialReference===m.SphericalECEFSpatialReference,D=this._getExtrusionSize(t),z=p.vec3f64.create();M||this._context.renderCoordsHelper.worldUpAtPosition(null,z);var T=g.getGeometryVertexData3D(S,E.hasZ,E.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);if(this._logGeometryCreationWarnings(T,S,"rings","ExtrudeSymbol3DLayer"),0===S.length||!S.some(function(e){return e.length>0}))return null;var R=v.computeCentroid(E),G=l.mat4f64.create();m.computeLinearTransformation(E.spatialReference,[R.x,R.y,0],G,this._context.renderSpatialReference);var j=l.mat4f64.create();s.mat4.invert(j,G);var I=o.mat3f64.create();i.mat3.normalFromMat4(I,j);for(var B=T.geometryData.polygons,U=T.eleVertexData,F=T.vertexData,N=F.length/3,H=new Float64Array(3*N*6),Y=new Float64Array(3*N*6),W=new Float64Array(3*N*6),Z=new Float64Array(1*N*6),k=0,q=this,J=0;J<B.length;++J)!function(e){var t=B[e],a=t.count,i=t.index;if(q._context.clippingExtent&&(g.computeBoundingBox(U,i,a,P),g.boundingBoxClipped(P,q._context.clippingExtent)))return"continue";var o=new Float64Array(U.buffer,3*i*H.BYTES_PER_ELEMENT,3*a),s=t.holeIndices.map(function(e){return e-i}),c=n(o,s,3);if(0===c.length)return"continue";var p=3*a*2+2*c.length,u=new Uint32Array(p),d=6*a,h=3*H.BYTES_PER_ELEMENT,v=new _.BufferViewVec3f64(H.buffer,k*h,h,(k+d)*h),y=3*Y.BYTES_PER_ELEMENT,m=new _.BufferViewVec3f64(Y.buffer,k*y,y,(k+d)*y),E=new Float64Array(W.buffer,3*k*W.BYTES_PER_ELEMENT,3*d),S=new Float64Array(Z.buffer,1*k*Z.BYTES_PER_ELEMENT,1*d);O(F,U,c,t,v.typedBuffer,E,m.typedBuffer,S,0,u,0,D,z,M),b.transformMat4(v,v,j),b.transformMat3(m,m,I),k+=6*a;var A=q._createExtrudeGeometry(u,{positions:v.typedBuffer,elevation:E,normals:m.typedBuffer,heights:S},r),V=new x(A,f+"path"+e);V.singleUse=!0,w.push(V),C.push(q._material),L.push(l.mat4f64.create())}(J);if(0===w.length)return null;var K=new A({geometries:w,materials:C,transformations:L,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:h},idHint:f});K.objectTransformation=G;var Q=function(e){var t=y._context.stage.view.ensureEdgeView();t.removeObject(e),y._edgeStageObjects.delete(e);var r=y._createEdgeMaterial(t);a.isSome(r)&&(y._edgeStageObjects.add(e),t.addObject(e,[r],{slicePlaneEnabled:y._context.slicePlaneEnabled},!y._context.isAsync))};Q(K);var X=function(e,t,r,a){var n=V(e.stageObject,t,r,a);return Q(K),n},$=new d(this,K,w,null,null,X,c);return $.alignedTerrainElevation=T.terrainElevation,$.needsElevationUpdates=g.needsElevationUpdates3D(c.mode),$},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[w.VertexAttrConstants.POSITION]=n,s[w.VertexAttrConstants.NORMAL]=n,s[w.VertexAttrConstants.COLOR]=i,l[w.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[w.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[w.VertexAttrConstants.COLOR]={size:4,data:r},l[w.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new S(l,s)},t.prototype._createEdgeMaterial=function(e){var t={opacity:this._getLayerOpacity()};return y.createMaterial(e,this.symbolLayer,t)},t}(h.default);t.Graphics3DExtrudeSymbolLayer=B;var U=p.vec3f64.create(),F=p.vec3f64.create(),N=p.vec3f64.create(),H=p.vec3f64.create(),Y=p.vec3f64.create(),W=p.vec3f64.create(),Z=p.vec3f64.create();t.default=B});