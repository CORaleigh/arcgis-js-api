// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../Graphic","../../../../core/Accessor","../../../../core/compilerUtils","../../../../core/Handles","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/webMercatorUtils","../../../../renderers/support/diffUtils","../../../../tasks/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFilterVisibility","./Graphics3DFrustumVisibility","./Graphics3DHighlights","./Graphics3DScaleVisibility","./Graphics3DSpatialIndex","./graphicUtils","../support/attributeUtils"],function(e,t,i,s,r,n,a,l,o,p,h,u,c,d,y,g,f,b,m,v,E,x,V,w){var C=function(e){function t(t){var i=e.call(this)||this;return i._handles=new l,i.highlights=new v,i.suspendResumeExtentMode="computed",i.dataExtent=null,i.suspendResumeExtent=null,i}return i(t,e),Object.defineProperty(t.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating)},enumerable:!0,configurable:!0}),t.prototype.normalizeCtorArgs=function(e){var t=!e.queryGraphicUIDsInExtent&&(e.scaleVisibilityEnabled||e.elevationAlignmentEnabled),i=t?new x({spatialReference:e.owner.view.spatialReference}):null,s=e.frustumVisibilityEnabled?new m:null,r=e.scaleVisibilityEnabled?new E:null,n=e.filterVisibilityEnabled&&"multipatch"!==e.layer.geometryType?new b.Graphics3DFilterVisibility({geometryType:e.layer.geometryType}):null,a=e.elevationAlignmentEnabled?new f:null,l=new g({owner:e.owner,layer:e.layer,asyncUpdates:e.asyncGraphicsUpdates,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1}),o=e.updateClippingExtent,p=e.queryGraphicUIDsInExtent,h=e.suspendResumeExtentMode,u=e.dataExtent,c=function(e,t,s){return i.queryGraphicUIDsInExtent(e,t,s)};return{graphicsCore:l,frustumVisibility:s,scaleVisibility:r,filterVisibility:n,elevationAlignment:a,spatialIndex:i,updateClippingExtent:o,suspendResumeExtentMode:h,dataExtent:u,queryGraphicUIDsInExtent:p||c}},t.prototype.initialize=function(){var e=this;this.scaleVisibility&&this._handles.add(this.layer.watch(["minScale","maxScale"],function(){return e.scaleVisibility.layerMinMaxScaleChangeHandler()})),this.filterVisibility&&this._handles.add(this.owner.watch("filter",function(){return e.filterVisibility.filterChanged()})),this.elevationAlignment&&this._handles.add(this.layer.watch("elevationInfo",function(t,i){c.diff(t,i)&&e.graphicsCore.elevationInfoChange()})),this._handles.add(this.layer.watch("labelsVisible",function(){return e.graphicsCore.updateVisibilityInfo()})),this._handles.add(this.layer.watch("labelingInfo",function(t,i){c.diff(t,i)&&e.graphicsCore.updateLabelingInfo()}))},t.prototype.setup=function(){var e=this;this.frustumVisibility&&this.frustumVisibility.setup(this.owner);var t=this.owner,i=this.owner.view.basemapTerrain;if(this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,this.queryGraphicUIDsInExtent,this.graphicsCore,i),this.filterVisibility&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment){var s=t.view.elevationProvider;this.elevationAlignment.setup(t,this.queryGraphicUIDsInExtent,this.graphicsCore,s)}return this.highlights&&this.highlights.setup(this.graphicsCore),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility,this.spatialIndex)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,spatialIndex:this.spatialIndex,deconfliction:this.deconfliction,labeling:this.labeling,highlights:this.highlights}),this._handles.add([this.layer.watch("renderer",function(t){return e.graphicsCore.rendererChange(t)}),t.watch("fullOpacity",function(){return e.graphicsCore.opacityChange()})]),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this._handles.add(t.view.watch("clippingArea",function(){return e._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?this.graphicsCore.updateLabelingInfo():o.resolve()},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var e=["frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","highlights","graphicsCore","spatialIndex"],t=0,i=e;t<i.length;t++){var s=i[t],r=this[s];r&&(r.destroy(),this._set(s,null))}this._set("layer",null),this._set("owner",null)},t.prototype.highlight=function(e,t,i){var s=this;if(e instanceof d){var n=this.highlights.acquireSet(t,i),a=n.set,l=n.handle;return this.owner.queryObjectIds(e).then(function(e){return s.highlights.setObjectIds(a,e)}),l}if("number"==typeof e)return this.highlight([e],t,i);if(e instanceof r)return this.highlight([e],t,i);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof r){var o=e;if(!i||!o[0].attributes||null===w.attributeLookup(o[0].attributes,i)){var p=o.map(function(e){return e.uid}),h=this.highlights.acquireSet(t,null),u=h.set,l=h.handle;return this.highlights.setUids(u,p),l}e=o.map(function(e){return w.attributeLookup(e.attributes,i)})}if("number"==typeof e[0]){var c=e,y=this.highlights.acquireSet(t,i),u=y.set,l=y.handle;return this.highlights.setObjectIds(u,c),l}}return R},t.prototype._updateClippingExtent=function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())},t.prototype.setupSuspendResumeExtent=function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(p.init(this,"suspendResumeExtentMode",function(){switch(e._handles.remove(I),e.suspendResumeExtentMode){case"computed":e._handles.add(p.init(e.graphicsCore,"computedExtent",function(t){return e.updateSuspendResumeExtent(t)}),I);break;case"data":e._handles.add(p.init(e,"dataExtent",function(t){return e.updateSuspendResumeExtent(t)}),I);break;default:a.neverReached(e.suspendResumeExtentMode)}}))},t.prototype.updateSuspendResumeExtent=function(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},t.prototype.extentToSuspendResumeRect=function(e,t){var i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!u.canProject(e,i))return;e=u.project(e,i)}return V.enlargeExtent(e,t,y.SUSPEND_RESUME_EXTENT_OPTIMISM)},t.prototype.suspendResumeExtentChanged=function(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)},s([h.property({aliasOf:"graphicsCore.layer"})],t.prototype,"layer",void 0),s([h.property({aliasOf:"graphicsCore.owner"})],t.prototype,"owner",void 0),s([h.property({constructOnly:!0})],t.prototype,"updateClippingExtent",void 0),s([h.property({constructOnly:!0})],t.prototype,"queryGraphicUIDsInExtent",void 0),s([h.property({constructOnly:!0})],t.prototype,"graphicsCore",void 0),s([h.property({constructOnly:!0})],t.prototype,"spatialIndex",void 0),s([h.property({constructOnly:!0})],t.prototype,"scaleVisibility",void 0),s([h.property({constructOnly:!0})],t.prototype,"filterVisibility",void 0),s([h.property({constructOnly:!0})],t.prototype,"elevationAlignment",void 0),s([h.property({constructOnly:!0})],t.prototype,"frustumVisibility",void 0),s([h.property({readOnly:!0})],t.prototype,"deconfliction",void 0),s([h.property({readOnly:!0})],t.prototype,"labeling",void 0),s([h.property({readOnly:!0})],t.prototype,"highlights",void 0),s([h.property()],t.prototype,"suspendResumeExtentMode",void 0),s([h.property()],t.prototype,"dataExtent",void 0),s([h.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],t.prototype,"suspended",null),s([h.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating"]})],t.prototype,"updating",null),t=s([h.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],t)}(h.declared(n)),I="suspendResumeExtentMode",R={remove:function(){},pause:function(){},resume:function(){}};return C});