// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","./featureExpressionInfoUtils","../../support/projectionUtils"],function(t,i,e,r,n,o,a,s,c,h,p,u){function l(t,i){for(var e=new Array(t),r=0;r<e.length;r++)e[r]=new Array(i);return e}var y=new o(Array,function(t){return s.set(t,s.ZERO)},null,10,5),f=c.create();return function(){function t(t,i,e,r){this.addedToSpatialIndex=!1,this._labelGraphics=[],this._auxiliaryGraphics=[],this._visibilityFlags=l(2,4),this._featureExpressionFeature=null,this.extent=null,++i.referenced,this.graphics3DSymbol=i,this.graphic=t,this._graphics=e,this._featureExpressionFeature=p.createFeature(t,r)}return t.prototype.initialize=function(t,i){var e=this;this._layer=t,this._stage=i,this.forEachSymbolLayerGraphic(function(r){r.initialize(t,i),r.setVisibility(e.isVisible())})},t.prototype.destroy=function(){this.forEachSymbolLayerGraphic(function(t){return t.destroy()}),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},Object.defineProperty(t.prototype,"destroyed",{get:function(){return null==this._graphics},enumerable:!0,configurable:!0}),t.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(t){return t.destroy()}),this._labelGraphics.length=0},t.prototype.addLabelGraphic=function(t,i,e){this._labelGraphics.push(t),t.initialize(i,e),t.setVisibility(this.isVisible(1))},t.prototype.addAuxiliaryGraphic=function(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._layer,this._stage),t.setVisibility(this.isVisible()))},t.prototype.isDraped=function(){var t=!1;return this.forEachSymbolLayerGraphic(function(i){"draped"===i.type&&(t=!0)}),t},t.prototype.isVisible=function(t,i){void 0===t&&(t=0);for(var e=0;e<=t;e++)for(var r=this._visibilityFlags[e],n=0;n<r.length;++n)if(!1===r[n]&&n!==i)return!1;return!0},t.prototype.hasVisibilityFlag=function(t,i){return null!=this._visibilityFlags[i][t]},t.prototype.setVisibilityFlag=function(t,i,e){var r=this.isVisible(e);this._visibilityFlags[e][t]=i;var n=this.isVisible(e);if(r===n)return!1;if(1===e)this.forEachLabelGraphic(function(t){return t.setVisibility(n)});else{this.forEachSymbolLayerGraphic(function(t){return t.setVisibility(n)});var o=this.isVisible(1);this.forEachLabelGraphic(function(t){return t.setVisibility(o)})}return!0},t.prototype.clearVisibilityFlag=function(t,i){return void 0===i&&(i=0),this.setVisibilityFlag(t,void 0,i)},t.prototype.getBSRadius=function(){var t=0;return this.forEachSymbolLayerGraphic(function(i){t=Math.max(t,i.getBSRadius())}),t},t.prototype.getCenterObjectSpace=function(t){return void 0===t&&(t=a.vec3f64.create()),this._graphics[0].getCenterObjectSpace(t)},t.prototype.computeExtent=function(t){if(!this.extent){this.extent=c.create();var i=this.graphic.geometry,e=i.spatialReference;if(h.computeAABR(i,this.extent),!e.equals(t)&&!u.boundingRectToBoundingRect(this.extent,e,this.extent,t))return this.extent=null,!1}return!0},Object.defineProperty(t.prototype,"usedMemory",{get:function(){var t=this,i=0;return this.forEachSymbolLayerGraphic(function(e){var r=e.graphics3DSymbolLayer.complexity,n="draped"===e.type?r.memory.draped:r.memory;i+=n.bytesPerFeature,n.bytesPerCoordinate&&(i+=h.numVertices(t.graphic.geometry)*n.bytesPerCoordinate)}),i},enumerable:!0,configurable:!0}),t.prototype.getProjectedBoundingBox=function(t,i,o,a){return r(this,void 0,void 0,function(){var h=this;return e(this,function(p){switch(p.label){case 0:return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?s.empty(a.boundingBox):a.boundingBox=s.empty(),a.requiresDrapedElevation=!1,[4,n.forEach(this._graphics,function(n){return r(h,void 0,void 0,function(){var r,c,h;return e(this,function(e){switch(e.label){case 0:return n?(r="draped"===n.type?i:t,c=y.acquire(),[4,n.getProjectedBoundingBox(r,o,a.screenSpaceObjects,c)]):[2];case 1:return h=e.sent(),isFinite(h[2])&&isFinite(h[5])||(a.requiresDrapedElevation=!0),h&&s.expand(a.boundingBox,c),y.release(c),[2]}})})})];case 1:return p.sent(),s.allFinite(a.boundingBox)||c.allFinite(s.toRect(a.boundingBox,f))?[2,a]:[2,null]}})})},t.prototype.needsElevationUpdates=function(){for(var t=0,i=this._graphics;t<i.length;t++){var e=i[t];if(e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0}for(var r=0,n=this._labelGraphics;r<n.length;r++){var e=n[r];if(e&&e.needsElevationUpdates)return!0}return!1},t.prototype.alignWithElevation=function(t,i){var e=this;this.forEachRenderedGraphic(function(r){"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(t,i,e._featureExpressionFeature)})},t.prototype.addHighlight=function(t,i){this.forEachSymbolLayerGraphic(function(e){return e.addHighlight(t,i)})},t.prototype.removeHighlight=function(t){this.forEachSymbolLayerGraphic(function(i){return i.removeHighlight(t)})},t.prototype.forEachGraphicList=function(t,i){t.forEach(function(t,e){return t&&i(t,e)})},t.prototype.forEachSymbolLayerGraphic=function(t){this.forEachGraphicList(this._graphics,t),this.forEachGraphicList(this._auxiliaryGraphics,t)},t.prototype.forEachLabelGraphic=function(t){this.forEachGraphicList(this._labelGraphics,t)},t.prototype.forEachRenderedGraphic=function(t){this.forEachSymbolLayerGraphic(t),this.forEachLabelGraphic(t)},t}()});