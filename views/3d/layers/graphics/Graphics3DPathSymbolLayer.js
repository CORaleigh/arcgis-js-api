// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/lang","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Point","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial"],function(e,t,r,a,i,n,o,s,l,p,c,d,u,h,y,m,f,v,g,_,b){function x(e,t,r,a){var i=e.stageObject,n=i.getMetadata().pathGeometries,o=i.getGeometryRecords(),s=o.length;P.spatialReference=r.spatialReference;for(var l="absolute-height"!==t.mode,p=0,d=0;d<s;d++){for(var u=o[d],h=u.geometry,y=n[h.id],m=0,f=0,v=y.builder.path.vertices;f<v.length;f++){var g=v[f];P.x=g.mapPos[0],P.y=g.mapPos[1],P.z=g.mapPos[2],g.elevation=c.computeElevation(r,P,t,a,l?D:null),l&&(m+=D.terrainElevation)}y.updateElevation(a),h.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(d),p+=m/y.builder.path.vertices.length}return p/s}Object.defineProperty(t,"__esModule",{value:!0});var S=function(e){function t(t,r,a,n){var o=e.call(this,t,r,a,n)||this;if(!o._isPropertyDriven("size")){var l=u.validateSymbolLayerSize(o._getSymbolSize());if(l)return o._logWarning(l),o.reject(),o}o._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:o._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},o._context.renderer&&o._context.renderer.visualVariables&&o._context.renderer.visualVariables.length>0?o._fastUpdates=h.initFastSymbolUpdatesState(o._context.renderer,o._vvConvertOptions):o._fastUpdates={enabled:!1};var p=o._getStageIdHint(),c=o._getMaterialOpacityAndColor(),d=s.vec3f64.fromArray(c),y=c[3],f={diffuse:d,ambient:d,opacity:y,transparent:y<1||o._isPropertyDriven("opacity"),vertexColors:!1,slicePlaneEnabled:o._context.slicePlaneEnabled,castShadows:o.symbolLayer.castShadows};o._fastUpdates.enabled?(i.mixin(f,o._fastUpdates.materialParameters,{size:o._getSize()}),o._material=new b(f,p+"_pathmat")):(f.vertexColors=o._isPropertyDriven("color")||o._isPropertyDriven("opacity"),o._material=new _(f,p+"_pathmat")),o._context.stage.add(m.ModelContentType.MATERIAL,o._material),o._profile=g.Profile.tube(w);var v="tube";switch("profile"in o.symbolLayer&&(v=o.symbolLayer.profile),v){case"tube":default:o._profile=g.Profile.tube(w);break;case"strip":o._profile=g.Profile.strip(),o._material.setParameterValues({cullFace:"none"});break;case"fence":o._profile=g.Profile.fence(),o._material.setParameterValues({cullFace:"none"});break;case"wall":o._profile=g.Profile.wall()}o._extruder=new g.SimpleExtruder;var x="simple";switch("joint"in o.symbolLayer&&(x=o.symbolLayer.joint),x){case"round":o._extruder=new g.RoundExtruder(4);break;case"bevel":o._extruder=new g.BevelExtruder;break;case"simple":default:o._extruder=new g.SimpleExtruder}return o.resolve(),o}return r(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(m.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,a=this.getGraphicElevationContext(t),i=e.renderingInfo;return this._createAs3DShape(t,i,a,r,t.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getMaterialOpacity(),t=e<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:e,transparent:t}),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var a=this;return e.forEach(function(e){var r=t(e);if(r){var i=e.graphic,n=a.getGraphicElevationContext(i);r.needsElevationUpdates=c.needsElevationUpdates3D(n.mode),r.elevationContext.set(n)}}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!h.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;var a={};i.mixin(a,this._fastUpdates.materialParameters),this._material.setParameterValues(a);break;default:return!1}return!0},t.prototype._getSymbolSize=function(){return this.symbolLayer.size||1},t.prototype._getSize=function(){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?1:.5*this._getSymbolSize()/this._context.renderCoordsHelper.unitInMeters},t.prototype._createAs3DShape=function(e,t,r,a,i){var l={},u=e.geometry,h=u.paths,m=[],_=[],b=[],S=s.vec3f64.create(),P=this._context.renderSpatialReference,D=P===y.SphericalECEFSpatialReference,w=new Array(6),E=c.getGeometryVertexData3D(h,u.hasZ,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(E,h,"paths","PathSymbol3DLayer"),h.length>0){for(var C=E.geometryData.outlines,U=E.eleVertexData,G=E.vertexData,z=0;z<C.length;++z){var L=C[z],V=L.index,M=L.count;if(!(M<2)&&(!this._context.clippingExtent||(c.computeBoundingBox(U,V,M,w),!c.boundingBoxClipped(w,this._context.clippingExtent)))){c.chooseOrigin(G,V,M,S),c.subtractCoordinates(G,V,M,S);var A=o.mat4f64.create();n.mat4.translate(A,A,S);var R=new g.Path(G,U,V,M,D,S),O=new g.Builder(R,this._profile,this._extruder),I=null;if(this._fastUpdates.enabled){var j=this._fastUpdates.visualVariables,F=j.size?d.getAttributeValue(j.size.field,e):0,H=j.color?d.getAttributeValue(j.color.field,e):0,T=j.opacity?d.getAttributeValue(j.opacity.field,e):0;I=new g.FastUpdatePathGeometry(O,F,H,T)}else{var k=1;this._isPropertyDriven("size")?k=t.size[0]:this.symbolLayer.size&&(k=this.symbolLayer.size),k*=.5/this._context.renderCoordsHelper.unitInMeters;var B=null;this._isPropertyDriven("color")&&(B=t.color),this._isPropertyDriven("opacity")&&null!=t.opacity&&(B=B?[B[0],B[1],B[2],t.opacity]:[1,1,1,t.opacity]),I=new g.StaticPathGeometry(O,k,B)}var W=I.createGeometryData(),q=new f(W,a+"path"+z);l[q.id]=I,q.singleUse=!0,m.push(q),_.push(this._material),b.push(A)}}var Z={layerUid:this._context.layer.uid,graphicUid:i,pathGeometries:l};if(m.length>0){var J=new v({geometries:m,materials:_,transformations:b,castShadow:!0,metadata:Z,idHint:a}),K=x,N=new p(this,J,m,null,null,K,r);return N.alignedTerrainElevation=E.terrainElevation,N.needsElevationUpdates=c.needsElevationUpdates3D(r.mode),N}}return null},t}(d.Graphics3DSymbolLayer);t.Graphics3DPathSymbolLayer=S;var P=new l,D={verticalDistanceToGround:0,terrainElevation:0},w=10;t.default=S});