// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry"],function(e,t,r,i,n,a,o,l,s,p,c,u,h,y,d,g,m,f,_,v){function x(e){return null!=e.size?i.pt2px(e.size):1}Object.defineProperty(t,"__esModule",{value:!0});var b=function(e){function t(t,r,i,n){var a=e.call(this,t,r,i,n)||this,o={idHint:a._getStageIdHint(),width:x(r),color:a._getMaterialOpacityAndColor(),slicePlaneEnabled:a._context.slicePlaneEnabled};if(!a._isPropertyDriven("size")){var l=d.validateSymbolLayerSize(o.width);if(l)return a._logWarning(l),a.reject(),a}return o.width<=0?(a.reject(),a):(a._isPropertyDriven("size")&&(o.width=0),a._material=g.createRibbonMaterial(o),a._context.stage.add(m.ModelContentType.MATERIAL,a._material),a.resolve(),a)}return r(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(m.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,n=r.geometry;if("polyline"!==n.type&&"polygon"!==n.type&&"extent"!==n.type)return this._logWarning("unsupported geometry type for line symbol: "+n.type),null;if(!this._validateGeometry(n))return null;var a="polygon"===n.type||"extent"===n.type?"rings":"paths",o="graphic"+r.uid,l=this._getVertexOpacityAndColor(t,Float32Array,255),s=0;t.size&&this._isPropertyDriven("size")&&(s=h.getSingleSizeDriver(t.size),s=i.pt2px(s));var p=this.getGraphicElevationContext(r);return"on-the-ground"===p.mode?this._createAsOverlay(r,a,l,s,p,o,this._context.layer.uid):this._createAs3DShape(r,a,l,s,p,o,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.getColor(),t=[e[0],e[1],e[2],this._getMaterialOpacity()],r={color:t};return this._material.setParameterValues(r),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var i=this._elevationContext.mode;if(null==r||null==i)return!1;if("on-the-ground"===r&&"on-the-ground"===i)return!0;if(r!==i&&("on-the-ground"===r||"on-the-ground"===i))return!1;var n=h.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,t,function(){return n})},t.prototype.slicePlaneEnabledChanged=function(e,t){var r={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._material.setParameterValues(r),!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype._getOutlineGeometry=function(e,t){return t},t.prototype._getGeometry=function(e){var t=e.geometry;return"extent"===t.type&&(t=l.fromExtent(t)),t},t.prototype._createAs3DShape=function(e,t,r,i,l,s,c){var y=this._getGeometry(e),d=y[t],m=this._getOutlineGeometry(y,d),v=[],x=[],b=[],E=o.vec3f64.create(),D=new Array(6),G=h.getGeometryVertexData3D(m,y.hasZ,y.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,l);if(this._logGeometryCreationWarnings(G,d,t,"LineSymbol3DLayer"),m.length>0){for(var C=G.geometryData.outlines,S=G.eleVertexData,w=G.vertexData,P=0;P<C.length;++P){var A=C[P];if(!(A.count<=1)){var L=A.index,O=A.count;if(!this._context.clippingExtent||(h.computeBoundingBox(S,L,O,D),!h.boundingBoxClipped(D,this._context.clippingExtent))){h.chooseOrigin(w,L,O,E),h.subtractCoordinates(w,L,O,E);var R=new Float64Array(S.buffer,3*L*S.BYTES_PER_ELEMENT,3*O),M=new Float64Array(w.buffer,3*L*w.BYTES_PER_ELEMENT,3*O),B=g.createPolylineGeometry(M,R,"rings"===t,r,i),T=new f(B,s+"path"+P);T.singleUse=!0,v.push(T),x.push(this._material);var U=a.mat4f64.create();n.mat4.translate(U,U,E),b.push(U)}}}if(v.length>0){var z=new _({geometries:v,materials:x,transformations:b,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:c},idHint:s}),V=p.perVertexElevationAligner,j=new u(this,z,v,null,null,V,l);return j.alignedTerrainElevation=G.terrainElevation,j.needsElevationUpdates=h.needsElevationUpdates2D(l.mode),j}}return null},t.prototype._createAsOverlay=function(e,t,r,i,l,p,u){var y=this._getGeometry(e);this._material.renderPriority=this._symbolLayerOrder;var d=y[t],m=this._getOutlineGeometry(y,d),f=[],_=new Array(6),x=s.empty(),b=o.vec3f64.create(),E=h.getGeometryVertexDataDraped(m,y.spatialReference,this._context.overlaySR);if(this._logGeometryCreationWarnings(E,d,t,"LineSymbol3DLayer"),m.length>0){for(var D=E.vertexData,G=E.geometryData.outlines,C=0;C<G.length;++C){var S=G[C],w=S.index,P=S.count;if(h.computeBoundingBox(D,w,P,_),!h.boundingBoxClipped(_,this._context.clippingExtent)){s.expand(x,_),h.chooseOrigin(D,w,P,b),h.subtractCoordinates(D,w,P,b),h.setZ(D,w,P,this._getDrapedZ());var A=new Float64Array(D.buffer,3*w*D.BYTES_PER_ELEMENT,3*P),L=a.mat4f64.create();n.mat4.translate(L,L,b);var O=g.createPolylineGeometry(A,null,"rings"===t,r,i),R=new v(O);R.data.layerUid=u,R.data.graphicUid=e.uid,R.material=this._material,R.center=[.5*(_[0]+_[3]),.5*(_[1]+_[4]),0],R.bsRadius=.5*Math.sqrt((_[3]-_[0])*(_[3]-_[0])+(_[4]-_[1])*(_[4]-_[1])),R.transformation=L,R.name=p,R.uniqueName=p+"#"+O.id,f.push(R)}}return new c(this,f,x)}return null},t}(y.default);t.Graphics3DLineSymbolLayer=b,t.default=b});