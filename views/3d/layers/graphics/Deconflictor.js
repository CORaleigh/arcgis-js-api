// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/Handles","../../../../core/PooledArray","../../../../core/watchUtils","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingRect","./deconflictorDebug","../../support/debugFlags","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils","../../support/geometryUtils/sphere","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(i,e,t,r,s,a,n,o,c,h,l,p,u,f,v,d,g,y,b,m,G,x){function D(i){var e,t,s,a;return r(this,function(r){switch(r.label){case 0:e=[];for(t in i)e.push(t);s=0,r.label=1;case 1:return s<e.length?(a=e[s],[4,i[a]]):[3,4];case 2:r.sent(),r.label=3;case 3:return s++,[3,1];case 4:return[2]}})}Object.defineProperty(e,"__esModule",{value:!0});var w=l.vec4f64.create(),V=l.vec4f64.create(),M=l.vec4f64.create(),P=l.vec4f64.create(),S=h.vec3f64.fromValues(0,0,0),C=d.sphere.create(),B=d.ray.create(),I=h.vec3f64.create(),E=p.create(),F=p.create(),A=function(){function i(){this.xMin=0,this.xMax=0,this.yMin=0,this.yMax=0,this.posView=0,this.culled=!1,this.visible=!1,this.pooled=!1}return i}(),R=function(){function i(i,e,t){void 0===t&&(t={}),this.graphics3DGraphic=i,this.slicePlaneEnabled=e,this.info=t}return i}(),T=function(){function i(i,e){void 0===e&&(e=new Map),this.graphics3DCore=i,this.graphics=e}return i}(),N=function(){function i(i){var e,t,r=this;this.handles=new s,this.dirty=!0,this.state=0,this.contexts=[],this.graphics=null,this.iterators=null,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0,this._iconMarginFactor=-.1,this.slicePlaneViewSpace=null,this.view=i,this.graphics=(e={},e[0]={active:{},visible:new a,remove:new a},e[1]={active:{},visible:new a,remove:new a},e),this.iterators=(t={},t[0]={active:null,visible:null,remove:null,sort:null},t[1]={active:null,visible:null,remove:null,sort:null},t),this.handles.add([i.watch("state.camera",function(){r.updateSlicePlane(),r.setDirtyUrgent()}),i.watch("map.ground.opacity",function(i,e){1!==i&&1!==e||r.setDirtyUrgent()}),n.init(i,"slicePlane",function(){return r.updateSlicePlane()})]),this.frameWorker=i.resourceController.scheduler.registerTask(12,function(i){return r.run(i)},function(){return r.shouldRun()})}return Object.defineProperty(i.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(i){this._iconMarginFactor=i,this.setDirty()},enumerable:!0,configurable:!0}),i.prototype.updateSlicePlane=function(){var i=this.view&&this.view.slicePlane;if(!i)return void(this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged()));this.slicePlaneViewSpace||(this.slicePlaneViewSpace=d.boundedPlane.create());var e=this.view.state.camera,t=e.viewMatrix;d.boundedPlane.transform(i,t,this.slicePlaneViewSpace),this.slicePlaneChanged()},i.prototype.slicePlaneChanged=function(){for(var i=0,e=this.contexts;i<e.length;i++){if(e[i].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();break}}},i.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.graphics[0].active=null,this.graphics[0].visible.clear(),this.graphics[0].remove.clear(),this.graphics[1].active=null,this.graphics[1].visible.clear(),this.graphics[1].remove.clear(),this.graphics=null,this.iterators=null,this.view=null},i.prototype.addGraphicsOwner=function(i){var e,t=this,r=this.findDeconflictionContext(i);return-1!==r?e=this.contexts[r]:(e=new T(i),this.contexts.push(e),this.setDirtyUrgent()),{addGraphic:function(i){return t.addGraphic(e,i)},removeGraphic:function(i){return t.removeGraphic(e,i)},labelingInfoChange:function(){return t.globalLabelingInfoChanged(e)},visibilityInfoChange:function(){},featureReductionChange:function(){return t.globalFeatureReductionChanged(e)},slicePlaneEnabledChange:function(){return t.globalSlicePlaneEnabledChanged(e)},clear:function(){e.graphics.forEach(function(i){t.removeGraphic(e,i.graphics3DGraphic)})}}},i.prototype.removeGraphicsOwner=function(i){var e=this,t=this.findDeconflictionContext(i);if(-1!==t){var r=this.contexts.splice(t,1)[0];r.graphics.forEach(function(i){return e.removeGraphic(r,i.graphics3DGraphic)}),this.setDirtyUrgent()}},i.prototype.setInitialIconVisibilityFlag=function(i,e){var t=!(this.graphicSupportsDeconfliction(e)&&this.isFeatureReductionEnabled(i));e.setVisibilityFlag(3,t,0)},Object.defineProperty(i.prototype,"isDirty",{get:function(){return 0!==this.state||this.dirty},enumerable:!0,configurable:!0}),i.prototype.setDirtyUrgent=function(){this.dirty=!0,this.frameWorker.priority=2},i.prototype.setDirty=function(){this.dirty=!0,this.frameWorker.priority=12},i.prototype.shouldRun=function(){return this.view.ready&&null!=this.view.state&&this.isDirty},i.prototype.run=function(i){switch(this.state){case 0:u.prepare(this.view),this.dirty=!1,this.camera=this.view.state.camera;var e=this.camera.fullWidth,t=this.camera.fullHeight;this.initBins(e,t),this.resetIterators(),i.madeProgress();case 1:if(this.state=1,!this.processActiveGraphics(0,i))return;case 3:if(this.state=3,!this.cleanVisibleGraphics(0,i))return;case 5:if(this.state=5,!this.sortVisibleGraphics(0,i))return;case 7:if(this.state=7,!this.deconflictVisibleGraphics(0,i))return;u.drawAccelerationStruct(this,this.graphics[0].visible);case 2:if(this.state=2,!this.processActiveGraphics(1,i))return;case 4:if(this.state=4,!this.cleanVisibleGraphics(1,i))return;case 6:if(this.state=6,!this.sortVisibleGraphics(1,i))return;case 8:if(this.state=8,!this.deconflictVisibleGraphics(1,i))return;u.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=0}},i.prototype.findDeconflictionContext=function(i){for(var e=0;e<this.contexts.length;e++)if(this.contexts[e].graphics3DCore===i)return e;return-1},i.prototype.globalFeatureReductionChanged=function(i){var e=this.isFeatureReductionEnabled(i.graphics3DCore);e||this.clearVisibilityFlags(i),this.modifyGraphics(i,e,0)},i.prototype.globalLabelingInfoChanged=function(i){var e=this.isLabelDeconflictionEnabled(i.graphics3DCore);this.modifyGraphics(i,e,1)},i.prototype.globalSlicePlaneEnabledChanged=function(i){var e=i.graphics3DCore.symbolCreationContext.slicePlaneEnabled;i.graphics.forEach(function(i){i.slicePlaneEnabled=e}),this.setDirtyUrgent()},i.prototype.modifyGraphics=function(i,e,t){var r=this;e?i.graphics.forEach(function(i){return r.addToActiveGraphics(i,t)}):i.graphics.forEach(function(i){return r.removeFromActiveGraphics(i,t)}),this.setDirtyUrgent()},i.prototype.graphicSupportsDeconfliction=function(i){var e=i._graphics;if(!e||!e.length)return!1;if(i.isDraped())return!1;for(var t=0,r=e;t<r.length;t++){var s=r[t];if(this.graphics3DGraphicsLayerSupportsDeconfliction(s))return!0}return!1},i.prototype.graphics3DGraphicsLayerSupportsDeconfliction=function(i){if(!i||"object3d"!==i.type)return!1;var e=i.stageObject;return 1===(e?e.getNumGeometryRecords():0)&&e.getGeometryRecord(0).material instanceof G},i.prototype.addGraphic=function(i,e){var t=e.graphic.uid,r=new R(e,i.graphics3DCore.symbolCreationContext.slicePlaneEnabled);i.graphics.set(t,r),this.isFeatureReductionEnabled(i.graphics3DCore)&&this.addToActiveGraphics(r,0),this.isLabelDeconflictionEnabled(i.graphics3DCore)&&this.addToActiveGraphics(r,1),this.setDirty()},i.prototype.removeGraphic=function(i,e){var t=e.graphic.uid,r=i.graphics.get(t);r&&(this.removeFromActiveGraphics(r,0),this.removeFromActiveGraphics(r,1),i.graphics.delete(t),this.setDirty())},i.prototype.addToActiveGraphics=function(i,e){i.info[e]=new A;var t=i.graphics3DGraphic.graphic.uid;this.graphics[e].active[t]=i},i.prototype.removeFromActiveGraphics=function(i,e){this.removeFromVisibleGraphics(i,e),this.clearGraphicVisibility(i,e),delete i.info[e];var t=i.graphics3DGraphic.graphic.uid;delete this.graphics[e].active[t]},i.prototype.addToVisibleGraphics=function(i,e){var t=i.info[e];t&&!t.pooled&&(this.graphics[e].visible.push(i),t.pooled=!0)},i.prototype.removeFromVisibleGraphics=function(i,e){var t=i.info[e];t&&t.pooled&&(this.graphics[e].remove.push(i),t.pooled=!1)},i.prototype.processActiveGraphics=function(i,e){for(var t=this.getOrCreateActiveGraphicsIterator(i),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&this.camera.relativeElevation>0;!e.done;){e.madeProgress();var s=t.next();if(s.done)return this.resetActiveGraphicsIterator(i),!0;var a=s.value,n=a&&a.info[i];n&&(this.collectGraphics3DGraphics(a,i,r),n.culled?this.removeFromVisibleGraphics(a,i):this.addToVisibleGraphics(a,i))}return!1},i.prototype.cleanVisibleGraphics=function(i,e){for(var t=this.graphics[i],r=this.ensureRemoveGraphicsIterator(i,e);!e.done;){var s=r.next();if(e.madeProgress(),s.done)return t.remove.clear(),this.resetRemoveGraphicsIterator(i),!0}return!1},i.prototype.sortVisibleGraphics=function(i,e){for(var t=this.ensureSortGraphicsIterator(i,function(e,t){return e.info[i]&&t.info[i]?t.info[i].posView-e.info[i].posView:Number.MAX_VALUE},e);!e.done;){var r=t.next();if(e.madeProgress(),r.done)return this.resetSortGraphicsIterator(i),!0}return!1},i.prototype.deconflictVisibleGraphics=function(i,e){for(var t=this.getOrCreateVisibleGraphicsIterator(i),r=1===i;!e.done;){e.madeProgress();var s=t.next();if(s.done)return this.resetVisibleGraphicsIterator(i),!0;var a=s.value,n=a.info[i];if(n&&!n.culled){var o=a.graphics3DGraphic,c=r&&!o.isVisible(),h=!c&&!this.doesIntersectExistingPoly(a,i);n.visible=h,h&&this.addToBins(a,i),this.setGraphicVisibility(a,i,h),h&&u.drawPoly(n,h?"green":"red")}}return!1},i.prototype.resetIterators=function(){this.iterators[0].active=null,this.iterators[0].visible=null,this.iterators[0].remove=null,this.iterators[0].sort=null,this.iterators[1].active=null,this.iterators[1].visible=null,this.iterators[1].remove=null,this.iterators[1].sort=null},i.prototype.getOrCreateActiveGraphicsIterator=function(i){var e=this.graphics[i],t=this.iterators[i];return t.active||(t.active=D(e.active)),t.active},i.prototype.resetActiveGraphicsIterator=function(i){this.iterators[i].active=null},i.prototype.getOrCreateVisibleGraphicsIterator=function(i){var e=this.graphics[i],t=this.iterators[i];return t.visible||(t.visible=e.visible.iterableForEach()),t.visible},i.prototype.resetVisibleGraphicsIterator=function(i){this.iterators[i].visible=null},i.prototype.ensureRemoveGraphicsIterator=function(i,e){var t=this.graphics[i],r=this.iterators[i];return r.remove||(r.remove=t.visible.iterableRemoveMany(t.remove.data,function(){return e.done})),r.remove},i.prototype.resetRemoveGraphicsIterator=function(i){this.iterators[i].remove=null},i.prototype.ensureSortGraphicsIterator=function(i,e,t){var r=this.graphics[i],s=this.iterators[i];return s.sort||(s.sort=r.visible.iterableSort(e,function(){return t.done})),s.sort},i.prototype.resetSortGraphicsIterator=function(i){this.iterators[i].sort=null},i.prototype.collectGraphics3DGraphics=function(i,e,t){var r=i.graphics3DGraphic;if(!r.destroyed){var s=1===e,a=s?r._labelGraphics:r._graphics,n=s?0:this.iconMarginFactor,o=i.info[e];if(!r.isVisible(0,3))return void(o.culled=!0);for(var h,l,u=p.empty(E),G=0,D=a;G<D.length;G++){var A=D[G];if(this.graphics3DGraphicsLayerSupportsDeconfliction(A)){var R=A.stageObject,T=R.getGeometryRecord(0),N=T.material,z=this.camera,L=T.geometry.data,X=L.getVertexAttr();if(t&&(C.radius=v.earthRadius,c.vec3.sub(B.direction,R.getCenter(),this.camera.eye),c.vec3.copy(B.origin,this.camera.eye),y.intersectRay(C,B,I))){var Y=Math.abs(Math.tan(c.vec3.angle(R.getCenter(),B.direction))),_=1-Y/this.view.width,W=Math.pow(_,4),j=c.vec3.sqrDist(this.camera.eye,I);if(W*c.vec3.sqrDist(this.camera.eye,R.getCenter())>j)return void(o.culled=!0)}if(!l){var k=R.getCenter(),H=T.origin.vec3;x.transformToWorld(k,H,w),x.transformToView(w,H,z.viewMatrix,V);var q=X[m.VertexAttrConstants.NORMAL].data;if(N.applyVerticalOffsetTransformation(V,q,R.objectTransformation,z,U),i.slicePlaneEnabled&&this.slicePlaneViewSpace&&d.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,V))return void(o.culled=!0);var J=X[m.VertexAttrConstants.AUXPOS1].data,K="screen"!==N.getParameters().centerOffsetUnits,Q=K?J:S;x.transformToProjection(V,z.projectionMatrix,Q,M),l=x.transformToNDC(M,P),K||(l[0]+=J[0]/z.fullWidth*2,l[1]+=J[1]/z.fullHeight*2);if(l[0]<-1||l[1]<-1||l[2]<-1||l[0]>=1||l[1]>=1)break;h=V[2],!f.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&o.visible&&(h*=.7)}var Z=A.getScreenSize(O);Z[0]*=z.pixelRatio,Z[1]*=z.pixelRatio,b.applyPrecomputedScaleFactorVec2(Z,U.factor,Z);var $=p.offset(N.calculateRelativeScreenBounds(Z,U.factorAlignment.scale,F),g.lerp(0,z.fullWidth,.5+.5*l[0]),g.lerp(0,z.fullHeight,.5+.5*l[1]));if(0!==n){var ii=n*Math.min(p.width($),p.height($));$[0]-=ii,$[1]-=ii,$[2]+=ii,$[3]+=ii}p.expand(u,$)}}null==h?o.culled=!0:(o.xMin=u[0],o.yMin=u[1],o.xMax=u[2],o.yMax=u[3],o.posView=h,o.culled=!1)}},i.prototype.doesIntersectExistingPoly=function(i,e){for(var t=i.graphics3DGraphic.graphic.uid,r=i.info[e],s=Math.floor(r.xMin/this.accBinsSizeX);s<=Math.floor(r.xMax/this.accBinsSizeX);s++)if(!(s<0||s>=this.accBinsNumX))for(var a=Math.floor(r.yMin/this.accBinsSizeY);a<=Math.floor(r.yMax/this.accBinsSizeY);a++)if(!(a<0||a>=this.accBinsNumY))for(var n=this.accBins[s][a],o=0;o<n.length;o++){var c=n.data[o],h=c.info[e];if(h&&h.visible&&(c.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,!(h.xMin>r.xMax||h.xMax<r.xMin||h.yMin>r.yMax||h.yMax<r.yMin))))return!0}return!1},i.prototype.initBins=function(i,e){if(null==this.accBins){this.accBins=[];for(var t=0;t<this.accBinsNumX;t++){this.accBins.push([]);for(var r=this.accBins[this.accBins.length-1],s=0;s<this.accBinsNumY;s++)r.push(new a)}}for(var t=0;t<this.accBinsNumX;t++)for(var s=0;s<this.accBinsNumY;s++)this.accBins[t][s].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=e/this.accBinsNumY,this.accNumTests=0},i.prototype.addToBins=function(i,e){for(var t=i.info[e],r=Math.floor(t.xMin/this.accBinsSizeX);r<=Math.floor(t.xMax/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(var s=Math.floor(t.yMin/this.accBinsSizeY);s<=Math.floor(t.yMax/this.accBinsSizeY);s++)s<0||s>=this.accBinsNumY||this.accBins[r][s].push(i)},i.prototype.isFeatureReductionEnabled=function(i){var e=i.layer;return!(!e||!e.featureReduction||"selection"!==e.featureReduction.type)},i.prototype.isLabelDeconflictionEnabled=function(i){return i.labelsEnabled},i.prototype.clearVisibilityFlags=function(i){var e=i.graphics3DCore.graphics3DGraphics;e&&e.forEach(function(i){return i.clearVisibilityFlag(3)})},i.prototype.setGraphicVisibility=function(i,e,t){var r=i.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(3,t,e),1===e&&this.view.labeler.setLabelGraphicVisibility(r,t))},i.prototype.clearGraphicVisibility=function(i,e){var t=i.graphics3DGraphic;t.destroyed||t.clearVisibilityFlag(3,e)},i}();e.Deconflictor=N;var U={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},O=o.vec2f64.create()});