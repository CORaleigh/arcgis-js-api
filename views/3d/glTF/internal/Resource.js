// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/assignHelper","../../../../core/compilerUtils","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/quat","../../../../core/libs/gl-matrix-2/quatf64","./BinaryStreamReader","./fillDefaults","./pathUtils","../../support/buffer/BufferView","../../support/buffer/utils"],function(e,t,r,n,o,s,i,a,u,c,f,p,d,l,h,b,y,m,w){function T(e){switch(e.componentType){case 5120:return new m.BufferViewVec2i8(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5121:return new m.BufferViewVec2u8(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5122:return new m.BufferViewVec2i16(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5123:return new m.BufferViewVec2u16(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5125:return new m.BufferViewVec2u32(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5126:return new m.BufferViewVec2f(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:s.neverReached(e.componentType)}}function O(e){return r(this,void 0,void 0,function(){return n(this,function(t){return[2,a.create(function(t,r){var n=new Blob([e]),o=new FileReader;o.onload=function(){var e=o.result;t(JSON.parse(e))},o.onerror=function(e){r(e)},o.readAsText(n)})]})})}function C(e,t){return r(this,void 0,void 0,function(){return n(this,function(r){return[2,a.create(function(r,n){var o=new Blob([e],{type:t}),s=URL.createObjectURL(o),i=new Image;i.addEventListener("load",function(){URL.revokeObjectURL(s),r(i)}),i.addEventListener("error",function(e){URL.revokeObjectURL(s),n(e)}),i.src=s})]})})}Object.defineProperty(t,"__esModule",{value:!0});var v,x={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20},U=function(){function e(e,t,r,n,o){this.context=e,this.errorContext=t,this.uri=r,this.json=n,this.glbBuffer=o,this.bufferCache=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=y.splitURI(this.uri).dirPart,this.checkVersionSupported(),this.checkRequiredExtensionsSupported(),t.errorUnsupportedIf(null==n.scenes,"Scenes must be defined."),t.errorUnsupportedIf(null==n.meshes,"Meshes must be defined"),t.errorUnsupportedIf(null==n.nodes,"Nodes must be defined."),this.computeNodeParents()}return e.load=function(t,o,s){return r(this,void 0,void 0,function(){var r,a,u,c,f,u,p;return n(this,function(n){switch(n.label){case 0:return i.endsWith(s,".gltf")?[4,t.loadJson(s)]:[3,2];case 1:return r=n.sent(),[2,new e(t,o,s,r)];case 2:return i.endsWith(s,".glb")?[4,t.loadBinary(s)]:[3,5];case 3:return a=n.sent(),[4,e.parseGLB(o,a)];case 4:return u=n.sent(),[2,new e(t,o,s,u.json,u.binaryData)];case 5:return[4,t.loadBinary(s)];case 6:return c=n.sent(),f=new h.BinaryStreamReader(c),f.remainingBytes()>=4&&f.readUint32()===x.MAGIC?[4,e.parseGLB(o,c)]:[3,8];case 7:return u=n.sent(),[2,new e(t,o,s,u.json,u.binaryData)];case 8:return[4,t.loadJson(s)];case 9:return p=n.sent(),[2,new e(t,o,s,p)]}})})},e.parseGLB=function(e,t){return r(this,void 0,void 0,function(){var r,o,s,i,a,u,c,f,p;return n(this,function(n){switch(n.label){case 0:r=new h.BinaryStreamReader(t),e.assert(r.remainingBytes()>=12,"GLB binary data is insufficiently large."),o=r.readUint32(),s=r.readUint32(),i=r.readUint32(),e.assert(o===x.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),e.assert(t.byteLength>=i,"GLB binary data is smalller than header specifies."),e.errorUnsupportedIf(2!==s,"Only GLB container version 2 is supported."),a=0,n.label=1;case 1:return r.remainingBytes()>=8?(f=r.readUint32(),p=r.readUint32(),0!==a?[3,3]:(e.assert(p===x.CHUNK_TYPE_JSON,"First GLB chunck must be JSON."),e.assert(f>=0,"No JSON data found."),[4,O(r.readUint8Array(f))])):[3,5];case 2:return u=n.sent(),[3,4];case 3:1===a?(e.errorUnsupportedIf(p!==x.CHUNK_TYPE_BIN,"Second GLB chunck expected to be BIN."),c=r.readUint8Array(f)):e.warnUnsupported("More than 2 GLB chunks detected. Skipping."),n.label=4;case 4:return a+=1,[3,1];case 5:return u||e.error("No GLB JSON chunk detected."),[2,{json:u,binaryData:c}]}})})},e.prototype.getBuffer=function(e){return r(this,void 0,void 0,function(){var t,r,o,s;return n(this,function(n){switch(n.label){case 0:return t=this.json.buffers[e],(r=this.errorContext,null==t.uri)?(r.assert(null!=this.glbBuffer,"GLB buffer not present"),[2,this.glbBuffer]):(o=this.bufferCache.get(e),o?[3,2]:[4,this.context.loadBinary(this.resolveUri(t.uri))]);case 1:s=n.sent(),o=new Uint8Array(s),this.bufferCache.set(e,o),r.assert(o.byteLength===t.byteLength,"Buffer byte lengths should match."),n.label=2;case 2:return[2,o]}})})},e.prototype.getAccessor=function(e){return r(this,void 0,void 0,function(){var t,r,o,s,i,a,u,c;return n(this,function(n){switch(n.label){case 0:return t=this.json.accessors[e],r=this.errorContext,r.errorUnsupportedIf(null==t.bufferView,"An accessor bufferView is required."),r.errorUnsupportedIf(t.type in["MAT2","MAT3","MAT4"],"AttributeType "+t.type+" is not supported"),o=this.json.bufferViews[t.bufferView],[4,this.getBuffer(o.buffer)];case 1:return s=n.sent(),i=I[t.type],a=B[t.componentType],u=i*a,c=o.byteStride||u,[2,{raw:s.buffer,byteStride:c,byteOffset:s.byteOffset+(o.byteOffset||0)+(t.byteOffset||0),entryCount:t.count,isDenselyPacked:c===u,componentCount:i,componentByteSize:a,componentType:t.componentType,min:t.min,max:t.max,normalized:!!t.normalized}]}})})},e.prototype.getIndexData=function(e){return r(this,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:return null==e.indices?[2,null]:[4,this.getAccessor(e.indices)];case 1:if(t=r.sent(),t.isDenselyPacked)switch(t.componentType){case 5121:return[2,new Uint8Array(t.raw,t.byteOffset,t.entryCount)];case 5123:return[2,new Uint16Array(t.raw,t.byteOffset,t.entryCount)];case 5125:return[2,new Uint32Array(t.raw,t.byteOffset,t.entryCount)]}else switch(t.componentType){case 5121:return[2,w.scalar.makeDense(this.wrapAccessor(m.BufferViewUint8,t))];case 5123:return[2,w.scalar.makeDense(this.wrapAccessor(m.BufferViewUint16,t))];case 5125:return[2,w.scalar.makeDense(this.wrapAccessor(m.BufferViewUint32,t))]}return[2]}})})},e.prototype.getPositionData=function(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,t.errorUnsupportedIf(null==e.attributes.POSITION,"POSITION vertex data is required."),[4,this.getAccessor(e.attributes.POSITION)];case 1:return r=n.sent(),t.errorUnsupportedIf(5126!==r.componentType,"[POSITION attribute] Expected type FLOAT, found "+N[r.componentType]),t.errorUnsupportedIf(3!==r.componentCount,"POSITION attribute must have 3 components."),[2,this.wrapAccessor(m.BufferViewVec3f,r)]}})})},e.prototype.getNormalData=function(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,t.errorUnsupportedIf(null==e.attributes.NORMAL,"NORMAL vertex data is required."),[4,this.getAccessor(e.attributes.NORMAL)];case 1:return r=n.sent(),t.errorUnsupportedIf(5126!==r.componentType,"[NORMAL attribute] Expected type FLOAT, found "+N[r.componentType]),t.errorUnsupportedIf(3!==r.componentCount,"NORMAL attribute must have 3 components."),[2,this.wrapAccessor(m.BufferViewVec3f,r)]}})})},e.prototype.getTangentData=function(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,t.errorUnsupportedIf(null==e.attributes.TANGENT,"TANGENT vertex data is required."),[4,this.getAccessor(e.attributes.TANGENT)];case 1:return r=n.sent(),t.errorUnsupportedIf(5126!==r.componentType,"[TANGENT attribute] Expected type FLOAT, found "+N[r.componentType]),t.errorUnsupportedIf(4!==r.componentCount,"NORMAL attribute must have 4 components."),[2,new m.BufferViewVec4f(r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*r.entryCount)]}})})},e.prototype.getTextureCoordinates=function(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,t.errorUnsupportedIf(null==e.attributes.TEXCOORD_0,"TEXCOORD_0 vertex data is required."),[4,this.getAccessor(e.attributes.TEXCOORD_0)];case 1:return r=n.sent(),(t.errorUnsupportedIf(2!==r.componentCount,"TEXCOORD_0 attribute must have 2 components."),5126===r.componentType)?[2,this.wrapAccessor(m.BufferViewVec2f,r)]:(t.errorUnsupportedIf(!r.normalized,"[TEXCOORD_0 attribute] Integer ComponentTypes are only supported for a normalized accessor."),[2,T(r)])}})})},e.prototype.hasNormals=function(e){return!!e.attributes.NORMAL},e.prototype.hasVertexColors=function(e){return!!e.attributes.COLOR_0},e.prototype.hasTextureCoordinates=function(e){return!!e.attributes.TEXCOORD_0},e.prototype.hasTangents=function(e){return!!e.attributes.TANGENT},e.prototype.getVertexColors=function(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,t.errorUnsupportedIf(null==e.attributes.COLOR_0,"COLOR_0 vertex data is required."),[4,this.getAccessor(e.attributes.COLOR_0)];case 1:if(r=n.sent(),t.errorUnsupportedIf(4!==r.componentCount&&3!==r.componentCount,"COLOR_0 attribute must have 3 or 4 components."),4===r.componentCount){if(5126===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec4f,r)];if(5121===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec4u8,r)];if(5123===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec4u16,r)]}else if(3===r.componentCount){if(5126===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec3f,r)];if(5121===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec3u8,r)];if(5123===r.componentType)return[2,this.wrapAccessor(m.BufferViewVec3u16,r)]}return t.errorUnsupported("[COLOR_0 attribute] Unsupported component type: "+N[r.componentType]),[2]}})})},e.prototype.getMaterial=function(e){return r(this,void 0,void 0,function(){var t,r,o,s,i,a,u,c;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,(r=this.materialCache.get(e.material))?[3,6]:(o=null!=e.material?b.material(this.json.materials[e.material]):b.material(),s=o.pbrMetallicRoughness,i=this.hasVertexColors(e),a=void 0,s.baseColorTexture?(t.errorUnsupportedIf(0!==(s.baseColorTexture.texCoord||0),"Only TEXCOORD_0 is supported"),[4,this.getTexture(s.baseColorTexture.index)]):[3,2]);case 1:a=n.sent(),n.label=2;case 2:return u=void 0,o.normalTexture?0===(s.baseColorTexture.texCoord||0)?[3,3]:(t.warnUnsupported("Only TEXCOORD_0 is supported for normal map"),[3,5]):[3,5];case 3:return[4,this.getTexture(o.normalTexture.index)];case 4:u=n.sent(),n.label=5;case 5:c=null!=e.material?e.material:-1,r={alphaMode:o.alphaMode,alphaCutoff:o.alphaCutoff,color:s.baseColorFactor,doubleSided:!!o.doubleSided,colorTexture:a,normalTexture:u,name:o.name,id:c,vertexColors:i,ESRI_externalColorMixMode:o.extras.ESRI_externalColorMixMode},n.label=6;case 6:return[2,r]}})})},e.prototype.getTexture=function(e){return r(this,void 0,void 0,function(){var t,r,o,s,i,a,u,c;return n(this,function(n){switch(n.label){case 0:return t=this.errorContext,(r=this.json.textures[e],o=b.textureSampler(null!=r.sampler?this.json.samplers[r.sampler]:{}),t.errorUnsupportedIf(null==r.source,"source must be defined for a texture"),s=this.json.images[r.source],i=this.textureCache.get(e))?[3,6]:(a=void 0,s.uri?[4,this.context.loadImage(this.resolveUri(s.uri))]:[3,2]);case 1:return a=n.sent(),[3,5];case 2:return t.errorUnsupportedIf(null==s.bufferView,"Image bufferView must be defined."),t.errorUnsupportedIf(null==s.mimeType,"Image mimeType must be defined."),u=this.json.bufferViews[s.bufferView],[4,this.getBuffer(u.buffer)];case 3:return c=n.sent(),t.errorUnsupportedIf(null!=u.byteStride,"byteStride not supported for image buffer"),[4,C(new Uint8Array(c.buffer,c.byteOffset+(u.byteOffset||0),u.byteLength),s.mimeType)];case 4:a=n.sent(),n.label=5;case 5:i={data:a,wrapS:o.wrapS,wrapT:o.wrapT,minFilter:o.minFilter,name:s.name,id:e},this.textureCache.set(e,i),n.label=6;case 6:return[2,i]}})})},e.prototype.getNodeTransform=function(e){if(void 0===e)return S;var t=this.nodeTransformCache.get(e);if(!t){var r=this.getNodeTransform(this.getNodeParent(e)),n=this.json.nodes[e];n.matrix?t=f.mat4.multiply(p.mat4f64.create(),r,n.matrix):n.translation||n.rotation||n.scale?(t=p.mat4f64.clone(r),n.translation&&f.mat4.translate(t,t,n.translation),n.rotation&&(A[3]=d.quat.getAxisAngle(A,n.rotation),f.mat4.rotate(t,t,A[3],A)),n.scale&&f.mat4.scale(t,t,n.scale)):t=r,this.nodeTransformCache.set(e,t)}return t},e.prototype.wrapAccessor=function(e,t){return new e(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*(t.entryCount-1)+t.componentByteSize*t.componentCount)},e.prototype.resolveUri=function(e){return u.makeAbsolute(e,this.baseUri)},e.prototype.getNodeParent=function(e){return this.nodeParentMap.get(e)},e.prototype.checkVersionSupported=function(){c.Version.parse(this.json.asset.version,"glTF").validate(g)},e.prototype.checkRequiredExtensionsSupported=function(){var e=this.json,t=this.errorContext;e.extensionsRequired&&0!==e.extensionsRequired.length&&t.errorUnsupportedIf(!0,"Extensions: "+e.extensionsRequired.join(", "))},e.prototype.computeNodeParents=function(){var e=this;this.json.nodes.forEach(function(t,r){t.children&&t.children.forEach(function(t){e.nodeParentMap.set(t,r)})})},e}();t.Resource=U;var g=new c.Version(2,0,"glTF"),S=f.mat4.fromXRotation(p.mat4f64.create(),Math.PI/2),A=l.quatf64.create(),I={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},B=(v={},v[5120]=1,v[5121]=1,v[5122]=2,v[5123]=2,v[5126]=4,v[5125]=4,v),N={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"}});