// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","./common","../../state/utils/viewUtils","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils"],function(e,t,r,a,n,i,s,c,o,u,l,d){function p(e,t,n,s,o){void 0===n&&(n=c.defaultApplyOptions),void 0===s&&(s=t),void 0===o&&(o=!0),t!==s&&s.copyFrom(t),q.eyeCenterDistance=0,q.requiresTwoSteps=!1;var u=v(e,t,n,void 0,q);if(0===u)return!1;switch(a.mat4.identity(D),a.mat4.rotate(D,D,-u,t.viewRight),n.tiltMode){case 1:i.vec3.transformMat4(S,t.viewForward,D),i.vec3.scale(S,S,q.eyeCenterDistance),i.vec3.add(s.center,t.eye,S);break;case 0:i.vec3.subtract(S,t.center,t.eye),i.vec3.transformMat4(S,S,D),i.vec3.subtract(s.eye,t.center,S);break;default:r.neverReached(n.tiltMode)}return i.vec3.transformMat4(s.up,s.up,D),s.markViewDirty(),!q.requiresTwoSteps||!o||p(e,s,n,s,!1)}function v(e,t,r,a,n){if(void 0===r&&(r=c.defaultApplyOptions),void 0===a&&(a=c.defaultApplyOptions),!e.state.constraints.tilt)return 0;var i=t.distance,s=e.state.constraints.tilt(i,P);return R(e,r,s),2===a.interactionType&&c.hasConstraintType(a.selection,2)&&x(e,a.interactionStartCamera,s),1===r.tiltMode||1===a.tiltMode?m(e,t,s,n):f(e,t,s)}function f(e,t,r){var a=o.viewAngle(e.renderCoordsHelper,t.center,t.eye),n=d.clamp(a,r.min,r.max),i=a-n;return C(i)?i:0}function m(e,t,a,n){switch(n&&(n.requiresTwoSteps=!1),e.viewingMode){case"global":return h(e,t,a,n);case"local":return y(e,t,a,n);default:r.neverReached(e.viewingMode)}}function y(e,t,r,a){var n=o.viewAngle(e.renderCoordsHelper,t.center,t.eye),i=d.clamp(n,r.min,r.max),s=n-i;if(!C(s))return 0;if(a){var c=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=e.renderCoordsHelper.getAltitude(t.eye)-c,l=Math.cos(i);Math.abs(l)>1e-4?a.eyeCenterDistance=u/l:a.eyeCenterDistance=t.distance}return s}function h(e,t,r,a){var n=M(e,t,b),i=d.clamp(n.tiltAtCenter,r.min,r.max);if(!C(n.tiltAtCenter-i))return 0;var s,c;return n.centerIsOnSurface?(s=w(n),c=g(n,s)):(s=n.constraints.clampTilt(n.eyeCenterDistance,n.tiltAtCenter),a&&s<Math.PI/2&&(a.requiresTwoSteps=!0,s=Math.PI/2-1e-5),c=I(n,s)),a&&(a.eyeCenterDistance=A(n,s)),c}function M(e,t,r){var a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=a+u.earthRadius,s=e.renderCoordsHelper.intersectManifold(t.ray,a,O);return r.eyeCenterDistance=t.distance,s?(r.eyeCenterDistance=i.vec3.distance(t.eye,O),r.tiltAtCenter=o.viewAngle(e.renderCoordsHelper,O,t.eye)):e.state.isLocal?r.tiltAtCenter=o.viewAngle(e.renderCoordsHelper,t.center,t.eye):(l.sphere.closestPointOnSilhouette(l.sphere.wrap(n),t.ray,O),r.eyeCenterDistance=i.vec3.distance(t.eye,O),r.tiltAtCenter=d.acos(-i.vec3.dot(t.viewForward,i.vec3.normalize(O,O)))),r.radius=n,r.eyeRadius=i.vec3.length(t.eye),r.constraints=e.state.constraints,r.centerIsOnSurface=s,r}function C(e){return Math.abs(e)>1e-9}function w(e){var t=e.constraints,r=e.eyeCenterDistance,a=e.tiltAtCenter,n=a,i=t.clampTilt(r,a),s=A(e,i);if(t.clampTilt(s,a)===i)return i;for(var c=0;c<10&&C(i-n);){var o=(n+i)/2,u=A(e,o);C(t.clampTilt(u,o)-o)?n=o:i=o,c++}return i}function A(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;var r=Math.PI-d.clamp(t,0,Math.PI),a=d.asin(e.radius/e.eyeRadius*Math.sin(r)),n=Math.PI-r-a,i=Math.sin(n)/Math.sin(r);if(e.eyeRadius<e.radius&&i>1){var s=Math.PI-a,c=Math.PI-r-s;return Math.sin(c)/Math.sin(r)*e.eyeRadius}return i*e.eyeRadius}function g(e,t){var r=d.asin(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),a=d.asin(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-a:a-r}function I(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function R(e,t,r){if(0!==t.interactionType){var a=t.interactionStartCamera,n=t.interactionFactor,i=r.min,s=r.max,u=v(e,a,c.defaultApplyOptions,t),l=0===u?0:o.viewAngle(e.renderCoordsHelper,a.center,a.eye);r.min=i,r.max=s,2===t.interactionType?(c.hasConstraintType(t.selection,2)&&x(e,a,r),c.adjustRangeForInteraction(u,l,!0,n,T,r)):c.adjustRangeForInteraction(u,l,!1,n,T,r)}}function x(e,t,r){if(!e.state.isLocal){var a=e.state.constraints;if(a.altitude){var n=i.vec3.squaredLength(t.center),s=Math.sqrt(n),c=t.distance,o=a.altitude.min+u.earthRadius,l=a.altitude.max+u.earthRadius,p=(o*o-c*c-n)/(-2*s*c),v=(l*l-c*c-n)/(-2*s*c);r.min=Math.max(r.min,Math.min(Math.PI-d.acos(v),r.max)),r.max=Math.min(r.max,Math.PI-d.acos(p))}}}Object.defineProperty(t,"__esModule",{value:!0}),t.apply=p,t.error=v;var S=s.vec3f64.create(),D=n.mat4f64.create(),O=s.vec3f64.create(),T=d.deg2rad(5),P={min:0,max:0},b={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},q={eyeCenterDistance:0,requiresTwoSteps:!1}});