// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/Float32ArrayList","../../lib/IntervalUtilities","../../lib/Util","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,r,a,n,i,o,s,u,g,d,l,f,h){function p(e,t,r,a){for(var n=new Map,i=t.vertexBufferLayout.stride/4,o=function(r,a){var o=r.origin,s=e.get(o.id),u=n.get(o.id);null==u&&(u={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.getSize(),toAdd:[],toRemove:[],origin:o.vec3},n.set(o.id,u));var g=t.elementCount(r.data)*i;a?(u.optimalCount+=g,u.sparseCount+=g,u.toAdd.push(r)):(u.optimalCount-=g,u.toRemove.push(r))},s=0,u=r;s<u.length;s++){var g=u[s];o(g,!0)}for(var d=0,l=a;d<l.length;d++){var g=l[d];o(g,!1)}return n}var m=function(){function e(e,t,r){this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._material=r,this._materialRep=t,this._glMaterials=d.acquireMaterials(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}return e.prototype.dispose=function(){d.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){var t=this,r=R;r.clear(),this.updateGeometries(e.toUpdate,r),this.addAndRemoveGeometries(e.toAdd,e.toRemove,r),this.updateHighlightCount(),r.forEach(function(e){return t.updateDisplayedIndexRanges(e)})},e.prototype.addAndRemoveGeometries=function(e,t,r){var a=this,n=this._material,i=this._bufferWriter,o=i.vertexBufferLayout,s=o.stride/4,g=this._dataByOrigin,d=p(g,i,e,t);d.forEach(function(e,t){d.delete(t);var i=e.optimalCount,l=e.sparseCount,f=g.get(t);if(null==f&&(u.assert(i>0),f=a.createData(o,i,e.origin),g.set(t,f)),0===i)return f.vao.dispose(!0),f.vao=null,void g.delete(t);var h=i<e.sparseCount/2,p=h?i:l,m=c,y=f.buffer.getSize(),b=f.buffer.getArray(),x=f.buffer.resize(p);h||x?a.removeAndRebuild(f,e.toRemove,s,b,m):e.toRemove.length>0?(a.removeByErasing(f,e.toRemove,s,m),e.toAdd.length>0&&(m.end=y)):(m.begin=y,m.end=y);var R=v;u.setMatrixTranslation3(R,-e.origin[0],-e.origin[1],-e.origin[2]),a.append(f,n,e.toAdd,s,R,m);var C=f.vao.vertexBuffers.geometry;if(C.byteSize!==f.buffer.getArray().buffer.byteLength)C.setData(f.buffer.getArray());else{var _=m.begin,A=m.end;if(_<A){var I=f.buffer.getArray(),w=4*_,B=4*A;C.setSubData(I,w,w,B)}}(m.updatedDisplayedIndexRange||f.displayedIndexRanges)&&r.add(f)})},e.prototype.updateGeometries=function(e,t){for(var r=this._bufferWriter,a=r.vertexBufferLayout.stride/4,n=0,i=e;n<i.length;n++){var o=i[n],s=o.updateType,g=o.renderGeometry,l=this._dataByOrigin.get(g.origin.id),f=l&&l.instances.get(g.uniqueName);if(!f)return;if(1&s&&(f.displayedIndexRange=d.generateRenderGeometryVisibleIndexRanges(g),t.add(l)),17&s&&(f.highlightedIndexRanges=d.generateRenderGeometryHighlightRanges(g),l.highlightCount=null),6&s){var h=l.buffer.getArray(),p=l.vao;d.calculateTransformRelToOrigin(g,y,b),r.write({transformation:y,invTranspTransformation:b},g.data,g.instanceParameters,r.vertexBufferLayout.createView(h.buffer),f.from),u.assert(f.from+r.elementCount(g.data)===f.to,"material VBO layout has changed"),p.vertexBuffers.geometry.setSubData(h,f.from*a*4,f.from*a*4,f.to*a*4)}}},e.prototype.updateDisplayedIndexRanges=function(e){var t=e.instances;e.displayedIndexRanges=[];var r=!0;t.forEach(function(t){t.displayedIndexRange?(e.displayedIndexRanges.push.apply(e.displayedIndexRanges,s.offsetIntervals(t.displayedIndexRange,t.from)),r=!1):e.displayedIndexRanges.push([t.from,t.to-1])}),e.displayedIndexRanges=r?null:s.mergeIntervals(e.displayedIndexRanges)},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.instances.forEach(function(e){e.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.render=function(e,t,r,a){var n=this,i=this._rctx,o=this._glMaterials.get(t.pass),s=4===t.pass;if(!o||null!=e&&!o.beginSlot(e)||s&&0===this._highlightCount)return!1;o.bind(i,r);var u=o.getProgram();u.setUniformMatrix4fv("model",x),u.hasUniform("modelNormal")&&u.setUniformMatrix4fv("modelNormal",x);var g=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,o.bindView(i,r),g=s?n.renderHighlightPass(o,e,a)||g:n.renderDefaultPass(o,e,a)||g)}),o.release(i,r),g},e.prototype.renderDefaultPass=function(e,t,r){var a=this._rctx,n=e.getProgram(),i=e.getDrawMode(),o=t.displayedIndexRanges;return(!o||0!==o.length)&&(f.assertCompatibleVertexAttributeLocations(t.vao,n),a.bindVAO(t.vao),o?d.drawArraysFaceRange(a,o,0,i,r):d.drawArrays(a,i,0,f.vertexCount(t.vao,"geometry"),r),!0)},e.prototype.renderHighlightPass=function(e,t,r){var a=this._rctx,n=e.getProgram(),i=e.getDrawMode(),o=t.vao;f.assertCompatibleVertexAttributeLocations(o,n),a.bindVAO(o);var s=!1;return t.instances.forEach(function(e){var t=e.highlightedIndexRanges;if(t&&0!==t.length)for(var n=0;n<t.length;n++){var o=t[n],u=o.range?o.range[0]+e.from:e.from,g=o.range?o.range[1]-o.range[0]+1:e.to-e.from;d.drawArrays(a,i,u,g,r),s=!0}}),s},e.prototype.createData=function(e,t,r){return{instances:new Map,vao:new h(this._rctx,i.Default3D,{geometry:n.glLayout(e)},{geometry:l.createVertex(this._rctx,35044)}),buffer:new o(t),optimalCount:0,origin:r,highlightCount:0}},e.prototype.removeAndRebuild=function(e,t,r,a,n){for(var i=0,o=t;i<o.length;i++){var s=o[i],u=s.uniqueName,g=e.instances.get(u);e.optimalCount-=(g.to-g.from)*r,e.instances.delete(u)}var d=0,l=e.buffer.getArray();n.begin=0,n.end=0;var f=-1,h=-1,p=0;e.instances.forEach(function(e){var t=e.from*r,n=e.to*r,i=n-t;f!==h&&h!==t?(l.set(a.subarray(f,h),p),p+=h-f,f=t):-1===f&&(f=t),h=n,e.from=d/r,d+=i,e.to=d/r}),f!==h&&l.set(a.subarray(f,h),p),n.end=d},e.prototype.removeByErasing=function(e,t,r,a){if(0!==t.length){a.begin=1/0,a.end=-1/0;for(var n=-1,i=-1,o=0,s=t;o<s.length;o++){var u=s[o],g=u.uniqueName,d=e.instances.get(g),l=d.from*r,f=d.to*r;n!==i&&i!==l?(e.buffer.erase(n,i),n=l):-1===n&&(n=l),i=f,e.instances.delete(g),e.optimalCount-=f-l,l<a.begin&&(a.begin=l),f>a.end&&(a.end=f)}n!==i&&e.buffer.erase(n,i)}},e.prototype.append=function(e,t,a,n,i,o){o.updatedDisplayedIndexRange=!1;for(var s=this._bufferWriter,l=0,f=a;l<f.length;l++){var h=f[l],p=h.data;r.mat4.multiply(y,i,h.transformation),r.mat4.invert(b,y),r.mat4.transpose(b,b);var m=o.end;s.write({transformation:y,invTranspTransformation:b},p,h.instanceParameters,s.vertexBufferLayout.createView(e.buffer.getArray().buffer),o.end/n);var c=s.elementCount(p)*n,v=m+c;u.assert(null==e.instances.get(h.uniqueName));var x=d.generateRenderGeometryVisibleIndexRanges(h),R=d.generateRenderGeometryHighlightRanges(h);R&&(e.highlightCount=null);var C=new g(h.name,m/n,v/n,x,R,void 0,void 0,h.idx);e.instances.set(h.uniqueName,C),x&&(o.updatedDisplayedIndexRange=!0),e.optimalCount+=c,o.end+=c}},e}(),c={updatedDisplayedIndexRange:!1,begin:0,end:0},v=a.mat4f64.create(),y=a.mat4f64.create(),b=a.mat4f64.create(),x=a.mat4f64.create(),R=new Set;return m});