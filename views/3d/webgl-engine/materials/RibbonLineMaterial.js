// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/MaterialUtil","./renderers/InstancedRenderer","./renderers/MergedRenderer","../shaders/RibbonLinePrograms","../../../webgl/renderState"],function(e,t,r,n,i,a,o,s,p,c,l,f,m,u,d,g,h,v,y){var P=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),b=function(e){function t(t,r){var n=e.call(this,r)||this;return n.params=d.copyParameters(t,x),"miter"!==n.params.join&&(n.params.miterLimit=0),n.numVertsAtJoin="wall"===n.params.type?2:4,n.numVertsAtCap=2,n.canBeMerged="screen"===n.params.type&&null==n.params.stippleLength,n}return r(t,e),t.prototype.getColor=function(){return this.params.color},t.prototype.dispose=function(){},t.prototype.setParameterValues=function(e){for(var t in e)u.assert("type"!==t,"RibbonLineMaterial: type cannot be changed after creation"),u.assert("stippleLength"!==t||null!=e[t]==(null!=this.params[t]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[t]=e[t];"miter"!==this.params.join&&(this.params.miterLimit=0),this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.intersect=function(e,t,r,n,i,a,o,s,p){p?d.intersectDrapedRenderLineGeometry(e,t,r,n,i,a,this.params.width,o):this.intersectLineGeometry(e,t,r,n,i,a,o)},t.prototype.intersectLineGeometry=function(e,t,r,n,i,s,c,f){if(n.enable.selectionMode&&!l.isAllHidden(t.componentVisibilities,e.componentOffsets)){if(!u.isTranslationMatrix(r))return void P.error("intersection assumes a translation-only matrix");var m=e.data,d=m.getVertexAttr()[u.VertexAttrConstants.POSITION].data,g=m.getVertexAttr()[u.VertexAttrConstants.SIZE],h=g&&g.data[0],v=n.camera,y=T;a.vec2.copy(y,n.point);var b=h+this.params.width*v.pixelRatio,A=4*v.pixelRatio,L=b/2+A;o.vec3.set(X[0],y[0]-L,y[1]+L,0),o.vec3.set(X[1],y[0]+L,y[1]+L,0),o.vec3.set(X[2],y[0]+L,y[1]-L,0),o.vec3.set(X[3],y[0]-L,y[1]-L,0);for(var x=0;x<4;x++)v.unprojectPoint(X[x],Z[x]);p.plane.fromPoints(v.eye,Z[0],Z[1],q),p.plane.fromPoints(v.eye,Z[1],Z[2],H),p.plane.fromPoints(v.eye,Z[2],Z[3],k),p.plane.fromPoints(v.eye,Z[3],Z[0],z);for(var S=Number.MAX_VALUE,x=0;x<d.length-5;x+=3)if(R[0]=d[x]+r[12],R[1]=d[x+1]+r[13],R[2]=d[x+2]+r[14],U[0]=d[x+3]+r[12],U[1]=d[x+4]+r[13],U[2]=d[x+5]+r[14],!(p.plane.signedDistance(q,R)<0&&p.plane.signedDistance(q,U)<0||p.plane.signedDistance(H,R)<0&&p.plane.signedDistance(H,U)<0||p.plane.signedDistance(k,R)<0&&p.plane.signedDistance(k,U)<0||p.plane.signedDistance(z,R)<0&&p.plane.signedDistance(z,U)<0)){if(v.projectPoint(R,E),v.projectPoint(U,N),E[2]<0&&N[2]>0){o.vec3.subtract(D,R,U);var V=v.frustum,w=-p.plane.signedDistance(V.planes[4],R),C=w/o.vec3.dot(D,V.planes[4]);o.vec3.scale(D,D,C),o.vec3.add(R,R,D),v.projectPoint(R,E)}else if(E[2]>0&&N[2]<0){o.vec3.subtract(D,U,R);var V=v.frustum,w=-p.plane.signedDistance(V.planes[4],U),C=w/o.vec3.dot(D,V.planes[4]);o.vec3.scale(D,D,C),o.vec3.add(U,U,D),v.projectPoint(U,N)}else if(E[2]<0&&N[2]<0)continue;E[2]=0,N[2]=0;var O=p.lineSegment.distance2(p.lineSegment.fromPoints(E,N,G),y);O<S&&(S=O,o.vec3.copy(W,R),o.vec3.copy(j,U))}var I=n.rayBeginPoint,M=n.rayEndPoint;if(S<L*L){var F=Number.MAX_VALUE;if(p.lineSegment.closestLineSegmentPoint(p.lineSegment.fromPoints(W,j,G),p.lineSegment.fromPoints(I,M,J),B)){o.vec3.subtract(B,B,I);var _=o.vec3.length(B);o.vec3.scale(B,B,1/_),F=_/o.vec3.distance(I,M)}c(F,B)}}},t.prototype.createBufferWriter=function(){return"wall"===this.params.type?new C:new V(this.canBeMerged)},t.prototype.createRenderer=function(e,t){return this.canBeMerged?new h(e,t,this):new g(e,t,this)},t.prototype.getGLMaterials=function(){return{color:A,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:L}},t.prototype.getAllTextureIds=function(){return[]},t}(m),A=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.updateParameters(),n}return r(t,e),t.prototype.updateParameters=function(){this.params=d.copyParameters(this.material.getParameters()),this.selectProgram()},t.prototype.beginSlot=function(e){return e===(this.params.writeDepth?6:9)},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(v.colorPass,{screenScale:"screen"===e.type,wall:"wall"===e.type,stipple:null!=e.stippleLength,slice:e.slicePlaneEnabled}),this.pipelineState=y.makePipelineState({blending:y.separateBlendingParams(770,1,771,771),polygonOffset:e.polygonOffset&&O,depthTest:{func:513},depthWrite:e.color[3]>=1&&e.writeDepth&&y.defaultDepthWriteParams,colorWrite:y.defaultColorWriteParams})},t.prototype.bind=function(e,t){var r=this,n=r.program,i=r.params;if(e.bindProgram(n),e.setPipelineState(this.pipelineState),n.setUniform4fv("eColor",i.color),n.setUniform1f("miterLimit",i.miterLimit),n.setUniform1f("nearPlane",t.nearFar[0]),n.setUniform1f("pixelRatio",t.pixelRatio),n.setUniform1f("extLineWidth",i.width),"screen"===i.type&&n.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),null!=i.stippleLength){var a=i.stippleLength?1/(2*i.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",a)}},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;d.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&d.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 5},t}(f),L=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.updateParameters(),n}return r(t,e),t.prototype.updateParameters=function(){this.params=d.copyParameters(this.material.getParameters()),this.selectProgram()},t.prototype.beginSlot=function(e){return 4===e},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(v.highlightPass,{screenScale:"screen"===e.type,wall:"wall"===e.type,stipple:null!=e.stippleLength,slice:e.slicePlaneEnabled}),this.pipelineState=y.makePipelineState({polygonOffset:e.polygonOffset&&O,depthTest:{func:513},depthWrite:e.color[3]>=1&&y.defaultDepthWriteParams,colorWrite:y.defaultColorWriteParams})},t.prototype.bind=function(e,t){var r=this,n=r.program,i=r.params;if(e.bindProgram(n),e.setPipelineState(this.pipelineState),d.bindHighlightRendering(e,t,n),n.setUniform4fv("eColor",i.color),n.setUniform1f("miterLimit",i.miterLimit),n.setUniform1f("nearPlane",t.nearFar[0]),n.setUniform1f("pixelRatio",t.pixelRatio),n.setUniform1f("extLineWidth",i.width),"screen"===i.type&&n.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),null!=i.stippleLength){var a=i.stippleLength?1/(2*i.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",a)}},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;d.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&d.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 5},t}(f),x={color:[1,1,1,1],width:0,type:"screen",join:"miter",miterLimit:5,writeDepth:!0,polygonOffset:!1,stippleLength:null,slicePlaneEnabled:!1},S=c.newLayout().vec3f(u.VertexAttrConstants.POSITION).vec2f(u.VertexAttrConstants.UV0).vec3f(u.VertexAttrConstants.AUXPOS1).vec3f(u.VertexAttrConstants.AUXPOS2).vec4f(u.VertexAttrConstants.COLOR).f32(u.VertexAttrConstants.SIZE),V=function(){function e(e){this.canBeMerged=e,this.vertexBufferLayout=S,this.numVertsAtJoin=4,this.numVertsAtCap=2}return e.prototype.allocate=function(e){return S.createBuffer(e)},e.prototype.elementCount=function(e){var t=e.indices[u.VertexAttrConstants.POSITION].length/2+1,r=(t-2)*this.numVertsAtJoin+2*this.numVertsAtCap;return this.canBeMerged&&(r+=2),r},e.prototype.write=function(e,t,r,n,i){var a=t.vertexAttr[u.VertexAttrConstants.POSITION].data,o=t.indices&&t.indices[u.VertexAttrConstants.POSITION];o&&o.length!==2*(a.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var s=t.vertexAttr[u.VertexAttrConstants.COLOR]?t.vertexAttr[u.VertexAttrConstants.COLOR].data:I,p=t.vertexAttr[u.VertexAttrConstants.SIZE]?t.vertexAttr[u.VertexAttrConstants.SIZE].data:M,c=a.length/3,l=e.transformation,f=n.position.typedBuffer,m=0,d=this.vertexBufferLayout.stride/4,g=i*d,h=g;this.canBeMerged&&(g+=d);var v=a[0],y=a[1],P=a[2];if(l){var b=v,A=y,L=P;v=l[0]*b+l[4]*A+l[8]*L+l[12],y=l[1]*b+l[5]*A+l[9]*L+l[13],P=l[2]*b+l[6]*A+l[10]*L+l[14]}var x=a[3],S=a[4],V=a[5];if(l){var b=x,A=S,L=V;x=l[0]*b+l[4]*A+l[8]*L+l[12],S=l[1]*b+l[5]*A+l[9]*L+l[13],V=l[2]*b+l[6]*A+l[10]*L+l[14]}for(var w=v,C=y,O=P,R=0;R<c;R++){var U=3*R;if(R<c-1&&(x=a[U+3],S=a[U+4],V=a[U+5],l)){var b=x,A=S,L=V;x=l[0]*b+l[4]*A+l[8]*L+l[12],S=l[1]*b+l[5]*A+l[9]*L+l[13],V=l[2]*b+l[6]*A+l[10]*L+l[14]}m+=Math.sqrt((w-v)*(w-v)+(C-y)*(C-y)+(O-P)*(O-P)),f[g++]=w,f[g++]=C,f[g++]=O,f[g++]=m,f[g++]=0===R?-1.2:-1,f[g++]=v,f[g++]=y,f[g++]=P,f[g++]=x,f[g++]=S,f[g++]=V,f[g++]=s[0],f[g++]=s[1],f[g++]=s[2],f[g++]=s[3],f[g++]=p[0],f[g++]=w,f[g++]=C,f[g++]=O,f[g++]=m,f[g++]=0===R?1.2:1,f[g++]=v,f[g++]=y,f[g++]=P,f[g++]=x,f[g++]=S,f[g++]=V,f[g++]=s[0],f[g++]=s[1],f[g++]=s[2],f[g++]=s[3],f[g++]=p[0],R>0&&R<c-1&&(f[g++]=w,f[g++]=C,f[g++]=O,f[g++]=m,f[g++]=-1.2,f[g++]=v,f[g++]=y,f[g++]=P,f[g++]=x,f[g++]=S,f[g++]=V,f[g++]=s[0],f[g++]=s[1],f[g++]=s[2],f[g++]=s[3],f[g++]=p[0],f[g++]=w,f[g++]=C,f[g++]=O,f[g++]=m,f[g++]=1.2,f[g++]=v,f[g++]=y,f[g++]=P,f[g++]=x,f[g++]=S,f[g++]=V,f[g++]=s[0],f[g++]=s[1],f[g++]=s[2],f[g++]=s[3],f[g++]=p[0]),v=w,y=C,P=O,w=x,C=S,O=V}if(this.canBeMerged){for(var R=h;R<h+d;R++)f[R]=f[R+d];for(var D=g-d,R=0;R<d;R++)f[g++]=f[D++]}},e}(),w=c.newLayout().vec3f(u.VertexAttrConstants.POSITION).vec2f(u.VertexAttrConstants.UV0),C=function(){function e(){this.vertexBufferLayout=w,this.numVertsAtJoin=2,this.numVertsAtCap=2,this.tmpCurrent=s.vec3f64.create(),this.tmpLast=s.vec3f64.create()}return e.prototype.allocate=function(e){return S.createBuffer(e)},e.prototype.elementCount=function(e){return(e.indices[u.VertexAttrConstants.POSITION].length/2+1-2)*this.numVertsAtJoin+2*this.numVertsAtCap},e.prototype.write=function(e,t,r,n,i){var a=t.vertexAttr[u.VertexAttrConstants.POSITION].data,s=t.indices&&t.indices[u.VertexAttrConstants.POSITION];s&&s.length!==2*(a.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var p=a.length/3,c=e.transformation,l=0,f=this.tmpCurrent,m=this.tmpLast;o.vec3.set(f,a[0],a[1],a[2]);for(var d=i,g=0;g<p;g++){var h=3*g;o.vec3.copy(m,f),o.vec3.set(f,a[h],a[h+1],a[h+2]),c&&o.vec3.transformMat4(f,f,c),l+=o.vec3.squaredDistance(m,f),n.position.setVec(d,f),n.uv0.set(d,0,l),n.uv0.set(d,1,-1),++d,n.position.setVec(d,f),n.uv0.set(d,0,l),n.uv0.set(d,1,1),++d}},e}(),O={factor:0,units:-4},I=[255,255,255,255],M=[0,0,0,0],R=s.vec3f64.create(),U=s.vec3f64.create(),D=s.vec3f64.create(),B=s.vec3f64.create(),T=s.vec3f64.create(),E=i.createRenderScreenPointArray3(),N=i.createRenderScreenPointArray3(),W=s.vec3f64.create(),j=s.vec3f64.create(),G=p.lineSegment.create(),J=p.lineSegment.create(),X=[i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3()],Z=[s.vec3f64.create(),s.vec3f64.create(),s.vec3f64.create(),s.vec3f64.create()],q=p.plane.create(),H=p.plane.create(),k=p.plane.create(),z=p.plane.create();return b});