// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../support/buffer/BufferView","../../support/buffer/InterleavedLayout","../lib/GLMaterialTexture","../lib/Material","../lib/Util","../lib/Util","./VisualVariableMaterialParameters","./internal/bufferWriters","./internal/MaterialUtil","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/PathPrograms","../../../webgl/renderState"],function(e,t,r,i,a,n,s,o,l,p,c,f,u,d,m,v,h,g,P,S){function x(e,t,r){return e[0]=Math.min(Math.max(e[0],t[0]),r[0]),e[1]=Math.min(Math.max(e[1],t[1]),r[1]),e[2]=Math.min(Math.max(e[2],t[2]),r[2]),e}function b(e){return e?6:4}function y(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function M(e){return!e.slicePlaneEnabled&&(e.cullFace?"none"!==e.cullFace:!e.transparent&&!e.doubleSided)}var z=u.assert,O=function(e){function t(r,i){var a=e.call(this,i)||this;return a.supportsEdges=!0,a.params=h.copyParameters(r,A),a.vertexBufferLayout=t.getVertexBufferLayout(a.params),a.textureMode=r.textureId?r.atlasRegions?"AtlasTextured":"Textured":"none",a}return i(t,e),t.prototype.isVisibleInPass=function(e){return 3!==e||this.params.castShadows},t.prototype.isVisible=function(){var t=this.params;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;var r=t.symbolColors,i=t.vvColorEnabled,a="replace"===t.colorMixMode,n=t.opacity>0,s=t.externalColor&&t.externalColor[3]>0;return i||r?!!a||n:a?s:n},t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)"textureId"===r&&z(t.textureId,"Can only change texture of material that already has a texture"),"wireframe"===r&&z(t.wireframe,"wireframe flag affects drawmode (lines instead of triangles) and therefore can only be set during contruction"),"atlasRegions"===r&&z(e.atlasRegions===t.atlasRegions,"Can not change texture atlas mode."),!e[r]||"vvSizeMinSize"!==r&&"vvSizeMaxSize"!==r&&"vvSizeOffset"!==r&&"vvSizeFactor"!==r?t[r]=e[r]:a.vec3.set(t[r],e[r][0],e[r][1],e[r][2]);this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.computeVertexPosition=function(e,t,r,i){a.vec3.copy(i,t),this.params.vvSizeEnabled?(a.vec3.copy(X,this.params.vvSizeFactor),a.vec3.scale(X,X,r),a.vec3.add(X,X,this.params.vvSizeOffset),x(X,this.params.vvSizeMinSize,this.params.vvSizeMaxSize),a.vec3.multiply(i,i,X)):a.vec3.scale(i,i,this.params.size),a.vec3.add(i,i,e)},t.prototype.intersectTriangles=function(e,t,r,i,n,s,o,l,p,c,f){for(var u=e[0],d=e[1],m=e[2],v=t[0],g=t[1],P=t[2],S=v-u,x=g-d,b=P-m,y=r;y<i;y++){var M=c?c[y]:y,z=o.offsetIdx+o.strideIdx*n[3*M],O=o.offsetIdx+o.strideIdx*n[3*M+1],w=o.offsetIdx+o.strideIdx*n[3*M+2],V=l.offsetIdx+l.strideIdx*n[3*M],I=l.offsetIdx+l.strideIdx*n[3*M+1],C=l.offsetIdx+l.strideIdx*n[3*M+2],U=0;if(this.params.vvSizeEnabled){var A=p.offsetIdx+p.strideIdx*s[3*M];U=p.data[A]}a.vec3.set(F,o.data[z],o.data[z+1],o.data[z+2]),a.vec3.set(R,l.data[V],l.data[V+1],l.data[V+2]),this.computeVertexPosition(F,R,U,N);var T=N[0],E=N[1],B=N[2];a.vec3.set(F,o.data[O],o.data[O+1],o.data[O+2]),a.vec3.set(R,l.data[I],l.data[I+1],l.data[I+2]),this.computeVertexPosition(F,R,U,N);var W=N[0],X=N[1],k=N[2];a.vec3.set(F,o.data[w],o.data[w+1],o.data[w+2]),a.vec3.set(R,l.data[C],l.data[C+1],l.data[C+2]),this.computeVertexPosition(F,R,U,N);var _=N[0],q=N[1],G=N[2],H=W-T,j=X-E,J=k-B,K=_-T,Q=q-E,Y=G-B,Z=x*Y-Q*b,$=b*K-Y*S,ee=S*Q-K*x,te=H*Z+j*$+J*ee,re=u-T,ie=d-E,ae=m-B,ne=ie*J-j*ae,se=ae*H-J*re,oe=re*j-H*ie;if(te>D){var le=re*Z+ie*$+ae*ee;if(le<0||le>te)continue;var pe=S*ne+x*se+b*oe;if(pe<0||le+pe>te)continue}else{if(!(te<-D))continue;var le=re*Z+ie*$+ae*ee;if(le>0||le<te)continue;var pe=S*ne+x*se+b*oe;if(pe>0||le+pe<te)continue}var ce=(K*ne+Q*se+Y*oe)/te;if(ce>=0){f(ce,h.computeNormal(H,j,J,K,Q,Y,L),M)}}},t.prototype.intersect=function(e,t,r,i,a,n,o,l){if("triangle"===e.data.primitiveType){var p=0;p=this.params.vvSizeEnabled?Math.max(this.params.vvSizeMaxSize[0],Math.max(this.params.vvSizeMaxSize[1],this.params.vvSizeMaxSize[2])):this.params.size;var c=s.fromValues(e.boundingInfo.bbMin[0]-p,e.boundingInfo.bbMin[1]-p,e.boundingInfo.bbMin[2]-p,e.boundingInfo.bbMax[0]+p,e.boundingInfo.bbMax[1]+p,e.boundingInfo.bbMax[2]+p),u=[n[0]-a[0],n[1]-a[1],n[2]-a[2]],d=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),m=[d/u[0],d/u[1],d/u[2]];if(h.intersectAabbInvDir(c,a,m,i.tolerance)){var v=e.indexCount/3;this.intersectTriangles(a,n,0,v,e.getIndices(f.VertexAttrConstants.POSITION),e.getIndices(f.VertexAttrConstants.AUXPOS2),e.getAttribute(f.VertexAttrConstants.POSITION),e.getAttribute(f.VertexAttrConstants.AUXPOS1),e.getAttribute(f.VertexAttrConstants.AUXPOS2),null,o)}}},t.prototype.createBufferWriter=function(){return new T(this.vertexBufferLayout)},t.prototype.createRenderer=function(e,t){return new g(e,t,this)},t.prototype.getGLMaterials=function(){return{color:w,depth:V,depthShadowMap:this.params.castShadows?I:null,normal:C,highlight:U}},t.prototype.getAllTextureIds=function(){return this.params.textureId?[this.params.textureId]:[]},t.getVertexBufferLayout=function(e){var t=l.newLayout().vec3f("position").vec3f("normal");return t.vec4f(f.VertexAttrConstants.AUXPOS1),e.textureId&&(t=t.vec2f("uv0"),e.atlasRegions&&(t=t.vec4u16("region",{glNormalized:!0}))),e.symbolColors&&(t=t.vec4u8("symbolColor")),(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f(f.VertexAttrConstants.AUXPOS2)),t},t}(c),w=function(e){function t(t,r,i){var a=this,n=t.getParameters();a=e.call(this,t,r,i,n.textureId,void 0,n.textureInitTransparent)||this,a.params=h.copyParameters(n);var s=a.params;return a.slot=b(s.transparent),a.textureMode=t.textureMode,a._createPrograms(),a.selectPipeline(),a}return i(t,e),t.prototype._createPrograms=function(){var e=this;this.programs=v.BindParametersMap.create(this.params,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.params;return this.programRep.getProgram(P.colorPass,{textureMode:this.textureMode,symbolColors:t.symbolColors,flipV:t.flipV,doubleSided:t.doubleSided&&"normal"===t.doubleSidedType,windowOrderDoubleSided:t.doubleSided&&"winding-order"===t.doubleSidedType,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO,vvSize:t.vvSizeEnabled,vvColor:t.vvColorEnabled,vvOpacity:t.vvOpacityEnabled,verticalOffset:null!==t.verticalOffset,screenSizePerspective:null!==t.screenSizePerspective,slice:t.slicePlaneEnabled,compressedNormals:t.compressedNormals,transparencyDiscard:t.transparent,wireframe:t.wireframe})},t.prototype.selectPipeline=function(){var e=this.params;this.pipelineState=S.makePipelineState({blending:E(e),culling:W(e),polygonOffset:e.polygonOffset&&B,depthTest:{func:513},depthWrite:S.defaultDepthWriteParams,colorWrite:S.defaultColorWriteParams})},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return v.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){this.params=h.copyParameters(this.material.getParameters()),this.slot=b(this.params.transparent),this.updateTexture(this.params.textureId),this._createPrograms(),this.selectPipeline()},t.prototype.bind=function(e,t){var r=this.params,i=this.program=v.BindParametersMap.lookup(this.programs,t);e.bindProgram(i),e.setPipelineState(this.pipelineState),i.setUniform1f("size",r.size),i.setUniform3fv("ambient",r.ambient),i.setUniform3fv("diffuse",r.diffuse),i.setUniform3fv("specular",r.specular),i.setUniform4fv("externalColor",r.externalColor),i.setUniform1i("colorMixMode",h.colorMixModes[r.colorMixMode]),i.setUniform1f("opacity",r.opacity),i.setUniform1f("layerOpacity",r.layerOpacity),h.bindVerticalOffset(r.verticalOffset,t,i),h.bindScreenSizePerspective(r.screenSizePerspective,i),y(i,r),this.bindTexture(e,i),"none"!==this.textureMode&&this.bindTextureSize(e,i)},t.prototype.release=function(e,t){},t.prototype.bindView=function(e,t){var r=this.program=v.BindParametersMap.lookup(this.programs,t),i=this.params,a=t.origin;h.bindView(a,t.view,r),h.bindCamPos(a,t.viewInvTransp,r),i.slicePlaneEnabled&&h.bindSlicePlane(a,t.slicePlane,r),t.shadowMappingEnabled&&t.shadowMap.bindView(r,a)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(){return this.params.wireframe?1:4},t}(p),V=function(e){function t(t,r,i,a){void 0===a&&(a=!1);var n=e.call(this,t,r,i,t.getParameters().textureId)||this;return n.textureMode=t.textureMode,n.biased=a,n.updateParameters(),n}return i(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(P.depthPass,{textureMode:this.textureMode,flipV:e.flipV,shadowMap:this.biased,vvSize:e.vvSizeEnabled,verticalOffset:null!==e.verticalOffset,screenSizePerspective:null!==e.screenSizePerspective,slice:e.slicePlaneEnabled,transparencyDiscard:e.transparent}),this.pipelineState=S.makePipelineState({culling:W(e),polygonOffset:e.polygonOffset&&B,depthTest:{func:513},depthWrite:S.defaultDepthWriteParams,colorWrite:S.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=b(this.params.transparent)},t.prototype.updateParameters=function(){this.params=h.copyParameters(this.material.getParameters()),this.selectProgram(),this.selectSlot(),this.updateTexture(this.params.textureId)},t.prototype.bind=function(e,t){var r=this.program,i=this.params;e.bindProgram(r),e.setPipelineState(this.pipelineState),r.setUniform1f("size",i.size),r.setUniform2fv("nearFar",t.nearFar),h.bindVerticalOffset(i.verticalOffset,t,r),h.bindScreenSizePerspective(i.screenSizePerspective,r),y(r,i),this.bindTexture(e,r)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,i=this.params,a=t.origin;h.bindView(a,t.view,r),i.slicePlaneEnabled&&h.bindSlicePlane(t.origin,t.slicePlane,r),i.screenSizePerspective&&h.bindCamPos(a,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return this.params.wireframe?1:4},t}(p),I=function(e){function t(t,r,i){return e.call(this,t,r,i,!0)||this}return i(t,e),t}(V),C=function(e){function t(t,r,i){var a=e.call(this,t,r,i,t.getParameters().textureId)||this;return a.textureMode=t.textureMode,a.updateParameters(),a}return i(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(P.normalPass,{textureMode:this.textureMode,flipV:e.flipV,vvSize:e.vvSizeEnabled,verticalOffset:null!==e.verticalOffset,screenSizePerspective:null!==e.screenSizePerspective,slice:e.slicePlaneEnabled,compressedNormals:e.compressedNormals,transparencyDiscard:e.transparent}),this.pipelineState=S.makePipelineState({polygonOffset:e.polygonOffset&&B,culling:W(e),depthTest:{func:513},depthWrite:S.defaultDepthWriteParams,colorWrite:S.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=b(this.params.transparent)},t.prototype.updateParameters=function(){this.params=h.copyParameters(this.material.getParameters()),this.selectProgram(),this.selectSlot(),this.updateTexture(this.params.textureId)},t.prototype.bind=function(e,t){var r=this.program,i=this.params;e.bindProgram(r),e.setPipelineState(this.pipelineState),r.setUniform1f("size",i.size),this.bindTexture(e,r),h.bindVerticalOffset(i.verticalOffset,t,r),h.bindScreenSizePerspective(i.screenSizePerspective,r),y(r,i)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,i=this.params,a=t.origin;h.bindView(a,t.view,r),r.setUniformMatrix4fv("viewNormal",t.viewInvTransp),i.slicePlaneEnabled&&h.bindSlicePlane(t.origin,t.slicePlane,r),i.screenSizePerspective&&h.bindCamPos(a,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(){return this.params.wireframe?1:4},t}(p),U=function(e){function t(t,r,i){var a=e.call(this,t,r,i,t.getParameters().textureId)||this;return a.textureMode=t.textureMode,a.updateParameters(),a}return i(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(P.highlightPass,{textureMode:this.textureMode,flipV:e.flipV,vvSize:e.vvSizeEnabled,verticalOffset:null!==e.verticalOffset,screenSizePerspective:null!==e.screenSizePerspective,slice:e.slicePlaneEnabled,transparencyDiscard:e.transparent}),this.pipelineState=S.makePipelineState({polygonOffset:e.polygonOffset&&B,culling:W(e),depthTest:{func:513},depthWrite:S.defaultDepthWriteParams,colorWrite:S.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=b(this.params.transparent)},t.prototype.updateParameters=function(){this.params=h.copyParameters(this.material.getParameters()),this.selectProgram(),this.selectSlot(),this.updateTexture(this.params.textureId)},t.prototype.bind=function(e,t){var r=this.program,i=this.params;e.bindProgram(r),e.setPipelineState(this.pipelineState),r.setUniform1f("size",i.size),this.bindTexture(e,r),h.bindVerticalOffset(i.verticalOffset,t,r),h.bindScreenSizePerspective(i.screenSizePerspective,r),y(r,i)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,i=this.params,a=t.origin;h.bindView(a,t.view,r),i.slicePlaneEnabled&&h.bindSlicePlane(t.origin,t.slicePlane,r),i.screenSizePerspective&&h.bindCamPos(a,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(){return this.params.wireframe?1:4},t}(p),A=r({size:1,wireframe:!1,textureId:void 0,textureInitTransparent:!1,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,symbolColors:!1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,compressedNormals:!1,receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,transparent:!1,polygonOffset:!1,atlasRegions:!1},d.Default),T=function(){function e(e){this.vertexBufferLayout=e}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices.position.length},e.prototype.write=function(e,t,r,i,a){if(f.VertexAttrConstants.AUXPOS1 in t.vertexAttr){var n=t.vertexAttr[f.VertexAttrConstants.AUXPOS1],s=t.indices[f.VertexAttrConstants.AUXPOS1];z(4===n.size);var l=i.getField(f.VertexAttrConstants.AUXPOS1,o.BufferViewVec4f);if(!l)throw new Error("unable to aquire view for "+f.VertexAttrConstants.AUXPOS1);m.writeBufferVec4(s,n.data,l,a)}if(f.VertexAttrConstants.AUXPOS2 in t.vertexAttr){var n=t.vertexAttr[f.VertexAttrConstants.AUXPOS2],s=t.indices[f.VertexAttrConstants.AUXPOS2];z(4===n.size);var p=i.getField(f.VertexAttrConstants.AUXPOS2,o.BufferViewVec4f);if(!p)throw new Error("unable to aquire view for "+f.VertexAttrConstants.AUXPOS2);m.writeBufferVec4(s,n.data,p,a)}m.writeDefaultAttributes(t,r,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a)},e}(),E=function(e){return e.transparent&&S.separateBlendingParams(770,1,771,771)},B={factor:2,units:2},W=function(e){return M(e)&&{face:"front"===e.cullFace?1028:1029,mode:2305}},D=Math.pow(2,-52),N=n.vec3f64.create(),X=n.vec3f64.create(),F=n.vec3f64.create(),R=n.vec3f64.create(),L=n.vec3f64.create();return O});