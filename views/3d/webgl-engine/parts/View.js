// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/has","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../lib/DrapedRenderer","../lib/GLMaterialRep","../lib/GLTextureRep","../lib/ProgramRepository","../lib/tracer","../lighting/Lightsources","./Model","./Viewport","../shaders/globalOptions","../../../support/screenshotUtils","../../../webgl/context-util","../../../webgl/FramebufferObject","../../../webgl/RenderingContext"],function(e,t,r,i,s,n,o,a,h,p,c,d,l,u,_,g,f,v,m,b,y,R){var w=s.getLogger("esri.views.3d.webgl-engine.parts.View"),x=function(){function e(e,t,r,i){var s=this;this.options=i,this._backgroundColor=h.vec4f64.fromValues(1,1,1,1),this._lightDirection=a.vec3f64.fromValues(0,1,0),this._didRender=!1,this._needsRender=!0,this._idleSuspend=!0,this._shouldRender=!1,this._supersampleScreenshots=!0,this._screenshotQueue=[],this._container=e,this._stage=t,this._initializeContext(i);var n=v.glslifyGlobalOptions({viewingMode:i.viewingMode});this._programRepository=new l(this._rctx,n);var o=function(){return s._viewport.getCamera().viewport};this._textureRep=new d(t.getAll(g.ContentType.TEXTURE),this._programRepository,o,this._rctx),this._materialRep=new c(this._textureRep,this._programRepository),this._viewport=new f(this._stage,this._programRepository,this._materialRep,this._textureRep,this._rctx),this._initializeViewportCamera(),this._drapedRenderer=new p(this._rctx,this._canvas,this._programRepository,this._materialRep,this._textureRep,r),this._initializeFrameTask()}return Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return this._viewport.isLoadingResources},enumerable:!0,configurable:!0}),e.prototype._initializeFrameTask=function(){var e=this;this._frameTask={preRender:function(){if(u.begin(),e._stage.processDirty(),e.needsRender()){e._shouldRender=!0;e._viewport.getCamera().setGLViewport(e._rctx),e._rctx.setClearColor.apply(e._rctx,e._backgroundColor),e._rctx.clearSafe(16640)}else e._shouldRender=!1},render:function(){e._shouldRender&&(e._didRender=!0,S.lightDirection=e._lightDirection,S.disableSlice=!1,e._viewport.render(S))},postRender:function(){u.end()},update:function(){e.resetNeedsRender(),e._performScreenshots()}}},e.prototype._initializeViewportCamera=function(){var e=this._container.getBoundingClientRect(),t=this._viewport.getCamera();t.viewport[2]=e.width,t.viewport[3]=e.height,this._viewport.setCamera(t)},e.prototype._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil},r=b.createContextOrErrorHTML(this._canvas,t,e.renderContext);this._gl=u.instrumentContext(r);var s={disabledExtensions:e.deactivatedWebGLExtensions||{}};this._rctx=new R(this._gl,s),!e.alpha&&this._rctx.contextAttributes.alpha&&w.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas),null!=e.supersampleScreenshots&&(this._supersampleScreenshots=e.supersampleScreenshots)},e.prototype.dispose=function(){this._viewport.dispose(),this._viewport=null,this._drapedRenderer.dispose(),this._drapedRenderer=null,this._programRepository.dispose(),this._programRepository=null,this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._container=null,this._canvas=null,this._gl=null,this._frameTask=null},e.prototype.getCombinedStats=function(){return this._viewport.getCombinedStats()},e.prototype.setNeedsRender=function(){this._didRender=!1,this._needsRender=!0},e.prototype.resetNeedsRender=function(){this._didRender&&(this._needsRender=!1,this._didRender=!1),this._viewport.resetNeedsRender(),this._textureRep.resetNeedsRender()},e.prototype.needsRender=function(){var e=this._viewport.getCamera();return 0!==e.fullWidth&&0!==e.fullHeight&&(this._needsRender||!this._idleSuspend||this._viewport.needsRender()||this._textureRep.needsRender())},e.prototype.getFrameTask=function(){return this._frameTask},e.prototype.setLighting=function(e){o.vec3.set(this._lightDirection,0,0,0);for(var t=0,r=e.lights;t<r.length;t++){var i=r[t];if(i instanceof _.MainLight){o.vec3.negate(this._lightDirection,i.direction);break}}this._viewport.setLighting(e),this._needsRender=!0},e.prototype.ensureEdgeView=function(){return this._viewport.ensureEdgeView()},Object.defineProperty(e.prototype,"edgeView",{get:function(){return this._viewport.edgeView},enumerable:!0,configurable:!0}),e.prototype.getMainLightDirection=function(){return this._lightDirection},e.prototype.setViewParams=function(e){"backgroundColor"in e&&(this._needsRender=!0,this._backgroundColor=e.backgroundColor),"supersampleScreenshots"in e&&(this._supersampleScreenshots=e.supersampleScreenshots)},e.prototype.setRenderParams=function(e){this._needsRender=!0,void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._viewport.setRenderParams(e)},e.prototype.getRenderParams=function(){var e=this._viewport.getRenderParams();return e.anisotropicFiltering=this._textureRep.getMaxAnisotropy(),e.idleSuspend=this._idleSuspend,e},Object.defineProperty(e.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return"s3tc"===e?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===e&&!!this._rctx.capabilities.shaderTextureLOD},e.prototype.modify=function(e,t,r,i){this._viewport.modify(e,t,r,i)},e.prototype.setCamera=function(e){this._viewport.setCamera(e)},e.prototype.getCamera=function(){return this._viewport.getCamera()},e.prototype.getCanvas=function(){return this._canvas},e.prototype.getDrapedRenderer=function(){return this._drapedRenderer},e.prototype.takeScreenshot=function(e){var t=this,r=n.createResolver(function(){t._screenshotQueue=t._screenshotQueue.filter(function(e){return e.resolver!==r})});return this._screenshotQueue.push({settings:e,resolver:r}),this._needsRender=!0,r.promise},e.prototype.getFramebufferTexture=function(e){return this._viewport.getFramebufferTexture(e)},Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._viewport.renderPlugins},enumerable:!0,configurable:!0}),e.prototype._renderScreenshotOverlay=function(e,t,r){if(this.options.renderScreenshotOverlay){e.width=t.width,e.height=t.height;var i=e.getContext("2d"),s=this._viewport.getCamera(),n=s.pixelRatio*r.pixelRatio;i.save(),i.translate(0,t.height),i.scale(1,-1),r.region&&i.translate(-r.region.x,-r.region.y),i.scale(n,n),this.options.renderScreenshotOverlay(e,t),i.restore()}},e.prototype._readbackScreenshot=function(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)},e.prototype._readbackScreenshotResampled=function(e){var t=e.framebufferWidth,i=e.framebufferHeight,s=e.region,n=e.resample,o=this._ensureScreenshotEncodeCanvas(),a=m.createEmptyImageData(t,i,o);this._gl.readPixels(0,0,t,i,6408,5121,new Uint8Array(a.data.buffer)),this._renderScreenshotOverlay(o,a,r({},e,{region:null}));var h=m.createEmptyImageData(s.width,s.height,o);return m.resampleHermite(a,h,!0,n.region.x,i-(n.region.y+n.region.height),n.region.width,n.region.height)},e.prototype._readbackScreenshotImmediate=function(e){var t=e.framebufferHeight,r=e.region,i=this._ensureScreenshotEncodeCanvas(),s=m.createEmptyImageData(r.width,r.height,i);return this._gl.readPixels(r.x,t-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(s.data.buffer)),this._renderScreenshotOverlay(i,s,e),s},e.prototype._renderScreenshot=function(e){var t=null,r=this._viewport.getCamera(),i=m.screenshotSuperSampleSettings(e,this._supersampleScreenshots),s=i.framebufferWidth,n=i.framebufferHeight,o=!1,a=this._viewport.hasSlicePlane&&e.disableSlice,h=s!==r.fullWidth||n!==r.fullHeight||a;if(h){var p=r.copy();p.fullWidth=s,p.fullHeight=n,p.pixelRatio*=i.pixelRatio;var c=r.fovX-p.fovX,d=r.fovY-p.fovY;c<0&&c<d?p.fovX=r.fovX:d<0&&d<c&&(p.fovY=r.fovY),this._drapedRenderer.forceUpdate&&this._drapedRenderer.forceUpdate(p),o=!0,t=new y(this._rctx,{width:p.fullWidth,height:p.fullHeight,colorTarget:0,depthStencilTarget:3}),this._rctx.bindFramebuffer(t),p.setGLViewport(this._rctx),this._rctx.setClearColor.apply(this._rctx,this._backgroundColor),this._rctx.clearSafe(16640),this._viewport.render({lightDirection:this._lightDirection,fbo:t,camera:p,disableSlice:e.disableSlice})}var l=this._readbackScreenshot(i);if(h&&!this._rctx.contextAttributes.alpha)for(var u=3;u<l.data.length;u+=4)l.data[u]=255;return t&&t.dispose(),this._rctx.bindFramebuffer(null),o&&this._drapedRenderer.forceUpdate&&this._drapedRenderer.forceUpdate(r),l},e.prototype._performScreenshots=function(){if(0!==this._screenshotQueue.length){for(var e=0,t=this._screenshotQueue;e<t.length;e++){var r=t[e],i=r.settings;if(this._gl){var s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(i),o=m.encodeResult(n,i,s,{flipY:!0,premultipliedAlpha:!0});r.resolver(o)}else r.resolver.reject()}this._screenshotQueue=[]}},e.prototype._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},Object.defineProperty(e.prototype,"test",{get:function(){return{viewport:this._viewport}},enumerable:!0,configurable:!0}),e.prototype.getGpuMemoryUsage=function(){return r({},this._viewport.getGpuMemoryUsage(),{draped:this._drapedRenderer?this._drapedRenderer.getGpuMemoryUsage():0})},e}(),S={fbo:null,camera:null,lightDirection:a.vec3f64.create(),disableSlice:!1};return x});