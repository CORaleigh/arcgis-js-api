// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","./Util"],function(e,t,r,n,i,o,a,s){function c(e,t,r){e[0]=Math.min(e[0],t[0]-r),e[1]=Math.min(e[1],t[1]-r),e[2]=Math.min(e[2],t[2]-r)}function u(e,t,r){e[0]=Math.max(e[0],t[0]+r),e[1]=Math.max(e[1],t[1]+r),e[2]=Math.max(e[2],t[2]+r)}function h(e,t,r){return r=r||e,r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t,r}function d(e,t,r){return!a.frustum.intersectsSphere(r.planes,a.sphere.wrap(t,e))}function f(e,t,r){if(!T.length)for(var n=0;n<8;++n)T.push({index:0,distance:0});for(var n=0;n<8;++n){var i=v[n];T.data[n].index=n,T.data[n].distance=p(e,t,i)}T.sort(function(e,t){return e.distance-t.distance}),r.clear();for(var n=0;n<8;++n)r.push(T.data[n].index)}function l(e,t){for(var r=1/0,n=null,i=0;i<8;++i){var o=p(e,t,g[i]);o<r&&(r=o,n=g[i])}return n}function p(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}var m=function(){function e(e,t,r,n){this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._objectCount=0,this._objectToBoundingSphere=r,n&&(void 0!==n.maximumObjectsPerNode&&(this._maximumObjectsPerNode=n.maximumObjectsPerNode),void 0!==n.maximumDepth&&(this._maximumDepth=n.maximumDepth)),isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(t)?this._root=new _(null,o.vec3f64.fromValues(0,0,0),.5):this._root=new _(null,e,t/2)}return Object.defineProperty(e.prototype,"center",{get:function(){return this._root.center},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return 2*this._root.halfSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"root",{get:function(){return this._root.node},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maximumObjectsPerNode",{get:function(){return this._maximumObjectsPerNode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maximumDepth",{get:function(){return this._maximumDepth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"objectCount",{get:function(){return this._objectCount},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._degenerateObjects.clear(),this._root=null,_.clearPool(),y=[null],N.prune(),T.prune(),D.prune()},e.prototype.add=function(e,t){var r=this._objectOrObjectsArray(e);t=null==t?r.length:t,this._objectCount+=t,this._grow(r);for(var n=_.acquire(),i=0;i<t;i++){var o=r[i];n.init(this._root),this._isDegenerate(o)?this._degenerateObjects.add(o):this._add(o,n)}_.release(n)},e.prototype.remove=function(e,t){var r=this._objectOrObjectsArray(e);this._objectCount-=r.length;for(var n=_.acquire(),i=0;i<r.length;i++){var o=r[i],a=t||this._boundingSphereFromObject(o,E);this._isValidRadius(a.radius)?(n.init(this._root),this._remove(o,a,n)):this._degenerateObjects.delete(o)}_.release(n),this._shrink()},e.prototype.update=function(e,t){!this._isValidRadius(t.radius)&&this._isDegenerate(e)||(this.remove(e,t),this.add(e))},e.prototype.forEachAlongRay=function(e,t,r){var n=this;this._forEachNode(this._root,function(i){if(!n._intersectsNode(e,t,i))return!1;var o=i.node;return o.terminals.forEach(function(i){n._intersectsObject(e,t,i)&&r(i)}),null!==o.residents&&o.residents.forEach(function(i){n._intersectsObject(e,t,i)&&r(i)}),!0})},e.prototype.forEach=function(e){this._forEachNode(this._root,function(t){var r=t.node;return r.terminals.forEach(e),null!==r.residents&&r.residents.forEach(e),!0}),this._degenerateObjects.forEach(e)},e.prototype.forEachDegenerateObject=function(e){this._degenerateObjects.forEach(e)},e.prototype.findClosest=function(e,t,r,n,i){return this._findClosest(e,"front-to-back"===t?1:-1,r,n,i)},e.prototype.forEachInDepthRange=function(e,t,r,n,i,o,a,s){this._forEachInDepthRange(e,t,"front-to-back"===r?1:-1,n,i,o,a,s)},e.prototype.forEachNode=function(e){this._forEachNode(this._root,function(t){return e(t.node,t.center,2*t.halfSize)})},e.prototype._intersectsNode=function(e,t,r){return h(r.center,2*-r.halfSize,x),h(r.center,2*r.halfSize,O),s.rayBoxTest(e,t,x,O)},e.prototype._intersectsObject=function(e,t,r){var n=this._objectToBoundingSphere.getRadius(r);return!(n>0)||a.sphere.intersectsRay(a.sphere.wrap(n,this._objectToBoundingSphere.getCenter(r)),a.ray.wrap(e,t))},e.prototype._forEachNode=function(e,t){for(var r=_.acquire().init(e),n=[r];0!==n.length;){if(r=n.pop(),t(r)&&!r.isLeaf())for(var i=0;i<r.node.children.length;i++){var o=r.node.children[i];o&&n.push(_.acquire().init(r).advance(i))}_.release(r)}},e.prototype._forEachNodeDepthOrdered=function(e,t,r,n){void 0===n&&(n=1);var i=_.acquire().init(e),o=[i];for(f(r,n,D);0!==o.length;){if(i=o.pop(),t(i)&&!i.isLeaf())for(var a=7;a>=0;--a){var s=D.data[a];if(!(s>=i.node.children.length)){var c=i.node.children[s];c&&o.push(_.acquire().init(i).advance(s))}}_.release(i)}},e.prototype._findClosest=function(e,t,r,n,o){var a=this,s=1/0,c=1/0,u=null,h=l(e,t),f=0,m=function(i){if(++f,!n||n(i)){var o=a._objectToBoundingSphere.getCenter(i),h=a._objectToBoundingSphere.getRadius(i);if(!r||!d(o,h,r)){var l=p(e,t,o),m=l-h,_=l+h;m<s&&(s=m,c=_,u=i)}}};return this._forEachNodeDepthOrdered(this._root,function(n){if(null!=o&&f>=o)return!1;if(r&&d(n.center,n.halfSize*b,r))return!1;if(i.vec3.scale(S,h,n.halfSize),i.vec3.add(S,S,n.center),p(e,t,S)>c)return!1;var a=n.node;return a.terminals.forEach(function(e){m(e)}),null!==a.residents&&a.residents.forEach(function(e){m(e)}),!0},e,t),u},e.prototype._forEachInDepthRange=function(e,t,r,n,o,a,s,c){var u=this,h=-1/0,f=1/0,m={setRange:function(e){1===r?(h=Math.max(h,e.near),f=Math.min(f,e.far)):(h=Math.max(h,-e.far),f=Math.min(f,-e.near))}};m.setRange(n);var _=p(t,r,e),v=l(t,r),g=l(t,-1*r),y=0,j=function(e){if(++y,!s||s(e)){var n=u._objectToBoundingSphere.getCenter(e),i=u._objectToBoundingSphere.getRadius(e),c=p(t,r,n)-_,l=c-i,v=c+i;l>f||v<h||a&&d(n,i,a)||o(e,m)}};this._forEachNodeDepthOrdered(this._root,function(e){if(null!=c&&y>=c)return!1;if(a&&d(e.center,e.halfSize*b,a))return!1;if(i.vec3.scale(S,v,e.halfSize),i.vec3.add(S,S,e.center),p(t,r,S)-_>f)return!1;if(i.vec3.scale(S,g,e.halfSize),i.vec3.add(S,S,e.center),p(t,r,S)-_<h)return!1;var n=e.node;return n.terminals.forEach(function(e){j(e)}),null!==n.residents&&n.residents.forEach(function(e){j(e)}),!0},t,r)},e.prototype._objectOrObjectsArray=function(e){return Array.isArray(e)?e:(y[0]=e,y)},e.prototype._remove=function(e,t,r){N.clear();var n=r.advanceTo(t,function(e,t){N.push(e.node),N.push(t)}),i=n?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(var o=N.length-2;o>=0;o-=2){var a=N.data[o],s=N.data[o+1];if(!this._purge(a,s))break}},e.prototype._nodeIsEmpty=function(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(var t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0},e.prototype._purge=function(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new n({shrink:!0})),!0)},e.prototype._add=function(e,t){t.advanceTo(this._boundingSphereFromObject(e,E))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))},e.prototype._split=function(e){var t=e.node.residents;e.node.residents=null;for(var r=0;r<t.length;r++){var n=_.acquire().init(e);this._add(t.data[r],n),_.release(n)}},e.prototype._grow=function(e){var t=this;if(0!==e.length){var r=this._boundingSphereFromObjects(e,function(e,r){return t._boundingSphereFromObject(e,r)},M);if(this._isValidRadius(r.radius)&&!this._fitsInsideTree(r))if(this._nodeIsEmpty(this._root.node))i.vec3.copy(this._root.center,r.center),this._root.halfSize=1.25*r.radius;else{var n=_.acquire();this._rootBoundsForRootAsSubNode(r,n),this._placingRootViolatesMaxDepth(n)?this._rebuildTree(r,n):this._growRootAsSubNode(n),_.release(n)}}},e.prototype._rebuildTree=function(e,t){var r=this;i.vec3.copy(z.center,t.center),z.radius=t.halfSize;var n=this._boundingSphereFromObjects([e,z],function(e){return e},V),o=_.acquire().init(this._root);this._root.initFrom(null,n.center,1.25*n.radius),this._forEachNode(o,function(e){return r.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&r.add(e.node.residents.data,e.node.residents.length),!0}),_.release(o)},e.prototype._placingRootViolatesMaxDepth=function(e){var t=0;return this._forEachNode(this._root,function(e){return t=Math.max(t,e.depth),!0}),t+Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E>this._maximumDepth},e.prototype._rootBoundsForRootAsSubNode=function(e,t){for(var r=e.radius,n=e.center,i=-1/0,o=this._root.center,a=this._root.halfSize,s=0;s<3;s++){var c=o[s]-a-(n[s]-r),u=n[s]+r-(o[s]+a),h=Math.max(0,Math.ceil(c/(2*a))),d=Math.max(0,Math.ceil(u/(2*a)))+1,f=Math.pow(2,Math.ceil(Math.log(h+d)*Math.LOG2E));i=Math.max(i,f),R[s].min=h,R[s].max=d}for(var s=0;s<3;s++){var h=R[s].min,d=R[s].max,l=(i-(h+d))/2;h+=Math.ceil(l),d+=Math.floor(l);var p=o[s]-a-h*a*2;j[s]=p+(d+h)*a}return t.initFrom(null,j,i*a,0)},e.prototype._growRootAsSubNode=function(e){var t=this._root.node;i.vec3.copy(M.center,this._root.center),M.radius=this._root.halfSize,this._root.init(e),e.advanceTo(M,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals},e.prototype._shrink=function(){for(;;){var e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}},e.prototype._findShrinkIndex=function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;for(var e=null,t=this._root.node.children,r=0,n=0;n<t.length&&null==e;)r=n++,e=t[r];for(;n<t.length;)if(t[n++])return-1;return r},e.prototype._isDegenerate=function(e){var t=this._objectToBoundingSphere.getRadius(e);return!this._isValidRadius(t)},e.prototype._isValidRadius=function(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0},e.prototype._fitsInsideTree=function(e){var t=this._root.center,r=this._root.halfSize,n=e.center;return e.radius<=r&&n[0]>=t[0]-r&&n[0]<=t[0]+r&&n[1]>=t[1]-r&&n[1]<=t[1]+r&&n[2]>=t[2]-r&&n[2]<=t[2]+r},e.prototype._boundingSphereFromObject=function(e,t){return i.vec3.copy(t.center,this._objectToBoundingSphere.getCenter(e)),t.radius=this._objectToBoundingSphere.getRadius(e),t},e.prototype._boundingSphereFromObjects=function(e,t,r){if(1===e.length){var n=t(e[0],M);i.vec3.copy(r.center,n.center),r.radius=n.radius}else{x[0]=1/0,x[1]=1/0,x[2]=1/0,O[0]=-1/0,O[1]=-1/0,O[2]=-1/0;for(var o=0;o<e.length;o++){var n=t(e[o],M);this._isValidRadius(n.radius)&&(c(x,n.center,n.radius),u(O,n.center,n.radius))}i.vec3.lerp(r.center,x,O,.5),r.radius=Math.max(O[0]-x[0],O[1]-x[1],O[2]-x[2])/2}return r},e}(),_=function(){function e(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=0),this.center=o.vec3f64.create(),this.initFrom(e,t,r,0)}return e.prototype.init=function(e){return this.initFrom(e.node,e.center,e.halfSize,e.depth)},e.prototype.initFrom=function(t,r,n,o){return void 0===t&&(t=null),void 0===n&&(n=this.halfSize),void 0===o&&(o=this.depth),this.node=t||e.createEmptyNode(),r&&i.vec3.copy(this.center,r),this.halfSize=n,this.depth=o,this},e.prototype.advance=function(t){var r=this.node.children[t];r||(r=e.createEmptyNode(),this.node.children[t]=r),this.node=r,this.halfSize/=2,this.depth++;var n=v[t];return this.center[0]+=n[0]*this.halfSize,this.center[1]+=n[1]*this.halfSize,this.center[2]+=n[2]*this.halfSize,this},e.prototype.advanceTo=function(e,t,r){for(void 0===r&&(r=!1);;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()&&!r)return t&&t(this,-1),!1;this.isLeaf()&&(this.node.residents=null);var n=this._childIndex(e);t&&t(this,n),this.advance(n)}},e.prototype.isLeaf=function(){return null!=this.node.residents},e.prototype.isTerminalFor=function(e){return e.radius>this.halfSize/2},e.prototype._childIndex=function(e){for(var t=e.center,r=this.center,n=0,i=0;i<3;i++)r[i]<t[i]&&(n|=1<<i);return n},e.createEmptyNode=function(){return{children:[null,null,null,null,null,null,null,null],terminals:new n({shrink:!0}),residents:new n({shrink:!0})}},e.acquire=function(){return e._pool.acquire()},e.release=function(t){e._pool.release(t)},e.clearPool=function(){e._pool.prune()},e._pool=new r(e),e}(),v=[o.vec3f64.fromValues(-1,-1,-1),o.vec3f64.fromValues(1,-1,-1),o.vec3f64.fromValues(-1,1,-1),o.vec3f64.fromValues(1,1,-1),o.vec3f64.fromValues(-1,-1,1),o.vec3f64.fromValues(1,-1,1),o.vec3f64.fromValues(-1,1,1),o.vec3f64.fromValues(1,1,1)],g=[o.vec3f64.fromValues(-1,-1,-1),o.vec3f64.fromValues(-1,-1,1),o.vec3f64.fromValues(-1,1,-1),o.vec3f64.fromValues(-1,1,1),o.vec3f64.fromValues(1,-1,-1),o.vec3f64.fromValues(1,-1,1),o.vec3f64.fromValues(1,1,-1),o.vec3f64.fromValues(1,1,1)],b=Math.sqrt(3),y=[null],j=o.vec3f64.create(),S=o.vec3f64.create(),x=o.vec3f64.create(),O=o.vec3f64.create(),N=new n,E={center:o.vec3f64.create(),radius:0},M={center:o.vec3f64.create(),radius:0},z={center:o.vec3f64.create(),radius:0},V={center:o.vec3f64.create(),radius:0},R=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],T=new n,D=new n;return m});