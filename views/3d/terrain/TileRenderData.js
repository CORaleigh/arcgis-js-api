// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/mathUtils","./TerrainConst","./TileGeometryFactory","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/BufferObject","../../webgl/VertexArrayObject"],function(e,t,r,i,a,l,n,s,o,u,c,h,m,f,p,y){Object.defineProperty(t,"__esModule",{value:!0});var g=function(){function e(){this.overlayTexOffset=a.vec2f64.create(),this.texOffsetAndScale=n.vec4f64.create(),this.geometryInfo={indices:null,vertexAttributes:null,boundingBox:s.empty(),numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0,skirtLength:0,uvOffsetAndScale:n.vec4f64.create()}}return e.prototype.init=function(e){this.tile=e;var t=this.geometryInfo;if(t.indices=null,t.vertexAttributes=null,s.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this._vao=null,this._texture=null,this.textureReference=null,l.vec4.set(this.texOffsetAndScale,0,0,1,1),this.opacity=1,this.overlays)for(var r=0,a=this.overlays;r<a.length;r++){var n=a[r];n.renderTargetId=null,n.highlightRenderTargetId=null,i.vec2.set(n.texScale,1,1),i.vec2.set(n.texOffset,0,0)}else{this.overlays=[null,null];for(var o=0;o<2;o++)this.overlays[o]={renderTargetId:null,highlightRenderTargetId:null,texScale:[1,1],texOffset:[0,0]}}this.overlayOpacity=1,this.localOrigin=null},e.prototype.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e,t),!0)},e.prototype.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},e.prototype.ensureTexture=function(e,t){return this._texture&&this._texture.descriptor.width!==t&&this.releaseTexture(),this._texture||(this._texture=e(t),this.tile.updateMemoryUsed()),this._texture},e.prototype.releaseTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null),this.textureReference=null},e.prototype._updateGeometryState=function(e){var t=this._getElevationInfo(),i=this.tile.lij[0],a=i<8?this.tile.numSubdivisionsAtLevel[i]+1:2;if(t.samplerData){var l=this.tile.vlevel-i,n=Math.max(i-t.maxTileLevel,u.ELEVATION_DESIRED_RESOLUTION_LEVEL-l),s=this.tile.maxTesselation;a=o.clamp(1+(s>>n),2,s+1)}var c=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(c=null);var h=this.geometryState,m=!1;return h.numVertsPerRow!==a&&(h.numVertsPerRow=a,m=!0),t.changed&&(h.samplerData=t.samplerData,m=!0),r.equals(h.clippingArea,c)||(h.clippingArea=c,m=!0),h.wireframe!==e&&(h.wireframe=e,m=!0),m},e.prototype._createGeometry=function(e,t){this.tile.createGeometry(this.geometryState,this.localOrigin,t);var r=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,a=e.gl;this._vao=new y(e,m.Default3D,{geometry:f.Pos3Tex},{geometry:p.createVertex(e,a.STATIC_DRAW,r)},p.createIndex(e,a.STATIC_DRAW,i))},e.prototype._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,c.releaseGeometry(this.geometryInfo),!0)},Object.defineProperty(e.prototype,"vao",{get:function(){return this._vao},enumerable:!0,configurable:!0}),e.prototype._getElevationInfo=function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[u.LayerClass.ELEVATION],r=t.length,i=new Array(r),a=0,l=0,n=!1,s=0;s<r;s++){var o=t[s];if(o.upsampleFromTile){var c=o.upsampleFromTile.tile,m=c.layerInfo[u.LayerClass.ELEVATION][s].data,f=m.samplerData;e&&e[a]===f||(n=!0),i[a++]=f,l=Math.max(l,c.lij[0])}else if(o.data){var p=this.tile.surface.layerViewByIndex(s,u.LayerClass.ELEVATION);if(h.fallsWithinLayer(this.tile,p.layer,!1)){var m=o.data;e&&e[a]===m.samplerData||(n=!0),i[a++]=m.samplerData,l=this.tile.lij[0]}}}return e&&e.length!==a&&(n=!0),a>0?i.length=a:i=null,{changed:n,samplerData:i,maxTileLevel:l}},Object.defineProperty(e.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureDescriptor",{get:function(){return this._texture?this._texture.descriptor:null},enumerable:!0,configurable:!0}),e}();t.TileRenderData=g});