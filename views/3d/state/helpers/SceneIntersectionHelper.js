// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec3","../../support/geometryUtils","../../support/stack","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/intersectorUtils"],function(e,t,r,i,n,a,s,o,c){function l(e,t){if(!e)return!1;var r=e.results.min;return!!r&&r.getIntersectionPoint(t)}function d(e,t,r){for(var i=0,n=e;i<n.length;i++){var a=n[i];t&&!t(a)||r.push(a)}return r}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t,r){this.viewingMode=e,this.layerProvider=t,this.view=r,this.tmpIntersector=new o(this.viewingMode),this.tmpRay=a.ray.create(),this.externalIntersectionHandlers=new Set,this.intersectionTolerance=o.DEFAULT_TOLERANCE,this.validateHUDIntersector=new o(this.viewingMode),this.validateHUDIntersector.enable.hud=!1}return e.prototype.intersectScreen=function(e,t,r,i){return this.intersectRay(this.getPickRay(e,this.tmpRay),t,r,i)},e.prototype.intersectScreenFreePointFallback=function(e,t,r,i){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t,r,i)},e.prototype.intersectRay=function(e,t,r,i){return i=this.computeIntersection(e,r,!1,i||this.tmpIntersector),l(i,t)},e.prototype.intersectRayFreePointFallback=function(e,t,r,i){return this.intersectRay(e,t,r,i)||this.intersectRayFreePointLocal(e,t)},e.prototype.intersectIntersectorScreen=function(e,t,r,i,n){return void 0===i&&(i=!1),void 0===n&&(n=!1),this.computeIntersection(this.getPickRay(e,this.tmpRay),r,i,t,n)},e.prototype.intersectToolIntersectorScreen=function(e,t,r){var i=this.getPickRay(e,this.tmpRay),n=this.computeIntersection(i,r,!0,t),a=n.results.min;return!!this.view.basemapTerrain&&this.view.basemapTerrain.isOpaque()||a.hasIntersectionPoint&&"TerrainRenderer"!==a.intersector||(n=this.computeIntersection(i,r,!1,t)),n},e.prototype.setTolerance=function(e){void 0===e&&(e=o.DEFAULT_TOLERANCE),this.intersectionTolerance=e},e.prototype.addIntersectionHandler=function(e){this.externalIntersectionHandlers.add(e)},e.prototype.removeIntersectionHandler=function(e){this.externalIntersectionHandlers.delete(e)},e.prototype.getPickRay=function(e,t){void 0===t&&(t=a.ray.create());var r=this.view.state.camera;return a.ray.fromScreen(r,e,t)},e.prototype.intersectRayFreePointLocal=function(e,t){if("local"!==this.viewingMode)return!1;var r=this.view.dataExtent,i={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},a=Math.max(i.x,i.y,i.z);if(0===a)return n.vec3.add(t,e.origin,n.vec3.normalize(s.sv3d.get(),e.direction)),!0;var o=this.view.state.camera,c=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),d=Math.sqrt(c*c+l*l),u=Math.abs(o.relativeElevation)+Number.MIN_VALUE,h=Math.pow(Math.max(0,Math.log(a/u)),2),y=a/Math.max(1,h);y=Math.max(y,Math.min(d,a));var v=n.vec3.scale(s.sv3d.get(),e.direction,y/n.vec3.length(e.direction));return n.vec3.add(t,e.origin,v),!0},e.prototype.computeIntersection=function(e,t,r,a,l){var d=this,u=this.view.state.camera,y=i.castRenderScreenPointArray3(s.sv3d.get());u.projectPoint(e.origin,y);var v=this.prepareFilters(t,h);a=a||new o(this.viewingMode),a.enable.storeAll=t&&t.allEnabled,a.enable.storeTerrainResults=v.filterLayerUid(c.TERRAIN_ID),a.enable.selectOpaqueTerrainOnly=!t||!("include"in t||"exclude"in t);var p=e.origin,f=n.vec3.add(s.sv3d.get(),e.origin,e.direction);a.intersect(v.layers,p,f,y,u,this.intersectionTolerance,r,null);var m=this.view.slicePlane,g=m?c.sliceFilterPredicate(m):null;a.intersect(v.sliceableLayers,p,f,y,u,this.intersectionTolerance,r,g,!1);var R=t&&t.terrainLocationFeedbackEnabled||l;this.externalIntersectionHandlers.forEach(function(e){if(e.intersectionHandlerId===c.TERRAIN_ID){if(!R&&!v.filterLayerUid(c.TERRAIN_ID))return}else if(!v.filterLayerUid(e.intersectionHandlerId))return;var t=e.slicePlaneEnabled?g:null;e.intersect(a,t,p,f,y)});var I=s.sv3d.get();if(l&&a.results.terrain.getIntersectionPoint(I)){var x=this.view._stage.getDrapedRenderer(),b=s.sv3d.get();this.view.renderCoordsHelper.fromRenderCoords(I,b,this.view.spatialReference),b[2]=this.view.basemapTerrain.getElevation(I)||0,x.intersect(a,b,v.filterRenderGeometry)}a.sortResults();var P=a.results.hud;if(P.hasIntersectionPoint){var w=i.castRenderScreenPointArray3(s.sv3d.get()),L=s.sv3d.get(),U=s.sv3d.get();this.unprojectHUDResultRay(P.center,w,L,U);var T=n.vec3.distance(P.center,L)/n.vec3.distance(L,U)*.99;this.validateHUDIntersector.intersect(v.layers,L,U,w,u,this.intersectionTolerance,r,null),this.validateHUDIntersector.intersect(v.sliceableLayers,L,U,w,u,this.intersectionTolerance,r,g,!1),this.externalIntersectionHandlers.forEach(function(e){if(v.filterLayerUid(e.intersectionHandlerId)){var t=e.slicePlaneEnabled?g:null;e.intersect(d.validateHUDIntersector,t,L,U,w)}});var E=this.validateHUDIntersector.results.min;(null==E.dist||T<=E.dist)&&(a.results.min.copyFrom(P),a.results.all.splice(0,0,P))}return a},e.prototype.prepareFilters=function(e,t){var r=[],i=[];return this.layerProvider.forEachLayer(function(e){e.isPickable&&(e.isSliceable?i:r).push(e)}),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,d(r,t.filterLayer,t.layers),d(i,t.filterLayer,t.sliceableLayers),t},e.prototype.unprojectHUDResultRay=function(e,t,r,n){var a=this.view.state.camera;a.projectPoint(e,t);var o=i.castRenderScreenPointArray3(s.sv3d.get());o[0]=t[0],o[1]=t[1],o[2]=0,a.unprojectPoint(o,r),o[2]=1,a.unprojectPoint(o,n)},e}();t.SceneIntersectionHelper=u;var h={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:function(e){return h.filterLayerUid(e.apiLayerUid)},filterLayerUid:function(e){var t=h.include,i=h.exclude;return r.isNone(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:function(e){return h.filterLayerUid(e.data.layerUid)}}});