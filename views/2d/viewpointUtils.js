// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Viewpoint","../../core/asyncUtils","../../core/promiseUtils","../../core/unitUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],function(e,t,r,n,a,c,o,i,s,u,l,f,m,v,y,g,d,p,x,h,b){function M(e,t,r){var n=u.common.toDegree(t[0]/K);return m.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),u.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/K))))}function w(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(u.common.toRadian(r)),m.vec2.set(e,u.common.toRadian(t[0])*K,.5*K*Math.log((1+r)/(1-r)))}function S(e,t,r,n){return n&&r&&!n.equals(r)&&h.canProject(n,r)&&n.isWebMercator?n.isWebMercator?w(e,t):M(e,t):m.vec2.copy(e,t)}function R(e){return e.wkid?e:e.spatialReference||p.WGS84}function G(e,t){return t.type?m.vec2.set(e,t.x,t.y):m.vec2.copy(e,t)}function P(e){return i.getMetersPerUnitForSR(e)}function A(e,t){return Math.max(e.width/t[0],e.height/t[1])*N(e.spatialReference)}function j(e,t,a,c){return n(this,void 0,void 0,function(){var n,i,s,u,l,f,m,v,p,x,b,M,w,S,R,G,P,A,T,v,B,z,O,k,V,q,F,W,I;return r(this,function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(i=e.every(function(e){return"attributes"in e}),s=e.some(function(e){return!e.geometry}),u=e,!(i&&s&&t&&t.allLayerViews))return[3,2];for(l=new Map,f=0,m=e;f<m.length;f++)v=m[f],p=v.layer,x=l.get(p)||[],b=v.attributes[p.objectIdField],null!=b&&x.push(b),l.set(p,x);return M=[],l.forEach(function(e,r){var n=t.allLayerViews.find(function(e){return e.layer.id===r.id});if("queryFeatures"in n){var a=r.createQuery();a.objectIds=e,a.returnGeometry=!0,M.push(n.queryFeatures(a))}}),[4,o.all(M)];case 1:for(w=r.sent(),S=[],R=0,G=w;R<G.length;R++)if((P=G[R])&&P.features&&P.features.length)for(A=0,T=P.features;A<T.length;A++)v=T[A],v.geometry&&S.push(v.geometry);u=S,r.label=2;case 2:B=0,z=u,r.label=3;case 3:return B<z.length?(O=z[B],[4,j(O,t,a,c)]):[3,6];case 4:c=r.sent(),r.label=5;case 5:return B++,[3,3];case 6:return[2,c];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(n=new d(e),[3,12]):[3,8];case 8:return e instanceof g?(n=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(n=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(k=e.layer,"queryFeatures"in(V=t.allLayerViews.find(function(e){return e.layer.id===k.id}))?(q=k.createQuery(),q.objectIds=[e.attributes[k.objectIdField]],q.returnGeometry=!0,[4,V.queryFeatures(q)]):[3,12]):[3,12];case 11:F=r.sent(),n=F&&F.features&&F.features[0]&&F.features[0].geometry,r.label=12;case 12:if(!n)return[2,null];if(!(W="point"===n.type?new y({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return[2,null];if(I=h.canProject(W,a),!W.spatialReference.equals(a)&&I)W=h.project(W,a);else if(!I)return[2,null];return c=c?c.union(W):W.clone(),[2,c]}})})}function T(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){var t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every(function(e){return"layer"in e})){for(var r=0,n=0,a=0,c=e;a<c.length;a++){var o=c[a],t=o.layer;t&&t.minScale&&t.maxScale&&(r=t.minScale<r?t.minScale:r,n=t.maxScale>n?t.maxScale:n)}return r&&n?{min:r,max:n}:null}}}function B(e,t){return n(this,void 0,void 0,function(){var n,c,o,i,s,u,l,f,m,g,p,x,M,w,P,B;return r(this,function(r){switch(r.label){case 0:return e?(n=t.spatialReference,c=t.size,o=t.viewpoint,i=t.constraints,s=null,"esri.Viewpoint"===e.declaredClass?s=e:e.viewpoint?s=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(s=e.target),u=null,s&&s.targetGeometry?(u=s.targetGeometry,[3,10]):[3,1]):[2,new a({targetGeometry:new d,scale:0,rotation:0})];case 1:return e instanceof y?(u=e,[3,10]):[3,2];case 2:return e||e&&(e.hasOwnProperty("center")||e.hasOwnProperty("extent")||e.hasOwnProperty("target"))?[4,j(e.center,t,n)]:[3,10];case 3:return m=r.sent(),m?[3,5]:[4,j(e.extent,t,n)];case 4:m=r.sent(),r.label=5;case 5:return f=m,f?[3,7]:[4,j(e.target,t,n)];case 6:f=r.sent(),r.label=7;case 7:return l=f,l?[3,9]:[4,j(e,t,n)];case 8:l=r.sent(),r.label=9;case 9:u=l,r.label=10;case 10:return!u&&o&&o.targetGeometry?u=o.targetGeometry:!u&&t.extent&&(u=t.extent),(g=R(u),n||(n=R(t.spatialReference||t.extent||u)),b.canProject(u,n)||!g||g.equals(n))?(p=G(v.vec2f64.create(),u.center?u.center:u),x=new d(S(p,p,g,n),n),M=null,M=s&&s.targetGeometry&&"point"===s.targetGeometry.type?s.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&i&&i.effectiveLODs?i.zoomToScale(e.zoom):Array.isArray(u)||"point"===u.type||"extent"===u.type&&0===u.width&&0===u.height?t.extent&&h.canProject(t.extent,n)?A(h.project(t.extent,n),c):t.extent?A(t.extent,c):o.scale:h.canProject(u.extent,n)?A(h.project(u.extent,n),c):A(u.extent,c),w=T(e),w&&(w.min&&w.min>M?M=w.min:w.max&&w.max<M&&(M=w.max)),P=0,s?P=s.rotation:e.hasOwnProperty("rotation")?P=e.rotation:o&&(P=o.rotation),B=new a({targetGeometry:x,scale:M,rotation:P}),i&&(B=i.fit(B),i.rotationEnabled||(B.rotation=P)),[2,B]):[2,null]}})})}function z(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function O(e,t,r){return r?m.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):m.vec2.scale(e,t,.5)}function k(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=A(n,a),c&&c.constraints&&c.constraints.constrain(e),e}function V(e,r,n,a){return t.getTransform(e,r,n,a),l.mat2d.invert(e,e)}function q(e,t,r){var n=I(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return m.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function F(e){return e.scale*W(e.targetGeometry.spatialReference)}function W(e){return x.isValid(e)?1/(P(e)*J*96):1}function I(e){return u.common.toRadian(e.rotation)||0}function N(e){return x.isValid(e)?P(e)*J*96:1}function U(e,t){return m.vec2.scale(e,t,.5)}function E(e){if(e.isWrappable){var t=x.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function C(e,t){return Math.round(E(e)/t)}function L(e,t){return c.safeCast(B(e,t))}function D(e,t,r){return F(t)}function H(e,t,r){return z(e,t),e.rotation+=r,e}function Q(e,t,r){return z(e,t),e.rotation=r,e}function _(e,t,r){return z(e,t),e.scale=r,e}Object.defineProperty(t,"__esModule",{value:!0});var J=39.37,K=s.wgs84Radius,X=180/Math.PI;t.extentToScale=A,t.create=B,t.copy=z,t.getAnchor=O,t.getExtent=function(){var e=v.vec2f64.create();return function(t,r,n){var a=r.targetGeometry;G(e,a);var c=.5*F(r);return t.xmin=e[0]-c*n[0],t.ymin=e[1]-c*n[1],t.xmax=e[0]+c*n[0],t.ymax=e[1]+c*n[1],t.spatialReference=a.spatialReference,t}}(),t.setExtent=k,t.getOuterExtent=function(){var e=v.vec2f64.create(),t=v.vec2f64.create();return function(r,n,a){G(e,n.targetGeometry),q(t,n,a);var c=.5*F(n),o=e[0]-c*t[0],i=e[1]-c*t[1],s=e[0]+c*t[0],u=e[1]+c*t[1],l=n.targetGeometry.spatialReference;return r.set({xmin:o,ymin:i,xmax:s,ymax:u,spatialReference:l}),r}}(),t.getOuterSize=q,t.getPaddingScreenTranslation=function(){var e=v.vec2f64.create();return function(t,r,n){return m.vec2.sub(t,U(t,r),O(e,r,n))}}(),t.getPaddingMapTranslation=function(){var e=f.mat2df64.create(),r=v.vec2f64.create();return function(n,a,c,o){var i=F(a),s=I(a);return m.vec2.set(r,i,i),l.mat2d.fromScaling(e,r),l.mat2d.rotate(e,e,s),l.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),l.mat2d.translate(e,e,[0,o.top-o.bottom]),m.vec2.set(n,e[4],e[5])}}(),t.getResolution=F,t.getResolutionToScaleFactor=N,t.getMatrix=function(){var e=v.vec2f64.create(),t=v.vec2f64.create(),r=v.vec2f64.create();return function(n,a,c,o,i,s){return m.vec2.negate(e,a),m.vec2.scale(t,c,.5*s),m.vec2.set(r,1/o*s,-1/o*s),l.mat2d.identity(n),l.mat2d.translate(n,n,t),i&&l.mat2d.rotate(n,n,i),l.mat2d.scale(n,n,r),l.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=F(n),i=I(n);return G(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=F(n);return G(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=E,t.getWorldScreenWidth=C,t.createAsync=L,t.angleBetween=function(){var e=v.vec2f64.create(),t=v.vec2f64.create(),r=[0,0,0];return function(n,a,c){m.vec2.subtract(e,n,a),m.vec2.normalize(e,e),m.vec2.subtract(t,n,c),m.vec2.normalize(t,t),m.vec2.cross(r,e,t);var o=Math.acos(m.vec2.dot(e,t)/(m.vec2.length(e)*m.vec2.length(t)))*X;return r[2]<0&&(o=-o),isNaN(o)&&(o=0),o}}(),t.addPadding=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return z(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return z(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=v.vec2f64.create();return function(t,r,n){z(t,r);var a=t.targetGeometry,c=R(n),o=R(a);return G(e,n),S(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSizeAt=D,t.resize=function(){var e=v.vec2f64.create();return function(r,n,a,c,o){o||(o="center"),m.vec2.sub(e,a,c),m.vec2.scale(e,e,.5);var i=e[0],s=e[1];switch(o){case"center":m.vec2.set(e,0,0);break;case"left":m.vec2.set(e,-i,0);break;case"top":m.vec2.set(e,0,s);break;case"right":m.vec2.set(e,i,0);break;case"bottom":m.vec2.set(e,0,-s);break;case"top-left":m.vec2.set(e,-i,s);break;case"bottom-left":m.vec2.set(e,-i,-s);break;case"top-right":m.vec2.set(e,i,s);break;case"bottom-right":m.vec2.set(e,i,-s)}return t.translateBy(r,n,e),r}}(),t.rotateBy=H,t.rotateTo=Q,t.scaleBy=function(){var e=v.vec2f64.create();return function(r,n,a,c,o){return z(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,o),r.scale=n.scale*a,t.toScreen(e,e,r,o),t.translateBy(r,r,m.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=_,t.scaleAndRotateBy=function(){var e=v.vec2f64.create();return function(r,n,a,c,o,i){return z(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,i),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,m.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=function(){var e=v.vec2f64.create(),r=v.vec2f64.create();return function(n,a,c,o,i,s,u){return t.getPaddingScreenTranslation(r,s,u),m.vec2.add(e,i,r),o?t.scaleAndRotateBy(n,a,c,o,e,s):t.scaleBy(n,a,c,e,s)}}(),t.toMap=function(){var e=f.mat2df64.create();return function(t,r,n,a){return m.vec2.transformMat2d(t,r,V(e,n,a,1))}}(),t.toScreen=function(){var e=f.mat2df64.create();return function(r,n,a,c){return m.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=v.vec2f64.create(),t=f.mat2df64.create();return function(r,n,a){z(r,n);var c=F(n),o=r.targetGeometry;return l.mat2d.fromRotation(t,I(n)),l.mat2d.scale(t,t,v.vec2f64.fromValues(c,c)),m.vec2.transformMat2d(e,a,t),o.x+=e[0],o.y+=e[1],r}}()});