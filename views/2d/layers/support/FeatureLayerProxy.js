// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/Accessor","../../../../core/Promise","../../../../core/promiseUtils","../../../../core/requireUtils","../../../../core/workers","../../../../core/accessorSupport/decorators","./util","module"],function(e,t,r,o,n,i,c,l,s,u,a,p,d){function y(e){return e&&"openPorts"in e}function f(e){return Array.isArray(e)}Object.defineProperty(t,"__esModule",{value:!0});var v=function(t){function n(e){var r=t.call(this,e)||this;return r.tileRenderer=null,r}return r(n,t),n.prototype.initialize=function(){var t=this;this.addResolvingPromise(u.open(s.getAbsMid("../features/Pipeline",e,d),{client:this.client,strategy:"dedicated"}).then(function(e){return t._connection=e,t._getStartupOptions(t.layer,t.featuresTiling)}).then(function(e){return f(e.service.source)?t._connection.invoke("startup",e,{transferList:e.service.source}):t._connection.invoke("startup",e)}))},n.prototype.destroy=function(){this._connection&&(this._connection.close(),this._connection=null)},n.prototype.configure=function(e){return this._connection.invoke("configure",e)},n.prototype.refresh=function(){return this._connection.invoke("controller.refresh")},n.prototype.redraw=function(){return this._connection.invoke("controller.redraw")},n.prototype.setViewState=function(e){return this._connection.invoke("setViewState",e.toJSON())},n.prototype.queryFeatures=function(e){return this._connection.invoke("controller.queryFeatures",e.toJSON())},n.prototype.queryObjectIds=function(e){return this._connection.invoke("controller.queryObjectIds",e.toJSON())},n.prototype.queryFeatureCount=function(e){return this._connection.invoke("controller.queryFeatureCount",e.toJSON())},n.prototype.queryExtent=function(e){return this._connection.invoke("controller.queryExtent",e.toJSON())},n.prototype.queryLatestObservations=function(e){return this._connection.invoke("controller.queryLatestObservations",e.toJSON())},n.prototype.onEdits=function(e){var t=e.addedFeatures,r=e.deletedFeatures,o=e.updatedFeatures;return this._connection.invoke("controller.onEdits",{addedFeatures:t,deletedFeatures:r,updatedFeatures:o})},n.prototype.enableEvent=function(e,t){return this._connection.invoke("controller.enableEvent",{name:e,value:t})},n.prototype.setFilter=function(e,t){return this._connection.invoke("controller.setFilter",{index:e,filter:t})},n.prototype._getStartupOptions=function(e,t){var r=e.capabilities,o=e.objectIdField,n=e.source,i=e.fields.map(function(e){return e.toJSON()}),c=e.fullExtent&&e.fullExtent.toJSON(),s=p.toJSONGeometryType(e.geometryType),u=e.timeInfo&&e.timeInfo.toJSON()||null;if(y(n))return n.openPorts().then(function(e){return{service:{capabilities:r,fields:i,fullExtent:c,geometryType:s,objectIdField:o,source:e,timeInfo:u},tileInfo:t.tileInfo.toJSON()}});if("stream"===e.type){var a=e.source,d=a.relatedLayerDefinition,f=a.archivedLayerDefinition,v=d&&{capabilities:d.capabilities,fields:d.fields,fullExtent:d.extent,geometryType:d.geometryType,objectIdField:d.objectIdField,source:a.layerDefinition.relatedFeatures.featuresUrl,joinField:a.layerDefinition.relatedFeatures.joinField}||null,m=f&&{capabilities:f.capabilities,fields:f.fields,fullExtent:f.extent,geometryType:f.geometryType,objectIdField:f.objectIdField,source:a.layerDefinition.keepLatestArchive.featuresUrl,maximumFeatureAge:a.layerDefinition.keepLatestArchive.maximumFeatureAge,updateInterval:a.layerDefinition.keepLatestArchive.updateInterval}||null;return l.resolve({service:{capabilities:e.capabilities,fields:e.fields.map(function(e){return e.toJSON()}),fullExtent:c||null,geometryType:p.toJSONGeometryType(e.geometryType),objectIdField:e.objectIdField||"__OBJECTID",source:e.parsedUrl.path,buddyLayers:{relatedFeatures:v,keepLatestArchive:m},streamUrls:a.layerDefinition.streamUrls,timeInfo:u,content:e.parsedUrl.query},tileInfo:t.tileInfo.toJSON()})}return l.resolve({service:{capabilities:r,fields:i,fullExtent:c,geometryType:s,objectIdField:o,source:"dynamicDataSource"in e?e.dynamicDataSource?e.parsedUrl:e.url+"/"+e.layerId:e.parsedUrl,timeInfo:u},tileInfo:t.tileInfo.toJSON()})},o([a.property({constructOnly:!0})],n.prototype,"client",void 0),o([a.property({constructOnly:!0})],n.prototype,"layer",void 0),o([a.property({constructOnly:!0})],n.prototype,"featuresTiling",void 0),o([a.property()],n.prototype,"tileRenderer",void 0),n=o([a.subclass()],n)}(a.declared(i,c));t.default=v});