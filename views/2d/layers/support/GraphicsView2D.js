// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/HandleOwner","../../../../core/Identifiable","../../../../core/MapPool","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/data/projectionSupport","../../engine/webgl/GraphicContainer","../../engine/webgl/TileData","../../engine/webgl/WGLTile","../../engine/webgl/mesh/factories/matcherUtils","../../engine/webgl/mesh/factories/WGLMeshFactory","../../engine/webgl/mesh/templates/WGLTemplateStore","../features/support/TileStore","../graphics/GraphicProcessingQueue","../graphics/GraphicStore","../graphics/graphicsUtils","../../../layers/GraphicsView"],function(e,t,i,r,a,n,s,o,h,p,d,l,c,u,g,f,v,_,y,m,w,S,U,G,b,T,I){function H(e,t,i){if(i.has(e))return i.get(e);var r={tile:t,addedOrModified:[],removed:[]};return i.set(e,r),r}Object.defineProperty(t,"__esModule",{value:!0});var P=new Set,O=function(e){function t(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var r=e.apply(this,t)||this;return r._hiddenGraphics=[],r._tiles=new Map,r._graphicStoreUpdate=!1,r._highlightIDs=new Set,r._graphicsSet=new Set,r._matcher=null,r._tileUpdateSet=new Set,r._tilesToUpdate=new Map,r._pendingUpdates=0,r._attached=!1,r.lastUpdateId=-1,r.updateRequested=!1,r.graphicUpdateHandler=r.graphicUpdateHandler.bind(r),r._addOrUpdateGraphic=r._addOrUpdateGraphic.bind(r),r._processAnalyzedGraphics=r._processAnalyzedGraphics.bind(r),r._graphicsChangeHandler=r._graphicsChangeHandler.bind(r),r}return i(t,e),t.prototype.initialize=function(){var e=this;this._tileStore=new U.default(this.view.featuresTilingScheme),this.container=new v.default({tileInfoView:this.view.featuresTilingScheme,highlightIDs:this._highlightIDs}),this._graphicStore=new b.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.renderer,this.graphics),this._graphicProcessingQueue=new G.default({process:this._addOrUpdateGraphic});var t=new S.default(this.container.getMaterialItems);this.renderer&&(this._matcher=m.createMatcher(this.renderer,t,null)),this._meshFactory=new w.default(null,this.uid,null,null,window.devicePixelRatio,this.view.spatialReference,t,null,this._tileStore.tileScheme.tileInfo),this.watch("renderer",function(i){e._graphicStore.renderer=i,i&&(e._matcher=m.createMatcher(e.renderer,t,null))}),this._tileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",function(){e.graphics.items.length>0&&e._graphicsChangeHandler({target:e.graphics,added:e.graphics.items,removed:[],moved:[]}),e.handles.add(e.graphics.on("change",e._graphicsChangeHandler),"graphics"),e._attached=!0,e.notifyChange("updating")})},t.prototype.destroy=function(){this._set("graphics",null),this._graphicStore.clear(),this._tileStore.destroy()},Object.defineProperty(t.prototype,"updating",{get:function(){return!this._attached||0!==this._pendingUpdates||this._graphicProcessingQueue.updating||this._tileUpdateSet.size>0||this._tilesToUpdate.size>0},enumerable:!0,configurable:!0}),t.prototype.install=function(e){e.addChild(this.container)},t.prototype.uninstall=function(e){e.removeChild(this.container)},t.prototype.addHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._highlightIDs.add(r)}this._buildHLList()},t.prototype.highlight=function(e){var t=this;return t.addHighlight(e),{remove:function(){t.removeHighlight(e)}}},t.prototype.hitTest=function(e,t){if(!this.view||!this.view.position)return h.resolve();var i=this.view.toMap(p.createScreenPoint(e,t));return this.searchFeatures(i).then(function(e){return e&&e.length?e[0]:null})},t.prototype.searchFeatures=function(e,t){var i=this;return void 0===t&&(t=2),h.create(function(r){r(i._graphicStore.hitTest(e.x,e.y,t,i.view.state.resolution,i.view.state.rotation))})},t.prototype.removeHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._highlightIDs.delete(r)}this._buildHLList()},t.prototype.setHighlight=function(e){this._highlightIDs.clear(),this.addHighlight(e)},t.prototype.update=function(e){var t=e.state,i=this.view.featuresTilingScheme.getClosestInfoForScale(t.scale).level;this._graphicStore.updateLevel(i),this._tileStore.setViewState(t),this._graphicStoreUpdate=!0,this.updateRequested=!1},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate(this))},t.prototype.processUpdate=function(e){this.updateRequested&&(this.updateRequested=!1,this.update(e))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic,i=e.property,r=e.newValue;switch(i){case"attributes":break;case"geometry":case"symbol":this._graphicProcessingQueue.push(t,"update");break;case"visible":this._setVisible(t.uid,r)}},t.prototype._getIntersectingTiles=function(e){var t=this._graphicStore.getBounds(e);return t&&0!==c.width(t)&&0!==c.height(t)?this._tileStore.boundsIntersections(t):[]},t.prototype._updateTile=function(e){var t=this,i=e.tile,r=this._getGraphicsData(i,e.addedOrModified);return this._processGraphics(i.key,r).then(function(r){return t._patchTile(i.key,{addOrUpdate:r,remove:e.removed}),r})},t.prototype._graphicsChangeHandler=function(e){var t=this;if(this._pendingUpdates++,this.notifyChange("updating"),!this._graphicStoreUpdate){var i=this.view.state,r=this.view.featuresTilingScheme.getClosestInfoForScale(i.scale).level;this._graphicStore.updateLevel(r),this._tileStore.setViewState(i)}for(var a,n=e.added,s=e.removed,o=e.moved,p=this._tilesToUpdate,d=[],l=new Array(n.length),c=0;c<n.length;c++){var u=n[c];l[c]=u,this._graphicsSet.add(u),d.push(this._addOrUpdateGraphic(u,"add"))}for(var g=0,f=s;g<f.length;g++){for(var v=f[g],_=this._getIntersectingTiles(v),y=0,m=_;y<m.length;y++){var w=m[y];a=w.key.id;var S=H(a,w,p);S.removed.push(v.uid)}this._graphicsSet.delete(v),this._graphicStore.remove(v)}for(var U=0,G=o;U<G.length;U++)for(var b=G[U],_=this._getIntersectingTiles(b),T=0,I=_;T<I.length;T++){var w=I[T];a=w.key.id;var S=H(a,w,p);S.addedOrModified.push(b)}h.all(d).then(function(){for(var e,i=0;i<l.length;i++){e=l[i];for(var r=t._getIntersectingTiles(e),n=0,s=r;n<s.length;n++){var o=s[n];a=o.key.id;H(a,o,p).addedOrModified.push(e)}}t._graphicStore.updateZ();var d=[];return p.forEach(function(e){return d.push(t._updateTile(e))}),h.all(d).then(function(){p.clear(),t._pendingUpdates--,t.notifyChange("updating")})}).catch(function(){t._pendingUpdates--})},t.prototype._buildHLList=function(){for(var e=0,t=this.container.children;e<t.length;e++){t[e].buildHLList(this._highlightIDs)}this.container.requestRender()},t.prototype._getSymbolResources=function(e){var t=e.symbol;if(!t&&this.renderer&&(t=this.renderer.getSymbol(e,{scale:this.view.scale})),!t||t&&"text"!==t.type)return h.resolve(null);P.clear();for(var i=t,r=i.text,a=0;a<r.length;a++)P.add(r.charCodeAt(a));var n=[];P.forEach(function(e){return n.push(e)});var s=[];return s.push({symbol:i.toJSON(),id:0,glyphIds:n}),this.container.getMaterialItems(s).then(function(e){return e.length>0?e[0].mosaicItem:null})},t.prototype._projectAndNormalizeGeometry=function(e){var t=this;if(!e.geometry)return h.resolve(null);var i=e.geometry;if(u.isPolygon(i)){var r=i.rings;i.rings=r}else if(u.isPolyline(i)){var a=i.paths;i.paths=a}else u.isExtent(i)&&(i=l.fromExtent(i));return f.checkProjectionSupport(i.spatialReference,this.view.spatialReference).then(function(){var e=T.normalizeCentralMeridian(i),r=f.project(e,i.spatialReference,t.view.spatialReference);return T.ensureClosedRings(r),r})},t.prototype._onTileUpdate=function(e){var t=this,i=g.getInfo(this.view.spatialReference);if(e.added&&e.added.length>0)for(var r=this,a=0,n=e.added;a<n.length;a++){var s=n[a];!function(e){var a=r._graphicStore.queryTileData(e);if(i)for(var n=Math.round((i.valid[1]-i.valid[0])/e.resolution),s=0,o=a;s<o.length;s++){var h=o[s];h.geometry&&u.isPoint(h.geometry)&&r._wrapPoints(h,n)}r._tileUpdateSet.add(e.key),r.notifyChange("updating"),r._processGraphics(e.key,a).then(function(i){t._addTile(e.key,i),t._tileUpdateSet.delete(e.key),t.notifyChange("updating")}).catch(function(){t._tileUpdateSet.delete(e.key),t.notifyChange("updating")})}(s)}if(e.removed&&e.removed.length>0)for(var o=0,h=e.removed;o<h.length;o++){var p=h[o];this._removeTile(p.key)}},t.prototype._addOrUpdateGraphic=function(e,t){var i=this,r=this._projectAndNormalizeGeometry(e),a=this._getSymbolResources(e);return h.all([r,a]).then(function(r){var a=r[0],n=r[1];return"add"===t?i._addProjectedGraphic(e,n,a):i._updateGraphic(e,n,a)})},t.prototype._addProjectedGraphic=function(e,t,i){if(!this._graphicsSet.has(e))return null;e.visible||this._hiddenGraphics.push(e.uid);var r=this._graphicStore.add(e,t,i);return!r||0===c.width(r)&&0===c.height(r)?null:r},t.prototype._updateGraphic=function(e,t,i){var r=this;if(!this._graphicStore.has(e))return h.resolve();for(var a=this._graphicStore.update(e,t,i),n=a.oldBounds,s=a.newBounds,p=0===c.width(n)&&0===c.height(n),d=0===c.width(s)&&0===c.height(s),l=p?[]:this._tileStore.boundsIntersections(n),u=d?[]:this._tileStore.boundsIntersections(s),g=o.acquire(),f=0,v=l;f<v.length;f++){var _=v[f];g.set(_.key,{addOrUpdate:null,remove:[e.uid]})}for(var y=0,m=u;y<m.length;y++){var _=m[y],w=this._getGraphicData(_,e);if(g.has(_.key)){var S=g.get(_.key);S.remove.length=0,S.addOrUpdate=w}else g.set(_.key,{addOrUpdate:w,remove:null})}var U=[];return g.forEach(function(e,t){var i=r._processGraphics(t,e.addOrUpdate).then(function(i){r._patchTile(t,{addOrUpdate:i,remove:e.remove})});U.push(i)}),o.release(g),h.all(U).then(function(){return s})},t.prototype._addTile=function(e,t){var i=c.create();this.view.featuresTilingScheme.getTileBounds(i,e);var r=new y(e,i,!0),a={clear:!0,addOrUpdate:t,remove:[]};r.setData(a,!1,!1),r.buildHLList(this._highlightIDs),this._hiddenGraphics.length>0&&r.setFilterFlag(0,[],this._hiddenGraphics),this._tiles.set(e,r),this.container.addChild(r)},t.prototype._removeTile=function(e){if(this._tiles.has(e)){var t=this._tiles.get(e);this.container.removeChild(t)}},t.prototype._patchTile=function(e,t){if(this._tiles.has(e)){var i=this._tiles.get(e);i.setData(t,!1,!1),i.buildHLList(this._highlightIDs),this._hiddenGraphics.length>0&&i.setFilterFlag(0,[],this._hiddenGraphics),this.container.requestRender()}},t.prototype._setVisible=function(e,t){var i=[],r=[],a=this._hiddenGraphics.indexOf(e);if(t){if(-1===a)return;this._hiddenGraphics.splice(a,1),i.push(e)}else{if(-1!==a)return;this._hiddenGraphics.push(e),r.push(e)}for(var n=this.container.children,s=0,o=n;s<o.length;s++){var h=o[s];h.data&&h.setFilterFlag(0,i,r)}},t.prototype._getGraphicsData=function(e,t){var i=g.getInfo(this.view.spatialReference),r=this._graphicStore.getGraphicsData(e,t);if(i)for(var a=Math.round((i.valid[1]-i.valid[0])/e.resolution),n=0,s=r;n<s.length;n++){var o=s[n];o.geometry&&u.isPoint(o.geometry)&&this._wrapPoints(o,a)}return r.sort(function(e,t){return e.insertAfter-t.insertAfter}),r},t.prototype._getGraphicData=function(e,t){var i=this._graphicStore.getGraphicData(e,t),r=[i],a=g.getInfo(this.view.spatialReference);if(a){var n=Math.round((a.valid[1]-a.valid[0])/e.resolution);i.geometry&&u.isPoint(i.geometry)&&this._wrapPoints(i,n)}return r},t.prototype._wrapPoints=function(e,t){var i=e.geometry;512===t?i.x<20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>492&&(e.geometry={points:[[i.x,i.y],[-t,0]]}):i.x<-20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>532&&(e.geometry={points:[[i.x,i.y],[-t,0]]})},t.prototype._processGraphics=function(e,t){var i=this;return t&&t.length&&this._meshFactory?this._meshFactory.analyze(t,this._matcher).then(function(t){return i._processAnalyzedGraphics(e,t)}):h.resolve(null)},t.prototype._processAnalyzedGraphics=function(e,t){for(var i=this._meshFactory,r=i.createMeshData(t.length),a=0,n=t;a<n.length;a++){var s=n[a];i.write(r,s,null,null,e.level)}return _.fromMeshData(r)},r([d.property()],t.prototype,"_graphicProcessingQueue",void 0),r([d.property({constructOnly:!0})],t.prototype,"graphics",void 0),r([d.property({dependsOn:["_graphicProcessingQueue.updating"]})],t.prototype,"updating",null),r([d.property()],t.prototype,"view",void 0),r([d.property()],t.prototype,"updateRequested",void 0),t=r([d.subclass("esri.views.2d.layers.support.GraphicsView2D")],t)}(d.declared(I,n,s.Identifiable));t.default=O});