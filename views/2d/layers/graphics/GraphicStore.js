// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","@dojo/framework/shim/Map","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/rbush/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../engine/webgl/util/iterator","./GraphicStoreItem","./graphicsUtils"],function(e,t,i,r,o,n,s,a,u,l,h,c,d,p){function m(e,t,i,r,o){return g.minX=t,g.minY=i,g.maxX=r,g.maxY=o,e.search(g)}Object.defineProperty(t,"__esModule",{value:!0});var g={minX:0,minY:0,maxX:0,maxY:0},y=a.create(),f=[],_=function(){function e(e,t,i,n,a){this.renderer=n,this._graphics=a,this._index=s(9,o("csp-restrictions")?function(e){return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new r.default,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=i;var u=e.getClosestInfoForScale(t);u&&(this._currentLevel=u.level,this._resolution=this._tileInfoView.getTileResolution(u.level))}return e.prototype.hitTest=function(e,t,i,r,o){e=h.normalizeMapX(e,this._tileInfoView.spatialReference);var s=.5*r*i;y[0]=e-s,y[1]=t-s,y[2]=e+s,y[3]=t+s;var c=.5*r*(i+50),d=m(this._index,e-c,t-c,e+c,t+c);if(!d||0===d.length)return[];for(var g,f={x:e,y:t},_=[],b=0,v=d;b<v.length;b++){var x=v[b];if(x.graphic.visible)switch(l.getJsonType(x.geometry)){case"esriGeometryPoint":var G=this._getSymbol(x.graphic);if(!G)continue;var B=x.geometry,z=void 0;if("text"===G.type){var w=G;z=p.getTextSymbolBounds(B.x,B.y,w,x.size,this._resolution,o)}else z=p.getMarkerSymbolBounds(B.x,B.y,G,this._resolution,o);u.polygonContainsPoint(z,f)&&_.push(x);break;case"esriGeometryPolyline":var P=this._getSymbol(x.graphic);if(!P)continue;g=1.5*r*window.devicePixelRatio*n.pt2px(P.width),p.isPointOnPolyline(x.geometry,e,t,g)&&_.push(x);break;case"esriGeometryEnvelope":var S=x.geometry,T=a.fromValues(S.xmin,S.ymin,S.xmax,S.ymax);a.intersects(T,y)&&_.push(x);break;case"esriGeometryPolygon":u.polygonContainsPoint(x.geometry,f)&&_.push(x);break;case"esriGeometryMultipoint":var I=this._getSymbol(x.graphic);if(!I)continue;for(var k=x.geometry.points,V=void 0,L=0;L<k.length;L++){if("text"===I.type){var w=I;V=p.getTextSymbolBounds(k[L][0],k[L][1],w,x.size,this._resolution,o)}else V=p.getMarkerSymbolBounds(k[L][0],k[L][1],I,this._resolution,o);if(u.polygonContainsPoint(V,f)){_.push(x);break}}}}return _.sort(function(e,t){var i=p.graphicGeometryToNumber(e.graphic),r=p.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r}),_.map(function(e){return e.graphic})},e.prototype.getGraphicsData=function(e,t){var r=m(this._index,e.bounds[0],e.bounds[1],e.bounds[2],e.bounds[3]);if(0===r.length||0===t.length)return[];r.sort(function(e,t){return e.zorder-t.zorder}),r[0].insertAfter=-1;for(var o=1;o<r.length;o++)r[o].insertAfter=r[o-1].graphic.uid;r.sort(function(e,t){return e.graphic.uid-t.graphic.uid}),t.sort(function(e,t){return e.uid-t.uid});for(var n,s=0,a=0,u=[],l={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},h=0,c=t;h<c.length;h++){var p=c[h];for(a=-2;s<r.length;)if(n=r[s],s++,p.uid===n.graphic.uid){a=n.insertAfter;break}if(n.geometry&&-2!==a){var g=n.getGeometryQuantized(l),y=i({},n.graphic.attributes);y[this._uidFieldName]=p.uid,u.push({centroid:d.default.getCentroidQuantized(n,l,this.renderer,this._scale),geometry:g,attributes:y,symbol:p.symbol,insertAfter:a})}}return u},e.prototype.getGraphicData=function(e,t){var r=this._itemByGraphic.get(t);if(!r)return null;var o=m(this._index,e.bounds[0],e.bounds[1],e.bounds[2],e.bounds[3]);o.sort(function(e,t){return e.zorder-t.zorder});var n=o.indexOf(r),s=0===n||-1===n?-1:o[n-1].graphic.uid,a={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},u=r.getGeometryQuantized(a),l=i({},r.graphic.attributes);return l[this._uidFieldName]=t.uid,{centroid:d.default.getCentroidQuantized(r,a,this.renderer,this._scale),geometry:u,attributes:l,symbol:t.symbol,insertAfter:s}},e.prototype.queryTileData=function(e){var t=50*e.resolution,i=a.pad(e.bounds,t,a.create()),r=m(this._index,i[0],i[1],i[2],i[3]),o=[];return this._createTileGraphics(o,r,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}),o},e.prototype.has=function(e){return this._itemByGraphic.has(e)},e.prototype.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},e.prototype.add=function(e,t,i){if(e){var r=d.default.acquire(e,i,t,this.renderer,this._resolution,this._scale,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds}},e.prototype.remove=function(e){if(this._itemByGraphic.has(e)){var t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)}},e.prototype.updateZ=function(){for(var e,t,i=this._graphics.items,r=0;r<i.length;r++)t=i[r],(e=this._itemByGraphic.get(t))&&(e.zorder=r)},e.prototype.update=function(e,t,i){var r=this._itemByGraphic.get(e),o=a.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,i,t,this.renderer,this._resolution,this._scale,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:o,newBounds:r.bounds}},e.prototype.updateLevel=function(e){var t=this;if(this._currentLevel!==e){this._currentLevel=e;var i=this._tileInfoView.getTileResolution(e);this._resolution=i,this._scale=this._tileInfoView.getTileScale({level:e,row:0,col:0,world:0}),this._index.clear();var r=this._itemByGraphic.values();f.length=0,c.forEachIter(r,function(e){e.updateBounds(t.renderer,t._resolution,t._scale,t._tileInfoView.spatialReference),e.geometry&&f.push(e)}),this._index.load(f)}},e.prototype.clear=function(){this._itemByGraphic.clear(),this._index.clear()},e.prototype._createTileGraphics=function(e,t,r){var o=this._uidFieldName;t.sort(function(e,t){return e.zorder-t.zorder});for(var n,s,a,u,l=0;l<t.length;l++){a=t[l],n=a.graphic,s=a.getGeometryQuantized(r),u=0===l?-1:t[l-1].graphic.uid;var h=i({},a.graphic.attributes);h[o]=n.uid,e.push({centroid:d.default.getCentroidQuantized(a,r,this.renderer,this._scale),geometry:s,attributes:h,symbol:n.symbol,insertAfter:u})}},e.prototype._getSymbol=function(e){return e.symbol?e.symbol:this.renderer?this.renderer.getSymbol(e,{scale:this._scale}):null},e}();t.default=_});