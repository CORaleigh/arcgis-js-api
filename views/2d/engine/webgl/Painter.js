// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/has","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./Utils","./VertexStream","./brushes/WGLBrushInfo","./brushes/WGLBrushStencil","./brushes/WGLGeometryBrushFill","./brushes/WGLGeometryBrushLabel","./brushes/WGLGeometryBrushLine","./brushes/WGLGeometryBrushMarker","./brushes/WGLGeometryBrushText","./painter/WGLHighlightPainter","./shaders/RasterPrograms","../../../webgl/FramebufferObject","../../../webgl/programUtils"],function(t,e,c,s,y,r,B,i,a,P,n,o,g,h,l,u,p,_,d,f,b,m,w,L,G){Object.defineProperty(e,"__esModule",{value:!0});var T=function(){function t(){this._initialized=!1}return t.prototype.registerPass=function(t,e){this._initialize();for(var s=0;s<P.WGLDrawPhase.NUM_DRAW_PHASES-2;s++){var r=1<<s;r&e&&this._passMap.set(r,t)}return this},t.prototype.getPaintPassTs=function(t){return this._initialize(),this._passMap.has(t)?[this._passMap.get(t)]:[]},t.prototype._initialize=function(){this._initialized||(this._passMap=new Map,this._initialized=!0)},t}();e.PainterOptions=T;var E=new Uint8Array(4*g.C_HITTEST_SEARCH_SIZE*g.C_HITTEST_SEARCH_SIZE),S=new Uint32Array(E.buffer),O=i.vec3f32.create(),x=[0,0],F=function(){function t(t){this.context=t,this._hlPainter=new m.default,this._blitRenderer=new a,this._globalOpacityFBO=null,this._boundFBO=null,this.textureManager=new o,this.stencilRef=-1,this.materialManager=new n(t),this._quadVertexStream=new h(t,[0,0,1,0,0,1,1,1]),this._transformTextureProgram=G.createProgram(t,w.transformTexture),this._transformSolidProgram=G.createProgram(t,w.transformSolid),this._transform=r.mat4f32.create()}return t.prototype.dispose=function(){this.materialManager.dispose(),this.textureManager.dispose(),this._hlPainter&&(this._hlPainter.dispose(),this._hlPainter=null),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._globalOpacityFBO&&(this._globalOpacityFBO.dispose(),this._globalOpacityFBO=null),this._boundFBO=null,this._hittestFBO&&(this._hittestFBO.dispose(),this._hittestFBO=null),this._passes&&(this._passes.forEach(function(t){return t.dispose()}),this._passes.clear()),this._brushes&&(this._brushes.forEach(function(t){return t.forEach(function(t){return t.dispose()})}),this._brushes.clear()),this._geometryBrushes&&(this._geometryBrushes.forEach(function(t){return t.dispose()}),this._geometryBrushes.clear()),this._quadVertexStream.dispose()},t.prototype.getBrushes=function(t){if(t===P.WGLDrawPhase.MAP)throw new Error("Painter: Tried to get brush for the MAP phase; use a specific geometry type and call getMapBrush() instead.");if(!this._brushes){var e=[this.getGeometryBrush(P.WGLGeometryType.FILL),this.getGeometryBrush(P.WGLGeometryType.LINE),this.getGeometryBrush(P.WGLGeometryType.MARKER),this.getGeometryBrush(P.WGLGeometryType.TEXT)],s=new _.default,r=new l.default,i=new u.default;this._brushes=new Map,this._brushes.set(P.WGLDrawPhase.LABEL,[s]),this._brushes.set(P.WGLDrawPhase.LABEL_ALPHA,[s]),this._brushes.set(P.WGLDrawPhase.HITTEST,e),this._brushes.set(P.WGLDrawPhase.HIGHLIGHT,e),this._brushes.set(P.WGLDrawPhase.CLIP,[i]),this._brushes.set(P.WGLDrawPhase.DEBUG,[r])}if(!this._brushes.has(t))throw new Error("Painter: Tried to get brush for unknown phase: "+t);return this._brushes.get(t)},t.prototype.getGeometryBrush=function(t){if(!this._geometryBrushes){var e=new p.default,s=new d.default,r=new f.default,i=new b.default,a=new _.default;this._geometryBrushes=new Map,this._geometryBrushes.set(P.WGLGeometryType.FILL,e),this._geometryBrushes.set(P.WGLGeometryType.LINE,s),this._geometryBrushes.set(P.WGLGeometryType.MARKER,r),this._geometryBrushes.set(P.WGLGeometryType.TEXT,i),this._geometryBrushes.set(P.WGLGeometryType.LABEL,a)}return this._geometryBrushes.get(t)},t.prototype.draw=function(t,e,s,r){this._setGlobalOpacity(t,s),0==(s&(P.WGLDrawPhase.LABEL_ALPHA|P.WGLDrawPhase.LABEL))&&this._drawClippingRects(t,e);var i=this.context;i.setBlendingEnabled(!0),i.setStencilWriteMask(0),i.setBlendFunctionSeparate(1,771,1,771),this._drawPhases(t,e,s,r),this._applyGlobalOpacity(t,s),this._debugTiles(t,e)},t.prototype.highlight=function(t,e){var s=this.context,r=s.getViewport();this._hlPainter.setup(s,r.width,r.height),this._hlPainter.startMaskDraw(s),this._drawClippingRects(t,e),s.setBlendingEnabled(!0),s.setStencilWriteMask(0),s.setBlendFunctionSeparate(1,771,1,771),this._drawPhases(t,e,P.WGLDrawPhase.HIGHLIGHT),this._hlPainter.draw(s)},t.prototype.setHighlightOptions=function(t){this._hlPainter.setHighlightOptions(t)},t.prototype.hitTest=function(t,e){var s=this.context,r=g.C_HITTEST_SEARCH_SIZE,i=[0,0],a=[0,0],n=t.state;if(n.toMap(i,[0,0]),n.toMap(a,[r,r]),0===e.filter(function(t){return!(i[0]>t.bounds[2]||a[0]<t.bounds[0]||i[1]<t.bounds[1]||a[1]>t.bounds[3])}).length)return[];this._hittestFBO||(this._hittestFBO=L.create(s,{colorTarget:0,depthStencilTarget:3,width:r,height:r}));var o=s.getViewport(),h=s.getBoundFramebufferObject();s.bindFramebuffer(this._hittestFBO),s.setViewport(0,0,r,r),this._drawClippingRects(t,e);var l=s.gl;s.setClearColor(1,1,1,1),s.clear(l.COLOR_BUFFER_BIT),s.setBlendingEnabled(!1),s.setStencilWriteMask(0),this._drawPhases(t,e,P.WGLDrawPhase.HITTEST),s.setBlendingEnabled(!0),this._hittestFBO.readPixels(0,0,r,r,6408,5121,E);for(var u=r*r,c=new Set,p=0;p<u;p++){var _=S[p];4294967295!==_&&c.add(_)}s.bindFramebuffer(h),s.setViewport(o.x,o.y,o.width,o.height);var d=[];return c.forEach(function(t){d.push(t)}),d},t.prototype.startStencilBurn=function(){this.context.setStencilTestEnabled(!0),this.context.setStencilWriteMask(255),this.context.setClearStencil(0),this.context.clear(this.context.gl.STENCIL_BUFFER_BIT),this.context.setStencilOp(7680,7680,7681),this.context.setColorMask(!1,!1,!1,!1),this.context.setBlendingEnabled(!1),this._quadVertexStream.bind(),this.context.bindProgram(this._transformSolidProgram)},t.prototype.startStencilDraw=function(){this.context.setStencilWriteMask(0),this.context.setStencilOp(7680,7680,7680),this.context.setColorMask(!0,!0,!0,!0),this.context.setBlendingEnabled(!0),this.context.setBlendFunction(1,771),this._quadVertexStream.bind(),this.context.bindProgram(this._transformTextureProgram)},t.prototype.endStencilDraw=function(){this.context.setStencilTestEnabled(!1),this._quadVertexStream.unbind(),this.context.bindProgram()},t.prototype.drawBitmap=function(t,e,s){var r=this.context,i=t.state,a=-Math.PI*i.rotation/180,n=-Math.PI*e.rotation/180;!(a+e.rotation)&&s<1.05&&.95<s?e.setSamplingMode(9728):e.setSamplingMode(9729);var o,h=i.toScreen(x,e.x,e.y),l=h[0],u=h[1],c=t.state.size[0],p=t.state.size[1],_=s*e.width,d=s*e.height,g=t.globalOpacity*e.opacity,f=this._transform,b=this._quadVertexStream,m=t.drawPhase;o=m===P.WGLDrawPhase.CLIP?(r.setStencilFunction(519,this.stencilRef,255),this._transformSolidProgram):(r.setStencilFunction(514,this.stencilRef,255),this._transformTextureProgram),y.mat4.identity(f),y.mat4.scale(f,f,B.vec3.set(O,2/c,2/p,1)),y.mat4.translate(f,f,B.vec3.set(O,l-c/2,p/2-u,0)),y.mat4.rotateZ(f,f,a),y.mat4.translate(f,f,B.vec3.set(O,_/2,-d/2,0)),y.mat4.rotateZ(f,f,-n),y.mat4.scale(f,f,B.vec3.set(O,_/2,d/2,1)),o.setUniformMatrix4fv("u_transform",f),m!==P.WGLDrawPhase.CLIP&&(e.bind(0),o.setUniform1i("u_texture",0)),o.setUniform1f("u_opacity",g),b.draw()},t.prototype._getPaintPass=function(e){if(this._passes||(this._passes=new Map),!this._passes.has(e))try{this._passes.set(e,new e)}catch(t){throw new Error("Tried to instantiate WGLPaintPass with unknown constructor: "+e+",\n"+t)}return this._passes.get(e)},t.prototype._getPaintPasses=function(t,e){var s=this;return e.getPaintPassTs(t).map(function(t){return s._getPaintPass(t)})},t.prototype._drawPhases=function(e,t,s,r){var i=this.context;i.setStencilTestEnabled(!0);for(var a=0;a<P.WGLDrawPhase.NUM_DRAW_PHASES-2;a++){var n=1<<a;if(n&s){var o=r?this._getPaintPasses(n,r):[],h=c({},e,{drawPhase:n});o.forEach(function(t){return t.preRender(e,e.rendererInfo)});for(var l=0,u=t;l<u.length;l++){u[l].doRender(h)}o.reverse().forEach(function(t){return t.postRender(e,e.rendererInfo)})}}i.setStencilTestEnabled(!1)},t.prototype._debugTiles=function(t,e){s("esri-feature-tiles-debug")&&this._drawPhases(t,e,P.WGLDrawPhase.DEBUG)},t.prototype._drawClippingRects=function(t,e){if(0!==e.length){var s=this.context;s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setColorMask(!1,!1,!1,!1),s.setStencilOp(7680,7680,7681),s.setClearStencil(0),s.clear(s.gl.STENCIL_BUFFER_BIT),s.setStencilWriteMask(255);for(var r=0,i=e.length;r<e.length;r++,i--){var a=e[r];a.attached&&(a.stencilRef=i)}this._drawPhases(t,e,P.WGLDrawPhase.CLIP),s.setColorMask(!0,!0,!0,!0)}},t.prototype._setGlobalOpacity=function(t,e){if(e===P.WGLDrawPhase.MAP&&1!==t.globalOpacity){var s=t.context,r=t.pixelRatio,i=t.state.size,a=i[0],n=i[1],o=Math.round(a*r),h=Math.round(n*r);null!==this._globalOpacityFBO&&this._globalOpacityFBO.width===o&&this._globalOpacityFBO.height===h||(null!==this._globalOpacityFBO&&this._globalOpacityFBO.dispose(),this._globalOpacityFBO=L.create(s,{colorTarget:0,depthStencilTarget:3,width:o,height:h})),this._boundFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this._globalOpacityFBO),s.setDepthWriteEnabled(!0),s.setStencilWriteMask(255),s.setClearColor(0,0,0,0),s.setClearDepth(1),s.setClearStencil(0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),s.setDepthWriteEnabled(!1)}},t.prototype._applyGlobalOpacity=function(t,e){if(e===P.WGLDrawPhase.MAP&&1!==t.globalOpacity){var s=t.context;s.bindFramebuffer(this._boundFBO);var r=this._globalOpacityFBO.colorTexture;this._blitRenderer.render(s,r,9728,t.globalOpacity),this._boundFBO=null}},t}();e.default=F});