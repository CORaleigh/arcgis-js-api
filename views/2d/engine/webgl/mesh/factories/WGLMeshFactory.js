// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../geometry/support/jsonUtils","../../../../../../symbols/SimpleLineSymbol","../../definitions","../../enums","../../WGLDisplayObject","../../collisions/LayerCollisionInfo","../MeshData","../VertexVector","./VVFactory","../templates/WGLLabelTemplate","../templates/WGLLineTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore","../../util/vvFlagUtils"],function(e,t,r,i,l,u,V,a,T,n,w,y,p,m,h,g,o,s,F,b){Object.defineProperty(t,"__esModule",{value:!0});var f=l.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),c={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null};var v=function(){function e(e,t,r,l,a,i,o,s,n){this._isDD=!1,this._labelsDebugTemplate=null,this._labelsDebugVVEval=null;var p=u.isSome(r)&&"visualVariables"in r&&r.visualVariables;this._isDD=u.isSome(r)&&"dot-density"===r.type,this._geometryType=e,this._idField=t,this._pixelRatio=a,this._vvFlags=p?b.getVVFlags(p):0,this._vvFactory=u.isSome(r)&&h.default.fromRenderer(r,l),this._vvBuf=new ArrayBuffer(32),this._vvBufU32=new Uint32Array(this._vvBuf),this._vvBufF32=new Float32Array(this._vvBuf),this._templateStore=o,s&&(T.DEBUG_LABELS&&(this._labelsDebugVVEval=p&&y.createLabelVVEvaluator(p)),this._validateLabelingInfo(s)&&(this._labelTemplates=s.map(function(e){return g.default.fromLabelClass(r,e,n)})))}return Object.defineProperty(e.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0}),e.prototype.createMeshData=function(e){var t=new Array(5),r=new Array,l=!!b.getMarkerVVFlags(this._vvFlags),a=!!b.getFillVVFlags(this._vvFlags),i=!!b.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),o=!!b.getTextVVFlags(this._vvFlags),s="esriGeometryPolyline"===this._geometryType?T.HEURISTIC_GLYPHS_PER_LINE:T.HEURISTIC_GLYPHS_PER_FEATURE;return t[n.WGLGeometryType.MARKER]=new m.VertexVectors(n.WGLGeometryType.MARKER,l,e),t[n.WGLGeometryType.FILL]=new m.VertexVectors(n.WGLGeometryType.FILL,a,e,this._isDD),t[n.WGLGeometryType.LINE]=new m.VertexVectors(n.WGLGeometryType.LINE,i,e),t[n.WGLGeometryType.TEXT]=new m.VertexVectors(n.WGLGeometryType.TEXT,o,e),t[n.WGLGeometryType.LABEL]=new m.VertexVectors(n.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?s:0),new p.default(r,t)},e.prototype.analyze=function(e,t,r,l){for(var a=e,i=0,o=a;i<o.length;i++){var s=o[i],n=-1;if("symbol"in s)s.filterFlags=1,null!=s.symbol?n=this._templateStore.createTemplateGroup(s.symbol,null,null,null):t&&(n=t.match(s,r,l));else if(t&&(n=t.match(s,r,l),F.isDynamicId(n)))for(var p=0,u=this._templateStore.getDynamicTemplateGroup(n);p<u.length;p++){var y=u[p];y&&y.analyze&&y.analyze(s,this._templateStore)}s.groupId=n}return this._templateStore.finalize().then(function(){return a})},e.prototype.write=function(e,t,r,l,a,i,o){var s=this._templateStore.getTemplateGroup(t.groupId),n=e,p=t.attributes[this._idField],u=new w(p),y=!!i&&!!this._labelTemplates&&i.has(p);if(F.isDynamicId(t.groupId))for(var m=0,h=s;m<h.length;m++){(L=h[m]).bindFeature(t,r,l)}if(s&&(t.geometry||t.centroid)){this._vvFactory&&this._vvFactory.computeVV(this._vvBufF32,t,r,l);var g=u.displayRecords,b=t.insertAfter;void 0!==b&&(u.insertAfter=b);var f=this._geometryType;f||(f=null!=t.centroid?"esriGeometryPolygon":V.getJsonType(t.geometry));var c=t.filterFlags;u.filterFlags=c;for(var v=0,_=s;v<_.length;v++){var L=_[v],d=n.get(L.geometryType);L.writeMesh(g,d,f,p,t,this._pixelRatio,this._vvBufU32,c)}if(y){var T=this._getLabelReference(s),G=i.get(p);this._writeLabelMesh(u,n,p,t,o,G,T,a,f,c)}n.pushDisplayObject(u)}},e.prototype._hasBadLabelClass=function(e,t){var r=e.labelPlacement,l=c[t];if(!e.symbol)return f.error(new i("mapview-labeling:missing-required-parameter","Unable to create labels for Feature Layer, LabelClass missing symbol",e)),!0;if(!l)return f.error(new i("mapview-labeling:unsupported-geometry-type","Unable to create labels for Feature Layer, "+t+" is not supported")),!0;if(!l.some(function(e){return e===r})){var a=l[0];r&&f.warn("Found invalid label placement type "+r+" for "+t+". Defaulting to "+a),e.labelPlacement=a}return!1},e.prototype._validateLabelingInfo=function(e){var t=this;return!e.some(function(e){return t._hasBadLabelClass(e,t._geometryType)})},e.prototype._getLabelReference=function(e){for(var t=0,r=e;t<r.length;t++){var l=r[t];if(l instanceof s.default)return l}return null},e.prototype._writeLabelMesh=function(e,t,r,l,a,i,o,s,n,p){for(var u=e.displayRecords,y=[],m=this._pixelRatio,h=this._vvBufU32,g=0;g<i.length;g++){var b=i[g],f=b.id,c=b.text,v=b.rtl,_=this._labelTemplates[f],L=t.get(_.geometryType),d=a.get(_.symbolId).glyphMosaicItems;_.bindReferenceTemplate(o),_.bindTextInfo(d,c,v),_.writeMesh(u,L,n,r,l,m,h,p,s,y)}e.metrics=y,T.DEBUG_LABELS&&this._debugLabels(e,t,p)},e.prototype._debugLabels=function(e,t,r){for(var l=e.displayRecords,a=e.id,i=0,o=e.metrics;i<o.length;i++){var s=o[i],n=s.boxes?s.boxes.concat([s.bounds]):[s.bounds];this._labelsDebugVVEval&&s.computeOffset(this._labelsDebugVVEval);for(var p=0,u=n;p<u.length;p++){var y=u[p],m=s.anchor[0]+s.offsetX+y.center[0],h=s.anchor[1]+s.offsetY+y.center[1],g={geometry:{paths:[[[m-y.width/2,h+y.height/2],[0,-y.height],[y.width,0],[0,y.height],[-y.width,0]]]},attributes:{}},b=this._getLabelDebugTemplate(),f=t.get(b.geometryType),c=this._pixelRatio;b.writeMesh(l,f,"esriGeometryPolyline",a,g,c,null,r)}}},e.prototype._getLabelDebugTemplate=function(){return this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate()),this._labelsDebugTemplate},e.prototype._createLabelsDebugTemplate=function(){var e=new a({style:"solid",width:1,color:[255,0,0,1]});return o.default.fromSimpleLine(null,!1,e,null)},e}();t.default=v});