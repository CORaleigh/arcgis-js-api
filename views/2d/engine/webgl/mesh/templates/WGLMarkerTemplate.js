// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../color","../../definitions","../../enums","../../enums","../../number","../../WGLDisplayRecord","../../materialKey/MaterialKey","./WGLMeshTemplate"],function(e,t,r,A,i,f,T,C,R,L,c,n,O,G,P,M,E,o){Object.defineProperty(t,"__esModule",{value:!0});var b=i.getLogger("esri.views.2d.engine.webgl.WGLMeshTemplate"),s=function(V){function d(e,t,r,i,o,s,n,h,a,p,u,l,d){var f=V.call(this)||this;f.geometryType=O.WGLGeometryType.MARKER,(200<s||200<n)&&(b.error(new A("mapview-oversized-resource","Marker size was clamped to the maximum allowed value of 200x200 pixels")),n<s?(n*=200/s,s=200):(s*=200/n,n=200));var c=L.vec2f32.create(),m=C.mat2df32.create();s=0===s?0:Math.max(s,2),n=0===n?0:Math.max(n,2);var y=(l===G.Alignment.MAP?1:0)|(p?1:0)<<1|(u?1:0)<<2,_=d.sdf?.5:1;if(T.mat2d.translate(m,m,L.vec2f32.fromValues(_*t,_*-r)),i){T.mat2d.rotate(m,m,3.14159265359/180*i)}var g=E.MarkerMaterialKey.load(E.createMaterialKey(f.geometryType,e,!1));d&&(g.sdf=d.sdf,g.pattern=!0,g.textureBinding=d.textureBinding),f._materialKey=g.data,f._fillColor=o,f._outlineColor=h,f._sizeOutlineWidth=P.i8888to32(s,n,a,y);var x=Math.round(d.rect.x/4)-128,M=Math.round(d.rect.y/4)-128,v=x+Math.round(d.rect.width/4),w=M+Math.round(d.rect.height/4);return R.vec2.set(c,-.5*s,-.5*n),R.vec2.transformMat2d(c,c,m),f._offsetAndTexUpperLeft=P.i8888to32(P.i8(c[0]),P.i8(c[1]),x,M),R.vec2.set(c,.5*s,-.5*n),R.vec2.transformMat2d(c,c,m),f._offsetAndTexUpperRight=P.i8888to32(P.i8(c[0]),P.i8(c[1]),v,M),R.vec2.set(c,-.5*s,.5*n),R.vec2.transformMat2d(c,c,m),f._offsetAndTexBottomLeft=P.i8888to32(P.i8(c[0]),P.i8(c[1]),x,w),R.vec2.set(c,.5*s,.5*n),R.vec2.transformMat2d(c,c,m),f._offsetAndTexBottomRight=P.i8888to32(P.i8(c[0]),P.i8(c[1]),v,w),f.height=n,f.width=s,f.xOffset=t,f.yOffset=r,f}return r(d,V),d.fromCIMMarker=function(e,t,r){var i=c.premultiplyAlphaRGBA(t.color),o=c.premultiplyAlphaRGBA(t.outlineColor),s=Math.round(f.pt2px(t.size)),n=Math.round(f.pt2px(t.size/r.height*r.width)),h=Math.round(f.pt2px(t.offsetX||0)),a=Math.round(f.pt2px(t.offsetY||0)),p=Math.round(f.pt2px(t.outlineWidth||0)),u=t.rotation||0,l=t.alignment||G.Alignment.SCREEN;return new d(e,h,a,u,i,n,s,o,p,t.colorLocked,!1,l,r)},d.fromPictureMarker=function(e,t,r){var i=Math.round(f.pt2px(t.width)),o=Math.round(f.pt2px(t.height)),s=n.PICTURE_FILL_COLOR;return new d(e,Math.round(f.pt2px(t.xoffset||0)),Math.round(f.pt2px(t.yoffset||0)),t.angle,s,i,o,0,0,!1,!1,G.Alignment.SCREEN,r)},d.fromSimpleMarker=function(e,t,r){var i=c.premultiplyAlphaRGBA(t.color),o=Math.round(f.pt2px(t.size)),s=o,n=Math.round(f.pt2px(t.xoffset||0)),h=Math.round(f.pt2px(t.yoffset||0)),a=t.style,p=t.outline,u=0|(p&&p.color&&c.premultiplyAlphaRGBA(p.color)),l=0|(p&&p.width&&Math.round(f.pt2px(p.width)));return new d(e,n,h,t.angle,i,o,s,u,l,!1,"cross"===a||"x"===a,G.Alignment.SCREEN,r)},d.prototype.writeMesh=function(e,t,r,i,o,s,n,h){var a=E.MarkerMaterialKey.load(this._materialKey),p=t.indexVector,u=t.get("geometry"),l=t.get("visibility"),d=new M(i,this.geometryType,this._materialKey),f=t.getVector("geometry").vertexCount;switch(e.push(d),d.vertexFrom=f,d.indexFrom=p.length,r){case"esriGeometryPoint":var c=o.geometry,m=c.x,y=c.y;return this._writeVertices(d,u,l,i,this._getPos(m,y),a,n,h),void this._writeIndices(d,p,f);case"esriGeometryPolyline":var _=o.geometry.paths;return void this._writeMany(d,p,u,l,f,i,_[0],a,n,h);case"esriGeometryPolygon":var g=o.centroid;if(g){m=g.x,y=g.y;this._writeVertices(d,u,l,i,this._getPos(m,y),a,n,h),this._writeIndices(d,p,f)}else b.error("Tried to render polygon geometries as markers, but found no centroid!");return;case"esriGeometryMultipoint":var x=o.geometry.points;return void this._writeMany(d,p,u,l,f,i,x,a,n,h);case"esriGeometryEnvelope":default:b.error("Unable to handle geometryType: "+r)}},d.prototype._getPos=function(e,t){return P.i1616to32(e,t)},d.prototype._writeMany=function(e,t,r,i,o,s,n,h,a,p){for(var u=0,l=0,d=0,f=0,c=n;f<c.length;f++){var m=c[f],y=m[0],_=m[1],g=this._getPos(y+u,_+l);this._writeVertices(e,r,i,s,g,h,a,p),this._writeIndices(e,t,o+d),u+=y,l+=_,d+=4}},d.prototype._writeVertices=function(e,t,r,i,o,s,n,h){t.push(o),t.push(this._offsetAndTexUpperLeft),t.push(i),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),this._writeVV(t,n,s),r.push(h),t.push(o),t.push(this._offsetAndTexUpperRight),t.push(i),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),this._writeVV(t,n,s),r.push(h),t.push(o),t.push(this._offsetAndTexBottomLeft),t.push(i),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),this._writeVV(t,n,s),r.push(h),t.push(o),t.push(this._offsetAndTexBottomRight),t.push(i),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),this._writeVV(t,n,s),r.push(h),e.vertexCount+=4},d.prototype._writeVV=function(e,t,r){r.hasVV()&&(e.push(t[O.VVType.SIZE]),e.push(t[O.VVType.COLOR]),e.push(t[O.VVType.OPACITY]),e.push(t[O.VVType.ROTATION]))},d.prototype._writeIndices=function(e,t,r){var i=r;t.push(i+0),t.push(i+1),t.push(i+2),t.push(i+1),t.push(i+3),t.push(i+2),e.indexCount+=6},d}(o.default);t.default=s});