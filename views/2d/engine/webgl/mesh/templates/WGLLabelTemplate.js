// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../definitions","../../enums","../../number","../../TextShaping","../../collisions/Metric","../../materialKey/MaterialKey","./GlyphGroup","./util","./WGLTextTemplate","../../../../../3d/support/mathUtils","../../../../../vectorTiles/GeometryUtils"],function(e,t,r,o,a,m,i,_,s,O,D,E,n,Z,z,pe,L,h,S,d){Object.defineProperty(t,"__esModule",{value:!0});var l=a.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),v=E.i8888to32(255,255,255,255),g=s.vec2f32.create(),b=i.mat2df32.create();var x={xOffset:0,yOffset:0,width:0,height:0},T=function(e,t){return void 0===t&&(t="mapview-labeling"),l.error(new o(t,e))};t.isMapAligned=function(e){switch(e){case"above-along":case"below-along":case"center-along":return 1;default:return 0}};var u=function(y){function o(e,t,r){var o=y.call(this,e,t.symbol)||this;o.geometryType=D.WGLGeometryType.LABEL,o._refTemplate=x;var a,i,s,n,h,l,u=t.symbol,p=(i=r,s=!!(a=t).minScale&&i.scaleToZoom(a.minScale)||0,S.clamp(s,0,25.5)),f=(h=r,l=!!(n=t).maxScale&&h.scaleToZoom(n.maxScale)||255,S.clamp(l,0,25.5)),c=function(e){switch(e){case"above-left":return[-1,-1];case"above-center":case"above-along":return[0,-1];case"above-right":return[1,-1];case"center-left":return[-1,0];case"center-center":case"center-along":return[0,0];case"center-right":return[1,0];case"below-left":return[-1,1];case"below-center":case"below-along":return[0,1];case"below-right":return[1,1];case"always-horizontal":return[0,0];default:T("Found invalid placement type "+e)}}(t.labelPlacement),m=c[0],_=c[1];o._justify=(-1*m+1)/2,o._xAlignD=m,o._yAlignD=_,o._xPlacementD=m,o._yPlacementD=_,o._minZoom=p,o._maxZoom=f;var d=z.LabelMaterialKey.load(z.createMaterialKey(o.geometryType,e,!1,t));d.sdf=!0,o._materialKey=d.data;var v=u.font.decoration.toLowerCase();return"underline"===v?o._decorationTop=6:"line-through"===v&&(o._decorationTop=-5),o}return r(o,y),o.fromLabelClass=function(e,t,r){return new o(e,t,r)},o.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||n.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=n.getBox(o)},o.prototype._computeShaping=function(e,t){return new n([e],O.TEXT_MAX_WIDTH,O.TEXT_LINE_HEIGHT,O.TEXT_SPACING,[0,0],.5,.5,t)},Object.defineProperty(o.prototype,"bounds",{get:function(){return this._bounds},enumerable:!0,configurable:!0}),o.prototype.bindReferenceTemplate=function(e){this._refTemplate=e||x},o.prototype._placeGlyphs=function(e,t,r,o){var a=this._size,i=this._haloSize,s=this._shapedBox,n=this._shapedGlyphs,h=this._computeGlyphTransform(s);if("esriGeometryPolyline"===e)for(var l=0;l<r.length;l++){T=r[l];for(var u=this._shapedBox.width*this._scale,p=function(e){return!(e%2)},f=T.order,c=f-(f-1)/2-1,m=c-(c-1)/2-1,_=m-(m-1)/2-1,d=-1===f?0:p(f)?o-.1:p(c)?o-1.1:p(m)?o-2.1:p(_)?o-3.1:0,v=Math.max(o+S.log2((u+48)/T.pathLen),Math.max(d,this._minZoom)),y=0,g=n;y<g.length;y++){M=g[y];T.place(M,e,t,h,this._materialKey,a,i,s,o,v,this._maxZoom)}}else for(var b=0,x=r;b<x.length;b++)for(var T=x[b],w=0,L=n;w<L.length;w++){var M=L[w];T.place(M,e,t,h,this._materialKey,a,i,s,o,this._minZoom,this._maxZoom)}},o.prototype.writeMesh=function(u,p,e,f,t,r,c,m,o,a){var _=this,i=this._computeAnchors(e,t),d=E.i8888to32(0,0,0,this._bitset);if(i.length&&this._shapedGlyphs.length){this._placeGlyphs(e,t,i,o);var v=z.LabelMaterialKey.load(this._materialKey);if("esriGeometryPolyline"!==e){var s=i[0],n=this._shapedBox,h=this._computeGlyphTransform(n),l=this._createBounds(this._shapedBox,h),y=s.glyphs.get(0),g=y[0],b=g.anchorX,x=g.anchorY,T=Math.floor(10*g.minZoom),w=Math.floor(10*g.maxZoom),L=u.length;y.forEach(function(e){e.minZoom=25.5,e.maxZoom=25.5}),this._writeVertices(u,p,f,c,y,m,v,d,T,w);var M={from:L,count:u.length-L},S=new Z.default(f,M,b,x,T),P=Math.max(this._refTemplate.height,this._refTemplate.width);return v.vvSizeFieldStops||v.vvSizeMinMaxValue||v.vvSizeScaleStops||v.vvSizeUnitValue?S.setVV(E.toFloat32(c[D.VVType.SIZE]),P,this._xPlacementD,this._yPlacementD):(S.offsetX=(P/2+O.COLLISION_PLACEMENT_PADDING)*this._xPlacementD,S.offsetY=(P/2+O.COLLISION_PLACEMENT_PADDING)*this._yPlacementD),S.bounds=l,a.push(S),void s.clear()}for(var G=function(e){var s=i[e],n=s.x,h=s.y,t=u.length,l=new Z.default(f,{from:t,count:-1},n,h,25.5);s.glyphs.forEach(function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];if(o.minZoom=Math.max(s.minZoom,o.minZoom),o.bounds){var a=o.anchorX-n,i=o.anchorY-h;o.bounds.center[0]+=a,o.bounds.center[1]+=i,l.add(o.bounds)}}l.bounds&&_._writeHalos(u,p,f,c,e,m,v,d)}),s.glyphs.forEach(function(e){l.bounds&&_._writeText(u,p,f,c,e,m,v,d)}),l.range.count=u.length-t,l.bounds&&a.push(l),s.clear()},A=0;A<i.length;A++)G(A);this._computedGlyphs=[]}},o.prototype._outsideTile=function(e,t){return e<0||512<=e||t<0||512<=t},o.prototype._smoothVertices=function(e,t){if(!(t<=0)){var r=e.length;if(!(r<3)){var o=[],a=0;o.push(0);for(var i=1;i<r;i++)a+=L.dist(e[i],e[i-1]),o.push(a);t=Math.min(t,.2*a);var s=[];s.push(e[0][0]),s.push(e[0][1]);var n=e[r-1][0],h=e[r-1][1],l=L.sub([0,0],e[0],e[1]);L.normalize(l),e[0][0]+=t*l[0],e[0][1]+=t*l[1],L.sub(l,e[r-1],e[r-2]),L.normalize(l),e[r-1][0]+=t*l[0],e[r-1][1]+=t*l[1];for(i=1;i<r;i++)o[i]+=t;o[r-1]+=t;var u=.5*t;for(i=1;i<r-1;i++){for(var p=0,f=0,c=0,m=i-1;0<=m&&!(o[m+1]<o[i]-u);m--){var _=u+o[m+1]-o[i],d=o[m+1]-o[m],v=o[i]-o[m]<u?1:_/d;if(Math.abs(v)<1e-6)break;var y=v*_-.5*(w=v*v)*d,g=v*d/t,b=e[m+1],x=e[m][0]-b[0],T=e[m][1]-b[1];p+=g/y*(b[0]*v*_+.5*w*(_*x-d*b[0])-w*v*d*x/3),f+=g/y*(b[1]*v*_+.5*w*(_*T-d*b[1])-w*v*d*T/3),c+=g}for(m=i+1;m<r&&!(o[m-1]>o[i]+u);m++){_=u-o[m-1]+o[i],d=o[m]-o[m-1],v=o[m]-o[i]<u?1:_/d;if(Math.abs(v)<1e-6)break;var w;y=v*_-.5*(w=v*v)*d,g=v*d/t,b=e[m-1],x=e[m][0]-b[0],T=e[m][1]-b[1];p+=g/y*(b[0]*v*_+.5*w*(_*x-d*b[0])-w*v*d*x/3),f+=g/y*(b[1]*v*_+.5*w*(_*T-d*b[1])-w*v*d*T/3),c+=g}s.push(p/c),s.push(f/c)}s.push(n),s.push(h);for(i=0,m=0;i<r;i++)e[i][0]=s[m++],e[i][1]=s[m++]}}},o.prototype._computeLineAnchors=function(e,t,r){for(var o=t.paths,a=this._scale*this._shapedBox.width,i=a/2+r,s=a/2+16,n=this._shapedBox.width*this._scale,h=0;h<o.length;h++){var l=o[h],u=[];u.push(l[0]);for(var p=1;p<l.length;p++){var f=u[p-1],c=f[0],m=f[1];c+=l[p][0],m+=l[p][1],u.push([c,m])}this._smoothVertices(u,n);var _=[];_.push(u[0]);for(var d=1;d<u.length;d++){var v=u[d-1],y=v[0],g=v[1],b=u[d],x=b[0],T=b[1],w=Math.round(x-y),L=Math.round(T-g);_.push([w,L])}l=o[h]=_;var M=this._getPathLength(l);if(!(M<2*s))for(var S=M/2,P=0,G=l[0][0],A=l[0][1],O=1;O<l.length;O++){w=l[O][0],L=l[O][1];var D=Math.sqrt(w*w+L*L);if(0<=(P+=D)-S){var E=P-S,Z=D-E,z=Z/D,I=G+w*z,V=A+L*z;if(!this._outsideTile(I,V)){var N=new pe.default(I,V,z,h,O,G,A,D,M,-1);e.push(N)}var B=-1,C=0;for(C=Z-i;0<=C;C-=i){var K=C/D,U=G+w*K,F=A+L*K;if(B++,!this._outsideTile(U,F)){N=new pe.default(U,F,K,h,O,G,A,D,M,B);e.push(N)}}P=C+i;for(var R=D-E,X=G,q=A,H=O-1;0!==H;H--){var j=l[H][0],k=l[H][1],W=Math.sqrt(j*j+k*k);if(i<=P+W){for(var Y=i-P;Y<W;Y+=i){var J=Y/W,Q=X-j*J,$=q-k*J;if(B++,Y+R+s<S&&!this._outsideTile(Q,$)){N=new pe.default(Q,$,1-J,h,H,X-j,q-k,W,M,B);e.push(N)}}P=W-(Y-i)}else P+=W;R+=W,X-=j,q-=k}var ee=-1;for(C=Z+i;C<=D;C+=i){var te=C/D,re=G+w*te,oe=A+L*te;if(ee++,!this._outsideTile(re,oe)){N=new pe.default(re,oe,te,h,O,G,A,D,M,ee);e.push(N)}}X=G+w,q=A+L,P=D-(C-i),R=E;for(H=O+1;H<l.length;H++){var ae=l[H][0],ie=l[H][1],se=Math.sqrt(ae*ae+ie*ie);if(i<=P+se){for(var ne=i-P;ne<se;ne+=i){var he=ne/se,le=X+ae*he,ue=q+ie*he;if(ee++,ne+R+s<S&&!this._outsideTile(le,ue)){N=new pe.default(le,ue,he,h,H,X,q,se,M,ee);e.push(N)}}P=se-(ne-i)}else P+=se;R+=se,X+=ae,q+=ie}break}G+=w,A+=L}}return e},o.prototype._computeAnchors=function(e,t){var r=[];switch(e){case"esriGeometryPoint":var o=t.geometry,a=o.x,i=o.y,s=new pe.default(a,i);return r.push(s),r;case"esriGeometryPolygon":if(t.centroid){var n=t.centroid;a=n.x,i=n.y,s=new pe.default(a,i);return r.push(s),r}T("Non-centroid polygon anchor placement not supported");break;case"esriGeometryPolyline":return this._computeLineAnchors(r,t.geometry,376);case"esriGeometryMultipoint":default:return T("Unable to handle geometryType: "+e),r}},o.prototype._getPathLength=function(e){for(var t=0,r=1;r<e.length;r++){var o=e[r][0],a=e[r][1];t+=Math.sqrt(o*o+a*a)}return t},o.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*d.C_DEG_TO_RAD,o=e.x,a=e.y,i=e.width/2,s=e.height/2,n=o+i,h=a+s,l=this._xAlignD*(i*t),u=this._yAlignD*(s*t),p=l+(this._xOffset+this._refTemplate.xOffset)+n,f=u-(this._yOffset+this._refTemplate.yOffset)-h,c=m.mat2d.identity(b);return m.mat2d.translate(c,c,_.vec2.set(g,p,f)),m.mat2d.scale(c,c,_.vec2.set(g,t,t)),m.mat2d.rotate(c,c,r),c},o.prototype._writeVertex=function(e,t,r,o,a,i,s,n,h,l){var u=t.get("geometry"),p=t.get("visibility"),f=t.get("visibilityRange"),c=n&&n[D.VVType.SIZE]||1,m=Math.min(Math.floor(Math.max(this._refTemplate.width,this._refTemplate.height)),255),_=this._xPlacementD+1,d=this._yPlacementD+1;this._refSymbolAndPlacementOffset=E.i8888to32(i.angle,m,_,d),u.push(o),u.push(a),u.push(i.vertexOffsetUpperLeft),u.push(i.texFontSizeUpperLeft),u.push(this._refSymbolAndPlacementOffset),u.push(c),p.push(h),u.push(o),u.push(a),u.push(i.vertexOffsetUpperRight),u.push(i.texFontSizeUpperRight),u.push(this._refSymbolAndPlacementOffset),u.push(c),p.push(h),u.push(o),u.push(a),u.push(i.vertexOffsetLowerLeft),u.push(i.texFontSizeLowerLeft),u.push(this._refSymbolAndPlacementOffset),u.push(c),p.push(h),u.push(o),u.push(a),u.push(i.vertexOffsetLowerRight),u.push(i.texFontSizeLowerRight),u.push(this._refSymbolAndPlacementOffset),u.push(c),p.push(h),f.push(v),f.push(v),e.vertexCount+=4},o}(h.default);t.default=u});