// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../Color","../../../../core/Logger","../../../../geometry/support/jsonUtils","../cim/CIMCursor","../cim/CIMEffects","../cim/CIMOperators","./CIMSymbolDrawHelper","./SDFHelper","../../../vectorTiles/GeometryUtils"],function(e,r,t,a,p,u,v,n,h,I,S){Object.defineProperty(r,"__esModule",{value:!0});var s=a.getLogger("esri/views/2d/engine/webgl/CIMSymbolHelper"),i=function(){function y(){}return y.getEnvelope=function(e){if("CIMPointSymbol"!==e.type)return null;var r=new h.EnvDrawHelper;return r.drawSymbol(e,{type:"point",x:0,y:0}),r.envelope()},y.rasterize=function(e,r){var a=this.getEnvelope(r);if(!a||a.width<=0||a.height<=0)return[null,0,0,0,0];var t=96/72,i=(a.x+.5*a.width)*t,o=-(a.y+.5*a.height)*t;e.width=a.width*t+2,e.height=a.height*t+2;var s=e.getContext("2d"),n=h.Transformation.createScale(t,-t);n.translate(.5*e.width-i,.5*e.height-o);new h.CanvasDrawHelper(s,n).drawSymbol(r,{type:"point",x:0,y:0});for(var l,c=s.getImageData(0,0,e.width,e.height),f=new Uint8Array(c.data),m=0;m<f.length;m+=4)l=f[m+3]/255,f[m]=f[m]*l,f[m+1]=f[m+1]*l,f[m+2]=f[m+2]*l;return[f,e.width,e.height,i/e.width,o/e.height]},y.fromSimpleMarker=function(e){var r,a,t,i=50,o=e.style;if("circle"===o||"esriSMSCircle"===o){var s=Math.acos(.995),n=Math.ceil(S.C_PI/s/4);0===n&&(n=1),s=S.C_PI_BY_2/n,n*=4;var l=[];l.push([i,0]);for(var c=1;c<n;c++)l.push([i*Math.cos(c*s),-i*Math.sin(c*s)]);l.push([i,0]),r={rings:[l]},a={xmin:-i,ymin:-i,xmax:i,ymax:i}}else if("cross"===o||"esriSMSCross"===o){r={rings:[[[f=0,i],[f,f],[i,f],[i,-f],[f,-f],[f,-i],[-f,-i],[-f,-f],[-i,-f],[-i,f],[-f,f],[-f,i],[f,i]]]},a={xmin:-i,ymin:-i,xmax:i,ymax:i}}else if("diamond"===o||"esriSMSDiamond"===o)r={rings:[[[-i,0],[0,i],[i,0],[0,-i],[-i,0]]]},a={xmin:-i,ymin:-i,xmax:i,ymax:i};else if("square"===o||"esriSMSSquare"===o)r={rings:[[[-i,-i],[-i,i],[i,i],[i,-i],[-i,-i]]]},a={xmin:-i,ymin:-i,xmax:i,ymax:i};else if("x"===o||"esriSMSX"===o){var f;r={rings:[[[0,f=0],[i-f,i],[i,i-f],[f,0],[i,f-i],[i-f,-i],[0,-f],[f-i,-i],[-i,f-i],[-f,0],[-i,i-f],[f-i,i],[0,f]]]},a={xmin:-i,ymin:-i,xmax:i,ymax:i}}else if("triangle"===o||"esriSMSTriangle"===o){var m=57.735026918962575,h=-m,y=2/3*100,p=y-100;r={rings:[[[h,p],[0,y],[m,p],[h,p]]]},a={xmin:h,ymin:p,xmax:m,ymax:y}}if(r&&a){var u=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&u.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});var v={type:"CIMPolygonSymbol",symbolLayers:u};t={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:a,markerGraphics:[{type:"CIMMarkerGraphic",geometry:r,symbol:v}]}]}}return t},y.getFillColor=function(e){if(!e)return null;switch(e.type){case"CIMPolygonSymbol":if(e.symbolLayers)for(var r=0,a=e.symbolLayers;r<a.length;r++){var t=a[r],i=y.getFillColor(t);if(null!=i)return i}break;case"CIMSolidFill":return e.color}},y.getStrokeColor=function(e){if(e)switch(e.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(e.symbolLayers)for(var r=0,a=e.symbolLayers;r<a.length;r++){var t=a[r],i=y.getStrokeColor(t);if(void 0!==i)return i}break;case"CIMSolidStroke":return e.color}},y.getStrokeWidth=function(e){if(e)switch(e.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(e.symbolLayers)for(var r=0,a=e.symbolLayers;r<a.length;r++){var t=a[r],i=y.getStrokeWidth(t);if(void 0!==i)return i}break;case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return e.width}},y.getSize=function(e){if(e)switch(e.type){case"CIMPointSymbol":var r=0;if(e.symbolLayers)for(var a=0,t=e.symbolLayers;a<t.length;a++){var i=t[a],o=y.getSize(i);r<o&&(r=o)}return r;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return e.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return e.size}},y.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){var r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},y.executeEffects=function(e,r,a){void 0===a&&(a=!1);var t=e?e.length:0;t&&a&&--t;for(var i=0;i<t;++i){var o=e[i];if(o){var s=n.getEffectOperator(o);s&&(r=s.execute(r,o,96/72))}}return r},y.processEffects=function(e,r,a){var t;if(e.effects&&0<e.effects.length){var i=u.deltaEncodeGeometry(a);t=new v.SimpleGeometryCursor(i),t=y.executeEffects(e.effects,t)}var o=e.symbolLayers[r];if(o.effects&&0<o.effects.length){var s=!1;if("CIMGeometricEffectDashes"===o.effects[o.effects.length-1].type&&(s=!0),!t){i=u.deltaEncodeGeometry(a);t=new v.SimpleGeometryCursor(i)}t=y.executeEffects(o.effects,t,s)}if(!t)return a;for(var n=[],l=t.next();l;)n.push(l),l=t.next();var c=n.length;switch(c){case 0:return null;case 1:return u.deltaEncodeGeometry(n[0]);default:for(var f=n[0],m=1;m<c;++m){var h=n[m];p.isPolygon(f)&&p.isPolygon(h)&&Array.prototype.push.apply(f.rings,h.rings),p.isPolyline(f)&&p.isPolyline(h)&&Array.prototype.push.apply(f.paths,h.paths)}return u.deltaEncodeGeometry(f)}},y}();r.CIMSymbolHelper=i;var o=function(){function e(){}return e.rasterizeSimpleFill=function(e,r){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");e.width=8,e.height=8;var a=e.getContext("2d");a.strokeStyle="#FFFFFF",a.lineWidth=1,a.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(a.moveTo(0,0),a.lineTo(0,8)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(a.moveTo(0,0),a.lineTo(8,0)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(a.moveTo(0,0),a.lineTo(8,8)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(a.moveTo(8,0),a.lineTo(0,8)),a.stroke();for(var t,i=a.getImageData(0,0,e.width,e.height),o=new Uint8Array(i.data),s=0;s<o.length;s+=4)t=o[s+3]/255,o[s]=o[s]*t,o[s+1]=o[s+1]*t,o[s+2]=o[s+2]*t;return[o,e.width,e.height]},e.rasterizeSimpleLine=function(e,r,a){var t;switch(a){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}var i,o="Butt"===t;switch(r){case"dash":case"esriSLSDash":i=o?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":i=o?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":i=o?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":i=o?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":i=o?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":i=o?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":i=o?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":i=o?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":i=o?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":i=o?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":s.error("Unexpected: style does not require rasterization"),i=[0,0];break;default:s.error("Tried to rasterize SLS, but found an unexpected style: "+r+"!"),i=[0,0]}return this.rasterizeDash(e,i,t)},e.rasterizeDash=function(e,r,a){for(var t="Butt"===a,i="Square"===a,o=!t&&!i,s=0,n=0,l=r;n<l.length;n++){s+=l[n]}for(var c=15*s,f=31*c,m=new Float32Array(f),h=o?225:15,y=0;y<f;++y)m[y]=h;for(var p=0,u=0,v=!0,S=0,d=r;S<d.length;S++){p=u,u+=15*d[S];for(var g=p;g<u;){for(var M=0;M<31;){y=M*c+g;var b=o?(M-15)*(M-15):Math.abs(M-15);m[y]=v?t?Math.max(Math.max(p+7.5-g,b),Math.max(g-u+7.5,b)):b:o?Math.min((g-p)*(g-p)+b,(g-u)*(g-u)+b):i?Math.min(Math.max(g-p,b),Math.max(u-g,b)):Math.min(Math.max(g-p+7.5,b),Math.max(u+7.5-g,b)),M++}g++}v=!v}var C=m.length,k=new Uint8Array(4*C);for(y=0;y<C;++y){var x=(o?Math.sqrt(m[y]):m[y])/15;I.packFloat(x,k,4*y)}return[k,c,31]},e}();r.SymbolHelper=o;var l=function(){function b(){}return b.findApplicableOverrides=function(e,r,a){if(r){if(e.primitiveName)for(var t=0,i=r;t<i.length;t++){var o=i[t];if(o.primitiveName===e.primitiveName){for(var s=!1,n=0,l=a;n<l.length;n++){l[n].primitiveName===e.primitiveName&&(s=!0)}s||a.push(o)}}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(var c=0,f=e.effects;c<f.length;c++){var m=f[c];b.findApplicableOverrides(m,r,a)}if(e.symbolLayers)for(var h=0,y=e.symbolLayers;h<y.length;h++){var p=y[h];b.findApplicableOverrides(p,r,a)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(e.effects)for(var u=0,v=e.effects;u<v.length;u++){m=v[u];b.findApplicableOverrides(m,r,a)}if("CIMVectorMarker"===e.type&&e.markerGraphics)for(var S=0,d=e.markerGraphics;S<d.length;S++){var g=d[S];b.findApplicableOverrides(g,r,a),b.findApplicableOverrides(g.symbol,r,a)}}}},b.applyOverrides=function(e,r,a,t){if(r){if(e.primitiveName)for(var i=0,o=r;i<o.length;i++){var s=o[i];if(s.primitiveName===e.primitiveName){if(t&&t.push({cim:e,propertyName:s.propertyName,value:e[s.propertyName]}),s.expression&&(s.value=b.toValue(s.propertyName,s.expression)),a){for(var n=!1,l=0,c=a;l<c.length;l++){c[l].primitiveName===e.primitiveName&&(n=!0)}n||a.push(s)}e[s.propertyName]=s.value}}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(var f=0,m=e.effects;f<m.length;f++){var h=m[f];b.applyOverrides(h,r,a,t)}if(e.symbolLayers)for(var y=0,p=e.symbolLayers;y<p.length;y++){var u=p[y];b.applyOverrides(u,r,a,t)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(e.effects)for(var v=0,S=e.effects;v<S.length;v++){h=S[v];b.applyOverrides(h,r,a,t)}if("CIMVectorMarker"===e.type&&e.markerGraphics)for(var d=0,g=e.markerGraphics;d<g.length;d++){var M=g[d];b.applyOverrides(M,r,a,t),b.applyOverrides(M.symbol,r,a,t)}}}},b.restoreOverrides=function(e){for(var r=0,a=e;r<a.length;r++){var t=a[r];t.cim[t.propertyName]=t.value}},b.getOverride=function(e,r,a){if(r&&0!==r.length)for(var t=0,i=e;t<i.length;t++){var o=i[t];if(o.primitiveName===r&&o.propertyName===a)return b.toValue(a,o.value)}},b.buildOverrideKey=function(e){return JSON.stringify(e.map(function(e){return{P:e.primitiveName,F:e.propertyName,V:e.value}}))},b.toValue=function(e,r){if("dashTemplate"===e)return r.split(" ").map(function(e){return Number(e)});if("color"!==e)return r;var a=new t(r).toRgba();return a[3]*=255,a},b}();r.OverrideHelper=l});