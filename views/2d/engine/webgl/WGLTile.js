// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./Fader","./number","./Utils","./WGLBuffers","./WGLDisplayList","../../tiling/TileKey"],function(t,e,a,s,l,o,d,n,p,i,y,h,f,m,c,_,I,u,v,g){function D(t,e){return t.sortKey-e.sortKey}var U=new Set;return function(r){function t(t,e,a){void 0===a&&(a=!1);var i=r.call(this)||this;return i._data=null,i.hlDisplayList=null,i._displayList=null,i._wglBuffers=null,i._dirtyMap=new h.default,i.coords=[0,0],i.bounds=[0,0,0,0],i.dvsMat3=d.mat3f32.create(),i.tileMat3=d.mat3f32.create(),i.labelMat2d=l.mat2df32.create(),i._labelIndex=null,i._dirty=!0,i.fader=new c.default,i.key=g.pool.acquire(t),i.coords[0]=e[0],i.coords[1]=e[3],i.bounds=e,i._ensureCorrectZOrder=a,i}return a(t,r),Object.defineProperty(t.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty},set:function(t){(this._dirty=t)||this.isReady||this.ready(),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),t.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},t.prototype.getDisplayList=function(t){switch(t){case m.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}},Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),t.prototype.setData=function(t,e,a){var i=t.addOrUpdate,r=t.remove;if(this.fader.reset(),(t.clear||!this.hasData)&&!t.addOrUpdate)return this.clear(),void this.ready();!t.clear&&this.hasData||!t.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:i,remove:r},e,a):(i.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new h.default,this._dispRecStore=f.default.fromTileData(i,this._dirtyMap),this._data=i,this._readyTileIfNoLabels(e,a),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=i.tileDisplayData.displayList.clone()))},t.prototype.commitChanges=function(t){this.isDirty&&this._wglBuffers||(this._wglBuffers||(this._wglBuffers=new u.default(this.stage.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},t.prototype.resetVisibility=function(t){var e=this,a=new Array(0),i=new Array(1);t.forEach(function(t){i[0]=t,e.setFilterFlag(0,a,i)})},t.prototype.setFilterFlag=function(t,e,a){if(this.hasData){for(var i=1<<t,r=this._data.tileBufferData.geometries.map(I.geometryToMappedGeometry),s=0,l=e;s<l.length;s++){var o=l[s];if(u=this._data.tileDisplayData.displayObjectRegistry.get(o)){u.setFilterFlag(t,!0);for(var d=0,n=u.displayRecords;d<n.length;d++){if(D=(b=r[(g=n[d]).geometryType]).geometry.vertexBuffer[I.C_VBO_VISIBILITY]){b.vertexFrom=null==b.vertexFrom?g.vertexFrom:Math.min(b.vertexFrom,g.vertexFrom),b.vertexTo=null==b.vertexTo?g.vertexFrom+g.vertexCount:Math.max(b.vertexTo,g.vertexFrom+g.vertexCount);for(var p=g.vertexFrom,y=g.vertexCount,h=0;h<y;++h)D.data[p+h]|=i}}}}for(var f=0,c=a;f<c.length;f++){var u,v=c[f];if(u=this._data.tileDisplayData.displayObjectRegistry.get(v)){u.setFilterFlag(t,!1);for(var m=0,_=u.displayRecords;m<_.length;m++){var g,D;if(D=(b=r[(g=_[m]).geometryType]).geometry.vertexBuffer[I.C_VBO_VISIBILITY]){b.vertexFrom=null==b.vertexFrom?g.vertexFrom:Math.min(b.vertexFrom,g.vertexFrom),b.vertexTo=null==b.vertexTo?g.vertexFrom+g.vertexCount:Math.max(b.vertexTo,g.vertexFrom+g.vertexCount);for(p=g.vertexFrom,y=g.vertexCount,h=0;h<y;++h)D.data[p+h]&=~i}}}}for(var x=!1,L=0;L<r.length;++L){var b;if(null!=(b=r[L]).vertexFrom&&null!=b.vertexTo){var R=b.vertexTo?b.vertexTo-b.vertexFrom:0;this._dirtyMap.markDirtyVertices(L,I.C_VBO_VISIBILITY,b.vertexFrom,R),x=!0}}x&&this.requestRender()}},t.prototype.setVisibilityRange=function(t,e,a,i){for(var r=this._data.tileDisplayData.displayObjectRegistry.get(t),s=this._data.tileBufferData.geometries[m.WGLGeometryType.LABEL].vertexBuffer[I.C_VBO_VISIBILITY_RANGE],l=1/0,o=0,d=e;d<e+a;++d){for(var n=r.displayRecords[d],p=Math.max(n.minZoom,i),y=n.maxZoom,h=_.i8888to32(p,y,p,y),f=n.vertexFrom*s.stride/4,c=n.vertexCount*s.stride/4,u=f;u<f+c;++u)s.data[u]=h;l=Math.min(l,n.vertexFrom),o=Math.max(o,n.vertexFrom+n.vertexCount)}var v=o-l;this._dirtyMap.markDirtyVertices(m.WGLGeometryType.LABEL,I.C_VBO_VISIBILITY_RANGE,l,v)},t.prototype.setTransform=function(t,e){var a=this.tileMat3,i=t.toScreenNoRotation([0,0],this.coords),r=i[0],s=i[1],l=e;o.mat3.set(this.tileMat3,l,0,0,0,l,0,r,s,1),o.mat3.multiply(this.dvsMat3,t.displayViewMat3,a)},t.prototype.setLabelTransform=function(t,e){var a=this.labelMat2d,i=t.getScreenTransform(a,e),r=p.vec2f32.create();n.vec2.transformMat2d(r,this.coords,i),s.mat2d.identity(a),s.mat2d.translate(a,a,r),s.mat2d.multiply(a,t.viewMat2d,a)},t.prototype.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},t.prototype.attach=function(){return!0},t.prototype.dispose=function(){this.clear()},t.prototype.doRender=function(t){if(this.isReady&&this.hasData){if(this.commitChanges(t),this.stage.context.setStencilFunction(514,this.stencilRef,255),t.drawPhase===m.WGLDrawPhase.MAP||t.drawPhase===m.WGLDrawPhase.LABEL||t.drawPhase===m.WGLDrawPhase.LABEL_ALPHA)this._displayList.replay(t,this);else for(var e=0,a=this.stage.painter.getBrushes(t.drawPhase);e<a.length;e++){a[e].draw(t,this)}this.fader.step()||this.requestRender()}},t.prototype.buildHLList=function(t){var e=this;this.hlDisplayList=new v;t.forEach(function(t){e._addToHLDisplayList(e.hlDisplayList,t)})},t.prototype._addToHLDisplayList=function(t,e){if(this._data){var a=this._data.tileDisplayData.displayObjectRegistry.get(e);if(a){for(var i=[],r=0,s=a.displayRecords;r<s.length;r++){var l=s[r].copy();l.meshData=null,l.symbolLevel=0,l.zOrder=0,i.push(l)}i.sort(D),t.addToList(i)}}},t.prototype._readyTileIfNoLabels=function(t,e){this.isDirty=!(!t||!e)&&(this._rebuildLabelIndex(),!0)},t.prototype._doPatchData=function(t,e,a){this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=f.default.fromTileData(this._data,this._dirtyMap)),this._readyTileIfNoLabels(e,a),this.requestRender()},t.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++)for(var a=0,i=e[t].metrics;a<i.length;a++){var r=i[a];this._insertIntoLabelIndex(r)}},t.prototype._insertIntoLabelIndex=function(t){-1!==t.xBucket&&this.labelIndex[t.yBucket][t.xBucket].push(t)},t.prototype._initLabelIndex=function(){for(var t=[],e=0;e<y.TILE_SIZE/y.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var a=0;a<y.TILE_SIZE/y.COLLISION_BUCKET_SIZE;a++)t[e].push([])}return t},t.prototype._patchData=function(t){for(var e=!0,a=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],i=(t.remove||[]).slice(),r=0,s=a;r<s.length;r++){null!=(v=s[r]).insertAfter&&i.push(v.id)}for(var l=0,o=i;l<o.length;l++){var d=o[l];if(u=this._data.tileDisplayData.displayObjectRegistry.get(d)){this._data.tileDisplayData.displayList.removeFromList(u.displayRecords);for(var n=0,p=u.displayRecords;n<p.length;n++){var y=p[n];this._dispRecStore.delete(y)}this._data.tileDisplayData.displayObjectRegistry.delete(d);var h=this._data.tileDisplayData.displayObjects.indexOf(u);this._data.tileDisplayData.displayObjects.splice(h,1)}}for(var f=0,c=a;f<c.length;f++){var u,v=c[f],m=void 0;if(u=this._data.tileDisplayData.displayObjectRegistry.get(v.id)){var _=u.displayRecords;u.set(v),u.displayRecords=_;for(var g=u.displayRecords.length,D=0;D<g;++D){var x=u.displayRecords[D],L=v.displayRecords[D];(D>=v.displayRecords.length||x.geometryType!==L.geometryType||x.symbolLevel!==L.symbolLevel||x.zOrder!==L.zOrder||x.materialKey!==L.materialKey)&&(this._dispRecStore.delete(u.displayRecords[D]),D<v.displayRecords.length&&(u.displayRecords[D]=void 0))}u.displayRecords.length=v.displayRecords.length,u.metrics=v.metrics}else{(u=v.copy()).displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(v.id,u);var b=void 0,R=this._data.tileDisplayData.displayObjects;if(null!=u.insertAfter)if(m={},0<=u.insertAfter){var I=this._data.tileDisplayData.displayObjectRegistry.get(u.insertAfter);I&&(b=R.indexOf(I)+1)<R.length?R.splice(b,0,u):(R.push(u),b=R.length)}else R.unshift(u),b=0;else R.push(u),b=R.length;if(m){var O=void 0;if(this._data.tileDisplayData.displayList.unified)O=0<v.displayRecords.length?1:0;else{U.clear();for(var T=0,B=v.displayRecords;T<B.length;T++){var F=B[T],w=this._data.tileDisplayData.displayList.getDPInfoType(F.geometryType);U.add(w)}O=U.size}var M=0;for(D=b-1;0<=D&&M<O;--D)for(var j=R[D].displayRecords.length-1;0<=j&&M<O;--j){var S=R[D].displayRecords[j];m[w=this._data.tileDisplayData.displayList.getDPInfoType(S.geometryType)]||(m[w]=S,++M)}}}var C=v.displayRecords.length;for(D=0;D<C;++D){L=v.displayRecords[D];(x=u.displayRecords[D])?(x.meshData=L.meshData,x.materialKey=L.materialKey):((x=L.copy()).vertexFrom=void 0,x.indexFrom=void 0,u.displayRecords[D]=x);var P=L.geometryType,A=(w=this._data.tileDisplayData.displayList.getDPInfoType(P),t.addOrUpdate.tileBufferData.geometries[P]),E=A.vertexBuffer,G=A.indexBuffer,V=void 0;m&&(V=m[w]?this._data.tileDisplayData.displayList.splitAfter(m[w]):-1),e=this._dispRecStore.setMeshData(x,L,E,G,V)&&e,m&&null!=x.indexFrom&&null!=x.indexFrom&&(m[w]=x)}}return e},t}(i.DisplayObject)});