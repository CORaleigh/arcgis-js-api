// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/promiseUtils","../../../../geometry/Point","../Container","../../engine/webgl/TileData","./enums","./Utils","./WGLRendererInfo"],function(e,t,o,r,h,a,d,u,i,s,p,c,n){Object.defineProperty(t,"__esModule",{value:!0});var l=function(i){function e(e){var t=i.call(this)||this;return t._rendererInfo=new n,t._pointToCallbacks=new Map,t._invisibleFeatures=new Set,t._displayWidth=0,t._displayHeight=0,t.layer=null,t.tileInfoView=e.tileInfoView,t.layer=e.layer,t._layerView=e.layerView,t}return r(e,i),e.prototype.dispose=function(){this.removeAllChildren();for(var e=0,t=this.children;e<t.length;e++){t[e].dispose()}},e.prototype.disposeWebGLResources=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].clear()}},e.prototype.displayWidth=function(){return this._displayWidth},Object.defineProperty(e.prototype,"displayHeight",{get:function(){return this._displayHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},set:function(e){this._visualVariablesInfo=e,this.requestRender()},enumerable:!0,configurable:!0}),e.prototype.hitTest=function(e,t){var i=this,r=[e,t];return a.create(function(e,t){i._pointToCallbacks.set(r,{resolve:e,reject:t}),i.requestRender()},function(){i._pointToCallbacks.has(r)&&i._pointToCallbacks.delete(r)})},e.prototype.setFilterFlag=function(e,t,i,r){if(void 0===r&&(r=!0),r){t||(t=[]),i||(i=[]);for(var a=this._invisibleFeatures,s=0,n=t;s<n.length;s++){var l=n[s];a.has(l)&&a.delete(l)}for(var o=0,h=i;o<h.length;o++){var d=h[o];a.add(d)}for(var u=0,p=this.children;u<p.length;u++){(y=p[u]).data&&y.setFilterFlag(0,t,i)}}else for(var c=0,f=this.children;c<f.length;c++){var y;(y=f[c]).data&&y.setFilterFlag(e,t,i)}},e.prototype.whenAttached=function(){var t=this;return this.attached?a.resolve():a.create(function(e){return t.once("attached",function(){return e()})})},e.prototype.getMaterialItems=function(n){var l=this;return this.whenAttached().then(function(){var e=n;if(l.stage&&e&&0!==e.length){for(var t=[],i=l.stage.painter.textureManager,r=0,a=e;r<a.length;r++){var s=a[r];t.push(i.rasterizeItem(s.symbol,s.glyphIds))}return d.all(t).then(function(e){return e.map(function(e,t){return{id:n[t].id,mosaicItem:e}})})}})},e.prototype.onTileData=function(e,t){var i=!(!this.layer.labelingInfo||!this.layer.labelingInfo.length),r=t.addOrUpdate&&s.decode(t.addOrUpdate),a=o({},t,{addOrUpdate:r});e.setData(a,i,this.layer.labelsVisible),e.resetVisibility(this._invisibleFeatures),e.buildHLList(this._layerView.highlightIDs),this.contains(e)||this.addChild(e),this.requestRender(),this._layerView&&this._layerView.view.labelManager.requestUpdate()},e.prototype.onTileError=function(e){e.clear(),e.buildHLList(this._layerView.highlightIDs),this.contains(e)||this.addChild(e),this.requestRender()},e.prototype.addChild=function(e){var t=i.prototype.addChild.call(this,e);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.addTile(this.layer.uid,e),this._buildHLList(),t},e.prototype.removeChild=function(e){var t=i.prototype.removeChild.call(this,e);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.removeTile(this.layer.uid,e.key.id),this._buildHLList(),t},e.prototype.renderChildren=function(e){var i=this,t=this.stage.painter;this._updateTilesTransform(e.state,this.tileInfoView.getClosestInfoForScale(e.state.scale).level),this._rendererInfo.update(e.state,this.layer.renderer,this._visualVariablesInfo.vvRanges,this._layerView.effects);var r=this.tileInfoView.getClosestInfoForScale(e.state.scale).level,a=this.tileInfoView.tileInfo.scaleToZoom(e.state.scale),s=o({},e,{rendererInfo:this._rendererInfo,requiredLevel:r,displayLevel:a,context:this.stage.context,painter:this.stage.painter});this.sortChildren(function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col});var n=s.drawPhase;if(n&(p.WGLDrawPhase.LABEL|p.WGLDrawPhase.LABEL_ALPHA)){var l=this.layer;if(!(l.labelsVisible&&l.labelingInfo&&0<l.labelingInfo.length))return;this._updateTilesTransform(s.state,s.requiredLevel)}t.draw(s,this.children,n,this._painterOptions),0<this._layerView.highlightIDs.size&&t.highlight(s,this.children),this._pointToCallbacks.forEach(function(e,t){e.resolve(i._hitTest(s,t[0],t[1]))}),this._pointToCallbacks.clear(),this._layerView.effects&&this._layerView.effects.some(function(e){return h.isSome(e)&&!e.done})&&this.requestRender()},e.prototype.updateHighlight=function(){this._buildHLList()},e.prototype._hitTest=function(e,t,i){var r=this.stage,a=r.painter,s=r.context,n=e.requiredLevel,l=[0,0];e.state.toMap(l,[t,i]);var o=e.state.clone(),h=o.viewpoint.clone();return h.targetGeometry=new u(l[0],l[1],e.state.spatialReference),o.viewpoint=h,o.size=[c.C_HITTEST_SEARCH_SIZE,c.C_HITTEST_SEARCH_SIZE],this._updateTilesTransform(o,n),a.hitTest({globalOpacity:1,painter:a,context:s,drawPhase:p.WGLDrawPhase.HITTEST,pixelRatio:e.pixelRatio,displayLevel:e.displayLevel,rendererInfo:this._rendererInfo,requiredLevel:n,state:o,stationary:e.stationary},this.children)},e.prototype._updateTilesTransform=function(e,t){for(var i=0,r=this.children;i<r.length;i++){var a=r[i],s=this.tileInfoView.tileInfo.lods[a.key.level].resolution,n=s/(e.resolution*e.pixelRatio);a.setTransform(e,n),a.setLabelTransform(e,s)}},e.prototype._buildHLList=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].buildHLList(this._layerView.highlightIDs)}this.requestRender()},e}(i.Container);t.default=l});