// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../geometry","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat2d","../../../core/libs/gl-matrix-2/mat2df64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Circle","../../../geometry/geometryEngine","../../../geometry/support/coordsUtils","../../../geometry/support/spatialReferenceUtils"],function(e,r,t,a,n,o,i,l,s,c,f,u,p,y,m,x){function d(e,r){return[e,r]}function h(e,r){return{x:e,y:r}}function v(e,r){return"2d"===e.type?new L(e.state.transform,e.spatialReference):"3d"===e.type?new z(e,new n.Point({x:r[0],y:r[1],spatialReference:e.spatialReference})):null}function g(e,r){return new n.Point({x:e[0],y:e[1],spatialReference:r})}function M(e,r){return new n.Multipoint({points:e,spatialReference:r})}function R(e,r,t){var a=new n.Polyline({paths:e,spatialReference:r});return t&&m.unnormalizeGeometryOnDatelineCrossing(a),a}function w(e,r,t,a){void 0===a&&(a=!0);var o=e.map(function(e){return Array.apply([],e)});o.forEach(function(e,r){e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]||e.push(e[0])});var i=new n.Polygon({rings:o,spatialReference:r});return i.rings.forEach(function(e){i.isClockwise(e)||e.reverse()}),t&&m.unnormalizeGeometryOnDatelineCrossing(i),a&&i.isSelfIntersecting&&x.isValid(r)&&(i=y.simplify(i)),i}function S(e,r,t,a){var n=r.mapToLocalMultiple(e),o=n[0],i=n[1],l=Math.round(i.x-o.x),s=Math.round(i.y-o.y),c=null,f=null,u=null;if(t&&a){var p=Math.sqrt(l*l+s*s);c=h(-C*p+o.x,P*p+o.y),f=h(C*p+o.x,P*p+o.y),u=h(o.x,o.y-p)}else if(t)c=h(s>0?i.x:o.x,o.y+s),f=h(o.x-l,s>0?i.y:o.y-s),u=h(s>0?o.x:i.x,o.y-s);else if(a){var y=Math.max(Math.abs(l),Math.abs(s)),m=y*Math.sqrt(3)/2;c=h(o.x,s>0?o.y+y:o.y),f=h(l>0?o.x+y:o.x-y,s>0?o.y+y:o.y),u=h(l>0?o.x+y/2:o.x-y/2,s>0?o.y+y-m:o.y-m)}else c=h(s>0?o.x+l/2:i.x,o.y),f=h(s>0?o.x:o.x+l/2,i.y),u=h(s>0?i.x:o.x,s>0?i.y:o.y);return w([[c,u,f].map(function(e){return r.localToMap(e)})],r.spatialReference,r.doUnnormalization,!0)}function T(e,r,t){var a=r.mapToLocalMultiple(e),n=[],o={x:a[0].x,y:a[0].y},i={x:a[1].x,y:a[1].y},l=Math.round(i.x-o.x),s=Math.round(i.y-o.y),c=Math.max(Math.abs(l),Math.abs(s));if(t){var f={x:o.x+c,y:o.y+c},u={x:o.x-c,y:o.y-c};n.push(h(f.x,u.y),h(u.x,u.y),h(u.x,f.y),h(f.x,f.y))}else{var p={x:l>0?o.x+c:o.x-c,y:s>0?o.y+c:o.y-c};n.push(h(o.x,o.y),h(p.x,o.y),h(p.x,p.y),h(o.x,p.y))}return w([n.map(function(e){return r.localToMap(e)})],r.spatialReference,r.doUnnormalization,!0)}function W(e,r,t){var a=r.mapToLocalMultiple(e);if(1===a.length){var n=48,o=a[0];a=[h(o.x-n,o.y+n),h(o.x+n,o.y-n),h(o.x+n,o.y-n),h(o.x-n,o.y+n)]}var i=[],l={x:a[0].x,y:a[0].y},s={x:a[1].x,y:a[1].y};if(t){var c=Math.round(s.x-l.x),f=Math.round(s.y-l.y);i.push(h(l.x-c,l.y-f),h(s.x,l.y-f),h(s.x,s.y),h(l.x-c,s.y))}else i.push(h(l.x,l.y),h(s.x,l.y),h(s.x,s.y),h(l.x,s.y));return w([i.map(function(e){return r.localToMap(e)})],r.spatialReference,r.doUnnormalization,!0)}function b(e,r,t){var a=r.mapToLocalMultiple(e),i=null,l=null;if(t)i=a[0],l=a[1];else{var s=a[0],c=a[1],f=Math.round(c.x-s.x),u=Math.round(c.y-s.y),x=Math.max(Math.abs(f),Math.abs(u));i=h(f>0?s.x+x/2:s.x-x/2,u>0?s.y+x/2:s.y-x/2),l=h(Math.abs(f)>Math.abs(u)?i.x-x/2:i.x,Math.abs(f)>Math.abs(u)?i.y:i.y-x/2)}var d=r.localToMap(i),v=r.localToMap(l);r.doUnnormalization&&m.unnormalizeVerticesOnDatelineCrossing([[d,v]],r.spatialReference);var g=new n.Point({x:d[0],y:d[1],spatialReference:r.spatialReference}),M=new n.Point({x:v[0],y:v[1],spatialReference:r.spatialReference}),R=o.getMetersPerUnitForSR(r.spatialReference)*y.distance(g,M,null);return new p({center:g,radius:R,radiusUnit:"meters",spatialReference:r.spatialReference})}function F(e,r,t){for(var a=r.mapToLocalMultiple(e),n=a[0],o=a[1],i=Math.round(o.x-n.x),l=Math.round(o.y-n.y),s=h(t?n.x:n.x+i/2,t?n.y:n.y+l/2),c=t?i:i/2,f=t?l:l/2,u=[],p=2*Math.PI/60,y=0;y<60;y++){var m=Math.cos(y*p),x=Math.sin(y*p),d=h(c*m+s.x,f*x+s.y);u.push(d)}return u.push(u[0]),w([u.map(function(e){return r.localToMap(e)})],r.spatialReference,r.doUnnormalization,!1)}Object.defineProperty(r,"__esModule",{value:!0}),r.makeMapPoint=d,r.makeSurfacePoint=h;var C=.8660254037844386,P=.5,U=function(){function e(e){this.spatialReference=e}return e.prototype.mapToLocalMultiple=function(e){var r=this;return e.map(function(e){return r.mapToLocal(e)})},Object.defineProperty(e.prototype,"doUnnormalization",{get:function(){return!1},enumerable:!0,configurable:!0}),e}(),L=function(e){function r(r,t){var a=e.call(this,t)||this;return a.transform=l.mat2df64.create(),a.transformInv=l.mat2df64.create(),a.transform=l.mat2df64.clone(r),i.mat2d.invert(a.transformInv,a.transform),a}return t(r,e),r.prototype.mapToLocal=function(e){return h(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])},r.prototype.localToMap=function(e){return d(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5])},r}(U);r.AffineCoordinateSystem=L;var z=function(e){function r(r,t){var a=e.call(this,r.spatialReference)||this;a.view=r,a.pWS=u.vec3f64.create(),a.tangentFrameUpWS=u.vec3f64.create(),a.tangentFrameRightWS=u.vec3f64.create(),a.tangentFrameForwardWS=u.vec3f64.create(),a.localFrameRightWS=u.vec3f64.create(),a.localFrameUpWS=u.vec3f64.create(),a.worldToLocalTransform=c.quatf64.create(),a.localToWorldTransform=c.quatf64.create(),a.scale=1,a.scale=r.resolution,a.pMS=t;var n=r.state.camera.viewRight;a.view.renderCoordsHelper.toRenderCoords(a.pMS,a.pWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,0,a.tangentFrameRightWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,1,a.tangentFrameUpWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,2,a.tangentFrameForwardWS);var o=u.vec3f64.create();return f.vec3.scale(o,a.tangentFrameForwardWS,f.vec3.dot(n,a.tangentFrameForwardWS)),f.vec3.subtract(a.localFrameRightWS,n,o),f.vec3.normalize(a.localFrameRightWS,a.localFrameRightWS),f.vec3.cross(a.localFrameUpWS,a.tangentFrameForwardWS,a.localFrameRightWS),s.quat.rotationTo(a.worldToLocalTransform,a.localFrameRightWS,a.tangentFrameRightWS),s.quat.invert(a.localToWorldTransform,a.worldToLocalTransform),a}return t(r,e),Object.defineProperty(r.prototype,"doUnnormalization",{get:function(){return"global"===this.view.viewingMode},enumerable:!0,configurable:!0}),r.prototype.mapToLocal=function(e){var r=u.vec3f64.create();this.view.renderCoordsHelper.toRenderCoords(new n.Point({x:e[0],y:e[1],spatialReference:this.spatialReference}),r),f.vec3.transformQuat(r,r,this.worldToLocalTransform);var t=this.view.renderCoordsHelper.fromRenderCoords(r,this.view.spatialReference);return h(t.x/this.scale,t.y/this.scale)},r.prototype.localToMap=function(e){var r=u.vec3f64.create();this.view.renderCoordsHelper.toRenderCoords(new n.Point({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),r),f.vec3.transformQuat(r,r,this.localToWorldTransform);var t=this.view.renderCoordsHelper.fromRenderCoords(r,this.view.spatialReference);return d(t.x,t.y)},r}(U);r.SceneViewCoordinateSystem=z,r.createViewAlignedCoordinateSystem=v,r.createPoint=g,r.createMultipoint=M,r.createPolyline=R,r.createPolygon=w,r.createTriangleMS=S,r.createSquare=T,r.createRectangle=W,r.createCircle=b,r.createEllipse=F});