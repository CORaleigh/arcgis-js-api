// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/decorateHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","../core/Accessor","../core/Collection","../core/Handles","../core/Logger","../core/maybe","../core/screenUtils","../core/watchUtils","../core/accessorSupport/decorators","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/ManipulatorCollection"],function(t,e,o,r,i,n,a,s,l,p,c,u,h,d,v,_,f,g){function m(t){return"touch"!==t}function y(t){return"mouse"!==t.pointerType||0===t.button}function b(t){var e=t.native;return!(!e.ctrlKey&&!e.metaKey)}var T=c.getLogger("esri.views.ToolViewManager");return function(t){function e(e){var o=t.call(this)||this;return o._handles=new p,o._ignorePopupEventId=null,o._ignoreClickEventId=null,o._manipulators=new g,o._stopDrag=!1,o._manipulatorPointerUpEventId=0,o._dragStartScreenPoints=new Map,o._dragPreviousScreenPoints=new Map,o._hoveredManipulators=new Map,o._grabbedManipulators=new Map,o.tools=f.newToolCollection(o),o.cursor=null,o}return r(e,t),e.prototype.initialize=function(){var t=this,e=this.view;this._handles.add(_.eventTypes.map(function(o){return e.on(o,function(e){t._handleInputEvent(e)})}).concat([this.tools.on("change",function(){t._refreshToolCursorWatchers(),t._refreshToolManipulatorWatchers()})]))},e.prototype.destroy=function(){this.tools.forEach(function(t){t.destroy&&t.destroy()}),this._manipulators.destroy(),this._manipulators=null,this._handles.destroy(),this._handles=null},Object.defineProperty(e.prototype,"activeTool",{set:function(t){var e=this;if(u.isSome(t)&&!this.view.ready)return void T.error("#activeTool=","cannot set active tool while view is not ready");f.swap(this,t,function(t){e._set("activeTool",t),e._setManipulatorActive()})},enumerable:!0,configurable:!0}),e.prototype.createTool=function(t,e,o){return n(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return[4,this.view.whenReady()];case 1:return i.sent(),o?[4,this.removeTool(o)]:[3,3];case 2:i.sent(),i.label=3;case 3:return r=new t(a({},e,{view:this.view})),this.tools.add(r),[2,r]}})})},e.prototype.removeTool=function(t){this.tools.remove(t)},e.prototype.attach=function(){var t=this;this.tools.forEach(function(e){e.attach&&e.attach(f.wrapToolViewManager(t,e))})},e.prototype.detach=function(){var t=this;this.tools.forEach(function(e){e.detach&&e.detach(),t.removeToolManipulators(e)})},e.prototype.handlesClickEvent=function(t){return u.isSome(this.activeTool)||t.eventId===this._ignorePopupEventId||u.isSome(this._manipulators.findClosest(h.createScreenPointFromEvent(t),t.pointerType))},e.prototype.addToolManipulator=function(t,e){var o=this;if(!this.tools.includes(t)||!this.view.ready)return void T.error("#addToolManipulator()","cannot add manipulator for tool not attached to view");this._manipulators.add(t,e,this._manipulatorPointerUpEventId),e.installRenderHandles&&e.installRenderHandles(this._handles,function(t){return o._manipulators.forEach(t)})},e.prototype.removeToolManipulator=function(t,e){var o=this,r=this._manipulators.remove(t,e);this._hoveredManipulators.forEach(function(t,e){var i=t.manipulatorId;r===i&&o._hoveredManipulators.delete(e)}),this._grabbedManipulators.forEach(function(t,e){var i=t.manipulatorId;r===i&&(o._grabbedManipulators.delete(e),o._dragStartScreenPoints.delete(e),o._dragPreviousScreenPoints.delete(e))}),this._setToolCursor()},e.prototype.removeToolManipulators=function(t){var e=this;this._manipulators.removeTool(t),this._hoveredManipulators.forEach(function(o,r){var i=o.tool;t===i&&e._hoveredManipulators.delete(r)}),this._grabbedManipulators.forEach(function(o,r){var i=o.tool;t===i&&(e._grabbedManipulators.delete(r),e._dragStartScreenPoints.delete(r),e._dragPreviousScreenPoints.delete(r))}),this._setToolCursor()},e.prototype.attemptManipulatorDragTo=function(t,e,o,r){return!this._manipulators.hasOverlappingInTool(t,e,o.screenPoint)&&(e.attemptDragTo(o,u.isSome(r)?r:{start:o.screenPoint,previous:o.screenPoint}),!0)},e.prototype._handleInputEvent=function(t){var e=this.activeTool;if("pointer-up"===t.type&&(this._manipulatorPointerUpEventId=t.eventId),"click"===t.type&&t.eventId===this._ignoreClickEventId||"double-click"===t.type&&t.eventId===this._ignoreClickEventId+2)return void t.stopPropagation();u.isSome(this.activeTool)?(this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(t),"immediate-click"===t.type&&u.isNone(this.activeTool)&&(this._ignoreClickEventId=t.eventId)):this.tools.forEach(function(e){!1!==e.visible&&e.handleInputEvent&&e.handleInputEvent(t)}),this._handleManipulatorEvent(t)&&(t.stopPropagation(),this._setToolCursor()),u.isSome(e)&&"pointer-up"===t.type&&(this._ignorePopupEventId=t.eventId)},e.prototype._handleManipulatorEvent=function(t){var e=!1;switch(t.type){case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(t.stopPropagation(),"end"===t.action&&(this._stopDrag=!1));break;case"pointer-down":if(!y(t)||b(t))break;var o=h.createScreenPointFromEvent(t),r=this._manipulators.findClosest(o,t.pointerType);if(u.isNone(r))break;var i=this._manipulators.findByKey(r);u.isSome(i)&&i.interactive&&(e=!0,this._grabbedManipulators.set(t.pointerId,r),i.grabbing=!0,this._dragStartScreenPoints.set(t.pointerId,o),this._dragPreviousScreenPoints.set(t.pointerId,o),this.activeTool=r.tool);break;case"pointer-up":if(!y(t))break;var n=this._manipulators.findByKey(this._grabbedManipulators.get(t.pointerId));u.isSome(n)&&(e=!0,n.grabbing=!1,1===this._grabbedManipulators.size&&(this.activeTool=null)),this._grabbedManipulators.delete(t.pointerId),this._dragStartScreenPoints.delete(t.pointerId),this._dragPreviousScreenPoints.delete(t.pointerId);break;case"pointer-drag":if(!y(t))break;var a=this._grabbedManipulators.get(t.pointerId),n=this._manipulators.findByKey(a);if(u.isNone(n))break;var o=h.createScreenPointFromEvent(t);o.x=Math.max(0,Math.min(this.view.width,o.x)),o.y=Math.max(0,Math.min(this.view.height,o.y));var s={start:this._dragStartScreenPoints.get(t.pointerId),previous:this._dragPreviousScreenPoints.get(t.pointerId)};switch(t.action){case"start":case"update":n.dragging=!0,e=this.attemptManipulatorDragTo(a.tool,n,{screenPoint:o},s);break;case"end":n.dragging=!1,e=!0}this._dragPreviousScreenPoints.set(t.pointerId,o);break;case"immediate-click":case"pointer-move":if(!m(t.pointerType))break;var l=this._manipulators.findByKey(this._hoveredManipulators.get(t.pointerId)),p=this._manipulators.findClosest(h.createScreenPointFromEvent(t),t.pointerType),c=this._manipulators.findByKey(p);if(l===c)break;e=!0,u.isSome(l)&&(l.hovering=!1),u.isSome(p)&&u.isSome(c)&&c.interactive?(c.hovering=!0,this._hoveredManipulators.set(t.pointerId,p)):this._hoveredManipulators.delete(t.pointerId);break;case"click":var o=h.createScreenPointFromEvent(t),r=this._manipulators.findClosest(o,t.pointerType,t.eventId),i=this._manipulators.findByKey(r);if(b(t)||this._manipulators.forEach(function(t){t.selected=!1}),u.isNone(i)||!i.interactive)break;i.selectable&&(i.selected=!0),i.click({screenPoint:o,button:t.button}),e=!0}return e},e.prototype._refreshToolCursorWatchers=function(){var t=this;this._handles.remove("cursors"),this._setToolCursor(),this.tools.forEach(function(e){if(e instanceof s){var o=d.watch(e,["cursor","visible"],function(){return t._setToolCursor()});t._handles.add(o,"cursors")}})},e.prototype._setToolCursor=function(){for(var t=null,e=0;e<this.tools.length;e++){var o=this.tools.getItemAt(e);if(null!=o.cursor&&!1!==o.visible){t=o.cursor;break}}!t&&this._grabbedManipulators.size>0&&(t="grabbing"),!t&&this._hoveredManipulators.size>0&&(t="pointer"),this._set("cursor",t)},e.prototype._refreshToolManipulatorWatchers=function(){var t=this;this._handles.remove("manipulators"),this.tools.forEach(function(e){if(e instanceof s){var o=d.watch(e,"visible",function(){return t._setManipulatorActive()},!0);t._handles.add(o,"manipulators")}})},e.prototype._setManipulatorActive=function(){var t=this;this._manipulators.forEach(function(e,o){var r=u.isNone(t.activeTool)||t.activeTool===o;e.active=o.visible&&r})},o([v.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),o([v.property({value:null})],e.prototype,"activeTool",null),o([v.property({readOnly:!0,type:l})],e.prototype,"tools",void 0),o([v.property({readOnly:!0})],e.prototype,"cursor",void 0),e=o([v.subclass("esri.views.ToolViewManager")],e)}(v.declared(s))});