// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","../../core/Accessor","../../core/Collection","../../core/compilerUtils","../../core/maybe","../../core/screenUtils","../../core/accessorSupport/decorators","../../core/libs/gl-matrix-2/mat3","../../core/libs/gl-matrix-2/mat3f64","../../core/libs/gl-matrix-2/mat4","../../core/libs/gl-matrix-2/mat4f64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f32","../../core/libs/gl-matrix-2/vec3","../../core/libs/gl-matrix-2/vec3f64","../../geometry/support/aaBoundingRect","../../layers/graphics/dehydratedFeatures","../3d/support/geometryUtils","../3d/support/stack","../3d/webgl-engine/lib/Intersector","../3d/webgl-engine/lib/intersectorUtils","../3d/webgl-engine/lib/Layer","../3d/webgl-engine/lib/Object3D","../3d/webgl-engine/parts/Model"],function(e,t,r,i,n,o,s,a,c,l,u,p,h,d,f,_,y,g,m,v,b,P,S,O,j,R,T){function A(e){return 0!==e[12]||0!==e[13]||0!==e[14]}Object.defineProperty(t,"__esModule",{value:!0});var M=function(e){function t(t){var r=e.call(this)||this;return r.hideOnGrab=!1,r.moveOnDrag=!0,r.snapToPointer=!0,r.allowOverlap=!1,r.collisionType={type:"point"},r.renderObjects=[],r.autoScaleRenderObjects=!0,r._radius=10,r._focusMultiplier=2,r._touchMultiplier=2.5,r.interactive=!0,r.selectable=!1,r.dragging=!1,r._position=g.vec3f64.create(),r._modelTransform=d.mat4f64.create(),r._dragOffset=null,r._dirtyScreenPoint=c.createScreenPoint(),r._dirtyScreenPointArray=c.createScreenPointArray(),r._dirtyRenderScreenPointArray=c.createRenderScreenPointArray3(),r._dirtyOriginScreenPointArray=c.createScreenPointArray(),r._screenPositionDirty=!0,r._engineResourcesAddedToStage=!1,r._engineResources=null,r._engineLayerId=null,r._materialIdReferences=null,r._hitResult={onSurface:!1,surfaceType:"ground"},r._handlers=new o,r}i(t,e),n=t,t.prototype.initialize=function(){this._intersector=new S(this.view.viewingMode),this._mapPoint=v.makeDehydratedPoint(0,0,0,this.view.spatialReference)},t.prototype.destroy=function(){this._handlers.removeAll(),this._handlers=null,this._removeResourcesFromStage(),this._engineResources=null,this._set("view",null),this._camera=null},Object.defineProperty(t.prototype,"alignment",{get:function(){return this._get("alignment")},set:function(e){this._set("alignment",e),this.constructed&&this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{set:function(e){e!==this._get("visible")&&(this._set("visible",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusMultiplier",{get:function(){return this._focusMultiplier},set:function(e){this._focusMultiplier=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"touchMultiplier",{get:function(){return this._touchMultiplier},set:function(e){this._touchMultiplier=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(e){A(e)&&(this._screenPositionDirty=!0),h.mat4.copy(this._modelTransform,e),this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._mapPoint,this._mapPoint.spatialReference),this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mapPoint",{get:function(){return this._mapPoint},set:function(e){v.clonePoint(e,this._mapPoint),this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grabbing",{set:function(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateEngineObject()),e||(this._dragOffset=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovering",{set:function(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"active",{set:function(e){e!==this._get("active")&&(this._set("active",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{set:function(e){e!==this._get("state")&&(this._set("state",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"surfaceType",{get:function(){return this._hitResult.onSurface?this._hitResult.surfaceType:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"screenPoint",{get:function(){return this._updateScreenPositions(),this._dirtyScreenPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_screenPointArray",{get:function(){return this._updateScreenPositions(),this._dirtyScreenPointArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_renderScreenPointArray",{get:function(){return this._updateScreenPositions(),this._dirtyRenderScreenPointArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_originScreenPointArray",{get:function(){return this._updateScreenPositions(),this._dirtyOriginScreenPointArray},enumerable:!0,configurable:!0}),t.prototype._updateScreenPositions=function(e){if(void 0===e&&(e=!1),this._screenPositionDirty){var t,r=A(this._modelTransform);if(r){var i=this._calculateModelTransformOffset(U);t=y.vec3.add(i,i,this._position)}else t=this._position;this._screenPositionDirty=!1,this._camera.projectPoint(t,this._dirtyRenderScreenPointArray),this._camera.renderToScreen(this._dirtyRenderScreenPointArray,this._dirtyScreenPointArray),c.screenPointArrayToObject(this._dirtyScreenPointArray,this._dirtyScreenPoint),r?(this._camera.projectPoint(this._position,D),this._camera.renderToScreen(D,this._dirtyOriginScreenPointArray)):f.vec2.copy(this._dirtyOriginScreenPointArray,this._dirtyScreenPointArray)}},t.prototype.intersectionDistance=function(e,t){if(!this._get("visible")||!this._get("active"))return null;var r=c.screenPointObjectToArray(e,E),i=this._getCollisionRadius(t);switch(this.collisionType.type){case"point":if(f.vec2.squaredDistance(this._screenPointArray,r)<i*i)return this._renderScreenPointArray[2];break;case"line":for(var n=this.collisionType.paths,o=this._camera.computeScreenPixelSizeAt(this._position),a=this._calculateObjectTransform(o,z),l=i*this._camera.computeScreenPixelSizeAt(this._position),p=b.ray.fromScreen(this._camera,r,C),h=0,d=n;h<d.length;h++){var _=d[h];if(0!==_.length)for(var g=y.vec3.transformMat4(N,_[0],a),m=1;m<_.length;m++){var v=y.vec3.transformMat4(H,_[m],a),S=b.lineSegment.closestRayDistance2(b.lineSegment.fromPoints(g,v,x),p);if(null!=S&&S<l*l){var O=y.vec3.add(P.sv3d.get(),g,v);y.vec3.scale(O,O,.5);var j=c.castRenderScreenPointArray(P.sv3d.get());return this._camera.projectPoint(O,j),j[2]}y.vec3.copy(g,v)}}break;case"disc":var R=this.collisionType.direction,o=this._camera.computeScreenPixelSizeAt(this._position),a=this._calculateObjectTransform(o,z),l=i*this._camera.computeScreenPixelSizeAt(this._position),p=b.ray.fromScreen(this._camera,r,C),T=u.mat3.fromMat4(I,a),A=y.vec3.transformMat3(F,R,T),M=this._calculateModelTransformPosition(G);b.plane.fromPositionAndNormal(M,A,L);var w=B;if(b.plane.intersectRay(L,p,w)&&y.vec3.squaredDistance(w,M)<l*l)return this._renderScreenPointArray[2];break;case"ribbon":var D=this.collisionType,n=D.paths,R=D.direction,o=this._camera.computeScreenPixelSizeAt(this._position),a=this._calculateObjectTransform(o,z),l=i*this._camera.computeScreenPixelSizeAt(this._position),p=b.ray.fromScreen(this._camera,r,C),T=u.mat3.fromMat4(I,a),A=y.vec3.transformMat3(F,R,T),M=this._calculateModelTransformPosition(G);b.plane.fromPositionAndNormal(M,A,L);var w=B;if(!b.plane.intersectRay(L,p,w))break;for(var k=0,U=n;k<U.length;k++){var _=U[k];if(0!==_.length)for(var g=y.vec3.transformMat4(N,_[0],a),m=1;m<_.length;m++){var v=y.vec3.transformMat4(H,_[m],a),S=b.lineSegment.distance2(b.lineSegment.fromPoints(g,v,x),w);if(null!=S&&S<l*l){var O=y.vec3.add(P.sv3d.get(),g,v);y.vec3.scale(O,O,.5);var j=c.castRenderScreenPointArray(P.sv3d.get());return this._camera.projectPoint(O,j),j[2]}y.vec3.copy(g,v)}}break;default:s.neverReached(this.collisionType)}return null},t.prototype.attemptDragTo=function(e){if(!this.moveOnDrag)return this._handlers.forEach(function(t){var r=t.type,i=t.handler;"drag"===r&&i(e)}),!1;var t=c.screenPointObjectToArray(e.screenPoint,E);a.isNone(this._dragOffset)&&this.grabbing&&!this.snapToPointer&&(this._dragOffset=f.vec2.subtract(_.vec2f32.create(),t,this._originScreenPointArray)),a.isSome(this._dragOffset)&&f.vec2.subtract(t,t,this._dragOffset);var r=this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector,"on-the-ground"===this.alignment?w:null),i=r.results.min,n=B;return i.getIntersectionPoint(n)?(this.position=n,this._hitResult.onSurface=!0,this._hitResult.surfaceType="TerrainRenderer"===i.intersector?"ground":"feature",this._handlers.forEach(function(t){var r=t.type,i=t.handler;"drag"===r&&i(e)})):this._hitResult.onSurface=!1,this._hitResult.onSurface},t.prototype.click=function(e){this._handlers.forEach(function(t){var r=t.type,i=t.handler;"click"===r&&i(e)})},t.prototype.on=function(e,t){this._handlers.push({type:e,handler:t})},t.prototype.addToEngineLayer=function(e,t){if(!a.isSome(this._engineLayerId)){if(a.isSome(e))this._engineLayerId=e;else{var r=new j("manipulator-3d",{isPickable:!1});this.view._stage.add(T.ContentType.LAYER,r),this.view._stage.addToViewContent([r.id]),this._engineLayerId=r.id}a.isSome(t)?this._materialIdReferences=t:this._materialIdReferences=new Map,this._updateEngineObject()}},t.prototype.installRenderHandles=function(e,t){var r=null,i=null;t(function(e){return!(e instanceof n)||(r=e._engineLayerId,i=e._materialIdReferences,!1)}),this.addToEngineLayer(r,i),this._camera=this.view.state.camera;var o="render-manipulator-3d";if(!e.has(o)){var s=function(e){t(function(t){t instanceof n&&t.view.renderCoordsHelper.fromRenderCoords(t.position,q,e.spatialReference)&&m.containsPoint(e.extent,q)&&t._refreshMapPoint(!0)})};e.add([this.view.state.watch("camera",function(e){t(function(t){t instanceof n&&(t._camera=e,t._screenPositionDirty=!0,t._updateEngineObject())})}),this.view.elevationProvider.on("elevation-change",function(e){return s(e)})],o)}},t.prototype._refreshMapPoint=function(e){switch(void 0===e&&(e=!1),this.alignment){case"none":break;case"on-the-ground":var t=this.view.elevationProvider.getElevation(this.mapPoint,"ground");if(!(t!==this._mapPoint.z||!e))return;this._mapPoint.z=t;break;default:s.neverReached(this.alignment)}this._screenPositionDirty=!0,this._hitResult.onSurface=!1,this.view.renderCoordsHelper.toRenderCoords(this._mapPoint,this._position),this._updateEngineObject()},t.prototype._updateEngineObject=function(){if(!a.isNone(this._engineLayerId)){if(!1===this._get("visible")||!1===this._get("active"))return void this._removeResourcesFromStage();var e=this._get("view").state.camera.computeScreenPixelSizeAt(this._position),t=z;if(!0===this._get("autoScaleRenderObjects")){var r=this._getFocusedSize(this._radius,this._focused)*e;this._calculateObjectTransform(r,t)}else this._calculateObjectTransform(e,t);for(var i=this._ensureEngineResources().objectsByState,n=(this._focused?2:1)|(this._get("selected")?8:4),o=this._get("hideOnGrab")&&this._get("grabbing"),s=0,c=i;s<c.length;s++){var l=c[s],u=l.stateMask,p=l.objects;if(o)for(var h=0,d=p;h<d.length;h++){var f=d[h];f.object3D.hideAllComponents(),f.startTimeMs=0}else{var _=0!=(15&u),y=0!=(32752&u),g=!_||(n&u)==(15&u),m=!y||(this._get("state")&u)==(32752&u);if(g&&m)for(var v=0,b=p;v<b.length;v++){var f=b[v];f.object3D.unhideAllComponents(),f.object3D.objectTransformation=t}else for(var P=0,S=p;P<S.length;P++){var f=S[P];f.object3D.hideAllComponents(),f.startTimeMs=0}}}}},t.prototype._ensureEngineResources=function(){if(a.isNone(this._engineResources)){var e=this.view._stage.get(T.ContentType.LAYER,a.expect(this._engineLayerId)),t=[],r=new Set;this.renderObjects.forEach(function(e){var i=e.material;r.has(i)||(t.push(i),r.add(i))});var i=function(e,t){var r=t.geometry,i=t.material,n=t.transform;Array.isArray(r)?r.forEach(function(t){return e.addGeometry(t,i,n)}):e.addGeometry(r,i,n)},n=new Map;this.renderObjects.forEach(function(e){var t=new R({idHint:"manipulator"});i(t,e);var r=e.stateMask||0,o=n.get(r)||[],s={object3D:t,startTimeMs:0,delayMs:e.delayMs};o.push(s),n.set(r,o)});var o=[];n.forEach(function(e,t){o.push({stateMask:t,objects:e})}),this._engineResources={objectsByState:o,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources},t.prototype._addResourcesToStage=function(){var e=this;if(!this._engineResourcesAddedToStage&&!a.isNone(this._engineResources)){var t=this._engineResources,r=t.objectsByState,i=t.layer;t.materials.forEach(function(t){var r=a.expect(e._materialIdReferences),i=r.get(t.id)||0;0===i&&e.view._stage.add(T.ContentType.MATERIAL,t),r.set(t.id,i+1)}),r.forEach(function(t){t.objects.forEach(function(t){var r=t.object3D;i.addObject(r),e.view._stage.add(T.ContentType.OBJECT,r)})}),this._engineResourcesAddedToStage=!0}},t.prototype._removeResourcesFromStage=function(){var e=this;if(this._engineResourcesAddedToStage&&!a.isNone(this._engineResources)){var t=this._engineResources,r=t.objectsByState,i=t.layer,n=t.materials;r.forEach(function(t){t.objects.forEach(function(t){var r=t.object3D;i.removeObject(r),e.view._stage.remove(T.ContentType.OBJECT,r.id)})}),n.forEach(function(t){var r=a.expect(e._materialIdReferences),i=r.get(t.id);1===i?(e.view._stage.remove(T.ContentType.MATERIAL,t.id),r.delete(t.id)):r.set(t.id,i-1)}),this._engineResourcesAddedToStage=!1}},t.prototype._getCollisionRadius=function(e){return this._getFocusedSize(this._radius,!0)*("touch"===e?this._touchMultiplier:1)},t.prototype._getFocusedSize=function(e,t){return e*(t?this._focusMultiplier:1)},t.prototype._calculateModelTransformPosition=function(e){var t=this._camera.computeScreenPixelSizeAt(this._position),r=this._calculateObjectTransform(t,k);return y.vec3.set(e,r[12],r[13],r[14])},t.prototype._calculateModelTransformOffset=function(e){var t=this._calculateModelTransformPosition(e);return y.vec3.subtract(e,t,this._position)},t.prototype._calculateObjectTransform=function(e,t){return h.mat4.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),h.mat4.multiply(t,t,this._modelTransform),t[12]+=this._position[0],t[13]+=this._position[1],t[14]+=this._position[2],t[15]=1,t};var n;return r([l.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),r([l.property({value:"none",nonNullable:!0})],t.prototype,"alignment",null),r([l.property()],t.prototype,"hideOnGrab",void 0),r([l.property()],t.prototype,"moveOnDrag",void 0),r([l.property()],t.prototype,"snapToPointer",void 0),r([l.property()],t.prototype,"allowOverlap",void 0),r([l.property()],t.prototype,"collisionType",void 0),r([l.property({constructOnly:!0})],t.prototype,"renderObjects",void 0),r([l.property()],t.prototype,"autoScaleRenderObjects",void 0),r([l.property({value:!0})],t.prototype,"visible",null),r([l.property()],t.prototype,"radius",null),r([l.property()],t.prototype,"focusMultiplier",null),r([l.property()],t.prototype,"touchMultiplier",null),r([l.property()],t.prototype,"interactive",void 0),r([l.property()],t.prototype,"selectable",void 0),r([l.property({value:!1})],t.prototype,"grabbing",null),r([l.property()],t.prototype,"dragging",void 0),r([l.property({value:!1})],t.prototype,"hovering",null),r([l.property({value:!1})],t.prototype,"selected",null),r([l.property({value:!0})],t.prototype,"active",null),r([l.property({value:0})],t.prototype,"state",null),r([l.property({dependsOn:["hovering","grabbing"]})],t.prototype,"focused",null),t=n=r([l.subclass("esri.views.interactive.Manipulator3D")],t)}(l.declared(n));t.Manipulator3D=M;var w={include:new Set};w.include.add(O.TERRAIN_ID);var E=c.createScreenPointArray(),D=c.createRenderScreenPointArray3(),x=b.lineSegment.create(),C=b.ray.create(),I=p.mat3f64.create(),k=d.mat4f64.create(),z=d.mat4f64.create(),L=b.plane.create(),N=g.vec3f64.create(),H=g.vec3f64.create(),B=g.vec3f64.create(),F=g.vec3f64.create(),G=g.vec3f64.create(),U=g.vec3f64.create(),q=g.vec3f64.create()});