// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","dojo/_base/kernel","../config","../kernel","../request","../core/Error","../core/JSONSupport","../core/lang","../core/Loadable","../core/promiseUtils","../core/accessorSupport/decorators","../geometry/Extent","./PortalQueryParams","./PortalQueryResult","./PortalUser"],function(e,r,t,o,n,p,u,a,i,l,s,y,d,c,f,h,m,v,P,g){var S,_={Bookmark:function(){return f.create(function(r){return e(["./Bookmark"],r)})},Portal:function(){return f.create(function(r){return e(["./Portal"],r)})},PortalFolder:function(){return f.create(function(r){return e(["./PortalFolder"],r)})},PortalGroup:function(){return f.create(function(r){return e(["./PortalGroup"],r)})},PortalItem:function(){return f.create(function(r){return e(["./PortalItem"],r)})},PortalQueryParams:function(){return f.create(function(r){return e(["./PortalQueryParams"],r)})},PortalQueryResult:function(){return f.create(function(r){return e(["./PortalQueryResult"],r)})},PortalRating:function(){return f.create(function(r){return e(["./PortalRating"],r)})},PortalUser:function(){return f.create(function(r){return e(["./PortalUser"],r)})}};return function(r){function y(e){var t=r.call(this)||this;return t.access=null,t.allSSL=!1,t.authMode="auto",t.authorizedCrossOriginDomains=null,t.basemapGalleryGroupQuery=null,t.bingKey=null,t.canListApps=!1,t.canListData=!1,t.canListPreProvisionedItems=!1,t.canProvisionDirectPurchase=!1,t.canSearchPublic=!0,t.canShareBingPublic=!1,t.canSharePublic=!1,t.canSignInArcGIS=!1,t.canSignInIDP=!1,t.colorSetsGroupQuery=null,t.commentsEnabled=!1,t.created=null,t.culture=null,t.customBaseUrl=null,t.defaultBasemap=null,t.defaultExtent=null,t.defaultVectorBasemap=null,t.description=null,t.eueiEnabled=!1,t.featuredGroups=null,t.featuredItemsGroupQuery=null,t.galleryTemplatesGroupQuery=null,t.livingAtlasGroupQuery=null,t.hasCategorySchema=!1,t.helperServices=null,t.homePageFeaturedContent=null,t.homePageFeaturedContentCount=null,t.httpPort=null,t.httpsPort=null,t.id=null,t.ipCntryCode=null,t.isPortal=!1,t.layerTemplatesGroupQuery=null,t.maxTokenExpirationMinutes=null,t.modified=null,t.name=null,t.portalHostname=null,t.portalMode=null,t.portalProperties=null,t.region=null,t.rotatorPanels=null,t.showHomePageDescription=!1,t.supportsHostedServices=!1,t.symbolSetsGroupQuery=null,t.templatesGroupQuery=null,t.units=null,t.url=a.portalUrl,t.urlKey=null,t.user=null,t.useStandardizedQuery=!1,t.useVectorBasemaps=!1,t.vectorBasemapGalleryGroupQuery=null,t}o(y,r),c=y,y.prototype.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},y.prototype.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},y.prototype.readAuthorizedCrossOriginDomains=function(e){if(e)for(var r=0,t=e;r<t.length;r++){var o=t[r];-1===a.request.trustedServers.indexOf(o)&&a.request.trustedServers.push(o)}return e},y.prototype.readDefaultBasemap=function(e){if(e){var r=S.fromJSON(e);return r.portalItem={portal:this},r}return null},y.prototype.readDefaultVectorBasemap=function(e){if(e){var r=S.fromJSON(e);return r.portalItem={portal:this},r}return null},Object.defineProperty(y.prototype,"extraQuery",{get:function(){var e=this.user&&this.user.orgId,r=!e||this.canSearchPublic;return this.id&&!r?" AND orgid:"+this.id:null},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"restUrl",{get:function(){var e=this.url;if(e){var r=e.indexOf("/sharing");e=r>0?e.substring(0,r):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"thumbnailUrl",{get:function(){var e=this.restUrl,r=this.thumbnail;return e&&r?this._normalizeSSL(e+"/portals/self/resources/"+r):null},enumerable:!0,configurable:!0}),y.prototype.readUrlKey=function(e){return e?e.toLowerCase():e},y.prototype.readUser=function(e){var r=null;return e&&(r=g.fromJSON(e),r.portal=this),r},y.prototype.load=function(){var r=this,t=f.create(function(r){return e(["../Basemap"],r)}).then(function(e){S=e}).then(function(){return r._fetchSelf()}).then(function(e){if(i.id){var t=i.id;r.credential=t.findCredential(r.restUrl),r.credential||r.authMode!==c.AUTH_MODE_AUTO||(r._esriId_credentialCreateHandle=t.on("credential-create",function(){t.findCredential(r.restUrl)&&r._signIn()}))}r.read(e)});return this.addResolvingPromise(t),this.when()},y.prototype.fetchBasemaps=function(e){var r=new v;return r.query=e||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0,this.queryGroups(r).then(function(e){if(r.num=100,r.query='type:"Web Map" -type:"Web Application"',e.total){var t=e.results[0];return r.sortField=t.sortField||"name",r.sortOrder=t.sortOrder||"desc",t.queryItems(r)}return null}).then(function(e){return e&&e.total?e.results.filter(function(e){return"Web Map"===e.type}).map(function(e){return new S({portalItem:e})}):[]})},y.prototype.fetchCategorySchema=function(){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema").then(function(e){return e.categorySchema}):f.resolve([])},y.prototype.fetchFeaturedGroups=function(){var e=this.featuredGroups,r=new v;if(r.num=100,r.sortField="title",e&&e.length){for(var t=[],o=0,n=e;o<n.length;o++){var p=n[o];t.push('(title:"'+p.title+'" AND owner:'+p.owner+")")}return r.query=t.join(" OR "),this.queryGroups(r).then(function(e){return e.results})}return f.resolve([])},y.prototype.fetchRegions=function(){var e=this.user&&this.user.culture||this.culture||u.locale;return this._request(this.restUrl+"/portals/regions",{query:{culture:e}})},y.getDefault=function(){return c._default||(c._default=new c),c._default},y.prototype.queryGroups=function(e){return this._queryPortal("/community/groups",e,"PortalGroup")},y.prototype.queryItems=function(e){return this._queryPortal("/search",e,"PortalItem")},y.prototype.queryUsers=function(e){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser")},y.prototype.toJSON=function(){throw new s("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},y.prototype._fetchSelf=function(e,r){void 0===e&&(e=this.authMode),void 0===r&&(r=!1);var t=this.restUrl+"/portals/self",o={authMode:e,query:{culture:u.locale}};return"auto"===o.authMode&&(o.authMode="no-prompt"),r&&(o.query.default=!0),this._request(t,o)},y.prototype._queryPortal=function(e,r,t){var o=this,n=function(t){return o._request(o.restUrl+e,r.toRequestOptions(o)).then(function(e){var n=r.clone();return n.start=e.nextStart,new P({nextQueryParams:n,queryParams:r,total:e.total,results:c._resultsToTypedArray(t,{portal:o},e)})}).then(function(e){return f.all(e.results.map(function(r){return"function"==typeof r.when?r.when():e})).then(function(){return e},function(){return e})})};return t&&_[t]?_[t]().then(function(e){return n(e)}):n()},y.prototype._signIn=function(){var e=this;if(this.authMode===c.AUTH_MODE_ANONYMOUS)return f.reject(new s("portal:invalid-auth-mode",'Current "authMode"\' is "'+this.authMode+'"'));if("failed"===this.loadStatus)return f.reject(this.loadError);var r=function(r){return f.resolve().then(function(){return"not-loaded"===e.loadStatus?(r||(e.authMode="immediate"),e.load().then(function(){return null})):"loading"===e.loadStatus?e.load().then(function(){return e.credential?null:(e.credential=r,e._fetchSelf("immediate"))}):e.user&&e.credential===r?null:(e.credential=r,e._fetchSelf("immediate"))}).then(function(r){r&&e.read(r)})};return i.id?i.id.getCredential(this.restUrl).then(function(e){return r(e)}):r(this.credential)},y.prototype._normalizeSSL=function(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")},y.prototype._normalizeUrl=function(e){var r=this.credential&&this.credential.token;return this._normalizeSSL(r?e+(e.indexOf("?")>-1?"&":"?")+"token="+r:e)},y.prototype._requestToTypedArray=function(r,t,o){var n=this,p=function(e){return n._request(r,t).then(function(r){var t=c._resultsToTypedArray(e,{portal:n},r);return f.all(t.map(function(e){return"function"==typeof e.when?e.when():r})).then(function(){return t},function(){return t})})};return o?f.create(function(r){return e(["./"+o],r)}).then(function(e){return p(e)}):p()},y.prototype._request=function(e,r){var o=this.authMode===c.AUTH_MODE_ANONYMOUS?"anonymous":"auto",n=null,p="auto",u={f:"json"},a="json";r&&(r.authMode&&(o=r.authMode),r.body&&(n=r.body),r.method&&(p=r.method),r.query&&(u=t({},u,r.query)),r.responseType&&(a=r.responseType));var i={authMode:o,body:n,method:p,query:u,responseType:a,timeout:0};return l(this._normalizeSSL(e),i).then(function(e){return e.data})},y._resultsToTypedArray=function(e,r,t){var o;return t?(o=t.listings||t.notifications||t.userInvitations||t.tags||t.items||t.groups||t.comments||t.provisions||t.results||t.relatedItems||t,(e||r)&&(o=o.map(function(t){var o=d.mixin(e?e.fromJSON(t):t,r);return"function"==typeof o.load&&o.load(),o}))):o=[],o};var c;return y.AUTH_MODE_ANONYMOUS="anonymous",y.AUTH_MODE_AUTO="auto",y.AUTH_MODE_IMMEDIATE="immediate",n([h.property()],y.prototype,"access",void 0),n([h.property()],y.prototype,"allSSL",void 0),n([h.property()],y.prototype,"authMode",void 0),n([h.property()],y.prototype,"authorizedCrossOriginDomains",void 0),n([h.reader("authorizedCrossOriginDomains")],y.prototype,"readAuthorizedCrossOriginDomains",null),n([h.property()],y.prototype,"basemapGalleryGroupQuery",void 0),n([h.property()],y.prototype,"bingKey",void 0),n([h.property()],y.prototype,"canListApps",void 0),n([h.property()],y.prototype,"canListData",void 0),n([h.property()],y.prototype,"canListPreProvisionedItems",void 0),n([h.property()],y.prototype,"canProvisionDirectPurchase",void 0),n([h.property()],y.prototype,"canSearchPublic",void 0),n([h.property()],y.prototype,"canShareBingPublic",void 0),n([h.property()],y.prototype,"canSharePublic",void 0),n([h.property()],y.prototype,"canSignInArcGIS",void 0),n([h.property()],y.prototype,"canSignInIDP",void 0),n([h.property()],y.prototype,"colorSetsGroupQuery",void 0),n([h.property()],y.prototype,"commentsEnabled",void 0),n([h.property({type:Date})],y.prototype,"created",void 0),n([h.property()],y.prototype,"credential",void 0),n([h.property()],y.prototype,"culture",void 0),n([h.property()],y.prototype,"currentVersion",void 0),n([h.property()],y.prototype,"customBaseUrl",void 0),n([h.property()],y.prototype,"defaultBasemap",void 0),n([h.reader("defaultBasemap")],y.prototype,"readDefaultBasemap",null),n([h.property({type:m})],y.prototype,"defaultExtent",void 0),n([h.property()],y.prototype,"defaultVectorBasemap",void 0),n([h.reader("defaultVectorBasemap")],y.prototype,"readDefaultVectorBasemap",null),n([h.property()],y.prototype,"description",void 0),n([h.property()],y.prototype,"eueiEnabled",void 0),n([h.property({dependsOn:["user","id","canSearchPublic"],readOnly:!0})],y.prototype,"extraQuery",null),n([h.property()],y.prototype,"featuredGroups",void 0),n([h.property()],y.prototype,"featuredItemsGroupQuery",void 0),n([h.property()],y.prototype,"galleryTemplatesGroupQuery",void 0),n([h.property()],y.prototype,"livingAtlasGroupQuery",void 0),n([h.property()],y.prototype,"hasCategorySchema",void 0),n([h.property()],y.prototype,"helpBase",void 0),n([h.property()],y.prototype,"helperServices",void 0),n([h.property()],y.prototype,"helpMap",void 0),n([h.property()],y.prototype,"homePageFeaturedContent",void 0),n([h.property()],y.prototype,"homePageFeaturedContentCount",void 0),n([h.property()],y.prototype,"httpPort",void 0),n([h.property()],y.prototype,"httpsPort",void 0),n([h.property()],y.prototype,"id",void 0),n([h.property()],y.prototype,"ipCntryCode",void 0),n([h.property({dependsOn:["access"],readOnly:!0})],y.prototype,"isOrganization",null),n([h.property()],y.prototype,"isPortal",void 0),n([h.property()],y.prototype,"layerTemplatesGroupQuery",void 0),n([h.property()],y.prototype,"maxTokenExpirationMinutes",void 0),n([h.property({type:Date})],y.prototype,"modified",void 0),n([h.property()],y.prototype,"name",void 0),n([h.property()],y.prototype,"portalHostname",void 0),n([h.property()],y.prototype,"portalMode",void 0),n([h.property()],y.prototype,"portalProperties",void 0),n([h.property()],y.prototype,"region",void 0),n([h.property({dependsOn:["url"],readOnly:!0})],y.prototype,"restUrl",null),n([h.property()],y.prototype,"rotatorPanels",void 0),n([h.property()],y.prototype,"showHomePageDescription",void 0),n([h.property()],y.prototype,"staticImagesUrl",void 0),n([h.property()],y.prototype,"stylesGroupQuery",void 0),n([h.property()],y.prototype,"supportsHostedServices",void 0),n([h.property()],y.prototype,"symbolSetsGroupQuery",void 0),n([h.property()],y.prototype,"templatesGroupQuery",void 0),n([h.property()],y.prototype,"thumbnail",void 0),n([h.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],y.prototype,"thumbnailUrl",null),n([h.property()],y.prototype,"units",void 0),n([h.property()],y.prototype,"url",void 0),n([h.property()],y.prototype,"urlKey",void 0),n([h.reader("urlKey")],y.prototype,"readUrlKey",null),n([h.property()],y.prototype,"user",void 0),n([h.reader("user")],y.prototype,"readUser",null),n([h.property()],y.prototype,"useStandardizedQuery",void 0),n([h.property()],y.prototype,"useVectorBasemaps",void 0),n([h.property()],y.prototype,"vectorBasemapGalleryGroupQuery",void 0),n([p(1,h.cast(v))],y.prototype,"_queryPortal",null),y=c=n([h.subclass("esri.portal.Portal")],y)}(h.declared(y,c))});