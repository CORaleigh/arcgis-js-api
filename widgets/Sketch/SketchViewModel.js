// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../geometry","../../Graphic","../../symbols","../../core/Accessor","../../core/Collection","../../core/compilerUtils","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/coordsUtils","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/3d/interactive/editingTools/graphicReshape3D/isSupportedGraphic","../../views/3d/interactive/editingTools/graphicTransform3D/isSupportedGraphic","../../views/draw/Draw","../../views/draw/support/createUtils","./support/OperationHandle"],function(e,t,r,o,i,a,n,p,c,s,l,h,d,u,v,y,m,f,g,_,G,w,b,E,S,x,C,A,T,U,H,O){function k(e,t){var r=e.history.undo.pop(),o=r.updates,i=[];t.forEach(function(e,t){var r=o[t],a={};null!=r&&(f.isSome(r.geometry)&&(a.geometry=e.geometry,e.geometry=r.geometry),f.isSome(r.symbol)&&(a.symbol=e.symbol,e.symbol=r.symbol),i.push(a))}),e.history.redo.push({updates:i})}function L(e,t){var r=e.history.redo.pop(),o=r.updates,i=[];t.forEach(function(e,t){var r=o[t],a={};null!=r&&(f.isSome(r.geometry)&&(a.geometry=e.geometry,e.geometry=r.geometry),f.isSome(r.symbol)&&(a.symbol=e.symbol,e.symbol=r.symbol),i.push(a))}),e.history.undo.push({updates:i})}function I(e){return{updates:e.map(function(e){return{geometry:e.geometry}})}}function R(e){return{updates:e.map(function(e){return{symbol:e.symbol}})}}function P(e){e.canUndo()?e.complete():e.cancel()}var M=m.getLogger("esri.widgets.Sketch.SketchViewModel"),V={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape"};return function(t){function l(e){var r=t.call(this,e)||this;return r._activeFillGraphic=null,r._activeLineGraphic=null,r._centerIndicatorGraphic=null,r._centerSymbol=new C({style:"cross",size:6,color:[255,255,255]}),r._defaultSegmentOffset=48,r._handles=new y,r._internalGraphicsLayer=new E({listMode:"hide"}),r._lineGraphic=null,r._operationHandle=null,r._vertexGraphics=[],r._viewHandles=new y,r._highlightHandlesByGraphic=new y,r._doUnnormalization=!1,r.activeFillSymbol=new S({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new x({color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new C({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.activeVertexSymbol=new C({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.createGraphic=null,r.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform"},r.layer=null,r.pointSymbol=new C({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new S({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new x({color:[130,130,130,1],width:2}),r.updateGraphics=new h,r.updateOnGraphicClick=!0,r.updatePointSymbol=new C({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new S({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new x({color:[12,207,255],width:2}),r.vertexSymbol=new C({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.view=null,r}return o(l,t),l.prototype.initialize=function(){var e=this;this._handles.add([G.when(this,"view.ready",function(t){e._viewHandles.removeAll(),t&&e._setUpViewReadyHandle()},!0),G.watch(this,"view",function(t,r){if(e._doUnnormalization=t&&"3d"===t.type&&"global"===t.viewingMode,r){var o=r.container,i=r.map;o&&(e.view.cursor=null),i&&i.remove(e._internalGraphicsLayer),e._viewHandles.removeAll(),e.reset()}},!0),G.watch(this,"layer",function(){return e.reset()}),G.on(this,"view.map.layers","change",function(t){t.removed.indexOf(e.layer)>=0&&e.reset()}),G.on(this,"layer.graphics","change",function(t){if(f.isSome(e._operationHandle))for(var r=0,o=t.removed;r<o.length;r++){var i=o[r];e.updateGraphics.includes(i)&&(e.updateGraphics.length>1?e._operationHandle.removeFromSelection(i):P(e._operationHandle))}})].concat(this._sceneViewHighlightHandles()))},l.prototype.destroy=function(){this._reset(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._highlightHandlesByGraphic.removeAll(),this._highlightHandlesByGraphic=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")},Object.defineProperty(l.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?"move":"transform"},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new U({view:this.view}):null},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"activeComponent",{get:function(){return this._operationHandle?this._operationHandle.activeComponent:null},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"state",{get:function(){var e=!(!this.get("view.ready")||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"},enumerable:!0,configurable:!0}),l.prototype.cancel=function(){this._operationHandle&&this._operationHandle.cancel()},l.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()},l.prototype.create=function(e,t){var r=this;if("disabled"===this.state)return this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));if(this._reset(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");var o=this._setupCreateOperation(e,t);if(o){this.view.map.add(this._internalGraphicsLayer);var i=function(){if(o===r._operationHandle){var t=o.cancelled?"cancel":"complete",i=r.createGraphic;r._operationHandle.destroy(),r._operationHandle=null,r._set("createGraphic",null),r.view&&r.view.map&&r.view.map.remove(r._internalGraphicsLayer),o.cancelled||r.layer.add(i),r._emitCreateEvent({graphic:i,state:t,tool:e,toolEventInfo:null})}};o.on("complete",i),o.on("cancel",i),this._operationHandle=o}},l.prototype.reset=function(){this._reset(),this._emitResetEvent()},l.prototype.update=function(e,t){return n(this,void 0,void 0,function(){var r,o,i,n,p,c,s,l=this;return a(this,function(a){switch(a.label){case 0:return r=this,(o=r.layer,i=r.state,n=r.view,"disabled"===i)?(o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),n||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2]):(this._reset(),(p=Array.isArray(e)?e:[e])&&p.length?(c=p.some(function(e){return e.layer!==o?(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):e.geometry?"2d"!==n.type||n.spatialReference.equals(e.geometry.spatialReference)?void 0:(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0):(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0)}),c?[2]:[4,this._setupUpdateOperation(p,t)]):(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),[2]));case 1:return(s=a.sent())?(this.view.map.add(this._internalGraphicsLayer),this._emitUpdateEvent({graphics:p,state:"start",tool:s.tool,toolEventInfo:null}),this._setUpdateOperationHandle(s),[2]):[2]}})})},l.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()},l.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()},l.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},l.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},l.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},l.prototype._reset=function(){this._removeCreateOperationGraphics(),this.cancel(),this._displayDefaultCursor(),this._draw&&this._draw.reset()},l.prototype._hitTest=function(e){return n(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return[4,this.view.hitTest(e)];case 1:return t=r.sent(),"2d"===this.view.type?[2,t]:t.results.length>0?[2,{screenPoint:e,results:[t.results[0]]}]:[2,{screenPoint:e,results:[]}]}})})},l.prototype._setUpViewReadyHandle=function(){var e=this,t=this.view;this._viewHandles.add([t.on("click",function(t){if(!e.view.toolViewManager.handlesClickEvent(t)){var o=e,i=o._operationHandle,a=o.defaultUpdateOptions,n=o.layer,p=o.state,c=o.updateGraphics,s=o.updateOnGraphicClick,l="active"===p&&"create"===i.type;"disabled"!==p&&!l&&s&&e._hitTest(_.createScreenPointFromEvent(t)).then(function(t){var o=t.results;o.length?o.some(function(t){if(t.graphic){var o=t.graphic;if(c.indexOf(o)>-1)return!0;if(o.layer===n)return e.update([o],r({},a)),!0}}):"active"===p&&e._reset()})}})])},l.prototype._setupCreateOperation=function(e,t){if(e){var r;switch(e){case"point":r=this._setupCreatePointOperation(e,t);break;case"multipoint":r=this._setupCreateMultipointOperation(e,t);break;case"polygon":case"polyline":r=this._setupCreatePolyOperation(e,t);break;case"rectangle":r=this._setupCreateRectangleOperation(e,t);break;case"circle":r=this._setupCreateCircleOperation(e,t)}return r}},l.prototype._setupCreatePointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=[o.on("cursor-update",function(e){f.isSome(e.coordinates)?r._displayCrosshairCursor():r._displayDefaultCursor()}),o.on("draw-complete",function(e){var t=e.coordinates,o=t[0],i=t[1],a=new p.Point(o,i,r.view.spatialReference),s=new c(a,r.pointSymbol);r._set("createGraphic",s),n&&n.complete()})],a=[this.view.on("key-down",function(e){e.key===V.cancelKey&&n&&n.cancel()})],n=this._operationHandleForCreateAction(o,i.concat(a),e);return n},l.prototype._setupCreateMultipointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=null,a=[],n=this._operationHandleForCreateAction(o,a,e);return a.push(o.on("vertex-add",function(t){var o=t.type,a=t.vertexIndex,n=t.vertices,p=n[a];i=t,r._drawMultipointGraphic(n,!0),r._emitCreateEvent({graphic:r.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,a=t.vertexIndex,n=t.vertices,p=n[a];i=t,r._drawMultipointGraphic(n,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:p,type:o}})}),o.on("vertex-update",function(t){var o=t.type,a=t.vertexIndex,n=t.vertices,p=n[a];i=t,r._drawMultipointGraphic(n,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:p}})}),o.on("cursor-update",function(e){i=e}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=H.createMultipoint(t,r.view.spatialReference);o?(r.createGraphic&&(r.createGraphic.geometry=o),n&&n.complete()):n&&n.cancel()}),o.on("undo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)}),o.on("redo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)})),a.push(this.view.on("pointer-move",function(e){return r._displayCrosshairCursor()}),this.view.on("key-down",function(e){return r._getCommonUpdateOperationKeyDownHandlers(n,e)})),n},l.prototype._setupCreatePolyOperation=function(e,t){var r=this,o=null;"polyline"===e?o=this._draw.create(e,t):"polygon"===e&&(o=this._draw.create(e,t));var i=new p.Point,a=null,n=!1,c=[o.on("vertex-add",function(t){var o=t.type,i=t.vertexIndex,p=t.vertices,c=p[i];r._snap(e,p,n),a=t,r._drawVertexGraphics(e,p,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,i=t.vertexIndex,p=t.vertices,c=p[i];r._snap(e,p,n),a=t,r._drawVertexGraphics(e,p,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:c,type:o}})}),o.on("vertex-update",function(t){var o=t.type,i=t.vertexIndex,p=t.vertices,c=p[i];r._snap(e,p,n),a=t,r._drawVertexGraphics(e,p,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:c}})}),o.on("cursor-update",function(t){var o=t.type,p=t.vertices;if(t.mapPoint&&(r._snap(e,p,n),a=t,i=t.mapPoint,r._drawVertexGraphics(e,p,{userClicked:!1}),p.length>1)){var c=p[p.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:c,type:o}})}}),o.on("draw-complete",function(t){var o=t.vertices.slice(0),i=null;"polyline"===e?i=H.createPolyline([o],r.view.spatialReference,r._doUnnormalization):"polygon"===e&&(i=H.createPolygon([o],r.view.spatialReference,r._doUnnormalization,!0)),i?(r.createGraphic.geometry=i,d&&d.complete()):d&&d.cancel()}),o.on("undo",function(t){var o=t.vertices,i=a&&"cursor-update"!==a.type;r._resetCreateOperationGraphics(),r._snap(e,o,n),o.length&&r._drawVertexGraphics(e,o,{userClicked:i})}),o.on("redo",function(t){var o=t.vertices,i=a&&"cursor-update"!==a.type;r._resetCreateOperationGraphics(),r._snap(e,o,n),o.length&&r._drawVertexGraphics(e,o,{userClicked:i})})],s=[this.view.on("pointer-move",function(e){r.view.toMap(_.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()}),this.view.on("key-down",function(t){var i=o.vertices.slice(0),p=a&&"cursor-update"!==a.type;t.key!==V.constraintKey||n||"2d"!==r.view.type?t.key===V.undoKey&&d&&d.canUndo()?(t.stopPropagation(),d.undo()):t.key===V.redoKey&&d&&d.canRedo()?(t.stopPropagation(),d.redo()):t.key===V.cancelKey&&d&&d.cancel():(n=!0,r._snap(e,i,!p),r._drawVertexGraphics(e,i,{userClicked:p}))}),this.view.on("key-up",function(t){var p=o.vertices.slice(0),c=a&&"cursor-update"!==a.type;t.key===V.constraintKey&&n&&(c||(p.pop(),p.push([i.x,i.y]),r._drawVertexGraphics(e,p,{userClicked:c})),n=!1)})];if("polygon"===e){var l=function(e,t,o){if(!e||!e.layer||!e.visible)return!1;var i=r.view.toScreen(e.geometry);return r._isWithinScreenDistance(i,t,o)},h=function(e){if(!(r._vertexGraphics.length<=2))return l(r._vertexGraphics[0],e,r._getVertexIntersectDistance())};s.push(this.view.on("pointer-move",function(e){var t=h(e);r._highlightHandlesByGraphic.forEach(function(e){return t?e.pause():e.resume()})}),this.view.on("pointer-down",function(e){if(h(e))return e.stopPropagation(),void o.complete();r._vertexGraphics.some(function(t){return l(t,e,r._getVertexIntersectDistance())})&&e.stopPropagation()}))}var d=this._operationHandleForCreateAction(o,c.concat(s),e);return d},l.prototype._setupCreateCircleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,a=!0,n=[o.on("vertex-add",function(t){var o=t.type,n=t.vertexIndex,p=t.vertices,c=p[n];r._drawSegmentGraphic(e,p,{centered:a,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,type:o}})}),o.on("cursor-update",function(t){var o=t.type,n=t.vertices;if(r._drawSegmentGraphic(e,n,{centered:a,constrained:i}),2===n.length){var p=n[n.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:p,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null,n=H.createViewAlignedCoordinateSystem(r.view,t[0]);1===t.length?(t.push([t[0][0]+r._defaultSegmentOffset*r.view.resolution,t[0][1]]),o=H.createCircle(t,n,!0)):o=i?H.createEllipse(t,n,a):H.createCircle(t,n,a),r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new c(o,r.polygonSymbol))),s&&s.complete()})],p=[this.view.on("pointer-move",function(e){r.view.toMap(_.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()}),this.view.on("key-down",function(t){t.key!==V.constraintKey||i?t.key===V.centerKey&&a?(a=!1,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i})):t.key===V.cancelKey&&s&&s.cancel():(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i}))}),this.view.on("key-up",function(t){t.key===V.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i})):t.key===V.centerKey&&(a=!0,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i}))})],s=this._operationHandleForCreateAction(o,n.concat(p),e);return s},l.prototype._setupCreateRectangleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,a=!1,n=[o.on("vertex-add",function(t){var o=t.type,n=t.vertexIndex,p=t.vertices,c=p[n];r._drawSegmentGraphic(e,p,{centered:a,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,type:o}})}),o.on("cursor-update",function(t){var o=t.type,n=t.vertices;if(r._drawSegmentGraphic(e,n,{centered:a,constrained:i}),2===n.length){var p=n[n.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:p,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null,n=H.createViewAlignedCoordinateSystem(r.view,t[0]);1===t.length&&(i=!1,a=!1),o=i?H.createSquare(t,n,a):H.createRectangle(t,n,a),r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new c(o,r.polygonSymbol))),s&&s.complete()})],p=[this.view.on("pointer-move",function(e){r.view.toMap(_.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()}),this.view.on("key-down",function(t){t.key!==V.constraintKey||i?t.key!==V.centerKey||a?t.key===V.cancelKey&&s&&s.cancel():(a=!0,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i})):(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i}))}),this.view.on("key-up",function(t){t.key===V.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i})):t.key===V.centerKey&&(a=!1,r._drawSegmentGraphic(e,o.vertices,{centered:a,constrained:i}))})],s=this._operationHandleForCreateAction(o,n.concat(p),e);return s},l.prototype._setupUpdateOperation=function(e,t){return n(this,void 0,void 0,function(){var o,i,n,p,c,s,l,h,d,u,u,v,u,v;return a(this,function(a){for(o=this,i=o._defaultUpdateTool,n=o.defaultUpdateOptions,p=o.layer,c=o.view,s=r({},n,t),l=s.tool||i,h=0,d=e;h<d.length;h++)u=d[h],p.remove(u),p.add(u);if("3d"===c.type){if(e=e.filter(function(e){return!e.geometry.hasZ&&"mesh"!==e.geometry.type}),"reshape"===l&&e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null];if("move"===l||e.length>1)return[2,this._setupMoveOrTransform3DOperation(e,s,c)];if(1===e.length){if(u=e[0],"point"===(v=u.geometry.type))return[2,T.isSupportedGraphic(u)?this._setupPointTransform3DOperation(u,s,c):this._setupMoveOrTransform3DOperation(e,s,c)];if("reshape"===l&&A.isSupportedGraphic(u))return[2,this._setupReshape3DOperation(u,s,c)];if("transform"===l)return[2,this._setupMoveOrTransform3DOperation(e,s,c,"transform")]}return[2,null]}if("move"===l)return[2,this._setupMoveOperation(e,s,c)];if(e.length>1)return"reshape"===l?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(e,l,s,c)];if(1===e.length){if(u=e[0],"point"===(v=u.geometry.type||null)||"multipoint"===v)return[2,this._setupMoveOperation(e,s,c)];if("transform"===l||"reshape"===l)return[2,this._setupTransformOrReshapeOperation(e,l,s,c)]}return[2,null]})})},l.prototype._setupMoveOrTransform3DOperation=function(t,r,o,i,p){return void 0===i&&(i="move"),void 0===p&&(p=!1),n(this,void 0,void 0,function(){var c,s,l,h,d=this;return a(this,function(u){switch(u.label){case 0:return[4,g.create(function(t){e(["../../views/3d/interactive/editingTools"],t)})];case 1:return c=u.sent().GraphicMove3DTool,s=new c({view:o}),this.view.tools.add(s),s.graphics.addMany(t),p||this.updateGraphics.addMany(t),l=[],h=new O.OperationHandle({activeComponent:s,tool:i,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),l.length=0,d.view.tools.remove(s),s.destroy()},undo:function(){k(h,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:i})},redo:function(){L(h,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:i})},addToSelection:function(e){d.updateGraphics.push(e),s.graphics.push(e),d._emitUpdateEvent({graphics:d.updateGraphics.toArray(),state:"active",tool:d.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=d.updateGraphics.indexOf(e);if(h.history.undo.forEach(function(e){return e.updates.splice(t,1)}),h.history.redo.forEach(function(e){return e.updates.splice(t,1)}),d.updateGraphics.remove(e),0===d.updateGraphics.length)return void P(h);s.graphics.remove(e)},toggleTool:function(){return n(d,void 0,void 0,function(){var e,t;return a(this,function(a){switch(a.label){case 0:return 1!==this.updateGraphics.length||!1===r.toggleToolOnClick?[2]:"transform"!==i?[2]:(e=this.updateGraphics.getItemAt(0),A.isSupportedGraphic(e)?[4,this._setupReshape3DOperation(e,r,o,!0)]:[2]);case 1:return t=a.sent(),h.onEnd(),h.destroy(),this._setUpdateOperationHandle(t),[2]}})})}}),l.push.apply(l,this._getHandlesForComponent(h).concat([this.view.on("click",function(e){return d._getCommonUpdateOperationClickHandlers(h,e)}),this.view.on("key-down",function(e){return d._getCommonUpdateOperationKeyDownHandlers(h,e)})])),[2,h]}})})},l.prototype._setupPointTransform3DOperation=function(t,r,o){return n(this,void 0,void 0,function(){var i,n,p,c,s,l,h,d=this;return a(this,function(a){switch(a.label){case 0:return i="transform",n=r.enableRotation,p=r.enableScaling,[4,g.create(function(t){e(["../../views/3d/interactive/editingTools"],t)})];case 1:return c=a.sent().GraphicTransform3DTool,s=new c({view:o,enableRotation:n,enableScaling:p}),this.view.tools.add(s),s.graphic=t,this.updateGraphics.add(t),l=[],h=new O.OperationHandle({activeComponent:s,tool:i,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),l.length=0,d.view.tools.remove(s),s.destroy()},undo:function(){k(h,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:i})},redo:function(){L(h,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:i})}}),l.push.apply(l,this._getHandlesForComponent(h).concat([this.view.on("click",function(e){return d._getCommonUpdateOperationClickHandlers(h,e)}),this.view.on("key-down",function(e){return d._getCommonUpdateOperationKeyDownHandlers(h,e)})])),[2,h]}})})},l.prototype._setupMoveOperation=function(e,t,r){return n(this,void 0,void 0,function(){var o,i,n,p,s,l,h=this;return a(this,function(a){switch(a.label){case 0:return o=[],i="move",e.forEach(function(e){o.push(new c(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e),n=[r.on("click",function(e){return h._getCommonUpdateOperationClickHandlers(s,e,t)}),r.on("key-down",function(e){return h._getCommonUpdateOperationKeyDownHandlers(s,e)}),r.on("key-down",function(e){e.key!==V.constraintKey||e.repeat||(p.enableMoveAllGraphics=!p.enableMoveAllGraphics)}),r.on("key-up",function(e){e.key===V.constraintKey&&(p.enableMoveAllGraphics=!p.enableMoveAllGraphics)})],[4,this._getGraphicMover(e,t,r)];case 1:return p=a.sent(),s=new O.OperationHandle({activeComponent:p,tool:i,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),n.forEach(function(e){return e.remove()}),l=[],n=[],p.destroy(),h._internalGraphicsLayer&&h._internalGraphicsLayer.removeMany(h.updateGraphics.toArray()),h.updateGraphics.forEach(function(e,t){e.symbol=o[t].symbol})},undo:function(){k(s,h.updateGraphics.toArray()),h._emitUndoEvent({graphics:h.updateGraphics.toArray(),tool:i})},redo:function(){L(s,h.updateGraphics.toArray()),h._emitRedoEvent({graphics:h.updateGraphics.toArray(),tool:i})},addToSelection:function(e){o.push(new c(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry),h.updateGraphics.push(e),p.graphics=h.updateGraphics.toArray(),h._emitUpdateEvent({graphics:h.updateGraphics.toArray(),state:"active",tool:h.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=h.updateGraphics.indexOf(e);s.history.undo.forEach(function(e){return e.updates.splice(t,1)}),s.history.redo.forEach(function(e){return e.updates.splice(t,1)});var r=o.splice(t,1)[0];if(e.symbol=r.symbol,h.updateGraphics.remove(e),0===h.updateGraphics.length)return void P(s);p.graphics=h.updateGraphics.toArray()}}),l=this._getHandlesForComponent(s),[2,s]}})})},l.prototype._setupReshape3DOperation=function(t,r,o,i){return void 0===i&&(i=!1),n(this,void 0,void 0,function(){var p,c,s,l,h,d=this;return a(this,function(u){switch(u.label){case 0:return p="reshape",[4,g.create(function(t){e(["../../views/3d/interactive/editingTools"],t)})];case 1:return c=u.sent().GraphicReshape3DTool,s=new c({view:o,graphic:t}),o.tools.add(s),i||this.updateGraphics.add(t),l=[],h=new O.OperationHandle({activeComponent:s,tool:p,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),l.length=0,o.tools.remove(s),s.destroy()},undo:function(){k(h,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:p})},redo:function(){L(h,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:p})},toggleTool:function(){return n(d,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return!1===r.toggleToolOnClick?[2]:[4,this._setupMoveOrTransform3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return e=t.sent(),h.onEnd(),h.destroy(),this._setUpdateOperationHandle(e),[2]}})})}}),l.push.apply(l,this._getHandlesForComponent(h).concat([o.on("click",function(e){return d._getCommonUpdateOperationClickHandlers(h,e)}),o.on("key-down",function(e){return d._getCommonUpdateOperationKeyDownHandlers(h,e)})])),[2,h]}})})},l.prototype._setupTransformOrReshapeOperation=function(e,t,r,o){return n(this,void 0,void 0,function(){var i,p,s,l,h,d,u,v,y,m,f=this;return a(this,function(g){switch(g.label){case 0:return i=r.multipleSelectionEnabled,p=void 0===i||i,s=r.toggleToolOnClick,l=void 0===s||s,h=[],e.forEach(function(e){h.push(new c(e.geometry,e.symbol,e.attributes)),e.symbol=f._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e),d=[o.on("click",function(e){f._hitTest(_.createScreenPointFromEvent(e)).then(function(t){if(y){var r=t.results;if(!r.length)return void P(y);var o=y.activeComponent,i=e.native&&e.native.shiftKey;r.some(function(e){if(e.graphic){var t=e.graphic;if(p&&i&&o&&"box"===o.type&&!o.isUIGraphic(t))return y.addToSelection(t),!0;if(o&&"box"===o.type&&o.isUIGraphic(t))return!1!==l&&1===f.updateGraphics.length&&("extent"===f.updateGraphics.getItemAt(0).geometry.type?f._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):y.toggleTool()),!0;if(o&&"reshape"===o.type){if(t===o.graphic)return!1!==l&&y.toggleTool(),!0;if(o.isUIGraphic(t))return!0;if(t.layer===f._internalGraphicsLayer)return!0}else t.layer===f.layer&&P(y)}})?e.stopPropagation():P(y)}})}),o.on("key-down",function(e){return f._getCommonUpdateOperationKeyDownHandlers(y,e)}),o.on("key-down",function(e){if(e.key===V.constraintKey&&!e.repeat&&y){var t=y.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),o.on("key-up",function(e){if(e.key===V.constraintKey&&y){var t=y.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}})],"transform"!==t?[3,2]:[4,this._getBox(e,r,o)];case 1:return v=g.sent(),[3,4];case 2:return[4,this._getReshape(e,r,o)];case 3:v=g.sent(),g.label=4;case 4:return u=v,y=new O.OperationHandle({activeComponent:u,type:"update",onEnd:function(){m.forEach(function(e){return e.remove()}),d.forEach(function(e){return e.remove()}),m=[],d=[],y.activeComponent.destroy(),f._internalGraphicsLayer.removeMany(f.updateGraphics.toArray()),f.updateGraphics.forEach(function(e,t){h[t]&&h[t].symbol&&(e.symbol=h[t].symbol)})},undo:function(){k(y,f.updateGraphics.toArray()),y.refreshComponent(),f._emitUndoEvent({graphics:f.updateGraphics.toArray(),tool:y.tool})},redo:function(){L(y,f.updateGraphics.toArray()),y.refreshComponent(),f._emitRedoEvent({graphics:f.updateGraphics.toArray(),tool:y.tool})},addToSelection:function(e){var t=y.activeComponent;h.push(new c(e.geometry,e.symbol,e.attributes)),e.symbol=f._getUpdateSymbol(e.geometry),f.updateGraphics.add(e),t.graphics=f.updateGraphics.toArray(),t.refresh(),y.resetHistory(),f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=y.activeComponent,r=f.updateGraphics.indexOf(e);y.history.undo.forEach(function(e){return e.updates.splice(r,1)}),y.history.redo.forEach(function(e){return e.updates.splice(r,1)});var o=h.splice(r,1)[0];if(e.symbol=o.symbol,f.updateGraphics.remove(e),0===f.updateGraphics.length)return void P(y);t.graphics=f.updateGraphics.toArray()},toggleTool:function(){return n(f,void 0,void 0,function(){var t;return a(this,function(i){switch(i.label){case 0:return this.updateGraphics.length>1?[2]:(t=null,"transform"!==y.tool?[3,2]:[4,this._getReshape(e,r,o)]);case 1:return t=i.sent(),[3,4];case 2:return"reshape"!==y.tool?[3,4]:[4,this._getBox(e,r,o)];case 3:t=i.sent(),i.label=4;case 4:return y.activeComponent.destroy(),y.activeComponent=t,y.activeComponent&&(m.forEach(function(e){return e.remove()}),m=this._getHandlesForComponent(y)),[2]}})})}}),m=this._getHandlesForComponent(y),[2,y]}})})},l.prototype._getGraphicMover=function(t,r,o){return n(this,void 0,void 0,function(){var i,n,p,c=this;return a(this,function(a){switch(a.label){case 0:return i=r.enableMoveAllGraphics,n=void 0===i||i,[4,g.create(function(t){return e(["../../views/draw/support/GraphicMover"],t)})];case 1:return p=a.sent(),[2,new p({enableMoveAllGraphics:n,graphics:t,view:o,callbacks:{onGraphicMoveStart:function(e){var t=e.dx,r=e.dy,o=e.graphic;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-start"}})},onGraphicMove:function(e){var t=e.dx,r=e.dy,o=e.graphic;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move"}})},onGraphicMoveStop:function(e){var t=e.dx,r=e.dy,o=e.graphic;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-stop"}})},onGraphicPointerOver:function(e){return c._displayDefaultCursor()},onGraphicPointerOut:function(e){return c._displayDefaultCursor()}}})]}})})},l.prototype._getBox=function(t,o,i){return n(this,void 0,void 0,function(){var n,p,c,s,l,h,d,u=this;return a(this,function(a){switch(a.label){case 0:return n=o.enableRotation,p=void 0===n||n,c=o.enableScaling,s=void 0===c||c,l=o.preserveAspectRatio,h=void 0!==l&&l,[4,g.create(function(t){
return e(["../../views/draw/support/Box"],t)})];case 1:return d=a.sent(),[2,new d({graphics:t,enableRotation:p,enableScaling:s,preserveAspectRatio:h,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onMove:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onMoveStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScaleStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScale:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScaleStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotateStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotate:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotateStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})}}})]}})})},l.prototype._getReshape=function(t,o,i){return n(this,void 0,void 0,function(){var n,p,c,s=this;return a(this,function(a){switch(a.label){case 0:return n=o.enableMidpoints,p=void 0===n||n,[4,g.create(function(t){return e(["../../views/draw/support/Reshape"],t)})];case 1:return c=a.sent(),[2,new c({enableMidpoints:p,graphic:t[0],layer:this._internalGraphicsLayer,view:i,callbacks:{onReshapeStart:function(e){return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:r({},e)})},onReshape:function(e){return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:r({},e)})},onReshapeStop:function(e){var t=e.mover,r=e.type;return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{mover:t,type:r}})},onMoveStart:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onMove:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onMoveStop:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onVertexAdd:function(e){var t=e.added,r=e.type,o=t.map(function(e){return b.geometryToCoordinates(e.geometry)});s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{added:o,type:r}})},onVertexRemove:function(e){var t=e.removed,r=e.type,o=t.map(function(e){return b.geometryToCoordinates(e.geometry)});s._emitUpdateEvent({graphics:s.updateGraphics.toArray(),state:"active",tool:s.activeTool,toolEventInfo:{removed:o,type:r}})}}})]}})})},l.prototype._getHandlesForComponent=function(e){var t=this,r=e.activeComponent;switch(r.type){case"graphic-mover":return[r.on("graphic-move-start",function(t){return e.addToHistory(I(t.allGraphics))})];case"box":return[r.on("move-start",function(t){return e.addToHistory(I(t.graphics))}),r.on("rotate-start",function(t){return e.addToHistory(I(t.graphics))}),r.on("scale-start",function(t){return e.addToHistory(I(t.graphics))})];case"reshape":return[r.on("move-start",function(t){return e.addToHistory(I([t.mover]))}),r.on("reshape-start",function(t){return e.addToHistory(I([t.graphic]))}),r.on("vertex-add",function(t){return e.addToHistory(I([t.oldGraphic]))}),r.on("vertex-remove",function(t){return e.addToHistory(I([t.oldGraphic]))})];case"move-3d":return[r.on("graphic-move-start",function(r){e.addToHistory(I(r.allGraphics)),t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{dx:0,dy:0,mover:r.allGraphics.length>0?r.allGraphics[0]:null,type:"move-start"}})}),r.on("graphic-move",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"}})}),r.on("graphic-move-stop",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"}})}),r.on("click",function(){return e.toggleTool()})];case"transform-3d":return[r.on("graphic-translate-start",function(r){e.addToHistory(I([r.graphic])),t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:r.graphic,dx:0,dy:0,type:"move-start"}})}),r.on("graphic-translate-stop",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,dx:0,dy:0,type:"move-stop"}})}),r.on("graphic-rotate-start",function(r){e.addToHistory(R([r.graphic])),t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:r.graphic,angle:0,type:"rotate-start"}})}),r.on("graphic-rotate-stop",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,angle:0,type:"rotate-stop"}})}),r.on("graphic-scale-start",function(r){e.addToHistory(R([r.graphic])),t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:r.graphic,xScale:1,yScale:1,type:"scale-start"}})}),r.on("graphic-scale-stop",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,xScale:1,yScale:1,type:"scale-stop"}})}),r.on("graphic-translate",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dx,dy:e.dy,type:"move"}})}),r.on("graphic-rotate",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"}})}),r.on("graphic-scale",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"}})})];case"reshape-3d":return[r.on("reshape-start",function(r){if(e.addToHistory(I([r.graphic])),r.isDragging){var o=r.fromTranslation?{mover:r.graphic,dx:0,dy:0,type:"move-start"}:{mover:r.graphic,type:"reshape-start"};t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:o})}}),r.on("vertex-move",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,type:"reshape"}})}),r.on("translate",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"}})}),r.on("reshape-stop",function(e){if(e.isDragging){var r=e.fromTranslation?{mover:e.graphic,dx:0,dy:0,type:"move-stop"}:{mover:e.graphic,type:"reshape-stop"};t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:r})}}),r.on("vertex-add",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{added:e.coords,type:"vertex-add"}})}),r.on("vertex-remove",function(e){t._emitUpdateEvent({graphics:t.updateGraphics.toArray(),state:"active",tool:t.activeTool,toolEventInfo:{removed:e.coords,type:"vertex-remove"}})}),r.on("click",function(){return e.toggleTool()})];case"draw":return null;default:d.neverReached(r)}},l.prototype._setUpdateOperationHandle=function(e){var t=this;this._operationHandle=e;var r=this.view,o=r.map,i=r.popup,a=!0;i&&(a=i.autoOpenEnabled,i.autoOpenEnabled=!1);var n=function(){if(e===t._operationHandle){var r=e.cancelled?"cancel":"complete",n=t.updateGraphics.toArray(),p=t._operationHandle.tool;t._operationHandle.destroy(),t._operationHandle=null,t._internalGraphicsLayer.removeMany(t.updateGraphics.toArray()),t.updateGraphics.removeAll(),o&&o.remove(t._internalGraphicsLayer),i&&(i.autoOpenEnabled=a),t._emitUpdateEvent({graphics:n,state:r,tool:p,toolEventInfo:null})}};e.on("complete",n),e.on("cancel",n)},l.prototype._getCommonUpdateOperationClickHandlers=function(e,t,r){var o=this,i=_.createScreenPointFromEvent(t),a=this.view.toolViewManager.handlesClickEvent(t);this._hitTest(i).then(function(i){var n=i.results;if(!n.length&&!a)return void P(e);var p=t.native&&t.native.shiftKey,c=!r||!!r.multipleSelectionEnabled;if(n.some(function(t){if(t.graphic){var r=t.graphic;if(c&&p&&r.layer===o.layer)return-1===o.updateGraphics.indexOf(r)?e.addToSelection(r):e.removeFromSelection(r),!0}}))return void t.stopPropagation();if(!a){n.some(function(e){return e.graphic&&o.updateGraphics.indexOf(e.graphic)>-1})?t.stopPropagation():P(e)}})},l.prototype._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(e){var r=t.key;r===V.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):r===V.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):r===V.cancelKey&&P(e)}},l.prototype._getCreateSymbol=function(e,t){void 0===t&&(t=!1);var r="3d"!==this.view.type&&t;switch(e.type){case"point":case"multipoint":return r?this.activePointSymbol:this.pointSymbol;case"polyline":return r?this.activeLineSymbol:this.polylineSymbol;case"polygon":return r?this.activeFillSymbol:this.polygonSymbol}return null},l.prototype._getUpdateSymbol=function(e){switch(e.type){case"point":case"multipoint":return this.updatePointSymbol;case"polyline":return this.updatePolylineSymbol;case"polygon":case"extent":return this.updatePolygonSymbol}return null},l.prototype._drawMultipointGraphic=function(e,t){var r=null;if(!t&&e.length>1){var o=e.slice(0);o.pop(),r=H.createMultipoint(o,this.view.spatialReference)}else r=H.createMultipoint(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new c(r,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)},l.prototype._drawVertexGraphics=function(e,t,r){var o=!(!r||!r.userClicked),i="polygon"===e,a=i?this.polygonSymbol:this.polylineSymbol;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();var n=t[0],s=n[0],l=n[1],h=new p.Point(s,l,this.view.spatialReference),d=i?H.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):H.createPolyline([t],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=h:this._vertexGraphics.push(new c(h,this.activeVertexSymbol)),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new c(d,a)),o&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){var u=t[1],s=u[0],l=u[1],v=new p.Point(s,l,this.view.spatialReference),y=this.vertexSymbol,m=H.createPolyline([t],this.view.spatialReference,this._doUnnormalization),d=i?H.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):H.createPolyline([t],this.view.spatialReference,this._doUnnormalization);if(!this._vertexGraphics.length){var f=t[0],g=f[0],_=f[1],h=new p.Point(g,_,this.view.spatialReference),G=new c(h,y);this._vertexGraphics.push(G)}if(1===this._vertexGraphics.length){var w=this._vertexGraphics[0],b=new c(v,y);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(b),this._internalGraphicsLayer.remove(w),this._internalGraphicsLayer.add(w)}else this._vertexGraphics[1].geometry=v;this._showActiveLineGraphic(m);var E=this._vertexGraphics[0];o&&(this._activeLineGraphic.symbol=this.polylineSymbol,E.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new c(d,this.polygonSymbol)),this._internalGraphicsLayer.remove(E),this._internalGraphicsLayer.add(E)}else if(t.length>2){var d=i?H.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):H.createPolyline([t],this.view.spatialReference,this._doUnnormalization);"polygon"===e&&this._showFillGraphic(d);var S=t.map(function(e){return[e[0],e[1]]}),x=S.pop(),C=[S[S.length-1],x],A=H.createPolyline([S],this.view.spatialReference,this._doUnnormalization),T=H.createPolyline([C],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(A),this._showActiveLineGraphic(T);for(var U=0;U<S.length;U++){var O=this._vertexGraphics[U];if(O)o||U!==this._vertexGraphics.length-1?O.symbol=this.vertexSymbol:O.symbol=this.activeVertexSymbol;else{var k=t[U],s=k[0],l=k[1];this._showVertexGraphic(new p.Point(s,l,this.view.spatialReference))}}if(o){this._activeLineGraphic.symbol=this.polylineSymbol;var L=t[t.length-1],s=L[0],l=L[1];this._showVertexGraphic(new p.Point(s,l,this.view.spatialReference))}else this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=d:(this._removeCreateGraphic(),this._set("createGraphic",new c(d,a)));for(var I=0,R=this._vertexGraphics;I<R.length;I++){var G=R[I];this._internalGraphicsLayer.remove(G),this._internalGraphicsLayer.add(G)}}},l.prototype._drawSegmentGraphic=function(e,t,r){if(t.length){var o=H.createViewAlignedCoordinateSystem(this.view,t[0]),i=!(!r||!r.centered),a=!(!r||!r.constrained),n=null;if(1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?n=a?H.createSquare(t,o,i):H.createRectangle(t,o,i):"circle"===e&&(n=a?H.createEllipse(t,o,i):H.createCircle(t,o,i)),n.extent&&n.extent.center&&this._showCenterIndicatorGraphic(n.extent.center)),!n)return void this._removeCreateGraphic();this.createGraphic?this.createGraphic.geometry=n:(this._removeCreateGraphic(),this._set("createGraphic",new c(n,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic))}},l.prototype._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new c(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))},l.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},l.prototype._showActiveLineGraphic=function(e){this._activeLineGraphic?this._activeLineGraphic.geometry=e:(this._activeLineGraphic=new c(e,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))},l.prototype._showFillGraphic=function(e){this._activeFillGraphic?this._activeFillGraphic.geometry=e:(this._activeFillGraphic=new c(e,this._getCreateSymbol(e,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))},l.prototype._showLineGraphic=function(e){this._lineGraphic?this._lineGraphic.geometry=e:(this._lineGraphic=new c(e,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,0))},l.prototype._showVertexGraphic=function(e,t){var r=t?this.activeVertexSymbol:this.vertexSymbol,o=new c(e,r);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)},l.prototype._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()},l.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))},l.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},l.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},l.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},l.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},l.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(function(e){return e.destroy()}),this._vertexGraphics=[])},l.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)},l.prototype._operationHandleForCreateAction=function(e,t,r){var o=this;return new O.OperationHandle({activeComponent:this._draw,tool:r,type:"create",onEnd:function(){t.forEach(function(e){return e.remove()}),t.length=0,o._removeCreateOperationGraphics(),o._internalGraphicsLayer&&o._internalGraphicsLayer.remove(o.createGraphic),o._displayDefaultCursor()},undo:function(){e.undo(),o._emitUndoEvent({graphics:[o.createGraphic],tool:r})},redo:function(){e.redo(),o._emitRedoEvent({graphics:[o.createGraphic],tool:r})},canUndo:function(){return e&&e.canUndo()},canRedo:function(){return e&&e.canRedo()}})},l.prototype._snap=function(e,t,r){r&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)},l.prototype._snapLastPolygonVertexToFirst=function(e){if(!(e.length<=2)){var t=e[0],r=e[e.length-1],o=this.view.toScreen(new p.Point(t[0],t[1],this.view.spatialReference)),i=this.view.toScreen(new p.Point(r[0],r[1],this.view.spatialReference));this._isWithinScreenDistance(o,i,this._getVertexIntersectDistance())&&(r[0]=t[0],r[1]=t[1])}},l.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?_.pt2px(this.vertexSymbol.size)/2+3:3},l.prototype._isWithinScreenDistance=function(e,t,r){var o=e.x-t.x,i=e.y-t.y;return Math.sqrt(o*o+i*i)<=r},l.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],o=H.createViewAlignedCoordinateSystem(this.view,r),i=o.mapToLocal(r),a=o.mapToLocal(t),n=Math.abs(a.x-i.x),p=Math.abs(a.y-i.y),c=o.localToMap(H.makeSurfacePoint(n>p?a.x:i.x,n>p?i.y:a.y));e.push(c)}},l.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")},l.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},l.prototype._logError=function(e,t,r){M.error(new u(e,t,r))},l.prototype._sceneViewHighlightHandles=function(){var e=this,t=function(t,r){var o=e.view;if(o&&"2d"!==o.type){var i=o.allLayerViews.find(function(e){return e.layer.uid===r.uid});i&&(t.added.forEach(function(t){e._highlightHandlesByGraphic.add(i.highlight(t),t.uid)}),t.removed.forEach(function(t){e._highlightHandlesByGraphic.remove(t.uid)}))}};return[this.updateGraphics.on("change",function(r){t(r,e.layer)}),this._internalGraphicsLayer.graphics.on("change",function(r){t(r,e._internalGraphicsLayer)}),G.on(this,"view.allLayerViews","change",function(r){if(r.added)for(var o=0,i=r.added;o<i.length;o++){var a=i[o];a.layer===e.layer?t({added:e.updateGraphics.toArray(),removed:[]},a.layer):a.layer===e._internalGraphicsLayer&&t({added:e._internalGraphicsLayer.graphics.toArray(),removed:[]},a.layer)}})]},l.prototype._emitCreateEvent=function(e){this.emit("create",r({},e,{type:"create"}))},l.prototype._emitUpdateEvent=function(e){this.emit("update",r({},e,{type:"update"}))},l.prototype._emitResetEvent=function(){this.emit("reset",{type:"reset"})},l.prototype._emitUndoEvent=function(e){this.emit("undo",r({},e,{type:"undo"}))},l.prototype._emitRedoEvent=function(e){this.emit("redo",r({},e,{type:"redo"}))},i([w.property({dependsOn:["state"],readOnly:!0})],l.prototype,"_draw",null),i([w.property()],l.prototype,"_operationHandle",void 0),i([w.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],l.prototype,"activeTool",null),i([w.property()],l.prototype,"activeFillSymbol",void 0),i([w.property()],l.prototype,"activeLineSymbol",void 0),i([w.property()],l.prototype,"activePointSymbol",void 0),i([w.property()],l.prototype,"activeVertexSymbol",void 0),i([w.property({readOnly:!0})],l.prototype,"createGraphic",void 0),i([w.property()],l.prototype,"defaultUpdateOptions",void 0),i([w.property()],l.prototype,"layer",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"pointSymbol",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"polygonSymbol",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"polylineSymbol",void 0),i([w.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],l.prototype,"state",null),i([w.property({readOnly:!0})],l.prototype,"updateGraphics",void 0),i([w.property()],l.prototype,"updateOnGraphicClick",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"updatePointSymbol",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"updatePolygonSymbol",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"updatePolylineSymbol",void 0),i([w.property({types:s.symbolTypes})],l.prototype,"vertexSymbol",void 0),i([w.property()],l.prototype,"view",void 0),i([w.property()],l.prototype,"cancel",null),i([w.property()],l.prototype,"complete",null),i([w.property()],l.prototype,"create",null),i([w.property()],l.prototype,"reset",null),i([w.property()],l.prototype,"update",null),i([w.property()],l.prototype,"undo",null),i([w.property()],l.prototype,"redo",null),i([w.property()],l.prototype,"canUndo",null),i([w.property()],l.prototype,"canRedo",null),i([w.property()],l.prototype,"toggleUpdateTool",null),l=i([w.subclass("esri.widgets.Sketch.SketchViewModel")],l)}(w.declared(l,v))});