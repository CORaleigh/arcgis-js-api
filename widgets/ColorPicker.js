// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["../Color","./ColorPicker/HexPalette","./support/colorUtils","./Widgette","../core/lang","@dojo/framework/shim/array","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/i18n!./ColorPicker/nls/ColorPicker","dojo/i18n!../nls/common","dojo/text!./ColorPicker/templates/ColorPicker.html","dojo/NodeList-dom"],function(e,t,s,o,r,i,a,l,n,c,h,d,u,_,p,g){var C={root:"esri-color-picker",container:"esri-container",header:"esri-menu__header",footer:"esri-footer",middle:"esri-middle",swatch:"esri-swatch",swatchRow:"esri-swatch-row",swatchEmpty:"esri-swatch-empty",swatchPreview:"esri-swatch-preview",swatchTransparencyBackground:"esri-swatch-transparency-background",palette:"esri-palette",paletteOptions:"esri-palette-options",paletteToggle:"esri-palette-toggle",label:"esri-label",hexInput:"esri-hex-input",recent:"esri-recent",suggested:"esri-suggested",selected:"esri-selected",disabled:"esri-disabled",section:"esri-section",transparencySlider:"esri-transparency-slider",ticks:"esri-color-picker-ticks",alt:"esri-alt",hidden:"esri-hidden"};return o.createSubclass([a,l],{declaredClass:"esri.widgets.ColorPicker",templateString:g,labels:_,baseClass:C.root,css:C,constructor:function(e){e=e||{},this._brightsPalette=new t({colors:e.palette}),this._pastelsPalette=new t({colors:this._toPastels(this._brightsPalette.colors)}),this._activePalette=this._brightsPalette,this._swatches={}},buildRendering:function(){this.inherited(arguments),this._createPalettes(),this.required||(this._noColorSwatchNode=h.create("div",{className:C.swatch+" "+C.swatchEmpty},this.dap_hexInput,"after")),this._addTicks(this.dap_ticks),c.toggle(this.dap_transparencySection,C.hidden,!this.showTransparencySlider),c.toggle(this.dap_recentColorSection,C.hidden,!this.showRecentColors),c.toggle(this.dap_suggestedColorSection,C.hidden,!this.showSuggestedColors)},postCreate:function(){this.inherited(arguments),this._addListeners(),this._selectColor()},_activePalette:null,_brightsPalette:null,_pastelsPalette:null,_swatches:null,_noColorSwatchNode:null,_previousColor:null,properties:{color:{value:null,get:function(){var t=this._get("color");return null===t?null:new e(t)},set:function(t,o){if(t=t||null,o=o||void 0===o,!this.required){if(null===t)return this._set("color",null),this._previousColor=null,this.dap_transparencySlider.value=0,this._disableTransparencySlider(),this._clearSelection(),this._updateHexInput(null),this._updatePreviewSwatch(t),c.add(this._noColorSwatchNode,C.selected),void(o&&this.emit("color-change",{color:null}));this._enableTransparencySlider(),c.remove(this._noColorSwatchNode,C.selected)}var r,i=s.normalizeColor(t),a=this._previousColor;if(a){if(s.equal(a,i))return;var l=this._findColorSwatch(a);l&&(c.remove(l,C.selected),d.set(l,"borderColor",""))}r=new e(i),this._set("color",r),this._previousColor=i,this.dap_transparencySlider.value=1-r.a,this._updatePreviewSwatch(r),this._checkSelection(),this._updateHexInput(r),this.trackColors&&this._addRecentColor(r.toHex()),o&&this.emit("color-change",{color:new e(r)})}},colorsPerRow:{value:13,set:function(e){var t=e>0?e:13;this._set("colorsPerRow",t)}},palette:{set:function(e){var t=this._activePalette===this._brightsPalette;this._brightsPalette.colors=e,this._pastelsPalette.colors=this._toPastels(this._brightsPalette.colors),this._activePalette=t?this._brightsPalette:this._pastelsPalette,this._createPalettes(),this._togglePalette(!t)}},recentColors:{value:[],get:function(){return this._get("recentColors").map(function(e){return s.normalizeColor(e)})},set:function(e){var t=e||[];this.showRecentColors&&(t=t.map(function(e){return s.normalizeColor(e).toHex()})),this._set("recentColors",t),0===t.length?this._clearRecentSwatches():this._renderRecentSwatches()}},required:!1,showRecentColors:!0,showSuggestedColors:!1,showTransparencySlider:!0,suggestedColors:{value:null,get:function(){return this._get("suggestedColors").map(function(e){return s.normalizeColor(e)})},set:function(e){if(this.showSuggestedColors){this._clearSuggestedSwatches();var t=e||[];t=t.map(function(e){return s.normalizeColor(e).toHex()}),this._set("suggestedColors",t),t.length>0&&this._renderSuggestedSwatches()}}},trackColors:!0},addRecentColor:function(e){e&&null!==e&&this._addRecentColor(s.normalizeColor(e).toHex())},saveRecentColors:function(e){localStorage.setItem(e,JSON.stringify(this.get("recentColors")))},loadRecentColors:function(e){this.set("recentColors",JSON.parse(localStorage.getItem(e)))},_addTicks:function(e){var t=[0,50,100],s=document.createDocumentFragment();t.forEach(function(e){h.create("span",{innerHTML:r.substitute({percent:e},p.percent)},s)}),e.appendChild(s)},_toPastels:function(t){var s=new e([238,238,238]);return t.map(function(t){return e.blendColors(new e(t),s,.2)})},_createSwatch:function(e){var t=e.className,s=e.hexColor||"transparent",o=e.paletteNode;return h.create("span",{className:t,style:{backgroundColor:s}},o)},_createSwatches:function(e,t){var s;t.colors.forEach(function(t,o){var r;o%this.colorsPerRow==0&&(s=h.create("div",{className:C.swatchRow},e)),r=this._createSwatch({className:C.swatch,hexColor:t,paletteNode:s}),this._swatches[t]=r},this)},_selectColor:function(){this.set("color",this.required?this.color||this._activePalette.colors[0]:this.color)},_setColorWithCurrentAlpha:function(e){null!==e&&null!==this.color&&(e=s.normalizeColor(e),e.a=this.color.a),this.set("color",e)},_updatePreviewSwatch:function(e){var t,o=this.dap_previewSwatch;if(null===e)return c.add(o,C.swatchEmpty),void d.set(o,{backgroundColor:"",borderColor:""});t=s.getContrastingColor(e),c.remove(o,C.swatchEmpty),d.set(o,{backgroundColor:e.toCss(!0),borderColor:t.toCss(!0)})},_showBrights:function(){c.remove(this.dap_paletteContainer,C.alt),this._activePalette=this._brightsPalette},_showPastels:function(){c.add(this.dap_paletteContainer,C.alt),this._activePalette=this._pastelsPalette},_setColorFromSwatch:function(e){var t=d.get(e,"backgroundColor");this._setColorWithCurrentAlpha(t)},_checkSelection:function(){var e=this.get("color");this._activePalette.contains(e)?this._highlightColor(e):this._clearSelection()},_addListeners:function(){var e="."+C.swatch;this.own(u(this.dap_paletteContainer,u.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this)),u(this.dap_recentColorPalette,u.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this)),u(this.dap_suggestedColorPalette,u.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this))),this.required||this.own(u(this._noColorSwatchNode,"click",function(){this.set("color",null)}.bind(this)));var t=this.dap_hexInput;u(t,"blur",function(){var e=s.normalizeHex(t.value);if(s.isShorthandHex(e))return void this._setColorWithCurrentAlpha(e);this._updateHexInput(this.color)}.bind(this)),u(t,"change",function(){var e=s.normalizeHex(t.value);s.isLonghandHex(e)&&this.color.toHex()!==e&&this._setColorWithCurrentAlpha(e)}.bind(this)),u(this.dap_transparencySlider,"change, input",function(e){var t,o=this.get("color");null!==o&&(t=s.normalizeColor(o),t.a=1-e.target.value,this._updatePreviewSwatch(t),this._updateHexInput(t),this.set("color",t))}.bind(this)),u(this.dap_paletteToggle,n,function(e){var t="true"===e.target.getAttribute("aria-pressed");this._togglePalette(!t)}.bind(this))},_togglePalette:function(e){this.dap_paletteToggle.setAttribute("aria-pressed",e),e?this._showPastels():this._showBrights(),this._checkSelection()},_createPalettes:function(){this._swatches={},h.empty(this.dap_primaryPalette),h.empty(this.dap_secondaryPalette),this._createSwatches(this.dap_primaryPalette,this._brightsPalette),this._createSwatches(this.dap_secondaryPalette,this._pastelsPalette)},_updateHexInput:function(e){this.dap_hexInput.value=null===e?"":e.toHex()},_addRecentColor:function(e){if(e){var t=this.recentColors,s=t.indexOf(e);s>-1&&t.splice(s,1),t.unshift(e),t.length>this.colorsPerRow&&t.pop(),this._renderRecentSwatches()}},_renderRecentSwatches:function(){if(this.recentColors){var e=i.from(this.dap_recentColorPalette.getElementsByClassName(C.recent+" "+C.swatch));this.recentColors.forEach(function(t,s){if(s<this.colorsPerRow){if(s+1>e.length){var o=this._createSwatch({hexColor:t,className:C.swatch+" "+C.recent,paletteNode:this.dap_recentColorPalette});e.push(o)}d.set(e[s],"backgroundColor",t)}},this)}},_renderSuggestedSwatches:function(){if(this.suggestedColors){var e=i.from(this.dap_recentColorPalette.getElementsByClassName(C.suggested+" "+C.swatch));this.suggestedColors.forEach(function(t,s){if(s<this.colorsPerRow){if(s+1>e.length){var o=this._createSwatch({hexColor:t,className:C.swatch+" "+C.suggested,paletteNode:this.dap_suggestedColorPalette});e.push(o)}d.set(e[s],"backgroundColor",t)}},this)}},_clearRecentSwatches:function(){h.empty(this.dap_recentColorPalette)},_clearSuggestedSwatches:function(){h.empty(this.dap_suggestedColorPalette)},_clearSelection:function(){var e=this.dap_paletteContainer.getElementsByClassName(C.selected)[0];e&&e.classList.remove(C.selected)},_highlightColor:function(e){var t,o=this._findColorSwatch(e);o&&(e=s.normalizeColor(e),t=s.getContrastingColor(e),c.add(o,C.selected),d.set(o,"borderColor",t.toHex()))},_findColorSwatch:function(e){var t,o=this._activePalette.colors,r=s.toHex(e);return o.indexOf(r)>-1&&(t=this._swatches[r]),t},_enableTransparencySlider:function(){this.dap_transparencySlider.disabled=!1},_disableTransparencySlider:function(){this.dap_transparencySlider.disabled=!0}})});