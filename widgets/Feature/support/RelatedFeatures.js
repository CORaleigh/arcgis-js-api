// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../request","../../../core/Accessor","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../../../tasks/QueryTask","../../../tasks/support/Query","../../../tasks/support/StatisticDefinition","./featureUtils"],function(e,t,r,a,o,i,n,s,u,l,d,f,c,p){var y=new Map,I="esri.widgets.Popup.support.RelatedFeatures",h=s.getLogger(I);return function(e){function t(t){var r=e.call(this)||this;return r.relatedInfoCount=null,r.relatedInfos=new Map,r}return r(t,e),t.prototype.destroy=function(){this.relatedInfos.clear()},t.prototype.addRelatedFeatureAttributes=function(e){var t=this;this.relatedInfos.forEach(function(r){return t._addRelatedFeatureAttribute(e,r)})},t.prototype.getRelatedFieldInfo=function(e){if(-1===e.indexOf("relationships/"))return null;var t=e.split("/").slice(1);return{layerId:t[0],fieldName:t[1]}},t.prototype.getRelatedInfo=function(e){return this.relatedInfos.get(e.toString())},t.prototype.isRelatedField=function(e){return void 0===e&&(e=""),!!e&&-1!==e.indexOf("relationships/")},t.prototype.queryRelatedInfos=function(e,t){var r=this;this.relatedInfos.clear();var a=p.getSourceLayer(e);if(!a)return u.resolve();var o=t.filter(function(e){return e&&r.isRelatedField(e.fieldName)});return o&&o.length?(this._createRelatedInfos(t,a),this._queryLayerInfos(a).then(function(t){return r._updateRelatedInfoLayerInfos(t),r._queryRelatedFeatureMap(e).then(function(e){return Object.keys(e).forEach(function(t){r._setRelatedFeatures(e[t],t.toString())}),e})})):u.resolve()},t.prototype._addRelatedFeatureAttribute=function(e,t){var r=this;e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach(function(a){return r._addAttributesFromFeature(e,a,t)}),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach(function(a){return r._addAttributesFromFeature(e,a,t)}))},t.prototype._updateRelatedInfoLayerInfo=function(e,t){var r=e.value;if(r){this.getRelatedInfo(t).layerInfo=r.data}},t.prototype._updateRelatedInfoLayerInfos=function(e){var t=this;Object.keys(e).forEach(function(r){return t._updateRelatedInfoLayerInfo(e[r],r.toString())})},t.prototype._addAttributesFromFeature=function(e,t,r){var a=this;e&&t&&r&&Object.keys(t.attributes).forEach(function(o){var i=a._relatedFieldInfoToString({layerId:r.relation.id.toString(),fieldName:o});e[i]=t.attributes[o]})},t.prototype._relatedFieldInfoToString=function(e){return e?"relationships/"+e.layerId+"/"+e.fieldName:""},t.prototype._createRelatedInfoForFieldInfo=function(e,t){var r=this.getRelatedFieldInfo(e.fieldName);if(r){var a=r.layerId,o=r.fieldName;if(a){var i=this.getRelatedInfo(a)||this._createRelatedInfo(a,t);if(i&&(i.relatedFields.push(o),e.statisticType)){var n=new c({statisticType:e.statisticType,onStatisticField:o,outStatisticFieldName:o});i.outStatistics.push(n)}}}},t.prototype._createRelatedInfos=function(e,t){var r=this;e.forEach(function(e){return r._createRelatedInfoForFieldInfo(e,t)})},t.prototype._queryRelatedFeatureMap=function(e){var t=this,r={};return this.relatedInfos.forEach(function(a,o){a.layerInfo&&(r[o]=t._queryRelatedLayerFeatures(e,a))}),u.eachAlways(r)},t.prototype._queryLayerInfos=function(e){var t=this,r={};return this.relatedInfos.forEach(function(a,o){var i=a.relation;if(!i){var s=new n("relation-required","A relation is required on a layer to retrieve related records.");return h.error(s),u.reject(s)}var l=i.relatedTableId;if(!l){var s=new n("A related table ID is required on a layer to retrieve related records.");return h.error(s),u.reject(s)}var d=e.url+"/"+l,f=y.get(d),c=f||t._queryLayerInfo(d);f||y.set(d,c),r[o]=c}),u.eachAlways(r)},t.prototype._queryLayerInfo=function(e){return o(e,{query:{f:"json"}})},t.prototype._queryRelatedLayerFeatures=function(e,t){var r=p.getSourceLayer(e),a=r.layerId.toString(),o=t.layerInfo,i=t.queryTask,n=t.relation,s=this._getDestinationRelation(o,a);if(s){var l=n.keyField,d=s.keyField,c=this._getDestinationFieldType(o,s),y="string"===c?d+"='"+e.attributes[l]+"'":d+"="+e.attributes[l],I=i.execute(new f({where:y,outFields:t.relatedFields})),h=t.outStatistics&&t.outStatistics.length>0&&o.supportsStatistics,F=h?i.execute(new f({where:y,outFields:t.relatedFields,outStatistics:t.outStatistics})):null;return u.eachAlways({features:I,statsFeatures:F||u.resolve()})}return u.resolve()},t.prototype._setRelatedFeatures=function(e,t){var r=this.getRelatedInfo(t);if(r){var a=e.value;if(a){var o=a.features,i=a.statsFeatures,n=o&&o.value;r.relatedFeatures=n?n.features:[];var s=i&&i.value;r.relatedStatsFeatures=s?s.features:[]}}},t.prototype._getRelation=function(e,t){if("feature"!==t.type)return null;var r=null;return t.relationships.some(function(t){if(t.id===parseInt(e,10))return r=t,!0}),r},t.prototype._createRelatedInfo=function(e,t){var r=this._getRelation(e,t);if(r){var a=t.url+"/"+r.relatedTableId,o=new d({url:a}),i={url:a,queryTask:o,relation:r,relatedFields:[],outStatistics:[]};return this.relatedInfos.set(e,i),i}},t.prototype._getDestinationRelation=function(e,t){var r;return e&&e.relationships&&e.relationships.some(function(e){if(""+e.relatedTableId===t)return r=e,!0}),r},t.prototype._getDestinationFieldType=function(e,t){var r=void 0;return e.fields.some(function(e){if(e.name===t.keyField){return r=-1!==["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"].indexOf(e.type)?"number":"string",!0}}),r},a([l.aliasOf("relatedInfos.size")],t.prototype,"relatedInfoCount",void 0),a([l.property()],t.prototype,"relatedInfos",void 0),t=a([l.subclass(I)],t)}(l.declared(i))});