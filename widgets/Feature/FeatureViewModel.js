// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","dojo/i18n!dojo/cldr/nls/number","dojo/regexp","../../Graphic","../../core/asyncUtils","../../core/date","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/fieldUtils","../../popup/content/TextContent","../../popup/content/support/ChartMediaInfoValueSeries","../../popup/support/FieldInfoFormat","../../tasks/support/AttachmentQuery","./support/featureUtils","./support/RelatedFeatures","../support/widget"],function(e,t,r,i,o,a,n,s,u,l,p,c,f,d,h,y,m,_,v,g,F,b,I,A,x,T,E,C){function L(){return n(this,void 0,void 0,function(){return a(this,function(t){return[2,m.create(function(t){e(["../../support/arcadeUtils"],function(e){t(e)})})]})})}function w(e){var t=/(\n)/gi;return"string"==typeof e?e.replace(t,'<br class="esri-text-new-line" />'):e}function N(e,t){var r=t[e];if("string"==typeof r){var i=/\'/g,o=encodeURIComponent(r).replace(i,"&apos;");t[e]=o}}function R(e,t){return e&&"feature"===e.type?e.getField(t):null}function P(e){return(""+e).trim()}function S(e,t,r,i){return t=P(t),h.substitute(t&&"{"===t[0]?r:i,e)}function D(e){return e.replace(/[\u00A0-\u9999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var k=["$datastore","$map","$layer"],q=y.getLogger("esri.widgets.FeatureViewModel"),O=/^\s*expression\//i,j=new RegExp(""+u.escapeString(s.group),"g"),V=new f("cancelled-query","cancelled feature query"),U=c.getFormat("short-date-short-time"),H="DateFormat"+U;return function(e){function t(t){var r=e.call(this)||this;return r._handles=new d,r._featurePromise=void 0,r._layerDateFields=null,r._graphicChangedThrottled=_.throttle(r._graphicChanged,1,r),r._effectivePopupTemplate=null,r._contentResponse=null,r._graphic=null,r.content=null,r.defaultPopupTemplateEnabled=!1,r.formattedAttributes=null,r.graphic=null,r.lastEditInfo=null,r.spatialReference=null,r.title="",r.map=null,r._handles.add(v.init(r,["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled"],function(){return r._graphicChangedThrottled()})),r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._graphic=null,this._layerDateFields=null},Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featurePromise},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(){var e=this;this._cancelFeatureQuery(),this._clear();var t=this.graphic,r=t?t.clone():null;if(this._graphic=r,r){var i=T.getSourceLayer(r);this._layerDateFields=i?this._getDateFields(i):[];var o=!1,a=this._queryFeature().catch(function(e){e!==V&&q.error("error","error loading template",e)}).then(function(){o=!0,e._featurePromise=null,e.notifyChange("waitingForContent")});o||(this._featurePromise=a,this.notifyChange("waitingForContent"))}},t.prototype._cancelFeatureQuery=function(){var e=this._featurePromise;e&&"function"==typeof e.cancel&&e.cancel(V),this._featurePromise=null,this.notifyChange("waitingForContent")},t.prototype._compileContent=function(e,t){var r=this;return e&&(e.nodeName||e&&C.isWidgetBase(e)||C.isWidget(e))?e:"string"==typeof e?this._compileText(new b({text:e})).text:Array.isArray(e)?e.map(function(e,i){var o=t&&t[i],a=o&&o.value;return"attachments"===e.type?r._compileAttachments(e,a):"fields"===e.type?r._compileFields(e):"media"===e.type?r._compileMedia(e):"text"===e.type?r._compileText(e):void 0}):void(e&&q.warn("invalid content type."))},t.prototype._compileFields=function(e){var t=this,r=this._effectivePopupTemplate,i=h.clone(e),o=r&&r.expressionInfos,a=i.fieldInfos?void 0:r&&r.fieldInfos,n=i.fieldInfos||h.clone(a),s=[];return n&&n.forEach(function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(o,r):null;e.label=i?i.title:e.label,s.push(e)}}),i.fieldInfos=s,i},t.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,a=t.sourceURL;if(a){var n=this._fixTokens(a,i);t.sourceURL=this._substituteAttributes(r,n)}if(o){var s=this._fixTokens(o,i);t.linkURL=this._substituteAttributes(r,s)}},t.prototype._compileMedia=function(e){var t=this,r=this,i=r._layerDateFields,o=r._graphic,a=h.clone(e),n=a.mediaInfos,s=o.attributes,u=T.getSourceLayer(o),l=this.formattedAttributes.global,p={dateFormat:{properties:i,formatter:H}};return a.mediaInfos=n&&n.map(function(e){var r=h.clone(e);if(r){var i=r.title?t._processFieldsInLinks(r.title,s):"",o=r.caption?t._processFieldsInLinks(r.caption,s):"";if(r.title=i?t._substituteAttributes(l,i,p):"",r.caption=o?t._substituteAttributes(l,o,p):"","image"===r.type){var a=r.value;return t._setImageValue({value:a,formattedAttributes:l,layer:u}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){var a=r.value;return t._setChartValue({value:a,attributes:s,formattedAttributes:l,layer:u}),r}}}).filter(Boolean),a},t.prototype._substituteAttributes=function(e,t,r){return P(this._removeEmptyHref(h.substitute(e,t,r)))},t.prototype._compileText=function(e){var t=this,r=t._layerDateFields,i=t._graphic,o=h.clone(e);if(o&&o.text){var a=i.attributes,n=this.formattedAttributes.global,s={dateFormat:{properties:r,formatter:H}},u=this._processFieldsInLinks(o.text,a);o.text=this._substituteAttributes(n,u,s)}return o},t.prototype._formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,o=e.editorField,a=e.editDateField;if(t){var n=t[a];if("number"==typeof n){var s=t[o],u=h.substitute({myKey:n},"{myKey:"+H+"}");return{type:"edit",date:u,user:s}}var l=t[i];if("number"==typeof l){var p=t[r],u=h.substitute({myKey:l},"{myKey:"+H+"}");return{type:"create",date:u,user:p}}}},t.prototype._compileLastEditInfo=function(){var e=this,t=e._effectivePopupTemplate,r=e._graphic;if(t){var i=t.lastEditInfoEnabled,o=r.get("sourceLayer.editFieldsInfo");if(i&&o)return this._formatEditInfo(o,r.attributes)}},t.prototype._compileTitle=function(){var e=this,t=e._effectivePopupTemplate,r=e._layerDateFields,i=e._graphic,o=t&&t.title,a=i.attributes,n={dateFormat:{properties:r,formatter:H}},s=this.formattedAttributes.global;if("function"==typeof o)return o.call(null,{graphic:i});if("string"==typeof o&&o){var u=this._processFieldsInLinks(o,a);return this._substituteAttributes(s,u,n)}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(O,"").toLowerCase();return e.some(function(e){if(e.name.toLowerCase()===i)return r=e,!0}),r}},t.prototype._fixTokens=function(e,t){var r=/(\{([^\{\r\n]+)\})/g;return e.replace(r,function(e,r,i){var o=R(t,i);return o?"{"+o.name+"}":r})},t.prototype._encodeAttributes=function(e){var t=e?h.clone(e):{};return Object.keys(t).forEach(function(e){return N(e,t)}),t},t.prototype._formatAttributesToFieldInfos=function(e,t,r){var i=this,o=h.clone(this._layerDateFields);e.forEach(function(a){var n=i._getFixedFieldName(a.fieldName,t);if(a.fieldName=n,r[n]=i._formatValue(r[n],{fieldInfos:e,fieldName:n,layer:t}),o&&a.format&&a.format.dateFormat){var s=o.indexOf(n);s>-1&&o.splice(s,1)}})},t.prototype._formatAttributes=function(e){var t=this,r=this._graphic,i=T.getSourceLayer(r),o=r.attributes;return this.addRelatedFeatureAttributes(o),Object.keys(o).forEach(function(e){var r=o[e];null!=r&&(o[e]=t._getDomainName(e,r)||t._getTypeName(e)||w(r))}),e&&this._formatAttributesToFieldInfos(e,i,o),o},t.prototype._formatValue=function(e,t){var r=this._layerDateFields,i={dateFormat:{properties:r,formatter:H}},o=t.fieldInfos,a=t.fieldName,n=this._getFieldInfo(o,a),u=h.clone(n),l=t.preventPlacesFormatting,p=t.layer,f=R(p,a);if(f&&"date"===f.type){var d=u.format||new A;d.dateFormat=d.dateFormat||"short-date-short-time",u.format=d}var y=u&&u.format;if(null==e||!u||null==y)return e;var m=[],_=!y.dateFormat&&(y.hasOwnProperty("places")||y.hasOwnProperty("digitSeparator")),v=!_||!y.hasOwnProperty("digitSeparator")||y.digitSeparator,g=_&&null!=y.places&&(!l||y.places>0);_&&g&&m.push("places: "+Number(y.places));var F=_?g?"NumberFormat("+m.join(",")+")":"NumberFormat":y.dateFormat?"DateFormat"+(c.getFormat(y.dateFormat)||U):void 0;if(!F)return e;var b=h.substitute({myKey:e},"{myKey:"+F+"}",i)||"";return _&&!v&&s.group?b.replace(j,""):b},t.prototype._getDomainName=function(e,t){if(this.isRelatedField(e))return null;var r=this._graphic,i=T.getSourceLayer(r);if(!i||"feature"!==i.type)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some(function(e){if(e.fieldName&&e.fieldName.toLowerCase()===r)return i=e,!0}),i}},t.prototype._getTypeName=function(e){if(this.isRelatedField(e))return null;var t=this._graphic,r=T.getSourceLayer(t);if(!r||"feature"!==r.type)return null;if(e!==r.typeIdField)return null;var i=r.getFeatureType(t);return i?i.name:null},t.prototype._removeEmptyHref=function(e){var t=/href=(""|'')/gi;return e.replace(t,"")},t.prototype._processFieldsInLinks=function(e,t){var r=this.get("_graphic.layer"),i=this._fixTokens(e,r),o=this._encodeAttributes(t),a=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return i?i.replace(a,function(e,r,i){return S(e,r||i,t,o)}):i},t.prototype._compileAttachments=function(e,t){var r=h.clone(e);return!t||t&&0===t.length?r:(r.attachmentInfos=t,r)},t.prototype._queryAttachments=function(){var e=this._graphic,t=T.getSourceLayer(e);if(!t)return m.resolve([]);var r="scene"===t.type&&t.associatedLayer?t.associatedLayer:t;if(r&&"feature"===r.type){var i=r,o=i.objectIdField,a=e.attributes,n=a&&a[o],s=new x({objectIds:[n],returnMetadata:!0});return i.queryAttachments(s).then(function(e){return e[n]||[]})}return m.resolve([])},t.prototype._queryContentElements=function(e){var t=this;if(!Array.isArray(e))return m.resolve();var r={};return e.forEach(function(e,i){if("attachments"===e.type){var o=t._queryAttachments();o&&(r[i]=o)}}),Object.keys(r).length?m.eachAlways(r):m.resolve()},t.prototype._getContent=function(){var e=this,t=e._effectivePopupTemplate,r=e._graphic,i=t&&t.content,o="function"==typeof i?i.call(null,{graphic:r}):i;return m.isThenable(o)?o:m.resolve(o)},t.prototype._querySourceLayer=function(e){var t=e.layer,r=e.outFields,i=e.objectIds,o=t.createQuery();return o.objectIds=i,o.outFields=r,o.returnGeometry=!0,t.queryFeatures(o).then(function(e){return e.features[0]})},t.prototype._queryRequiredFieldsFeature=function(){var e=this,t=this,r=t._graphic,i=t._effectivePopupTemplate,o=r.sourceLayer;return o&&"function"==typeof o.queryFeatures&&i?("function"==typeof o.load?o.load():m.resolve()).then(function(){var t=r.attributes[o.objectIdField];return p.safeCast(i.getRequiredFields(o.fields)).then(function(i){return F.featureHasFields(i,r)||"number"!=typeof t?null:e._querySourceLayer({layer:o,outFields:i,objectIds:[t]})})}):m.resolve(null)},t.prototype._queryFeature=function(){var e=this,t=this._graphic;return this._effectivePopupTemplate=t&&t.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled),this._getContent().then(function(r){var i=e._checkForRelatedFeatures(r),a=e._createFormattedExpressions().then(function(e){t.attributes=o({},t.attributes,e)}),n=e._queryContentElements(r).then(function(t){return e._contentResponse=t}),s=e._queryRequiredFieldsFeature().then(function(e){e&&(t.geometry=e.geometry,t.attributes=o({},t.attributes,e.attributes))});return m.eachAlways([i,a,n,s]).then(function(){e._set("formattedAttributes",e._createFormattedAttributes(r)),e._set("title",e._compileTitle());var t=e._compileLastEditInfo();e._set("lastEditInfo",t||null);var i=e._compileContent(r,e._contentResponse);return e._set("content",i||null),i})})},t.prototype._isExpressionField=function(e){return O.test(e)},t.prototype._getDateFields=function(e){var t=e.fields;return t?t.filter(function(e){return"date"===e.type}).map(function(e){return e.name}):[]},t.prototype._formatArcadeArray=function(e){return'<ul class="esri-widget__list">'+e.map(function(e){return"<li>"+("string"==typeof e?D(e):e)+"</li>"}).join("")+"</ul>"},t.prototype._formatArcadeDictionary=function(e){return'<table class="esri-widget__table">'+e.keys().map(function(t){var r=e.field(t);return"<tr><th>"+t+"</th><td>"+("string"==typeof r?D(r):r)+"</td></tr>"}).join("")+"</table>"},t.prototype._createFormattedExpressions=function(){return n(this,void 0,void 0,function(){var e,t,r,i,o,s,u,l,p,c,f,d=this;return a(this,function(h){switch(h.label){case 0:return e=this,t=e._effectivePopupTemplate,r=e._graphic,i=t&&t.expressionInfos,o=[],s={},i&&i.length?[4,L()]:[2,s];case 1:for(u=h.sent(),l=function(e){var t="expression/"+e.name,i=u.createSyntaxTree(e.expression),l=k.filter(function(e){return u.hasVariable(i,e)}),p=u.loadScriptDependencies(i,!0,l).then(function(){return n(d,void 0,void 0,function(){var e,o,n,p,c=this;return a(this,function(a){return e=this.spatialReference,o=u.getViewInfo({spatialReference:e}),n=u.createExecContext(r,o),n.useAsync=!0,this._addVarsToContext(u,l,n,o),p=u.createFunction(i,n),[2,u.executeAsyncFunction(p,n).then(function(e){s[t]="string"==typeof e?D(e):Array.isArray(e)?c._formatArcadeArray(e):e&&"esri.arcade.Dictionary"===e.declaredClass?c._formatArcadeDictionary(e):e},function(e){return q.error("arcade-execution-error",e)})]})})});o.push(p)},p=0,c=i;p<c.length;p++)f=c[p],l(f);return[2,m.eachAlways(o).then(function(){return s})]}})})},t.prototype._addVarsToContext=function(e,t,r,i){var o=this,a=o.graphic,n=o.map;t.forEach(function(t){var o=t.toLowerCase(),s={map:n,spatialReference:i.sr};"$map"===o&&(r.vars[o]=e.convertMapToFeatureSetCollection(s)),"$layer"===o&&(r.vars[o]=e.convertFeatureLayerToFeatureSet(a.sourceLayer,i.sr)),"$datastore"===o&&(r.vars[o]=e.convertServiceUrlToWorkspace(a.sourceLayer.url,i.sr))})},t.prototype._createFormattedAttributes=function(e){var t=this,r=this._effectivePopupTemplate,i=r&&r.fieldInfos,o={global:this._formatAttributes(i),content:[]};return Array.isArray(e)&&e.forEach(function(e,r){"fields"===e.type&&e.fieldInfos&&(o.content[r]=t._formatAttributes(e.fieldInfos))}),o},t.prototype._getAllFieldInfos=function(e){var t=this._effectivePopupTemplate,r=[],i=t&&t.fieldInfos;return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach(function(e){if("fields"===e.type){var t=e&&e.fieldInfos;r.push.apply(r,t)}}),r):r},t.prototype._checkForRelatedFeatures=function(e){var t=this._graphic,r=this._getAllFieldInfos(e);return this.queryRelatedInfos(t,r)},t.prototype._getChartOption=function(e){var t=e.value,r=e.attributes,i=e.formattedAttributes,o=e.fieldName,a=e.relatedFieldName,n=e.fieldInfos,u=e.index,l=this._graphic,p=T.getSourceLayer(l),c=t.normalizeField,f=t.tooltipField,d=c?this.isRelatedField(c)?r[this.getRelatedFieldInfo(c).fieldName]:r[c]:null,h=a&&void 0!==r[a]?r[a]:void 0!==r[o]?r[o]:i[o],y="string"==typeof h&&s.group?parseFloat(h.replace(j,"")):h,m=void 0===y?null:y&&d?y/d:y,_=new I({x:u,y:m});if(this.isRelatedField(o)){var v=this.getRelatedFieldInfo(o),g=this.getRelatedFieldInfo(f),F=g?g.fieldName:null,b=this._formatValue(m,{fieldInfos:n,fieldName:a,layer:p,preventPlacesFormatting:!!d}),A=v?v.label||v.fieldName:a,x=F&&void 0!==r[F]?r[F]:A;return _.tooltip=x+": "+b,_}var E=this._getFieldInfo(n,o),C=this._getFixedFieldName(o,p),L=E?E.label||E.fieldName:o,w=f&&void 0!==i[f]?i[f]:L,N=i[C];return _.tooltip=w+": "+N,_},t.prototype._getFixedFieldName=function(e,t){var r=R(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map(function(e){return r._getFixedFieldName(e,t)})},t.prototype._setChartValue=function(e){var t=this,r=e.value,i=e.attributes,o=e.formattedAttributes,a=e.layer,n=this,s=n._effectivePopupTemplate,u=n.relatedInfoCount,l=r.fields,p=r.normalizeField;if(r.fields=this._getFixedFieldNames(l,a),p&&(r.normalizeField=this._getFixedFieldName(p,a)),l.some(function(e){return!!(null!=o[e]||t.isRelatedField(e)&&u)})){var c=s&&s.fieldInfos;l.forEach(function(e,a){if(t.isRelatedField(e))return void(r.series=r.series.concat(t._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:o,value:r})));var n=t._getChartOption({value:r,index:a,attributes:i,formattedAttributes:o,fieldName:e,fieldInfos:c});r.series.push(n)})}},t.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,a=e.value,n=[],s=this.getRelatedFieldInfo(i),u=s.layerId,l=s.fieldName,p=this.getRelatedInfo(u);if(!p)return n;var c=p.relatedFeatures,f=p.relation;if(!f||!c)return n;var d=f.cardinality;return c.forEach(function(e,s){var u=e.attributes;u&&Object.keys(u).forEach(function(e){e===l&&n.push(t._getChartOption({value:a,index:s,attributes:u,formattedAttributes:o,fieldName:i,relatedFieldName:e,fieldInfos:r}))})}),"one-to-many"===d||"many-to-many"===d?n:[n[0]]},i([g.property({readOnly:!0})],t.prototype,"content",void 0),i([g.property({type:Boolean})],t.prototype,"defaultPopupTemplateEnabled",void 0),i([g.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([g.property({type:l})],t.prototype,"graphic",void 0),i([g.property({readOnly:!0})],t.prototype,"lastEditInfo",void 0),i([g.property()],t.prototype,"spatialReference",void 0),i([g.property({readOnly:!0})],t.prototype,"title",void 0),i([g.property()],t.prototype,"map",void 0),i([g.property({readOnly:!0})],t.prototype,"waitingForContent",null),t=i([g.subclass("esri.widgets.FeatureViewModel")],t)}(g.declared(E))});