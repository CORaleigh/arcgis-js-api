// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["./Widgette","../core/numberUtils","../renderers/support/utils","../widgets/RendererSlider","../widgets/RendererSlider/sliderUtils","../Color","dijit/_TemplatedMixin","dojo/debounce","dojo/dom-style","dojo/dom-construct","dojo/dom-class","dojox/gfx","dojo/text!./UnivariateColorSizeSlider/templates/UnivariateColorSizeSlider.html"],function(i,t,e,s,a,o,l,r,n,h,m,u,d){return i.createSubclass([l],{_rampNode:null,_sliderHeight:null,_barsGroup:null,_updateTimer:null,_css:null,_defaultHeight:200,_handles:[0,1],declaredClass:"esri.widgets.UnivariateColorSizeSlider",templateString:d,properties:{visualVariables:[],values:null,minValue:{dependsOn:["statistics"],get:function(){return this.get("statistics.min")||0},set:function(i){if(void 0===i)return this._clearOverride("minValue");this._override("minValue",i)}},maxValue:{dependsOn:["statistics"],get:function(){return this.get("statistics.max")||100},set:function(i){if(void 0===i)return this._clearOverride("maxValue");this._override("maxValue",i)}},minSize:null,maxSize:null,histogram:null,statistics:null,zoomOptions:null,histogramVisible:!0,statisticsVisible:!0,labelsVisible:!0,ticksVisible:!0,handlesVisible:!0,histogramWidth:100,rampWidth:26,symbolWidth:50},constructor:function(){this._css={container:"esri-color-and-size-slider",handlerTickSize:"esri-handler-tick-size"},this._attachSymbols=r(this._attachSymbols,0)},postCreate:function(){this.inherited(arguments),this._setUpDataDefaults()},startup:function(){this.inherited(arguments),this._slider=new s({type:"UnivariateColorSizeSlider",values:this.values,isDate:this.isDate,minimum:this.zoomOptions?this.zoomOptions.minSliderValue:this.minValue,maximum:this.zoomOptions?this.zoomOptions.maxSliderValue:this.maxValue,_minZoomLabel:this.zoomOptions?this.minValue:null,_maxZoomLabel:this.zoomOptions?this.maxValue:null,_isZoomed:!!this.zoomOptions,labelsVisible:this.labelsVisible,ticksVisible:this.ticksVisible,handlesVisible:this.handlesVisible,handles:this._handles},this._sliderNode),this._slider.startup(),this._rampNode=this._slider._sliderAreaRight,this._sliderHeight=n.get(this._rampNode,"height")||this._defaultHeight,this._createSVGSurfaces(),this._slider.on("slide",function(i){this._colorInfoAutoAdjust(),this._fillRamp(i.values)}.bind(this)),this._slider.on("data-change",function(i){var t=i.values,e=this._getSizeVisualVariable();e.minDataValue=t[0],e.maxDataValue=t[1],this.values=t,this._colorInfoAutoAdjust(),this._fillRamp(),this.emit("data-change",{})}.bind(this)),this._slider.on("handle-value-change",function(i){var t=i.values,e=this._getSizeVisualVariable();e.minDataValue=t[0],e.maxDataValue=t[1],this.values=t,this._updateRendererSlider(),this.emit("handle-value-change",{})}.bind(this)),this._slider.on("data-value-change",function(i){var t=i.min,e=i.max;this.set({minValue:t,maxValue:e}),this._updateRendererSlider(),this.emit("data-value-change",{})}.bind(this)),this._slider.on("stop",function(){this.emit("handle-value-change",{})}.bind(this)),this._slider.on("zoom-out",function(){this.zoomOptions=null}.bind(this)),this.statistics&&this.statisticsVisible&&this._generateStatistics(),this.histogramVisible&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram(),this.watch("minValue, maxValue, symbol, visualVariables, minSize, maxSize, statistics, histogram, zoomOptions",this._updateTimeout),this.watch("histogramVisible",this._toggleHistogram),this.watch("zoomOptions",this._zoomEventHandler)},destroy:function(){this._slider&&this._slider.destroy(),this._avgHandleObjs&&this._avgHandleObjs.avgHandleTooltip&&this._avgHandleObjs.avgHandleTooltip.destroy(),this.countTooltips&&this.countTooltips.forEach(function(i){i.destroy()})},refresh:function(){this._updateTimeout()},_updateTimeout:function(){this._updateRendererSlider()},_updateRendererSlider:function(){var i=this._getSizeVisualVariable();this.set({minSize:i.minSize,maxSize:i.maxSize,values:[i.minDataValue,i.maxDataValue]}),this.minValue===this.maxValue&&(0===this.minValue?this.set({maxValue:100,values:[20,80]}):null===this.minValue?this.set({minValue:0,maxValue:100,values:[20,80]}):this.set({minValue:0,maxValue:2*this.minValue,values:[this.maxValue/5,this.maxValue/5*4]})),null!==this.zoomOptions&&!1!==this.zoomOptions?(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue,this._slider.set({minimum:this.zoomOptions.minSliderValue,maximum:this.zoomOptions.maxSliderValue})):(this._slider.set({minimum:this.minValue,maximum:this.maxValue}),this._minZoomLabel=null,this._maxZoomLabel=null,this._isZoomed=!0),this._slider.set("values",this.values),this._slider._reset(),this._slider._updateRoundedLabels(),this._slider._generateMoveables(),this._clearRect(),this._createSVGSurfaces(),this.statistics&&this.statisticsVisible&&this._generateStatistics(),this.histogramVisible&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram()},_zoomEventHandler:function(){this.emit("zoom",{zoomed:!!this.zoomOptions})},_setUpDataDefaults:function(){var i=this._getSizeVisualVariable();this.set({minSize:i.minSize,maxSize:i.maxSize}),null!==this.zoomOptions&&!1!==this.zoomOptions&&(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue),null===i.minDataValue&&null===i.maxDataValue||0===i.minDataValue&&0===i.maxDataValue?null===this.minValue&&null===this.maxValue&&this.set({minValue:0,maxValue:100,values:[20,80]}):this.minValue===this.maxValue?0===this.minValue?this.set({maxValue:100,values:[20,80]}):null===this.minValue?this.set({minValue:0,maxValue:100,values:[20,80]}):this.set({minValue:0,maxValue:2*this.minValue,values:[this.maxValue/5,this.maxValue/5*4]}):this.values=[i.minDataValue,i.maxDataValue],null===this.minValue&&(this.minValue=0),null===this.maxValue&&(this.maxValue=100)},_colorInfoAutoAdjust:function(){var i=this._getColorVisualVariable(),t=i.stops,s=t.length-1,a=this._slider.values,o=t[0].value=a[0],l=t[s].value=a[1],r=(t||[]).map(function(i,t){return{value:o*(s-t)/s+l*t/s,index:t}});e.updateColorStops({stops:t,changes:r,isDate:this.isDate})},_getSizeVisualVariable:function(){var i;return this.visualVariables.some(function(t){if("size"===t.type)return i=t,!0}),i},_getColorVisualVariable:function(){var i;return this.visualVariables.some(function(t){if("color"===t.type)return i=t,!0}),i},_createSVGSurfaces:function(){this._proportionalSymbolSurface=u.createSurface(this._rampNode,this.rampWidth,this._sliderHeight),this._surfaceRect=this._proportionalSymbolSurface.createRect({width:this.rampWidth,height:this._sliderHeight}),this._histogramSurface=a.generateHistogramSurface(this._rampNode,this.histogramWidth,this._sliderHeight,this.rampWidth),this._fillRamp(),this._attachSymbols()},_attachSymbols:function(){this._attachSymbol(this._slider.moveables[0],this.minSize,"min"),this._attachSymbol(this._slider.moveables[1],this.maxSize,"max")},_attachSymbol:function(i,t){var e,s=n.get(i.handleContainer,"height"),a=this.symbol||{type:"custom"};switch(i.symbol||(i.symbol=h.create("div",{style:"position: absolute; left: 10px;"},i)),a.type){case"simple-line":e=t===this.minSize?5:13,this._generateLineSymbol(i,e,s);break;case"simple-marker":default:e=t===this.minSize?12:48,this._generateCircleSymbol(i.symbol,e,s)}return i.symbol},_generateLineSymbol:function(i,t,e){var s,a=i.tick,l=i.symbol;return m.add(a,this._css.handlerTickSize),n.set(l,"top",e/2-t+"px"),n.set(l,"height",2*t+"px"),n.set(l,"width",t-4+"px"),l.innerHTML="",s=u.createSurface(l),s.rawNode.style.position="absolute",s.rawNode.style.top=1===t?"1px":t/2+"px",this.isLeftToRight()||(s.rawNode.style.left="-45px"),s.setDimensions(this.rampWidth,t),s.createRect({width:this.rampWidth,height:t}).setFill(new o([0,0,0,.4])),s},_generateCircleSymbol:function(i,t,e){var s,a=t/2,l=12===t,r=this.isLeftToRight();return n.set(i,"top",e/2-(a+1)+"px"),n.set(i,"height",2*(a+1)+"px"),n.set(i,"width",l?2*(a+1):a+"px"),n.set(i,"left",l?"8px":"10px"),i.innerHTML="",s=u.createSurface(i),s.rawNode.style.position="absolute",this.isLeftToRight()||(s.rawNode.style.left=l?"-35px":"-53px"),l?(s.setDimensions(2*(a+1),2*(a+1)),s.createCircle({cx:7,cy:a+1,r:a}).setFill(new o([0,0,0,.4])).setStroke("#FFF")):(s.setDimensions(a+1,2*(a+1)),s.createCircle({cx:r?0:23,cy:a+1,r:a}).setFill(new o([0,0,0,.2])).setStroke("#FFF")),s},_fillRamp:function(i){var t,e=this._getGradientColorStops(),s=this._slider,a=this._sliderHeight,o=i?i[0]:s.values[0],l=i?i[1]:s.values[1],r=Math.round(a-(o-s.minimum)/(s.maximum-s.minimum)*a),h=Math.round(a-(l-s.minimum)/(s.maximum-s.minimum)*a),m=this.rampWidth,d=this.isLeftToRight();d?(this._proportionalSymbolSurface.clear(),this._proportionalSymbolSurface.createPath().moveTo(m,0).lineTo(m,h).lineTo(10,r).lineTo(10,a).lineTo(0,a).lineTo(0,0).closePath().setStroke("#FFF").setFill({type:"linear",x1:0,y1:0,x2:0,y2:a,colors:e})):(this._proportionalSymbolSurface.clear(),this._proportionalSymbolSurface.createPath().moveTo(m,0).lineTo(m,a).lineTo(m-10,a).lineTo(m-10,r).lineTo(0,h).lineTo(0,0).closePath().setStroke("#FFF").setFill({type:"linear",x1:0,y1:0,x2:0,y2:a,colors:e})),n.set(this._proportionalSymbolSurface.rawNode,"overflow","visible"),n.set(this._proportionalSymbolSurface.rawNode,"background-color","#d9d9d9"),t={color:"#FFF",width:3},null!==this.zoomOptions&&!1!==this.zoomOptions&&(this.toggleSliderBottom&&this.toggleSliderTop?(this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke(t).setTransform(u.matrix.translate(0,5)),this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke(t).setTransform(u.matrix.translate(0,195))):this.toggleSliderBottom?this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke(t).setTransform(u.matrix.translate(0,195)):this.toggleSliderTop&&this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke(t).setTransform(u.matrix.translate(0,5)))},_getGradientColorStops:function(){var i=this._getColorVisualVariable(),t=this._slider.minimum,e=this._slider.maximum;return i.stops.slice().map(function(i){return{color:i.color,offset:(e-i.value)/(e-t)}}).reverse()},_clearRect:function(){this._proportionalSymbolSurface.destroy(),this._histogramSurface.destroy()},_showHistogram:function(){this.histogram||this.zoomOptions&&this.zoomOptions.histogram?this._generateHistogram():this._barsGroup&&(this._barsGroup.destroy(),this._barsGroup=null)},_toggleHistogram:function(){this.histogramVisible?(n.set(this._barsGroup.rawNode,"display","inline-block"),this._showHistogram()):n.set(this._barsGroup.rawNode,"display","none")},_generateHistogram:function(){var i=this.zoomOptions&&this.zoomOptions.histogram?this.zoomOptions.histogram:this.histogram;this._barsGroup=a.generateHistogram(this._histogramSurface,i,this.histogramWidth,this.rampWidth,this.isLeftToRight()),this.countTooltips=a.generateCountTooltips(i,this._barsGroup)},_generateStatistics:function(){if(!(this.statistics.count<2||isNaN(this.statistics.avg))){var i,e,s,o,l=this.statistics,r=this._slider,n=this.zoomOptions||null,h=a.getPrecision(this.maxValue);l.min===l.max&&l.min===l.avg?(s=0,o=2*l.avg):(s=l.min,o=l.max),s===r.minimum&&o===r.maximum||(s=r.minimum,o=r.maximum),n&&(s=n.minSliderValue,o=n.maxSliderValue),i=this._sliderHeight*(o-l.avg)/(o-s),e=t.round([l.avg,o,s])[0],this._avgHandleObjs=a.generateAvgLine(this._histogramSurface,e,i,h,this.isLeftToRight(),this.isDate)}}})});