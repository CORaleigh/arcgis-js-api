// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["./_DelayedUpdate","./support/colorRampUtils","./support/schemeUtils","@dojo/framework/shim/array","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/i18n!./nls/SymbolStyler","dojo/text!./templates/ColorRampPicker.html","dojo/NodeList-dom","dijit/form/Button"],function(e,t,s,i,r,o,c,a,h,n,l,d,m){var p={root:"esri-color-ramp-picker",item:"esri-item",text:"esri-icon-font-fallback-text",selected:"esri-selected",container:"esri-container",list:"esri-list",preview:"esri-preview",flipper:"esri-flipper",flipIcon:"esri-icon-up-down-arrows",viewport:"esri-viewport"},_={default:{height:70,width:20},preview:{height:180,width:20}};return o.createSubclass([r,c,e],{baseClass:p.root,declaredClass:"esri.widgets.SymbolStyler.ColorRampPicker",templateString:m,labels:d,css:p,constructor:function(){this._colorRampSurfaces=[],this._commitPropsTrigger=this.createUpdateTrigger(this._commitProperties,this)},postCreate:function(){this.inherited(arguments),this._addHandlers()},destroy:function(){this.inherited(arguments),this._colorRampSurfaces.forEach(function(e){e.destroy()}),this._previewRampSurface&&this._previewRampSurface.destroy()},_schemesChanged:!1,_selectedChanged:!1,_numStopsChanged:!1,_orientationChanged:!1,_commitPropsTrigger:null,_colorRampSurfaces:null,_previewRampSurface:null,_rampsAndSchemes:null,numStops:0,_setNumStopsAttr:function(e){e=e>0?e:0,this._numStopsChanged=!0,this._set("numStops",e),this._buildRampsAndSchemes(),this._commitPropsTrigger()},schemes:null,_setSchemesAttr:function(e){this._schemesChanged=!0,this._set("schemes",e),this._buildRampsAndSchemes(),this._commitPropsTrigger()},selected:null,_getSelectedAttr:function(){var e=this.selected;return{colors:s.createColors(e.colors)}},_setSelectedAttr:function(e){Array.isArray(e)&&(e={colors:e}),e.colors||(e.colors=this._rampsAndSchemes[0].colors),this._selectedChanged=!0,this._set("selected",e),this._commitPropsTrigger(),this.emit("color-ramp-change",this.get("selected"))},flipColors:function(){var e=this._rampsAndSchemes,t=this.selected;-1===this._getSuggestions().indexOf(t.colors)&&t.colors.reverse(),e.forEach(function(e){s.flipColors(e.scheme)}),this._orientationChanged=!0,this.set("selected",t),this._commitPropsTrigger()},_buildRampsAndSchemes:function(){this.schemes&&(this._rampsAndSchemes=s.getColorRampsWithSchemes(this.schemes,this.numStops))},_commitProperties:function(){var e,t;(this._schemesChanged||this._numStopsChanged)&&(this._schemesChanged=!1,this._numStopsChanged=!1,e=this._rampsAndSchemes,t=this._hasStops(),h.empty(this.dap_colorRampPicker),this._colorRampSurfaces=[],e.forEach(function(e){this._createColorRampItem({colors:e.colors,hasStops:t})},this),this._renderSuggestions()),this._selectedChanged&&(this._selectedChanged=!1,this._renderSelected()),this._orientationChanged&&(this._orientationChanged=!1,this._renderSelected(),this._renderSuggestions()),this.selected||this.set("selected",this._rampsAndSchemes[0])},_hasStops:function(){return this.numStops>0},_createColorRampItem:function(e){var s=e.colors,i=e.numClasses,r=h.create("div",{className:p.item,tabIndex:0},this.dap_colorRampPicker),o=n.get(r,"height")||_.default.height,c=n.get(r,"width")||_.default.width,a=t.createColorRamp({node:r,width:c,height:o,colors:s,numClasses:i});this._colorRampSurfaces.push(a)},_renderSuggestions:function(){var e=this._colorRampSurfaces,s=this._rampsAndSchemes,i=this._hasStops();e.forEach(function(e,r){t.updateColorRamp({ramp:e,colors:s[r].colors,hasStops:i})})},_renderSelected:function(){var e=this.selected.colors,s=this.dap_previewRamp,i=n.get(s,"height")||_.preview.height,r=n.get(s,"width")||_.preview.width,o=e,c=this._hasStops();this._previewRampSurface?t.updateColorRamp({ramp:this._previewRampSurface,colors:o,hasStops:c}):this._previewRampSurface=t.createColorRamp({node:s,height:i,width:r,colors:o,hasStops:c})},_getSuggestions:function(){return this._rampsAndSchemes.map(function(e){return e.colors})},_addHandlers:function(){var e="."+p.item,t=this;this.own(l(this.dap_colorRampPicker,l.selector(e,a),function(){t._rampClickHandler.call(this,t)})),this.own(l(this.dap_colorFlipper,a,function(){this.flipColors()}.bind(this)))},_rampClickHandler:function(e){var t=p.selected,s=this,r=i.from(e.dap_colorRampPicker.getElementsByClassName(p.item)),o=r.indexOf(s);r.forEach(function(e){e.classList.remove(t)}),s.classList.add(t),e.set("selected",e._rampsAndSchemes[o])}})});