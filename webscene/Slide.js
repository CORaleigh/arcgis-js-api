// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../Basemap","../Viewpoint","../core/Collection","../core/collectionUtils","../core/JSONSupport","../core/lang","../core/Logger","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../core/libs/gl-matrix-2/vec3","../core/libs/gl-matrix-2/vec3f64","../layers/Layer","../support/basemapUtils","../views/3d/support/mathUtils","../webdoc/support/Thumbnail","./Environment","./Lighting","./support/Description","./support/SlideGround","./support/Title"],function(e,t,n,i,r,o,a,s,l,p,u,c,d,y,h,m,f,v,g,b,w,L,T,_,S,C){function A(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers}function U(e){var t=A(e);if(t)return t.filter(function(e){return e.visible}).map(function(e){return e.id}).toArray()}function j(e,t){var n=t-e;return n>H&&(n-=R),n<-H&&(n+=R),n}function I(e,t){return b.moduloPositive(e+t,R)}var V=0,x=function(e){function t(t){var n=e.call(this)||this;return n.id="",n.sublayerIds=null,n}i(t,e),n=t,t.prototype.clone=function(){return new n({id:this.id,sublayerIds:u.clone(this.sublayerIds)})};var n;return r([y.property({type:String,json:{write:!0}})],t.prototype,"id",void 0),r([y.property({type:[Number],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],t.prototype,"sublayerIds",void 0),t=n=r([y.subclass("esri.webscene.VisibleLayer")],t)}(y.declared(p)),q=s.ofType(x),E=c.getLogger("esri.webscene.Slide"),D=function(e){function t(t){var n=e.call(this,t)||this;return n._currentAnimation=null,n.id=Date.now().toString(16)+"-slide-"+V++,n.title=new C.default,n.description=new _.default,n.thumbnail=new w.default,n.viewpoint=null,n.basemap=null,n.ground=null,n.environment=new L,n.visibleLayers=new q,n}return i(t,e),t.prototype.castTitle=function(e){return"string"==typeof e?new C.default({text:e}):h.ensureType(C.default,e)},t.prototype.castDescription=function(e){return"string"==typeof e?new _.default({text:e}):h.ensureType(_.default,e)},t.prototype.castThumbnail=function(e){return"string"==typeof e?new w.default({url:e}):h.ensureType(w.default,e)},t.prototype.castBasemap=function(e){return g.ensureType(e)},Object.defineProperty(t.prototype,"visibleLayers",{set:function(e){this._set("visibleLayers",l.referenceSetter(e,this._get("visibleLayers"),q))},enumerable:!0,configurable:!0}),t.prototype.castVisibleLayers=function(e){return e&&"function"==typeof e.map?e.map(function(e){if("string"==typeof e)return{id:e};if(e instanceof v){var t=U(e);return{id:e.id,sublayerIds:t}}return e.id?{id:e.id,sublayerIds:e.sublayerIds}:(E.warn('Invalid visible layer, expected { id }, Layer or "id"'),e)}):null},t.prototype.clone=function(){return new(0,this.constructor)({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})},t.prototype._updateVisibleLayersFrom=function(e){var t=this,n=[];return d.eachAlways(this._allLayers(e.map).map(function(t){return e.whenLayerView(t).then(function(e){if(e.visible){var i=U(t);n.push(new x({id:e.layer.id,sublayerIds:i}))}})}).toArray()).then(function(){t.visibleLayers.removeAll(),t.visibleLayers.addMany(n)})},t.prototype.updateFrom=function(e,t){var i=this;return t={screenshot:n({format:"jpeg",quality:80,width:120,height:75,disableSlice:!0},t&&t.screenshot)},e.when(function(){return i.viewpoint=e.viewpoint.clone(),i.environment.lighting=T.prototype.clone.apply(e.environment.lighting),i.basemap=e.map.basemap&&e.map.basemap.clone()||null,i.ground=e.map.ground?S.default.fromGround(e.map.ground):null,i._updateVisibleLayersFrom(e)}).then(function(){return e.takeScreenshot(t.screenshot)}).then(function(e){return i.thumbnail=new w.default({url:e.dataUrl}),i})},t.prototype.applyTo=function(e,t){var i=this,r=n({animate:!0},t);return this._applyBasemap(e).then(function(){return d.all([i._applyViewpoint(e,r),i._applyLayerVisibility(e),i._applyGround(e)])}).then(function(){return i})},t.prototype._applyBasemap=function(e){var t=this;return this.basemap?this.basemap.load().catch(function(e){return e}).then(function(){e.map.basemap=g.clonePreservingTiledLayers(t.basemap,e.map.basemap)}):d.resolve()},t.prototype._applyGround=function(e){return this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground)),d.resolve()},t.prototype._allLayers=function(e){var t=new s;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t},t.prototype._collectLayers=function(e,t){var n=this;e.layers.forEach(function(e){t.add(e);var i=e;i.layers&&n._collectLayers(i,t)})},t.prototype._applyLayerVisibility=function(e){var t=this;if(this.visibleLayers){this._allLayers(e.map).forEach(function(e){var n=t.visibleLayers.find(function(t){return t.id===e.id});e.visible=null!=n;var i=n&&n.sublayerIds,r=A(e);i&&r&&r.forEach(function(e){return e.visible=i.indexOf(e.id)>=0})})}},t.prototype._applyViewpoint=function(e,t){if(this.viewpoint&&!t.ignoreViewpoint){if(this.viewpoint.camera.fov=e.camera.fov,t.animate)return this.get("environment.lighting.date")?this._animateToLighting(e,t):(e.environment.lighting=this.environment.lighting.clone(),e.goTo(this.viewpoint,t));e.viewpoint=this.viewpoint,e.environment.lighting=this.environment.lighting.clone()}else e.environment.lighting=this.environment.lighting.clone();return d.resolve()},t.prototype._animateToLighting=function(e,t){var n,i=this;"global"===e.viewingMode&&(n=this._animateLightingWithCamera(e)),this._currentAnimation&&(this._currentAnimation.cancel(),this._currentAnimation=null),e.environment.lighting.cameraTrackingEnabled=!1,e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);var r=e.goTo(this.viewpoint,t);return this._currentAnimation=r,this._currentAnimation.catch(function(e){return e}).then(function(){n&&n.remove(),i._currentAnimation===r&&(e.environment.lighting.cameraTrackingEnabled=!0)}),this._currentAnimation.then(function(){e.environment.lighting=i.environment.lighting.clone()}),this._currentAnimation},t.prototype._getTime=function(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]},t.prototype._setTime=function(e,t,n){return e.setTime(t),e.setUTCHours(n/3600),e.setUTCMinutes(n%3600/60),e.setUTCSeconds(n%3600%60),e},t.prototype._animateLightingWithCamera=function(e){var t=this,n=new Date(e.environment.lighting.date.toString()),i=this._getTime(n),r=i[0],o=i[1],a=this._getTime(this.environment.lighting.date),s=a[0],l=a[1],p=j(o,l),u=e.renderCoordsHelper,c=f.vec3f64.create();u.toRenderCoords(e.camera.position,c);var d=f.vec3f64.create();u.toRenderCoords(this.viewpoint.camera.position,d);var y=f.vec3f64.create(),h=new Date;return e.watch("camera",function(n){u.toRenderCoords(n.position,y);var i=m.vec3.squaredDistance(c,y),a=m.vec3.squaredDistance(d,y),l=0;i+a!==0&&(l=i/(i+a));var f=r+(s-r)*l,v=I(o,p*l);e.environment.lighting.date=t._setTime(h,f,v)})},t.createFrom=function(e,t){return(new this).updateFrom(e,t)},r([y.property({type:String,json:{write:{isRequired:!0}}})],t.prototype,"id",void 0),r([y.property({type:C.default,json:{default:function(){return new C.default({text:""})},write:{isRequired:!0}}})],t.prototype,"title",void 0),r([y.cast("title")],t.prototype,"castTitle",null),r([y.property({type:_.default,json:{write:{overridePolicy:function(e){return{enabled:!(!e||!e.text)}}}}})],t.prototype,"description",void 0),r([y.cast("description")],t.prototype,"castDescription",null),r([y.property({type:w.default,json:{default:function(){return new w.default({url:""})},write:{isRequired:!0}}})],t.prototype,"thumbnail",void 0),r([y.cast("thumbnail")],t.prototype,"castThumbnail",null),r([y.property({type:a,nonNullable:!0,json:{write:{isRequired:!0}}})],t.prototype,"viewpoint",void 0),r([y.property({type:o,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],t.prototype,"basemap",void 0),r([y.cast("basemap")],t.prototype,"castBasemap",null),r([y.property({type:S.default,json:{write:!0}})],t.prototype,"ground",void 0),r([y.property({type:q,json:{write:{isRequired:!0}}})],t.prototype,"visibleLayers",null),r([y.cast("visibleLayers")],t.prototype,"castVisibleLayers",null),r([y.property({type:L,json:{write:!0}})],t.prototype,"environment",void 0),t=r([y.subclass("esri.webscene.Slide")],t)}(y.declared(p)),R=86400,H=43200;return D});