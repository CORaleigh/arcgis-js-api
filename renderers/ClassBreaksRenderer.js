// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../symbols","../symbols","../core/kebabDictionary","../core/lang","../core/Logger","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesRenderer","./support/ClassBreakInfo","./support/LegendOptions","../support/arcadeUtils","../symbols/support/jsonUtils"],function(e,t,r,o,l,n,a,s,i,p,u,c,y,f,d,m,b,h,g,v,k){var B=c.getLogger("esri.renderers.ClassBreaksRenderer"),I=new p.default({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),S=f.ensureType(h.ClassBreakInfo);return function(e){function t(t){var r=e.call(this)||this;return r.backgroundFillSymbol=null,r.classBreakInfos=null,r.defaultLabel=null,r.defaultSymbol=null,r.field=null,r.isMaxInclusive=!0,r.legendOptions=null,r.normalizationField=null,r.normalizationTotal=null,r.type="class-breaks",r.valueExpression=null,r.valueExpressionTitle=null,r._set("classBreakInfos",[]),r}r(t,e),p=t,t.prototype.readClassBreakInfos=function(e,t,r){if(Array.isArray(e)){var o=t.minValue;return e.map(function(e){var t=new h.ClassBreakInfo;return t.read(e,r),null==t.minValue&&(t.minValue=o),null==t.maxValue&&(t.maxValue=t.minValue),o=t.maxValue,t})}},t.prototype.writeClassBreakInfos=function(e,t,r,o){var l=e.map(function(e){return e.write({},o)});this._areClassBreaksConsecutive()&&l.forEach(function(e){return delete e.classMinValue}),t[r]=l},Object.defineProperty(t.prototype,"compiledFunc",{get:function(){return v.createFunction(this.valueExpression)},enumerable:!0,configurable:!0}),t.prototype.readDefaultSymbol=function(e,t,r){return k.read(e,t,r)},t.prototype.writeDefaultSymbolWebScene=function(e,t,r,o){k.writeTarget(e,t,r,o)},t.prototype.writeDefaultSymbol=function(e,t,r,o){k.writeTarget(e,t,r,o)},t.prototype.castField=function(e){return null==e?e:"function"==typeof e?(B.error(".field: field must be a string value"),null):f.ensureString(e)},Object.defineProperty(t.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalizationType",{get:function(){var e=this._get("normalizationType"),t=!!this.normalizationField,r=null!=this.normalizationTotal;return t||r?(e=t&&"field"||r&&"percent-of-total"||null,t&&r&&B.warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==e&&"percent-of-total"!==e||(e=null),e},set:function(e){this._set("normalizationType",e)},enumerable:!0,configurable:!0}),t.prototype.addClassBreakInfo=function(e,t,r){var o=null;o="number"==typeof e?new h.ClassBreakInfo({minValue:e,maxValue:t,symbol:r}):S(u.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},t.prototype.removeClassBreakInfo=function(e,t){for(var r=this.classBreakInfos.length,o=0;o<r;o++){var l=[this.classBreakInfos[o].minValue,this.classBreakInfos[o].maxValue];if(l[0]===e&&l[1]===t){this.classBreakInfos.splice(o,1);break}}},t.prototype.getBreakIndex=function(e,t){var r=this.field,o=e.attributes,l=this.isMaxInclusive,n=null;if(this.valueExpression)n=v.executeFunction(this.compiledFunc,v.createExecContext(e,v.getViewInfo(t)));else{n=parseFloat(o[r]);var a=this.normalizationType;if(a){var s=this.normalizationTotal,i=parseFloat(o[this.normalizationField]);if("log"===a)n=Math.log(n)*Math.LOG10E;else if("percent-of-total"!==a||isNaN(s)){if("field"===a&&!isNaN(i)){if(isNaN(n)||isNaN(i))return-1;n/=i}}else n=n/s*100}}if(null!=n&&"number"==typeof n&&!isNaN(n))for(var p=0;p<this.classBreakInfos.length;p++){var u=[this.classBreakInfos[p].minValue,this.classBreakInfos[p].maxValue];if(u[0]<=n&&(l?n<=u[1]:n<u[1]))return p}return-1},t.prototype.getClassBreakInfo=function(e,t){var r=this.getBreakIndex(e,t);return-1!==r?this.classBreakInfos[r]:null},t.prototype.getSymbol=function(e,t){var r=this.getBreakIndex(e,t);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol},t.prototype.getSymbols=function(){var e=[];return this.classBreakInfos.forEach(function(t){t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.clone=function(){return new p({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:u.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:u.clone(this.visualVariables),legendOptions:u.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},t.prototype.collectRequiredFields=function(e,t){return a(this,void 0,void 0,function(){return n(this,function(r){switch(r.label){case 0:return[4,this.collectVVRequiredFields(e,t)];case 1:return r.sent(),d.collectField(e,t,this.field),d.collectField(e,t,this.normalizationField),[4,d.collectArcadeFieldNames(e,t,this.valueExpression)];case 2:return r.sent(),[2]}})})},t.prototype._areClassBreaksConsecutive=function(){for(var e=this.classBreakInfos,t=e.length,r=1;r<t;r++)if(e[r-1].maxValue!==e[r].minValue)return!1;return!0};var p;return o([y.property({types:{base:s.BaseSymbol,key:"type",typeMap:{"simple-fill":i.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":i.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":i.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{read:k.read,write:{target:{backgroundFillSymbol:{type:s.PolygonSymbol3D}},writer:k.writeTarget}}},read:k.read,write:k.writeTarget}})],t.prototype,"backgroundFillSymbol",void 0),o([y.property({type:[h.ClassBreakInfo]})],t.prototype,"classBreakInfos",void 0),o([y.reader("classBreakInfos")],t.prototype,"readClassBreakInfos",null),o([y.writer("classBreakInfos")],t.prototype,"writeClassBreakInfos",null),o([y.property({dependsOn:["valueExpression"]})],t.prototype,"compiledFunc",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),o([y.property({types:i.symbolTypesRenderer})],t.prototype,"defaultSymbol",void 0),o([y.reader("defaultSymbol")],t.prototype,"readDefaultSymbol",null),o([y.writer("web-scene","defaultSymbol",{defaultSymbol:{types:i.symbolTypesRenderer3D}})],t.prototype,"writeDefaultSymbolWebScene",null),o([y.writer("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"field",void 0),o([y.cast("field")],t.prototype,"castField",null),o([y.property({type:Boolean})],t.prototype,"isMaxInclusive",void 0),o([y.property({type:g.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),o([y.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],t.prototype,"minValue",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"normalizationField",void 0),o([y.property({type:Number,cast:function(e){return f.ensureNumber(e)},json:{write:!0}})],t.prototype,"normalizationTotal",void 0),o([y.property({type:I.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:I.jsonValues,read:I.read,write:I.write}})],t.prototype,"normalizationType",null),o([y.enumeration.serializable()({classBreaks:"class-breaks"})],t.prototype,"type",void 0),o([y.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),o([y.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),o([l(2,y.cast(i.ensureType))],t.prototype,"addClassBreakInfo",null),t=p=o([y.subclass("esri.renderers.ClassBreaksRenderer")],t)}(y.declared(m,b))});