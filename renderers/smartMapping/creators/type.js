// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","dojo/i18n!../../nls/smartMapping","../..","../../../pointCloudRenderers","../../../core/lang","../../../core/promiseUtils","./support/utils","../statistics/uniqueValues","../support/utils","../symbology/type","../../support/LegendOptions","../../support/utils"],function(e,r,l,t,o,n,a,i,s,u,d,c,p,y){function m(e){if(!e||!e.layer||!e.field&&!e.valueExpression)return i.reject(s.createError("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required"));if(e.valueExpression&&!e.view)return i.reject(s.createError("type-renderer:missing-parameters","View is required when 'valueExpression' is specified"));var r=l({},e);r.symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.sortEnabled=null==r.sortEnabled||r.sortEnabled,r.statistics=a.clone(r.statistics);var t=[0,2,1,3],o=d.createLayerAdapter(r.layer,t);return r.layer=o,o?o.load().then(function(){var e=o.geometryType,l=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(l&&("polyline"===e||"polygon"===e))return i.reject(s.createError("type-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))return i.reject(s.createError("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var t=d.getFieldsList({field:r.field,valueExpression:r.valueExpression}),n=s.verifyBasicFieldValidity(o,t,"type-renderer:invalid-parameters");return n?i.reject(n):r}):i.reject(s.createError("type-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(t).join(", ")))}function f(e){if(!(e&&e.layer&&e.field))return i.reject(s.createError("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required"));var r=l({},e);r.statistics=a.clone(r.statistics);var t=[4],o=d.createLayerAdapter(r.layer,t);return r.layer=o,r.density=r.density||25,r.size=r.size||"100%",s.isValidPointSize(r.size)?o?o.load().then(function(){var e=d.getFieldsList({field:r.field}),l=s.verifyBasicFieldValidity(o,e,"type-point-cloud-class-renderer:invalid-parameters");return l?i.reject(l):r}):i.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(t).join(", "))):i.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function v(e){var r=e.typeScheme,l=e.basemap;if(r)r=c.cloneScheme(r);else{var t=c.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=t&&t.primaryScheme,l=t&&t.basemapId}return{scheme:r,basemapId:l}}function b(e,r){return e.label<r.label?-1:e.label>r.label?1:0}function h(e,r){return e.value<r.value?-1:e.value>r.value?1:0}function g(e,r){var l=r.count-e.count;return 0===l&&(l=b(e,r)),l}function T(e,r){var l=r.count-e.count;return 0===l&&(l=h(e,r)),l}function S(e,r,l){var t;"count"===r?(t=T,l&&l.codedValues&&(t=g)):"value"===r&&(t=h,l&&l.codedValues&&(t=b)),t&&e.sort(t)}function E(e,r){var n,a=e.uniqueValueInfos,i=r.layer,u=r.field,d=u?i.getField(u):null,m=d?i.getFieldDomain(d.name):null,f=-1===r.numTypes?a.length:r.numTypes,b=i.geometryType,h=v({basemap:r.basemap,geometryType:b,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view}),g=h.scheme,T=new o.UniqueValueRenderer({field:u}),E=-1,x={value:null,domain:m,fieldInfo:d};if(a.forEach(function(e,r){x.value=e.value,e.label=y.createUniqueValueLabel(x),null===e.value&&(E=r)}),E>-1&&(n=a.splice(E,1)[0]),!1!==r.sortEnabled&&S(a,r.sortBy,m),d&&d.type===V){var I=a.filter(function(e,r){return r<f}),M=I.map(function(e){return e.value});x.dateFormatInterval=y.calculateDateFormatInterval(M)}var w=s.createColors(g.colors,a.length),q=s.getSymbolSizeFromScheme(g,b),j=s.getSymbolOutlineFromScheme(g,b);a.forEach(function(e,l){x.value=e.value,e.label=y.createUniqueValueLabel(x),e.symbol=s.createSymbol(b,{type:r.symbolType,color:w[l],size:q,outline:j,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})}),r.valueExpression&&(T.valueExpression=r.valueExpression,T.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(T.legendOptions=new p.LegendOptions(r.legendOptions)),w=s.createColors(g.colors,f);for(var z=0;z<f;z++){var L=a[z];L&&T.addUniqueValueInfo({value:L.value,label:L.label,symbol:s.createSymbol(b,{type:r.symbolType,color:w[z],size:q,outline:j,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})})}r.defaultSymbolEnabled&&(T.defaultSymbol=s.createSymbol(b,{type:r.symbolType,color:g.noDataColor,size:q,outline:j,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),T.defaultLabel=t.other),n&&(n.symbol=s.createSymbol(b,{type:r.symbolType,color:g.noDataColor,size:q,outline:j,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),a.push(n));var C=[],F=T.uniqueValueInfos.length===a.length?-1:T.uniqueValueInfos.length;if(F>-1)for(var z=F;z<a.length;z++)C.push(l({},a[z]));return{renderer:T,uniqueValueInfos:a,excludedUniqueValueInfos:C,typeScheme:c.cloneScheme(g),basemapId:h.basemapId}}function x(e,r){var l=e.uniqueValueInfos,t=v({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r}),o=t&&t.scheme,n="point-cloud-class"===o.theme,a=n?o.colors:s.createColors(o.colors,l.length);return S(l,"value"),l.map(function(e,r){var l=e.value,t=null;return n?(t=a[l])||(t=a[a.length-1]):t=a[r],{values:[l],color:t,label:e.label}})}function I(e){return m(e).then(function(e){return(null!=e.statistics?i.resolve(e.statistics):u({layer:e.layer,field:e.field,valueExpression:e.valueExpression,returnAllCodedValues:e.returnAllCodedValues,view:e.view})).then(function(r){return E(r,e)})})}function M(e){return f(e).then(function(e){return(null!=e.statistics?i.resolve(e.statistics):u({layer:e.layer,field:e.field})).then(function(r){return{renderer:new n.PointCloudUniqueValueRenderer({field:e.field,pointsPerInch:e.density,pointSizeAlgorithm:s.getPointSizeAlgorithm(e.size),colorUniqueValueInfos:x(r,e.typeScheme)})}})})}Object.defineProperty(r,"__esModule",{value:!0});var V="date";r.createRenderer=I,r.createPCClassRenderer=M});