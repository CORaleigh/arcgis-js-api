// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/promiseUtils","../../utils","../../../../support/heatmapUtils","../../../../../support/arcadeUtils","../../../../../tasks/support/ClassBreaksDefinition","../../../../../tasks/support/generateRendererUtils"],function(a,e,n,t,r,i,o,l){function u(a,e){var n=a&&a.features,t=n&&n[0]&&n[0].attributes,r={};for(var i in t)r[i.replace(w,"").toLowerCase()]=t[i];return r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),e&&(["min","max","avg","stddev","sum","variance"].forEach(function(a){null!=r[a]&&(r[a]=Math.ceil(r[a]))}),r.min===r.max&&null!=r.min&&(r.avg=r.min,r.stddev=r.variance=0)),r}function s(a,e,n){var t=m(a,e);t=c(t,a.minValue,a.maxValue);var r=f(t,!a.normalizationType);return n&&["avg","stddev","variance"].forEach(function(a){null!=r[a]&&(r[a]=Math.ceil(r[a]))}),r}function c(a,e,n){return e=null==e?-1/0:e,n=null==n?1/0:n,a.filter(function(a){if(null!=a&&D(a)&&a>=e&&a<=n)return a})}function m(a,e){var n=a.field,t="function"==typeof n,r=a.valueExpression,o=i.createFunction(r),l=a.normalizationType,u=a.normalizationField,s=a.normalizationTotal,c=[],m=a.view,f=m&&i.getViewInfo({viewingMode:"2d"===m.type?"map":m.viewingMode,scale:m.scale,spatialReference:m.spatialReference});return e?(e.forEach(function(a){var e,m=a.attributes;if(r){var v=i.createExecContext(a,f);e=i.executeFunction(o,v)}else t?e=n.call(null,a):m&&(e=m[n]);if(l&&null!=e&&D(e)){var d=m&&parseFloat(m[u]);"log"===l&&0!==e?e=Math.log(e)*Math.LOG10E:"percent-of-total"===l&&D(s)&&0!==s?e=e/s*100:"field"===l&&D(d)&&0!==d&&(e/=d)}c.push(e)}),c):c}function f(a,e){for(var n=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=a;u<s.length;u++){var c=s[u];r+=c,n=Math.min(n,c),t=Math.max(t,c)}var m=a.length;if(m){i=r/m;for(var f=0,v=0,d=a;v<d.length;v++){var c=d[v];f+=Math.pow(c-i,2)}l=e?m>1?f/(m-1):0:m>0?f/m:0,o=Math.sqrt(l)}else n=null,t=null;return{avg:i,count:m,max:t,min:n,stddev:o,sum:r,variance:l}}function v(a){var n;for(n in a)e.statisticTypes.indexOf(n)>-1&&(D(a[n])||(a[n]=null));return a}function d(a){var e=a.field,n=a.classificationMethod||R,t=a.normalizationType,r=a.normalizationField,i=new o;return i.classificationField=e,i.breakCount=a.breakCount,i.classificationMethod=n,i.standardDeviationInterval="standard-deviation"===n?a.standardDeviationInterval||_:void 0,i.normalizationType=t,i.normalizationField="field"===t?r:void 0,i}function p(a,e,n,t,i,o){void 0===e&&(e=10);for(var l=new Float64Array(i*o),u=r.createKernel(e),s=Math.round(3*e),c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,v=0,d=0,p=0,h=r.createValueFunction(t,n),x=0,g=a;x<g.length;x++)for(var V=g[x],F=V.geometry,y=V.attributes,T=F.x-s,z=F.y-s,E=Math.max(0,T),M=Math.max(0,z),b=Math.min(o,F.y+s),I=Math.min(i,F.x+s),S=+h(y),N=M;N<b;N++)for(var C=u[N-z],D=E;D<I;D++){var w=u[D-T],k=N*i+D,O=l[k];f=l[k]+=C*w*S;var q=f-O;v+=q,d+=q*q,f<c&&(c=f),f>m&&(m=f),p++}if(!p)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};var B=(m-c)/2;return{mean:v/p,stdDev:Math.sqrt((d-v*v/p)/p),min:c,max:m,mid:B,count:p}}function h(a,e){var n=a.normalizationTotal,t=d({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||B}),r=m(a,e);return r=c(r,a.minValue,a.maxValue),x(a,l.createGenerateRendererClassBreaks({definition:t,values:r,normalizationTotal:n}))}function x(a,e){var n=e.classBreaks,t=n.length,r=n[0].minValue,i=n[t-1].maxValue,o="standard-deviation"===a.classificationMethod,l=q;return n=n.map(function(a){var e=a.label,n={minValue:a.minValue,maxValue:a.maxValue,label:e};if(o&&e){var t=e.match(l),r=t.map(function(a){return+a.trim()});2===r.length?(n.minStdDev=r[0],n.maxStdDev=r[1],r[0]<0&&r[1]>0&&(n.hasAvg=!0)):1===r.length&&(e.indexOf("<")>-1?(n.minStdDev=null,n.maxStdDev=r[0]):e.indexOf(">")>-1&&(n.minStdDev=r[0],n.maxStdDev=null))}return n}),{minValue:r,maxValue:i,classBreakInfos:n,normalizationTotal:e.normalizationTotal}}function g(a,e,n){for(var t,r=(e-a)/n,i=[],o=a,l=1;l<=n;l++)t=o+r,t=Number(t.toFixed(16)),i.push([o,t]),o=t;return i}function V(a){var e=[],n=a.classBreaks,t=n[0].minValue,r=n[n.length-1].maxValue;n.forEach(function(a){e.push([a.minValue,a.maxValue])});var i={field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal};return{min:t,max:r,intervals:e,sqlExpr:F(i),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}}function F(a){var e=a.field,n=a.normalizationType,t=a.normalizationField,r=a.normalizationTotal,i=e;return"percent-of-total"===n?i="(("+e+" / "+r+") * 100)":"log"===n?i="(log("+e+") * "+U+")":"field"===n&&(i="("+e+" / "+t+")"),i}function y(a,e,n){for(var t=e.min,r=e.max,i=e.normTotal,o=a.numBins||L,l=e.intervals||g(t,r,o),u=l.map(function(a,e){return{minValue:l[e][0],maxValue:l[e][1],count:0}}),s=m(a,n),c=0,f=s;c<f.length;c++){var v=f[c];if(null!=v&&v>=t&&v<=r){var d=T(l,v);d>-1&&u[d].count++}}return{bins:u,minValue:t,maxValue:r,normalizationTotal:i}}function T(a,e){for(var n=-1,t=a.length-1;t>=0;t--){if(e>=a[t][0]){n=t;break}}return n}function z(a,e){var n;if(e=e.toLowerCase(),a)for(var t in a)if(t.toLowerCase()!==e){n=a[t];break}return n}function E(a,e){var n;if(e=e.toLowerCase(),a)for(var t in a)if(t.toLowerCase()===e){n=a[t];break}return n}function M(a,e,n,t,r){var i={};a&&a.features&&a.features.forEach(function(a){var e=a.attributes,n=z(e,"countOFExpr"),t=E(e,"countOFExpr");0!==n&&(i[n]=t)});var o=[];return g(e,n,t).forEach(function(a,e){var n=(e+1).toString();o.push({minValue:a[0],maxValue:a[1],count:i.hasOwnProperty(n)?i[n]:0})}),{bins:o,minValue:e,maxValue:n,normalizationTotal:r}}function b(a,e,t,r){var i=a&&a.features,o="countOF"+(t||"Expr"),l={},u=!1;if(i.forEach(function(a){var e=a.attributes,n=E(e,o),r=t?E(e,t):z(e,o);null===r&&0===n&&(u=!0),(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==l[r]?l[r]={count:n,data:r}:l[r].count=l[r].count+n}),t&&u){var s=t+" is NULL";return e.queryFeatureCount(s).then(function(a){return a=a||0,l.null.count=l.null.count+a,I(l,r)}).catch(function(){return I(l,r)})}return n.resolve(I(l,r))}function I(a,e){if(e)for(var n in a)a[n].label=e[n];return{count:a}}function S(a,e,n,t){var r=a.count,i=[];if(t&&n&&"coded-value"===n.type){n.codedValues.forEach(function(a){var e=a.code;r.hasOwnProperty(e)||(r[e]={data:e,count:0})})}for(var o in r){var l=r[o];i.push({value:l.data,count:l.count,label:l.label})}return{uniqueValueInfos:i}}function N(a,e,n){for(var t=a.features?O:k,r=m(a,e),i={},o=0,l=r;o<l.length;o++){var u=l[o];(null==u||"string"==typeof u&&""===u.trim())&&(u=null),null==i[u]?i[u]={count:1,data:u}:i[u].count++}return S({count:i},t,n,a.returnAllCodedValues)}function C(a,e){return t.getDateDiffSQL(a,new Date(0),e,"milliseconds").sqlExpression}function D(a){return"number"==typeof a&&!isNaN(a)&&a!==1/0&&a!==-1/0}Object.defineProperty(e,"__esModule",{value:!0});var w=/_value$/i,k="features-in-memory",O="features",q=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,B=5,L=10,U=Math.LOG10E,R="equal-interval",_=1;e.statisticTypes=["min","max","avg","stddev","count","sum","variance"],e.getSummaryStatisticsFromFeatureSet=u,e.calculateStatsFromMemory=s,e.getDataValues=m,e.processSummaryStatisticsResult=v,e.createCBDefn=d,e.calculateHeatmapStats=p,e.calculateClassBreaksFromMemory=h,e.resolveCBResult=x,e.getEqualIntervalBins=g,e.generateBinParams=V,e.getFieldExpr=F,e.calculateHistogramFromMemory=y,e.getHistogramFromFeatureSet=M,e.getUniqueValuesFromFeatureSet=b,e.createUVResult=S,e.calculateUniqueValuesFromMemory=N,e.msSinceUnixEpochSQL=C,e.isValidNumber=D});