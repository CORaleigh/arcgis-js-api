// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/executeAsync","../../core/pbf","../../core/promiseUtils","../2d/engine/webgl/TileClipper","../2d/tiling/enums","./BackgroundBucket","./CircleBucket","./Feature","./FillBucket","./LineBucket","./SourceLayerData","./SymbolBucket"],function(e,t,r,i,n,a,l,s,u,c,o,f,h,p){return function(){function e(e,t,r){this._pbfTiles={},this._tileClippers={},this._client=r,this._tile=t,this._layers=t.getLayers();var n=t.tileKey.split("/").map(parseFloat),l=n[0],s=n[1],u=n[2];this._level=l;for(var c=0,o=Object.keys(e);c<o.length;c++){var f=o[c],h=e[f];this._pbfTiles[f]=new i(new Uint8Array(h.protobuff),new DataView(h.protobuff));if(h.refKey){var p=h.refKey.split("/").map(parseFloat)[0],v=l-p;if(v>0){var _=(1<<v)-1,y=s&_,B=u&_;this._tileClippers[f]=new a.TileClipper(v,y,B)}}this._tileClippers[f]||(this._tileClippers[f]=new a.SimpleBuilder)}}return e.prototype.parse=function(){for(var e,t=this,i=this._parseTileData(this._pbfTiles),a=this._layers,s=a.length,u=this._level,o=[],f=this._tileClippers,h={},p={},v=s-1;v>=0;v--)if(e=a[v],!(e.minzoom&&u<e.minzoom||e.maxzoom&&u>=e.maxzoom||e.layout&&"none"===e.layout.visibility))if(0!==e.type){if(i[e.source]&&f[e.source]){var _=i[e.source],y=f[e.source],B=e.sourceLayer,k=_[B];if(k){var x=p[e.source];x||(x=p[e.source]=new Set),x.add(e.sourceLayer);var g=this._createBucket(e);if(g){g.layerIndex=v,g.layerExtent=k.extent,g.tileClipper=y;var D=h[e.source];D||(D=h[e.source]={});var d=D[B];d||(d=D[B]=[]),d.push(g)}}}}else{var g=this._createBucket(e);g.layerIndex=v,o.push(g)}for(var m=10*this._level,w=10*(this._level+1),I=[],b=[],V=[],C=[],L=new Set,T={},S=[],F=[],z=0,j=Object.keys(p);z<j.length;z++){var A=j[z];!function(e){p[e].forEach(function(t){S.push(t),F.push(e)})}(A)}var E=0,O=0,K=S.length;return r(function(){if(t._tile.status===l.TileStatus.INVALID)return!0;switch(E){case 0:if(O<K){var e=F[O],r=S[O++];if(!i[e]||!h[e])break;var n=i[e],a=n[r],s=h[e],u=s[r];if(!u||0===u.length)break;for(var o=a.getData();o.next(2);){var f=new c(o.getMessage(),a),p=f.values;if(p){var v=p._minzoom;if(v&&v>=w)continue;var _=p._maxzoom;if(_&&_<=m)continue}for(var y=0,B=u;y<B.length;y++){var k=B[y];k.pushFeature(f)}}}else{for(var x=t._tile,g=0,D=Object.keys(h);g<D.length;g++){var e=D[g],d=h[e];for(var z in d)for(var u=d[z],j=0,A=u;j<A.length;j++){var k=A[j];k.hasFeatures()&&(3===k.layer.type?(I.push(k),x.addBucket(k)):k.layer.refLayerId?V.push(k):(b.push(k),C[k.layer.id]=k))}}E=1,O=0,K=I.length}break;case 1:if(O<K){var N=I[O++];N.getResources(N.tileClipper,L,T)}else E=2}return 2===E}).then(function(){if(t._tile.status===l.TileStatus.INVALID)return[];var e,i=[],a=t._tile.getWorkerTileHandler();L.size>0&&(e=a.fetchSprites(L,t._client),i.push(e));var s;for(var u in T){var c=T[u];c.size>0&&(s=a.fetchGlyphs(t._tile.tileKey,u,c,t._client),i.push(s))}return n.all(i).then(function(e){if(t._tile.status===l.TileStatus.INVALID)return[];var i=0,n=0,a=b.length;return r(function(){if(t._tile.status===l.TileStatus.INVALID)return!0;switch(i){case 0:if(n<a){var e=b[n++];e.processFeatures(e.tileClipper,t._tile),o.push(e)}else i=1,n=0,a=V.length;break;case 1:for(var r=0,s=V;r<s.length;r++){var e=s[r],u=C[e.layer.refLayerId];u&&(u.assignBufferInfo(e),o.push(e))}i=2,n=0,a=I.length;break;case 2:if(n<a){var e=I[n++];e.processFeatures(e.tileClipper,t._tile),o.push(e)}else i=3}return 3===i}).then(function(){return o.sort(function(e,t){return e.layerIndex-t.layerIndex}),o})}).catch(function(e){return n.reject(new Error(e))})}).catch(function(e){return n.reject(new Error(e))})},e.prototype._parseTileData=function(e){for(var t={},r=0,i=Object.keys(e);r<i.length;r++){for(var n=i[r],a=e[n],l={};a.next();)switch(a.tag()){case 3:var s=new h(a.getMessage());l[s.name]=s;break;default:a.skip()}t[n]=l}return t},e.prototype._createBucket=function(e){switch(e.type){case 0:return this._createBackgroundBucket(e);case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}},e.prototype._createBackgroundBucket=function(e){return new s(e,this._level)},e.prototype._createFillBucket=function(e){var t=this._tile;return new o(e,this._level,e.hasDataDrivenFill?t.fillDDVertexBuffer:t.fillVertexBuffer,t.fillIndexBuffer,e.hasDataDrivenOutline?t.outlineDDVertexBuffer:t.outlineVertexBuffer,t.outlineIndexBuffer)},e.prototype._createLineBucket=function(e){var t=this._tile;return new f(e,this._level,e.hasDataDrivenLine?t.lineDDVertexBuffer:t.lineVertexBuffer,t.lineIndexBuffer)},e.prototype._createCircleBucket=function(e){var t=this._tile;return new u(e,this._level,t.circleVertexBuffer,t.circleIndexBuffer)},e.prototype._createSymbolBucket=function(e){var t=this._tile;return new p(e,this._level,e.hasDataDrivenIcon?t.iconDDVertexBuffer:t.iconVertexBuffer,t.iconIndexBuffer,e.hasDataDrivenText?t.textDDVertexBuffer:t.textVertexBuffer,t.textIndexBuffer,t.placementEngine,t.getWorkerTileHandler())},e}()});