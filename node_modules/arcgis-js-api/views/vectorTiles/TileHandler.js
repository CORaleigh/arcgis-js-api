// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../request","../../core/has","../../core/ItemCache","../../core/promiseUtils","../../core/requireUtils","../../core/workers","../2d/tiling/TileKey","./GeometryUtils","./GlyphMosaic","./GlyphSource","./SpriteMosaic","./TileIndex","./VectorTileDisplayObject","module"],function(e,t,i,r,o,n,s,a,u,c,l,p,h,f,d,y){var g=new o(10),_=new Map;return function(){function t(e,t,i,r){this.devicePixelRatio=t,this.allowUpdates=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._updateQueue=new Map,this._ongoingRequests=new Map,this._vectorTileLayer=e,this._container=r}return t.prototype.destroy=function(){this.stop(),this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)},Object.defineProperty(t.prototype,"initialized",{get:function(){return this._broadcastPromise&&this._broadcastPromise.isFulfilled()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spriteMosaic",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ongoingRequestCount",{get:function(){return this._ongoingRequests.size},enumerable:!0,configurable:!0}),t.prototype.start=function(){var t=this;this.stop();var i=[],o=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio).then(function(e){t._spriteMosaic=new h(1024,1024,250),t._spriteMosaic.setSpriteSource(e),r("stable-symbol-rendering")&&t._spriteMosaic.preloadSpriteItems()});i.push(o);var u=this._vectorTileLayer.styleRepository,c=new p(u.glyphs);this._glyphMosaic=new l(1024,1024,c);var f=this._vectorTileLayer.sourceNameToSource;for(var d in f)i.push(this._fetchTileMap(f[d]));var g=a.open(s.getAbsMid("./WorkerTileHandler",e,y),{client:this}).then(function(e){t._connection=e});return i.push(g),this._broadcastPromise=n.all(i).then(function(){return t._connection.broadcast("setLayers",u.styleJSON)}),this._broadcastPromise},t.prototype.stop=function(){this._broadcastPromise&&!this._broadcastPromise.isFulfilled()&&this._broadcastPromise.cancel(),this._updateQueue.forEach(function(e){return e.cancel()}),this._ongoingRequests.forEach(function(e){return e.cancel()}),this._connection&&(this._connection.close(),this._connection=null)},t.prototype.updateStyle=function(){this._updateQueue.forEach(function(e){return e.cancel()}),this._updateQueue.clear(),this._ongoingRequests.forEach(function(e){return e.cancel()}),this._ongoingRequests.clear();var e,t=this._vectorTileLayer.styleRepository,i=n.create(function(t){e=t});return n.all(this._connection.broadcast("updateStyle",t.styleJSON)).then(function(){return e()}),this._broadcastPromise=i,i},t.prototype.updateTile=function(e,t){var i=this;if(!this.allowUpdates)return n.resolve(null);if(!this._broadcastPromise.isFulfilled()||!this._connection)return n.reject(new Error("no connection"));var r=Math.round(c.degToByte(t.state.rotation));if(e.rotation===r)return n.resolve(null);var o,s=e.key;return this._updateQueue.has(s.id)&&(o=this._updateQueue.get(s.id),o.cancel(),this._updateQueue.delete(s.id)),e.rotation=r,o=e.client.invoke("updateSymbols",{key:e.id,rotation:r}).then(function(t){return i._updateQueue.delete(s.id),e.updateSymbolData(t),t}).catch(function(e){"cancel"!==e.dojoType&&i._updateQueue.delete(s.id)}),this._updateQueue.set(e.id,o),o},t.prototype.updateTileData=function(e){for(var t,i=e.tileId,r=this._container.children,o=0;o<r.length;o++)if(t=r[o],t.id===i){t.updateTileData(e.tileData);break}},t.prototype.getVectorTile=function(e,t,i,r){void 0===r&&(r=0);var o=new u(e,t,i,0),s=new d(o,this._vectorTileLayer.tileInfo,this._vectorTileLayer.styleRepository,0),a=this.getTileData(o,0).then(function(e){return e?s.setData(e.tileData,e.client):s.setData(null,null),s});return n.create(function(e,t){a.then(function(t){return e(t)}).catch(function(e){return t(e)})})},t.prototype.getTileData=function(e,t){var i=this;if(!this._broadcastPromise.isFulfilled()||!this._connection)return n.reject(new Error("no connection"));var r=e.id;if(this._ongoingRequests.has(r))return this._ongoingRequests.get(r);var o=this._vectorTileLayer.sourceNameToSource,s=[],a=[];for(var u in o){var l=o[u],p=l.getRefKey(e);s.push(p),a.push(l.name)}var h=!1,f=n.eachAlways(s).then(function(o){for(var s=Math.round(c.degToByte(t)),u=[],l=0;l<o.length;l++)if(null==o[l].value)u.push(n.reject("getRefKey failed for source "+a[l]));else{var p=i._getTileData(e,o[l].value,a[l]).then(function(e){return e&&e.protobuff?e:(h=!0,i._ongoingRequests.delete(r),n.reject())});u.push(p)}return n.eachAlways(u).then(function(t){for(var a={},u=[],c=0;c<t.length;c++)if(t[c].value&&t[c].value.protobuff&&t[c].value.protobuff.byteLength>0){var l=o[c].value.toString();a[t[c].value.sourceName]={refKey:l,protobuff:t[c].value.protobuff},u.push(t[c].value.protobuff)}if(0===Object.keys(a).length)return h=!0,i._ongoingRequests.delete(r),n.resolve(null);var p=i._connection.getAvailableClient();return p.invoke("createTileAndParse",{key:e.toString(),rotation:s,cacheTile:i.allowUpdates,sourceName2DataAndRefKey:a},{transferList:u}).then(function(e){return h=!0,i._ongoingRequests.delete(r),{tileData:e,client:p}}).catch(function(t){return h=!0,i._ongoingRequests.delete(r),p.invoke("destructTileData",e.id),n.reject(t)})}).catch(function(e){return i._ongoingRequests.delete(r),n.reject(e)})}).catch(function(e){return i._ongoingRequests.delete(r),n.reject(e)});return h||this._ongoingRequests.set(r,f),f},t.prototype.getSprites=function(e){return this._spriteMosaic.getSpriteItems(e)},t.prototype.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.tileID,e.font,e.codePoints)},t.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository},t.prototype._getTileData=function(e,t,i){return this.fetchTileData(t.toString(),i).then(function(e){return{protobuff:e,sourceName:i}})},t.prototype._fetchTileMap=function(e){if(e.capabilities.operations.supportsTileMap&&e.tileIndex)return n.resolve();if(!e.tileMapURL)return n.resolve();var t=g.get(e.tileMapURL);if(t)return e.tileIndex=t,n.resolve();if(_.has(e.tileMapURL))return _.get(e.tileMapURL).then(function(t){e.tileIndex=new f(t.data)});var r=i(e.tileMapURL,{responseType:"json"});return r.then(function(t){e.tileIndex=new f(t.data),_.delete(e.tileMapURL),g.put(e.tileMapURL,e.tileIndex)}),_.set(e.tileMapURL,r),r},t.prototype.fetchTileData=function(e,t){var r=u.pool.acquire(e),o=this._vectorTileLayer.sourceNameToSource;if(!(t in o))return u.pool.release(r),n.reject(new Error("invalid source name"));var s=o[t],a=s.getSourceTileUrl(r.level,r.row,r.col);return u.pool.release(r),i(a,{responseType:"array-buffer"}).then(function(e){return e.data})},t}()});