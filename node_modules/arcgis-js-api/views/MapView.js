// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/Error","../core/Handles","../core/has","../core/Logger","../core/promiseUtils","../core/screenUtils","../core/watchUtils","../core/workers","../core/accessorSupport/decorators","./BreakpointsOwner","./Magnifier","./MapViewBase","./2d/input/MapViewInputManager","./2d/support/HighlightOptions","./support/screenshotUtils","./support/WebGLRequirements","./ui/2d/DefaultUI2D"],function(e,t,i,r,n,a,s,o,p,h,u,c,l,g,d,w,y,f,v,_,m){function V(){return p.create(function(t){e(["./2d/RenderingCore2D"],function(e){b=e.Stage,M=e.GraphicsView2D,S=e.LabelManager,O=e.MapViewNavigation,k=e.MagnifierView2D,t()})})}var b,M,S,O,k,C=o.getLogger("esri.views.MapView");return function(e){function t(t){var i=e.call(this,t)||this;return i._graphicsView=null,i._magnifierView=null,i._mapViewHandles=new a,i._stage=null,i._resolveWhenReady=[],i.highlightOptions=new f,i.magnifier=new d,i.inputManager=new y({view:i}),i.mapViewNavigation=null,i.supersampleScreenhotsEnabled=!0,i.ui=new m,i.rendering=!1,c.initialize(),i}return i(t,e),Object.defineProperty(t.prototype,"background",{get:function(){return this.get("map.initialViewProperties.background")||null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"interacting",{get:function(){return this.mapViewNavigation&&this.mapViewNavigation.interacting||!1},enumerable:!0,configurable:!0}),t.prototype.toMap=function(e){if(h.isSupportedScreenPointEvent(e)){var t=h.createScreenPointFromSupportedEvent(this,e);return this.inherited(arguments,[t])}return this.inherited(arguments)},t.prototype.hitTest=function(e){var t=h.isSupportedScreenPointEvent(e)?h.createScreenPointFromSupportedEvent(this,e):e;if(!this._setup||isNaN(t.x)||isNaN(t.y))return p.resolve({screenPoint:t,results:[]});var i=this.toMap(t),r=[this._graphicsView];return r.push.apply(r,this.allLayerViews.toArray().reverse()),p.all(r.map(function(e){return e&&e.hitTest?e.hitTest(t.x,t.y):null})).then(function(e){return{screenPoint:t,results:e.filter(function(e){return null!=e}).map(function(e){return{mapPoint:i,graphic:e}})}})},t.prototype.takeScreenshot=function(e){return this._setup?this._stage.takeScreenshot(v.toRenderSettings(e,this),this.allLayerViews):p.reject("Map view cannot be used before it is ready")},t.prototype.on=function(e,t,i){var r=this.inputManager&&this.inputManager.viewEvents.register(e,t,i);return r||this.inherited(arguments)},t.prototype.hasEventListener=function(e){return this.inherited(arguments)||this.inputManager&&this.inputManager.viewEvents.hasHandler(e)},t.prototype.graphicChanged=function(e){this._graphicsView&&this._graphicsView.graphicUpdateHandler(e)},t.prototype.whenReady=function(){var e=this;return p.create(function(t){e._setup?t(e):e._resolveWhenReady.push(t)})},t.prototype.forceDOMReadyCycle=function(){this.forceReadyCycle()},t.prototype.validate=function(){var e=_.check({supportsMajorWebPerformanceCaveat:!0});return s("safari")&&s("safari")<9&&(e=new n("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:s("safari")})),e?(C.warn("#validate()",e.message),p.reject(e)):V()},t.prototype._startup=function(){var e=this;if(!this._setup){this.inherited(arguments),this.graphics.owner=this;var t=new b(this.surface,{canvas:this.renderCanvas,supersampleScreenshots:this.supersampleScreenhotsEnabled}),i=new M({view:this,graphics:this.graphics}),r=new O({view:this,animationManager:this.animationManager}),n=new S({view:this});this._magnifierView=new k,this._magnifierView.magnifier=this.magnifier,this._stage=t,this._graphicsView=this._frameTask.graphicsView=i,this._set("mapViewNavigation",r),this._set("labelManager",n),this._mapViewHandles.add([this.allLayerViews.on("change",function(){return e._updateStageChildren()}),t.on("post-render",function(){return e._set("rendering",e.allLayerViews.some(function(e){return!0===e.rendering}))}),this.watch("stationary",function(e){return t.stationary=e},!0),this.watch("state.viewpoint",function(i){return t.state=e.state},!0),this.watch("background",function(e){return t.background=e},!0),this.watch("magnifier",function(t){return e._magnifierView.magnifier=t},!0),u.init(this,"highlightOptions.color,highlightOptions.haloOpacity,highlightOptions.fillOpacity",function(){e._stage.setHighlightOptions(e.highlightOptions),e._stage.requestRender()})]),t.state=this.state,t.background=this.background,this._updateStageChildren();var a=this._resolveWhenReady;this._resolveWhenReady=[],a.forEach(function(t){return t(e)})}},t.prototype._tearDown=function(){this._setup&&(this._mapViewHandles.removeAll(),this.layerViewManager.clear(),this.labelManager.destroy(),this._graphicsView.destroy(),this._magnifierView.destroy(),this._stage.destroy(),this.mapViewNavigation.destroy(),this._stage=null,this._graphicsView=null,this._magnifierView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,this.inherited(arguments))},t.prototype._updateStageChildren=function(){var e=this;this._stage.removeAllChildren(),this.allLayerViews.filter(function(e){return null!=e.container}).forEach(function(t,i){e._stage.addChildAt(t.container,i)}),this._stage.addChild(this._graphicsView.container),this._stage.addChild(this._magnifierView)},r([l.property({readOnly:!0,dependsOn:["map.initialViewProperties?.background"]})],t.prototype,"background",null),r([l.property({type:f})],t.prototype,"highlightOptions",void 0),r([l.property({type:d})],t.prototype,"magnifier",void 0),r([l.property({readOnly:!0})],t.prototype,"inputManager",void 0),r([l.property({readOnly:!0})],t.prototype,"mapViewNavigation",void 0),r([l.property({dependsOn:["mapViewNavigation.interacting"],type:Boolean})],t.prototype,"interacting",null),r([l.property({type:Boolean,constructOnly:!0})],t.prototype,"supersampleScreenhotsEnabled",void 0),r([l.property({type:m})],t.prototype,"ui",void 0),r([l.property({readOnly:!0})],t.prototype,"rendering",void 0),r([l.property({constructOnly:!0})],t.prototype,"renderCanvas",void 0),t=r([l.subclass("esri.views.MapView")],t)}(l.declared(w,g))});