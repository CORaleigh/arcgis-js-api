// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/scheduling"],function(e,s,t,r,i,o){function n(e){return e&&"function"==typeof e.then}return function(){function e(e){var s=this;this._apiPromises=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this._pendingProcessing=0,this.concurrency=1,this.ordered=!1,e.concurrency&&(this.concurrency=e.concurrency),e.ordered&&(this.ordered=!0,this._itemsToProcess=[]),this._queue=new i({peeker:e.peeker}),this.process=e.process;var t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,function(e){return s.update(e)},function(){return s.needsUpdate()}))}return e.prototype.destroy=function(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)},Object.defineProperty(e.prototype,"length",{get:function(){return this._processingItems.size+this._queue.length+this._pendingProcessing},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this._queue.clear();var e=[];this._processingItems.forEach(function(s){return e.push(s.resultPromise)}),this._processingItems.clear(),e.forEach(function(e){return e.cancel()}),e.length=0,this._apiPromises.forEach(function(s){return e.push(s)}),this._apiPromises.clear(),e.forEach(function(e){return e.cancel()}),this._cancelNext()},e.prototype.find=function(e,s){var t=this,r=void 0;return this._apiPromises.forEach(function(i,o){e.call(s,o)&&(r=t._apiPromises.get(o).promise)}),r},e.prototype.get=function(e){var s=this._apiPromises.get(e);return s&&s.promise||void 0},e.prototype.isOngoing=function(e){return this._processingItems.has(e)},e.prototype.has=function(e){return this._apiPromises.has(e)},e.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},e.prototype.push=function(e){var s=this;if(this._apiPromises.has(e))return this._apiPromises.get(e).promise;var t=function(t){var r=s._processingItems.get(e);r?r.resultPromise.cancel(t):(s._remove(e),s._scheduleNext())},i=r.createDeferred(t);return this._add(e,i),this._scheduleNext(),i.promise},e.prototype.reset=function(){var e=[];this._processingItems.forEach(function(s){return e.push(s)}),this._processingItems.clear();for(var s=0,t=e;s<t.length;s++){var r=t[s];r.resultPromise.isFulfilled()?this._processReset(r):(r.isReset=!0,r.resultPromise.cancel())}},e.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())},e.prototype.needsUpdate=function(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency},e.prototype.update=function(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()},e.prototype._scheduleNext=function(){var e=this;this._task||this._isPaused||this._schedule||(this._schedule=o.schedule(function(){e._schedule=null,e._next()}))},e.prototype._next=function(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())},e.prototype._cancelNext=function(){this._schedule&&(this._schedule.remove(),this._schedule=null)},e.prototype._processResult=function(e,s){this._remove(e.item),this._scheduleNext(),e.dfd.resolve(s)},e.prototype._processError=function(e,s){if(e.isReset)return void this._processReset(e);this._remove(e.item),this._scheduleNext(),e.dfd.reject(s)},e.prototype._processReset=function(e){this._remove(e.item),this._add(e.item,e.dfd),this._scheduleNext()},e.prototype._processOrdered=function(e,s){var t=this;if(e.isReset)return void this._processReset(e);e.result=s;var r=!1;this._processingItems.forEach(function(e){r||(e.result?t._itemsToProcess.push(e):r=!0)});for(var i=0,o=this._itemsToProcess;i<o.length;i++){var n=o[i];!1===n.result.ok?this._processError(n,n.result.error):this._processResult(n,n.result.value)}this._itemsToProcess.length=0},e.prototype._process=function(e){var s=this;if(!t.isNone(e)){var r=this._apiPromises.get(e);this._pendingProcessing++;var i=this.process(e);if(this._pendingProcessing--,n(i)){var o={item:e,resultPromise:i,result:null,dfd:r,isReset:!1};this._processingItems.set(e,o),this.ordered?i.then(function(e){return s._processOrdered(o,{ok:!0,value:e})},function(e){return s._processOrdered(o,{ok:!1,error:e})}):i.then(function(e){return s._processResult(o,e)},function(e){return s._processError(o,e)})}else r.resolve(i),this._remove(e)}},e.prototype._add=function(e,s){this._apiPromises.set(e,s),this._queue.push(e)},e.prototype._remove=function(e){this._queue.remove(e),this._apiPromises.delete(e),this._processingItems.delete(e)},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{update:function(s){return e.update(s)}}},enumerable:!0,configurable:!0}),e}()});