// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/screenUtils","../DisplayObject","../webgl/enums","../webgl/shaders/MagnifierPrograms","../../../3d/support/imageUtils","../../../webgl/BufferObject","../../../webgl/programUtils","../../../webgl/Texture","../../../webgl/VertexArrayObject"],function(e,r,t,i,a,s,o,n,h,u,l,d,m,g){Object.defineProperty(r,"__esModule",{value:!0});var p=i.getLogger("esri.views.2d.engine.webgl.magnifier.Magnifier"),c=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t._maskPath=e.toUrl("../../../../images/magnifier/mask.png"),t._overlayPath=e.toUrl("../../../../images/magnifier/overlay.png"),t.visible=!1,t}return t(i,r),i.prototype.destroy=function(){this._readbackTexture&&(this._readbackTexture.dispose(),this._readbackTexture=null,this._maskTexture.dispose(),this._maskTexture=null,this._overlayTexture.dispose(),this._overlayTexture=null,this._vertexArrayObject.dispose(),this._vertexArrayObject=null,this._program.dispose(),this._program=null)},Object.defineProperty(i.prototype,"magnifier",{get:function(){return this._magnifier},set:function(e){var r=this;this._magnifier=e,this._handle&&this._handle.remove(),this._handle=e.watch("version",function(){r.visible=e.visible,r.requestRender()}),this.visible=e.visible,this.requestRender()},enumerable:!0,configurable:!0}),i.prototype.doRender=function(e){var r=this.stage.context;if(e.drawPhase===n.WGLDrawPhase.MAP&&this._updateRessources(r)){var t=this._magnifier,i=1/t.factor,a=Math.ceil(i*this.overlay.width),o=Math.ceil(i*this.overlay.height),h=e.state.size,u=e.pixelRatio,l=u*h[0],d=u*h[1],m=t.position||{x:.5*h[0],y:.5*h[1]},g=u*m.x,p=d-u*m.y,c=.5*a,f=.5*o;c>g?g=c:g>=l-c&&(g=l-c-1),f>p?p=f:p>=d-f&&(p=d-f-1);var v=g-c,_=p-f,y=this._readbackTexture;r.bindTexture(y,0),r.gl.copyTexImage2D(y.descriptor.target,0,y.descriptor.pixelFormat,v,_,a,o,0);var b=this.stage.background&&this.stage.background.color,x=b?[b.a*b.r/255,b.a*b.g/255,b.a*b.b/255,b.a]:[1,1,1,1],w=(g+s.pt2px(t.offsetX))/l*2-1,T=(p-s.pt2px(t.offsetY))/d*2-1,k=this.overlay.width/l*2,P=this.overlay.height/d*2,M=this._program;r.bindVAO(this._vertexArrayObject),r.bindTexture(this._overlayTexture,6),r.bindTexture(this._maskTexture,7),r.bindProgram(M),M.setUniform4fv("u_background",x),M.setUniform1i("u_readbackTexture",0),M.setUniform1i("u_overlyTexture",6),M.setUniform1i("u_maskTexture",7),M.setUniform2f("u_drawPos",w,T),M.setUniform1f("u_width",k),M.setUniform1f("u_height",P),r.drawArrays(5,0,4),r.bindVAO()}},i.prototype._updateRessources=function(e){var r=this;if(!this._resourcePromise){var t=void 0;t=this.mask?a.resolve():u.requestImage(this._maskPath).then(function(e){return r.mask=e});var i=void 0;return i=this.overlay?a.resolve():u.requestImage(this._overlayPath).then(function(e){return r.overlay=e}),this._resourcePromise=a.all([t,i]).then(function(){r.requestRender()}),this.requestRender(),!1}if(!this._resourcePromise.isResolved())return this.requestRender(),!1;var s=1/this._magnifier.factor,o=Math.ceil(s*this.overlay.width),n=Math.ceil(s*this.overlay.height);if(this._readbackTexture&&this._readbackTexture.descriptor.width===o&&this._readbackTexture.descriptor.height===n)return!0;if(this.overlay.width!==this.mask.width||this.overlay.height!==this.mask.height)return p.error("Overlay and mask images must have the same size"),!1;if(!this._program){var c=d.createProgram(e,h.magnifier);if(!c)return!1;this._program=c}if(!this._vertexArrayObject){var f={geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},v=new Uint16Array([0,1,0,0,1,1,1,0]),_=h.magnifier.attributes,y=new g(e,_,f,{geometry:l.createVertex(e,35044,v)});this._vertexArrayObject=y}if(!this._overlayTexture){var b=new m(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.overlay);this._overlayTexture=b}if(!this._maskTexture){var x=new m(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);this._maskTexture=x}var w=new m(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:o,height:n});return this._readbackTexture=w,!0},i}(o.DisplayObject);r.default=c});