// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","./GeometryUtils","./Rect","./RectangleBinPack","../../../webgl/Texture"],function(t,e,p,_,g,a){return function(){function s(t,e,i){void 0===i&&(i=0),this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,0<i&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new g(this._pageWidth,this._pageHeight);var s=Math.floor(this._pageWidth),h=Math.floor(this._pageHeight);this._mosaicsData[0]=new Uint32Array(s*h),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}return s.prototype.getWidth=function(t){return t>=this._size.length?-1:this._size[t][0]},s.prototype.getHeight=function(t){return t>=this._size.length?-1:this._size[t][1]},s.prototype.getPage=function(t){return t<this._textures.length?this._textures[t]:null},s.prototype.has=function(t){return this._mosaicRects.has(t)},Object.defineProperty(s.prototype,"itemCount",{get:function(){return this._mosaicRects.size},enumerable:!0,configurable:!0}),s.prototype.getSpriteItem=function(t){return this._mosaicRects.get(t)},s.prototype.addSpriteItem=function(t,e,i,s,h,a,r){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);var o=this._allocateImage(e[0],e[1]),n=o[0],p=o[1],_=o[2];if(n.width<=0||n.height<=0)return null;var g={rect:n,width:e[0],height:e[1],anchorX:i[0],anchorY:i[1],sdf:a,simplePattern:r,pixelRatio:1,page:p};return this._mosaicRects.set(t,g),this._copy({rect:n,spriteSize:e,spriteData:s,page:p,pageSize:_,repeat:h,sdf:a}),g},s.prototype.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},s.prototype.processNextItem=function(){var t=this._spriteCopyQueue.pop();t&&this._copy(t)},s.prototype.getSpriteItems=function(t){for(var e={},i=0,s=t;i<s.length;i++){var h=s[i];e[h]=this.getSpriteItem(h)}return e},s.prototype.getMosaicItemPosition=function(t,e){var i=this.getSpriteItem(t),s=i&&i.rect;if(!s)return null;s.width=i.width,s.height=i.height;var h=i.width,a=i.height;return{size:[i.width,i.height],tl:[(s.x+1)/this._size[i.page][0],(s.y+1)/this._size[i.page][1]],br:[(s.x+1+h)/this._size[i.page][0],(s.y+1+a)/this._size[i.page][1]],page:i.page}},s.prototype.bind=function(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this._textures[i]||(this._textures[i]=new a(t,{pixelFormat:6408,dataType:5121,width:this._size[i][0],height:this._size[i][1]},new Uint8Array(this._mosaicsData[i].buffer)));var h=this._textures[i];h.setSamplingMode(e),this._dirties[i]&&(h.setData(new Uint8Array(this._mosaicsData[i].buffer)),h.generateMipmap()),t.bindTexture(h,s),this._dirties[i]=!1},s._copyBits=function(t,e,i,s,h,a,r,o,n,p,_){var g=s*e+i,c=o*a+r;if(_){c-=a;for(var u=-1;u<=p;g=((++u+p)%p+s)*e+i,c+=a)for(var l=-1;l<=n;l++)h[c+l]=t[g+(l+n)%n]}else for(u=0;u<p;u++){for(l=0;l<n;l++)h[c+l]=t[g+l];g+=e,c+=a}},s.prototype._copy=function(t){if(!(t.page>=this._mosaicsData.length)){var e=t.spriteData,i=this._mosaicsData[t.page];i&&e||console.error("Source or target images are uninitialized!");s._copyBits(e,t.spriteSize[0],0,0,i,t.pageSize[0],t.rect.x+1,t.rect.y+1,t.spriteSize[0],t.spriteSize[1],t.repeat),this._dirties[t.page]=!0}},s.prototype._allocateImage=function(t,e){t+=2,e+=2;var i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){var s=Math.pow(2,Math.ceil(p.log2(t))),h=Math.pow(2,Math.ceil(p.log2(e))),a=new _(0,0,t,e);return this._mosaicsData.push(new Uint32Array(s*h)),this._dirties.push(!0),this._size.push([s,h]),this._textures.push(void 0),[a,this._mosaicsData.length-1,[s,h]]}var r=t%4?4-t%4:0,o=e%4?4-e%4:0,n=this._binPack.allocate(t+r,e+o);return n.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new g(this._pageWidth,this._pageHeight),this._allocateImage(t,e)):[n,this._currentPage,[this._pageWidth,this._pageHeight]]},s.prototype.dispose=function(){this._binPack=null;for(var t=0,e=this._textures;t<e.length;t++){var i=e[t];i&&i.dispose()}this._textures.length=0,this._mosaicsData.length=0,this._mosaicRects.clear()},s}()});