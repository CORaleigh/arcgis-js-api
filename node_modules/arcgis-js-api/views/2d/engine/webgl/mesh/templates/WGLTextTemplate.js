// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../color","../../definitions","../../enums","../../fontUtils","../../number","../../TextShapingNew","../../WGLDisplayRecord","../../collisions/BoundingBox","../../materialKey/MaterialKey","./ComputedGlyph","./WGLMeshTemplate","../../util/BidiText","../../../../layers/graphics/graphicsUtils","../../../../../vectorTiles/GeometryUtils"],function(e,t,r,I,o,s,a,i,T,w,h,V,l,p,L,c,x,G,O,u,n,f,m,_){Object.defineProperty(t,"__esModule",{value:!0});var b=o.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),y=i.mat2df32.create(),g=w.vec2f32.create(),d=function(i){function n(e,t){var r=i.call(this)||this;r.geometryType=l.WGLGeometryType.TEXT,r._xOffset=s.pt2px(t.xoffset),r._yOffset=s.pt2px(t.yoffset),r._decorationTop=p.getFontDecorationTop(t.font),r._color=0|(t.color&&h.premultiplyAlphaRGBA(t.color)),r._haloColor=0|(t.haloColor&&h.premultiplyAlphaRGBA(t.haloColor)),r._haloSize=Math.min(Math.floor(5*s.pt2px(s.toPt(t.haloSize||0))),127),r._size=Math.min(Math.round(s.pt2px(t.font.size)),127),r._scale=r._size/24,r._angle=t.angle||0,r._justify=m.getJustification(t.horizontalAlignment||"center"),r._xAlignD=m.getXAnchorDirection(t.horizontalAlignment||"center"),r._yAlignD=-m.getYAnchorDirection(t.verticalAlignment||"baseline"),r._baseline="baseline"===(t.verticalAlignment||"baseline"),r._bitset=0;var o=O.MaterialKeyBase.load(O.createMaterialKey(r.geometryType,e,!1));return o.sdf=!0,r._materialKey=o.data,r.symbolId=t.id,r}return r(n,i),n.fromText=function(e,t,r){var o=new n(e,t),i=f.bidiText(t.text),s=i[0],a=i[1];return o.bindTextInfo(r,s,a),o._computeGlyphs(o._shapedGlyphs,o._shapedBox),o},n.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||c.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=c.getBox(o)},n.prototype.writeMesh=function(e,t,r,o,i,s,a,n){var h,l,p=this._computedGlyphs,c=O.TextMaterialKey.load(this._materialKey),u=L.i8888to32(0,0,0,this._bitset);switch(r){case"esriGeometryPoint":for(var f=i.geometry,m=f.x,_=f.y,y=0,g=p;y<g.length;y++){(A=g[y]).anchorX=m,A.anchorY=_}return void this._writeVertices(e,t,o,a,p,n,c,u,0,0);case"esriGeometryPolygon":if(i.centroid){for(var d=i.centroid,v=(m=d.x,_=d.y,0),x=p;v<x.length;v++){(A=x[v]).anchorX=m,A.anchorY=_}return void this._writeVertices(e,t,o,a,p,n,c,u,0,0)}case"esriGeometryMultipoint":m=0,_=0;for(var T=0,w=i.geometry.points;T<w.length;T++){var V=w[T];m+=V[0],_+=V[1];for(var G=0,M=p;G<M.length;G++){var A;(A=M[G]).anchorX=m,A.anchorY=_}this._writeVertices(e,t,o,a,p,n,c,u,0,0)}return;default:h="Unable to handle geometryType: "+r,void 0===l&&(l="mapview-processing"),b.error(new I(l,h))}},n.prototype._computeGlyphs=function(e,t){for(var r=new Array(e.length),o=this._computeGlyphTransform(t),i=O.MaterialKeyBase.load(this._materialKey),s=0;s<e.length;s++){var a=e[s],n=a.x,h=a.y,l=a.codePoint,p=a.glyphMosaicItem;i.textureBinding=p.textureBinding,r[s]=u.default.from(n,h,0,0,-1,0,25,p,l,i.data,o,this._size,this._haloSize,!1,!0)}this._computedGlyphs=r},n.prototype._createBounds=function(e,t){var r,o,i=e.width/2,s=e.height/2,a=t[4],n=t[5];if(this._angle){var h=w.vec2f32.fromValues(-i,-s),l=w.vec2f32.fromValues(i,-s),p=w.vec2f32.fromValues(-i,s),c=w.vec2f32.fromValues(i,s);T.vec2.transformMat2d(h,h,t),T.vec2.transformMat2d(l,l,t),T.vec2.transformMat2d(p,p,t),T.vec2.transformMat2d(c,c,t);for(var u=1/0,f=1/0,m=0,_=0,y=0,g=[h,l,p,c];y<g.length;y++){var d=g[y];u=Math.min(d[0],u),m=Math.max(d[0],m),f=Math.min(d[1],f),_=Math.max(d[1],_)}r=m-u,o=_-f}else r=e.width*this._scale,o=e.height*this._scale;var v=r+V.COLLISION_BOX_PADDING,x=o+V.COLLISION_BOX_PADDING;return new G.default(a,n,v,x)},n.prototype._computeShaping=function(e,t){return new c([e],512,V.TEXT_LINE_HEIGHT,V.TEXT_SPACING,[0,.5*-V.TEXT_LINE_HEIGHT],.5*(1-this._xAlignD),0,t)},n.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*_.C_DEG_TO_RAD,o=a.mat2d.identity(y);a.mat2d.rotate(o,o,r),a.mat2d.translate(o,o,T.vec2.set(g,this._xOffset,-this._yOffset)),a.mat2d.scale(o,o,T.vec2.set(g,t,t));var i=this._baseline?25:e.y+(1-this._yAlignD)*e.height*.5;return a.mat2d.translate(o,o,T.vec2.set(g,-4,-4-i)),o},n.prototype._writeVertices=function(e,t,r,o,i,s,a,n,h,l){this._writeHalos(e,t,r,o,i,s,a,n,h,l),this._writeText(e,t,r,o,i,s,a,n,h,l)},n.prototype._writeHalos=function(e,t,r,o,i,s,a,n,h,l){var p=t.indexVector,c=a.hasVV(),u=t.getVector("geometry").vertexCount,f=0;if(this._haloSize)for(var m=0;m<i.length;m++,f+=4){var _=i[m],y=L.i1616to32(2*_.anchorX+1,2*_.anchorY),g=null==h?Math.floor(10*_.minZoom):h,d=null==l?Math.floor(10*_.maxZoom):l,v=new x(r,this.geometryType,_.materialKey,g,d);v.vertexFrom=u+f,v.indexFrom=p.length,this._writeVertex(v,t,r,y,this._haloColor,_,c,o,s,n),this._writeIndices(v,p,u+f),e.push(v)}},n.prototype._writeText=function(e,t,r,o,i,s,a,n,h,l){for(var p=t.indexVector,c=a.hasVV(),u=t.getVector("geometry").vertexCount,f=0,m=0;m<i.length;m++,f+=4){var _=i[m],y=L.i1616to32(2*_.anchorX,2*_.anchorY),g=null==h?Math.floor(10*_.minZoom):h,d=null==l?Math.floor(10*_.maxZoom):l,v=new x(r,this.geometryType,_.materialKey,g,d);v.vertexFrom=u+f,v.indexFrom=p.length,this._writeVertex(v,t,r,y,this._color,_,c,o,s,n),this._writeIndices(v,p,u+f),e.push(v)}},n.prototype._writeVertex=function(e,t,r,o,i,s,a,n,h,l){var p=t.get("geometry"),c=t.get("visibility");p.push(o),p.push(r),p.push(i),p.push(s.vertexOffsetUpperLeft),p.push(s.texFontSizeUpperLeft),p.push(l),this._writeVV(p,n,a),c.push(h),p.push(o),p.push(r),p.push(i),p.push(s.vertexOffsetUpperRight),p.push(s.texFontSizeUpperRight),p.push(l),this._writeVV(p,n,a),c.push(h),p.push(o),p.push(r),p.push(i),p.push(s.vertexOffsetLowerLeft),p.push(s.texFontSizeLowerLeft),p.push(l),this._writeVV(p,n,a),c.push(h),p.push(o),p.push(r),p.push(i),p.push(s.vertexOffsetLowerRight),p.push(s.texFontSizeLowerRight),p.push(l),this._writeVV(p,n,a),c.push(h),e.vertexCount+=4},n.prototype._writeVV=function(e,t,r){r&&(e.push(t[l.VVType.SIZE]),e.push(t[l.VVType.COLOR]),e.push(t[l.VVType.OPACITY]),e.push(t[l.VVType.ROTATION]))},n.prototype._writeIndices=function(e,t,r){t.push(r+0),t.push(r+1),t.push(r+2),t.push(r+1),t.push(r+3),t.push(r+2),e.indexCount+=6},n}(n.default);t.default=d});