// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../cim/cimAnalyzer","../../color","../../enums","../../number","../../WGLDisplayRecord","../../materialKey/MaterialKey","./util","./WGLDynamicMeshTemplate","../../util/Result"],function(t,e,o,i,s,c,V,r,w,A,n,f,y,C,M,T,m,a,L){Object.defineProperty(e,"__esModule",{value:!0});var P=A.vec2f32.create(),F=r.mat2df32.create(),x=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate"),h=function(i){function r(t,r){var e=i.call(this)||this;e.geometryType=y.WGLGeometryType.MARKER,e.xOffset=0,e.yOffset=0,e.width=0,e.height=0,e._dynamicPropertyMap=new Map,e._cimMarkerLayer=r;var o=0;m.isFunction(r.color)||(o=f.premultiplyAlphaRGBA(r.color));e._dynamicPropertyMap.set("_fillColor",function(t,e,i){return m.isFunction(r.color)?f.premultiplyAlphaRGBA(r.color(t,e,i)):o});var s=0;m.isFunction(r.outlineColor)||(s=f.premultiplyAlphaRGBA(r.outlineColor));var n;e._dynamicPropertyMap.set("_outlineColor",function(t,e,i){return m.isFunction(r.outlineColor)?f.premultiplyAlphaRGBA(r.outlineColor(t,e,i)):s}),m.isFunction(r.size)||(n=c.pt2px(r.size));var a;e._dynamicPropertyMap.set("_size",function(t,e,i){return m.isFunction(r.size)?c.pt2px(r.size(t,e,i)):n}),m.isFunction(r.scaleX)||(a=r.scaleX);var h;e._dynamicPropertyMap.set("_scaleX",function(t,e,i){return m.isFunction(r.scaleX)?r.scaleX(t,e,i):a}),m.isFunction(r.offsetX)||(h=c.pt2px(r.offsetX));var u;e._dynamicPropertyMap.set("xOffset",function(t,e,i){return m.isFunction(r.offsetX)?c.pt2px(r.offsetX(t,e,i)):h}),m.isFunction(r.offsetY)||(u=c.pt2px(r.offsetY));var p;e._dynamicPropertyMap.set("yOffset",function(t,e,i){return m.isFunction(r.offsetY)?c.pt2px(r.offsetY(t,e,i)):u}),m.isFunction(r.outlineWidth)||(p=c.pt2px(r.outlineWidth));var l;e._dynamicPropertyMap.set("_outlineWidth",function(t,e,i){return m.isFunction(r.outlineWidth)?c.pt2px(r.outlineWidth(t,e,i)):p}),m.isFunction(r.rotation)||(l=r.rotation);return e._dynamicPropertyMap.set("_angle",function(t,e,i){return m.isFunction(r.rotation)?r.rotation(t,e,i):l}),e._colorLockedAndAlignment=(r.alignment===y.Alignment.MAP?1:0)|(r.colorLocked?1:0)<<1,e._materialKey=T.createMaterialKey(e.geometryType,t,!1),e}return o(r,i),r.fromCIMMarker=function(t,e){return new r(t,e)},r.prototype.analyze=function(t,e){var i=this._materialCache,r=this._cimMarkerLayer.materialHash(t);if(i.has(r)){var o=i.get(r);return s.resolve(o)}return e.getMosaicItem(n.analyzeCIMResource(t,this._cimMarkerLayer.cim)).then(function(t){return i.set(r,t),t})},r.prototype.bindFeature=function(i,r,o){var s=this,t=this._dynamicPropertyMap;t&&t.forEach(function(t,e){s[e]=t(i,r,o)});var e=this._cimMarkerLayer.rotateClockwise?-this._angle:this._angle,n=this._size*this._scaleX,a=this._size,h=this.xOffset,u=this.yOffset,p=this._cimMarkerLayer.frameHeight?a/this._cimMarkerLayer.frameHeight:1,l=this._outlineWidth*p,c=this._materialCache,f=this._cimMarkerLayer.materialHash(i),y=c.get(f);if(y){var m,d;if(y&&L.ok(y.spriteMosaicItem)){d=y.spriteMosaicItem,this._sizeOutlineWidth=C.i8888to32(n,a,l,this._colorLockedAndAlignment),m=d.sdf?.5:1,V.mat2d.identity(F),V.mat2d.translate(F,F,A.vec2f32.fromValues(m*h,m*-u)),e&&V.mat2d.rotate(F,F,3.14159265359/180*e);var _=Math.round(d.rect.x/4)-128,g=Math.round(d.rect.y/4)-128,v=_+Math.round(d.rect.width/4),M=g+Math.round(d.rect.height/4);w.vec2.set(P,-.5*n,-.5*a),w.vec2.transformMat2d(P,P,F),this._offsetAndTexUpperLeft=C.i8888to32(P[0],P[1],_,g),w.vec2.set(P,.5*n,-.5*a),w.vec2.transformMat2d(P,P,F),this._offsetAndTexUpperRight=C.i8888to32(P[0],P[1],v,g),w.vec2.set(P,-.5*n,.5*a),w.vec2.transformMat2d(P,P,F),this._offsetAndTexBottomLeft=C.i8888to32(P[0],P[1],_,M),w.vec2.set(P,.5*n,.5*a),w.vec2.transformMat2d(P,P,F),this._offsetAndTexBottomRight=C.i8888to32(P[0],P[1],v,M);var x=T.MarkerMaterialKey.load(this._materialKey);d&&(x.sdf=d.sdf,x.pattern=!0,x.textureBinding=d.textureBinding),this._materialKey=x.data}}},r.prototype.writeMesh=function(t,e,i,r,o,s,n,a){var h=T.MarkerMaterialKey.load(this._materialKey),u=e.indexVector,p=e.get("geometry"),l=e.get("visibility"),c=new M(r,this.geometryType,this._materialKey),f=e.getVector("geometry").vertexCount;switch(t.push(c),c.vertexFrom=f,c.indexFrom=u.length,i){case"esriGeometryPoint":var y=o.geometry,m=y.x,d=y.y;return this._writeVertices(c,p,l,r,this._getPos(m,d),h,n,a),void this._writeIndices(c,u,f);case"esriGeometryPolyline":var _=o.geometry.paths;return void this._writeMany(c,u,p,l,f,r,_[0],h,n,a);case"esriGeometryPolygon":var g=o.centroid;if(g){m=g.x,d=g.y;this._writeVertices(c,p,l,r,this._getPos(m,d),h,n,a),this._writeIndices(c,u,f)}else x.error("Tried to render polygon geometries as markers, but found no centroid!");return;case"esriGeometryMultipoint":var v=o.geometry.points;return void this._writeMany(c,u,p,l,f,r,v,h,n,a);case"esriGeometryEnvelope":default:x.error("Unable to handle geometryType: "+i)}},r.prototype._getPos=function(t,e){return C.i1616to32(t,e)},r.prototype._writeMany=function(t,e,i,r,o,s,n,a,h,u){for(var p=0,l=0,c=0,f=0,y=n;f<y.length;f++){var m=y[f],d=m[0],_=m[1],g=this._getPos(d+p,_+l);this._writeVertices(t,i,r,s,g,a,h,u),this._writeIndices(t,e,o+c),p+=d,l+=_,c+=4}},r.prototype._writeVertices=function(t,e,i,r,o,s,n,a){e.push(o),e.push(this._offsetAndTexUpperLeft),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,n,s),i.push(a),e.push(o),e.push(this._offsetAndTexUpperRight),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,n,s),i.push(a),e.push(o),e.push(this._offsetAndTexBottomLeft),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,n,s),i.push(a),e.push(o),e.push(this._offsetAndTexBottomRight),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,n,s),i.push(a),t.vertexCount+=4},r.prototype._writeVV=function(t,e,i){i.hasVV()&&(t.push(e[y.VVType.SIZE]),t.push(e[y.VVType.COLOR]),t.push(e[y.VVType.OPACITY]),t.push(e[y.VVType.ROTATION]))},r.prototype._writeIndices=function(t,e,i){var r=i;e.push(r+0),e.push(r+1),e.push(r+2),e.push(r+1),e.push(r+3),e.push(r+2),t.indexCount+=6},r}(a.default);e.default=h});