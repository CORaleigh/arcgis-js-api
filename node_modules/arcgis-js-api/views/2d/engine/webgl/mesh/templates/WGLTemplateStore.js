// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../symbols","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../cim/cimAnalyzer","./WGLDynamicMarkerTemplate","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/BidiText","../../util/Lock","../../util/Result"],function(e,t,s,a,r,i,o,u,c,n,l,p,h,m,f,_,d){Object.defineProperty(t,"__esModule",{value:!0});var y=o.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),v=new Array,M=new r.SimpleFillSymbol({color:"black",outline:null}),T=new r.SimpleMarkerSymbol({size:"14px",color:"black",outline:null}),I=new r.SimpleLineSymbol({color:"black",width:"2px"});function b(t,e){var r=t.length;return t.push(null),e.then(function(e){return t[r]=e}),t}function g(e){return!!(1&e)}t.isDynamicId=g;var S=function(){function e(e){this._idCounter=0,this._templateIdCounter=0,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._lock=new _.default,this._fetchResource=e}return Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),e.prototype.createTemplateGroup=function(e,t,r,i){this._initErrorTemplates();var o=this._hashSymbol(e);if(!this._symbolToTemplate.has(o)){var n=new Array;t&&this._createMeshTemplates(n,t,r,i,!0),this._createMeshTemplates(n,e,r,i,!1);var s=this._createGroupId("cim"===e.type);this._idToTemplateGroup.set(s,n),this._symbolToTemplate.set(o,s)}return this._symbolToTemplate.get(o)},e.prototype.getMosaicItem=function(e){var t,r=this,i=this._createTemplateId();if("text"===e.type){var o=f.bidiText(e.text)[0];t=[];for(var n=0;n<o.length;n++)t.push(o.charCodeAt(n))}var s=u.create(function(e){return r._idToResolver.set(i,e)});return this._fetchQueue.push({symbol:e,id:i,glyphIds:t}),s},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):v},e.prototype.getDynamicTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?(g(e)||y.error("mapview-template-store","Id "+e+" does not refer to a dynamic template"),this._idToTemplateGroup.get(e)):v},e.prototype.finalize=function(){return this._fetchQueue.length||this._lock.isHeld()?_.withLock(this._lock,this._fetchAllQueuedResources.bind(this)):u.resolve()},e.prototype._initErrorTemplates=function(){if(!this._errorTemplates){var e=this._createMeshTemplates([],M,null,null,!1),t=this._createMeshTemplates([],T,null,null,!1),r=this._createMeshTemplates([],I,null,null,!1);this._errorTemplates={fill:e,marker:t,line:r}}},e.prototype._fetchAllQueuedResources=function(){var s=this;if(!this._fetchQueue.length)return u.resolve();var t=this._fetchQueue;return this._fetchQueue=[],this._fetchResource(t).then(function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t],o=i.id,n=i.mosaicItem;s._idToResolver.get(o)(n),s._idToResolver.delete(o)}}).catch(function(e){"cancel"===e.dojoType?s._fetchQueue=s._fetchQueue.concat(t):y.error(new i("mapview-template-store","Unable to fetch requested texture resources",e))})},e.prototype._createGroupId=function(e){return this._idCounter++<<1|(e?1:0)},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._getCodepoints=function(e){for(var t=f.bidiText(e.text)[0],r=[],i=0;i<t.length;i++)r.push(t.charCodeAt(i));return r},e.prototype._getMosaicItem=function(e){var t=this,r=this._createTemplateId(),i="text"===e.type&&this._getCodepoints(e),o=u.create(function(e){return t._idToResolver.set(r,e)});return this._fetchQueue.push({symbol:e.toJSON(),id:r,glyphIds:i}),o},e.prototype._hashSymbol=function(e){return e.id?e.id:JSON.stringify(e)},e.prototype._createSMS=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,d.ok(t,y)?[2,h.default.fromSimpleMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createPMS=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,d.ok(t,y)?[2,h.default.fromPictureMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createSFS=function(i,o,n){return s(this,void 0,void 0,function(){var t,r;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,d.ok(t,y)?[2,l.default.fromSimpleFill(o,r,t,n)]:[2,this._fillError]}})})},e.prototype._createPFS=function(i,o,n){return s(this,void 0,void 0,function(){var t,r;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,d.ok(t,y)?[2,l.default.fromPictureFill(o,r,t,n)]:[2,this._fillError]}})})},e.prototype._createSLS=function(i,o,n){return s(this,void 0,void 0,function(){var t,r;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,d.ok(t,y)?[2,p.default.fromSimpleLine(o,n,r,t)]:[2,this._lineError]}})})},e.prototype._createTS=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().glyphMosaicItems,[2,m.default.fromText(i,r,t)]}})})},e.prototype._createCIMText=function(e,t){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,u.resolve(null)]})})},e.prototype._createCIMFill=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return r.materialHash,[4,this.getMosaicItem(r.cim)];case 1:return t=e.sent().spriteMosaicItem,d.ok(t,y)?[2,l.default.fromCIMFill(i,r,t,!1)]:[2,this._fillError]}})})},e.prototype._createCIMLine=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return r.materialHash,[4,this.getMosaicItem(r.cim)];case 1:return t=e.sent().spriteMosaicItem,d.ok(t,y)?[2,p.default.fromCIMLine(i,r,t,!1)]:[2,this._lineError]}})})},e.prototype._createCIMMarker=function(r,i){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return r.materialHash?[2,u.resolve(n.default.fromCIMMarker(i,r))]:[4,this.getMosaicItem(r.cim)];case 1:return t=e.sent().spriteMosaicItem,d.ok(t,y)?[2,h.default.fromCIMMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createCIM=function(e,t){switch(e.type){case"marker":return this._createCIMMarker(e,t);case"line":return this._createCIMLine(e,t);case"fill":return this._createCIMFill(e,t);case"text":return this._createCIMText(e,t)}},e.prototype._createCIMMeshTemplates=function(e,t,r,i){for(var o=0,n=c.analyzeCIMSymbol(t,i);o<n.length;o++){var s=n[o];b(e,this._createCIM(s,r))}},e.prototype._createMeshTemplates=function(e,t,r,i,o){if(-1!==t.type.indexOf("3d"))return y.error("3D symbols are not supported with MapView"),e;switch(t.type){case"cim":return this._createCIMMeshTemplates(e,t,r,i),e;case"simple-marker":return b(e,this._createSMS(t,r));case"picture-marker":return b(e,this._createPMS(t,r));case"simple-fill":var n=t;return b(e,this._createSFS(n,r,o)),n.outline&&b(e,this._createSLS(n.outline,r,!0)),e;case"picture-fill":var s=t;return b(e,this._createPFS(s,r,o)),s.outline&&b(e,this._createSLS(s.outline,r,!0)),e;case"simple-line":return b(e,this._createSLS(t,r,!1));case"text":return b(e,this._createTS(t,r));default:return y.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),e}},e}();t.default=S});