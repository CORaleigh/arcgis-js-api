// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/earcut/earcut","../../color","../../definitions","../../enums","../../number","../../TileClipper","../../WGLDisplayRecord","../../materialKey/MaterialKey","../Tesselator","./WGLMeshTemplate"],function(t,e,i,r,_,g,m,w,f,T,d,O,I,v,o){Object.defineProperty(e,"__esModule",{value:!0});var x=r.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLFillTemplate"),K=[],H=[],C=128;var a=function(u){function c(t,e,i,r,o,a,s,n,h){var l=u.call(this)||this;l.fillColor=i,l.tl=r,l.br=o,l.aux1=a,l.aux2=s,l.aux3=n,l.isBFS=h,l.geometryType=f.WGLGeometryType.FILL,l.useLibtess=!0;var p=I.FillMaterialKey.load(I.createMaterialKey(l.geometryType,t,!1));return e&&(p.sdf=e.sdf,p.pattern=!0,p.textureBinding=e.textureBinding),l._materialKey=p.data,l._tesselator=new v.default,l._tileClipper=new d.TileClipper(0,0,0,1,8),l._tileClipper.setExtent(w.TILE_SIZE),l}return i(c,u),c.fromCIMFill=function(t,e,i,r){void 0===r&&(r=!1);var o=e.color,a=o&&m.premultiplyAlphaRGBA(o)||0,s=T.i8888to32(0,0,0,e.colorLocked?1:0);if(!i)return new c(t,null,a,0,0,0,0,s,r);var n=i.rect,h=i.width,l=i.height,p=n.x+1,u=n.y+1,f=p+h,d=u+l,v=T.nextHighestPowerOfTwo(_.pt2px(e.height||0));255<v?v=255:v<=0&&(v=T.nextHighestPowerOfTwo(d-u));var g=T.nextHighestPowerOfTwo(_.pt2px(e.height/l*h||0));255<g?g=255:g<=0&&(g=T.nextHighestPowerOfTwo(f-p));var x=_.pt2px(e.offsetX||0)+C;255<x&&(x=255);var y=_.pt2px(-e.offsetY||0)+C;255<y&&(y=255);var w=e.scaleX||1;return new c(t,i,a,T.i1616to32(p,u),T.i1616to32(f,d),T.i8888to32(g,v,x,y),T.i1616to32(C*w,128),0,r)},c.fromSimpleFill=function(t,e,i,r){void 0===r&&(r=!1);var o=e.color,a=o&&"none"!==e.style&&m.premultiplyAlphaRGBA(o)||0;if(!i)return new c(t,null,a,0,0,0,0,0,r);var s=i.rect,n=i.width,h=i.height,l=s.x+1,p=s.y+1,u=s.x+1+n,f=s.y+1+h;return new c(t,i,a,T.i1616to32(l,p),T.i1616to32(u,f),T.i8888to32(T.nextHighestPowerOfTwo(u-l),T.nextHighestPowerOfTwo(f-p),0,0),T.i1616to32(C,C),0,r)},c.fromPictureFill=function(t,e,i,r){void 0===r&&(r=!1);var o=w.PICTURE_FILL_COLOR,a=i.rect,s=i.width,n=i.height,h=a.x+1,l=a.y+1,p=h+s,u=l+n,f=T.i1616to32(h,l),d=T.i1616to32(p,u),v=T.nextHighestPowerOfTwo(_.pt2px(e.width));255<v&&(v=255);var g=T.nextHighestPowerOfTwo(_.pt2px(e.height));255<g&&(g=255);var x=_.pt2px(e.xoffset)+C;255<x&&(x=255);var y=_.pt2px(-e.yoffset)+C;return 255<y&&(y=255),new c(t,i,o,f,d,T.i8888to32(v,g,x,y),T.i1616to32(C*e.xscale,C*e.yscale),0,r)},c.prototype.writeMesh=function(t,e,i,r,o,a,s,n){if(K.length=0,"esriGeometryPolygon"===i){var h=o.geometry,l=this._isClippingRequired(h),p=function(t){for(var e=0,i=0;i<t.length;i++)for(var r=t[i],o=r[0],a=o[0],s=o[1],n=1;n<r.length;n++){var h=r[n],l=a+h[0],p=s+h[1];e-=(l-a)*(p+s)/2,a=l,s=p}return e}(h.rings),u=l?this._clip(h,!this.useLibtess):h.rings;return this.useLibtess?this._writeMeshLibtess(t,e,i,r,u,l,a,p,s,n):this._writeMeshEarcut(t,e,i,r,u,l,a,s,n)}x.error("Unable to handle geometryType: "+i)},c.prototype._isClippingRequired=function(t){for(var e=w.TILE_SIZE+8,i=0,r=t.rings;i<r.length;i++){var o=r[i],a=o.length;if(!(a<3)){var s=o[0][0],n=o[0][1];if(s<-8||e<s||n<-8||e<n)return!0;for(var h=1;h<a;++h)if(s+=o[h][0],n+=o[h][1],s<-8||e<s||n<-8||e<n)return!0}}return!1},c.prototype._clip=function(t,e){var i,r;this._tileClipper.reset(3);for(var o=0,a=t.rings;o<a.length;o++){var s=a[o],n=s.length;if(!(n<3)){i=s[0][0],r=s[0][1],this._tileClipper.moveTo(i,r);for(var h=1;h<n;++h)i+=s[h][0],r+=s[h][1],this._tileClipper.lineTo(i,r);this._tileClipper.close()}}return this._tileClipper.result(e)},c.prototype._writeMeshLibtess=function(t,e,i,r,o,a,s,n,h,l){if(o&&o.length){var p=[],u=e.indexVector,f=e.getVector("geometry"),d=e.getVector("visibility"),v=new O(r,this.geometryType,this._materialKey),g=I.FillMaterialKey.load(this._materialKey),x=f.vertexCount,y=a;v.vertexFrom=x,v.indexFrom=u.length,this._tesselator.beginPolygon(K,p);for(var w=0,c=o;w<c.length;w++){var _=c[w];if(!(_.length<3)){this._tesselator.beginContour();var m=void 0,T=void 0;T=y?(m=_[0].x,_[0].y):(m=_[0][0],_[0][1]);var C=[m,T,0];this._tesselator.addVertex(C,C);for(var F=1;F<_.length-1;F++){y?(m=_[F].x,T=_[F].y):(m+=_[F][0],T+=_[F][1]);var L=[m,T,0];this._tesselator.addVertex(L,L)}this._tesselator.endContour()}}this._tesselator.endPolygon(),this._writeVerticesLibTess(v,f,d,r,K,g,n,h,l),this._writeIndicesLibTess(v,u,x,p),0<v.indexCount&&t.push(v)}},c.prototype._writeMeshEarcut=function(t,e,i,r,o,a,s,n,h){if(o&&o.length){var l=e.indexVector,p=e.getVector("geometry"),u=e.getVector("visibility"),f=new O(r,this.geometryType,this._materialKey),d=I.FillMaterialKey.load(this._materialKey),v=p.vertexCount;f.vertexFrom=v,f.indexFrom=l.length,t.push(f);for(var g=0,x=0,y=a,w=0,c=o;w<c.length;w++){var _=c[w],m=x,T=void 0,C=void 0;C=y?(T=_[0].x,_[0].y):(T=_[0][0],_[0][1]),K[x++]=T,K[x++]=C;for(var F=0,L=1;L<_.length;++L){var V=void 0,b=void 0;if(y){var M=T,P=C;V=(T=_[L].x)-M,b=(C=_[L].y)-P}else T+=V=_[L][0],C+=b=_[L][1];F-=V*(C+C+b),K[x++]=T,K[x++]=C}0<F?(0<m-g&&(this._write(f,l,p,u,v,r,K,H,g,m,d,n,h),g=m),H.length=0):F<0&&0<m-g?H.push(.5*(m-g)):x=m}0<x-g&&this._write(f,l,p,u,v,r,K,H,g,x,d,n,h),K.length=H.length=0}},c.prototype._write=function(t,e,i,r,o,a,s,n,h,l,p,u,f){var d=g(s.slice(h,l),n,2);if(d.length){var v=i.vertexCount;this._writeVertices(t,i,r,a,s,n,p,u,f),this._writeIndices(t,e,v,d)}},c.prototype._writeVertices=function(t,e,i,r,o,a,s,n,h){for(var l=0;l<o.length;l+=2){var p=T.i1616to32(o[l],o[l+1]);e.data.push(p),e.data.push(r),e.data.push(this.fillColor),e.data.push(this.tl),e.data.push(this.br),e.data.push(this.aux1),e.data.push(this.aux2),e.data.push(this.aux3),this._writeVV(e.data,n,s),i.data.push(h),t.vertexCount++}},c.prototype._writeIndices=function(t,e,i,r){for(var o=i,a=0;a<r.length;a+=3)e.push(o+r[a]),e.push(o+r[a+1]),e.push(o+r[a+2]),t.indexCount+=3},c.prototype._writeVerticesLibTess=function(t,e,i,r,o,a,s,n,h){for(var l=0;l<o.length;l+=2){var p=T.i1616to32(o[l],o[l+1]);e.data.push(p),e.data.push(r),a.dotDensity||(e.data.push(this.fillColor),e.data.push(this.tl),e.data.push(this.br),e.data.push(this.aux1),e.data.push(this.aux2),e.data.push(this.aux3)),this._writeVV(e.data,n,a),this._writeDD(e.data,a,n,s),i.data.push(h),t.vertexCount++}},c.prototype._writeIndicesLibTess=function(t,e,i,r){for(var o=i,a=0;a<r.length;a++)e.push(o+r[a]),t.indexCount++},c.prototype._writeVV=function(t,e,i){i.hasVV()&&(this.isBFS?(t.writeF32(1e-30),t.writeF32(1e-30)):(t.push(e[f.VVType.COLOR]),t.push(e[f.VVType.OPACITY])))},c.prototype._writeDD=function(t,e,i,r){var o=new Float32Array(i.buffer),a=1/r;e.dotDensity&&(t.writeF32(Math.max(0,o[0]*a)),t.writeF32(Math.max(0,o[1]*a)),t.writeF32(Math.max(0,o[2]*a)),t.writeF32(Math.max(0,o[3]*a)),t.writeF32(Math.max(0,o[4]*a)),t.writeF32(Math.max(0,o[5]*a)),t.writeF32(Math.max(0,o[6]*a)),t.writeF32(Math.max(0,o[7]*a)))},c}(o.default);e.default=a});