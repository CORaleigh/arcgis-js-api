// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","./definitions","./Geometry","./GeometryUtils"],function(i,t,e,v,g){Object.defineProperty(t,"__esModule",{value:!0});var c=function(i,t,s){this.ratio=i,this.x=t,this.y=s},s=function(){function i(i,t,s,h,n){void 0===h&&(h=8),void 0===n&&(n=8),this.lines=[],this.starts=[],this.pixelRatio=h,this.pixelMargin=n,this.tileSize=e.TILE_SIZE*h,this.dz=i,this.yPos=t,this.xPos=s}return i.prototype.setExtent=function(i){this.finalRatio=this.tileSize/i*(1<<this.dz);var t=this.pixelRatio*this.pixelMargin;t/=this.finalRatio;var s=i>>this.dz;s<t&&(t=s),this.margin=t,this.xmin=s*this.xPos-t,this.ymin=s*this.yPos-t,this.xmax=this.xmin+s+2*t,this.ymax=this.ymin+s+2*t},i.prototype.reset=function(i){this.type=i,this.lines=[],this.starts=[],this.line=null,this.start=0},i.prototype.moveTo=function(i,t){this._pushLine(),this._prevIsIn=this._isIn(i,t),this._moveTo(i,t,this._prevIsIn),this._prevPt=new v.Point(i,t),this._firstPt=new v.Point(i,t),this._dist=0},i.prototype.lineTo=function(i,t){var s,h,n,e,l,r,o,a,u=this._isIn(i,t),x=new v.Point(i,t),p=v.Point.distance(this._prevPt,x);if(u)this._prevIsIn?this._lineTo(i,t,!0):(s=this._prevPt,h=x,n=this._intersect(h,s),this.start=this._dist+p*(1-this._r),this._lineTo(n.x,n.y,!0),this._lineTo(h.x,h.y,!0));else if(this._prevIsIn)h=this._prevPt,s=x,n=this._intersect(h,s),this._lineTo(n.x,n.y,!0),this._lineTo(s.x,s.y,!1);else{var y=this._prevPt,_=x;if(y.x<=this.xmin&&_.x<=this.xmin||y.x>=this.xmax&&_.x>=this.xmax||y.y<=this.ymin&&_.y<=this.ymin||y.y>=this.ymax&&_.y>=this.ymax)this._lineTo(_.x,_.y,!1);else{var m=[];if((y.x<this.xmin&&_.x>this.xmin||y.x>this.xmin&&_.x<this.xmin)&&(e=(this.xmin-y.x)/(_.x-y.x),(a=y.y+e*(_.y-y.y))<=this.ymin?r=!1:a>=this.ymax?r=!0:m.push(new c(e,this.xmin,a))),(y.x<this.xmax&&_.x>this.xmax||y.x>this.xmax&&_.x<this.xmax)&&(e=(this.xmax-y.x)/(_.x-y.x),(a=y.y+e*(_.y-y.y))<=this.ymin?r=!1:a>=this.ymax?r=!0:m.push(new c(e,this.xmax,a))),(y.y<this.ymin&&_.y>this.ymin||y.y>this.ymin&&_.y<this.ymin)&&(e=(this.ymin-y.y)/(_.y-y.y),(o=y.x+e*(_.x-y.x))<=this.xmin?l=!1:o>=this.xmax?l=!0:m.push(new c(e,o,this.ymin))),(y.y<this.ymax&&_.y>this.ymax||y.y>this.ymax&&_.y<this.ymax)&&(e=(this.ymax-y.y)/(_.y-y.y),(o=y.x+e*(_.x-y.x))<=this.xmin?l=!1:o>=this.xmax?l=!0:m.push(new c(e,o,this.ymax))),0===m.length)l?r?this._lineTo(this.xmax,this.ymax,!0):this._lineTo(this.xmax,this.ymin,!0):r?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(1<m.length&&m[0].ratio>m[1].ratio)this.start=this._dist+p*m[1].ratio,this._lineTo(m[1].x,m[1].y,!0),this._lineTo(m[0].x,m[0].y,!0);else{this.start=this._dist+p*m[0].ratio;for(var f=0;f<m.length;f++)this._lineTo(m[f].x,m[f].y,!0)}this._lineTo(_.x,_.y,!1)}}this._dist+=p,this._prevIsIn=u,this._prevPt=x},i.prototype.close=function(){if(2<this.line.length){var i=this._firstPt,t=this._prevPt;i.x===t.x&&i.y===t.y||this.lineTo(i.x,i.y);for(var s=this.line,h=s.length;4<=h&&(s[0].x===s[1].x&&s[0].x===s[h-2].x||s[0].y===s[1].y&&s[0].y===s[h-2].y);)s.pop(),s[0].x=s[h-2].x,s[0].y=s[h-2].y,--h}},i.prototype.result=function(i){return void 0===i&&(i=!0),this._pushLine(),0===this.lines.length?null:(3===this.type&&i&&n.simplify(this.tileSize,this.margin*this.finalRatio,this.lines),this.lines)},i.prototype.resultWithStarts=function(){if(2!==this.type)throw new Error("Only valid for lines");this._pushLine();var i=this.lines,t=i.length;if(0===t)return null;for(var s=[],h=0;h<t;h++)s.push({line:i[h],start:this.starts[h]||0});return s},i.prototype._isIn=function(i,t){return i>=this.xmin&&i<=this.xmax&&t>=this.ymin&&t<=this.ymax},i.prototype._intersect=function(i,t){var s,h,n;if(t.x>=this.xmin&&t.x<=this.xmax)n=((h=t.y<=this.ymin?this.ymin:this.ymax)-i.y)/(t.y-i.y),s=i.x+n*(t.x-i.x);else if(t.y>=this.ymin&&t.y<=this.ymax)n=((s=t.x<=this.xmin?this.xmin:this.xmax)-i.x)/(t.x-i.x),h=i.y+n*(t.y-i.y);else{h=t.y<=this.ymin?this.ymin:this.ymax;var e=((s=t.x<=this.xmin?this.xmin:this.xmax)-i.x)/(t.x-i.x),l=(h-i.y)/(t.y-i.y);e<l?(n=e,h=i.y+e*(t.y-i.y)):(n=l,s=i.x+l*(t.x-i.x))}return this._r=n,new v.Point(s,h)},i.prototype._pushLine=function(){this.line&&(1===this.type?0<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start)):2===this.type?1<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start)):3===this.type&&3<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start))),this.line=[],this.start=0},i.prototype._moveTo=function(i,t,s){3!==this.type?s&&(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new v.Point(i,t))):(s||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new v.Point(i,t)),this._is_h=!1,this._is_v=!1)},i.prototype._lineTo=function(i,t,s){var h,n;if(3!==this.type)if(s){if(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),0<this.line.length&&(h=this.line[this.line.length-1]).equals(i,t))return;this.line.push(new v.Point(i,t))}else this.line&&0<this.line.length&&this._pushLine();else if(s||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line&&0<this.line.length){var e=(h=this.line[this.line.length-1]).x===i,l=h.y===t;if(e&&l)return;this._is_h&&e?(h.x=i,h.y=t,(n=this.line[this.line.length-2]).x===i&&n.y===t?(this.line.pop(),this.line.length<=1?(this._is_h=!1,this._is_v=!1):(n=this.line[this.line.length-2],this._is_h=n.x===i,this._is_v=n.y===t)):(this._is_h=n.x===i,this._is_v=n.y===t)):this._is_v&&l?(h.x=i,h.y=t,(n=this.line[this.line.length-2]).x===i&&n.y===t?(this.line.pop(),this.line.length<=1?(this._is_h=!1,this._is_v=!1):(n=this.line[this.line.length-2],this._is_h=n.x===i,this._is_v=n.y===t)):(this._is_h=n.x===i,this._is_v=n.y===t)):(this.line.push(new v.Point(i,t)),this._is_h=e,this._is_v=l)}else this.line.push(new v.Point(i,t))},i}();t.TileClipper=s;var h=function(){function i(){}return i.prototype.setExtent=function(i){this._ratio=4096===i?1:4096/i},i.prototype.reset=function(i){this.type=i,this.lines=[],this.line=null},i.prototype.moveTo=function(i,t){this.line&&this.lines.push(this.line),this.line=[];var s=this._ratio;this.line.push(new v.Point(Math.round(i*s),Math.round(t*s)))},i.prototype.lineTo=function(i,t){var s=this._ratio;this.line.push(new v.Point(Math.round(i*s),Math.round(t*s)))},i.prototype.close=function(){var i=this.line;i&&!i[0].isEqual(i[i.length-1])&&i.push(i[0])},i.prototype.result=function(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:(3===this.type&&1!==this._ratio&&n.simplify(4096,64,this.lines),this.lines)},i}();t.SimpleBuilder=h;var n=function(){function v(){}return v.simplify=function(i,t,s){if(s){for(var h=-t,n=i+t,e=-t,l=i+t,r=[],o=[],a=s.length,u=0;u<a;++u){var x=s[u];if(x&&!(x.length<2))for(var p=x[0],y=void 0,_=x.length,m=1;m<_;++m)y=x[m],p.x===y.x&&(p.x<=h&&(p.y>y.y?(r.push(u),r.push(m),r.push(0),r.push(-1)):(o.push(u),o.push(m),o.push(0),o.push(-1))),p.x>=n&&(p.y<y.y?(r.push(u),r.push(m),r.push(1),r.push(-1)):(o.push(u),o.push(m),o.push(1),o.push(-1)))),p.y===y.y&&(p.y<=e&&(p.x<y.x?(r.push(u),r.push(m),r.push(2),r.push(-1)):(o.push(u),o.push(m),o.push(2),o.push(-1))),p.y>=l&&(p.x>y.x?(r.push(u),r.push(m),r.push(3),r.push(-1)):(o.push(u),o.push(m),o.push(3),o.push(-1)))),p=y}if(0!==r.length&&0!==o.length){v.fillParent(s,o,r),v.fillParent(s,r,o);var f=[];v.calcDeltas(f,o,r),v.calcDeltas(f,r,o),v.addDeltas(f,s)}}},v.fillParent=function(i,t,s){for(var h=s.length,n=t.length,e=0;e<n;e+=4){for(var l=t[e],r=t[e+1],o=t[e+2],a=i[l][r-1],u=i[l][r],x=8092,p=-1,y=0;y<h;y+=4)if(s[y+2]===o){var _=s[y],m=s[y+1],f=i[_][m-1],v=i[_][m];switch(o){case 0:case 1:if(g.between(a.y,f.y,v.y)&&g.between(u.y,f.y,v.y))(c=Math.abs(v.y-f.y))<x&&(x=c,p=y);break;case 2:case 3:var c;if(g.between(a.x,f.x,v.x)&&g.between(u.x,f.x,v.x))(c=Math.abs(v.x-f.x))<x&&(x=c,p=y)}}t[e+3]=p}},v.calcDeltas=function(i,t,s){for(var h=t.length,n=0;n<h;n+=4){var e=v.calcDelta(n,t,s,[]);i.push(t[n]),i.push(t[n+1]),i.push(t[n+2]),i.push(e)}},v.calcDelta=function(i,t,s,h){var n=t[i+3];if(-1===n)return 0;var e=h.length;return 1<e&&h[e-2]===n?0:(h.push(n),v.calcDelta(n,s,t,h)+1)},v.addDeltas=function(i,t){for(var s=i.length,h=0,n=0;n<s;n+=4){h<(r=i[n+3])&&(h=r)}for(n=0;n<s;n+=4){var e=t[i[n]],l=i[n+1],r=h-i[n+3];switch(i[n+2]){case 0:e[l-1].x-=r,e[l].x-=r,1===l&&(e[e.length-1].x-=r),l===e.length-1&&(e[0].x-=r);break;case 1:e[l-1].x+=r,e[l].x+=r,1===l&&(e[e.length-1].x+=r),l===e.length-1&&(e[0].x+=r);break;case 2:e[l-1].y-=r,e[l].y-=r,1===l&&(e[e.length-1].y-=r),l===e.length-1&&(e[0].y-=r);break;case 3:e[l-1].y+=r,e[l].y+=r,1===l&&(e[e.length-1].y+=r),l===e.length-1&&(e[0].y+=r)}}},v}(),l=function(){function i(){this.linesIn=[],this.linesOut=[]}return i.prototype.cut=function(i,t){var s;if(this.xCut=t,i.rings)this.closed=!0,s=i.rings,this.minPts=4;else{if(!i.paths)return null;this.closed=!1,s=i.paths,this.minPts=2}for(var h=0,n=s;h<n.length;h++){if((_=n[h])&&!(_.length<this.minPts)){for(var e=!0,l=0,r=_;l<r.length;l++){var o=r[l];e?(this.moveTo(o),e=!1):this.lineTo(o)}this.closed&&this.close()}}this._pushLineIn(),this._pushLineOut(),s=[];for(var a=0,u=this.linesIn;a<u.length;a++){(_=u[a])&&_.length>=this.minPts&&s.push(_)}for(var x=-2*this.xCut,p=0,y=this.linesOut;p<y.length;p++){var _;if((_=y[p])&&_.length>=this.minPts){for(var m=0,f=_;m<f.length;m++){(o=f[m])[0]+=x}s.push(_)}}return this.closed?i.rings=s:i.paths=s,i},i.prototype.moveTo=function(i){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(i[0]),this._moveTo(i[0],i[1],this._prevSide),this._prevPt=i,this._firstPt=i},i.prototype.lineTo=function(i){var t=this._side(i[0]);if(t*this._prevSide==-1){var s=this._intersect(this._prevPt,i);this._lineTo(this.xCut,s,0),this._prevSide=0,this._lineTo(i[0],i[1],t)}else this._lineTo(i[0],i[1],t);this._prevSide=t,this._prevPt=i},i.prototype.close=function(){var i=this._firstPt,t=this._prevPt;i[0]===t[0]&&i[1]===t[1]||this.lineTo(i),this._checkClosingPt(this.lineIn),this._checkClosingPt(this.lineOut)},i.prototype._moveTo=function(i,t,s){this.closed?(this.lineIn.push([s<=0?i:this.xCut,t]),this.lineOut.push([0<=s?i:this.xCut,t])):(s<=0&&this.lineIn.push([i,t]),0<=s&&this.lineOut.push([i,t]))},i.prototype._lineTo=function(i,t,s){this.closed?(this._addPolyVertex(this.lineIn,s<=0?i:this.xCut,t),this._addPolyVertex(this.lineOut,0<=s?i:this.xCut,t)):s<0?(0===this._prevSide&&this._pushLineOut(),this.lineIn.push([i,t])):0<s?(0===this._prevSide&&this._pushLineIn(),this.lineOut.push([i,t])):this._prevSide<0?(this.lineIn.push([i,t]),this.lineOut.push([i,t])):0<this._prevSide&&(this.lineOut.push([i,t]),this.lineIn.push([i,t]))},i.prototype._addPolyVertex=function(i,t,s){var h=i.length;1<h&&i[h-1][0]===t&&i[h-2][0]===t?i[h-1][1]=s:i.push([t,s])},i.prototype._checkClosingPt=function(i){var t=i.length;3<t&&i[0][0]===this.xCut&&i[t-2][0]===this.xCut&&i[1][0]===this.xCut&&(i[0][1]=i[t-2][1],i.pop())},i.prototype._side=function(i){return i<this.xCut?-1:i>this.xCut?1:0},i.prototype._intersect=function(i,t){var s=(this.xCut-i[0])/(t[0]-i[0]);return i[1]+s*(t[1]-i[1])},i.prototype._pushLineIn=function(){this.lineIn&&this.lineIn.length>=this.minPts&&this.linesIn.push(this.lineIn),this.lineIn=[]},i.prototype._pushLineOut=function(){this.lineOut&&this.lineOut.length>=this.minPts&&this.linesOut.push(this.lineOut),this.lineOut=[]},i}();t.CutVertical=l});