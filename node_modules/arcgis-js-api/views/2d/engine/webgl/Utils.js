// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../arcade/Dictionary","../../../../arcade/Feature","../../../../core/Error","../../../../core/Logger","../../../../core/screenUtils","../../../../geometry/support/quantizationUtils","../../../../support/arcadeUtils","./color","./enums","./SymbolProperties","../../../3d/support/mathUtils","../../../webgl/Texture"],function(e,n,a,i,s,t,r,o,_,V,u,c,E,I,T){var l;Object.defineProperty(n,"__esModule",{value:!0});var p=r.getLogger("esri.views.2d.engine.webgl.Utils");function y(e){for(var r={},t=0,n=e;t<n.length;t++){var i=n[t];r[i.name]=i.strideInBytes}return r}n.C_HITTEST_SEARCH_SIZE=4,n.C_VBO_GEOMETRY="geometry",n.C_VBO_PERINSTANCE="per_instance",n.C_VBO_PERINSTANCE_VV="per_instance_vv",n.C_VBO_VISIBILITY="visibility",n.C_VBO_VISIBILITY_RANGE="visibilityRange",n.C_ICON_VERTEX_DEF=[{name:n.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_ICON_VERTEX_DEF_VV=[{name:n.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_FILL_VERTEX_DEF=[{name:n.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_FILL_VERTEX_DEF_VV=[{name:n.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_FILL_VERTEX_DEF_DD=[{name:n.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_LINE_VERTEX_DEF=[{name:n.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_LINE_VERTEX_DEF_VV=[{name:n.C_VBO_GEOMETRY,strideInBytes:44,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_TEXT_VERTEX_DEF=[{name:n.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_TEXT_VERTEX_DEF_VV=[{name:n.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],n.C_LABEL_VERTEX_DEF=[{name:n.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:n.C_VBO_VISIBILITY,strideInBytes:1,divisor:0},{name:n.C_VBO_VISIBILITY_RANGE,strideInBytes:2,divisor:0}],n.C_ICON_STRIDE_SPEC=y(n.C_ICON_VERTEX_DEF),n.C_ICON_STRIDE_SPEC_VV=y(n.C_ICON_VERTEX_DEF_VV),n.C_FILL_STRIDE_SPEC=y(n.C_FILL_VERTEX_DEF),n.C_FILL_STRIDE_SPEC_VV=y(n.C_FILL_VERTEX_DEF_VV),n.C_FILL_STRIDE_SPEC_DD=y(n.C_FILL_VERTEX_DEF_DD),n.C_LINE_STRIDE_SPEC=y(n.C_LINE_VERTEX_DEF),n.C_LINE_STRIDE_SPEC_VV=y(n.C_LINE_VERTEX_DEF_VV),n.C_TEXT_STRIDE_SPEC=y(n.C_TEXT_VERTEX_DEF),n.C_TEXT_STRIDE_SPEC_VV=y(n.C_TEXT_VERTEX_DEF_VV),n.C_LABEL_STRIDE_SPEC=y(n.C_LABEL_VERTEX_DEF),n.getStrides=function(e,r,t){switch(e){case c.WGLGeometryType.MARKER:return r?n.C_ICON_STRIDE_SPEC_VV:n.C_ICON_STRIDE_SPEC;case c.WGLGeometryType.FILL:return t?n.C_FILL_STRIDE_SPEC_DD:r?n.C_FILL_STRIDE_SPEC_VV:n.C_FILL_STRIDE_SPEC;case c.WGLGeometryType.LINE:return r?n.C_LINE_STRIDE_SPEC_VV:n.C_LINE_STRIDE_SPEC;case c.WGLGeometryType.TEXT:return r?n.C_TEXT_STRIDE_SPEC_VV:n.C_TEXT_STRIDE_SPEC;case c.WGLGeometryType.LABEL:return n.C_LABEL_STRIDE_SPEC}return null};var C=[n.C_VBO_GEOMETRY,n.C_VBO_VISIBILITY],f=[n.C_VBO_GEOMETRY,n.C_VBO_VISIBILITY],d=[n.C_VBO_GEOMETRY,n.C_VBO_VISIBILITY],m=[n.C_VBO_GEOMETRY,n.C_VBO_VISIBILITY],v=[n.C_VBO_GEOMETRY,n.C_VBO_VISIBILITY,n.C_VBO_VISIBILITY_RANGE];function B(e){switch(e){case c.WGLGeometryType.MARKER:return C;case c.WGLGeometryType.FILL:return f;case c.WGLGeometryType.LINE:return d;case c.WGLGeometryType.TEXT:return m;case c.WGLGeometryType.LABEL:return v}return null}function S(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function L(e){switch(e){case"esriSMS":return"simple-marker";case"esriPMS":return"picture-marker";case"esriSLS":return"simple-line";case"esriPLS":return"picture-line";case"esriSFS":return"simple-fill";case"esriPFS":return"picture-fill";case"esriTS":return"text"}return e}function h(e){return"string"==typeof e}n.getNamedBuffers=B,n.strideToPackingFactor=S,n.allocateTypedArrayBuffer=function(e,r){switch(r%4){case 0:case 2:return new Uint32Array(Math.floor(e*r/4));case 1:case 3:return new Uint8Array(e*r)}},n.allocateTypedArrayBufferwithData=function(e,r){switch(r%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}},n.normalizeSymbolType=L,n.isMarkerSymbol=function(e){var r=L(e.type);if(r){switch(r){case"simple-marker":case"picture-marker":case"CIMPointSymbol":return!0}return!1}},n.isFillSymbol=function(e){var r=L(e.type);if(r){switch(r){case"simple-fill":case"picture-fill":case"CIMPolygonSymbol":return!0}return!1}},n.isLineSymbol=function(e){var r=L(e.type);if(r){switch(r){case"simple-line":case"picture-line":case"CIMLineSymbol":return!0}return!1}},n.isPictureSymbol=function(e){var r=L(e.type);if(r){switch(r){case"picture-marker":case"picture-line":case"picture-fill":return!0}return!1}return!1},n.isTextSymbol=function(e){var r=L(e.type);if(r){switch(r){case"text":case"CIMTextSymbol":return!0}return!1}},n.getTextProperties=function(e){return E.TextProperties.pool.acquire(e.color?u.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?u.copyAndPremultiply(e.haloColor):[255,255,255,255],o.pt2px(e.haloSize),o.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)},n.isDefined=function(e){return null!=e},n.isNumber=function(e){return"number"==typeof e},n.isString=h,n.isStringOrNull=function(e){return null==e||h(e)},n.lerp=function(e,r,t){return e+(r-e)*t};var O=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(r)},e.prototype.getKeys=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();n.KeysGetter=O;var R=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(e)},e.prototype.getValues=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();function D(e){var i={};switch(e){case"esriGeometryPoint":return function(e,r,t,n){return _.hydratePoint(r,i,e,t,n)};case"esriGeometryPolygon":return function(e,r,t,n){return _.hydratePolygon(r,i,e,t,n)};case"esriGeometryPolyline":return function(e,r,t,n){return _.hydratePolyline(r,i,e,t,n)};case"esriGeometryMultipoint":return function(e,r,t,n){return _.hydrateMultipoint(r,i,e,t,n)};default:return p.error(new t("mapview-arcade","Unable to handle geometryType: "+e)),function(e,r,t,n){return e}}}n.ValuesGetter=R,n.getCapType=function(e,r){switch(e){case"butt":return c.CapType.BUTT;case"round":return r?c.CapType.SQUARE:c.CapType.ROUND;case"square":return c.CapType.SQUARE;default:return p.error(new t("mapview-invalid-type","Cap type "+e+" is not a valid option. Defaulting to round")),c.CapType.ROUND}},n.getJoinType=function(e){switch(e){case"miter":return c.JoinType.MITER;case"bevel":return c.JoinType.BEVEL;case"round":return c.JoinType.ROUND;default:return p.error(new t("mapview-invalid-type","Join type "+e+" is not a valid option. Defaulting to round")),c.JoinType.ROUND}},n.getVVType=function(e){switch(e){case"opacity":return c.VVType.OPACITY;case"color":return c.VVType.COLOR;case"rotation":return c.VVType.ROTATION;case"size":return c.VVType.SIZE;default:return p.error("Cannot interpret unknown vv: "+e),null}},n.createHydrateFactory=D,n.getTransformParams=function(e){return{transform:e.transform,hasZ:e.hasZ,hasM:e.hasM}},n.createArcadeFunction=function(e,r,_){var t=r.fields,u=r.spatialReference,c=r.hasGeometryExpr,n=r.geometryType,E=V.createFunction(e),I=new s,T=new i({viewingMode:null,scale:null}),l={},p={vars:{$feature:I,$view:null},spatialReference:u},y={fields:t},C=D(n);return function(e,r,t){if(c){var n=r.transform,i=r.hasZ,a=r.hasM,s=C(e.geometry,n,i,a);s.spatialReference=u,I.repurposeFromGraphicLikeObject(s,e.attributes,y)}else I.repurposeFromGraphicLikeObject(e.geometry,e.attributes,y);t?((p.vars.$view=T).attributes.viewingMode=t.viewingMode,T.attributes.scale=t.scale):p.vars.$view=l;var o=V.executeFunction(E,p);return _?_(o):o}},n.copyMeshData=function(e,r,t,n,i,a,s){for(var o in a)for(var _=a[o].stride,u=S(_),c=a[o].data,E=t[o].data,I=_*i.vertexCount/u,T=_*e/u,l=_*i.vertexFrom/u,p=0;p<I;++p)E[p+T]=c[p+l];var y=i.indexCount;for(p=0;p<y;++p)n[p+r]=s[p+i.indexFrom]-i.vertexFrom+e},n.C_VBO_INFO=((l={})[n.C_VBO_GEOMETRY]=35044,l[n.C_VBO_VISIBILITY]=35044,l[n.C_VBO_VISIBILITY_RANGE]=35048,l),n.createGeometryData=function(e,r){for(var t=[],n=0;n<5;++n){for(var i={},a=0,s=B(n);a<s.length;a++){var o=s[a];i[o]={data:r(n,o)}}t.push({data:e(n),buffers:i})}return t},n.resampleHermite=function(e,r,t,n,i,a,s){void 0===s&&(s=!0);for(var o=r/i,_=t/a,u=Math.ceil(o/2),c=Math.ceil(_/2),E=0;E<a;E++)for(var I=0;I<i;I++){for(var T=4*(I+(s?a-E-1:E)*i),l=0,p=0,y=0,C=0,V=0,f=0,d=0,m=(E+.5)*_,v=Math.floor(E*_);v<(E+1)*_;v++)for(var B=Math.abs(m-(v+.5))/c,S=(I+.5)*o,L=B*B,h=Math.floor(I*o);h<(I+1)*o;h++){var O=Math.abs(S-(h+.5))/u,R=Math.sqrt(L+O*O);-1<=R&&R<=1&&0<(l=2*R*R*R-3*R*R+1)&&(d+=l*e[3+(O=4*(h+v*r))],y+=l,e[O+3]<255&&(l=l*e[O+3]/250),C+=l*e[O],V+=l*e[O+1],f+=l*e[O+2],p+=l)}n[T]=C/p,n[T+1]=V/p,n[T+2]=f/p,n[T+3]=d/y}},n.createTextureFromTexelData=function(e,r){var t,n;return n=I.isPowerOfTwo(r.width)&&I.isPowerOfTwo(r.height)?(t=!0,9987):(t=!1,9729),new T(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,hasMipmap:t,samplingMode:n,wrapMode:33071,flipped:!0},r)},n.geometryToMappedGeometry=function(e){return{vertexFrom:void 0,vertexTo:void 0,geometry:e}};var g=new Map;n.createProgramDescriptor=function(e,r){if(!g.has(e)){var t=function(n){var i={},e=function(e){var r=n[e],t=0;i[e]=r.map(function(e){var r=a({},e,{normalized:e.normalized||!1,divisor:e.divisor||0,offset:t,stride:0});return t+=e.count*function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5126:case 5124:case 5125:return 4}}(e.type),r}),i[e].forEach(function(e){return e.stride=t})};for(var r in n)e(r);return i}(r),n={strides:function(e){var r={};for(var t in e){var n=e[t];r[t]=n.length?n[0].stride:0}return r}(t),bufferLayouts:t,attributes:function(e){var r={};for(var t in e)for(var n=0,i=e[t];n<i.length;n++){var a=i[n];r[a.name]=a.location}return r}(r)};g.set(e,n)}return g.get(e)}});