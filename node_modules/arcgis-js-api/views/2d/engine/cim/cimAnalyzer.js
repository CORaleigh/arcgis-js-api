// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../webgl/CIMSymbolHelper","../webgl/enums","../webgl/SDFHelper","../webgl/Utils"],function(e,i,t,o,r,a){function l(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function m(e){switch(e){case"Butt":return o.CapType.BUTT;case"Square":return o.CapType.SQUARE;case"Round":default:return o.CapType.ROUND}}function n(e){switch(e){case"Bevel":return o.JoinType.BEVEL;case"Miter":return o.JoinType.MITER;case"Round":default:return o.JoinType.ROUND}}function c(e,i){var t=[],o=e.data.symbol,r=e.data.primitiveOverrides;switch(o.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":s(o,i,r,t)}return t}function s(e,i,r,a){if(e){var c=e.symbolLayers;if(c){var s,u=t.CIMSymbolHelper.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(s=o.Alignment.MAP);for(var y=c.length;y--;){var v=c[y];if(v&&!1!==v.enable)switch(v.type){case"CIMSolidFill":a.push({type:"fill",materialHash:null,cim:v,colorLocked:v.colorLocked,color:f(v.primitiveName,"Color",r,i)||l(v.color),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1});break;case"CIMPictureFill":a.push({type:"fill",materialHash:null,cim:v,colorLocked:v.colorLocked,color:f(v.primitiveName,"TintColor",r,i)||l(v.tintColor),height:f(v.primitiveName,"Height",r,i)||v.height,scaleX:f(v.primitiveName,"ScaleX",r,i)||v.scaleX,angle:f(v.primitiveName,"Rotation",r,i)||v.rotation,offsetX:f(v.primitiveName,"OffsetX",r,i)||v.offsetY,offsetY:f(v.primitiveName,"OffsetY",r,i)||v.offsetY});break;case"CIMHatchFill":case"CIMGradientFill":break;case"CIMSolidStroke":var h=void 0!==v.width?v.width:4;a.push({type:"line",materialHash:null,cim:v,isOutline:"CIMPolygonSymbol"===e.type,colorLocked:v.colorLocked,color:f(v.primitiveName,"Color",r,i)||l(v.color),width:f(v.primitiveName,"Width",r,i)||h,cap:f(v.primitiveName,"CapStyle",r,i)||m(v.capStyle),join:f(v.primitiveName,"JoinStyle",r,i)||n(v.joinStyle),miterLimit:f(v.primitiveName,"MiterLimit",r,i)||v.miterLimit,sizeRatio:u?h/u:1,isDashed:!1});break;case"CIMPictureStroke":var h=void 0!==v.width?v.width:4;a.push({type:"line",materialHash:null,cim:v,isOutline:"CIMPolygonSymbol"===e.type,colorLocked:v.colorLocked,color:f(v.primitiveName,"TintColor",r,i)||l(v.tintColor),width:f(v.primitiveName,"Width",r,i)||h,cap:f(v.primitiveName,"CapStyle",r,i)||m(v.capStyle),join:f(v.primitiveName,"JoinStyle",r,i)||n(v.joinStyle),miterLimit:f(v.primitiveName,"MiterLimit",r,i)||v.miterLimit,sizeRatio:u?h/u:1,isDashed:!1});break;case"CIMGradientStroke":var h=void 0!==v.width?v.width:4;a.push({type:"line",materialHash:null,cim:v,isOutline:"CIMPolygonSymbol"===e.type,colorLocked:v.colorLocked,color:{r:0,g:0,b:0,a:1},width:f(v.primitiveName,"Width",r,i)||h,cap:f(v.primitiveName,"CapStyle",r,i)||m(v.capStyle),join:f(v.primitiveName,"JoinStyle",r,i)||n(v.joinStyle),miterLimit:f(v.primitiveName,"MiterLimit",r,i)||v.miterLimit,sizeRatio:u?h/u:1,isDashed:!1});break;case"CIMCharacterMarker":break;case"CIMPictureMarker":a.push({type:"marker",materialHash:null,cim:v,colorLocked:v.colorLocked,alignment:s,anchorPoint:v.anchorPoint,size:f(v.primitiveName,"Size",r,i)||v.size,scaleX:f(v.primitiveName,"ScaleX",r,i)||v.scaleX,rotation:f(v.primitiveName,"Rotation",r,i)||v.rotation,offsetX:f(v.primitiveName,"OffsetX",r,i)||v.offsetX,offsetY:f(v.primitiveName,"OffsetY",r,i)||v.offsetY,color:f(v.primitiveName,"TintColor",r,i)||l(v.tintColor),outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:v.rotateClockwise,sizeRatio:u?v.size/u:1});break;case"CIMVectorMarker":p(v,i,r,u,s,a)}}}}}function p(e,i,o,a,m,n){var c=e.markerGraphics;if(c){var s=0;if(e.scaleSymbolsProportionally){var p=e.frame;p&&(s=p.ymax-p.ymin)}for(var u=0,y=c;u<y.length;u++){if(y[u]){var v=r.getSDFSymbol(e),h=v&&"CIMLineSymbol"===v.type?.5:1;n.push({type:"marker",materialHash:o?function(e){return"0"}:null,cim:e,colorLocked:e.colorLocked,alignment:m,anchorPoint:e.anchorPoint,size:f(e.primitiveName,"Size",o,i)||e.size,scaleX:1,rotation:f(e.primitiveName,"Rotation",o,i)||e.rotation,offsetX:f(e.primitiveName,"OffsetX",o,i)||e.offsetX,offsetY:f(e.primitiveName,"OffsetY",o,i)||e.offsetY,color:l(t.CIMSymbolHelper.getFillColor(v)),outlineColor:l(t.CIMSymbolHelper.getStrokeColor(v)),outlineWidth:t.CIMSymbolHelper.getStrokeWidth(v)*h,frameHeight:s,rotateClockwise:e.rotateClockwise,sizeRatio:a?e.size/a:1})}}}}function f(e,i,t,o){if(!e)return null;for(var r=0,l=t;r<l.length;r++){var m=l[r];if(m.primitiveName===e&&m.propertyName===i){var n=m.valueExpressionInfo;if(n)return a.createArcadeFunction(n.expression,o)}}return null}function u(e,i){return i}Object.defineProperty(i,"__esModule",{value:!0}),i.analyzeCIMSymbol=c,i.analyzeCIMResource=u});