// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../geometry","../../../../Viewpoint","../../../../core/Accessor","../../../../core/accessorSupport/decorators","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../viewpointUtils","../../../navigation/RotationMomentumEstimator","../../../navigation/ZoomMomentumEstimator"],function(t,o,i,e,n,a,m,s,r,u,p,h,c){return function(t){function o(o){var i=t.call(this,o)||this;return i._animationTime=0,i._momentumFinished=!1,i._rotationMomentumEstimator=new h.RotationMomentumEstimator(.6,.15,.95),i._rotationDirection=1,i._zoomDirection=1,i._zoomMomentumEstimator=new c.ZoomMomentumEstimator,i._zoomOnly=null,i.zoomMomentum=null,i.rotateMomentum=null,i.viewpoint=new a({targetGeometry:new n.Point,scale:0,rotation:0}),i.watch("_momentumFinished",function(t){t&&i.navigation.stop()}),i}return i(o,t),o.prototype.begin=function(t,o){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=o.angle,this._previousRadius=this._startRadius=o.radius,this._previousCenter=o.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,o.timestamp),this.addToZoomEstimator(o,1)},o.prototype.update=function(t,o){null===this._updateTimestamp&&(this._updateTimestamp=o.timestamp);var i=o.angle,e=o.radius,n=o.center,a=Math.abs(180*(i-this._startAngle)/Math.PI),m=Math.abs(e-this._startRadius),s=this._startRadius/e;if(this._previousRadius){var r=e/this._previousRadius,u=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=u>=0?1:-1,this._zoomDirection=r>=1?1:-1,t.constraints.rotationEnabled?(null===this._zoomOnly&&o.timestamp-this._updateTimestamp>200&&(this._zoomOnly=m-a>0),null===this._zoomOnly||this._zoomOnly?u=0:this.addToRotateEstimator(i-this._startAngle,o.timestamp)):u=0,this.addToZoomEstimator(o,s),this.navigation.setViewpoint([n.x,n.y],1/r,u,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=e,this._previousCenter=n},o.prototype.end=function(t,o){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()},o.prototype.addToRotateEstimator=function(t,o){this._rotationMomentumEstimator.add(t,.001*o)},o.prototype.addToZoomEstimator=function(t,o){this._zoomMomentumEstimator.add(o,.001*t.timestamp)},o.prototype.canZoomIn=function(t){var o=t.scale,i=t.constraints.effectiveMaxScale;return 0===i||o>i},o.prototype.canZoomOut=function(t){var o=t.scale,i=t.constraints.effectiveMinScale;return 0===i||o<i},o.prototype.onAnimationUpdate=function(t){var o=this;this.navigation.animationManager.animateContinous(t.viewpoint,function(i,e){var n=!o.canZoomIn(t)&&o._zoomDirection>1||!o.canZoomOut(t)&&o._zoomDirection<1,a=!o.rotateMomentum||o.rotateMomentum.isFinished(o._animationTime),m=n||!o.zoomMomentum||o.zoomMomentum.isFinished(o._animationTime),s=.001*e;if(o._momentumFinished=a&&m,!o._momentumFinished){var h=o.rotateMomentum?Math.abs(o.rotateMomentum.valueDelta(o._animationTime,s))*o._rotationDirection*180/Math.PI:0,c=o.zoomMomentum?Math.abs(o.zoomMomentum.valueDelta(o._animationTime,s)):1,l=u.vec2f64.create(),d=u.vec2f64.create();if(o._previousCenter){r.vec2.set(l,o._previousCenter.x,o._previousCenter.y),p.getPaddingScreenTranslation(d,t.size,t.padding),r.vec2.add(l,l,d);var _=t.constraints,v=t.scale,M=v*c;c<1&&!_.canZoomInTo(M)?(c=v/_.effectiveMaxScale,o.zoomMomentum=null,o.rotateMomentum=null):c>1&&!_.canZoomOutTo(M)&&(c=v/_.effectiveMinScale,o.zoomMomentum=null,o.rotateMomentum=null),p.scaleAndRotateBy(i,t.viewpoint,c,h,l,t.size)}}o._animationTime+=s})},o.prototype.stopMomentumNavigation=function(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())},e([s.property()],o.prototype,"_momentumFinished",void 0),e([s.property()],o.prototype,"viewpoint",void 0),e([s.property()],o.prototype,"navigation",void 0),o=e([s.subclass("esri.views.2d.navigation.actions.Pinch")],o)}(s.declared(m))});