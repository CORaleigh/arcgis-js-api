// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/intersects","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../engine/webgl/definitions","../../engine/webgl/fontUtils","../../engine/webgl/GeometryUtils","../../engine/webgl/TextShapingNew","../../engine/webgl/TileClipper","../../engine/webgl/util/BidiText"],function(e,t,r,n,a,i,s,c,m,o,l,x,u,f,v,p,g,h,y,d,b){function M(e){if(x.isPolygon(e))for(var t=0,r=e.rings;t<r.length;t++){var n=r[t];n.length<3||(n[0][0]===n[n.length-1][0]&&n[0][1]===n[n.length-1][1]||n.push(n[0]))}}function T(e,t,r,n,a,i,s,c,m){if(!n)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var l=r.symbol;if(!l&&i&&(l=i.getSymbol(r,{scale:c})),!l)return e;var u=n;if(!x.isPoint(u)){o.getBoundsXY(e,u);var f=t[0];0===f&&(f=D(l,a),t[0]=f);var v=s*f,p=v/2;return e[0]-=p,e[1]-=p,e[2]+=p,e[3]+=p,e}var g=u.x,h=u.y;switch(l.type){case"simple-marker":case"picture-marker":P(e,g,h,l,s,m);break;case"text":0===t[2]&&0===t[3]&&G(t,l,a),N(e,g,h,l,t,s,m)}return e}function I(e){return"simple-marker"===e||"picture-marker"===e||"text"===e}function _(e){switch(e.geometry.type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function w(e){switch(e){case"left":return 1;case"right":return-1;case"center":case"justify":return 0}}function E(e){switch(e){case"top":return-1;case"middle":return 0;case"baseline":case"bottom":return 1}}function X(e){switch(e){case"left":return 0;case"right":return 1;case"center":case"justify":return.5}}function A(e,t,r,n){i.vec2.set(Q,t,r);for(var a,s,c,m,o,l,x,u,f,v=e.paths,p=1/0,g=0;g<v.length;g++){var h=v[g];if(!(h.length<2))for(var y=1;y<h.length;y++)a=h[y-1][0],c=h[y-1][1],s=h[y][0],m=h[y][1],o=Math.min(a,s)-n,l=Math.min(c,m)-n,x=Math.max(a,s)+n,u=Math.max(c,m)+n,t<o||t>x||r<l||r>u||(i.vec2.set(V,a,c),i.vec2.set(K,s,m),i.vec2.subtract(Z,K,V),i.vec2.subtract($,V,Q),i.vec2.scale(ee,Z,i.vec2.dot(Z,$)/i.vec2.dot(Z,Z)),i.vec2.subtract(te,$,ee),f=i.vec2.dot(te,te),p>f&&(p=f))}return Math.sqrt(p)<=n}function z(e,t,a,s,c){var m,o,l=r.pt2px(a.xoffset),x=r.pt2px(a.yoffset),u=h.C_DEG_TO_RAD*a.angle,f=h.C_DEG_TO_RAD*c;switch(a.type){case"simple-marker":var v=a;m=o=r.pt2px(v.size);break;case"picture-marker":var p=a;m=r.pt2px(p.width),o=r.pt2px(p.height)}var g=n.mat2d.identity(Y);n.mat2d.translate(g,g,i.vec2.set(J,e,t)),n.mat2d.rotate(g,g,f-u),n.mat2d.scale(g,g,i.vec2.set(J,s,-s)),n.mat2d.translate(g,g,i.vec2.set(J,l,-x));var y=[0,0];i.vec2.transformMat2d(y,i.vec2.set(J,-.5*m,-.5*o),g);var d=[0,0];i.vec2.transformMat2d(d,i.vec2.set(J,-.5*m,.5*o),g);var b=[0,0];i.vec2.transformMat2d(b,i.vec2.set(J,.5*m,-.5*o),g);var M=[0,0];return i.vec2.transformMat2d(M,i.vec2.set(J,.5*m,.5*o),g),{rings:[[y,b,M,d,y]]}}function S(e,t,a,s,c,m){var o=E(a.verticalAlignment||"baseline"),l="baseline"===(a.verticalAlignment||"baseline"),x=r.pt2px(a.xoffset),u=r.pt2px(a.yoffset),f=r.pt2px(a.font.size)/24,v=4*f,p=l?25*f:s[1]+(1+o)*s[3]*.5,g=h.C_DEG_TO_RAD*a.angle,y=h.C_DEG_TO_RAD*m,d=n.mat2d.identity(Y);n.mat2d.translate(d,d,i.vec2.set(J,e,t)),n.mat2d.rotate(d,d,y-g),n.mat2d.scale(d,d,i.vec2.set(J,c,-c)),n.mat2d.translate(d,d,i.vec2.set(J,x,-u)),n.mat2d.translate(d,d,i.vec2.set(J,-v,-v-p));var b=[0,0];i.vec2.transformMat2d(b,i.vec2.set(J,s[0],s[1]),d);var M=[0,0];i.vec2.transformMat2d(M,i.vec2.set(J,s[0],s[1]+s[3]),d);var T=[0,0];i.vec2.transformMat2d(T,i.vec2.set(J,s[0]+s[2],s[1]),d);var I=[0,0];return i.vec2.transformMat2d(I,i.vec2.set(J,s[0]+s[2],s[1]+s[3]),d),{rings:[[b,T,I,M,b]]}}function k(e){var t,r,n,a,i,s,c,m,u=null;if(!e)return null;t=e.spatialReference,r=f.getInfo(t),n=t.isWebMercator,s=n?102100:4326,a=ne[s].maxX,i=ne[s].minX,c=ne[s].plus180Line,m=ne[s].minus180Line;var v,p=e.toJSON();if(!r)return p;if("mesh"===e.type)v=p;else if(x.isPoint(p))v=q(p,a,i);else if(x.isMultipoint(p))p.points=p.points.map(function(e){return q(e,a,i)}),v=p;else if(x.isExtent(p))v=B(p,r);else if(x.isPolygon(p)||x.isPolyline(p)){var g=F;o.getBoundsXY(g,p);var h={xmin:g[0],ymin:g[1],xmax:g[2],ymax:g[3]},y=H(h.xmin,i),b=y*(2*a),M=0===b?p:L(p,b);h.xmin+=b,h.xmax+=b,l.extentIntersectsPolyline(h,c)&&h.xmax!==a?u=M:l.extentIntersectsPolyline(h,m)&&h.xmin!==i?u=M:v=M}else v=e.clone();if(null!==u){return(new d.CutVertical).cut(u,a)}return v}function D(e,t){var r=0;switch(e.type){case"simple-fill":case"picture-fill":var n=e.outline;if(!n)return 0;r=n.width;break;case"simple-line":r=e.width;break;case"simple-marker":r=e.size;break;case"picture-marker":r=Math.max(e.width,e.height);break;case"text":var a=[0,0,0,0];G(a,e,t),r=Math.max(a[0],a[1])}return r}function G(e,t,n){if(!n||0===n.glyphMosaicItems.length)return e;var a=b.bidiText(t.text),i=a[0],s=a[1],c=X(t.horizontalAlignment||"center"),m=w(t.horizontalAlignment||"center"),o=n.glyphMosaicItems,l=new y([o],p.TEXT_MAX_WIDTH,p.TEXT_LINE_HEIGHT,p.TEXT_SPACING,[0,.5*-p.TEXT_LINE_HEIGHT],.5*(1-m),0,c),x=l.getShaping(i,s),u=g.getFontDecorationTop(t.font);isNaN(u)||y.addDecoration(x,u);var f=y.getBox(x),v=r.pt2px(t.font.size),h=v/re;return e[0]=h*f.x,e[1]=h*f.y,e[2]=h*f.width,e[3]=h*f.height,e}function R(e,t,n){var a=b.bidiText(t.text),i=a[0],s=a[1],c=X(t.horizontalAlignment||"center"),m=w(t.horizontalAlignment||"center"),o=new y([],p.TEXT_MAX_WIDTH,p.TEXT_LINE_HEIGHT,p.TEXT_SPACING,[0,.5*-p.TEXT_LINE_HEIGHT],.5*(1-m),0,c),l=o.getEstimatedShaping(i,s,n),x=y.getBox(l),u=r.pt2px(t.font.size),f=u/re;return e[0]=f*x.x,e[1]=f*x.y,e[2]=f*x.width,e[3]=f*x.height,e}function P(e,t,r,n,a,i){for(var s,c,m=z(t,r,n,a,0),o=0,l=0;l<m.rings[0].length-1;l++)c=m.rings[0][l],s=(t-c[0])*(t-c[0])+(r-c[1])*(r-c[1]),o=Math.max(o,s);o=Math.sqrt(o);var x=u.normalizeMapX(t-o,i),f=u.normalizeMapX(t+o,i);if(x>f){var p=v.getInfo(i);if(p){var g=p.valid,h=g[0],y=g[1];x=h,f=y}}return e[0]=x,e[1]=r-o,e[2]=f,e[3]=r+o,e}function N(e,t,r,n,a,i,s){for(var c,m,o=S(t,r,n,a,i,0),l=0,x=0;x<o.rings[0].length-1;x++)m=o.rings[0][x],c=(t-m[0])*(t-m[0])+(r-m[1])*(r-m[1]),l=Math.max(l,c);l=Math.sqrt(l);var f=u.normalizeMapX(t-l,s),p=u.normalizeMapX(t+l,s);if(f>p){var g=v.getInfo(s);if(g){var h=g.valid,y=h[0],d=h[1];f=y,p=d}}return e[0]=f,e[1]=r-l,e[2]=p,e[3]=r+l,e}function C(e){return x.isPolygon(e)?e.rings:e.paths}function H(e,t){return Math.ceil((e-t)/(2*t))}function L(e,t){for(var r=C(e),n=0,a=r;n<a.length;n++)for(var i=a[n],s=0,c=i;s<c.length;s++){var m=c[s];m[0]+=t}return e}function B(e,t){if(!t)return e;var r=U(e,t).map(function(e){return e.extent});return r.length<2?r[0]||e:r.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:r.map(function(e){return[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]})}}function U(e,t){var r,n=[],a=e.ymin,i=e.ymax,s=e.xmax-e.xmin,c=e.xmin,m=e.xmax,o=t.valid,l=o[0],x=o[1];r=O(e.xmin,t);var u=r.x,f=r.frameId;r=O(e.xmax,t);var v=r.x,p=r.frameId,g=u===v&&s>0;if(s>2*x){var h={xmin:c<m?u:v,ymin:a,xmax:x,ymax:i},y={xmin:l,ymin:a,xmax:c<m?v:u,ymax:i},d={xmin:0,ymin:a,xmax:x,ymax:i},b={xmin:l,ymin:a,xmax:0,ymax:i},M=[],T=[];W(h,d)&&M.push(f),W(h,b)&&T.push(f),W(y,d)&&M.push(p),W(y,b)&&T.push(p);for(var I=f+1;I<p;I++)M.push(I),T.push(I);n.push({extent:h,frameIds:[f]},{extent:y,frameIds:[p]},{extent:d,frameIds:M},{extent:b,frameIds:T})}else u>v||g?n.push({extent:{xmin:u,ymin:a,xmax:x,ymax:i},frameIds:[f]},{extent:{xmin:l,ymin:a,xmax:v,ymax:i},frameIds:[p]}):n.push({extent:{xmin:u,ymin:a,xmax:v,ymax:i},frameIds:[f]});return n}function O(e,t){var r,n=t.valid,a=n[0],i=n[1],s=2*i,c=0;return e>i?(r=Math.ceil(Math.abs(e-i)/s),e-=r*s,c=r):e<a&&(r=Math.ceil(Math.abs(e-a)/s),e+=r*s,c=-r),{x:e,frameId:c}}function W(e,t){var r=t.xmin,n=t.ymin,a=t.xmax,i=t.ymax;return j(e,r,n)&&j(e,r,i)&&j(e,a,i)&&j(e,a,n)}function j(e,t,r){return t>=e.xmin&&t<=e.xmax&&r>=e.ymin&&r<=e.ymax}function q(e,t,r){if(Array.isArray(e)){var n=e[0];if(n>t){var a=H(n,t);e[0]=n+a*(-2*t)}else if(n<r){var a=H(n,r);e[0]=n+a*(-2*r)}}else{var n=e.x;if(n>t){var a=H(n,t);e.x+=a*(-2*t)}else if(n<r){var a=H(n,r);e.x+=a*(-2*r)}}return e}Object.defineProperty(t,"__esModule",{value:!0});var Y=a.mat2df32.create(),J=s.vec2f32.create(),F=m.create();t.ensureClosedRings=M,t.getBounds=T,t.isMarkerSymbol=I,t.graphicGeometryToNumber=_,t.getXAnchorDirection=w,t.getYAnchorDirection=E,t.getJustification=X;var V=s.vec2f32.create(),K=s.vec2f32.create(),Q=s.vec2f32.create(),Z=s.vec2f32.create(),$=s.vec2f32.create(),ee=s.vec2f32.create(),te=s.vec2f32.create();t.isPointOnPolyline=A,t.getMarkerSymbolBounds=z,t.getTextSymbolBounds=S,t.normalizeCentralMeridian=k;var re=24;t.getTextSymbolSize=G,t.getTextSymbolEstimatedSize=R;var ne={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:c.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:c.WGS84}}}});