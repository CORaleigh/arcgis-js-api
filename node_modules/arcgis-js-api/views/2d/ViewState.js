// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Viewpoint","../../core/JSONSupport","../../core/accessorSupport/decorators","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df32","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/mat3","../../core/libs/gl-matrix-2/mat3f32","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f32","../../core/libs/gl-matrix-2/vec2f64","../../core/libs/gl-matrix-2/types/vec2","./viewpointUtils"],function(t,e,i,r,o,a,s,n,p,c,l,f,m,h,v,d,u,y,w){var x=[0,0];return function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var r=t.apply(this,e)||this;return r._viewpoint2D={center:u.vec2f64.create(),rotation:0,scale:0,spatialReference:null},r.center=[0,0],r.extent=new o.Extent,r.id=0,r.inverseTransform=f.mat2df64.create(),r.resolution=0,r.rotation=0,r.scale=0,r.transform=f.mat2df64.create(),r.transformNoRotation=f.mat2df64.create(),r.displayMat3=h.mat3f32.create(),r.displayViewMat3=h.mat3f32.create(),r.viewMat3=h.mat3f32.create(),r.viewMat2d=l.mat2df32.create(),r.worldScreenWidth=0,r.size=[0,0],r}i(e,t),s=e,Object.defineProperty(e.prototype,"pixelRatio",{set:function(t){this._set("pixelRatio",t),this._update()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{set:function(t){this._set("size",t),this._update()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewpoint",{set:function(t){if(t){var e=this._viewpoint2D,i=t.targetGeometry;e.center[0]=i.x,e.center[1]=i.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=i.spatialReference}this._update()},enumerable:!0,configurable:!0}),e.prototype.copy=function(t){var e=this.size,i=this.viewpoint;return i&&e?(this.viewpoint=w.copy(i,t.viewpoint),this._set("size",v.vec2.copy(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this},e.prototype.clone=function(){return new s({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})},e.prototype.toMap=function(t,e,i){return y.isVec2(e)?v.vec2.transformMat2d(t,e,this.inverseTransform):(x[0]=e,x[1]=i,v.vec2.transformMat2d(t,x,this.inverseTransform))},e.prototype.toScreen=function(t,e,i){return y.isVec2(e)?v.vec2.transformMat2d(t,e,this.transform):(x[0]=e,x[1]=i,v.vec2.transformMat2d(t,x,this.transform))},e.prototype.toScreenNoRotation=function(t,e,i){return y.isVec2(e)?v.vec2.transformMat2d(t,e,this.transformNoRotation):(x[0]=e,x[1]=i,v.vec2.transformMat2d(t,x,this.transformNoRotation))},e.prototype.pixelSizeAt=function(t){var e=this.viewpoint;return w.pixelSizeAt(t,e,this.size)},e.prototype.getScreenTransform=function(t,e){var i=this._viewpoint2D.center,r=this._get("pixelRatio")||1,o=this._get("size");return w.getMatrix(t,i,o,e,0,r),t},e.prototype._update=function(){var t=this._viewpoint2D,e=t.center,i=t.spatialReference,r=t.scale,s=t.rotation,n=this._get("pixelRatio")||1,l=this._get("size");this._set("id",this.id+1);var f=new a({targetGeometry:new o.Point(e[0],e[1],i),scale:r,rotation:s});if(this._set("viewpoint",f),l&&i&&r){this.resolution=w.getResolution(f),this.rotation=s,this.scale=r,this.spatialReference=i,v.vec2.copy(this.center,e);var h=0!==l[0]?2/l[0]:0,u=0!==l[1]?-2/l[1]:0;m.mat3.set(this.displayMat3,h,0,0,0,u,0,-1,1,1);var y=m.mat3.identity(this.viewMat3),x=d.vec2f32.fromValues(l[0]/2,l[1]/2),g=d.vec2f32.fromValues(-l[0]/2,-l[1]/2),R=p.common.toRadian(s);m.mat3.translate(y,y,x),m.mat3.rotate(y,y,R),m.mat3.translate(y,y,g),m.mat3.multiply(this.displayViewMat3,this.displayMat3,y);var b=c.mat2d.identity(this.viewMat2d);return c.mat2d.translate(b,b,x),c.mat2d.rotate(b,b,R),c.mat2d.translate(b,b,g),w.getExtent(this.extent,f,l),w.getTransform(this.transform,f,l,n),c.mat2d.invert(this.inverseTransform,this.transform),w.getTransformNoRotation(this.transformNoRotation,f,l,n),this.worldScreenWidth=w.getWorldScreenWidth(this.spatialReference,this.resolution),this}};var s;return r([n.property({readOnly:!0})],e.prototype,"id",void 0),r([n.property({value:1,json:{write:!0}})],e.prototype,"pixelRatio",null),r([n.property({json:{write:!0}})],e.prototype,"size",null),r([n.property({type:a,json:{write:!0}})],e.prototype,"viewpoint",null),e=s=r([n.subclass("esri.views.2d.ViewState")],e)}(n.declared(s))});