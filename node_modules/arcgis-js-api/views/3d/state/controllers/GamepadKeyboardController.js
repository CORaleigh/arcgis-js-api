// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../camera/constraintUtils","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/navigationUtils","../utils/viewUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../webgl-engine/lib/Camera","../../../navigation/gamepadAndKeyboardUtils"],function(t,e,a,i,r,n,o,s,l,c,p,d,m,v,h,u,f,y,g,w,C,b){function T(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,r.mat4.identity(t.pan.matrix),t.rotate.enabled=!1,r.mat4.identity(t.rotate.matrix)}Object.defineProperty(e,"__esModule",{value:!0});var S=function(t){function e(e,a,i){var r=t.call(this)||this;return r.view=e,r.gamepadDevice=a,r.disableMovements=i,r.transformation={translation:[0,0,0],heading:0,tilt:0},r.keysButtonState=[0,0,0,0,0,0,0,0,0,0],r.tmpCamera=new C,r.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new C,interactionFactor:0,interactionDirection:null,tiltMode:1},r}return a(e,t),e.prototype.handleEventGamepad=function(t){var e=b.extractTransformation(t,this.view.navigation.gamepad,this.transformation);if("end"===t.action||b.isZeroTransformation(e))return void this.finishController()},e.prototype.activateDirection=function(t){this.keysButtonState[t]=1,b.extractTransformationKeyboard(this.keysButtonState,this.transformation)},e.prototype.deactivateDirection=function(t){this.keysButtonState[t]=0;var e=b.extractTransformationKeyboard(this.keysButtonState,this.transformation);b.isZeroTransformation(e)&&this.finishController()},e.prototype.onControllerStart=function(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,t.prototype.onControllerStart.call(this,e)},e.prototype.updateFilteredSurfaceElevation=function(t){var e=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(e-this.filteredSurfaceElevation)*t},e.prototype.stepController=function(e,a){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(a),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,G),this.applyDisabledMovementTypes(G),this.applyPan(G.pan),this.applyRotate(G.rotate),this.applyZoom(G.zoom),this.applyAscend(G.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,l.applyAll(this.view,this.currentCamera,this.constraintOptions),t.prototype.stepController.call(this,e,a)},e.prototype.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)},e.prototype.applyRotate=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.up,r=e.eye;o.vec3.subtract(a,a,r),o.vec3.transformMat4(a,a,t.matrix),o.vec3.add(a,a,r),o.vec3.transformMat4(i,i,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,l.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyPan=function(t,e){if(void 0===e&&(e=this.currentCamera),t.enabled){var a=e.center,i=e.eye,r=e.up;o.vec3.transformMat4(i,i,t.matrix),o.vec3.transformMat4(a,a,t.matrix);this.view.state.isGlobal&&o.vec3.transformMat4(r,r,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,l.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyZoom=function(t){if(t){var e=this.currentCamera,a=e.eye,i=e.viewForward;o.vec3.add(a,a,o.vec3.scale(w.sv3d.get(),i,t)),this.currentCamera.markViewDirty(),o.vec3.copy(R,i),o.vec3.negate(R,R),this.constraintOptions.interactionDirection=R,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,l.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.applyAscend=function(t){if(t){var e=this.currentCamera,a=e.center,i=e.eye,r=this.view.renderCoordsHelper,n=r.worldUpAtPosition(i,w.sv3d.get());this.constraintOptions.interactionDirection=o.vec3.copy(R,n);if(this.view.state.isGlobal){var s=o.vec3.length(i),c=(s+t)/s;o.vec3.scale(i,i,c),o.vec3.scale(a,a,c)}else{var p=o.vec3.scale(w.sv3d.get(),n,t);o.vec3.add(i,i,p),o.vec3.add(a,a,p)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,l.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,l.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.calculateControlTransformation=function(t,e,a){T(a);var i=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(i,e,a):this.calculateControlTransformationGlobal(i,e,a)},e.prototype.updateCameraCenter=function(){var t=this.currentCamera,e=t.ray,a=t.center,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(e,i,a),this.currentCamera.markViewDirty()},e.prototype.calculateControlTransformationLocal=function(t,e,a){var n=e.viewRight,s=e.viewForward,l=this.transformation,p=this.view.navigation.gamepad,d=o.vec3.set(w.sv3d.get(),s[0],s[1],0);o.vec3.normalize(d,d);var m=l.translation[0]*t.pan;if(0!==m){var h=o.vec3.scale(w.sv3d.get(),n,m);r.mat4.translate(a.pan.matrix,a.pan.matrix,h),a.pan.enabled=!0}switch(p.mode){case"pan":var u=-l.translation[1]*t.pan;if(0!==u){var f=o.vec3.scale(w.sv3d.get(),d,u);r.mat4.translate(a.pan.matrix,a.pan.matrix,f),a.pan.enabled=!0}break;case"zoom":a.zoom=-l.translation[1]*t.zoom;break;default:i.neverReached(p.mode)}var y=l.translation[2]*t.ascend;a.ascend=y;var C=-l.heading*t.rotate;0!==C&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,C,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,w.sv3d.get())),a.rotate.enabled=!0);var b=l.tilt*t.rotate,T=v.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),S=g.clamp(T+b,c.TiltDefault.min,c.TiltDefault.max)-T;S&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,S,n),a.rotate.enabled=!0)},e.prototype.calculateControlTransformationGlobal=function(t,e,a){var i=e.eye,n=e.viewRight,s=this.transformation,l=this.view.navigation.gamepad,c=o.vec3.cross(w.sv3d.get(),n,i);o.vec3.normalize(c,c),o.vec3.negate(c,c),d.panMotionToRotationMatrix(this.beginCamera,e,s,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,a,l),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(G.pan,this.tmpCamera);var p=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,m=s.translation[2]*t.ascend;a.ascend=m;var v=-s.heading*t.rotate;0!==v&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,v,this.tmpCamera.eye),a.rotate.enabled=!0);var h=s.tilt*t.rotate,u=this.clampTiltDeltaGlobalToValidRange(h,e.ray,p);0!==u&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,u,this.tmpCamera.viewRight),a.rotate.enabled=!0)},e.prototype.clampTiltDeltaGlobalToValidRange=function(t,e,a){var i=m.onSurfaceTiltToEyeTiltGlobal(c.TiltDefault.min,e.origin,a),r=0,n=0,s=w.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(e,a,s)){var l=v.viewAngle(this.view.renderCoordsHelper,s,e.origin);r=m.onSurfaceTiltToEyeTiltGlobal(l,e.origin,a),n=m.onSurfaceTiltToEyeTiltGlobal(c.TiltDefault.max,e.origin,a)}else{y.sphere.closestPointOnSilhouette(y.sphere.wrap(a+f.earthRadius),e,s);var l=g.acos(-o.vec3.dot(e.direction,o.vec3.normalize(s,s)));r=m.offSurfaceTiltToEyeTiltGlobal(l,e.origin,a),n=m.offSurfaceTiltToEyeTiltGlobal(c.TiltDefault.max,e.origin,a)}return g.clamp(r+t,i,n)-r},e.prototype.getPointAbsoluteSurfaceElevation=function(t,e,a){var i=this.view.renderCoordsHelper,r=i.getAltitude(t),n=Math.abs(r-e),s=e+n;return o.vec3.copy(a,t),i.setAltitude(s,a),s},e.prototype.clampedDistanceToSurface=function(t,e){var a=this.view.renderCoordsHelper,i=this.view.state.camera,r=h.headingTiltToDirectionUp(this.view,e,0,M,U).direction,n=a.intersectManifoldClosestSilhouette(y.ray.wrap(e,r),t,w.sv3d.get()),s=o.vec3.distance(e,n),l=a.intersectManifoldClosestSilhouette(y.ray.wrap(e,g.directionFromTo(w.sv3d.get(),e,i.center)),t,w.sv3d.get()),c=o.vec3.distance(e,l);return Math.min(s,c)},e.prototype.computeHeadingRotateRadius=function(t){var e=this.view,a=e.renderCoordsHelper,i=e.state,r=i.camera,n=i.isGlobal,s=a.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,w.sv3d.get());if(n){var l=o.vec3.subtract(w.sv3d.get(),t,s),c=o.vec3.length(l);o.vec3.scale(l,l,1/c);var p=o.vec3.normalize(w.sv3d.get(),t),d=g.acos(o.vec3.dot(p,l));return c*Math.sin(Math.min(O,d))}var m=o.vec3.copy(w.sv3d.get(),t);return a.setAltitude(this.filteredSurfaceElevation,m),o.vec3.distance(s,m)},e.prototype.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:A},e.prototype.computeVelocities=function(t){var e=this.filteredSurfaceElevation,a=e+f.earthRadius,i=this.view.state,r=i.camera,n=i.isGlobal,o=w.sv3d.get(),s=this.getPointAbsoluteSurfaceElevation(r.eye,e,o),l=this.clampedDistanceToSurface(e,o),c=r.width/2,p=D*r.width,d=D*r.width,m=l*Math.tan(.5*r.fovX)/c,v=m/a,h=m/this.computeHeadingRotateRadius(o),u=n?v:m,y=u*p*t,C=s-e;return{pan:y,ascend:Math.max(this.minimumAscendVelocity()*t,Math.pow(2,p*t/c)*C-C),zoom:Math.pow(2,p*t/c)*l-l,rotate:g.clamp(h*d,z,E)*t}},e.prototype.applyDisabledMovementTypes=function(t){void 0===this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&r.mat4.identity(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&r.mat4.identity(t.rotate.matrix))},e.activatesFor=function(t,e){var a=b.extractTransformation(e,t.navigation.gamepad,x);return!("end"===e.action||b.isZeroTransformation(a))},e}(p.InteractiveController);e.GamepadKeyboardController=S;var x={translation:[0,0,0],heading:0,tilt:0},M=80,O=g.deg2rad(M),D=.75,A=5,z=g.deg2rad(30),E=g.deg2rad(80),G={zoom:0,ascend:0,pan:{enabled:!1,matrix:n.mat4f64.create()},rotate:{enabled:!1,matrix:n.mat4f64.create()}},R=s.vec3f64.create(),U=u.createDirectionUp()});