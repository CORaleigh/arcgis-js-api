// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../support/geometryUtils/coordinateSystem","../../webgl-engine/lib/Camera"],function(e,t,a,r,c,n,o,i,s,v,l,d,h,u,m){function p(e,t,a){return a[0]=t[0]/(e.fullWidth/e.pixelRatio),a[1]=t[1]/(e.fullHeight/e.pixelRatio),a}function f(e,t,a){var r=h.sv3d.get(),c=h.sv3d.get(),n=h.sv3d.get();i.vec3.copy(c,e),i.vec3.copy(n,t);var o=i.vec3.dot(c,a),s=i.vec3.dot(n,a);i.vec3.scale(r,a,o),i.vec3.subtract(c,c,r),i.vec3.normalize(c,c),i.vec3.scale(r,a,s),i.vec3.subtract(n,n,r),i.vec3.normalize(n,n);var v=i.vec3.dot(c,n);i.vec3.cross(r,a,c);var l=i.vec3.dot(n,r);return Math.atan2(l,v)}function g(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function y(e,t,a){var c=h.sm4d.get();r.mat4.identity(c),r.mat4.rotate(c,c,a[3],a),i.vec3.subtract(e.eye,e.eye,t),i.vec3.transformMat4(e.eye,e.eye,c),i.vec3.add(e.eye,e.eye,t),i.vec3.subtract(e.center,e.center,t),i.vec3.transformMat4(e.center,e.center,c),i.vec3.add(e.center,e.center,t),i.vec3.transformMat4(e.up,e.up,c),e.markViewDirty()}function M(e,t,a,r){return l.plane.intersectRay(e,l.ray.fromScreen(t,a,fe),r)}function P(e,t,a,r){var c=h.sv3d.get(),n=1-a;i.vec3.subtract(c,t,e.eye);var o=i.vec3.length(c),s=o*(1-n);n>=0&&s<r&&(s=r,n=-(s-o)/o),Math.abs(o-s)<1e-6||(i.vec3.scale(c,c,n),i.vec3.add(e.eye,e.eye,c),i.vec3.lerp(e.center,e.center,t,n))}function b(e,t,a){t.getScreenCenter(Z),l.sphere.intersectScreen(e,t,Z,t.center),t.markViewDirty();var r=t.distance,c=r*a;if(!(Math.abs(r-c)<1e-6)){var n=i.vec3.scale(h.sv3d.get(),t.viewForward,c);i.vec3.subtract(t.eye,t.center,n),t.markViewDirty()}}function x(e,t,a){A(t,a),i.vec3.normalize(a,a),i.vec3.scale(a,a,e)}function A(e,t){i.vec3.set(t,0,0,0);for(var a=0,r=e;a<r.length;a++){var c=r[a];i.vec3.add(t,t,c)}i.vec3.scale(t,t,1/e.length)}function z(e,t,a){return Math.sin(e/i.vec3.length(t))*(a+v.earthRadius)}function T(e,t,a){return z(Math.PI/2,t,a)+(e-Math.PI/2)}function S(e,a,r,c){var n=s.vec3f64.create(),o=l.sphere.create(),v=!0;return e.intersectScreen(r,n)?o.radius=i.vec3.length(n):(a.aboveGround?o.radius=Math.max(i.vec3.length(a.center),.9*t.Earth.radius):o.radius=i.vec3.length(a.eye)-a.relativeElevation,c?V(o,a,r,n):v=l.sphere.intersectScreen(o,a,r,n)),{sphere:o,scenePickPoint:v?n:null}}function w(e,a,r){var c=i.vec3.length(e.eye),n=c-t.Earth.radius;if(Math.abs(n)>t.VerticalPanTresholds.Elevation)return _.Horizontal;var o=a.radius>c;return e.aboveGround===o?_.Vertical:(i.vec3.subtract(j,e.eye,r),i.vec3.normalize(j,j),Math.abs(.5*Math.PI-d.acos(i.vec3.dot(r,j)/i.vec3.length(r)))<t.VerticalPanTresholds.Angle?_.Vertical:_.Horizontal)}function I(e,t,a){i.vec3.subtract(B,a,t),i.vec3.subtract(e.eye,e.eye,B),i.vec3.subtract(e.center,e.center,B),e.markViewDirty()}function V(e,t,a,r){var c=l.ray.fromScreenAtEye(t,a,fe);return l.sphere.closestPointOnSilhouette(e,c,J),l.sphere.intersectRay(e,c,r)?!(i.vec3.squaredDistance(J,c.origin)<i.vec3.squaredDistance(r,c.origin))||(i.vec3.copy(r,J),!1):(i.vec3.subtract(K,t.eye,t.center),i.vec3.normalize(K,K),l.plane.fromNormalAndOffset(K,-i.vec3.dot(i.vec3.normalize(K,K),J),L),l.plane.intersectRay(L,c,r),!1)}function H(e,a,r,c,n,o){var s;if(i.vec3.cross(me,e,a),i.vec3.subtract(he,e,a),i.vec3.length(e)<=n||!c.aboveGround){i.vec3.cross(r,he,c.eye);var v=i.vec3.dot(e,a)/(i.vec3.length(e)*i.vec3.length(a)),l=Math.cos(d.clamp(d.cyclicalPI.normalize(d.deg2rad(o)),0,t.TiltThresholdPanningSpeed));s=-d.acos(v)-Math.max(0,i.vec3.length(a)-n)/(l*n)}else i.vec3.subtract(Q,c.eye,c.center),i.vec3.cross(r,he,Q),s=-i.vec3.length(he)/n;return i.vec3.normalize(r,r),i.vec3.scale(r,r,i.vec3.length(me)),s}function R(e,a,r,c){var n,o=Math.cos(d.clamp(d.cyclicalPI.normalize(d.deg2rad(c)),0,t.TiltThresholdPanningSpeed));return n=a>r?-(a-r)/(o*r):a<-r?Math.PI-(a+r)/(o*r):d.acos(a/r),((e>r?-(e-r)/(o*r):e<-r?Math.PI-(e+r)/(o*r):d.acos(e/r))-n)*r}function D(e,t,a,r,c,o,s,v,l,d){var h=R(e[2],t[2],s.radius,l),u=d?R(e[0],t[0],s.radius,180):t[0]-e[0],m=Math.sin(v)*u-Math.cos(v)*h,p=Math.cos(v)*u+Math.sin(v)*h;i.vec3.normalize(de,c);var f=d?m/Math.sqrt(Math.abs(Math.pow(s.radius,2)-Math.pow(i.vec3.dot(a,de),2))):m/s.radius,g=p/Math.sqrt(Math.abs(Math.pow(s.radius,2)-Math.pow(i.vec3.dot(a,r),2)));n.vec2.set(o,f,g)}function k(e,t,a,r,c,n,o,s,v,l){i.vec3.cross(me,e,t),u.coordinateSystemFromOneAxisAndNormalVector(n.up,n.eye,ee,te,ae),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],n.eye,X,Y,$),i.vec3.copy(a,Y),i.vec3.copy(r,X),i.vec3.normalize(a,a),i.vec3.scale(a,a,i.vec3.length(me)),u.vectorCoordinates(e,i.vec3.normalize(te,te),i.vec3.normalize(ae,ae),i.vec3.normalize(ee,ee),re),u.vectorCoordinates(t,te,ae,ee,ce),D(re,ce,e,X,Y,c,o,s,v,l)}function F(e,t,a,c,n,o,s){r.mat4.identity(ie),r.mat4.identity(se),r.mat4.identity(ve),r.mat4.rotate(ie,ie,n,c),r.mat4.rotate(se,se,s,o),r.mat4.multiply(ve,ie,se),i.vec3.subtract(t,e,a),i.vec3.transformMat4(t,t,ve),i.vec3.add(t,t,a)}function q(e,t,a,c,n,o){r.mat4.identity(ie),r.mat4.identity(se),r.mat4.identity(ve),r.mat4.rotate(ie,ie,c,a),r.mat4.rotate(se,se,o,n),r.mat4.multiply(ve,ie,se),i.vec3.subtract(e.eye,e.eye,t),i.vec3.transformMat4(e.eye,e.eye,ve),i.vec3.add(e.eye,e.eye,t),i.vec3.subtract(e.center,e.center,t),i.vec3.transformMat4(e.center,e.center,ve),i.vec3.add(e.center,e.center,t),i.vec3.subtract(e.up,e.up,t),i.vec3.transformMat4(e.up,e.up,ve),i.vec3.add(e.up,e.up,t),e.markViewDirty()}function E(e,a,r,c,n,o,i,s){void 0===i&&(i=t.PreservingHeadingThreshold.Pole),void 0===s&&(s=t.PreservingHeadingThreshold.Angle);var v=Math.abs(c)>Math.PI-s||Math.abs(c)<s,l=Math.abs(e[2])<r*i||Math.abs(a)>r;return!!(v&&l&&o.aboveGround&&n<t.PreservingHeadingThreshold.Tilt)}function O(e,t,a,r,c,n){if(n)l.axisAngle.fromPoints(a,r,oe),y(t,e.center,oe);else{var o=H(a,r,pe,t,e.radius,c);y(t,e.center,l.axisAngle.wrapAxisAngle(pe,o))}}function G(e,t,a,r,c,n,o){var s=o?20:1;i.vec3.copy(le,r),ue.copyFrom(t);for(var v,l=0;l<s&&i.vec3.squaredDistance(a,le)>1e-12&&(v=i.vec3.squaredDistance(a,le),k(a,le,Y,X,ne,ue,e,c,n,o),q(ue,e.center,X,ne[1],Y,ne[0]),F(le,le,e.center,X,ne[1],Y,ne[0]),i.vec3.squaredDistance(a,le)<v||0===l);l++)t.copyFrom(ue)}function C(e,a,r,c,n,o,s){E(r,i.vec3.dot(a.up,r),e.radius,-d.cyclicalPI.normalize(d.deg2rad(n)),o,a,t.PreservingHeadingThreshold.Pole,t.PreservingHeadingThreshold.Angle)?G(e,a,r,c,-d.cyclicalPI.normalize(d.deg2rad(n)),o,s):O(e,a,r,c,o,s)}function U(e,t,a,c,n,o){var s=e.eye;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],s,X,Y,$);var v=t.translation[0]*a.pan,l=t.translation[1]*a.pan,d=Math.max(Math.sqrt(Math.abs(1-Math.pow(i.vec3.dot(e.center,X),2)/Math.pow(i.vec3.length(e.center),2))),.5),h=(Math.sin(o)*l+Math.cos(o)*v)/d,m=-Math.cos(o)*l+Math.sin(o)*v;switch(r.mat4.rotate(c.pan.matrix,c.pan.matrix,h,X),c.pan.enabled=!0,n.mode){case"pan":r.mat4.rotate(c.pan.matrix,c.pan.matrix,m,Y),c.pan.enabled=!0;break;case"zoom":c.zoom=-t.translation[1]*a.zoom}}function N(e,t,a,c,n){var o=e.eye,s=e.viewRight,v=i.vec3.cross(h.sv3d.get(),s,o),l=t.translation[0]*a.pan;switch(0!==l&&(r.mat4.rotate(c.pan.matrix,c.pan.matrix,-l,v),c.pan.enabled=!0),n.mode){case"pan":var d=t.translation[1]*a.pan;0!==d&&(r.mat4.rotate(c.pan.matrix,c.pan.matrix,d,s),c.pan.enabled=!0);break;case"zoom":c.zoom=-t.translation[1]*a.zoom}}function W(e,t,a,r,c,n,o,s,v){E(e.center,i.vec3.dot(e.up,e.center),i.vec3.length(e.center),-d.cyclicalPI.normalize(d.deg2rad(n)),o,t)?U(t,a,r,s,v,-d.cyclicalPI.normalize(d.deg2rad(c))):N(t,a,r,s,v)}Object.defineProperty(t,"__esModule",{value:!0}),t.Earth=l.sphere.fromValues(v.earthRadius,s.vec3f64.create()),t.normalizeCoordinate=p,t.rotationFromPointsAroundAxis=f,t.normalizeRotationDelta=g,t.applyRotation=y,t.intersectPlaneFromScreenPoint=M,t.applyZoomToPoint=P,t.applyZoomOnSphere=b;var Z=a.createScreenPointArray();t.centroidOnSphere=x,t.centroid=A,t.onSurfaceTiltToEyeTiltGlobal=z,t.offSurfaceTiltToEyeTiltGlobal=T;var _;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(_=t.PanMode||(t.PanMode={})),t.VerticalPanTresholds={Elevation:3e4,Angle:d.deg2rad(8)},t.PreservingHeadingThreshold={Pole:.95,Angle:d.deg2rad(18),Tilt:45},t.TiltThresholdPanningSpeed=d.deg2rad(80),t.pickPointAndInitSphere=S,t.decidePanMode=w;var j=s.vec3f64.create();t.applyPanPlanar=I;var B=s.vec3f64.create();t.sphereOrPlanePointFromScreenPoint=V;var J=s.vec3f64.create(),K=s.vec3f64.create(),L=l.plane.create();t.rotationAngleAndAxisDirectRotation=H;var Q=s.vec3f64.create();t.lengthFromPoints=R,t.rotationAnglesHeadingPreserving=D,t.rotationAnglesAndAxesHeadingPreserving=k,t.rotatePointAroundTwoAxes=F,t.applyRotationWithTwoAxes=q,t.preserveHeadingThreshold=E,t.applyPanSphericalDirectRotation=O,t.applyPanSphericalPreserveHeading=G,t.panToPosition=C,t.panMotionToRotationMatrix=W;var X=s.vec3f64.create(),Y=s.vec3f64.create(),$=s.vec3f64.create(),ee=s.vec3f64.create(),te=s.vec3f64.create(),ae=s.vec3f64.create(),re=s.vec3f64.create(),ce=s.vec3f64.create(),ne=o.vec2f64.create(),oe=l.axisAngle.create(),ie=c.mat4f64.create(),se=c.mat4f64.create(),ve=c.mat4f64.create(),le=s.vec3f64.create(),de=s.vec3f64.create(),he=s.vec3f64.create(),ue=new m,me=s.vec3f64.create(),pe=s.vec3f64.create(),fe={origin:s.vec3f64.create(),direction:s.vec3f64.create()}});