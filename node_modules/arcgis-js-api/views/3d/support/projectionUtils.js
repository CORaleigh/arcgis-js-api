// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","./earthUtils","./mathUtils","../webgl-engine/lib/BufferVectorMath"],function(e,n,t,a,r,i,c,l,o,u,f,s){function m(e,n,t,r){return 2===e.length?(k[0]=e[0],k[1]=e[1],k[2]=0,e=k):e===t&&(a.vec3.copy(k,e),e=k),x(e,n,0,t,r,0,1)}function h(e,n,t,a){void 0===a&&(a=0),k[0]=e.x,k[1]=e.y;var r=e.z;return k[2]=void 0!==r?r:a,x(k,e.spatialReference,0,n,t,0,1)}function M(e,n,t,a){var r;return t instanceof i?(r=t,a=a||r.spatialReference):o.isPoint(t)?(r=t,r.hasZ=!0,a=a||r.spatialReference):(a=t,r=new i({spatialReference:a})),x(e,n,0,k,a,0,1)?(r.x=k[0],r.y=k[1],r.z=k[2],r.spatialReference=a,r):null}function v(e,n,t,a,r,i){return k[0]=e,k[1]=n,k[2]=t,x(k,a,0,r,i,0,1)}function x(e,n,t,a,r,i,c){void 0===c&&(c=1),w!==n&&(z=E(n),w=n),U!==r&&(H=E(r),U=r);var l=t+3*c;if(z!==H||0===z&&!n.equals(r)){if(!(z>0&&H>0))return!1;if(2!==H){var o=q[H];if(2!==z)for(var u=C[z],f=t,s=i;f<l;f+=3,s+=3)u(e,f,N,0),o(N,0,a,s);else for(var f=t,s=i;f<l;f+=3,s+=3)o(e,f,a,s)}else for(var u=C[z],f=t,s=i;f<l;f+=3,s+=3)u(e,f,a,s)}else if(a!==e||t!==i)for(var f=t,s=i;f<l;f++,s++)a[s]=e[f];return!0}function R(e,n,a,r){var i=E(e),c=E(r);if(i===c&&1!==c&&(0!==i||e.equals(r)))return t.mat4.identity(a),t.mat4.translate(a,a,n),!0;if(1===c){var l=C[i];if(l){l(n,0,N,0),P(N,0,V,0);var o=X*N[0],u=X*N[1],f=Math.sin(o),s=Math.cos(o),m=Math.sin(u),h=Math.cos(u),M=a;return M[0]=-f,M[4]=-m*s,M[8]=h*s,M[12]=V[0],M[1]=s,M[5]=-m*f,M[9]=h*f,M[13]=V[1],M[2]=0,M[6]=h,M[10]=m,M[14]=V[2],M[3]=0,M[7]=0,M[11]=0,M[15]=1,!0}}else if(3===c&&(2===i||1===i)){C[i](n,0,N,0);var v=X*N[1];g(N,0,V,0),t.mat4.identity(a),t.mat4.translate(a,a,V);var x=1/Math.cos(v);return t.mat4.scale(a,a,[x,x,1]),!0}return!1}function p(e,n,t,r,i){a.vec3.copy(D,e),a.vec3.add(F,e,n),m(D,t,D,i),m(F,t,F,i),a.vec3.subtract(r,F,D),a.vec3.normalize(r,r)}function S(e,n,t,a){var r=E(n),i=E(a);if(r===i&&(0!==r||n.equals(a)))return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],!0;if(1===i){var c=C[r];if(c)return c(e,0,N,0),P(N,0,t,0),t[3]=e[3],!0}else if(3===i&&(2===r||1===r)){C[r](e,0,N,0);var l=Math.abs(X*N[1])+Math.asin(e[3]/(B+e[2]));if(g(N,0,t,0),l>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{var o=1/Math.cos(l);t[3]=o*e[3]}return!0}return!1}function T(e,n,t){if(null==e)return!1;var a=!0;return k[0]=null!=e.xmin?e.xmin:0,k[1]=null!=e.ymin?e.ymin:0,k[2]=null!=e.zmin?e.zmin:0,a=a&&x(k,e.spatialReference,0,n,t,0,1),k[0]=null!=e.xmax?e.xmax:0,k[1]=null!=e.ymax?e.ymax:0,k[2]=null!=e.zmax?e.zmax:0,a=a&&x(k,e.spatialReference,0,n,t,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),a}function d(e,n,t){if(null==e)return!1;var a=!0;return k[0]=null!=e.xmin?e.xmin:0,k[1]=null!=e.ymin?e.ymin:0,k[2]=null!=e.zmin?e.zmin:0,a=a&&x(k,e.spatialReference,0,k,t,0,1),n[0]=k[0],n[1]=k[1],k[0]=null!=e.xmax?e.xmax:0,k[1]=null!=e.ymax?e.ymax:0,k[2]=null!=e.zmax?e.zmax:0,a=a&&x(k,e.spatialReference,0,k,t,0,1),n[2]=k[0],n[3]=k[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),a}function y(e,n,t,a){if(null==e)return!1;if(n.equals(a))return l.set(t,e),!0;var r=!0;return k[0]=e[0],k[1]=e[1],k[2]=0,r=r&&x(k,n,0,k,a,0,1),t[0]=k[0],t[1]=k[1],k[0]=e[2],k[1]=e[3],k[2]=0,r=r&&x(k,n,0,k,a,0,1),t[2]=k[0],t[3]=k[1],r}function E(e){return e.wkt===n.SphericalECEFSpatialReference.wkt?1:e.isWGS84?2:e.isWebMercator?3:e.wkt===n.WGS84ECEFSpatialReference.wkt?4:0}function G(e,n,t,a){t[a++]=e[n++],t[a++]=e[n++],t[a]=e[n]}function I(e,n,t,a){t[a++]=Y*(e[n++]/B),t[a++]=Y*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/B))),t[a]=e[n]}function g(e,n,t,a){var r=.4999999*Math.PI,i=f.clamp(X*e[n+1],-r,r),c=Math.sin(i);t[a++]=X*e[n]*B,t[a++]=B/2*Math.log((1+c)/(1-c)),t[a]=e[n+2]}function P(e,n,t,a){var r=B+e[n+2],i=X*e[n+1],c=X*e[n],l=Math.cos(i);t[a++]=Math.cos(c)*l*r,t[a++]=Math.sin(c)*l*r,t[a]=Math.sin(i)*r}function b(e,n,t,a){var r=s.Vec3Compact.length(e,n),i=f.asin(e[n+2]/(0===r?1:r)),c=Math.cos(i),l=c*r,o=(e[n+1]>0?1:-1)*f.acos(e[n]/(0===l?1:l));t[a++]=Y*o,t[a++]=Y*i,t[a]=r-B}function A(e,n,t,a){var r=W,i=X*e[n],c=X*e[n+1],l=e[n+2],o=Math.sin(c),u=Math.cos(c),f=r.a/Math.sqrt(1-r.e2*o*o);t[a++]=(f+l)*u*Math.cos(i),t[a++]=(f+l)*u*Math.sin(i),t[a++]=(f*(1-r.e2)+l)*o}function O(e,n,t,a){var r,i,c,l,o,u,f,s,m,h,M,v,x,R,p,S,T,d,y,E,G,I=W,g=e[n],P=e[n+1],b=e[n+2];r=Math.abs(b),i=g*g+P*P,c=Math.sqrt(i),l=i+b*b,o=Math.sqrt(l),E=Math.atan2(P,g),u=b*b/l,f=i/l,R=I.a2/o,p=I.a3-I.a4/o,f>.3?(s=r/o*(1+f*(I.a1+R+u*p)/o),y=Math.asin(s),h=s*s,m=Math.sqrt(1-h)):(m=c/o*(1-u*(I.a5-R-f*p)/o),y=Math.acos(m),h=1-m*m,s=Math.sqrt(h)),M=1-I.e2*h,v=I.a/Math.sqrt(M),x=I.a6*v,R=c-v*m,p=r-x*s,T=m*R+s*p,S=m*p-s*R,d=S/(x/M+T),y+=d,G=T+S*d/2,b<0&&(y=-y),t[a++]=Y*E,t[a++]=Y*y,t[a]=G}Object.defineProperty(n,"__esModule",{value:!0}),n.SphericalECEFSpatialReference=new c({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",\' + earthUtils.earthRadius + \',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),n.WGS84ECEFSpatialReference=new c({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'});var w,z,U,H;n.vectorToVector=m,n.pointToVector=h,n.vectorToPoint=M,n.xyzToVector=v,n.bufferToBuffer=x,n.computeLinearTransformation=R,n.transformDirection=p,n.mbsToMbs=S,n.extentToBoundingBox=T,n.extentToBoundingRect=d,n.boundingRectToBoundingRect=y;!function(e){function n(e){return e/B}function t(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/B))}function a(e){return e*B}function r(e){var n=Math.sin(e);return B/2*Math.log((1+n)/(1-n))}e.x2lon=n,e.y2lat=t,e.lon2x=a,e.lat2y=r}(n.webMercator||(n.webMercator={}));var q=[void 0,P,G,g,A],C=[void 0,b,G,I,O],X=f.deg2rad(1),Y=f.rad2deg(1),B=u.earthRadius,W={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},k=r.vec3f64.create(),N=r.vec3f64.create(),V=r.vec3f64.create(),D=r.vec3f64.create(),F=r.vec3f64.create()});