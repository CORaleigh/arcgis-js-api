// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../support/ArrayPool","../support/earthUtils","../support/mathUtils","./TerrainConst"],function(r,e,t,a,n,o,i,u){function E(){S.clear(),A.clear()}function s(r){S.put(r.vertexAttributes),r.vertexAttributes=null,r.indices=null}function m(r,e,t){for(var a=0,n=t;a<n.length;a++){var o=n[a];if(o){var E=o.safeWidth,s=o.width,m=o.pixelData,f=i.clamp(o.dy*(o.y1-e),0,E),R=i.clamp(o.dx*(r-o.x0),0,E),v=Math.floor(f),T=Math.floor(R),c=v*s+T,l=c+s,I=m[c],_=m[l],S=m[c+1],y=m[l+1];if(I+_+S+y<.5*u.ELEVATION_NODATA_VALUE){f-=v,R-=T;var A=I+(S-I)*R;return A+(_+(y-_)*R-A)*f}}}return null}function f(r,e,n,E,s,f,R,T){var _=n[0],y=n[1],A=n[2],V=n[3],g=.1*o.earthRadius*(V-y),w=r.numVertsPerRow-1,O=r.numVertsPerRow-1,P=r.numVertsPerRow*r.numVertsPerRow,D=2*w+2*O,x=S.get((P+D)*u.GEOMETRY_VERTEX_STRIDE),X=T.geometryInfo.boundingBox;a.empty(X);for(var G=e[2]-e[0],L=e[3]-e[1],b=A-_,Y=s[0],k=s[1],N=s[2],U=0;U<=w;U++){var B=U/w,C=_+B*b;M[U]=Math.sin(C),d[U]=Math.cos(C),h[U]=B,p[U]=e[0]+B*G}for(var W=E&&!!(1&f),j=E&&!!(2&f),q=0,F=0;F<=O;F++){var z=F/O,H=i.lerp(y,V,z),J=Math.cos(H),K=Math.sin(H),Q=void 0;E?(Q=o.earthRadius/2*Math.log((1+K)/(1-K)),z=(Q-e[1])/L):Q=180*H/Math.PI;for(var U=0;U<=w;U++){var B=h[U],Z=M[U],$=d[U],rr=o.earthRadius;r.samplerData&&(rr+=m(p[U],Q,r.samplerData)||0);var er=$*J*rr,tr=Z*J*rr,ar=K*rr,nr=er-Y,or=tr-k,ir=ar-N;c(nr,or,ir,X);var ur=u.GEOMETRY_VERTEX_STRIDE*q;x[ur+0]=nr,x[ur+1]=or,x[ur+2]=ir,x[ur+3]=B,x[ur+4]=z;var Er=I(U,F,w,O);if(Er>-1){var sr=u.GEOMETRY_VERTEX_STRIDE*(P+Er),mr=W&&0===F?-1:j&&F===O?1:0,fr=0===mr?nr:-Y,Rr=0===mr?or:-k,vr=0===mr?ir:o.earthRadius*mr-N;x[sr+0]=fr,x[sr+1]=Rr,x[sr+2]=vr,x[sr+3]=0===mr?l(B,z):B,x[sr+4]=0===mr?g:z,0!==mr&&c(fr,Rr,vr,X)}++q}}T.geometryInfo.numVertsPerRow=r.numVertsPerRow,T.geometryInfo.vertexAttributes=x,T.geometryInfo.skirtLength=g,t.vec4.set(T.geometryInfo.uvOffsetAndScale,0,0,1,1),v(T.geometryInfo,r.numVertsPerRow,E?f:0,R)}function R(r,e,n,o,i){var E=e[0],s=e[1],f=e[2]-E,R=e[3]-s,T=r.clippingArea,_=T?Math.max(0,(T[0]-e[0])/f):0,y=T?Math.max(0,(T[1]-e[1])/R):0,A=T?Math.min(1,(T[2]-e[0])/f):1,M=T?Math.min(1,(T[3]-e[1])/R):1,d=A>_?1/(A-_):1,h=M>y?1/(M-y):1,p=-_*d,V=-y*h,g=.1*f,w=r.numVertsPerRow-1,O=r.numVertsPerRow-1,P=r.numVertsPerRow*r.numVertsPerRow,D=2*w+2*O,x=S.get((P+D)*u.GEOMETRY_VERTEX_STRIDE),X=i.geometryInfo.boundingBox;a.empty(X);for(var G=0,L=0;L<=O;L++){var b=L/O,Y=V+b*h,k=s+b*R;T&&(k<T[1]?(k=T[1],Y=0):k>T[3]&&(k=T[3],Y=1));for(var N=0;N<=w;N++){var U=N/w,B=p+U*d,C=E+U*f;T&&(C<T[0]?(C=T[0],B=0):C>T[2]&&(C=T[2],B=1));var W=r.samplerData?m(C,k,r.samplerData)||0:0,j=C-n[0],q=k-n[1],F=W-n[2];c(j,q,F,X),x[u.GEOMETRY_VERTEX_STRIDE*G]=j,x[u.GEOMETRY_VERTEX_STRIDE*G+1]=q,x[u.GEOMETRY_VERTEX_STRIDE*G+2]=F,x[u.GEOMETRY_VERTEX_STRIDE*G+3]=B,x[u.GEOMETRY_VERTEX_STRIDE*G+4]=Y;var z=I(N,L,w,w);if(z>-1){var H=u.GEOMETRY_VERTEX_STRIDE*(P+z);x[H]=j,x[H+1]=q,x[H+2]=F,x[H+3]=l(B,Y),x[H+4]=g}++G}}i.geometryInfo.numVertsPerRow=r.numVertsPerRow,i.geometryInfo.vertexAttributes=x,i.geometryInfo.skirtLength=g,t.vec4.set(i.geometryInfo.uvOffsetAndScale,_,y,A-_,M-y),v(i.geometryInfo,r.numVertsPerRow,0,o)}function v(r,e,t,a){var n=(2&t)>0,o=e+(a?1024:0)+(n?2048:0),i=A.get(o);i||(i=T(e,n,a),A.set(o,i)),r.indices=i.values,r.numSurfaceIndices=i.numSurfaceIndices,r.numSkirtIndices=i.numSkirtIndices,r.numWithoutSkirtIndices=r.numSurfaceIndices+(t?6*(e-1)*(a?2:1):0)}function T(r,e,t){var a=r-1,n=r-1,o=r*r,i=2*a+2*n,u=a*n*2*3,E=6*i,s=6*(2*a+n-1);t&&(u*=2,E*=2,s*=2);for(var m,f,R,v,T=o+i>y?new Uint32Array(u+E):new Uint16Array(u+E),c=0,l=0,S=u,A=0,M=0;M<=n;M++){e&&(A=0===M?s:M===n?-s:0),S+=A;for(var d=0;d<=a;d++){var h=I(d,M,a,n);if(h>-1){var p=_(d,M,a,n);0!==p&&(m=c,f=o+h,R=o+(0===d&&1===M?0:h+1),v=c+p,t?(T[S+0]=m,T[S+1]=f,T[S+2]=f,T[S+3]=R,T[S+4]=R,T[S+5]=m,T[S+6]=R,T[S+7]=v,T[S+8]=v,T[S+9]=m,T[S+10]=m,T[S+11]=R,S+=12):(T[S+0]=m,T[S+1]=f,T[S+2]=R,T[S+3]=R,T[S+4]=v,T[S+5]=m,S+=6))}++c,d<a&&M<n&&(m=M*(a+1)+d,f=m+1,R=f+(a+1),v=R-1,t?(T[l+0]=m,T[l+1]=f,T[l+2]=f,T[l+3]=R,T[l+4]=R,T[l+5]=m,T[l+6]=R,T[l+7]=v,T[l+8]=v,T[l+9]=m,T[l+10]=m,T[l+11]=R,l+=12):(T[l+0]=m,T[l+1]=f,T[l+2]=R,T[l+3]=R,T[l+4]=v,T[l+5]=m,l+=6))}S-=A}return{values:T,numSurfaceIndices:u,numSkirtIndices:E}}function c(r,e,t,a){r<a[0]&&(a[0]=r),r>a[3]&&(a[3]=r),e<a[1]&&(a[1]=e),e>a[4]&&(a[4]=e),t<a[2]&&(a[2]=t),t>a[5]&&(a[5]=t)}function l(r,e){var t=e>r?1:0;return 2+4*t+(1-2*t)*(r+e)}function I(r,e,t,a){return 0===e?r:r===t?t+e:e===a?t+a+(t-r):0===r&&e>0?2*t+a+(a-e):-1}function _(r,e,t,a){return 0===e&&r!==t?1:r===t&&e!==a?t+1:e===a&&0!==r?-1:0===r&&0!==e?-(t+1):0}Object.defineProperty(e,"__esModule",{value:!0});var S=new n.ArrayPool(Float32Array);e.clearCaches=E,e.releaseGeometry=s,e.elevationSampler=m;var y=65536;e.createSphericalGlobeTile=f,e.createPlanarGlobeTile=R;var A=new Map,M=new Array(u.MAX_TILE_TESSELATION+1),d=new Array(u.MAX_TILE_TESSELATION+1),h=new Array(u.MAX_TILE_TESSELATION+1),p=new Array(u.MAX_TILE_TESSELATION+1)});