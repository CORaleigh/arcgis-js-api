// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../support/mathUtils","./ElevationTileAgent","./MapTileAgent","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./tileUtils","../../vectorTiles/VectorTileDisplayObject","../../webgl/Texture","../../webgl/Util"],function(e,t,i,n,r,a,s,o,l,d,h,p,u,g,c,f,y,v,A,m,E){function L(e,t,i,n){var r=i===g.LayerClass.ELEVATION?p.Pool.acquire():u.Pool.acquire();return r.init(e,t,i,n),r}function _(e){e.dispose(),e instanceof p?p.Pool.release(e):e instanceof u&&u.Pool.release(e)}var U=c.weakAssert,T=s.vec3f64.create(),I=s.vec3f64.create(),O=l.vec4f64.create(),b=s.vec3f64.create();return function(){function e(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._dirty=!0,this.extent=d.create(),this._elevationBounds=r.vec2f64.create(),this.children=[null,null,null,null],this.layerInfo=new Array(g.LayerClass.COUNT),this.extentWGS84Rad=d.create(),this.centerAtSeaLevel=s.vec3f64.create(),this.center=s.vec3f64.create(),this.tileUp=b,this._isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0,this.screenDepth=0,this.renderOrder=0,this.edgeLen=0,this.edgeLen2=0,this.radius=0,this._memoryUsed=0}return Object.defineProperty(e.prototype,"memoryUsed",{get:function(){return this._memoryUsed},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxTesselation",{get:function(){return this._maxTesselation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numSubdivisionsAtLevel",{get:function(){return this._numSubdivisionAtLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isWithinClippingArea",{get:function(){return this._isWithinClippingArea},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"surface",{get:function(){return this._surface},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){if(this._dirty){var e=this._isVisible();e!==this._visible&&(this._visible=e,this.updateAgentSuspension(),this._visible=e),this._dirty=!1}return this._visible},enumerable:!0,configurable:!0}),e.prototype.init=function(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this._isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.edgeLen2=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t._elevationBounds?n.vec2.copy(this.elevationBounds,t.elevationBounds):n.vec2.set(this.elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._dirty=!0,this._parent=t,this._surface=i;for(var r=0;r<4;r++)this.children[r]=null;for(var a=0;a<g.LayerClass.COUNT;a++){var s=i.numLayers(a),o=this.layerInfo[a];this.layerInfo[a]?o.length=s:(o=new Array(s),this.layerInfo[a]=o);for(var l=0;l<s;l++)o[l]=y.TilePerLayerInfo.makeEmptyLayerInfo(a,this._surface.upsampleInfoPool,o[l]),a===g.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(l,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize[0],g.MAX_TILE_TESSELATION)},e.prototype.dispose=function(){U(!this.renderData,"tile.renderData was not unloaded"),this._parent&&U(-1===this._parent.children.indexOf(this),"still linked");for(var e=0;e<g.LayerClass.COUNT;e++)for(var t=0,i=this.layerInfo[e];t<i.length;t++){var n=i[t];n.dispose()}this._parent=null,this._surface=null,this._memoryUsed=0},e.prototype.updateMemoryUsed=function(){var e=this._surface.tilingScheme.pixelSize,t=e[0]*e[1]*4;this._memoryUsed=0;for(var i=0,n=this.layerInfo[g.LayerClass.MAP];i<n.length;i++){var r=n[i],a=r.data;a instanceof m?this._memoryUsed+=E.getGpuMemoryUsage(a):a instanceof HTMLImageElement?this._memoryUsed+=t:a instanceof A&&(this._memoryUsed+=a.getGpuMemoryUsage()+a.getCpuMemoryUsage())}for(var s=0,o=this.layerInfo[g.LayerClass.ELEVATION];s<o.length;s++){var r=o[s];this._memoryUsed+=r.data?t:0}if(this.renderData){this._memoryUsed+=this.renderData.estimatedGeometryMemoryUsage;var l=this.renderData.textureDescriptor;l&&(this._memoryUsed+=E.getGpuMemoryUsage(l))}},e.prototype.updateScreenDepth=function(e){a.vec3.copy(O,this.center),O[3]=1,o.vec4.transformMat4(O,O,e),this.screenDepth=O[2]/O[3]},e.prototype.shouldSplit=function(e,t){var i=this.lij[0];a.vec3.subtract(T,this.center,t);var n=a.vec3.squaredLength(T),r=e[4];if(n<this.edgeLen2&&i<r)return g.TileUpdate.SPLIT;var s=e[1],o=2*Math.sqrt(n),l=e[0],d=l*o,p=this.edgeLen/d;if(p<s)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],g.TileUpdate.VSPLITMERGE):g.TileUpdate.NONE;if(i>=r){var u=i+Math.ceil(-h.log2(s/p));return u!==this.vlevel?(this.vlevel=u,g.TileUpdate.VSPLITMERGE):g.TileUpdate.NONE}if(i>6){a.vec3.scale(I,this.tileUp,a.vec3.dot(this.tileUp,T)),a.vec3.subtract(I,I,T);var c=a.vec3.squaredLength(I);if(c>this.radius*this.radius){a.vec3.scale(I,I,this.radius/Math.sqrt(c)),a.vec3.add(I,I,this.center),a.vec3.subtract(I,t,I);var f=this._elevationBounds[1]-this._elevationBounds[0],y=Math.min(1,(Math.abs(a.vec3.dot(I,this.tileUp))+.5*f+this.curvatureHeight)/a.vec3.length(I)),v=e[3],A=e[5],m=.1/A,E=e[2],L=E*o;if(y*(this.edgeLen/L)<m*v)return g.TileUpdate.NONE}}return g.TileUpdate.SPLIT},e.prototype.getWGS84Extent=function(){var e=this.extentWGS84Rad;return d.fromValues(h.rad2deg(e[0]),h.rad2deg(e[1]),h.rad2deg(e[2]),h.rad2deg(e[3]))},e.prototype.load=function(e){for(var t=null==this.renderData&&e.loadCachedElevationData(this),i=0;i<g.LayerClass.COUNT;i++)if(this.layerInfo[i])if(i===g.LayerClass.ELEVATION&&t)for(var n=0,r=this.layerInfo[i];n<r.length;n++){var a=r[n];a.loadingAgent=f.DONE}else this._createOrUpdateAgents(0,i);e.loadTile(this)},e.prototype.unload=function(e){e.unloadTile(this,this.elevationDone);for(var t=0;t<g.LayerClass.COUNT;t++)for(var i=this.layerInfo[t],n=0,r=i;n<r.length;n++){var a=r[n];a.loadingAgent&&a.loadingAgent!==f.DONE&&(_(a.loadingAgent),a.loadingAgent=null),a.pendingUpdates=0}this._pendingUpdates&=~g.TileUpdate.GEOMETRY,this._pendingUpdates&=~g.TileUpdate.TEXTURE},e.prototype.updateClippingStatus=function(e){if(i.equals(e,this.clippingArea))return!1;var t=this.intersectsClippingArea,n=this._isWithinClippingArea;e?(this.intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this._isWithinClippingArea=!0),this.clippingArea=e,this._dirty=!0;var r=n&&this._isWithinClippingArea,a=!(n||t||this._isWithinClippingArea||this.intersectsClippingArea);return!this.renderData||r||a||this.setPendingUpdate(g.TileUpdate.GEOMETRY),!0},e.prototype.updateVisibility=function(){this._dirty=!0},e.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},e.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data&&!i.dataInvalidated},e.prototype.hasDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemap;return!n||"unavailable"!==n.getAvailability(e.lij[1],e.lij[2])},Object.defineProperty(e.prototype,"hasPendingUpdates",{get:function(){return 0!==this._pendingUpdates},enumerable:!0,configurable:!0}),e.prototype.isSuspended=function(e){return!!this.hasPendingUpdate(g.TileUpdate.SPLIT)||e!==g.LayerClass.ELEVATION&&!this.visible},Object.defineProperty(e.prototype,"elevationDone",{get:function(){if(this.hasPendingUpdate(g.TileUpdate.GEOMETRY))return!1;for(var e=0,t=this.layerInfo[g.LayerClass.ELEVATION];e<t.length;e++){var i=t[e];if(i.loadingAgent!==f.DONE||!i.upsampleFromTile)return!1}return!0},enumerable:!0,configurable:!0}),e.prototype.hasPendingUpdate=function(e){return(this._pendingUpdates&e)===e},e.prototype.setPendingUpdate=function(e){this._pendingUpdates|=e,this._surface.setPendingUpdates()},e.prototype.resetPendingUpdate=function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)},e.prototype.requestLayerData=function(e,t,i){g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,i.tile.lij.toString());var n=this.layerInfo[t][e];if(n.waitingAgents.indexOf(i)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(i),n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),setTimeout(i.dataArrived.bind(i,this),0),!0;if(n.requestPromise)return!0;var r=this._surface.requestTileData(this,e,t);if(!r||r.isFulfilled())return!1;var a=function(){n.requestPromise===r&&(n.requestPromise=null)};return n.requestPromise=r,r.then(a,a),!0},e.prototype.descendants=function(e){e||(e=[]);for(var t=0;t<4;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},Object.defineProperty(e.prototype,"isLeaf",{get:function(){return!(this.children[0]||this.children[1]||this.children[2]||this.children[3])},enumerable:!0,configurable:!0}),e.prototype.hasLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},e.prototype.findByLij=function(e){if(this.hasLij(e))return this;for(var t=0;t<4;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},e.prototype.unrequestLayerData=function(e,t,n){g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var r=this.layerInfo[t][e],a=r.waitingAgents,s=null!=i.removeUnordered(a,n);if(U(s,"agent has not requested this piece of map data"),a.length<1){var o=r.requestPromise;o&&!o.isFulfilled()&&(o.cancel(),r.requestPromise=null),g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),t,e),this.updateMemoryUsed()}},e.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1;for(var r=0;r<n.waitingAgents.length;r++)n.waitingAgents[r].dataArrived(this);n.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);var n=this.layerInfo[t][e];n.dataMissing=!0;for(var r=0;r<n.waitingAgents.length;r++)n.waitingAgents[r].dataMissing(this);n.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.updateRenderData=function(e){switch(e){case g.LayerClass.MAP:return this.updateTexture();case g.LayerClass.ELEVATION:return this.updateGeometry()}},e.prototype.updateTexture=function(){this.renderData&&(this._pendingUpdates|=g.TileUpdate.TEXTURE,this._surface.setPendingUpdates())},e.prototype.updateGeometry=function(){this.setPendingUpdate(g.TileUpdate.GEOMETRY);for(var e=0,t=this.layerInfo[g.LayerClass.ELEVATION];e<t.length;e++){t[e].pendingUpdates|=g.TileUpdate.GEOMETRY}this._surface.setPendingUpdates()},e.prototype.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},e.prototype.computeElevationBounds=function(){n.vec2.set(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);for(var e=this.layerInfo[g.LayerClass.ELEVATION],t=!1,i=0,r=e;i<r.length;i++){var a=r[i];a.elevationBounds&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],a.elevationBounds[0]),this._elevationBounds[1]=Math.max(this._elevationBounds[1],a.elevationBounds[1]),t=!0)}t||n.vec2.set(this._elevationBounds,0,0),this.updateRadiusAndCenter()},e.prototype.updateRadiusAndCenter=function(){var e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);a.vec3.scale(I,this.tileUp,e),a.vec3.add(this.center,this.centerAtSeaLevel,I)},e.prototype.findElevationBoundsForLayer=function(e,t){var i=this.layerInfo[g.LayerClass.ELEVATION][e];if(!i.elevationBounds||i.elevationBounds[2]<t){var r=this._surface.layerViewByIndex(e,g.LayerClass.ELEVATION);if(v.fallsWithinLayer(this,r.layer,!1)){var s=O,o=!1;if(i.data){var l=i.data;n.vec2.copy(s,l.bounds),s[2]=this.lij[0],o=!0}else{for(var d=0,h=void 0,l=void 0,p=this._parent;p&&(!l||d<g.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(d=this.vlevel-p.lij[0],h=l||h,!(!(l=p.layerInfo[g.LayerClass.ELEVATION][e].data)&&h&&d>=g.ELEVATION_DESIRED_RESOLUTION_LEVEL));p=p._parent);l=l||h,l&&(l.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],s),s[0]!==1/0&&(s[2]=l.level,o=!0))}o&&(i.elevationBounds?a.vec3.copy(i.elevationBounds,s):i.elevationBounds=[s[0],s[1],s[2]])}}},e.prototype.modifyLayers=function(e,t,i){for(var n=this.layerInfo[i],r=0,a=n;r<a.length;r++){var s=a[r];s.loadingAgent&&s.loadingAgent!==f.DONE&&(_(s.loadingAgent),s.loadingAgent=null),s.waitingAgents.length=0}if(i===g.LayerClass.MAP)for(var o=0;o<n.length;++o)void 0===e[o]&&n[o].dispose();for(var l=t.length,d=new Array(l),o=0;o<l;o++){var h=t[o];d[o]=h>-1?n[h]:y.TilePerLayerInfo.makeEmptyLayerInfo(i,this._surface.upsampleInfoPool)}this.layerInfo[i]=d,this.updateMemoryUsed()},e.prototype.restartAgents=function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))},e.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===f.DONE&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},e.prototype.updateAgentSuspension=function(){for(var e=0;e<g.LayerClass.COUNT;e++)for(var t=this.isSuspended(e),i=0,n=this.layerInfo[e];i<n.length;i++){var r=n[i];r.loadingAgent&&r.loadingAgent!==f.DONE&&(r.loadingAgent.setSuspension(t),r.loadingAgent===f.DONE&&this.updateRenderData(e))}},e.prototype.removeLayerAgent=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==f.DONE&&i.loadingAgent.dispose(),i.loadingAgent=null},e.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=f.DONE,n.data||n.upsampleFromTile||this._createOrUpdateAgents(e+1,t)},e.prototype._createOrUpdateAgents=function(e,t){for(var i=this.isSuspended(t),n=this.layerInfo[t],r=e;r<n.length;++r){var a=n[r],s=!1,o=this._surface.layerViewByIndex(r,t);if(a.loadingAgent?(a.loadingAgent!==f.DONE&&a.loadingAgent.setSuspension(i),a.loadingAgent!==f.DONE&&(s=a.loadingAgent.update())):v.fallsWithinLayer(this,o.layer,!1)&&(a.loadingAgent=L(this,r,t,i),s=a.loadingAgent.startLoading(),s?a.loadingAgent===f.DONE&&this.setPendingUpdate(g.TileUpdate.GEOMETRY):(_(a.loadingAgent),a.loadingAgent=f.DONE)),a.loadingAgent===f.DONE&&this.updateRenderData(t),s&&o.isOpaque)return}},e.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},e.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},e}()});