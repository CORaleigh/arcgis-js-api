// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/PooledArray","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../webgl-engine/materials/internal/MaterialUtil"],function(t,e,r,n,i,s){function a(t){return t[0]+"/"+t[1]+"/"+t[2]}function o(t){return a(t.lij)}function l(t,e){if(Array.isArray(t))for(var r=0;r<t.length;r++)f(t[r],e);else f(t,e)}function f(t,e){e(t);for(var r=0;r<4;r++){var n=t.children[r];n&&f(n,e)}}function u(t,e){if(Array.isArray(t))for(var r=0;r<t.length;r++)c(t[r],e);else c(t,e)}function c(t,e){for(var r=0;r<4;r++){var n=t.children[r];n&&c(n,e)}e(t)}function h(t,e){for(;t;t=t.parent)if(t.hasLij(e))return t;return null}function v(t,e,r){if(!e)return!1;var n=e.fullExtent,i=t.extent;if(r){if(i[0]<n.xmin||i[1]<n.ymin||i[2]>n.xmax||i[3]>n.ymax)return!1}else if(n.xmin>i[2]||n.ymin>i[3]||n.xmax<i[0]||n.ymax<i[1])return!1;var s=t.surface.tilingScheme.levels[t.lij[0]].scale;return!(e.minScale>0&&s>1.00000001*e.minScale)&&!(e.maxScale>0&&s<.99999999*e.maxScale)}function p(t,e){var r=t.extent;return e[0]>=r[0]&&e[1]>=r[1]&&e[0]<=r[2]&&e[1]<=r[3]}function d(t,e){for(;e--;)t=t.parent;return t}function m(t,e){var r=t.lij[0]-e.lij[0]-1,n=t.lij[1]>>r,i=t.lij[2]>>r,s=0;return 1&n&&(s+=2),1&i&&(s+=1),e.children[s]}function x(t,e){e.sort(function(e,r){return y(e,r,t)})}function y(t,e,r){var n=t.screenDepth,i=e.screenDepth;return n<i?-r:n>i?r:0}function q(t,e,r){for(var n=1,i=0,s=0;t!==e;)if(n*=.5,i*=.5,s*=.5,1&t.lij[2]&&(i+=.5),0==(1&t.lij[1])&&(s+=.5),null==(t=t.parent))throw new Error("tile was not a descendant of upsampleTile");r.init(e,i,s,n)}function g(t){for(var e=0;e<t.length;e++){var r=t[e],n=r.parent;if(n)for(var i=0;i<4;i++){var s=n.children[i];if(s&&s!==r&&s.visible)return!0}}return!1}function j(t,e,r,i,a,o,l,f,u){for(var c=o.data,h=o.offsetIdx,v=o.strideIdx,p=t[0],d=t[1],m=t[2],x=e[0],y=e[1],q=e[2],g=x-p,j=y-d,_=q-m,b=r;b<i;b++){var T=l?l[b]:b,w=h+v*a[3*T],I=h+v*a[3*T+1],L=h+v*a[3*T+2],M=c[w],U=c[w+1],k=c[w+2];c[w+3]>=2&&(n.vec3.set(P,M,U,k),f(P),M+=P[0],U+=P[1],k+=P[2]);var D=c[I],E=c[I+1],N=c[I+2];c[I+3]>=2&&(n.vec3.set(P,D,E,N),f(P),D+=P[0],E+=P[1],N+=P[2]);var O=c[L],W=c[L+1],B=c[L+2];c[L+3]>=2&&(n.vec3.set(P,O,W,B),f(P),O+=P[0],W+=P[1],B+=P[2]);var J=D-M,V=E-U,z=N-k,C=O-M,F=W-U,G=B-k,H=j*G-F*_,K=_*C-G*g,Q=g*F-C*j,R=J*H+V*K+z*Q,X=p-M,Y=d-U,Z=m-k,$=Y*z-V*Z,tt=Z*J-z*X,et=X*V-J*Y;if(R>A){var rt=X*H+Y*K+Z*Q;if(rt<0||rt>R)continue;var nt=g*$+j*tt+_*et;if(nt<0||rt+nt>R)continue}else{if(!(R<-A))continue;var rt=X*H+Y*K+Z*Q;if(rt>0||rt<R)continue;var nt=g*$+j*tt+_*et;if(nt>0||rt+nt<R)continue}var it=(C*$+F*tt+G*et)/R;if(it>=0){u(it,s.computeNormal(J,V,z,C,F,G,S),T)}}}Object.defineProperty(e,"__esModule",{value:!0});var _=function(){function t(){this.q=new r,this._last=null,this.done=!0}return t.prototype.resetOne=function(t){this.q.clear(),this.q.push(t),this._last=null,this.done=!1},t.prototype.reset=function(t){this.q.clear(),t&&this.q.pushArray(t),this._last=null,this.done=0===this.q.length},t.prototype.skipSubtree=function(){this._last=null,0===this.q.length&&(this.done=!0)},t.prototype.next=function(){if(this.done)return null;if(this._last){var t=this._last.children;if(t[0])for(var e=3;e>=0;e--){var r=t[e];r&&this.q.push(r)}}return this._last=this.q.pop(),0!==this.q.length||this._last.children[0]||(this.done=!0),this._last},t}();e.IteratorPreorder=_;var b=function(){function t(){this.q=new r,this.done=!0}return t.prototype.reset=function(t){if(this.q.clear(),t){this.q.pushArray(t);for(var e=0;e<this.q.length;++e)for(var r=this.q.data[e],n=0;n<4;n++){var i=r.children[n];i&&this.q.push(i)}}this.done=0===this.q.length},t.prototype.next=function(){var t=this.q.pop();return this.done=0===this.q.length,t},t}();e.IteratorPostorder=b,e.lij2str=a,e.tile2str=o,e.traverseTilesPreorder=l,e.traverseTilesPostorder=u,e.findParentByLIJ=h,e.fallsWithinLayer=v,e.isPosWithinTile=p,e.getTileNLevelsUp=d,e.nextTileInAncestry=m,e.sortTiles=x,e.compareTiles=y,e.computeUpsampleInfo=q,e.hasVisibleSiblings=g;var A=Math.pow(2,-52),P=i.vec3f64.create(),S=i.vec3f64.create();e.intersectSkirts=j});