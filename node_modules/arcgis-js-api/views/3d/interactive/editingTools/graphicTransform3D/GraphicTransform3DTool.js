// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/math/common","../../../../../geometry/Point","../../../../../layers/graphics/dehydratedFeatures","./graphicTransform3DToolConfig","./isSupportedGraphic","../../../support/geometryUtils","../../../support/mathUtils","../../../support/projectionUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/InteractiveToolBase","../../../../interactive/Manipulator3D","../../../../interactive/manipulatorUtils"],function(t,e,a,r,i,n,o,s,c,l,u,p,h,g,m,d,f,v,_,y,S,D,T,R,M,I,A,b,w,E,O,N,C,F){function P(t){var e=new w(E.createCylinderGeometry(T.DISC_HEIGHT,1,T.GEOMETRY_SEGMENTS,_.vec3f64.fromValues(0,0,1),_.vec3f64.fromValues(0,0,0)),"graphic-transform-disc"),a=W(),r=W(.5),i=d.mat4.fromScaling(f.mat4f64.create(),_.vec3f64.fromValues(T.DISC_RADIUS,T.DISC_RADIUS,T.DISC_RADIUS)),n=new C.Manipulator3D({view:t,renderObjects:[{geometry:e,material:a,stateMask:rt.RingUnfocused|rt.ArrowUnfocused,transform:i},{geometry:e,material:r,transform:i}],autoScaleRenderObjects:!1,radius:T.DISC_COLLISION_RADIUS,focusMultiplier:1,allowOverlap:!0,snapToPointer:!1,alignment:"on-the-ground",collisionType:{type:"disc",direction:_.vec3f64.fromValues(0,0,1)}});return n.visible=!1,n}function k(t){for(var e=function(t,e,a){for(var r=[],i=Math.ceil(T.GEOMETRY_SEGMENTS*(e-t)/(2*Math.PI)),n=0;n<i+1;n++){var o=t+n*(e-t)/i;r.push(_.vec3f64.fromValues(a*Math.cos(o),a*Math.sin(o),0))}return r},a=function(t){return e(0,2*Math.PI,t)},r=function(t){return[[-t/2,0],[t/2,0],[t/2,T.RING_HEIGHT/2],[-t/2,T.RING_HEIGHT/2]]},i=function(t,e){return new w(E.createPathExtrusionGeometry(r(e),t,[],[],!1),"graphic-transform-ring")},n=a(T.RING_RADIUS),o=i(n,T.RING_THICKNESS),s={left:[],right:[]},c=[],l=0;l<2;l++){var u=l*Math.PI-Math.PI/4,p=Math.PI/2-T.ROTATE_INDICATOR_ARC_LENGTH,h=u+p,g=u+Math.PI/2-p,m=e(h,g,T.INNER_INDICATOR_RADIUS),v=i(m,T.INDICATOR_THICKNESS);c.push(m),s.left.push(v),s.right.push(v);for(var y=0;y<2;y++){var S=0===y,D=f.mat4f64.create();if(S){d.mat4.scale(D,D,[1,-1,1]),d.mat4.rotate(D,D,-h,[0,0,1]);var R=Math.round(T.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(m.length-1));D[12]=m[R][0],D[13]=m[R][1],D[14]=m[R][2]}else{d.mat4.rotate(D,D,g,[0,0,1]);var R=Math.round((1-T.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(m.length-1));D[12]=m[R][0],D[13]=m[R][1],D[14]=m[R][2]}var M=E.createExtrudedTriangle(T.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,T.ROTATE_INDICATOR_ARROW_TIP_RADIUS,T.RING_HEIGHT);E.transformInPlace(M,D);var I=new w(M,"graphic-transform-ring-rotate");(S?s.left:s.right).push(I)}}for(var A=[],l=0;l<2;l++){var u=l*Math.PI-Math.PI/4,p=Math.PI/2-T.SCALE_INDICATOR_ARC_LENGTH,h=u+p,g=u+Math.PI/2-p,m=e(h,g,T.OUTER_INDICATOR_RADIUS);A.push(i(m,T.INDICATOR_THICKNESS))}var b=a(T.RING_RADIUS+T.SCALE_INDICATOR_OFFSET1),O=a(T.RING_RADIUS+T.SCALE_INDICATOR_OFFSET2),N=i(b,T.INDICATOR_THICKNESS),F=i(O,T.INDICATOR_THICKNESS),P=a(T.RING_RADIUS-T.SCALE_INDICATOR_OFFSET1),k=a(T.RING_RADIUS-T.SCALE_INDICATOR_OFFSET2),G=i(P,T.INDICATOR_THICKNESS),H=i(k,T.INDICATOR_THICKNESS),L=W(),U=W(.66),x=W(.5),j=W(.33),V=[{geometry:o,material:L,stateMask:rt.DiscUnfocused|rt.ArrowUnfocused},{geometry:o,material:x},{geometry:A,material:L,stateMask:rt.Unlocked|rt.RingFocused},{geometry:N,material:U,stateMask:2|rt.ScaleIn},{geometry:F,material:j,stateMask:2|rt.ScaleIn},{geometry:G,material:U,stateMask:2|rt.ScaleOut},{geometry:H,material:j,stateMask:2|rt.ScaleOut},{geometry:s.left,material:L,stateMask:rt.Unlocked|rt.RingFocused},{geometry:s.left,material:L,stateMask:2|rt.RotateLeft},{geometry:s.right,material:L,stateMask:2|rt.RotateRight}],z=[n].concat(c);return new C.Manipulator3D({view:t,renderObjects:V,autoScaleRenderObjects:!1,radius:T.RING_THICKNESS,focusMultiplier:1,moveOnDrag:!1,allowOverlap:!0,alignment:"on-the-ground",collisionType:{type:"ribbon",paths:z,direction:_.vec3f64.fromValues(0,0,1)}})}function G(t){var e=Math.sqrt(T.DISC_TRANSLATE_ARROW_SIZE*T.DISC_TRANSLATE_ARROW_SIZE*3/4),a=E.createExtrudedTriangle(e,T.DISC_TRANSLATE_ARROW_SIZE/2,T.DISC_TRANSLATE_ARROW_SIZE/2,T.DISC_HEIGHT);E.transformInPlace(a,d.mat4.fromTranslation(b.sm4d.get(),v.vec3.set(b.sv3d.get(),0,-e/3,0)));var r=new w(a,"graphic-transform-disc-arrow"),i=W(),n=W(.5),o=new C.Manipulator3D({view:t,renderObjects:[{geometry:r,material:n,stateMask:1|rt.DiscFocused},{geometry:r,material:n,stateMask:1|rt.ArrowFocused},{geometry:r,material:i,stateMask:2}],autoScaleRenderObjects:!1,radius:e,focusMultiplier:1,allowOverlap:!0,snapToPointer:!1,alignment:"on-the-ground",collisionType:{type:"disc",direction:_.vec3f64.fromValues(0,0,1)}});return o.visible=!1,o}function H(t,e){var a=this,r=t.allLayerViews.find(function(t){return t.layer===e.layer}),o=e.symbol;return u.all(o.symbolLayers.map(function(t){return n(a,void 0,void 0,function(){var e,a,n;return i(this,function(i){switch(i.label){case 0:e=null,a=null,"object"===t.type&&(e=t.heading),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,r.whenSymbolLayerSize(o,t)];case 2:return a=i.sent(),[3,4];case 3:return n=i.sent(),a=null,[3,4];case 4:return[2,{heading:e,size:a}]}})})}).toArray()).then(function(t){return{symbolLayers:t}})}function L(t){var e=t.symbol,a=e.symbolLayers.find(function(t){return"object"===t.type});return a&&a.heading||0}function U(t,e,a,r){t.symbolLayers.forEach(function(t,i){var n=e.symbolLayers[i],o=n.heading,s=n.size;"object"===t.type&&(t.heading=(l.isSome(o)?o:0)-y.toDegree(a),l.isSome(s)&&"width"in s&&(t.width=s.width*r,t.depth=s.depth*r,t.height=s.height*r))})}function x(t){var e=v.vec3.subtract(b.sv3d.get(),t.startPoint,t.origin),a=v.vec3.subtract(b.sv3d.get(),t.endPoint,t.origin),r=v.vec3.length(e),i=v.vec3.length(a);return 0===r?0:i/r}function j(t,e){var a=t.origin,r=t.startPoint,i=t.endPoint,n=t.plane,o=V(r,e,b.sv3d.get()),s=V(i,e,b.sv3d.get());if(v.vec3.squaredDistance(o,s)<T.DRAG_THRESHOLD_PX*T.DRAG_THRESHOLD_PX)return null;var c=v.vec3.subtract(b.sv3d.get(),r,a),l=v.vec3.cross(b.sv3d.get(),c,n),u=r,p=v.vec3.add(b.sv3d.get(),u,l),h=V(a,e,b.sv3d.get()),g=o,m=V(p,e,b.sv3d.get()),d=v.vec3.subtract(b.sv3d.get(),m,g),f=v.vec3.subtract(b.sv3d.get(),o,h),_=M.ray.wrap(g,d),y=M.ray.wrap(h,f);return M.ray.distance2(_,s)<M.ray.distance2(y,s)?"rotate":"scale"}function W(t){void 0===t&&(t=1);var e=T.HANDLE_COLOR.concat([t]),a=new O({color:e,transparent:1!==t,cullFace:"back"},"graphic-transform");return a.renderOccluded=2,a}function V(t,e,a){var r=e.projectPoint(t,h.castRenderScreenPointArray(it)),i=e.renderToScreen(r,nt);return v.vec3.set(a,i[0],i[1],0)}function z(t,e){var a=t.longitude,r=e.longitude;if(null==a||null==r)return!1;var i=I.cyclicalDeg.shortestSignedDiff(a,r);return Math.abs(i)<90}function K(t){var e=t.spatialReference;return"local"===t.viewingMode||(e.isWGS84||e.isWebMercator)&&t.scale<T.ALIGN_ARROWS_SCALE_THRESHOLD}Object.defineProperty(e,"__esModule",{value:!0});var B=c.getLogger("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool"),Z=function(){function t(t){this.graphic=t}return t}();e.GraphicTranslateStartEvent=Z;var q=function(){function t(t){this.graphic=t}return t}();e.GraphicTranslateStopEvent=q;var Y=function(){function t(t){this.graphic=t}return t}();e.GraphicRotateStartEvent=Y;var X=function(){function t(t){this.graphic=t}return t}();e.GraphicRotateStopEvent=X;var J=function(){function t(t){this.graphic=t}return t}();e.GraphicScaleStartEvent=J;var Q=function(){function t(t){this.graphic=t}return t}();e.GraphicScaleStopEvent=Q;var $=function(){function t(t,e,a){this.graphic=t,this.dx=e,this.dy=a,this.type="translate"}return t}();e.GraphicTranslateEvent=$;var tt=function(){function t(t,e){this.graphic=t,this.angle=e,this.type="rotate"}return t}();e.GraphicRotateEvent=tt;var et=function(){function t(t,e){this.graphic=t,this.scale=e,this.type="scale"}return t}();e.GraphicScaleEvent=et;var at=function(t){function e(e){var a=t.call(this,e)||this;return a.enableRotation=!0,a.enableScaling=!0,a.discManipulator=null,a.ringManipulator=null,a.arrowManipulators=null,a.type="transform-3d",a._handles=new s,a._arrowDragData=null,a._ringDragData=null,a._startSymbolDataPromise=null,a._startSymbolData=null,a._ringDelayedFocusFrameTask=null,a._ringManipulatorHasDelayedFocused=!1,a._scaleAnimationFrameTask=null,a}return r(e,t),e.prototype.destroy=function(){this._removeFrameTasks(),this.graphic=null,this._handles.destroy(),this._handles=null,this._set("view",null)},Object.defineProperty(e.prototype,"graphic",{set:function(t){if(l.isSome(t)&&!R.isSupportedGraphic(t))return void B.error("Only graphics from a graphics layer with point geometries and object symbology are supported");this._set("graphic",t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_ringMode",{get:function(){return l.isSome(this._ringDragData)&&this._ringDragData.mode||this._ringModeFromOptions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_ringModeFromOptions",{get:function(){var t=this._shouldAllowModeType("scale"),e=this._shouldAllowModeType("rotate");return t||e?e?t?null:{type:"rotate",startAngle:0}:{type:"scale"}:{type:"disabled"}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_manipulatorState",{get:function(){var t=this._ringMode,e=0;return e=l.isNone(t)?rt.Unlocked:"rotate"===t.type?l.isSome(this._ringDragData)&&this._ringDragData.angleDir<0?rt.RotateLeft:rt.RotateRight:l.isSome(this._ringDragData)&&this._ringDragData.scaleDir<0?rt.ScaleIn:rt.ScaleOut,e|=this.discManipulator.focused?rt.DiscFocused:rt.DiscUnfocused,e|=this._ringManipulatorHasDelayedFocused?rt.RingFocused:rt.RingUnfocused,e|=this.arrowManipulators.some(function(t){return t.manipulator.focused})?rt.ArrowFocused:rt.ArrowUnfocused},enumerable:!0,configurable:!0}),e.prototype.hide=function(){this._removeFrameTasks()},e.prototype.reset=function(){this.graphic=null},e.prototype.onAttach=function(t){for(var e=this,a=P(this.view),r=k(this.view),i=[],n=0;n<4;n++){var o=G(this.view),s=f.mat4f64.create();this._calculateArrowManipulatorTransform(n,s),i.push({manipulator:o,transform:s})}this.discManipulator=a,this.ringManipulator=r,this.arrowManipulators=i,this._handles.add([a.watch("grabbing",function(t){e._setSingleManipulatorInteractive(a,t)},!0),a.watch("dragging",function(t){l.isSome(e.graphic)&&(t?e.emit("graphic-translate-start",new Z(e.graphic)):e.emit("graphic-translate-stop",new q(e.graphic)))},!0),g.watch(a,"focused",function(){l.isNone(e._scaleAnimationFrameTask)&&e._updateManipulators()}),g.init(this,"graphic.geometry",function(){l.isSome(e.graphic)&&e.graphic.geometry&&"point"===e.graphic.geometry.type&&(a.mapPoint=D.clonePoint(e.graphic.geometry,st)),e._updateManipulators()},!0)]),i.forEach(function(t,a){var r=t.manipulator;r.on("drag",function(t){e._handleArrowDrag(a)}),e._handles.add([g.watch(r,"focused",function(){e._updateManipulators()}),g.watch(r,"grabbing",function(t){e._setSingleManipulatorInteractive(r,t)}),g.watch(r,"dragging",function(t){l.isNone(e.graphic)||(t?e.emit("graphic-translate-start",new Z(e.graphic)):(e._arrowDragData=null,e.emit("graphic-translate-stop",new q(e.graphic))))})])}),a.on("drag",function(t){if(!l.isNone(e.graphic)&&e.graphic.geometry&&"point"===e.graphic.geometry.type){var r=e.graphic.geometry.z,i=e.graphic.geometry,n=D.clonePoint(a.mapPoint,new S);n.z=r,e.graphic.geometry=n;var o=n.x-i.x,s=n.y-i.y;e.emit("graphic-translate",new $(e.graphic,o,s))}}),this._handles.add([r.watch("grabbing",function(t){e._setSingleManipulatorInteractive(r,t)},!0),r.watch("dragging",function(t){if(!1===t){var a=e._ringDragData;if(e._ringDragData=null,e._startSymbolDataPromise=null,e._startSymbolData=null,l.isSome(a)){var r=a.mode;if(l.isNone(r)||l.isSome(r)&&"scale"===r.type){var i=x(a);e._startScaleResetAnimation(i)}else e._updateManipulators();if(l.isSome(e.graphic)&&l.isSome(a.mode))switch(a.mode.type){case"rotate":e.emit("graphic-rotate-stop",new X(e.graphic));break;case"scale":e.emit("graphic-scale-stop",new Q(e.graphic))}}}else if(l.isSome(e.graphic)&&l.isSome(e._ringMode)&&"disabled"!==e._ringMode.type)switch(e._ringMode.type){case"rotate":e.emit("graphic-rotate-start",new Y(e.graphic));break;case"scale":e.emit("graphic-scale-start",new J(e.graphic))}},!0),g.watch(r,"focused",function(){l.isNone(e._scaleAnimationFrameTask)&&e._startRingFocusFrameTask()})]),r.on("drag",function(t){e._handleRingDrag(t.screenPoint)}),t.addManipulator(a),t.addManipulator(r),i.forEach(function(e){var a=e.manipulator;return t.addManipulator(a)})},e.prototype.onDetach=function(){this._handles.removeAll(),this.discManipulator=null,this.ringManipulator=null,this.arrowManipulators=[]},e.prototype._handleArrowDrag=function(t){if(!l.isNone(this.graphic)&&this.graphic.geometry&&"point"===this.graphic.geometry.type){var e=this.arrowManipulators[t].manipulator,a=this.graphic.geometry,r=this.graphic.geometry.spatialReference,i=new S,n=K(this.view);if(n){var o=this._calculateArrowManipulatorDirection(t,b.sv3d.get()),s=v.vec3.subtract(b.sv3d.get(),e.position,this.discManipulator.position);M.vector.projectPoint(o,s,s);var c=v.vec3.add(s,s,this.discManipulator.position);if(!this.view.renderCoordsHelper.fromRenderCoords(c,i,r))return}else{var u=e.mapPoint;A.vectorToPoint(v.vec3.set(b.sv3d.get(),u.x,u.y,u.z),u.spatialReference,i,r)}var p=!z(a,i);p&&(i.x=a.x,i.y=a.y),n||p||(0===t||2===t?i.x=a.x:i.y=a.y);if(l.isNone(this._arrowDragData)){var h=D.clonePoint(a,new S),g=i.x-a.x,m=i.y-a.y;(Math.abs(g)>1e-5||Math.abs(m)>1e-5)&&(this._arrowDragData={startPoint:h,dxMapConstrained:g,dyMapConstrained:m})}else if(n&&!p){var d=this._arrowDragData,f=d.dxMapConstrained,_=d.dyMapConstrained,h=d.startPoint;if(Math.abs(f)<1e-5)i.x=h.x;else if(Math.abs(_)<1e-5)i.y=h.y;else{var y=i.x-h.x;i.y=h.y+y*_/f}}var T=i.x-a.x,R=i.y-a.y;i.z=a.z,this.graphic.geometry=i,this.emit("graphic-translate",new $(this.graphic,T,R))}},e.prototype._handleRingDrag=function(t){var e=this;if(!l.isNone(this.graphic)&&!l.isSome(this._startSymbolDataPromise)){var a=this._ringDragData,r=this._startSymbolData,i=this.graphic,n=h.screenPointObjectToArray(t,h.castScreenPointArray(b.sv2d.get())),o=M.ray.fromScreen(this.view.state.camera,n,ot),s=this.discManipulator.modelTransform;if(l.isNone(a)||l.isNone(r)){var c=_.vec3f64.fromValues(0,0,1);v.vec3.transformMat4(c,c,s);var u=_.vec3f64.clone(this.ringManipulator.position),p=M.plane.fromPositionAndNormal(u,c),g=_.vec3f64.create();M.plane.intersectRay(p,o,g)&&(this._ringDragData={origin:u,plane:p,angle:0,angleDir:0,scale:1,scaleDir:0,startPoint:g,endPoint:_.vec3f64.clone(g),mode:null},this._startSymbolDataPromise=H(this.view,i),this._startSymbolDataPromise.then(function(t){e._startSymbolData=t,e._startSymbolDataPromise=null},function(){e._startSymbolDataPromise=null}))}else{var p=a.plane;if(M.plane.intersectRay(p,o,a.endPoint)){var m=x(a),c=p,f=F.calculateInputRotationTransform(a.startPoint,a.endPoint,a.origin,c),S=I.cyclicalPI.shortestSignedDiff(a.angle,f);a.angleDir=I.clamp(a.angleDir+S,-T.ROTATE_INDICATOR_DIRECTION_BUFFER,T.ROTATE_INDICATOR_DIRECTION_BUFFER),a.angle=f;var D=m-a.scale;a.scaleDir=I.clamp(a.scaleDir+D,-T.SCALE_INDICATOR_DIRECTION_BUFFER,T.SCALE_INDICATOR_DIRECTION_BUFFER),a.scale=m;var R=null,A=this._ringMode;if(l.isSome(A))R=A;else{var w=j(a,this.view.state.camera);if(l.isSome(w)){switch(w){case"rotate":this.emit("graphic-rotate-start",new Y(this.graphic));break;case"scale":this.emit("graphic-scale-start",new J(this.graphic))}R="scale"===w?{type:"scale"}:{type:"rotate",startAngle:f}}}a.mode=R,l.isSome(R)&&("rotate"===R.type?m=1:"scale"===R.type&&(f=0));var E=d.mat4.fromScaling(b.sm4d.get(),v.vec3.set(b.sv3d.get(),m,m,1));if(this._updateManipulators(E),l.isSome(R)&&"disabled"!==R.type){"rotate"===R.type&&(f-=R.startAngle);var O=i.symbol.clone();switch(U(O,r,f,m),this.graphic.symbol=O,R.type){case"rotate":this.emit("graphic-rotate",new tt(this.graphic,y.toDegree(f)));break;case"scale":this.emit("graphic-scale",new et(this.graphic,m))}}}}}},e.prototype._shouldAllowModeType=function(t){return"scale"===t?this.enableScaling:!(l.isNone(this.graphic)||!this.enableRotation)&&this.graphic.symbol.symbolLayers.some(function(t){return"object"===t.type})},e.prototype._updateManipulators=function(t){var e=this._manipulatorState,a=this._getManipulatorRotationAngle(),r=d.mat4.identity(b.sm4d.get());0!==a&&d.mat4.rotate(r,r,a,_.vec3f64.fromValues(0,0,1));var i=this.discManipulator.position,n=this.view.renderCoordsHelper.basisMatrixAtPosition(i,b.sm4d.get()),o=t?d.mat4.multiply(b.sm4d.get(),n,t):n,s=l.isSome(this.graphic)&&null!=this.graphic.geometry,c=K(this.view)?d.mat4.multiply(b.sm4d.get(),o,r):o;this.discManipulator.state=e,this.discManipulator.modelTransform=c,this.discManipulator.visible=s,this.arrowManipulators.forEach(function(t){var a=t.manipulator,r=t.transform,n=d.mat4.multiply(b.sm4d.get(),c,r);a.state=e,a.position=i,a.modelTransform=n,a.visible=s});var u=d.mat4.multiply(b.sm4d.get(),o,r);this.ringManipulator.state=e,this.ringManipulator.position=this.discManipulator.position,this.ringManipulator.modelTransform=u;var p=this._ringMode,h=l.isSome(p)&&"disabled"===p.type;this.ringManipulator.visible=s&&!h},e.prototype._setSingleManipulatorInteractive=function(t,e){if(!e)return this.discManipulator.interactive=!0,this.ringManipulator.interactive=!0,void this.arrowManipulators.forEach(function(t){t.manipulator.interactive=!0});this.discManipulator.interactive=this.discManipulator===t,this.ringManipulator.interactive=this.ringManipulator===t,this.arrowManipulators.forEach(function(e){var a=e.manipulator;a.interactive=a===t})},e.prototype._startRingFocusFrameTask=function(){var t=this;this._removeFrameTasks();var e=0;this._ringDelayedFocusFrameTask=p.addFrameTask({update:function(a){var r=a.deltaTime;if(e+=r,!t.ringManipulator.focused)return t._ringManipulatorHasDelayedFocused=!1,t._updateManipulators(),void t._removeFrameTasks();e>T.RING_INDICATOR_DELAY_MS&&(t._ringManipulatorHasDelayedFocused=!0,t._updateManipulators(),t._removeFrameTasks())}})},e.prototype._startScaleResetAnimation=function(t){var e=this;this._removeFrameTasks();var a=t;this._scaleAnimationFrameTask=p.addFrameTask({update:function(t){var r=t.deltaTime;if(a+=((a+1)/2-a)*Math.min(r*T.RING_RESET_ANIMATION_SPEED_FACTOR,1),Math.abs(a-1)<.01)return e._updateManipulators(),void e._removeFrameTasks();var i=d.mat4.fromScaling(b.sm4d.get(),v.vec3.set(b.sv3d.get(),a,a,1));e._updateManipulators(i)}})},e.prototype._getManipulatorRotationAngle=function(){var t=l.isSome(this.graphic)?L(this.graphic):0,e=y.toRadian(-t);if(l.isNone(this._ringDragData)||l.isSome(this._ringDragData.mode))return e;var a=this._ringDragData,r=a.origin,i=a.plane,n=a.startPoint,o=a.endPoint,s=i;return e+F.calculateInputRotationTransform(n,o,r,s)},e.prototype._calculateArrowManipulatorTransform=function(t,e){var a=d.mat4.identity(b.sm4d.get());d.mat4.fromZRotation(a,t*Math.PI/2);var r=d.mat4.identity(b.sm4d.get());return d.mat4.fromTranslation(r,v.vec3.set(b.sv3d.get(),0,T.DISC_TRANSLATE_ARROW_OFFSET,0)),d.mat4.multiply(e,a,r)},e.prototype._calculateArrowManipulatorDirection=function(t,e){var a=this.discManipulator.modelTransform;return 0===t||2===t?v.vec3.set(e,a[4],a[5],a[6]):v.vec3.set(e,a[0],a[1],a[2])},e.prototype._removeFrameTasks=function(){this.ringManipulator&&(this._ringManipulatorHasDelayedFocused=this.ringManipulator.focused),l.isSome(this._ringDelayedFocusFrameTask)&&(this._ringDelayedFocusFrameTask.remove(),this._ringDelayedFocusFrameTask=null),l.isSome(this._scaleAnimationFrameTask)&&(this._scaleAnimationFrameTask.remove(),this._scaleAnimationFrameTask=null)},a([m.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),a([m.property({value:null})],e.prototype,"graphic",null),a([m.property()],e.prototype,"enableRotation",void 0),a([m.property()],e.prototype,"enableScaling",void 0),a([m.property({readOnly:!0})],e.prototype,"type",void 0),e=a([m.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool")],e)}(m.declared(N,o));e.GraphicTransform3DTool=at;var rt,it=_.vec3f64.create(),nt=h.createScreenPointArray();!function(t){t.Unlocked=16,t.ScaleIn=32,t.ScaleOut=64,t.RotateLeft=128,t.RotateRight=256,t.DiscFocused=512,t.DiscUnfocused=1024,t.RingFocused=2048,t.RingUnfocused=4096,t.ArrowFocused=8192,t.ArrowUnfocused=16384}(rt||(rt={}));var ot=M.ray.create(),st=D.makeDehydratedPoint(0,0,0,null)});