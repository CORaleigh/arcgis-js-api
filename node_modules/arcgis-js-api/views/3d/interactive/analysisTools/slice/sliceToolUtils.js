// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/compilerUtils","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/quat","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","./sliceToolConfig","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../../interactive/manipulatorUtils"],function(e,t,a,i,s,r,n,c,o,v,l,d,u,m,g,f){function p(e,t,a,i,s,r,n,c,v){return b(t,c.worldUpAtPosition(e,u.sv3d.get()),r,n,v.basis1,v.basis2),o.vec3.scale(v.basis1,v.basis1,i),o.vec3.scale(v.basis2,v.basis2,s),o.vec3.copy(v.origin,t),o.vec3.scale(v.origin,v.origin,-a),o.vec3.add(v.origin,v.origin,e),d.boundedPlane.fromValues(v.origin,v.basis1,v.basis2,v)}function b(e,t,s,r,n,c){var v=t,d=o.vec3.dot(e,v),m=Math.abs(d)>l.VERTICAL_DOT_THRESHOLD?"vertical":"horizontal",g=u.sv3d.get(),f=u.sv3d.get(),p=function(){o.vec3.cross(g,v,s.viewUp),o.vec3.cross(f,v,g)},b=function(e){o.vec3.cross(f,e,v),o.vec3.copy(g,v)};if(i.isSome(r)&&r!==m)switch(r){case"vertical":p();break;case"horizontal":b(s.viewUp);break;default:a.neverReached(r)}else switch(m){case"vertical":p();break;case"horizontal":b(e);break;default:a.neverReached(m)}var h=o.vec3.cross(u.sv3d.get(),g,f);o.vec3.dot(h,s.viewForward)>0&&o.vec3.scale(f,f,-1),o.vec3.normalize(n,g),o.vec3.normalize(c,f)}function h(e,t,a,i,s,r){var n=o.vec3.copy(u.sv3d.get(),r.origin),c=o.vec3.copy(u.sv3d.get(),r.basis1),v=o.vec3.copy(u.sv3d.get(),r.basis2),m=o.vec3.copy(u.sv3d.get(),s.origin);o.vec3.add(m,m,o.vec3.scale(u.sv3d.get(),s.basis1,e.direction[0]<0?1:-1)),o.vec3.add(m,m,o.vec3.scale(u.sv3d.get(),s.basis2,e.direction[1]<0?1:-1));var g=o.vec3.length(s.basis1),f=o.vec3.length(s.basis2),p=o.vec3.subtract(u.sv3d.get(),a,m),b=o.vec3.subtract(u.sv3d.get(),t,m),h=0,P=0;if(F(e)){var y=k(s),R=k(r);h=g-.5*e.direction[0]*o.vec3.dot(s.basis1,b)/g,P=f-.5*e.direction[1]*o.vec3.dot(s.basis2,b)/f;var S=R/y;h*=S,P*=S}var I=.5*e.direction[0]*o.vec3.dot(s.basis1,p)/g,_=.5*e.direction[1]*o.vec3.dot(s.basis2,p)/f,E=h+I,T=P+_,A=o.vec3.scale(u.sv3d.get(),s.basis1,E/g),H=o.vec3.scale(u.sv3d.get(),s.basis2,T/f);return E>0&&x(r.origin,A,i)>l.PLANE_MIN_BASIS_SCREEN_LEN2&&o.vec3.copy(c,A),T>0&&x(r.origin,H,i)>l.PLANE_MIN_BASIS_SCREEN_LEN2&&o.vec3.copy(v,H),o.vec3.copy(n,m),o.vec3.add(n,n,o.vec3.scale(u.sv3d.get(),c,e.direction[0]<0?-1:1)),o.vec3.add(n,n,o.vec3.scale(u.sv3d.get(),v,e.direction[1]<0?-1:1)),d.boundedPlane.fromValues(n,c,v,r)}function P(e,t){return l.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function y(e,t,a,i){var s=o.vec3.cross(u.sv3d.get(),t,a);return o.vec3.cross(s,s,t),d.plane.fromPositionAndNormal(e,s,i)}function R(e,t){return f.calculateTranslateRotateFromBases(e.basis1,e.basis2,e.origin,t)}function S(e,t,a){e.visible=!1,t.visible=!1,a.forEach(function(e){return e.visible=!1})}function I(e,t,a){var i=t.worldUpAtPosition(e.origin,u.sv3d.get()),s=Z(e,i),r=L(i,e),n=o.vec3.copy(u.sv3d.get(),s?1===r?e.basis1:e.basis2:e.plane);return d.plane.fromPositionAndNormal(e.origin,n,a)}function _(e,t,a,i,n){if(e.forceHide)return void(e.visible=!1);e.floating=!1;var c=i.worldUpAtPosition(a.origin,u.sv3d.get()),m=Z(a,c),g=L(c,a),f=O(a),p=m&&2!==g?f.basis2Positive:f.basis1Positive;r.mat4.rotateZ(e.transform,t,p.rotationIdx*Math.PI/2);var b=o.vec3.subtract(u.sv3d.get(),p.position,a.origin);o.vec3.normalize(b,b);var h=o.vec3.scale(u.sv3d.get(),b,n.computeScreenPixelSizeAt(p.position)*l.SHIFT_RESTART_OFFSET_DISTANCE);o.vec3.add(h,h,p.position);var P=n.projectPoint(h,s.castRenderScreenPointArray3(u.sv3d.get())),y=E(n,P);d.ray.fromRender(n,P,W),o.vec3.normalize(W.direction,W.direction);var R=u.sv3d.get();y&&d.boundedPlane.intersectRay(a,W,R)&&(e.floating=!0,h=R);var S=n.computeScreenPixelSizeAt(h);r.mat4.scale(e.transform,e.transform,o.vec3.set(u.sv3d.get(),S,S,S)),e.transform[12]=h[0],e.transform[13]=h[1],e.transform[14]=h[2],e.position=v.vec3f64.clone(h),e.visible=!0}function E(e,t){var a=e.viewport,i=a[0],s=a[1],r=a[2],n=a[3],c=Math.min(r,n)/16,o=!1;return t[0]<i+c?(t[0]=i+c,o=!0):t[0]>i+r-c&&(t[0]=i+r-c,o=!0),t[1]<s+c?(t[1]=s+c,o=!0):t[1]>s+n-c&&(t[1]=s+n-c,o=!0),o}function T(e,t,a){t.visible&&e(t.transform,a)}function A(e,t,a){var i=o.vec3.length(t.basis1),s=o.vec3.length(t.basis2),n=G(t),c=k(t);a.forEach(function(a){a.visible=!0,o.vec3.add(a.position,o.vec3.scale(u.sv3d.get(),t.basis1,a.direction[0]),o.vec3.scale(u.sv3d.get(),t.basis2,a.direction[1])),o.vec3.add(a.position,t.origin,a.position);var v=0;if(F(a))1===a.direction[0]&&-1===a.direction[1]?v=Math.PI/2:1===a.direction[0]&&1===a.direction[1]?v=Math.PI:-1===a.direction[0]&&1===a.direction[1]&&(v=3*Math.PI/2),a.scale=c;else{var l=0!==a.direction[0]?1:2,d=1===l?s:i;v=1===l?Math.PI/2:0,a.scale=d-n}r.mat4.identity(a.transform),r.mat4.rotateZ(a.transform,a.transform,v),r.mat4.scale(a.transform,a.transform,o.vec3.set(u.sv3d.get(),a.scale,a.scale,a.scale)),r.mat4.multiply(a.transform,e,a.transform),a.transform[12]=a.position[0],a.transform[13]=a.position[1],a.transform[14]=a.position[2]})}function H(e,t,a){for(var i=0;i<t.length;i++){var s=t[i],r=e[i],n=i===a;r(s.transform,n)}}function N(e,t,a,i,s,n){if(s.forceHide)return void(s.visible=!1);var c=a.worldUpAtPosition(t.origin,u.sv3d.get()),l=Z(t,c),d=L(c,t),m=O(t),g=l&&2!==d?m.basis2Negative:m.basis1Negative;r.mat4.identity(s.transform),r.mat4.rotateZ(s.transform,s.transform,g.rotationIdx*Math.PI/2),l&&r.mat4.rotateX(s.transform,s.transform,Math.PI/2),r.mat4.multiply(s.transform,e,s.transform);var f=g.position,p=i.computeScreenPixelSizeAt(f);r.mat4.scale(s.transform,s.transform,o.vec3.set(u.sv3d.get(),p,p,p)),s.transform[12]=f[0],s.transform[13]=f[1],s.transform[14]=f[2],s.position=v.vec3f64.clone(f),s.visible=!0}function w(e,t,a){t.visible&&e(t.transform,a)}function M(e,t,a){if(!e.visible)return!1;for(var i=U(e.position,l.SHIFT_RESTART_TIP_RADIUS,a.camera,a.pointerType),s=o.vec3.transformMat4(u.sv3d.get(),t[0],e.transform),r=1;r<t.length;r++){var n=o.vec3.transformMat4(u.sv3d.get(),t[r],e.transform),c=d.lineSegment.closestRayDistance2(d.lineSegment.fromPoints(s,n,Q),a.ray);if(null!=c&&c<i*i)return!0;s=n}return!1}function z(e,t,a){if(!e.visible)return!1;var i=o.vec3.length(t.basis1),s=o.vec3.length(t.basis2),r=G(t),n=e.position,c=U(n,l.RESIZE_HANDLE_INPUT_RADIUS,a.camera,a.pointerType);if(F(e)){var v=u.sv3d.get(),m=u.sv3d.get();C(t,e,v,m);var g=d.lineSegment.closestRayDistance2(d.lineSegment.fromPoints(n,v,Q),a.ray),f=d.lineSegment.closestRayDistance2(d.lineSegment.fromPoints(n,m,Q),a.ray);return null!=g&&g<c*c||null!=f&&f<c*c}var p=0!==e.direction[0]?1:2,b=1===p?t.basis2:t.basis1,h=1===p?s:i,P=o.vec3.scale(u.sv3d.get(),b,1-r/h),v=o.vec3.add(u.sv3d.get(),n,P),m=o.vec3.subtract(u.sv3d.get(),n,P),y=d.lineSegment.closestRayDistance2(d.lineSegment.fromPoints(v,m,Q),a.ray);return null!=y&&y<c*c}function D(e,t,a){if(!e.visible)return!1;for(var i=U(e.position,l.ROTATE_HEADING_TIP_RADIUS,a.camera,a.pointerType),s=o.vec3.transformMat4(u.sv3d.get(),t[0],e.transform),r=1;r<t.length;r++){var n=o.vec3.transformMat4(u.sv3d.get(),t[r],e.transform),c=d.lineSegment.closestRayDistance2(d.lineSegment.fromPoints(s,n,Q),a.ray);if(null!=c&&c<i*i)return!0;s=n}return!1}function U(e,t,a,i){return t*("mouse"===i?l.MOUSE_INPUT_FOCUS_MULTIPLIER:l.TOUCH_INPUT_FOCUS_MULTIPLIER)*a.computeScreenPixelSizeAt(e)}function L(e,t){return Math.abs(o.vec3.dot(t.basis1,e))>Math.abs(o.vec3.dot(t.basis2,e))?1:2}function O(e){return{basis1Positive:{position:o.vec3.add(u.sv3d.get(),e.origin,e.basis1),rotationIdx:0},basis2Positive:{position:o.vec3.add(u.sv3d.get(),e.origin,e.basis2),rotationIdx:1},basis1Negative:{position:o.vec3.subtract(u.sv3d.get(),e.origin,e.basis1),rotationIdx:2},basis2Negative:{position:o.vec3.subtract(u.sv3d.get(),e.origin,e.basis2),rotationIdx:3}}}function x(e,t,a){var i=a.projectPoint(o.vec3.add(u.sv3d.get(),e,t),s.castRenderScreenPointArray3(u.sv3d.get())),r=a.projectPoint(o.vec3.subtract(u.sv3d.get(),e,t),s.castRenderScreenPointArray3(u.sv3d.get()));return o.vec3.squaredLength(o.vec3.subtract(i,i,r))}function G(e){var t=o.vec3.length(e.basis1),a=o.vec3.length(e.basis2);return l.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(t,a)}function k(e){return G(e)}function C(e,t,a,i){o.vec3.normalize(a,e.basis1),o.vec3.scale(a,a,-t.direction[0]*t.scale),o.vec3.add(a,a,t.position),o.vec3.normalize(i,e.basis2),o.vec3.scale(i,i,-t.direction[1]*t.scale),o.vec3.add(i,i,t.position)}function F(e){return 0!==e.direction[0]&&0!==e.direction[1]}function j(e,t,a){var s=function(s){var l=(s?t:e).slice(0),d=o.vec3.subtract(u.sv3d.get(),l[0],l[1]);o.vec3.normalize(d,d);var f=o.vec3.subtract(u.sv3d.get(),l[l.length-1],l[l.length-2]);if(o.vec3.normalize(f,f),a.padding>0){var p=o.vec3.scale(v.vec3f64.create(),f,-a.padding);if(l[l.length-1]=o.vec3.add(p,p,l[l.length-1]),a.bothEnds){var b=o.vec3.scale(v.vec3f64.create(),d,-a.padding);l[0]=o.vec3.add(b,b,l[0])}}var h=s?a.tipFocusMultiplier:1,P=a.tipLength*(a.focusTipLength?h:1),y=a.tipRadius*h,R=r.mat4.identity(u.sm4d.get());if(a.padding>0){var S=P/4,I=o.vec3.set(u.sv3d.get(),0,S,0),_=1+a.padding/S;r.mat4.translate(R,R,I),r.mat4.scale(R,R,o.vec3.set(u.sv3d.get(),_,_,_)),r.mat4.translate(R,R,o.vec3.scale(I,I,-1/_))}var E=r.mat4.identity(n.mat4f64.create()),T=v.vec3f64.fromValues(0,1,0),A=r.mat4.fromQuat(n.mat4f64.create(),c.quat.rotationTo(u.sq4d.get(),T,f));A[12]=l[l.length-1][0],A[13]=l[l.length-1][1],A[14]=l[l.length-1][2],r.mat4.multiply(A,A,R);var H,N,w=new m(q(a.tubeRadius*(s?a.tubeFocusMultiplier:1)+a.padding,a.flat,l),"arrow-tube"),M=[{part:"tube",geometry:w,transform:E}];if(i.isSome(a.flat)?H=new m(g.createExtrudedTriangle(P,y,y,a.flat.thickness),"arrow-tip"):(H=new m(g.createConeGeometry(P,y,24,!1,!1,!0),"arrow-tip"),N=new m(g.createConeGeometry(P,y,24,!1,!0,!1),"arrow-cap")),M.push({part:"tip",geometry:H,transform:A}),N&&M.push({part:"cap",geometry:N,transform:A}),a.bothEnds){var z=r.mat4.fromQuat(n.mat4f64.create(),c.quat.rotationTo(u.sq4d.get(),T,d));z[12]=l[0][0],z[13]=l[0][1],z[14]=l[0][2],r.mat4.multiply(z,z,R),M.push({part:"tip",geometry:H,transform:z}),N&&M.push({part:"cap",geometry:N,transform:z})}return M};return{normal:s(!1),focused:s(!0)}}function q(e,t,a){var s=[];if(i.isSome(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else for(var r=0;r<12;r++){var n=r/12*2*Math.PI;s.push([Math.cos(n)*e,Math.sin(n)*e])}return g.createPathExtrusionGeometry(s,a,[],[],!1)}function B(e,t){var a=o.vec3.subtract(v.vec3f64.create(),e[e.length-1],e[e.length-2]);if(o.vec3.normalize(a,a),o.vec3.scale(a,a,l.ROTATE_HEADING_TIP_LENGTH),o.vec3.add(a,a,e[e.length-1]),t){var i=o.vec3.subtract(v.vec3f64.create(),e[0],e[1]);return o.vec3.normalize(i,i),o.vec3.scale(i,i,l.ROTATE_HEADING_TIP_LENGTH),o.vec3.add(i,i,e[0]),[i].concat(e,[a])}return e.concat([a])}function Z(e,t){return Math.abs(o.vec3.dot(e.plane,t))<=l.PERPENDICULAR_GROUND_DOT_THRESHOLD}function V(e){switch(e.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"point-cloud":case"scene":case"stream":case"unknown":case"unsupported":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"web-tile":case"wms":case"wmts":return!0;default:return a.neverReached(e.type),!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.createPlane=p,t.normalToBases=b,t.resizePlane=h,t.calculatePlaneHalfSize=P,t.createShiftPlane=y,t.calculateBoundedPlaneTranslateRotate=R,t.hideHandles=S,t.createRotatePlane=I,t.updateShiftRestartHandle=_,t.updateShiftRestartObject=T,t.updateResizeHandles=A,t.updateResizeHandleObjects=H,t.updateRotateHeadingHandle=N,t.updateRotateHeadingObject=w,t.intersectsShiftRestartHandle=M,t.intersectsResizeHandle=z,t.intersectsRotateHeadingHandle=D,t.calculateScreenSpaceBasisLength2=x,t.calculateResizeHandlePadding=G,t.calculateDiagonalResizeHandleScale=k,t.calculateDiagonalResizeHandleEndPositions=C,t.isDiagonalResizeHandle=F,t.createArrowGeometry=j,t.addArrowTips=B,t.isAlwaysDrapedLayer=V;var Q=d.lineSegment.create(),W=d.ray.create()});