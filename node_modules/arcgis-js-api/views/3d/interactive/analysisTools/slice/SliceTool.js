// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/clock","../../../../../core/Collection","../../../../../core/compilerUtils","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../layers/Layer","../../../../../layers/buildingSublayers/BuildingComponentSublayer","./sliceToolConfig","./sliceToolUtils","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../webgl-engine/materials/ColorMaterial","../../../webgl-engine/materials/NativeLineMaterial","../../../webgl-engine/materials/RibbonLineMaterial","../../../webgl-engine/materials/SlicePlaneMaterial","../../../webgl-engine/parts/Model","../../../../interactive/InteractiveToolBase","../../../../interactive/interactiveToolUtils","../../../../interactive/manipulatorUtils"],function(e,t,i,r,a,s,n,o,l,c,d,u,h,p,_,v,y,f,m,R,g,H,E,T,P,S,b,I,w,O,L,A,C,M,G,D){function F(e){return"mouse"!==e.pointerType||0===e.button}var k=l.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool"),z=function(e){function t(t,i){void 0===i&&(i=a.default);var r=e.call(this,t)||this;return r._clock=i,r.cursor=null,r.layersMode="none",r.excludedLayers=new s,r.disableEngineLayers=!1,r._handles=new o,r._viewHandles=new o,r._frameTask=null,r._ignoreClickEventId=null,r._prevPointerMoveTimeout=null,r._activePointerId=null,r._editingEnabled=!0,r.inputState=null,r._startPlane=E.boundedPlane.create(),r._previewPlane=null,r._activeKeyModifiers={},r._lastCursorPosition=u.createScreenPoint(),r._baseOpacity=1,r._hoveredResizeHandleIdx=null,r._isShiftRestartHandleHovered=!1,r._isRotateHeadingHandleHovered=!1,r._resizeHandles=[{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[1,0],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[1,1],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[0,1],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[-1,1],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[-1,0],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[-1,-1],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[0,-1],visible:!1},{transform:v.mat4f64.create(),position:f.vec3f64.create(),scale:1,direction:[1,-1],visible:!1}],r._shiftRestartHandle={transform:v.mat4f64.create(),position:f.vec3f64.create(),visible:!1,forceHide:!1,floating:!1},r._rotateHeadingHandle={transform:v.mat4f64.create(),position:f.vec3f64.create(),visible:!1,forceHide:!1},r._areEngineLayersCreated=!1,r._outlineResources=null,r._gridResources=null,r._shiftRestartResources=null,r._resizeHandleResources=null,r._rotateHeadingHandleResources=null,r}i(t,e),l=t,t.prototype.initialize=function(){var e=this;this._handles.add([h.init(this,"state",function(){"slicing"===e.state?G.setActive(e,!0):"sliced"===e.state&&G.setActive(e,!1)},!0),this.excludedLayers.on("before-add",function(t){var i=t.item;null!=i&&(i instanceof m||i instanceof R)?i instanceof m&&H.isAlwaysDrapedLayer(i)?(k.error("excludedLayers","Layer '"+i.title+", id:"+i.id+"' of type '"+i.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),t.preventDefault()):e.excludedLayers.includes(i)&&t.preventDefault():(k.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})])},t.prototype.destroy=function(){this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout()},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plane",{set:function(e){this._set("plane",e),this.visible&&(this._updateLayerViews(),this.view.slicePlane=e,this._updateEngineLayers(),e&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"excludeGroundSurface",{set:function(e){this._set("excludeGroundSurface",e),this._updateLayerViews()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),this._updateEngineLayers()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_internallyEditable",{get:function(){return this.editable&&this._editingEnabled&&"none"===this.layersMode},enumerable:!0,configurable:!0}),t.prototype.show=function(){var e=this;this._createEngineLayers(),this._updateEngineLayers(),this._updateMouseCursor(),this._updateLayerViews();var t=this.view;t.slicePlane=this.plane,0===this._viewHandles.size&&(this.disableEngineLayers||this._viewHandles.add(t.state.watch("camera",function(){e._updateEngineLayers(),e._updateMouseCursor()})),this._viewHandles.add([t.allLayerViews.on("change",function(){e._updateLayerViews()}),this.excludedLayers.on("change",function(t){e._updateLayerViews()})]))},t.prototype.hide=function(){this._removeEngineLayers(),this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()},t.prototype.newSlice=function(){this._reset(),this._unsetOtherToolPlanes(),G.setActive(this,!0)},t.prototype.clearSlice=function(){this._reset()},t.prototype.enterExcludeLayerMode=function(){this._set("layersMode","exclude"),G.setActive(this,!0)},t.prototype.exitExcludeLayerMode=function(){this._set("layersMode","none"),G.setActive(this,!1)},t.prototype.deactivate=function(){this._updateMouseCursor(!1),this._set("layersMode","none"),"sliced"!==this.state&&(this.plane=null),this._updatePreviewPlane(null)},t.prototype.disableEditing=function(){this._editingEnabled=!1,this._updateEngineLayers()},t.prototype.enableEditing=function(){this._editingEnabled=!0,this._updateEngineLayers()},t.prototype.onDetach=function(){this._reset()},t.prototype.onInputEvent=function(e){switch(e.type){case"pointer-down":if(!this._shouldHandlePointerEvent(e))return;this._onPointerDown(e)&&e.stopPropagation(),this._activePointerId=e.pointerId;break;case"pointer-drag":if(!this._shouldHandlePointerEvent(e))return;this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e)&&e.stopPropagation(),this._updateMouseCursor();break;case"pointer-up":if(!this._shouldHandlePointerEvent(e))return;this._onPointerUp(e)&&e.stopPropagation(),this._activePointerId=null;break;case"click":if(!F(e))return;this._onClick(e)&&e.stopPropagation();break;case"double-click":if(!F(e))return;this._onDoubleClick(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}},t.prototype._reset=function(){this.plane=null,this._set("layersMode","none")},t.prototype._createEngineLayers=function(){var e=this;if(!this._areEngineLayersCreated&&!this.disableEngineLayers){this._areEngineLayersCreated=!0;var t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]],i=new P(S.createPolylineGeometry(t),"slice-outline"),r=g.PLANE_OUTLINE_COLOR.slice(),a=new L({color:r,writeDepth:!1,width:g.PLANE_OUTLINE_WIDTH},"slice-outline");a.renderOccluded=4;var s=new b("slice-outline",{isPickable:!1}),n=new I({idHint:"slice-outline"}),o=function(t){n.removeAllGeometries(),t&&(r[3]=g.PLANE_OUTLINE_COLOR[3]*e._baseOpacity,a.setParameterValues({color:r}),n.addGeometry(i,a,t))};s.addObject(n),this._outlineResources={layer:s,objects:[n],materials:[a],resetGeometry:o},this._addResourcesToStage(this._outlineResources);var l=new P(S.createSquareGeometry(),"slice-grid"),c=g.PLANE_BACKGROUND_COLOR.slice(),d=new A({backgroundColor:c,gridColor:g.GRID_COLOR,gridWidth:4},"slice-grid");d.renderOccluded=4;var s=new b("slice-grid",{isPickable:!1}),u=new I({idHint:"slice-grid"}),h=[0,0,0,0],o=function(t){if(u.removeAllGeometries(),t){c[3]=g.PLANE_BACKGROUND_COLOR[3]*e._baseOpacity;var i=e.inputState&&"resize"===e.inputState.type,r=i?g.GRID_COLOR:h;d.setParameterValues({backgroundColor:c,gridColor:r}),u.addGeometry(l,d,t)}};s.addObject(u),this._gridResources={layer:s,objects:[u],materials:[d],resetGeometry:o},this._addResourcesToStage(this._gridResources);var p=[f.vec3f64.fromValues(0,0,-g.SHIFT_RESTART_ARROW_LENGTH/2),f.vec3f64.fromValues(0,0,g.SHIFT_RESTART_ARROW_LENGTH/2)],y=H.addArrowTips(p,!0),m=function(e,t){return H.createArrowGeometry(p,p,{tubeRadius:g.SHIFT_RESTART_TUBE_RADIUS,tipRadius:g.SHIFT_RESTART_TIP_RADIUS,tipLength:g.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:g.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:g.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t})},R=m(0,!1),E=m(g.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),T=new w({color:g.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:"back"},"slice-shift");T.renderOccluded=8;var C=new w({color:g.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:"back"},"slice-shift");C.renderOccluded=8;var M=new w({color:g.SHIFT_RESTART_TUBE_COLOR,cullFace:"back"},"slice-shift");M.renderOccluded=8;var G=new w({color:g.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:"front"},"slice-shift");G.renderOccluded=2;var D=new P(S.createPolylineGeometry([[0,0,0],[-g.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),F=new P(S.createPolylineGeometry([[0,0,0],[-g.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),k=new O({color:g.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");k.renderOccluded=4;var z=new I({idHint:"slice-shift"}),s=new b("slice-shift",{isPickable:!1}),N=v.mat4f64.create(),o=function(t,i){z.removeAllGeometries(),t&&(i?(R.focused.forEach(function(e){var i=e.part,r=e.geometry,a=e.transform,s="tip"===i?T:"cap"===i?C:M;z.addGeometry(r,s,_.mat4.multiply(N,t,a))}),E.focused.forEach(function(e){var i=e.geometry,r=e.transform;z.addGeometry(i,G,_.mat4.multiply(N,t,r))}),e._shiftRestartHandle.floating||z.addGeometry(F,k,t)):(R.normal.forEach(function(e){var i=e.part,r=e.geometry,a=e.transform,s="tip"===i?T:"cap"===i?C:M;z.addGeometry(r,s,_.mat4.multiply(N,t,a))}),E.normal.forEach(function(e){var i=e.geometry,r=e.transform;z.addGeometry(i,G,_.mat4.multiply(N,t,r))}),e._shiftRestartHandle.floating||z.addGeometry(D,k,t)))};s.addObject(z),this._shiftRestartResources={layer:s,objects:[z],materials:[T,M,G],intersectPath:y,resetGeometry:o},this._addResourcesToStage(this._shiftRestartResources);var t=[[1,0,0],[0,0,0],[0,1,0]],U=new P(S.createPolylineGeometry(t),"slice-resize"),x=new P(S.createPolylineGeometry([[1,0,0],[-1,0,0]]),"slice-resize"),s=new b("slice-resize",{isPickable:!1}),V=this._resizeHandles.map(function(){return new I({idHint:"slice-resize"})}),j=g.HANDLE_COLOR.concat([1]),B=this._resizeHandles.map(function(e){var t=H.isDiagonalResizeHandle(e),i=new L({color:j,width:t?g.RESIZE_HANDLE_CORNER_WIDTH:g.RESIZE_HANDLE_EDGE_WIDTH},"slice-resize");return i.renderOccluded=4,i}),W=new O({color:j},"slice-resize");W.renderOccluded=4;for(var K=V.map(function(t,i){return function(r,a){if(t.removeAllGeometries(),r){var s=H.isDiagonalResizeHandle(e._resizeHandles[i]),n=s?U:x,o=(s?g.RESIZE_HANDLE_CORNER_WIDTH:g.RESIZE_HANDLE_EDGE_WIDTH)*(a?g.DISPLAY_FOCUS_MULTIPLIER:1);if(1===o)t.addGeometry(n,W,r);else{var l=B[i];l.setParameterValues({width:o}),t.addGeometry(n,l,r)}}}}),Z=0,Y=V;Z<Y.length;Z++){var q=Y[Z];s.addObject(q)}this._resizeHandleResources={layer:s,objects:V,materials:B.concat([W]),resetGeometries:K},this._addResourcesToStage(this._resizeHandleResources);var J=.1*Math.PI,Q=1.7*Math.PI,X=g.ROTATE_HEADING_DISC_RADIUS,$=X*g.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,ee=g.ROTATE_HEADING_DISC_ARROW_RADIUS,te=g.ROTATE_HEADING_DISC_ARROW_RADIUS*g.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,ie=g.ROTATE_HEADING_OFFSET_DISTANCE,re=function(e){for(var t=[],i=0;i<32;i++){var r=Math.PI+J+(Q-J)*i/31;t.push(f.vec3f64.fromValues(ie+e*Math.cos(r),e*Math.sin(r),0))}return t},ae=re(ee),se=re(te),y=H.addArrowTips(ae,!1),ne=H.createArrowGeometry(ae,se,{tubeRadius:g.ROTATE_HEADING_TUBE_RADIUS,tipRadius:g.ROTATE_HEADING_TIP_RADIUS,tipLength:g.ROTATE_HEADING_TIP_LENGTH,tubeFocusMultiplier:g.ROTATE_HEADING_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:g.ROTATE_HEADING_TIP_FOCUS_MULTIPLIER,padding:0,bothEnds:!1,flat:{thickness:2},focusTipLength:!0,addCap:!0}),oe=new w({color:g.ROTATE_HEADING_ARROW_COLOR,cullFace:"back"},"slice-rotate-heading");oe.renderOccluded=8;var le=new P(S.createPolylineGeometry([[0,0,0],[ie-X,0,0]]),"slice-rotate-heading"),ce=new P(S.createPolylineGeometry([[0,0,0],[ie-$,0,0]]),"slice-rotate-heading"),de=new O({color:g.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");de.renderOccluded=4;var ue=f.vec3f64.fromValues(0,0,1),he=f.vec3f64.fromValues(ie,0,0),pe=new P(S.createCylinderGeometry(1,X,32,ue,he),"slice-rotate-heading"),_e=new P(S.createCylinderGeometry(1,$,32,ue,he),"slice-rotate-heading"),ve=new w({color:g.ROTATE_HEADING_DISC_COLOR,transparent:!0,writeDepth:!1,cullFace:"back"},"slice-rotate-heading");ve.renderOccluded=8;var s=new b("slice-rotate-heading",{isPickable:!1}),ye=new I({idHint:"slice-rotate-heading"}),fe=v.mat4f64.create(),o=function(e,t){ye.removeAllGeometries(),e&&(t?(ne.focused.forEach(function(t){var i=t.geometry,r=t.transform;ye.addGeometry(i,oe,_.mat4.multiply(fe,e,r))}),ye.addGeometry(ce,de,e),ye.addGeometry(_e,ve,e)):(ne.normal.forEach(function(t){var i=t.geometry,r=t.transform;ye.addGeometry(i,oe,_.mat4.multiply(fe,e,r))}),ye.addGeometry(le,de,e),ye.addGeometry(pe,ve,e)))};s.addObject(ye),this._rotateHeadingHandleResources={layer:s,objects:[ye],materials:[oe,de,ve],intersectPath:y,resetGeometry:o},this._addResourcesToStage(this._rotateHeadingHandleResources)}},t.prototype._updateEngineLayers=function(){if(this._areEngineLayersCreated){this._outlineResources.resetGeometry(),this._gridResources.resetGeometry(),this._shiftRestartResources.resetGeometry(),this._resizeHandleResources.resetGeometries.forEach(function(e){return e()}),this._rotateHeadingHandleResources.resetGeometry(),H.hideHandles(this._shiftRestartHandle,this._rotateHeadingHandle,this._resizeHandles);var e=this.plane||c.isSome(this._previewPlane)&&this._previewPlane,t=e===this._previewPlane;if(e){var i=H.calculateBoundedPlaneTranslateRotate(e,x),r=y.vec3.set(T.sv3d.get(),y.vec3.length(e.basis1),y.vec3.length(e.basis2),1);_.mat4.fromScaling(V,r);var a=_.mat4.multiply(V,i,V),s=this.view._stage.getCamera(),n=H.calculateScreenSpaceBasisLength2(e.origin,e.basis1,s),o=H.calculateScreenSpaceBasisLength2(e.origin,e.basis2,s),l=Math.max(n,o);if(this._gridResources.resetGeometry(a),t)return void this._outlineResources.resetGeometry(a);this._internallyEditable&&l>g.SHIFT_MIN_BASIS_SCREEN_LEN2&&(H.updateShiftRestartHandle(this._shiftRestartHandle,i,e,this.view.renderCoordsHelper,s),H.updateShiftRestartObject(this._shiftRestartResources.resetGeometry,this._shiftRestartHandle,this._isShiftRestartHandleFocused())),this._internallyEditable&&l>g.PLANE_MIN_BASIS_SCREEN_LEN2?(H.updateResizeHandles(i,e,this._resizeHandles),H.updateResizeHandleObjects(this._resizeHandleResources.resetGeometries,this._resizeHandles,this._focusedResizeHandleIdx())):this._outlineResources.resetGeometry(a),this._internallyEditable&&l>g.ROTATE_MIN_BASIS_SCREEN_LEN2&&(H.updateRotateHeadingHandle(i,e,this.view.renderCoordsHelper,s,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused()),H.updateRotateHeadingObject(this._rotateHeadingHandleResources.resetGeometry,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused()))}}},t.prototype._removeEngineLayers=function(){this._areEngineLayersCreated&&(this._areEngineLayersCreated=!1,this._removeResourcesFromStage(this._outlineResources),this._outlineResources=null,this._removeResourcesFromStage(this._gridResources),this._gridResources=null,this._removeResourcesFromStage(this._shiftRestartResources),this._shiftRestartResources=null,this._removeResourcesFromStage(this._resizeHandleResources),this._resizeHandleResources=null,this._removeResourcesFromStage(this._rotateHeadingHandleResources),this._rotateHeadingHandleResources=null)},t.prototype._updateLayerViews=function(){var e=this.view.tools.some(function(e){return e instanceof l&&!!e.plane}),t=[],i=function(e){"layers"in e?e.layers.forEach(i):t.push(e)};this.excludedLayers.forEach(i),this.view.allLayerViews.forEach(function(i){"slicePlaneEnabled"in i&&(i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0),"componentLayerViews"in i&&i.componentLayerViews.forEach(function(i){i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0})}),this.view.basemapTerrain.slicePlaneEnabled=e&&!this.excludeGroundSurface},t.prototype._onPointerDown=function(e){var t=this;if("exclude"===this.layersMode||!this._internallyEditable)return!1;var i=!1,r=this.view._stage.getCamera(),a=this._calculatePickRay(u.createScreenPointFromEvent(e)),s=function(e,t,i){var r=H.createShiftPlane(t,i.plane,a.direction,E.plane.create()),s=f.vec3f64.create();return E.plane.intersectRay(r,a,s),{type:"shift",creating:e,shiftPlane:r,depth:0,startPoint:s}};if(this.plane)if(H.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:r,pointerType:e.pointerType,ray:a}))E.boundedPlane.copy(this.plane,this._startPlane),this.inputState=s(!1,this._shiftRestartHandle.position,this.plane),i=!0;else if(H.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:r,pointerType:e.pointerType,ray:a})){var n=H.createRotatePlane(this.plane,this.view.renderCoordsHelper,E.plane.create()),o=f.vec3f64.create();E.plane.intersectRay(n,a,o)&&(E.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate-heading",rotatePlane:n,startPoint:o},i=!0)}else{for(var l=function(i,s){if(H.intersectsResizeHandle(i,t.plane,{camera:r,pointerType:e.pointerType,ray:a})){var n=T.sv3d.get();if(E.plane.intersectRay(t.plane.plane,a,n))return E.boundedPlane.copy(t.plane,t._startPlane),t.inputState={type:"resize",activeHandleIdx:s,startPoint:f.vec3f64.clone(n)},!0}return!1},c=0;c<this._resizeHandles.length&&!i;c++){var d=this._resizeHandles[c];H.isDiagonalResizeHandle(d)&&l(d,c)&&(i=!0)}for(var c=0;c<this._resizeHandles.length&&!i;c++){var d=this._resizeHandles[c];!H.isDiagonalResizeHandle(d)&&l(d,c)&&(i=!0)}}if(!i&&!this.inputState&&!this.plane&&this.active){var h=this.plane||E.boundedPlane.create();this._pickPlane(u.createScreenPointFromEvent(e),!1,this._activeKeyModifiers,h)&&(E.boundedPlane.copy(h,this._startPlane),this.inputState=s(!0,h.origin,h),this.plane=h,i=!0)}return i&&this._updateMouseCursor(),i},t.prototype._onPointerDrag=function(e){var t=this.inputState;if(!t)return!1;if(!this.plane)return!1;if("end"===e.action)return this._finishInput(e);var i=this._calculatePickRay(u.createScreenPointFromEvent(e)),r=this.view._stage.getCamera();switch(t.type){case"shift":if(E.plane.intersectRay(t.shiftPlane,i,N)){var a=Math.min((1-Math.abs(y.vec3.dot(this.plane.plane,i.direction)))/.001,1),s=-E.plane.signedDistance(this._startPlane.plane,N),o=-E.plane.signedDistance(this._startPlane.plane,t.startPoint);t.depth=t.depth*(1-a)+s*a-o,y.vec3.copy(U,this._startPlane.origin);var l=y.vec3.copy(T.sv3d.get(),this._startPlane.plane);y.vec3.scale(l,l,-t.depth),y.vec3.add(l,l,U),E.boundedPlane.fromValues(l,this.plane.basis1,this.plane.basis2,this.plane),this.plane=this.plane}break;case"resize":var c=T.sv3d.get();if(E.plane.intersectRay(this.plane.plane,i,c)){var d=this._resizeHandles[t.activeHandleIdx];this.plane=H.resizePlane(d,t.startPoint,c,r,this._startPlane,this.plane)}break;case"rotate-heading":var h=T.sm4d.get(),c=T.sv3d.get();if(E.plane.intersectRay(t.rotatePlane,i,c)){var p=t.rotatePlane,v=D.calculateInputRotationTransform(t.startPoint,c,this.plane.origin,p);_.mat4.rotate(h,_.mat4.identity(h),v,p);var f=y.vec3.transformMat4(T.sv3d.get(),this._startPlane.basis1,h),m=y.vec3.transformMat4(T.sv3d.get(),this._startPlane.basis2,h);E.boundedPlane.fromValues(this.plane.origin,f,m,this.plane),this.plane=this.plane}break;default:n.neverReached(t)}return!0},t.prototype._onPointerMove=function(e){return this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,(this._shiftRestartHandle.forceHide||this._rotateHeadingHandle.forceHide)&&(this._shiftRestartHandle.forceHide=!1,this._rotateHeadingHandle.forceHide=!1,this._updateEngineLayers()),this._resetPointerMoveTimeout(),"touch"!==e.pointerType&&(this._updatePreviewPlane(u.createScreenPointFromEvent(e),this._activeKeyModifiers),!!this.plane&&(!!this._internallyEditable&&(this._updateHovered(e)&&(this._updateEngineLayers(),this._updateMouseCursor()),null!=this._hoveredResizeHandleIdx||this._isShiftRestartHandleHovered||this._isRotateHeadingHandleHovered)))},t.prototype._onPointerUp=function(e){return!!this._finishInput(e)&&(this._ignoreClickEventId=e.eventId,!0)},t.prototype._onClick=function(e){var t=this;return"exclude"===this.layersMode?(this.view.hitTest(u.createScreenPointFromEvent(e)).then(function(e){if(e.results.length){var i=e.results[0],r=i&&i.graphic;if(r){var a=r.sourceLayer||r.layer;a&&t.excludedLayers.push(a)}}else t.excludeGroundSurface=!0}),this._set("layersMode","none"),G.setActive(this,!1),!0):!!this.inputState||this._ignoreClickEventId===e.eventId},t.prototype._onDoubleClick=function(e){return this._ignoreClickEventId===e.eventId},t.prototype._onKeyDown=function(e){return"Escape"===e.key&&this.plane&&this.active?(this.plane=null,!0):(e.key===g.forceVerticalModifier||e.key===g.forceHorizontalModifier)&&(this._activeKeyModifiers[e.key]=!0,c.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onKeyUp=function(e){return!(e.key!==g.forceVerticalModifier&&e.key!==g.forceHorizontalModifier||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],c.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._finishInput=function(e){var t=this.inputState;return this.inputState=null,!(!t||!this.plane)&&(E.boundedPlane.copy(this.plane,this._startPlane),this._updateHovered(e),this._updateEngineLayers(),this._updateMouseCursor(),!0)},t.prototype._updatePreviewPlane=function(e,t){var i=this;void 0===t&&(t={});var r=this._previewPlane;if(this._previewPlane=null,c.isNone(e))return void this._removeFrameTask();if(!this.plane&&this.active){var a=c.isSome(r)?r:E.boundedPlane.create();if(r=c.isSome(r)?E.boundedPlane.copy(r,j):null,this._pickPlane(e,!0,t,a)){var s=g.PREVIEW_FADE_DOT_THRESHOLD,n=!1;c.isSome(r)&&(n=y.vec3.dot(r.plane,a.plane)<s||y.vec3.dot(y.vec3.normalize(T.sv3d.get(),r.basis1),y.vec3.normalize(T.sv3d.get(),a.basis1))<s),n&&(this._baseOpacity=0),this._previewPlane=a}}c.isSome(this._previewPlane)&&c.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=d.addFrameTask({update:function(e){var t=e.deltaTime;i._baseOpacity=Math.min(i._baseOpacity+t/(1e3*g.PREVIEW_FADE_DURATION_SECONDS),1),i._updateEngineLayers(),1===i._baseOpacity&&i._removeFrameTask()}}):c.isNone(this._frameTask)&&(this._updateEngineLayers(),this._removeFrameTask())},t.prototype._removeFrameTask=function(){c.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)},t.prototype._updateHovered=function(e){var t=this,i=this._hoveredResizeHandleIdx,r=this._isShiftRestartHandleHovered,a=this._isRotateHeadingHandleHovered;this._hoveredResizeHandleIdx=null,this._isShiftRestartHandleHovered=!1,this._isRotateHeadingHandleHovered=!1;var s=e.pointerType,n=function(){return!t._isAnyHandleFocused()&&"touch"!==s},o=this._calculatePickRay(u.createScreenPointFromEvent(e)),l=this.view._stage.getCamera();if(n()&&(this._isShiftRestartHandleHovered=H.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:l,pointerType:s,ray:o})),n()&&(this._isRotateHeadingHandleHovered=H.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:l,pointerType:s,ray:o})),n())for(var c=0;c<this._resizeHandles.length;c++){var d=this._resizeHandles[c];if(H.intersectsResizeHandle(d,this.plane,{camera:l,pointerType:s,ray:o})){this._hoveredResizeHandleIdx=c;break}}return this._hoveredResizeHandleIdx!==i||this._isShiftRestartHandleHovered!==r||this._isRotateHeadingHandleHovered!==a},t.prototype._focusedResizeHandleIdx=function(){return this.inputState&&"resize"===this.inputState.type?this.inputState.activeHandleIdx:this._hoveredResizeHandleIdx},t.prototype._isShiftRestartHandleFocused=function(){return!(!this.inputState||"shift"!==this.inputState.type)||this._isShiftRestartHandleHovered},t.prototype._isRotateHeadingHandleFocused=function(){return!(!this.inputState||"rotate-heading"!==this.inputState.type)||this._isRotateHeadingHandleHovered},t.prototype._calculatePickRay=function(e){var t=E.ray.create(),i=u.screenPointObjectToArray(e,B);return E.ray.fromScreen(this.view.state.camera,i,t),y.vec3.normalize(t.direction,t.direction),t},t.prototype._pickIntersector=function(e){var t=u.screenPointObjectToArray(e,T.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t)},t.prototype._pickPlane=function(e,t,i,r){var a=this._pickIntersector(e).results.min,s=T.sv3d.get();if(!a.getIntersectionPoint(s))return!1;var n=a.getTransformedNormal(T.sv3d.get()),o=this.view._stage.getCamera();y.vec3.dot(n,o.viewForward)>0&&y.vec3.scale(n,n,-1);var l=H.calculatePlaneHalfSize(s,o),c=(t?1:-1)*l*g.INITIAL_DEPTH_OFFSET_FRAC,d=y.vec3.scale(T.sv3d.get(),n,c);y.vec3.add(d,d,s);var u=i[g.forceVerticalModifier]?"vertical":i[g.forceHorizontalModifier]?"horizontal":null;return H.createPlane(d,n,0,l,l,o,u,this.view.renderCoordsHelper,r),!0},t.prototype._addResourcesToStage=function(e){var t=this;e.materials.forEach(function(e){return t.view._stage.add(C.ContentType.MATERIAL,e)}),e.objects.forEach(function(e){return t.view._stage.add(C.ContentType.OBJECT,e)}),this.view._stage.add(C.ContentType.LAYER,e.layer),this.view._stage.addToViewContent([e.layer.id])},t.prototype._removeResourcesFromStage=function(e){var t=this;this.view._stage.remove(C.ContentType.LAYER,e.layer.id),this.view._stage.removeFromViewContent([e.layer.id]),e.objects.forEach(function(e){return t.view._stage.remove(C.ContentType.OBJECT,e.id)}),e.materials.forEach(function(e){return t.view._stage.remove(C.ContentType.MATERIAL,e.id)})},t.prototype._updateMouseCursor=function(e){void 0===e&&(e=this.active),this._set("cursor",null),this._isAnyHandleFocused()?this._set("cursor","slicing"===this.state?"grabbing":"pointer"):e&&this._set("cursor","crosshair")},t.prototype._isAnyHandleFocused=function(){return null!=this._focusedResizeHandleIdx()||this._isShiftRestartHandleFocused()||this._isRotateHeadingHandleFocused()},t.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)},t.prototype._resetPointerMoveTimeout=function(){var e=this;this._clearPointerMoveTimeout(),this._prevPointerMoveTimeout=this._clock.setTimeout(function(){e._shiftRestartHandle.forceHide=!0,e._isShiftRestartHandleHovered=!1,e._rotateHeadingHandle.forceHide=!0,e._isRotateHeadingHandleHovered=!1,e._updateEngineLayers(),e._updateMouseCursor()},g.POINTER_MOVE_TIMER_MS)},t.prototype._shouldHandlePointerEvent=function(e){return F(e)&&(c.isNone(this._activePointerId)||this._activePointerId===e.pointerId)},t.prototype._unsetOtherToolPlanes=function(){var e=this;this.view.tools.forEach(function(t){t!==e&&t instanceof l&&(t._set("plane",null),t._updateEngineLayers())})};var l;return r([p.property({constructOnly:!0})],t.prototype,"view",void 0),r([p.property({dependsOn:["plane","inputState"],readOnly:!0})],t.prototype,"state",null),r([p.property({dependsOn:["view.type"],readOnly:!0})],t.prototype,"isSupported",null),r([p.property({readOnly:!0})],t.prototype,"cursor",void 0),r([p.property({value:null})],t.prototype,"plane",null),r([p.property({readOnly:!0})],t.prototype,"layersMode",void 0),r([p.property({readOnly:!0})],t.prototype,"excludedLayers",void 0),r([p.property({type:Boolean,value:!1})],t.prototype,"excludeGroundSurface",null),r([p.property({value:!0})],t.prototype,"editable",null),r([p.property()],t.prototype,"inputState",void 0),t=l=r([p.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],t)}(p.declared(M)),N=f.vec3f64.create(),U=f.vec3f64.create(),x=v.mat4f64.create(),V=v.mat4f64.create(),j=E.boundedPlane.create(),B=u.createScreenPointArray();return z});