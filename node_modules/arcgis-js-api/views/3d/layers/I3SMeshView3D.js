// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/errors/CancelError","../../../Color","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/Collection","../../../core/Evented","../../../core/HandleOwner","../../../core/has","../../../core/iteratorUtils","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/requireUtils","../../../core/scheduling","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../layers/graphics/controllers/I3SOnDemandController","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SProjectionUtil","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/edgeUtils","./support/layerViewUpdatingProperties","./support/symbolColorUtils","../support/mathUtils","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../webgl-engine/Stage","../webgl-engine/lib/Geometry","../webgl-engine/lib/Layer","../webgl-engine/lib/Object3D","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Texture","../webgl-engine/lib/Util","../webgl-engine/lib/TextureBackedBuffer/BufferManager","../webgl-engine/materials/component/index","module"],function(e,t,r,n,i,o,a,s,l,d,c,u,h,p,g,f,y,m,_,b,v,C,I,O,x,w,M,S,E,D,T,j,R,V,A,P,G,F,N,B,U,L,k,H,q,K,z,J,W,Y,X,Q,Z,$,ee,te,re,ne,ie,oe,ae){function se(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.i3sTexId===t)return i.data}return null}function le(e){return x.isArrayBuffer(e.data)}function de(e,t){for(var r=1024,n=0,i=e;n<i.length;n++){var o=i[n];r+=o.interleavedVertexData.byteLength+(o.indices?o.indices.byteLength:0),r+=o.positionData.data.byteLength+o.positionData.indices.byteLength}for(var a=0,s=t;a<s.length;a++){var l=s[a];x.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function ce(e,t){return!(t.byteSize>_e)||(pe.warn("Node is too big to store in IndexedDB cache: "+e.baseUrl+" ("+t.byteSize+" bytes)"),!1)}function ue(e,t){return(0|e)+(0|t)|0}Object.defineProperty(t,"__esModule",{value:!0});var he=Q.ModelContentType,pe=_.getLogger("esri.views.3d.layers.SceneLayerView3D"),ge=[1,1,1,1],fe=[.8,.8,.8],ye=function(){function e(){}return e}(),me=11,_e=104857600,be=function(t){function l(){var e=null!==t&&t.apply(this,arguments)||this;return e._layerUid="",e._highlights=new N(e),e._elevationProvider=null,e._worker=new G,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new k.IDBCache("esri-scenelayer-cache","geometries",me),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._cacheKeySuffix=null,e._tmpAttributeOnlyGraphic=new d(null,null,{}),e}return n(l,t),Object.defineProperty(l.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"rendererNeedsTextures",{get:function(){return L.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=w.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=P.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!f("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),l.prototype.initialize=function(){var t=this;if(S.open(I.getAbsMid("./SceneLayerWorker",e,ae)).then(function(e){t.destroyed?e.close():t._workerThread=e}),L.checkSceneLayerValid(this.layer),L.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUid=this.layer.uid,this._controller=new V({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.view.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new B({layerView:this,stageLayer:this._stageLayer}),this.handles.add([M.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),M.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),M.watch(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),M.watch(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),M.init(this,"filter",function(){return t._filterChange()}),M.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){t._reloadAll(),t._memCache.clear()}),M.init(this,"suspended",function(e){return t._suspendedChange(e)})],"sceneLayerHandles"),f("disable-feature:single-idb-cache")&&(this._idbCache=new k.IDBCache("esri-scenelayer-cache-v"+me,"geometries",me)),this._idbCache.init().catch(function(e){pe.warn("Failed to initialize IndexedDB cache: "+e)}),this._cacheKeySuffix=L.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._componentColorManager=this._hasSymbolColors?new ie.BufferManager(this._stage.view.renderingContext):null},l.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},l.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},l.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},l.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},l.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},l.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e.id)},l.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},l.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},l.prototype.ignoresMemoryFactor=function(){return!1},l.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)},l.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},l.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;var n=""+this.layer.uid,i=new $(n,{},n);this._stageLayer=i,e.add(he.LAYER,i),this._stage.addToViewContent([i.id])},l.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;this._removeAllNodeDataFromStage(),ne.verify(0===this._nodeId2Meta.size),e.remove(he.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},l.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e.id);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},l.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e.id);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},l.prototype.setAttributeData=function(e,t){var r=this._nodeId2Meta.get(e.id);r&&(r.attributeInfo=t,r.cachedRendererVersion=this._getInvalidRendererVersion(),r.filteredIds=null,this._updateEngineObject(r))},l.prototype.getLoadedNodeIDs=function(){return c.keysOfMap(this._nodeId2Meta)},l.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){if(this._isIntegratedMesh)return{forceTransparency:!1};var n=this.fullOpacity,i=1-J.clamp(ne.fallbackIfUndefined(t.transparency,0),0,1);return{baseColorOpacity:i,layerOpacity:n,forceTransparency:!!(i<1||n<1||e&&m.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r)}},l.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},l.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},l.prototype._getMaterialParameters=function(e,t,n){var i=t.params,o=ne.fallbackIfUndefined(i.diffuse,fe);"standard"!==t.type&&pe.warn("Unknown material type '"+t.type+"', must be 'standard'");var a=this._isIntegratedMesh,s=this._calcEngineMaterialTransparencyParams(e,i);return r({baseColor:o,baseColorTexture:n,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(i),cullFace:this._calcEngineMaterialCullFaceParams(i),writeStencil:a,receiveSSAO:!a,normals:a?"ground":"vertex"},s)},l.prototype._getGeometryParameters=function(e,t){return{textureCoordinates:null!=e,textureCoordinateRegions:t.params.vertexRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":"compressed"}},l.prototype._createTexture=function(e,t,r,n,i){if(null==t)return null;var o=se(n,r);if(null==o)return null;var a,s=null==t?null:this._getI3STexEncoding(t),l="none"!==t.wrap[0]||"none"!==t.wrap[1],d="rgba"===t.channels,c=!0;if(s===L.DDS_ENCODING_STRING)a=re.DDS_ENCODING;else{var u=o;c=J.isPowerOfTwo(u.width)&&J.isPowerOfTwo(u.height)}var h=i||!0===t.atlas,p=(h?this._enableAtlasMipMaps:this._enableMipMaps)&&c,g=h||!l,f=h&&p&&this._disableAtlasAnisotropy,y=g?{s:33071,t:33071}:{s:10497,t:10497},m={mipmap:p,wrap:y,disableAnisotropy:f,encoding:a,noUnpackFlip:!0,components:d?4:3},_=new re(o,r,m);return this._stage.add(he.TEXTURE,_),e.memory+=this.memEstimateTextureAdded(_),_},l.prototype._createEngineMaterial=function(e,t,r,n,i,o){var a=n.params.vertexRegions,s=null!=t?this._createTexture(e,t,r,o,a):null,l=this._getMaterialParameters(t,n,s&&s.id),d=this._getGeometryParameters(t,n),c=oe.ComponentMaterial.create(l,d,i);return c.metadata={i3sTex:t,i3sMatParams:n.params,engineTex:s},c},l.prototype._getI3STexEncoding=function(e){var t=L.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures);return t>-1?e.encoding[t]:e.encoding},l.prototype._getVertexBufferLayout=function(e,t){var r=e.params.materialID,n=t.materialDefinitions[r];ne.assert(void 0!==n,"geometry wants unknown material "+r);var i,o=e.params.textureID||"none";return"none"!==o&&(null!=t.textureDefinitions&&null!=t.textureDefinitions[o]||pe.warn("textureDefinitions missing in shared resource"),i=t.textureDefinitions[o]),X.glLayout(oe.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(i,n)))},l.prototype._createEngineMat=function(e,t,r,n){var i=t.params.materialID,o=r.materialDefinitions[i];ne.assert(void 0!==o,"geometry wants unknown material "+i);var a,s=t.params.textureID||"none";return"none"!==s&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[s]||pe.warn("textureDefinitions missing in shared resource"),a=r.textureDefinitions[s]),this._createEngineMaterial(e,a,s,o,i,n)},l.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},l.prototype._findGraphicNodeAndIndex=function(e){var t=H.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return y.everyMap(this._nodeId2Meta,function(e,n){var i=e.featureIds.indexOf(t);return-1===i||(r={node:e.node,index:i},!1)}),r},l.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.id);if(!r)return[];for(var n=[],i=this._getObjectIdField(),o=0,a=t;o<a.length;o++){var s=a[o],l=H.attributeLookup(s.attributes,i),d=r.featureIds.indexOf(l);-1!==d&&n.push(d)}return n},l.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return C.reject();var r=this._nodeId2Meta.get(t.node.id).engineObject,n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(Y.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var i=R.empty();return R.expandWithBuffer(i,n,0,8),C.resolve({boundingBox:i,screenSpaceObjects:[]})}},l.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(e){for(var t=new Map,n=[],i=0,o=e;i<o.length;i++){var a=o[i],s=r._findGraphicNodeAndIndex(a),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},n.push(l)),l.indices.push(s.index),l.graphics.push(a)}return n};return L.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0})},l.prototype.getGraphicFromStageObject=function(e,t){if(this._isIntegratedMesh)return null;var r=this._getMetadata(e),n=e.getComponentFromTriangleNr(0,t);if(null!=n&&null!=r.featureIds&&n<r.featureIds.length){return this._createGraphic(n,r)}return null},l.prototype.hasStageObject=function(e){var t=e.getMetadata(),r=this._nodeId2Meta.get(t.i3sNode);return r&&r.engineObject===e},l.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.i3sNode)},l.prototype._getCacheKey=function(e){return e.baseUrl+this._cacheKeySuffix},l.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},l.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},l.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=ue(this._cancelCount,1)},l.prototype._handleCancelled=function(e){if(ue(this._cancelCount,-e)>0)throw new s},l.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.id))},l.prototype.loadCachedNodeData=function(e,t){var r=this,n=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(i){if(null==i)return null;if(r._handleCancelled(n),i.nodeVersion!==e.version)return r._idbCache.remove(r._getCacheKey(e)),null;e.obb||(e.obb=W.clone(i.nodeObb),r._controller.updateVisibility(e.id));var o=function(e){if(null==e.data)return!0;var t=i.sharedResource.textureDefinitions[e.i3sTexId],n=r._getI3STexEncoding(t);return e.encoding!==n};return r.rendererNeedsTextures&&i.textureData.some(o)?t(i.allGeometryData,i.sharedResource).then(function(t){return i.textureData=t,i.byteSize=de(i.transformedGeometries,i.textureData),t.every(le)&&ce(e,i)&&r._idbCache.put(r._getCacheKey(e),i).catch(function(t){t&&"indexedb:not-initialized"===t.name||pe.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(n),i}):i}):C.resolve(null)},l.prototype.addNodeData=function(e,t){var n=this;return this._addData(e,t.attributeDataInfo,function(){return n._transformBundle(e,t).then(function(t){return n._controller.reschedule(e.id,t)}).then(function(i){e.obb||(e.obb=i.obb,n._controller.updateVisibility(e.id));var o={allGeometryData:t.allGeometryData,transformedGeometries:i.transformedGeometries,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:n._cachingEnabled()?de(i.transformedGeometries,t.textureData):0};if(ce(e,o)&&o.byteSize>0){var a=o.textureData.map(function(e){return le(e)?e:{i3sTexId:e.i3sTexId,encoding:e.encoding,data:null}});n._idbCache.put(n._getCacheKey(e),r({},o,{textureData:a})).catch(function(t){return pe.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return n._addCachedNodeData(e,o)})})},l.prototype._transformBundle=function(e,t){for(var r=this,n=[],i=[t.geometryBuffer],o=0,a=t.allGeometryData;o<a.length;o++)for(var s=a[o].geometries,l=0,d=s;l<d.length;l++){var c=d[l];n.push(this._getVertexBufferLayout(c,t.sharedResource))}var u={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData,layouts:n,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",u,{transferList:i}):this._controller.reschedule(e.id,u).then(function(e){return r._worker.transform(e)})},l.prototype.addCachedGPUData=function(e,t){if(!this._controller.isGeometryVisible(e))return void this._memCache.put(this._getMemCacheKey(e.id),t,e.memory);this._nodeId2Meta.set(e.id,t),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1);for(var r=0,n=t.engineObject.getGeometryRecords();r<n.length;r++){n[r].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled})}this._updateEngineObject(t),this._highlights.objectCreated(t.engineObject)},l.prototype.addCachedNodeData=function(e,t,r){var n=this;return this._addData(e,r,function(){return n._addCachedNodeData(e,t)})},l.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return C.resolve();var n=t.allGeometryData,i=t.transformedGeometries,o=t.textureData,a=t.sharedResource;if(0===n.length)return C.resolve();if(1!==n.length&&console.warn("Node with",n.length,"geometries is unsupported"),!this.rendererNeedsTextures)for(var s=0,l=o;s<l.length;s++){var d=l[s];d.data=null}var c={};c[he.OBJECT]={},c[he.GEOMETRY]={},c[he.MATERIAL]={};var u=0,h=!1;e.memory=0;var p=n[0],g=p.componentOffsets,f=p.geometries,y=p.featureIds,m=null,_=null;if(this._hasSymbolColors){m=this._componentColorManager.getBuffer(y.length),_=new Uint16Array(y.length);for(var b=0;b<y.length;b++)_[b]=m.aquireIndex()}for(var v,I=e.id+"|"+y[0],O=[],x=[],w=[],M=new Array,S=this.view,E=0,T=f;E<T.length;E++){var j=T[E],R=this._createEngineMat(e,j,a,o),V=i[u++];v=V.corMatrices.globalTrafo,h=h||V.hasColors;var A=new te(new Float32Array(V.interleavedVertexData),V.layout,V.positionData,g||te.DefaultOffsets,V.indices||te.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(A,_);var P=null!=j.transformation?D.mat4f64.clone(j.transformation):ve,G=O.length,F=I+(G>0?"_"+G:""),N=new Z(A,F),B=S.renderSpatialReference;O.push(N),w.push(P),M.push(R);var L=U.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,B);x.push(L),e.memory+=this.memEstimateGeometryAdded(N.data),c[he.MATERIAL][R.id]=R,c[he.GEOMETRY][N.id]=N}var k={i3sNode:e.id,layerUid:this._layerUid},H=new ee({idHint:e.id,name:I,geometries:O,materials:M,transformations:w,origins:x,castShadow:!0,metadata:k});H.objectTransformation=v,c[he.OBJECT][H.id]=H;var q=this._addTasks.get(e.id),K=new ye;K.node=e,K.engineObject=H,K.featureIds=y,K.componentColorBuffer=m,K.componentIndices=_,K.cachedRendererVersion=this._getInvalidRendererVersion(),K.cachedSymbolInfos=[],K.attributeInfo=q.attributeInfo,!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors||(this._hasColors=h),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors");var z=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(K).then(function(){var t=r._stageLayer,n=r._stage,i=c[he.OBJECT];for(var o in i)i.hasOwnProperty(o)&&t.addObject(i[o]);for(var a in c)if(c.hasOwnProperty(a)){var s=c[a];for(var l in s)s.hasOwnProperty(l)&&null==n.get(a,l)&&n.add(a,s[l])}if(r._nodeId2Meta.set(e.id,K),r.suspended)return void r._removeNodeStageData(e.id);K.attributeInfo=q.attributeInfo,K.cachedRendererVersion===r._rendererVersion&&z===r.slicePlaneEnabled||r._addOrUpdateEdgeRendering(K),r._setObjectSymbology(K),r._applyFiltersToNode(K)&&r._updateEdgeRendering(K),r.visibleGeometryChanged(H),r._highlights.objectCreated(H);for(var d=0,u=K.engineObject.getGeometryRecords();d<u.length;d++){u[d].material.updateParameters({slicePlaneEnabled:r.slicePlaneEnabled})}})},l.prototype._addData=function(e,t,n){var i=this,o=this._addTasks.get(e.id);return o?o.attributeInfo=t:(o=r({},C.createResolver(),{attributeInfo:t}),this._addTasks.set(e.id,o),n().then(o.resolve,o.reject).then(function(){return i._addTasks.delete(e.id)})),o.promise},l.prototype._clippingAreaChanged=function(){var e=R.create();Y.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},l.prototype._filterChange=function(){this._applyFilters(!1)},l.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e.engineObject))})},l.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},l.prototype.addSqlFilter=function(e,t,r,n){var i=this;t&&r&&e.push(function(e,o){return i._sqlFilter(e,o,t,r,n)})},l.prototype._sqlFilter=function(e,t,r,n,i){var o={},a=this._createLayerGraphic(o),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;n.every(function(e){return null!=d[e]||e===s})&&L.filterInPlace(e,l,function(e){o[s]=l[e];for(var t=0,c=n;t<c.length;t++){var u=c[t];u!==s&&(o[u]=L.getCachedAttributeValue(d[u],e))}try{return r.testFeature(a)}catch(e){return i(e),!1}})},l.prototype._boundingboxFilter=function(e,t,r){Y.mbsToMbs(t.node.mbs,this._controller.crsIndex,Me,this.view.renderSpatialReference);var n=null!=r?L.intersectBoundingBoxWithMbs(r,Me):2;if(2!==n){if(0===n)return void(e.length=0);var i=t.engineObject.getGeometryRecords()[0].geometry;if(i.componentCount===t.featureIds.length){var o=L.getClipAABB(r,t.engineObject);L.filterInPlace(e,t.featureIds,function(e){return R.intersects(o,i.getComponentAABB(e,Oe))})}}},l.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return C.resolve();var r=e.engineObject,n=this._edgeView.hasObject(r),i=this._extractObjectEdgeMaterials(e),o=i.hasEdges,a=i.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};if(o){var l=!r.isHidden(r.geometryRecords[0]);if(n)this._edgeView.updateAllComponentMaterials(r,a,s,t),this._edgeView.updateObjectVisibility(r,l);else if(l)return u.safeCast(this._edgeView.addObject(r,a,s,!1))}else n&&this._edgeView.removeObject(r);return C.resolve()},l.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._edgeView.removeObject(e.engineObject)},l.prototype._applyFiltersToNode=function(e){var t=e.engineObject,r=t.areAllComponentsVisible();if(t.unhideAllComponents(),0===this._filters.length)return!r;var n=e.featureIds;null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters);var i=e.filteredIds;if(i===n)return!r;for(var o=t.getGeometryRecords()[0],a=0,s=0;s<n.length;s++){var l=n[s];a>=i.length||i[a]!==l?t.setComponentVisibility(o,s,!1):a++}return!0},l.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,n=this._filters;r<n.length;r++){(0,n[r])(t,e)}return t.length===e.featureIds.length?e.featureIds:t},l.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,n){return t._removeNodeStageData(n,e)})},l.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop();this._removeNodeStageData(r.id),t.madeProgress()}},l.prototype._removeNodeStageData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._nodeId2Meta.get(e);if(r){var n=r.engineObject;n.setHidden(n.geometryRecords[0],!0),this.visibleGeometryChanged(n),this._removeEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(n),this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory)}},l.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,n=e.engineObject;this._edgeView&&this._edgeView.removeObject(n),r.removeObject(n);for(var i=0,o=n.getGeometryRecords();i<o.length;i++){var a=o[i];this.memEstimateGeometryRemoved(a.geometry.data),t.remove(he.GEOMETRY,a.geometry.id),this._removeMaterial(a.material,t)}if(e.componentIndices){for(var s=0;s<e.componentIndices.length;s++)e.componentColorBuffer.releaseIndex(e.componentIndices[s]);this._componentColorManager.garbageCollect()}t.remove(he.OBJECT,n.id)},l.prototype._removeMaterial=function(e,t){t.remove(he.MATERIAL,e.id);var r=e.metadata.engineTex;r&&(this.memEstimateTextureRemoved(r),t.remove(he.TEXTURE,r.id))},l.prototype.setPolygonOffset=function(e,t){var r=this._nodeId2Meta.get(e.id);if(r)for(var n=0,i=r.engineObject.getGeometryRecords();n<i.length;n++){var o=i[n],a=o.material;a.updateParameters({polygonOffsetEnabled:t})}},l.prototype._getInvalidRendererVersion=function(){return ue(this._rendererVersion,-1)},l.prototype._rendererChange=function(e){return a(this,void 0,void 0,function(){var t,r,n,i,a,s,l,d;return o(this,function(o){switch(o.label){case 0:return this._currentRenderer=e,(this.notifyChange("rendererNeedsTextures"),this._rendererVersion=ue(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e)?(t=this,r=L.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[o.sent(),this.layer.fields]),o.label=2;case 2:if(e&&"visualVariables"in e&&e.visualVariables)for(n=0,i=e.visualVariables;n<i.length;n++)a=i[n],"color"===a.type?this._colorVariable=a:"opacity"===a.type?this._opacityVariable=a:pe.warn("Unsupported visual variable type for 3D Object Scene Services: "+a.type);if(e)for(s=0,l=e.getSymbols();s<l.length;s++)d=l[s],"mesh-3d"!==d.type&&pe.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},l.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},l.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},l.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},n=this._tmpAttributeOnlyGraphic;n.attributes=r;var i=this._currentRenderer,o=e.attributeInfo.attributeData,a=null!=e.featureIds?this.layer.objectIdField:null,s=null!=o?this._rendererFields:null;null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));for(var l=e.cachedSymbolColors,d=!0,c=0;c<t;c++){if(null!=a&&(r[a]=e.featureIds[c]),null!=s)for(var u=0,h=s;u<h.length;u++){var p=h[u];o[p]&&(r[p]=L.getCachedAttributeValue(o[p],c))}var g=i&&i.getSymbol(n),f=null;g instanceof A&&(this._symbolInfos.has(g.id)||this._symbolInfos.set(g.id,L.getSymbolInfo(g)),f=this._symbolInfos.get(g.id)),e.cachedSymbolInfos[c]=f;var y=null,m=null,_=!0,b=!0;if(i&&"visualVariables"in i){if(this._colorVariable){var v=i.getColor(n,{colorInfo:this._colorVariable,color:we});v&&(y=xe,y[0]=v.r/255,y[1]=v.g/255,y[2]=v.b/255,this._opacityVariable||null===v.a||(m=v.a))}this._opacityVariable&&(m=i.getOpacity(n,{opacityInfo:this._opacityVariable}))}if(f&&f.material){var C=f.material;y=null==y||null==m?F.overrideColor(y,m,C.color,C.alpha,ge,xe):F.overrideColor(y,m,null,null,ge,xe),z.encodeSymbolColor(y,C.colorMixMode,l,4*c),_=f.castShadows}else z.encodeSymbolColor(null,null,l,4*c),_=!0;if(c>0&&d){for(var I=4*(c-1);I<4*c;I++)l[I]!==l[I+4]&&(d=!1);_!==b&&(d=!1)}b=_}e.uniformSymbolColor=d}},l.prototype._extractObjectEdgeMaterials=function(e){for(var t=[],r=e.engineObject,n=e.featureIds?e.featureIds.length:1,i={opacity:this.fullOpacity},o=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),a=!1,s=null,l=null,d=this._getSymbolInfos(e),c=0;c<n;c++){var u=d[c];r.getComponentVisibility(r.getGeometryRecords()[0],c)&&u?(l!==u&&(l=u,(s=q.createMaterialFromEdges(this._edgeView,u.edges,i))&&(a=!0)),t.push(b.isSome(s)?s:o)):t.push(o)}return{hasEdges:a,perFeatureEdgeMaterials:t}},l.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r=this._getSymbolColors(e);if(e.uniformSymbolColor){var n=z.decodeSymbolColor(r,0),i=n.color,o=n.colorMixMode,a=!0;e.cachedSymbolInfos[0]&&(a=e.cachedSymbolInfos[0].castShadows);for(var s=0,l=e.engineObject.getGeometryRecords();s<l.length;s++){var d=l[s],c=d.material;c.updateParameters({componentData:{castShadows:a,externalColor:i,externalColorMixMode:o}})}var u=i[3]<1;this._updateObjectOpacity(e.engineObject,u)}else{for(var h=e.componentColorBuffer.textureBuffer,p=!0,g=0;g<t;g++){var f=4*g,y=e.componentIndices[g],m=1;e.cachedSymbolInfos[g]&&(m=!0===e.cachedSymbolInfos[g].castShadows?1:0),h.setData(y,0,r[f],r[f+1],254&r[f+2]|m,r[f+3]),p=p&&z.isOpaqueSymbolColor(r,f)}for(var _=0,b=e.engineObject.getGeometryRecords();_<b.length;_++){var d=b[_],c=d.material;c.updateParameters({componentData:h})}this._updateObjectOpacity(e.engineObject,!p),this._stage.setNeedsRender()}}},l.prototype._setComponentIndices=function(e,t){
for(var r=e.getAttribute(ne.VertexAttrConstants.COMPONENTINDEX),n=r.data,i=r.offsetIdx,o=r.strideIdx,a=e.getIndices(ne.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],c=l;c<d;c++){var u=i+a[c]*o;n[u]=t[s]}},l.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},l.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},l.prototype._updateObjectOpacity=function(e,t){for(var r=0,n=e.getGeometryRecords();r<n.length;r++){var i=n[r],o=i.material,a=o.metadata;void 0!==t&&(a.symbolIsTransparent=t);var s=this._calcEngineMaterialTransparencyParams(a.i3sTex,a.i3sMatParams,a.symbolIsTransparent);o.updateParameters(s)}},l.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e.engineObject)},l.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._stageLayer.isSliceable=e,this._nodeId2Meta.forEach(function(e){for(var n=0,i=e.engineObject.getGeometryRecords();n<i.length;n++){i[n].material.updateParameters(r)}t._updateEdgeRendering(e,!1)})},l.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e,t)},l.prototype._forAllFeatures=function(e,t,r){var n=this;this._nodeId2Meta.forEach(function(i,o){n._forAllFeaturesOfNode(i,e,r),t&&t(i.node)})},l.prototype._forAllFeaturesOfNode=function(e,t,r){for(var n=e.featureIds,i=e.engineObject.getGeometryRecords()[0],o=0;o<n.length;o++)if(r||e.engineObject.getComponentVisibility(i,o)){var a=n[o];t(a,o,e,i)}},l.prototype._createGraphic=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var n=t.attributeInfo.attributeData;if(null!=n)for(var i=0,o=Object.keys(n);i<o.length;i++){var a=o[i];r[a]=L.getCachedAttributeValue(n[a],e)}return this._createLayerGraphic(r)},l.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,Ie),i=0;i<8;++i)Ce[0]=1&i?n[0]:n[3],Ce[1]=2&i?n[1]:n[4],Ce[2]=4&i?n[2]:n[5],T.vec3.transformMat4(Ce,Ce,t.objectTransformation),r[3*i]=Ce[0],r[3*i+1]=Ce[1],r[3*i+2]=Ce[2];return r},l.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var n=this._highlights;if("number"==typeof e?e=[e]:e instanceof d?e=[e]:e instanceof h&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof d){var i=e,o=i.map(function(e){return H.attributeLookup(e.attributes,r._getObjectIdField())}),a=n.acquireSet(t),s=a.set,l=a.handle;return n.setFeatureIds(s,o),l}if("number"==typeof e[0]){var o=e,c=n.acquireSet(t),s=c.set,l=c.handle;return n.setFeatureIds(s,o),l}}return Se},l.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=O.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},l.prototype.test=function(){return{controller:this._controller}},i([E.property()],l.prototype,"view",void 0),i([E.property()],l.prototype,"layer",void 0),i([E.property()],l.prototype,"_controller",void 0),i([E.property({dependsOn:["_controller.updating"]})],l.prototype,"updating",void 0),i([E.property({dependsOn:["_controller.rootNodeVisible"]})],l.prototype,"suspended",void 0),i([E.property(K.updatingPercentage)],l.prototype,"updatingPercentage",void 0),i([E.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],l.prototype,"updatingPercentageValue",void 0),i([E.property({readOnly:!0})],l.prototype,"hasTexturesOrVertexColors",null),i([E.property({readOnly:!0})],l.prototype,"rendererNeedsTextures",null),i([E.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],l.prototype,"elevationOffset",null),i([E.property({type:Boolean})],l.prototype,"slicePlaneEnabled",void 0),i([E.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],l.prototype,"uncompressedTextureDownsamplingEnabled",null),i([E.property({dependsOn:["layer.version"]})],l.prototype,"useCompressedTextures",null),l=i([E.subclass("esri.views.3d.layers.I3SMeshView3D")],l)}(E.declared(g,p,v));t.I3SMeshView3D=be;var ve=D.mat4f64.create(),Ce=j.vec3f64.create(),Ie=R.create(),Oe=R.create(),xe=[0,0,0,0],we=new l([0,0,0,0]),Me=[0,0,0,0],Se={remove:function(){},pause:function(){},resume:function(){}}});