// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../renderers/PointCloudClassBreaksRenderer","../../../../renderers/PointCloudStretchRenderer","../../../../renderers/PointCloudUniqueValueRenderer","./I3SBinaryReader"],function(e,r,t,n,o,l){function i(e){var r=e.renderer,t=r&&r.type,n=r&&e.renderer.toJSON()||null,o=null,l=!1;"point-cloud-unique-value"===t?o=b(e.attributeStorageInfo,r.field):"point-cloud-stretch"===t?o=b(e.attributeStorageInfo,r.field):"point-cloud-class-breaks"===t?o=b(e.attributeStorageInfo,r.field):"point-cloud-rgb"===t?(o=g(e.attributeStorageInfo,r.field),l=null!=o):(o=g(e.attributeStorageInfo,"RGB"),l=null!=o);var i=null;return r&&r.colorModulation&&(i=b(e.attributeStorageInfo,r.colorModulation.field)),{rendererJSON:n,isRGBRenderer:l,primaryAttribute:o,modulationAttribute:i}}function a(e){var r=e.filters;return r?r.map(function(r){return{filterJSON:r.toJSON(),attributeInfo:b(e.attributeStorageInfo,r.field)}}):[]}function u(e,r,l,i,a){var u=e.rendererJSON,f=e.isRGBRenderer,d=e.primaryAttribute,s=e.modulationAttribute,c=p(d,r,i,a),v=p(s,l,i,a),g=null,b=null;if(c&&f)g=c;else if(c&&"pointCloudUniqueValueRenderer"===u.type){b=o.fromJSON(u);var S=b.colorUniqueValueInfos;g=new Uint8Array(3*a);for(var y=m(b.fieldTransformType),h=0;h<a;h++)for(var I=y?y(c[h]):c[h],R=I+"",A=0;A<S.length;A++)if(S[A].values.indexOf(R)>=0){g[3*h]=S[A].color.r,g[3*h+1]=S[A].color.g,g[3*h+2]=S[A].color.b;break}}else if(c&&"pointCloudStretchRenderer"===u.type){b=n.fromJSON(u);var C=b.stops;g=new Uint8Array(3*a);for(var y=m(b.fieldTransformType),h=0;h<a;h++){var I=y?y(c[h]):c[h],O=C.length-1;if(I<C[0].value)g[3*h]=C[0].color.r,g[3*h+1]=C[0].color.g,g[3*h+2]=C[0].color.b;else if(I>=C[O].value)g[3*h]=C[O].color.r,g[3*h+1]=C[O].color.g,g[3*h+2]=C[O].color.b;else for(var A=1;A<C.length;A++)if(I<C[A].value){var B=(I-C[A-1].value)/(C[A].value-C[A-1].value);g[3*h]=C[A].color.r*B+C[A-1].color.r*(1-B),g[3*h+1]=C[A].color.g*B+C[A-1].color.g*(1-B),g[3*h+2]=C[A].color.b*B+C[A-1].color.b*(1-B);break}}}else if(c&&"pointCloudClassBreaksRenderer"===u.type){b=t.fromJSON(u);var V=b.colorClassBreakInfos;g=new Uint8Array(3*a);for(var y=m(b.fieldTransformType),h=0;h<a;h++)for(var I=y?y(c[h]):c[h],A=0;A<V.length;A++)if(I>=V[A].minValue&&I<=V[A].maxValue){g[3*h]=V[A].color.r,g[3*h+1]=V[A].color.g,g[3*h+2]=V[A].color.b;break}}else{g=new Uint8Array(3*a);for(var h=0;h<g.length;h++)g[h]=255}if(v&&b&&b.colorModulation)for(var k=b.colorModulation.minValue,x=b.colorModulation.maxValue,h=0;h<a;h++){var I=v[h],J=I>=x?1:I<=k?.3:.3+.7*(I-k)/(x-k);g[3*h]=J*g[3*h],g[3*h+1]=J*g[3*h+1],g[3*h+2]=J*g[3*h+2]}return g}function f(e,r,t,n){for(var o=e.length/3,l=n.map(function(r,n){return p(t[n].attributeInfo,r,e,o)}),i=0,a=0;a<o;a++){for(var u=!0,f=0;f<t.length&&u;f++){var s=t[f].filterJSON,c=l[f][a];switch(s.type){case"pointCloudValueFilter":var v="exclude"===s.mode;-1!==s.values.indexOf(c)===v&&(u=!1);break;case"pointCloudBitfieldFilter":var g=d(s.requiredSetBits),b=d(s.requiredClearBits);(c&g)===g&&0==(c&b)||(u=!1);break;case"pointCloudReturnFilter":for(var m=15&c,S=c>>>4&15,y=S>1,h=1===m,I=m===S,R=!1,A=0,C=s.includedReturns;A<C.length;A++){var O=C[A];if("last"===O&&I||"firstOfMany"===O&&h&&y||"lastOfMany"===O&&I&&y||"single"===O&&!y){R=!0;break}}R||(u=!1)}}u&&(e[3*i]=e[3*a],e[3*i+1]=e[3*a+1],e[3*i+2]=e[3*a+2],r[3*i]=r[3*a],r[3*i+1]=r[3*a+1],r[3*i+2]=r[3*a+2],i++)}return i}function d(e){for(var r=0,t=0,n=e||[];t<n.length;t++){r|=1<<n[t]}return r}function s(e){var r=e&&e.pointSizeAlgorithm;return r&&"splat"===r.type?r:null}function c(e){var r=e&&e.pointSizeAlgorithm;return r&&"fixed-size"===r.type?r:null}function v(e){var r=e&&e.pointSizeAlgorithm;return!(!r||!r.type)&&"fixed-size"===r.type}function g(e,r){for(var t=0,n=e;t<n.length;t++){var o=n[t];if(o.name===r&&null!=o.attributeValues&&"UInt8"===o.attributeValues.valueType&&3===o.attributeValues.valuesPerElement)return{storageInfo:o,useElevation:!1}}return null}function b(e,r){for(var t=0,n=e;t<n.length;t++){var o=n[t];if(o.name===r){var l="embedded-elevation"===o.encoding;return{storageInfo:l?null:o,useElevation:l}}}return"elevation"===r.toLowerCase()?{storageInfo:null,useElevation:!0}:null}function p(e,r,t,n){if(e&&e.useElevation){for(var o=new Float64Array(n),i=0;i<n;i++)o[i]=t[3*i+2];return o}return e&&r?l.readBinaryAttribute(e.storageInfo,r,n):null}function m(e){return null==e||"none"===e?null:"low-four-bit"===e?function(e){return 15&e}:"high-four-bit"===e?function(e){return(240&e)>>4}:"absolute-value"===e?function(e){return Math.abs(e)}:"modulo-ten"===e?function(e){return e%10}:null}Object.defineProperty(r,"__esModule",{value:!0}),r.getRendererInfo=i,r.getFilterInfo=a,r.evaluateRenderer=u,r.filterInPlace=f,r.getSplatSizeAlgorithm=s,r.getFixedSizeAlgorithm=c,r.rendererUsesFixedSizes=v});