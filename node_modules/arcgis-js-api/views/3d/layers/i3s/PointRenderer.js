// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../geometry/support/aaBoundingBox","../../support/geometryUtils","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/lib/ProgramRepository","../../webgl-engine/materials/internal/MaterialUtil","../../webgl-engine/shaders/PointRendererPrograms","../../../webgl/BufferObject","../../../webgl/renderState","../../../webgl/VertexArrayObject"],function(e,t,i,r,n,s,a,o,l,c,d,p,u,h,m,f,g,_,b,v){function S(e){return e?256:64}function P(e,t,i,r,n){if(i.drawScreenSpace)return i.fixedSize*t*r;var s=S(n)*t*r;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),s):Math.min(e/2,s)}function x(e,t,i,r,n){return i.drawScreenSpace?0:P(e,t,i,r,n)}function y(e,t,i){return null==i&&(i=o.vec3f64.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}var z=n.mat4f64.create(),R={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]},I=function(){function e(){this.didRender=!1,this.needsRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=c.create(c.POSITIVE_INFINITY),this._programRep=null,this._needsPrograms=!0,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=r.mat4f32.create(),this.tempVec3=a.vec3f32.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){var t=e.rctx;this._programRep=new m(t),this.needsRender=!0,this._needsPrograms=!0},e.prototype.uninitializeRenderContext=function(e){this._programRep.dispose(),this._programRep=null,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,i,r,n){var a=o.vec3f64.create(),m=o.vec3f64.create(),f=o.vec3f64.create(),g=o.vec3f64.create(),_=p.plane.create(),b=e.camera.perScreenPixelRatio/2,v=e.camera.near,S=this._getSizeParams();s.vec3.subtract(m,r,i);var R=1/s.vec3.length(m);s.vec3.scale(m,m,R),s.vec3.negate(f,m),l.vec4.set(_,m[0],m[1],m[2],-s.vec3.dot(m,i));var I={},M={},U=[],w=c.create(),F=c.create(this._clipBox);c.offset(F,-i[0],-i[1],-i[2],F);for(var E=0,W=this.nodes;E<W.length;E++){var O=W[E],V=O.splatSize*this._scaleFactor,q=u.minimumDistancePlane(O.obb,_),j=u.maximumDistancePlane(O.obb,_);q-=x(V,q+v,S,b,O.isLeaf),j-=x(V,j+v,S,b,O.isLeaf);var B=j<0,D=null!=I.dist&&null!=M.dist&&I.dist<q*R&&M.dist>j*R;if(!B&&!D){var N=P(V,j+v,S,b,O.isLeaf);if(u.intersectLine(O.obb,i,m,N)){var C=N*N;u.toAaBoundingBox(O.obb,w),c.offset(w,-i[0],-i[1],-i[2],w);var L=!c.contains(F,w);s.vec3.subtract(g,O.origin,i);for(var A=O.coordinates.length/3,T=0;T<A;T++)if(a[0]=g[0]+O.coordinates[3*T],a[1]=g[1]+O.coordinates[3*T+1],a[2]=g[2]+O.coordinates[3*T+2],!L||c.containsPoint(F,a)){var H=s.vec3.dot(a,m),Y=s.vec3.squaredLength(a)-H*H;if(!(Y>C)){var k=H+v,G=x(V,k,S,b,O.isLeaf);if(!(H-G<0)){k-=G;var J=P(V,k,S,b,O.isLeaf);if(!(Y>J*J)){var K=this.layerUid+"/"+O.id+"/"+T,Q=(H-G)*R;if(null==I.dist||Q<I.dist){var X=I;(null==t||t(i,r,Q))&&(X.point=y(O,T,X.point),X.dist=Q,X.normal=f,X.pointId=K,X.layerUid=this.layerUid)}if(null==M.dist||Q>M.dist){var X=M;(null==t||t(i,r,Q))&&(X.point=y(O,T,X.point),X.dist=Q,X.normal=f,X.pointId=K,X.layerUid=this.layerUid)}if((null==t||t(i,r,Q))&&e.enable.storeAll){var Z={};Z.point=y(O,T,Z.point),Z.dist=Q,Z.normal=f,Z.pointId=K,Z.layerUid=this.layerUid,U.push(Z)}}}}}}}}if(null!=I.dist){var $=e.results.min;if(null==$.dist||I.dist<$.dist){var ee={type:"external",point:I.point,metadata:{pointId:I.pointId,layerUid:I.layerUid}};$.set(ee,I.pointId,I.dist,I.normal,z,void 0),$.intersector="PointRenderer"}}if(null!=M.dist){var te=e.results.max;if(null==te.dist||M.dist>te.dist){var ee={type:"external",point:M.point,metadata:{pointId:M.pointId,layerUid:M.layerUid}};te.set(ee,M.pointId,M.dist,M.normal,z,void 0),te.intersector="PointRenderer"}}if(e.enable.storeAll)for(var ie=d.ray.fromPoints(i,r),re=0,ne=U;re<ne.length;re++){var X=ne[re],ee={type:"external",point:X.point,metadata:{pointId:X.pointId,layerUid:X.layerUid}},se=new h.IntersectorResult(ie);se.set(ee,X.pointId,X.dist,X.normal,z,void 0),se.intersector="PointRenderer",e.results.all.push(se)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass)return!1;for(var t=1===e.pass,r=e.rctx,n=0,a=this.nodes;n<a.length;n++){var o=a[n];null==o.vao&&this._initNode(e,o)}this._selectPrograms();var l=this._getSizeParams(),d=t?l.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:l.drawScreenSpace?this._programScreen:this._programWorld;if(null==d||0===this.nodes.length)return!0;var p=this._clipBox,u=!c.equals(p,c.POSITIVE_INFINITY,function(e,t){return e===t});u||(s.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),d.setUniform3fv("uClipMin",this.tempVec3),s.vec3.set(this.tempVec3,1/0,1/0,1/0),d.setUniform3fv("uClipMax",this.tempVec3)),r.bindProgram(d),r.setPipelineState(this._pipelineState),d.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&d.setUniform2f("nearFar",e.camera.near,e.camera.far);var h=e.camera.pixelRatio;l.drawFixedSize&&d.setUniform2f("uPointScale",l.fixedSize*h,e.camera.fullHeight);for(var m=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,g=0,_=this.nodes;g<_.length;g++){var o=_[g];if(d.setUniform2f("uScreenMinMaxSize",l.screenMinSize*h,S(o.isLeaf)*h),!l.drawFixedSize){var b=o.splatSize*this._scaleFactor;d.setUniform2f("uPointScale",b*h,e.camera.fullHeight/h)}var v=o.origin;u&&(s.vec3.set(this.tempVec3,p[0]-v[0],p[1]-v[1],p[2]-v[2]),d.setUniform3fv("uClipMin",this.tempVec3),s.vec3.set(this.tempVec3,p[3]-v[0],p[4]-v[1],p[5]-v[2]),d.setUniform3fv("uClipMax",this.tempVec3)),i.mat4.identity(this.tempMatrix4),i.mat4.translate(this.tempMatrix4,this.tempMatrix4,v),i.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),d.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),m&&f.bindSlicePlane(v,m,d),r.bindVAO(o.vao),r.drawArrays(0,0,o.coordinates.length/3)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){c.set(this._clipBox,e||c.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender(),this._needsPrograms=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._requestRender()},e.prototype.removeNode=function(e){var t=null;return this.nodes=this.nodes.filter(function(i){return i.id!==e||(t=i,i.vao&&(i.vao.dispose(!0),i.vao=null),!1)}),this._requestRender(),t},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new v(i,g.program.attributes,R,{positions:_.createVertex(i,35044,t.coordinates),colors:_.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this.didRender=!1,this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,r=this._minSizePx;return e&&(r=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:r}},e.prototype._selectPrograms=function(){this._needsPrograms&&(this._needsPrograms=!1,this._programWorld=this._programRep.getProgram(g.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(g.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(g.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(g.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._pipelineState=b.makePipelineState({depthTest:{func:513},depthWrite:b.defaultDepthWriteParams,colorWrite:b.defaultColorWriteParams}))},e}();return function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(I||(I={})),I});