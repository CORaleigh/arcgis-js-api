// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","dojo/errors/CancelError","../../../../core/PooledArray","../../../../core/urlUtils","../../support/orientedBoundingBox"],function(e,t,i,r,s,n,o){Object.defineProperty(t,"__esModule",{value:!0});var a=["version","level","sharedResource","attributeData","geometryData","textureData","lodSelection"],d=function(){function e(e,t,i,r,o,a,d,h,l,p){var f=this;this.rootId=i,this.streamDataSupplier=r,this.viewportQueries=o,this.logger=a,this._isLoaded=d,this._isSelected=h,this._enable=l,this._needsUpdate=p,this._dirty=!0,this.nodeIndex={},this._loadingNodes=new Set,this._failedNodes=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s,this._prefetch=new s,this._updates=new u,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.rootUrl=n.makeAbsolute(t,e),this.traverseVisible(function(e,t){return f.nodeTraversalState(t)})}return e.prototype.getNode=function(e){return this.nodeIndex[e]},Object.defineProperty(e.prototype,"size",{get:function(){return Object.keys(this.nodeIndex).length},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){h.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e,t){var r=this;if(this._dirty){this._indexMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),h.clear(),this._updates.reset(e);var s=!0,n=new l,o=new l,a=new Map,d=function(d,u,l){if(r._updateNodeFeatureEstimate(u,o),!u){++r._indexMissing;var p=r.entryPriority(d);return r._loadingNodes.has(d.id)||r._failedNodes.has(d.id)||(r._missing.push(i({},d,{baseUrl:l})),a.set(d.id,p)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,p))}if(0===r._missing.length&&u.children)for(var f=0,c=u.children;f<c.length;f++){var m=c[f];r.nodeIndex[m.id]||r._loadingNodes.has(m.id)||(a.set(m.id,r.entryPriority(m)),r._prefetch.push(i({},m,{baseUrl:u.baseUrl})))}if(!u.failed&&u.featureData&&0!==u.featureData.length)if(r._isLoaded(u)){if(n.known+=u.memory,++n.knownNodes,r._isSelected(u)?u.children&&(s=!1):(n.unremoved+=u.memory,s=!1),r._needsUpdate(u)){var _=r.entryPriority(u);a.set(u.id,_),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,_),r._updates.update.push(u)}}else if(u.memory&&(n.known+=u.memory,++n.knownNodes),r._isSelected(u)){if(u.children&&(s=!1),u.memory?(n.missing+=u.memory,n.known+=u.memory,++n.knownNodes):++n.missingNodes,e.indexOf(u.id)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(u)),void(r._updates.cancel=r._updates.cancel.filter(function(e){return e!==u.id}));if(!t.done&&r._enable(u))return void t.madeProgress();var g=r.entryPriority(u);a.set(u.id,g),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,g),h.push(u)}};this.traverseVisible(d),this._unloadedMemoryEstimate=n.missing-n.unremoved,n.knownNodes>3&&n.missingNodes>0&&(this._unloadedMemoryEstimate+=n.known/n.knownNodes*n.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(o),this._featureEstimate.leafsReached=s,this._missing.sort(function(e,t){return a.get(e.id)-a.get(t.id)}),this._missing.length>0?(this._maxUnloadedPrio=a.get(this._missing.back().id),this._prefetch.clear()):this._prefetch.sort(function(e,t){return a.get(e.id)-a.get(t.id)}),this._updates.add=h.filter(function(e){var t=e.id;return a.get(t)>=r._maxUnloadedPrio},this,this._updates.add),this._updates.add.sort(function(e,t){return a.get(e.id)-a.get(t.id)}),this._updates.update.sort(function(e,t){return a.get(e.id)-a.get(t.id)}),this._dirty=this._indexMissing>0}},e.prototype.checkFeatureTarget=function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,s=t,n=i,o=10;o--;){var a=new l;this._updateFeatureEstimate(r,a);if(this._computeFeatureEstimate(a)<=e){if(r>=t||a.missingNodes>0||0===o)break;n=r,r=.5*(r+s)}else s=r,r=.5*(r+n)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)},e.prototype._updateFeatureEstimate=function(e,t){var i=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,r){return i._updateNodeFeatureEstimate(r,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){if(0===this._missing.length)return!1;e=Math.min(e,this._missing.length);for(var t=0;t<e;++t)this._loadNode(this._missing.pop());return!0},e.prototype.prefetch=function(e){if(0===this._prefetch.length)return!1;e=Math.min(e,this._prefetch.length);for(var t=0;t<e;++t)this._loadNode(this._prefetch.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loadingNodes.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.id];if(t&&t.version===this._version)return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),s=!0;if(r)if(e.parentNode){var n=this.nodeIndex[e.parentNode.id];if(null==n)return null;var o=this._nodeTraversalState[n.id];s=o&&i>o.lodLevel}else s=i>0;return t?(t.lodLevel=i,t.isChosen=s,t.version=this._version,t):(this._nodeTraversalState[e.id]={nodeHasLOD:r,lodLevel:i,isChosen:s,version:this._version},this._nodeTraversalState[e.id])},e.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id);var i=n.makeAbsolute(e.href,e.baseUrl),s=function(e){t._loadingNodes.delete(e),0===t._missing.length&&0===t._loadingNodes.size&&t.requestUpdate()};this.streamDataSupplier.request(i,"json").then(function(e){var r=e.data,n=r,d={id:n.id,mbs:n.mbs,parentNode:n.parentNode,children:n.children,featureData:n.featureData};a.forEach(function(e){d[e]=n.hasOwnProperty(e)?n[e]:null}),n.hasOwnProperty("obb")&&!t.ignoreServiceOBB&&(d.obb=o.clone(n.obb),d.hasServiceOBB=!0,t.viewportQueries.updateNode(d.id)),t.nodeIndex[d.id]=d,d.baseUrl=i,d.featureData&&1===d.featureData.length&&d.featureData[0].featureRange&&(d.numFeatures=d.featureData[0].featureRange[1]-d.featureData[0].featureRange[0]+1),t.nodeTraversalState(d),s(d.id)},function(n){n instanceof r||(t.logger.error("Error loading node: "+i),t._failedNodes.add(e.id)),s(e.id)})},e.prototype.resetFailedNodes=function(){this._failedNodes.clear();for(var e=0,t=Object.keys(this.nodeIndex);e<t.length;e++){var i=t[e];this.nodeIndex[i].failed=!1}},e.prototype.entryPriority=function(e){if(null==e.mbs&&e.id===this.rootId)return 1/0;var t=0,i=this.nodeIndex[e.id];if(null!=i&&null!=i.parentNode){var r=this._nodeTraversalState[i.parentNode.id];null!=r&&(t=r.lodLevel)}for(var s=this.progressiveLoadPenalty,n=i;n;n=n.parentNode?this.nodeIndex[n.parentNode.id]:null)if(this._isLoaded(n)){s=0;break}var o=this.viewportQueries.distToPOI(e);return-o-t*(o+this.progressiveLoadPenalty)+s},e.prototype.traverseVisible=function(e){var t=this.nodeIndex[this.rootId];if(!t)return void e({id:this.rootId,mbs:null,href:this.rootUrl},null,"");this._traverse({id:this.rootId,mbs:t.mbs,href:this.rootUrl},t,e,"")},e.prototype._traverse=function(e,t,i,r){if(!t.children||0===t.children.length)return void(this.viewportQueries.isGeometryVisible(t)&&i(e,t,r));if(this.viewportQueries.isNodeVisible(t)){i(e,t,r);var s=this.nodeTraversalState(t);if(!s.nodeHasLOD||s.lodLevel!==this._maxLodLevel)for(var n=0,o=t.children;n<o.length;n++){var a=o[n],d=this.nodeIndex[a.id];d?this._traverse(a,d,i,t.baseUrl):this.viewportQueries.isNodeVisible(a)&&i(a,null,t.baseUrl)}}},e.prototype.traverse=function(e,t){if(t(e)&&e.children)for(var i=0;i<e.children.length;++i){var r=this.getNode(e.children[i].id);r&&this.traverse(r,t)}},e.prototype.traverseChildren=function(e,t){if(e.children)for(var i=0;i<e.children.length;++i){var r=this.getNode(e.children[i].id);r&&t(r)&&this.traverseChildren(r,t)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e}();t.I3SIndex=d;var h=new s,u=function(){function e(){this.update=new s,this.add=new s,this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}(),l=function(){function e(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}return e}()});