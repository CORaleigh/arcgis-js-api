// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/meshUtils/deduplicate","./I3SBinaryReader","../../support/projectionUtils","../../webgl-engine/lib/Util"],function(e,t,r,n,a,s,o,i,c,u,f){function l(e,t,r,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var s=e.params.vertexAttributes,o=s.position.count;if(!m(r[0].stride))throw h("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var i=r[0].stride/Uint32Array.BYTES_PER_ELEMENT,c=new Uint32Array(i*o);r=r.slice(0).sort(function(e,t){return e.offset-t.offset});for(var u=0,f=r;u<f.length;u++){var l=f[u];!function(e){if(-1!==a.indexOf(e.name))return"continue";var r=s[e.name],i=E(e.type),u=void 0,f=!1;if(null==r){var l=n.filter(function(t){return t.name===e.name})[0];if(!l)throw h("Geometry definition is missing attribute");r={valueType:y(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var g=0;g<S.length;g++)S[g]=l.byteValue;u=S.buffer,f=!0}else u=t;if(y(e.type)!==r.valueType)throw h("Geometry definition type must match attribute type");if(!p(r.byteOffset)||!p(e.offset))throw h(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!m(r.valuesPerElement*i.BYTES_PER_ELEMENT)||!m(e.count*i.BYTES_PER_ELEMENT))throw h(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var b=new Uint32Array(u),w=r.byteOffset/Uint32Array.BYTES_PER_ELEMENT,I=r.valuesPerElement*i.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,T=e.offset/Uint32Array.BYTES_PER_ELEMENT,A=e.stride/Uint32Array.BYTES_PER_ELEMENT;f?v(b[0],I,c,T,A,o):d(b,w,I,c,T,A,o)}(l)}return c.buffer}function d(e,t,r,n,a,s,o){switch(r){case 1:for(var i=0;i<o;i++)n[a]=e[t],t+=1,a+=s;break;case 2:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],t+=2,a+=s;break;case 3:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],t+=3,a+=s;break;case 4:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],n[a+3]=e[t+3],t+=4,a+=s;break;default:throw h("Unhandled stride size "+r)}}function v(e,t,r,n,a,s){switch(t){case 1:for(var o=0;o<s;o++)r[n]=e,n+=a;break;case 2:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,n+=a;break;case 3:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,r[n+2]=e,n+=a;break;case 4:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,n+=a;break;default:throw h("Unhandled stride size "+t)}}function E(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function y(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function p(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function m(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function h(e){return new Error("I3SGeometryUtil processing failed: "+e)}function g(e,t,r,n,a){if("none"===e)b(a);else{var s=c.createTypedView(r,t.params.vertexAttributes.normal),o="earth-centered"===e?n:null;w(s,a.normals,o)}}function b(e){var t=e.normals,r=e.positions,o=e.normalInd,i=e.positionInd;f.assert(e.normalInd.length===e.positionInd.length);for(var c=s.vec3f32.create(),u=s.vec3f32.create(),l=n.vec2f32.create(),d=r.data,v=r.offsetIdx,E=r.strideIdx,y=t.data,p=t.offsetIdx,m=t.strideIdx,h=0;h<i.length;h+=3){var g=i[h],b=v+E*g,w=d[b],I=d[b+1],T=d[b+2];g=i[h+1],b=v+E*g,c[0]=d[b]-w,c[1]=d[b+1]-I,c[2]=d[b+2]-T,g=i[h+2],b=v+E*g,u[0]=d[b]-w,u[1]=d[b+1]-I,u[2]=d[b+2]-T,a.vec3.cross(c,c,u),f.encodeNormal(c,l);for(var A=0;A<3;A++){var _=o[h+A],U=p+m*_;y[U]=f.encodeInt16(l[0]),y[U+1]=f.encodeInt16(l[1])}}}function w(e,t,r){var n=e.length/3,a=t.data,s=t.offsetIdx,o=t.strideIdx;if(null!=r)for(var i=r,c=i[0],u=i[1],l=i[2],d=i[4],v=i[5],E=i[6],y=i[8],p=i[9],m=i[10],h=0;h<n;h++){var g=e[3*h],b=e[3*h+1],w=e[3*h+2];N[0]=c*g+u*b+l*w,N[1]=d*g+v*b+E*w,N[2]=y*g+p*b+m*w,f.encodeNormal(N,L),a[s+h*o]=f.encodeInt16(L[0]),a[s+h*o+1]=f.encodeInt16(L[1])}else for(var h=0;h<n;h++)N[0]=e[3*h],N[1]=e[3*h+1],N[2]=e[3*h+2],f.encodeNormal(N,L),a[s+h*o]=f.encodeInt16(L[0]),a[s+h*o+1]=f.encodeInt16(L[1])}function I(e,t,r){var n=t[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var a=new Float32Array(e),s=n.stride/4,o=n.offset/4,c=3*a.length/s,u=new Float32Array(c),f=0;f<c/3;f++)u[3*f]=a[f*s+o],u[3*f+1]=a[f*s+o+1],u[3*f+2]=a[f*s+o+2];var l=i.default(u.buffer,3,r);return l.uniqueCount<x?{data:new Float32Array(l.buffer),indices:new Uint16Array(l.indices)}:{data:new Float32Array(l.buffer),indices:l.indices}}function T(){return null!=k?r.resolve():r.create(function(t,r){return e(["../../../../geometry/geometryEngine"],t)}).then(function(e){return k=e})}function A(e,t,r,n){var a=r.spatialReference||t.spatialReference,s=t.renderSpatialReference,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};o.rings[0][4]=o.rings[0][0];var i=n.objectTransformation,c=n.getGeometryRecords()[0].geometry,u={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};u.rings[0][3]=u.rings[0][0];var f=k[e];return f||(console.error("Spatial relationship",e,"not supported"),f=function(){return!0}),{type:e,mask:r,maskSR:a,renderSR:s,aabb:o,transform:i,geometry:c,triangle:u,testFunction:f}}function _(e,t){switch(t){case 0:switch(e.type){case"intersects":case"contains":case"crosses":case"envelope-intersects":case"overlaps":case"touches":case"within":return 1;case"disjoint":return 0}break;case 2:switch(e.type){case"intersects":case"contains":case"envelope-intersects":case"within":return 0;case"disjoint":case"crosses":case"overlaps":case"touches":return 1}break;case 1:switch(e.type){case"envelope-intersects":return 0}}return 2}function U(e,t){var r={x:t[0],y:t[1],hasZ:!1,hasM:!1,type:"point",spatialReference:e.maskSR};return M(e,k.buffer(r,t[3],1,!0))}function M(e,t){return k.contains(e.mask,t)?2:k.intersects(e.mask,t)?1:0}function R(e,t){var r=t.type,n=t.mask,s=t.transform,o=t.renderSR,i=t.maskSR,c=t.geometry,l=t.triangle,d=t.testFunction,v=t.aabb;c.getComponentAABB(e,B);var E=[v.rings[0][0],v.rings[0][1],v.rings[0][2],v.rings[0][3]];a.vec3.set(E[0],B[0],B[1],0),a.vec3.set(E[1],B[0],B[4],0),a.vec3.set(E[2],B[3],B[4],0),a.vec3.set(E[3],B[3],B[1],0);for(var y=0;y<4;++y)a.vec3.transformMat4(E[y],E[y],s),u.vectorToVector(E[y],o,E[y],i);switch(delete v._geVersion,_(t,M(t,v))){case 1:return!1;case 0:return!0}var p,m=l.rings[0][0],h=l.rings[0][1],g=l.rings[0][2],b=c.data.getIndices(f.VertexAttrConstants.POSITION),w=c.data.componentOffsets,I=c.data.getAttribute(f.VertexAttrConstants.POSITION),T=I.data,A=I.offsetIdx,U=I.strideIdx,R=w.length?w[e]:0,S=w.length?w[e+1]:b.length;switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":p=function(){return d(n,l)?0:2};break;case"contains":case"disjoint":case"within":default:p=function(){return d(n,l)?2:1}}for(var y=R;y<S;y+=3){var x=A+U*b[y+0],k=A+U*b[y+1],N=A+U*b[y+2];a.vec3.set(m,T[x+0],T[x+1],T[x+2]),a.vec3.set(h,T[k+0],T[k+1],T[k+2]),a.vec3.set(g,T[N+0],T[N+1],T[N+2]),a.vec3.transformMat4(m,m,s),a.vec3.transformMat4(h,h,s),a.vec3.transformMat4(g,g,s),u.vectorToVector(m,o,m,i),u.vectorToVector(h,o,h,i),u.vectorToVector(g,o,g,i);var L=h[0]-m[0],Y=h[1]-m[1],O=g[0]-m[0],V=g[1]-m[1];if(!(Math.abs(L*V-Y*O)<P))switch(delete l._geVersion,p()){case 1:return!1;case 0:return!0}}switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":return!1;case"contains":case"disjoint":case"within":default:return!0}}Object.defineProperty(t,"__esModule",{value:!0});var S=new Uint8Array(64);t.interleaveGeometryBuffer=l,t.processAndInterleaveNormals=g;var x=65536;t.extractPositionData=I;var k;t.loadGeometryEngine=T,t.acquireMaskFilterContext=A,t.getIntersectRelation=_,t.intersectMaskWithMbs=U;var P=Math.pow(2,-32);t.filterMask=R;var B=o.create(),N=s.vec3f32.create(),L=n.vec2f32.create()});