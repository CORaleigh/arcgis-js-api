// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Handles","../../../../core/accessorSupport/decorators"],function(e,i,t,a,r,l,n){function s(e,i){return null!==e&&e>0&&e<8e7||i>50}return function(e){function i(){var i=e.call(this)||this;return i._scaleRangeActive=!1,i._layerScaleRangeVisibilityDirty=!0,i.layerScaleRangeVisibilityQuery=!1,i.scaleChangeEventHandle=null,i.handles=new l,i.layerView=null,i.layer=null,i.queryGraphicUIDsInExtent=null,i.extent=null,i.graphicsCore=null,i.basemapTerrain=null,i.suspended=!1,i}return t(i,e),Object.defineProperty(i.prototype,"layerScaleRangeVisibilityDirty",{get:function(){return this._layerScaleRangeVisibilityDirty},set:function(e){this._layerScaleRangeVisibilityDirty!==e&&(this._layerScaleRangeVisibilityDirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"updating",{get:function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},enumerable:!0,configurable:!0}),i.prototype.setup=function(e,i,t,a,r){var l=this;this.layerView=e,this.layer=i,this.queryGraphicUIDsInExtent=t,this.graphicsCore=a,this.basemapTerrain=r,this.updateScaleRangeActive();var n=this.layerView.view.resourceController.scheduler;this.handles.add(n.registerTask(6,function(){return l.update()},function(){return l.needsUpdate()}))},i.prototype.destroy=function(){this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null),this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null},i.prototype.needsUpdate=function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},i.prototype.setExtent=function(e){this.extent=e,this.layerScaleRangeVisibilityDirty=!0},i.prototype.update=function(){this.updateSuspendScaleVisible(),this.layerScaleRangeVisibilityDirty=!1},i.prototype.scaleRangeActive=function(){return this._scaleRangeActive},i.prototype.updateScaleRangeActive=function(){var e=this,i=this.layer,t=s(i.minScale,i.maxScale);i.labelingInfo&&!t&&(t=i.labelingInfo.some(function(e){return e&&s(e.minScale,e.maxScale)}));var a=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.scaleChangeEventHandle&&this.basemapTerrain?this.scaleChangeEventHandle=this.basemapTerrain.on("scale-change",function(i){return e.scaleUpdateHandler(i)}):!t&&this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null),a},i.prototype.updateSuspendScaleVisibleFinish=function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e)},i.prototype.updateSuspendScaleVisible=function(){var e=this,i=this.layerView.view.basemapTerrain;this.extent&&i&&this._scaleRangeActive?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,i.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,function(i){return e.updateSuspendScaleVisibleFinish(i)})):this.updateSuspendScaleVisibleFinish(!0)},i.prototype.visibleAtScale=function(e,i,t){return null==e||e>t&&(!i||e<i)},i.prototype.visibleAtLayerScale=function(e){return this.visibleAtScale(e,this.layer.minScale,this.layer.maxScale)},i.prototype.visibleAtLabelScale=function(e,i){return this.visibleAtScale(e,i.minScale,i.maxScale)},i.prototype.graphicScale=function(e){var i;if(e.centroid?i=e.centroid:"point"===e.graphic.geometry.type&&(i=e.graphic.geometry),i){return this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(i):1}return null},i.prototype.graphicVisible=function(e){var i=this.graphicScale(e);return this.visibleAtLayerScale(i)},i.prototype.updateVisibility=function(e){if(this._scaleRangeActive){var i=this.graphicVisible(e);return e.setVisibilityFlag(1,i,0)}return!1},i.prototype.updateGraphicLabelScaleVisibility=function(e){if(!this._scaleRangeActive)return!1;if(!e._labelGraphics||0===e._labelGraphics.length)return!1;var i=this.graphicScale(e),t=this.updateLabelScaleVisibility(e,i);return t&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),t},i.prototype.updateLabelScaleVisibility=function(e,i){if(!e._labelGraphics||0===e._labelGraphics.length)return!1;var t=e._labelGraphics[0],a=t._labelClass;if(a&&null!=a.minScale&&null!=a.maxScale){var r=this.visibleAtLabelScale(i,a);if(e.setVisibilityFlag(1,r,1))return!0}return!1},i.prototype.scaleUpdateHandler=function(e){var i=this;if(!this.layerView.suspended){var t=e.extent,a=e.scale,r=this.visibleAtLayerScale(a),l=!1;this.queryGraphicUIDsInExtent(t,e.spatialReference,function(e){var n=i.graphicsCore.getGraphics3DGraphicById(e);if(n){var s=n.centroid;if(s&&(t[0]>s.x||t[1]>s.y||t[2]<s.x||t[3]<s.y))return;var c=!1;n.setVisibilityFlag(1,r,0)&&(c=!0),i.updateLabelScaleVisibility(n,a)&&(c=!0),c&&(l=!0)}}),l&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}this.layerScaleRangeVisibilityDirty=!0},i.prototype.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&(this._scaleRangeActive?this.graphicsCore.updateAllGraphicsVisibility():this.graphicsCore.forEachGraphics3DGraphic(function(e){return e.clearVisibilityFlag(1)})),this.layerScaleRangeVisibilityDirty=!0},a([n.property({readOnly:!0})],i.prototype,"suspended",void 0),a([n.property({readOnly:!0})],i.prototype,"updating",null),i=a([n.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],i)}(n.declared(r))});