// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../geometry","../../../../core/Accessor","../../../../core/Handles","../../../../core/Logger","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Polygon","../../../../geometry/support/jsonUtils","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/data/FeatureStore","../../../../layers/graphics/data/QueryEngine"],function(e,t,r,i,n,o,s,a,u,y,h,d,l,c,p,g){Object.defineProperty(t,"__esModule",{value:!0});var _=a.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility"),f=function(e){function t(t){var r=e.call(this)||this;return r._dirty=!1,r._querying=!1,r._handles=new s,r}return r(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this._dirty||this._querying||null!=this._queryResult},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureGeometryType",{get:function(){switch(this.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.geometryType;case"mesh":case"extent":return"polygon"}},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t){var r=this;this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,e.layer.timeInfo&&(this._timeInfo=e.layer.timeInfo.toJSON()),this._scheduler=this._layerView.view.resourceController.scheduler,this._handles.add(this._scheduler.registerTask(4,function(e){return r._update(e)},function(){return r._needsUpdate()})),this._handles.add(u.on(t.owner,"loadedGraphics","change",function(e){return r._graphicsChanged(e)},function(){return r.dirty=!0}))},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null},t.prototype.clear=function(){this._queryEngine&&(this._queryEngine.destroy(),this._queryEngine=null,this._queryResult=null,this._store=null,this._querying=!1,this._core.forEachGraphics3DGraphic(function(e){return e.clearVisibilityFlag(2)})),this.dirty=!1,this.notifyChange("updating")},t.prototype._graphicsChanged=function(e){if(!this._queryEngine)return void(this.dirty=!0);if(e.removed&&e.removed.length>0){for(var t=new Array(e.removed.length),r=0;r<e.removed.length;++r)t[r]=e.removed[r].uid;this._store.removeManyById(t)}if(e.added&&e.added.length>0){for(var i=new Array(e.added.length),r=0;r<e.added.length;++r)i[r]=this._convertToOptimizedFeature(e.added[r]);this._store.addMany(i),this.dirty=!0}},t.prototype.updateVisibility=function(e){this._queryEngine&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)},t.prototype.filterChanged=function(){this.dirty=!0},Object.defineProperty(t.prototype,"active",{get:function(){return this._layerView.filter&&this._core.owner.loadedGraphics.length>0},enumerable:!0,configurable:!0}),t.prototype._ensureQueryEngine=function(e){var t=this;if(!this.active)return this.clear(),!1;if(this._queryEngine)return!0;var r,i=this._core.owner.loadedGraphics,o=n.featureGeometryTypeKebabDictionary.toJSON(this.featureGeometryType),s=new Array(i.length),a=0;return i.forEach(function(e){s[++a]=t._convertToOptimizedFeature(e),r=r||e.geometry.spatialReference}),this._store=new p.default({geometryType:o,hasM:!1,hasZ:!1}),this._store.addMany(s),this._queryEngine=new g.default({hasZ:!1,hasM:!1,geometryType:o,fields:[],timeInfo:this._timeInfo,spatialReference:r,objectIdField:this._objectIdField,featureStore:this._store,scheduler:this._scheduler,priority:4}),e.madeProgress(),!0},t.prototype._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult},t.prototype._update=function(e){var t=this;if(!this._ensureQueryEngine(e))return void(this.dirty=!1);if(this._dirty&&!this._querying&&!e.done){this._querying=!0,this.dirty=!1;var r=this._layerView.filter?this._layerView.filter.toJSON():{};this._queryEngine.executeQueryForIdSet(r).then(function(e){t._queryResult=e,t._querying=!1}).catch(function(e){_.warn("FeatureFilter query failed: "+e),t._queryResult=new Set,t._core.forEachGraphics3DGraphic(function(e){return t._queryResult.add(t._getFeatureId(e.graphic)),!1}),t._querying=!1}),e.madeProgress()}this._queryResult&&!e.done&&(this._core.forEachGraphics3DGraphic(function(r){if(e.done)return!1;var i=t._queryResult.has(t._getFeatureId(r.graphic));return!!r.setVisibilityFlag(2,i,0)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null)),this.notifyChange("updating")},t.prototype._convertToOptimizedFeature=function(e){var t=e.geometry;if("mesh"===t.type||"extent"===t.type){var r=h.fromExtent("mesh"===t.type?t.extent:t);return r.hasZ=!1,r.hasM=!1,new c.default(l.convertFromGeometry(r),e.attributes,null,this._getFeatureId(e))}return l.convertFromFeature(e,d.getJsonType(e.geometry),!1,!1,this._objectIdField)},t.prototype._getFeatureId=function(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId},Object.defineProperty(t.prototype,"dirty",{set:function(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),i([y.property({readOnly:!0})],t.prototype,"updating",null),i([y.property({constructOnly:!0})],t.prototype,"geometryType",void 0),i([y.property({readOnly:!0,dependsOn:["geometryType"]})],t.prototype,"featureGeometryType",null),t=i([y.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],t)}(y.declared(o));t.Graphics3DFilterVisibility=f});