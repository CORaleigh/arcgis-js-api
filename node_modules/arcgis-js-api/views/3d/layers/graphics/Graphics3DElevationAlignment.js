// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Handles","../../../../core/PooledArray","../../../../core/accessorSupport/decorators","../../../../geometry/support/aaBoundingRect"],function(t,e,r,i,n,s,a,o,h){var p=function(){function t(){this.extents=new a({allocator:function(t){return t||h.create()}}),this.tempExtent=h.create(),this.dirty=!1}return Object.defineProperty(t.prototype,"length",{get:function(){return this.extents.length},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.extents.clear()},t.prototype.add=function(t){this.contains(t)||(this.removeContained(t),h.set(this.extents.pushNew(),t),this.dirty=!0)},t.prototype.pop=function(){return this.dirty&&(this.mergeTight(),this.dirty=!1),this.extents.pop()},t.prototype.mergeTight=function(){for(var t=this.extents,e=this.tempExtent,r=!1;!r;){r=!0;for(var i=0;i<t.length;++i)if(function(r){for(var i=t.data[r],n=h.area(i),s=!1,a=t.length-1;a>r;--a){var o=t.data[a],p=h.area(o);h.expand(i,o,e);var u=n+p;(h.area(e)-u)/u<.05&&(h.set(i,e),n=h.area(i),t.swapElements(a,t.length-1),t.pop(),s=!0)}return s}(i)){r=!1;break}}},t.prototype.contains=function(t){return this.extents.some(function(e){return h.contains(e,t)})},t.prototype.removeContained=function(t){for(var e=this.extents.length-1;e>=0;--e)h.contains(t,this.extents.data[e])&&this.extents.removeUnorderedIndex(e)},t}();return function(t){function e(){var e=t.call(this)||this;return e.dirtyExtents=new p,e.globalDirty=!1,e.dirtyGraphicsQueue=new a({deallocator:null}),e.handles=new s,e.updateElevation=!1,e.layerView=null,e.graphicsCore=null,e}return r(e,t),Object.defineProperty(e.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0}),e.prototype.setup=function(t,e,r,i){var n=this;this.layerView=t,this.queryGraphicUIDsInExtent=e,this.graphicsCore=r,this.elevationProvider=i;var s=this.layerView.view.resourceController.scheduler;this.handles.add([i.on("elevation-change",function(t){return n.elevationUpdateHandler(t)}),this.layerView.watch("suspended",function(){return n.suspendedChange()}),s.registerTask(12,function(t){return n.update(t)},function(){return n.needsUpdate()})])},e.prototype.destroy=function(){this.dirtyGraphicsQueue=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},e.prototype.clear=function(){this.dirtyGraphicsQueue.clear(),this.notifyChange("updating")},e.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},e.prototype.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},e.prototype.needsUpdate=function(){return this.dirtyGraphicsQueue.length>0||this.dirtyExtents.length>0||this.globalDirty},e.prototype.update=function(t){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,t.madeProgress());this.needsUpdate()&&!t.done;)this._updateDirtyGraphics(t),this._updateDirtyExtents(t);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},e.prototype._updateDirtyGraphics=function(t){for(var e=this.layerView.view,r=this.graphicsCore.stageLayer.id,i=this.layerView.labeling;this.dirtyGraphicsQueue.length>0&&!t.done;){for(var n=Math.min(this.dirtyGraphicsQueue.length,100);n--&&!t.done;){var s=this.dirtyGraphicsQueue.pop(),a=this.graphicsCore.getGraphics3DGraphicById(s);a&&a.alignWithElevation(this.elevationProvider,e.renderCoordsHelper),t.madeProgress()}e._stage.processDirtyLayer(r),i&&i.processStageDirty()}},e.prototype._updateDirtyExtents=function(t){for(var e=this;this.dirtyExtents.length>0&&this.dirtyGraphicsQueue.length<100&&!t.done;){var r=this.dirtyExtents.pop();this.queryGraphicUIDsInExtent(r,this.spatialReference,function(t){var r=e.graphicsCore.getGraphics3DGraphicById(t);r&&r.needsElevationUpdates()&&e.dirtyGraphicsQueue.push(t)}),t.madeProgress()}},e.prototype.markAllGraphicsElevationDirty=function(){var t=this;this.dirtyExtents.clear(),this.dirtyGraphicsQueue.clear(),this.graphicsCore.graphics3DGraphics.forEach(function(e,r){return t.dirtyGraphicsQueue.push(r)})},e.prototype.elevationUpdateHandler=function(t){var e=t.extent;if(this.layerView.suspended){if(!this.updateElevation){var r=this.graphicsCore.computedExtent;r&&e[2]>r.xmin&&e[0]<r.xmax&&e[3]>r.ymin&&e[1]<r.ymax&&(this.updateElevation=!0)}}else e[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(e),this.spatialReference=t.spatialReference,this.notifyChange("updating")},i([o.property({readOnly:!0})],e.prototype,"updating",null),e=i([o.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],e)}(o.declared(n))});