// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/Version","../../../../geometry/support/aaBoundingBox","../../support/imageUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,r,t,n,a,i,s,o,u,l,c,p,f,d,m,v,g,x){function y(e,r){return a(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return[4,h(e,r.streamDataSupplier)];case 1:return t=n.sent(),[2,A(t,r)]}})})}function h(e,r){if(r){var t=r.request(e,"json");return c.create(function(e,r){t.then(function(r){e(r.data)},function(e){r(e instanceof i?e:b(e.url))})},function(){r.cancelRequest(t)})}var n=s(e);return c.create(function(e,r){n.then(function(r){e(r.data)},function(e){r(e instanceof i?e:b(e))})},function(){n.cancel()})}function b(e){return new o("","Request for object resource failed: "+e)}function w(e){var r=e.params,t=r.topology,n=!0;switch(r.vertexAttributes||(j.warn("Geometry must specify vertex attributes"),n=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var a=r.faces;if(a){if(r.vertexAttributes)for(var i in r.vertexAttributes){var s=a[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(j.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),n=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(j.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),n=!1)):(j.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),n=!1)}}else j.warn("Indexed geometries must specify faces"),n=!1;break;default:j.warn("Unsupported topology '"+t+"'"),n=!1}e.params.material||(j.warn("Geometry requires material"),n=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(j.warn("Geometries with externally defined attributes are not yet supported"),n=!1)}return n}function A(e,r){return a(this,void 0,void 0,function(){var t,a,i,s,o,l,c,f,d,g,y,h,b,A,j,q,B,E,O,C,D,S,G,R,V,H,_,z,F,L,J,K,N,Q;return n(this,function(n){switch(n.label){case 0:return t=[],a=[],i=[],s=[],o=p.Version.parse(e.version||"1.0","wosr"),k.validate(o),l="meshsymbol_"+e.model.name,c=e.textureDefinitions,[4,I(l,c,r)];case 1:f=n.sent();for(d in f)s.push(f[d].engineTexObj);for(g=e.model.geometries,y=e.materialDefinitions,h=0,b=0;b<g.length;b++)if(A=g[b],w(A)){j=T(A),q=A.params.vertexAttributes,B={};for(E in q)O=q[E],C=O.values,B[E]={data:C,size:O.valuesPerElement};if(D={},"PerAttributeArray"===A.params.topology){S=B.position.data.length/B.position.size,G=P(S);for(R in B)D[R]=G}else{V=A.params.faces;for(H in V)D[H]=new Uint32Array(V[H].values)}_=j.texture?f[j.texture]:null,z=i[j.material]?i[j.material][j.texture]:null,z||(F=j.material.substring(j.material.lastIndexOf("/")+1),L=y[F].params,1===L.transparency&&(L.transparency=0),J=_&&_.alphaChannelUsage,K=L.transparency>0||"transparency"===J||"maskAndTransparency"===J,N={ambient:L.diffuse,diffuse:L.diffuse,specular:[0,0,0],opacity:1-(L.transparency||0),transparent:K,textureAlphaMode:_?M(_.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:_?_.engineTexObj.id:void 0,textureInitTransparent:!0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:L.externalColorMixMode||"tint",textureAlphaPremultiplied:!0},r&&r.materialParamsMixin&&u.mixin(N,r.materialParamsMixin),z=new x(N,l),i[j.material]||(i[j.material]={}),i[j.material][j.texture]=z),a.push(z),Q=new m(new v(B,D),l),h+=D.position?D.position.length:0,t.push(Q)}return[2,{stageResources:{textures:s,materials:a,geometries:t},pivotOffset:e.model.pivotOffset,boundingBox:U(t),numberOfVertices:h,lodThreshold:null}]}})})}function U(e){var r=f.empty();return e.forEach(function(e){var t=e.boundingInfo;f.expand(r,t.getBBMin()),f.expand(r,t.getBBMax())}),r}function I(e,r,t){return a(this,void 0,void 0,function(){var a,i,s,o,u,l,p,f;return n(this,function(n){switch(n.label){case 0:a=[],i=function(n){var i=r[n],s=i.images[0].data;if(!s)return j.warn("Externally referenced texture data is not yet supported"),"continue";var o=i.encoding+";base64,"+s,u="/textureDefinitions/"+n,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},p=t&&t.disableTextures?c.resolve(null):d.requestImage(o);a.push(p.then(function(r){return{refId:u,engineTexObj:new g(r,e,l),alphaChannelUsage:"rgba"===i.channels?i.alphaChannelUsage||"transparency":"none"}}))};for(s in r)i(s);return[4,c.all(a)];case 1:for(o=n.sent(),u={},l=0,p=o;l<p.length;l++)f=p[l],u[f.refId]=f;return[2,u]}})})}function M(e){switch(e){case"mask":return"mask";case"maskAndTransparency":return"maskBlend";case"none":return"opaque";case"transparency":default:return"blend"}}function T(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function P(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}Object.defineProperty(r,"__esModule",{value:!0});var j=l.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");r.load=y,r.createStageResources=A;var k=new p.Version(1,2,"wosr")});