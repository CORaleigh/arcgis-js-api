// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Handles","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/LabelClass","../../../../layers/support/labelFormatUtils","../../../../support/arcadeUtils","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./graphicSymbolUtils","./labelPlacement","../../support/debugFlags","../../webgl-engine/Stage","../../webgl-engine/lib/Layer","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas"],function(e,t,a,l,s,r,i,n,o,c,h,u,b,p,d,y,f,g,v,x,C,m,T){Object.defineProperty(t,"__esModule",{value:!0});var L=i.getLogger("esri.views.3d.layers.graphics.Labeler"),D=function(e){function t(t){var a=e.call(this)||this;return a.idHint="__labeler",a._dirty=!1,a.labels={},a.labelsToAdd={},a.labelsToRemove={},a.labelingContexts=[],a}return a(t,e),t.prototype.setup=function(){var e=this;this.handles||(this.handles=new r,this.handles.add([this.view.watch("state.camera",function(){return e.setDirty()}),this.view.watch("pixelRatio",function(){return e.resetAllLabels()})])),this.textTextureAtlas||(this.textTextureAtlas=new T.default(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new x(this.view._stage),this.calloutMaterialCollection=new x(this.view._stage));var t=this.view.resourceController.scheduler;this.handles.add(t.registerTask(8,function(t){return e.update(t)},function(){return e.needsUpdate()}))},t.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null),this.labelingContexts=[],this.labels={},this.labelsToAdd={},this.labelsToRemove={}},t.prototype.isActiveLabelingContext=function(e){return e.active&&this.labelsEnabled(e)},t.prototype.activateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]=a,a.graphics3DGraphic.setVisibilityFlag(0,!0,1)}e.active=!0},t.prototype.deactivateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];a.graphics3DGraphic.setVisibilityFlag(0,!1,1),a.rendered&&(this.labelsToRemove[t]=e.labels[t]),delete this.labels[t],delete this.labelsToAdd[t]}e.active=!1},t.prototype.addLabelTextureToAtlas=function(e){for(var t=0;t<e.graphics3DGraphic._labelGraphics.length;t++){var a=e.graphics3DGraphic._labelGraphics[t];if(a._labelClass){var l=e.textRenderers[a._labelIndex];l&&this.textTextureAtlas.addTextTexture(l,a.stageObject)}}e.rendered=!0},t.prototype.removeLabelTextureFromAtlas=function(e){for(var t=e.graphics3DGraphic,a=0;a<t._labelGraphics.length;a++){var l=t._labelGraphics[a];if(l._labelClass){var s=e.textRenderers[l._labelIndex];s&&this.textTextureAtlas.removeTextTexture(s,t._labelGraphics[a].stageObject)}}e.rendered=!1},t.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty},t.prototype.update=function(e){var t=null!=e;this._dirty=!1;for(var a=!1,l=0,s=this.labelingContexts;l<s.length;l++){var r=s[l];if(this.isActiveLabelingContext(r)){if(!this.hasValidLabelClassContext(r)){if(this.hasInvalidLabelClassContext(r)){this.deactivateLabelingContext(r);continue}if(this.createLabelClassContext(r),this.hasPendingLabelClassContext(r)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(r))continue}for(var i in r.labelsToInitialize){var n=r.labelsToInitialize[i];if(this.ensureGraphics3DResources(n)&&(this.labels[i]=n,a=!0),(n.visible&&n.hasTextTextureResources||!n.visible&&n.hasGraphics3DResources)&&delete r.labelsToInitialize[i],t&&(e.madeProgress(),e.done))return void(this._dirty=!0)}}}t&&a&&this.view.deconflictor.setDirty();for(var i in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[i]),delete this.labelsToRemove[i];for(var i in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[i]),delete this.labelsToAdd[i]},t.prototype.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()},t.prototype.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},t.prototype.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},t.prototype.createLabelClassContext=function(e){var t=this;return e.labelClassPromise?e.labelClassPromise:(e.labelClassPromise=e.layer.when(function(){e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();var a=e.graphics3DCore,l=a.layer.labelingInfo&&a.layer.labelingInfo.filter(function(e){return!!e.symbol});if(!l||0===l.length)return null;if(l.some(function(e){return u.hasGeometryOperations(e)}))return L.warn('Label expressions with arcade geometry operations are not supported. Labels for layer "'+e.layer.title+'" will not display '),null;var s=new Array(l.length),r=l.map(function(e,l){var r=e.symbol,i=d.getGraphics3DSymbol(a.getOrCreateGraphics3DSymbol(r)),n=null;return b.isCalloutSupport(r)&&r.hasVisibleCallout()&&(n=p.make(r,a.symbolCreationContext)),s[l]={labelClass:e,graphics3DSymbol:i,graphics3DCalloutSymbolLayer:n,options:h.getLabelingOptions(e),calloutSymbolLayerIndex:0,textRenderParameters:t.createTextRenderParameters(i.symbol)},i});return n.all(r).then(function(){return s})}).then(function(t){t&&(e.labelClassContexts=t)}).catch(function(){e.labelClassContexts=null}),e.labelClassPromise)},t.prototype.createTextRenderParameters=function(e){var t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?m.default.fromSymbol(t,this.view.pixelRatio):null},t.prototype.destroyLabelClassContext=function(e){for(var t=0,a=e.labelClassContexts;t<a.length;t++){var l=a[t];--l.graphics3DSymbol.referenced,l.graphics3DSymbol=null}e.labelClassContexts=[],e.labelClassPromise=null},t.prototype.createLabelText=function(e,t,a,l){if(!c.evaluateWhere(t.where,e.attributes))return null;var s=t.getLabelExpression();return s.expression?h.buildLabelText(s.expression,e,l.fields,a):null},t.prototype.createTextSymbolGraphic=function(e,t,a,l,s){var r={text:e.text,centerOffset:a.centerOffset,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,anchor:a.anchor,centerOffsetUnits:a.centerOffsetUnits,verticalOffset:a.verticalOffset,debugDrawBorder:f.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return G.graphic=t,G.renderingInfo=null,G.layer=l,s.createLabel(G,r,this.hudMaterialCollection,this.textTextureAtlas)},t.prototype.createLineCalloutGraphic=function(e,t,a,l,s){var r={symbol:t,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return G.graphic=e,G.renderingInfo=r,G.layer=s,a.createGraphics3DGraphic(G)},t.prototype.ensureGraphics3DResources=function(e){var t=e.graphics3DGraphic;if(t.destroyed)return!1;if(e.hasGraphics3DResources)return!1;this.ensureTextTextureResources(e);var a=e.labelingContext,l=!1,s=t.graphic,r=a.labelClassContexts,i=a.layer,n=this.labelsEnabled(a);if(!r||0===r.length||!t._graphics[0])return!1;for(var o=0;o<r.length;o++){var c=r[o],h=c.labelClass,u=e.textRenderers[o];if(u){var b=c.graphics3DSymbol,p=null;b.symbol&&"label-3d"===b.symbol.type&&(p=b.symbol);var d=b.childGraphics3DSymbols[0],f=y.get({graphics3DGraphic:t,labelSymbol:p,labelClass:c.labelClass});if(d&&f){var g=this.createTextSymbolGraphic(u,s,f,i,d);if(!g)return!1;if(g._labelClass=h,g._labelIndex=o,t.addLabelGraphic(g,a.stageLayer,this.view._stage),a.spatialIndex&&a.spatialIndex.add(t),t.setVisibilityFlag(0,n,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),l=!0,c.graphics3DCalloutSymbolLayer&&f.hasLabelVerticalOffset){var v=this.createLineCalloutGraphic(s,p,c.graphics3DCalloutSymbolLayer,f,i);v&&(c.calloutSymbolLayerIndex=t._labelGraphics.length,t.addLabelGraphic(v,a.stageLayer,this.view._stage))}break}}}return a.scaleVisibility&&l&&a.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},t.prototype.destroyGraphics3DResources=function(e){e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},t.prototype.ensureTextTextureResources=function(e){if(!e.hasTextTextureResources){var t=e.labelingContext,a=e.graphics3DGraphic,l=t.labelClassContexts,s=t.layer,r=a.graphic;if(l&&0!==l.length){for(var i=0;i<l.length;i++){var n=l[i];if(e.textRenderers[i]=null,n.textRenderParameters){var o=n.labelClass,c=n.options,h=this.createLabelText(r,o,c,s);h&&(e.textRenderers[i]=new C.default(h,n.textRenderParameters))}}e.hasTextTextureResources=!0}}},t.prototype.destroyTextTextureResources=function(e){e.textRenderers=[],e.hasTextTextureResources=!1},t.prototype.addGraphic=function(e,t){var a={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},l=t.graphic.uid;e.labels[l]=a,this.isActiveLabelingContext(e)&&this.hasValidLabelClassContext(e)&&this.ensureGraphics3DResources(a)?this.labels[l]=a:e.labelsToInitialize[l]=a;var s=e.graphics3DCore.asyncUpdates;this.setDirty(s),this.view.deconflictor.setDirty()},t.prototype.removeGraphic=function(e,t){var a=t.graphic.uid,l=e.labels[a];if(l){this.labels[a]&&(this.removeLabelTextureFromAtlas(l),delete this.labels[a],delete this.labelsToAdd[a],delete this.labelsToRemove[a]),l.hasTextTextureResources&&this.destroyTextTextureResources(l),l.hasGraphics3DResources&&this.destroyGraphics3DResources(l),delete e.labels[a],delete e.labelsToInitialize[a];var s=e.graphics3DCore.asyncUpdates;this.setDirty(s),this.view.deconflictor.setDirty()}},t.prototype.labelsEnabled=function(e){return!0===e.layer.labelsVisible&&null!=e.layer.labelingInfo&&e.layer.labelingInfo.length>0},t.prototype.labelingInfoChange=function(e,t){if(t){for(var a=0,l=t;a<l.length;a++){var s=l[a],r=e.labels[s];r&&(this.removeGraphic(e,r.graphics3DGraphic),this.addGraphic(e,r.graphics3DGraphic))}return n.create(function(e){return!0})}return this.visibilityInfoChange(e),this.resetLabels(e),this.createLabelClassContext(e)},t.prototype.globalPropertyChanged=function(e,t){for(var a=0,l=t.labelClassContexts;a<l.length;a++){var s=l[a];!function(a){var l=new Map;for(var s in t.labels){var r=t.labels[s],i=r.graphics3DGraphic;l.set(i.graphic.uid,i)}var n=function(e){return e._labelGraphics[0]};if(a.graphics3DSymbol.childGraphics3DSymbols[0].globalPropertyChanged(e,l,n),a.graphics3DCalloutSymbolLayer){var o=function(e){return e._labelGraphics[a.calloutSymbolLayerIndex]};a.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,o)}}(s)}},t.prototype.visibilityInfoChange=function(e){var t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e);var a=e.graphics3DCore.asyncUpdates;this.setDirty(a)},t.prototype.resetAllLabels=function(){for(var e=0,t=this.labelingContexts;e<t.length;e++){var a=t[e];this.resetLabels(a)}},t.prototype.resetLabels=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]&&(this.removeLabelTextureFromAtlas(a),delete this.labels[t],delete this.labelsToAdd[t],delete this.labelsToRemove[t]),a.hasTextTextureResources&&this.destroyTextTextureResources(a),a.hasGraphics3DResources&&this.destroyGraphics3DResources(a),a.visible=!1,a.rendered=!1,e.labelsToInitialize[t]=a}this.destroyLabelClassContext(e);var l=e.graphics3DCore.asyncUpdates;this.setDirty(l),this.view.deconflictor.setDirty()},t.prototype.findLabelingContext=function(e){for(var t=0,a=this.labelingContexts;t<a.length;t++){var l=a[t];if(l.graphics3DCore===e)return l}return null},t.prototype.addGraphicsOwner=function(e,t,a){var l=this;if(!this.findLabelingContext(e)){var s=e.layer,r={graphics3DCore:e,layer:s,scaleVisibility:t,spatialIndex:a,active:e.layer.labelsVisible,labelClassPromise:null,labelClassContexts:[],labels:{},labelsToInitialize:{},stageLayer:new v(this.idHint+"_"+s.uid,{isPickable:!0},s.uid)};return this.view._stage.add(g.ModelContentType.LAYER,r.stageLayer),this.view._stage.addToViewContent([r.stageLayer.id]),this.labelingContexts.push(r),this.setDirty(),{addGraphic:function(e){return l.addGraphic(r,e)},removeGraphic:function(e){return l.removeGraphic(r,e)},featureReductionChange:function(){},layerLabelsEnabled:function(){return l.labelsEnabled(r)},labelingInfoChange:function(e){return l.labelingInfoChange(r,e)},elevationInfoChange:function(){return l.globalPropertyChanged("elevationInfo",r)},slicePlaneEnabledChange:function(){return l.globalPropertyChanged("slicePlaneEnabled",r)},visibilityInfoChange:function(){return l.visibilityInfoChange(r)},reset:function(){return l.resetLabels(r)},clear:function(){},processStageDirty:function(){return l.view._stage.processDirtyLayer(r.stageLayer.id)}}}},t.prototype.removeGraphicsOwner=function(e){var t=this.findLabelingContext(e);if(t){var a=this.labelingContexts.indexOf(t);this.labelingContexts.splice(a,1);for(var l in t.labels)this.removeGraphic(t,t.labels[l].graphics3DGraphic);var s=t.stageLayer.id;this.view._stage.removeFromViewContent([s]),this.view._stage.remove(g.ModelContentType.LAYER,s),t.stageLayer=null,this.setDirty()}},t.prototype.setLabelGraphicVisibility=function(e,t){var a=e.graphic.uid,l=this.labels[a];if(l){t&&!l.rendered?(this.labelsToAdd[a]=l,l.hasTextTextureResources||(l.labelingContext.labelsToInitialize[a]=l)):!t&&l.rendered&&(this.labelsToRemove[a]=l),l.visible=t;var s=l.labelingContext.graphics3DCore.asyncUpdates;this.setDirty(s)}},Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(e){void 0===e&&(e=!0),this._dirty=!0,e||this.update(null)},Object.defineProperty(t.prototype,"updating",{get:function(){return this.labelingContexts.some(function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{textTextureAtlas:this.textTextureAtlas}},enumerable:!0,configurable:!0}),l([o.property({constructOnly:!0})],t.prototype,"view",void 0),l([o.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=l([o.subclass()],t)}(o.declared(s));t.Labeler=D;var G={graphic:null,renderingInfo:null,layer:null}});