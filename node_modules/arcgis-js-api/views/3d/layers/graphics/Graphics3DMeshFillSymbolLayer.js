// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../Color","../../../../Color","../../../../core/compilerUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/MeshComponent","../../../../geometry/support/webMercatorUtils","../../../../geometry/support/meshUtils/projection","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","../support/edgeUtils","../support/symbolColorUtils","../../support/debugFlags","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Texture","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/NativeLineMaterial"],function(e,t,r,a,o,n,i,s,l,c,u,p,m,f,h,d,g,v,_,y,x,b,C,T,A,O,M,w,S,N,E,I,P){Object.defineProperty(t,"__esModule",{value:!0});var F=E.VertexAttrConstants,R=function(e){function t(t,r,a,o){var n=e.call(this,t,r,a,o)||this;return n._edgeStageObjects=new Set,n._materials={},n._textures={},T.DRAW_MESH_GEOMETRY_NORMALS&&(n._debugVertexNormalMaterial=new P({color:[1,0,1,1]},"debugVertexNormal"),n._debugFaceNormalMaterial=new P({color:[0,1,1,1]},"debugFAceNormal")),n.resolve(),n}return r(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject();for(var t in this._materials){var r=this._materials[t];this._context.stage.remove(O.ModelContentType.MATERIAL,r.material.id)}for(var t in this._textures){var a=this._textures[t];this._context.stage.remove(O.ModelContentType.TEXTURE,a.id)}this._materials={},this._textures={}},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("mesh"!==t.geometry.type)return this._logWarning("unsupported geometry type for fill on mesh-3d symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,a=this.getGraphicElevationContext(t),o=e.renderingInfo;return this._createAs3DShape(t,o,a,r,t.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getLayerOpacity();for(var t in this._materials){var r=this._materials[t];r.material.setParameterValues({layerOpacity:e});var a=r.material.getParameters();this._setMaterialTransparentParameter(a,r),r.material.setParameterValues({transparent:a.transparent})}if(this._edgeStageObjects.size>0){var o=this._context.stage.view.ensureEdgeView(),n=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){return o.updateAllComponentOpacities(e,[n])})}return!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,y.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;for(var a in this._materials){this._materials[a].material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})}if(this._edgeStageObjects.size>0){var o=this._context.stage.view.ensureEdgeView(),n=this._createEdgeMaterial(o);if(i.isSome(n)){var s=[n];this._edgeStageObjects.forEach(function(e){return o.updateAllComponentMaterials(e,s,{slicePlaneEnabled:r._context.slicePlaneEnabled},!1)})}}return!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype._requiresSymbolVertexColors=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._colorOrTextureUid=function(e){return e?e instanceof o?e.toHex():e.uid:"-"},t.prototype._materialProperties=function(e,t,r){var a,o,n,i,s,l,c=this._requiresSymbolVertexColors();t.material&&(o=t.material.color,a=this._colorOrTextureUid(t.material.color),n=t.material.colorTexture,i=this._colorOrTextureUid(t.material.colorTexture),s=t.material.normalTexture,l=this._colorOrTextureUid(t.material.normalTexture));var u=!!e.vertexAttributes.color,p=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:c,hasVertexColors:u,hasVertexTangents:p,color:o,colorTexture:n,normalTexture:s,uid:"vc:"+u+",vt:"+p+",vct"+r+",svc:"+c+",cmuid:"+a+",ctmuid:"+i+",ntmuid:"+l}},t.prototype._setInternalColorValueParameters=function(e,t){t.diffuse=a.toUnitRGB(e),t.opacity=e.a},t.prototype._getLoadableTextureResource=function(e){return e.data?e.data instanceof HTMLImageElement?e.data.complete?e.data:e.data.src:e.data:e.url},t.prototype._getInternalTextureId=function(e,t){var r=this._getLoadableTextureResource(e);if(r){var a=this._textures[e.uid];return a||(a=new N(r,t+"_"+e.uid+"_tex",{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0}),this._textures[e.uid]=a,this._context.stage.add(O.ModelContentType.TEXTURE,a)),a.id}},t.prototype._castTextureWrap=function(e){if(void 0===e&&(e="repeat"),"string"==typeof e){var t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}},t.prototype._castTextureWrapIndividual=function(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}},t.prototype._setInternalMaterialParameters=function(e,t,r){e.color&&this._setInternalColorValueParameters(e.color,r),e.colorTexture&&(r.textureId=this._getInternalTextureId(e.colorTexture,t)),e.hasVertexTangents&&e.normalTexture&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture,t))},t.prototype._setExternalMaterialParameters=function(e){if(this._isPropertyDriven("color"))e.externalColor=V;else{var t=this.symbolLayer.material?a.toUnitRGBA(this.symbolLayer.material.color):V;e.externalColor=t}var r=this.symbolLayer.material&&this.symbolLayer.material.colorMixMode;r&&(e.colorMixMode=r)},t.prototype._hasTransparentVertexColors=function(e){var t=e.vertexAttributes.color;if(!t)return!1;for(var r=3;r<t.length;r+=4)if(255!==t[r])return!0;return!1},t.prototype._getOrCreateMaterial=function(e,t){var r=t.material&&t.material.color,a=t.material&&t.material.colorTexture,o=this._hasTransparentVertexColors(e)||r&&r.a<1||a&&a.transparent,n=this._materialProperties(e,t,o),i=this._materials[n.uid];if(i)return i.material;var s={material:null,isComponentTransparent:o,alphaMode:t.material?t.material.alphaMode:"opaque"},l=this._getStageIdHint(),c={specular:B,vertexColors:n.hasVertexColors,symbolColors:n.hasSymbolVertexColors,vertexTangents:n.hasVertexTangents,ambient:B,diffuse:L,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:"none",layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,textureInitTransparent:!0};t.material&&(c.doubleSided=t.material.doubleSided,c.cullFace=t.material.doubleSided?"none":"back",c.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(n,l,c),this._setExternalMaterialParameters(c),this._setMaterialTransparentParameter(c,s);var u=new I(c,l+"_"+n.uid+"_mat");return s.material=u,this._materials[n.uid]=s,this._context.stage.add(O.ModelContentType.MATERIAL,u),u},t.prototype._setMaterialTransparentParameter=function(e,t){var r=this._isPropertyDriven("opacity");e.transparent=r||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?"maskBlend":"opaque":e.textureAlphaMode=t.alphaMode},t.prototype._addDebugNormals=function(e,t,r,a){for(var o,n,i,s,l=t.length,c=e.spatialReference.isWGS84?20015077/180:1,m=.1*Math.max(e.extent.width*c,e.extent.height*c,e.extent.zmax-e.extent.zmin),f=[],h=[],d=[],g=[],v=0;v<l;v++)for(var _=t[v],y=_.data.getAttribute(F.POSITION),x=_.data.getAttribute(F.NORMAL),b=_.data.getIndices(F.POSITION),C=_.data.getIndices(F.NORMAL),T=y.data,A=x.data,O=0;O<b.length;O++){for(var S=3*b[O],N=3*C[O],E=0;E<3;E++)f.push(T[S+E]);for(var E=0;E<3;E++)f.push(T[S+E]+A[N+E]*m);if(h.push(h.length),h.push(h.length),O%3==0){this._calculateFaceNormal(T,b,O,W),this._getFaceVertices(T,b,O,j,G,D),p.vec3.add(j,j,G),p.vec3.add(j,j,D),p.vec3.scale(j,j,1/3);for(var E=0;E<3;E++)d.push(j[E]);for(var E=0;E<3;E++)d.push(j[E]+W[E]*m);g.push(g.length),g.push(g.length)}}var I=(o={},o[F.POSITION]={data:new Float64Array(f),size:3},o),P=(n={},n[F.POSITION]=new Uint32Array(h),n),R=new w(I,P,void 0,"line"),L=new M(R,"debugVertexNormal");L.singleUse=!0,t.push(L),r.push(this._debugVertexNormalMaterial),a.push(u.mat4f64.clone(a[0]));var I=(i={},i[F.POSITION]={data:new Float64Array(d),size:3},i),P=(s={},s[F.POSITION]=new Uint32Array(g),s),R=new w(I,P,void 0,"line"),L=new M(R,"debugFaceNormal");L.singleUse=!0,t.push(L),r.push(this._debugFaceNormalMaterial),a.push(u.mat4f64.clone(a[0]))},t.prototype._createAs3DShape=function(e,t,r,a,o){var n=this,s=e.geometry;if("mesh"!==s.type)return null;var l=this._createGeometryInfo(s,t,a);if(!l)return null;var c=l.geometries,u=l.materials,p=l.transformations,m=l.objectTransformation;T.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(s,c,u,p);var f=new S({geometries:c,materials:u,transformations:p,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:o},idHint:a});f.objectTransformation=m;var h=function(e){var t=n._context.stage.view.ensureEdgeView();t.removeObject(e),n._edgeStageObjects.delete(e);var r=n._createEdgeMaterial(t);i.isSome(r)&&(n._edgeStageObjects.add(e),t.addObject(e,[r],{slicePlaneEnabled:n._context.slicePlaneEnabled},!n._context.isAsync,{mergeGeometries:!0}))};h(f);var d=function(e,t,r,a,o){var n=v.perObjectElevationAligner(e,t,r,a,o);return h(f),n},g=new _(this,f,c,null,null,d,r);g.needsElevationUpdates=y.needsElevationUpdates3D(r.mode);var x=s.extent.center.clone();return x.z=0,g.elevationContext.centerPointInElevationSR=x,g.alignedTerrainElevation=d(g,g.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper,this._context.featureExpressionInfoContext),g},t.prototype._createComponentNormals=function(e,t,r,a){var o=r.shading||"flat";switch(o){case"source":return this._createComponentNormalsSource(e,t,r,a);case"flat":return this._createComponentNormalsFlat(e,r,a);case"smooth":return this._createComponentNormalsSmooth(e,r,a);default:n.neverReached(o)}},t.prototype._createComponentNormalsSource=function(e,t,r,a){if(!t)return this._createComponentNormalsFlat(e,r,a);var o=!1;if(!r.trustSourceNormals)for(var n=0;n<a.length;n+=3){this._calculateFaceNormal(e,a,n,W);for(var i=0;i<3;i++){var s=3*a[n+i];j[0]=t[s+0],j[1]=t[s+1],j[2]=t[s+2],p.vec3.dot(W,j)<0&&(t[s+0]=-t[s+0],t[s+1]=-t[s+1],t[s+2]=-t[s+2],o=!0)}}return{normals:t,indices:a,didFlipNormals:o}},t.prototype._createComponentNormalsFlat=function(e,t,r){for(var a=new Float32Array(r.length),o=new Uint32Array(3*r.length),n=0;n<r.length;n+=3)for(var i=this._calculateFaceNormal(e,r,n,W),s=0;s<3;s++)a[n+s]=i[s],o[n+s]=n/3;return{normals:a,indices:o,didFlipNormals:!1}},t.prototype._createComponentNormalsSmooth=function(e,t,r){for(var a={},o=0;o<r.length;o+=3)for(var n=this._calculateFaceNormal(e,r,o,W),i=0;i<3;i++){var s=r[o+i],l=a[s];l||(l={normal:m.vec3f64.create(),count:0},a[s]=l),p.vec3.add(l.normal,l.normal,n),l.count++}for(var c=new Float32Array(3*r.length),u=new Uint32Array(3*r.length),o=0;o<r.length;o++){var s=r[o],l=a[s];1!==l.count&&(p.vec3.normalize(l.normal,l.normal),l.count=1);for(var i=0;i<3;i++)c[3*o+i]=l.normal[i];u[o]=o}return{normals:c,indices:u,didFlipNormals:!1}},t.prototype._getFaceVertices=function(e,t,r,a,o,n){var i=3*t[r+0],s=3*t[r+1],l=3*t[r+2];a[0]=e[i+0],a[1]=e[i+1],a[2]=e[i+2],o[0]=e[s+0],o[1]=e[s+1],o[2]=e[s+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2]},t.prototype._calculateFaceNormal=function(e,t,r,a){return this._getFaceVertices(e,t,r,j,G,D),p.vec3.subtract(G,G,j),p.vec3.subtract(D,D,j),p.vec3.cross(j,G,D),p.vec3.normalize(a,j),a},t.prototype._getOrCreateComponents=function(e){return e.components?e.components:k},t.prototype._createPositionBuffer=function(e){var t=e.vertexAttributes.position,r=new Float64Array(t.length),a=this._context.renderSpatialReference;return y.reproject(e.vertexAttributes.position,0,e.spatialReference,r,0,a,t.length/3),r},t.prototype._createNormalBuffer=function(e,t){var r=e.vertexAttributes.normal;if(!r)return null;if("local"===this._context.layerView.view.viewingMode)return r;var a=e.vertexAttributes.position,o=new Float32Array(r.length);return g.projectNormalToECEF(r,a,t,e.spatialReference,o)},t.prototype._createTangentBuffer=function(e,t){var r=e.vertexAttributes.tangent;if(!r)return null;if("local"===this._context.layerView.view.viewingMode)return r;var a=e.vertexAttributes.position,o=new Float32Array(r.length);return g.projectTangentToECEF(r,a,t,e.spatialReference,o)},t.prototype._createColorBuffer=function(e){return e.vertexAttributes.color},t.prototype._createSymbolColorBuffer=function(e){if(this._requiresSymbolVertexColors()){var t=this._getVertexOpacityAndColor(e),r=this.symbolLayer.material&&this.symbolLayer.material.colorMixMode||null,a=new Uint8Array(4);return C.encodeSymbolColor(t,r,a),a}return null},t.prototype._createColorIndices=function(e,t){for(var r=new Uint32Array(t.length),a=0;a<r.length;a++)r[a]=0;return r},t.prototype._createBuffers=function(e,t){var r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this._logWarning("Mesh geometry must contain position vertex attributes"),null;var a=e.vertexAttributes.normal,o=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(a&&a.length!==r.length)return this._logWarning("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/4!=r.length/3)return this._logWarning("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(o&&o.length/2!=r.length/3)return this._logWarning("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;var i=this._createPositionBuffer(e),s=this._createColorBuffer(e),l=this._createSymbolColorBuffer(t),c=this._createNormalBuffer(e,i);return{positionBuffer:i,normalBuffer:c,tangentBuffer:this._createTangentBuffer(e,i),uvBuffer:o,colorBuffer:s,symbolColorBuffer:l,objectTransformation:this._transformCenterLocal(e,i,c)}},t.prototype._transformCenterLocal=function(e,t,r){var a=e.extent.center,o=this._context.renderSpatialReference;U[0]=a.x,U[1]=a.y,U[2]=0;var n=u.mat4f64.create();A.computeLinearTransformation(e.spatialReference,U,n,o),c.mat4.invert(z,n);for(var i=0;i<t.length;i+=3)j[0]=t[i+0],j[1]=t[i+1],j[2]=t[i+2],p.vec3.transformMat4(j,j,z),t[i+0]=j[0],t[i+1]=j[1],t[i+2]=j[2];if(r){s.mat3.fromMat4(H,n),s.mat3.transpose(H,H);for(var i=0;i<r.length;i+=3)j[0]=r[i+0],j[1]=r[i+1],j[2]=r[i+2],p.vec3.transformMat3(j,j,H),r[i+0]=j[0],r[i+1]=j[1],r[i+2]=j[2]}return n},t.prototype._validateFaces=function(e,t){var r=e.vertexAttributes.position.length/3,a=t.faces;if(a){for(var o=-1,n=0;n<a.length;n++){var i=a[n];i>o&&(o=i)}if(r<=o)return this._logWarning("Vertex index "+o+" is out of bounds of the mesh position buffer"),!1}else if(r%3!=0)return this._logWarning("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0},t.prototype._getOrCreateFaces=function(e,t){if(t.faces)return t.faces;for(var r=new Uint32Array(e.vertexAttributes.position.length/3),a=0;a<r.length;a++)r[a]=a;return r},t.prototype._isOutsideClippingArea=function(e){if(!this._context.clippingExtent)return!1;var t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;var r,a=this._context.elevationProvider.spatialReference,o=t.length/3;return e.spatialReference.equals(a)?r=t:(r=new Float64Array(t.length),y.reproject(e.vertexAttributes.position,0,e.spatialReference,r,0,a,o)),y.computeBoundingBox(r,0,o,q),y.boundingBoxClipped(q,this._context.clippingExtent)},t.prototype._createGeometryInfo=function(e,t,r){var a,o;if(!d.canProject(e,this._context.layerView.view.spatialReference))return this._logWarning("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;var n=this._createBuffers(e,t);if(!n)return null;for(var i=n.positionBuffer,s=n.uvBuffer,l=n.colorBuffer,c=n.symbolColorBuffer,p=n.normalBuffer,m=n.tangentBuffer,f=n.objectTransformation,h=this._getOrCreateComponents(e),g=[],v=[],_=[],y=!1,x=0,b=h;x<b.length;x++){var C=b[x];if(!this._validateFaces(e,C))return null;var T=this._getOrCreateFaces(e,C);if(0!==T.length){var A=this._createComponentNormals(i,p,C,T);A.didFlipNormals&&(y=!0);var O=(a={},a[F.POSITION]={size:3,data:i},a[F.NORMAL]={size:3,data:A.normals},a),S=(o={},o[F.POSITION]=T,o[F.NORMAL]=A.indices,o);l&&(O[F.COLOR]={size:4,data:l},S[F.COLOR]=T),c&&(O[F.SYMBOLCOLOR]={size:4,data:c},S[F.SYMBOLCOLOR]=this._createColorIndices(C,T)),e.vertexAttributes.uv&&(O[F.UV0]={size:2,data:s},S[F.UV0]=T),e.vertexAttributes.tangent&&(O[F.TANGENT]={size:4,data:m},S[F.TANGENT]=T);var N=new w(O,S),E=new M(N,r+"_mesh");E.singleUse=!0,g.push(E),v.push(u.mat4f64.create()),_.push(this._getOrCreateMaterial(e,C))}}return y&&this._logWarning("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:g,transformations:v,materials:_,objectTransformation:f}},t.prototype._createEdgeMaterial=function(e){var t={opacity:this._getLayerOpacity()};return b.createMaterial(e,this.symbolLayer,t)},t}(x.default);t.Graphics3DMeshFillSymbolLayer=R;var L=[1,1,1],V=[1,1,1,1],B=[0,0,0],U=m.vec3f64.create(),j=m.vec3f64.create(),G=m.vec3f64.create(),D=m.vec3f64.create(),W=m.vec3f64.create(),z=u.mat4f64.create(),H=l.mat3f64.create(),q=f.create(),k=[new h];t.default=R});