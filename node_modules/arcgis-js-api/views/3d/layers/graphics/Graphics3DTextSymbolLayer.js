// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,n,i,o,a,l,s,c,d,p,u,f,h,y,v){function g(e,t,r){e&&e.forEach(function(e){var n=t(e);n&&r(n,e.graphic)})}Object.defineProperty(t,"__esModule",{value:!0});var m=[0,0,1],b=function(e){function t(t,r,n,i){var o=e.call(this,t,r,n,i)||this;if(o._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},!o._isPropertyDriven("size")){var a=p.validateSymbolLayerSize(o.symbolLayer.size);if(a)return o._logWarning(a),o.reject(),o}return o._createTextRenderParameters(),o.resolve(),o}return r(t,e),t.prototype._createTextRenderParameters=function(){var e=this._context.layerView.view.pixelRatio;this._textRenderParameters=h.default.fromSymbol(this.symbolLayer,e)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject()},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic,r=c.placePointOnGeometry(t.geometry);if(!r)return this._logWarning("unsupported geometry type for text symbol: "+t.geometry.type),null;var n=this.symbolLayer.text;if(!n)return null;var i=a.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,r,n,i)},t.prototype.createLabel=function(e,t,r,n){var i=e.graphic,o=c.placePointOnGeometry(i.geometry);if(!o)return this._logWarning("unsupported geometry type for label: "+i.geometry.type),null;var a=t.text;return a?this._createAs3DShape(i,o,a,t,t,r,n):null},t.prototype.getGraphicElevationContext=function(t,r){void 0===r&&(r=0);var n=e.prototype.getGraphicElevationContext.call(this,t);return n.addOffsetRenderUnits(r),n},t.prototype.layerOpacityChanged=function(){return this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},t.prototype.layerElevationInfoChanged=function(e,t){var r=this;return g(e,t,function(e,t){r.updateGraphicElevationContext(t,e)}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return g(e,t,function(e){for(var t=0,n=e.stageObject.geometryRecords;t<n.length;t++){n[t].material.setParameterValues({slicePlaneEnabled:r._context.slicePlaneEnabled})}}),!0},t.prototype.pixelRatioChanged=function(e,t){return!1},t.prototype.updateGraphicElevationContext=function(e,t){var r=this.getGraphicElevationContext(e,t.metadata.elevationOffset);t.elevationContext.set(r),t.needsElevationUpdates=c.needsElevationUpdates2D(r.mode)||"absolute-height"===r.mode},t.prototype._defaultElevationInfoNoZ=function(){return x},t.prototype._createAs3DShape=function(e,t,r,a,d,h,g){void 0===d&&(d=S);var b=this.getGraphicElevationContext(e,d.elevationOffset),x=this._context.layer.id+"_label_"+e.uid,O="polyline"===e.geometry.type,P=e.uid,_=this._context.stage.view.renderingContext,E=d.anchor in p.namedAnchorToHUDMaterialAnchorPos?d.anchor:"center",G=p.namedAnchorToHUDMaterialAnchorPos[E],D=n.isNone(g)?new y(_,r,this._textRenderParameters,x):null,w={occlusionTest:!0,screenOffset:d.screenOffset,anchorPos:G,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:d.centerOffsetUnits,debugDrawBorder:d.debugDrawBorder,drawInSecondSlot:!0};if(n.isSome(D)&&(w.textureId=D.id,w.texCoordScale=D.texcoordScale),n.isSome(g)&&(w.textureId=g.textureId),n.isSome(a)&&n.isSome(a.verticalOffset)){var C=a.verticalOffset,L=C.screenLength,U=C.minWorldLength,T=C.maxWorldLength;w.verticalOffset={screenLength:i.pt2px(L),minWorldLength:U||0,maxWorldLength:null!=T?T:1/0}}if(this._context.screenSizePerspectiveEnabled){var A=this._context.sharedResources,R=A.screenSizePerspectiveSettings,W=A.screenSizePerspectiveSettingsLabels;w.screenSizePerspective=W.overridePadding(this._textRenderParameters.haloSize),w.screenSizePerspectiveAlignment=R}O&&(w.shaderPolygonOffset=1e-4),w.slicePlaneEnabled=this._context.slicePlaneEnabled;var z=null,j=JSON.stringify(w);n.isSome(h)?null==(z=h.getMaterial(j))&&(z=new v(w,x),h.addMaterial(j,z)):z=new v(w,x);var H=[z],I=f.createPointGeometry(m,d.translation,void 0,n.isSome(D)?[D.displayWidth,D.displayHeight]:[0,0],d.centerOffset,n.isSome(g)?[0,0]:null),M=[new u(I,x)],N=this._context.layer.uid,V=c.createStageObjectForPoint(this._context,t,M,H,null,null,b,x,N,P,!0);if(null===V)return null;var B=l.perObjectElevationAligner,F=new s(this,V.object,M,n.isNone(h)?H:null,n.isSome(D)?[D]:null,B,b);F.alignedTerrainElevation=V.terrainElevation,F.needsElevationUpdates=c.needsElevationUpdates2D(b.mode)||"absolute-height"===b.mode;var q=n.isSome(D)?D:d,J=q.displayWidth,Z=q.displayHeight;F.getScreenSize=function(e){return void 0===e&&(e=o.vec2f64.create()),e[0]=J,e[1]=Z,e};var k={labelText:r,elevationOffset:d.elevationOffset};return F.metadata=k,c.extendPointGraphicElevationContext(F,t,this._context.elevationProvider),F},t}(d.default);t.Graphics3DTextSymbolLayer=b;var x={mode:"relative-to-ground",offset:0},S={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};t.default=b});