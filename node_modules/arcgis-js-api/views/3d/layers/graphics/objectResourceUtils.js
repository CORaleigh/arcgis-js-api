// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/lang","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/esriProvidedModelParameters","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../support/mathUtils","../../support/buffer/BufferView","../../support/buffer/math","../../support/buffer/utils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,o,a,i,n,s,u,l,c,f,d,m,p,g,v,b,x,h,w,B,T,V,M,y){function C(e,t){return void 0===t&&(t={}),a(this,void 0,void 0,function(){var r,a,n,s,u,l,c,f,d,p;return o(this,function(o){switch(o.label){case 0:return r=S(e),"wosr"!==r.fileType?[3,2]:[4,b.load(r.url,t)];case 1:return a=o.sent(),[2,{lods:[a],referenceBoundingBox:a.boundingBox}];case 2:return n=new m.DefaultLoadingContext(t.streamDataSupplier),[4,g.load(n,r.url,t)];case 3:return s=o.sent(),(_(s),I(s),u=i({},t.materialParamsMixin,{treeRendering:s.customMeta.esriTreeRendering}),null!=r.specifiedLodIndex)?(l=L(s,u,r.specifiedLodIndex),c=l[0].boundingBox,0!==r.specifiedLodIndex&&(f=L(s,u,r.specifiedLodIndex),c=f[0].boundingBox),[2,{lods:l,referenceBoundingBox:c}]):(d=L(s,u),p=d[0].boundingBox,[2,{lods:d,referenceBoundingBox:p}])}})})}function S(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function L(e,t,r){var o=e.model,a=l.mat4f64.create(),n=new Array,c=new Map,f=new Map;return o.lods.forEach(function(e,l){if(void 0===r||l===r){var m=0,p={stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:s.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:d.empty()};n.push(p),e.parts.forEach(function(r){var n=r.material+(r.attributes.normal?"_normal":"")+(r.attributes.color?"_color":"")+(r.attributes.texCoord0?"_texCoord0":"")+(r.attributes.tangent?"_tangent":""),l=o.materials.get(r.material),g=s.isSome(r.attributes.texCoord0),v=s.isSome(r.attributes.normal);if(!c.has(n)){if(s.isSome(l.textureColor)&&g&&!f.has(l.textureColor)){var b=o.textures.get(l.textureColor),x=i({},b.parameters,{preMultiplyAlpha:!0});f.set(l.textureColor,new M(b.data,l.textureColor,x))}if(s.isSome(l.textureNormal)&&g&&!f.has(l.textureNormal)){var b=o.textures.get(l.textureNormal),x=i({},b.parameters,{preMultiplyAlpha:!0});f.set(l.textureNormal,new M(b.data,l.textureNormal,x))}var C=y.COLOR_GAMMA,S=Math.pow(l.color[0],1/C),L=Math.pow(l.color[1],1/C),R=Math.pow(l.color[2],1/C);c.set(n,new y(i({transparent:"BLEND"===l.alphaMode,textureAlphaMode:A(l.alphaMode),textureAlphaCutoff:l.alphaCutoff,diffuse:[S,L,R],ambient:[S,L,R],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",vertexColors:!!r.attributes.color,vertexTangents:!!r.attributes.tangent,normals:v?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:s.isSome(l.textureColor)&&g?f.get(l.textureColor).id:void 0,colorMixMode:l.colorMixMode,normalTextureId:s.isSome(l.textureNormal)&&g?f.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:!0},t),n))}var _=N(r.indices||r.attributes.position.count,r.primitiveType),I={},E={},D=r.attributes.position.count,O=B.createBuffer(h.BufferViewVec3f,D);if(w.vec3.transformMat4(O,r.attributes.position,r.transform),E.position={data:O.typedBuffer,size:O.elementCount},I.position=_,s.isSome(r.attributes.normal)){var z=B.createBuffer(h.BufferViewVec3f,D);u.mat4.invert(a,r.transform),u.mat4.transpose(a,a),w.vec3.transformMat4(z,r.attributes.normal,a),E.normal={data:z.typedBuffer,size:z.elementCount},I.normal=_}if(s.isSome(r.attributes.tangent)){var P=B.createBuffer(h.BufferViewVec4f,D);u.mat4.invert(a,r.transform),u.mat4.transpose(a,a),w.vec4.transformMat4(P,r.attributes.tangent,a),E.aTangent={data:P.typedBuffer,size:P.elementCount},I.aTangent=_}if(s.isSome(r.attributes.texCoord0)){var U=B.createBuffer(h.BufferViewVec2f,D);B.vec2.normalizeIntegerBuffer(U,r.attributes.texCoord0),E.uv0={data:U.typedBuffer,size:U.elementCount},I.uv0=_}if(s.isSome(r.attributes.color)){var F=B.createBuffer(h.BufferViewVec4u8,D);if(4===r.attributes.color.elementCount)r.attributes.color instanceof h.BufferViewVec4f?w.vec4.scale(F,r.attributes.color,255):r.attributes.color instanceof h.BufferViewVec4u8?B.vec4.copy(F,r.attributes.color):r.attributes.color instanceof h.BufferViewVec4u16&&w.vec4.scale(F,r.attributes.color,1/256);else{B.vec4.fill(F,255,255,255,255);var H=new h.BufferViewVec3u8(F.buffer,0,4);r.attributes.color instanceof h.BufferViewVec3f?w.vec3.scale(H,r.attributes.color,255):r.attributes.color instanceof h.BufferViewVec3u8?B.vec3.copy(H,r.attributes.color):r.attributes.color instanceof h.BufferViewVec3u16&&w.vec3.scale(H,r.attributes.color,1/256)}E.color={data:F.typedBuffer,size:F.elementCount},I.color=_}var j=new T(new V(E,I),"gltf_"+e.name+"_"+m++);p.stageResources.geometries.push(j),p.stageResources.materials.push(c.get(n)),s.isSome(l.textureColor)&&g&&p.stageResources.textures.push(f.get(l.textureColor)),s.isSome(l.textureNormal)&&g&&p.stageResources.textures.push(f.get(l.textureNormal)),p.numberOfVertices+=D;var G=j.boundingInfo;d.expand(p.boundingBox,G.getBBMin()),d.expand(p.boundingBox,G.getBBMax())})}}),n}function A(e){switch(e){case"BLEND":return"blend";case"MASK":return"mask";case"OPAQUE":return"opaque";default:return"blend"}}function N(e,t){switch(t){case 4:return v.trianglesToTriangles(e);case 5:return v.triangleStripToTriangles(e);case 6:return v.triangleFanToTriangles(e)}}function R(e,t){void 0===e&&(e=""),void 0===t&&(t="");var r=n.endsWith(e,"Imposter"),o=e.split("__")[0];if(-1!==t.indexOf("/RealisticTrees/")){var a=p.treeParamsTable[o];if(a)return{crownCenter:a.center,crownDimensions:a.radius,imposter:r}}}function _(e){if(e.meta.isEsriSymbolResource){var t=function(e,t){var r=e.attributes.normal,o=e.attributes.position,a=o.count;if(!s.isNone(r)){for(var i=f.vec3f64.create(),n=f.vec3f64.create(),d=f.vec3f64.create(),m=B.createBuffer(h.BufferViewVec4u8,a),p=B.createBuffer(h.BufferViewVec3f,a),g=u.mat4.invert(l.mat4f64.create(),e.transform),v=c.vec3.transformMat4(f.vec3f64.create(),t.crownCenter,g),b=c.vec3.transformMat4(f.vec3f64.create(),t.crownDimensions,g),w=0;w<a;w++){o.getVec(w,n),r.getVec(w,i),c.vec3.subtract(d,n,v),c.vec3.divide(d,d,b);var T=x.clamp(c.vec3.length(d),0,1),V=.6+.4*T*T;c.vec3.lerp(d,d,i,.2),p.setVec(w,d),m.set(w,0,255*V),m.set(w,1,255*V),m.set(w,2,255*V),m.set(w,3,255)}e.attributes.normal=p,e.attributes.color=m}};e.model.lods.forEach(function(r){var o=R(r.name,e.meta.uri);o&&(e.customMeta.esriTreeRendering=!0,r.parts.forEach(function(e){t(e,o)}))})}}function I(e){var t=e.model.lods.length;e.meta.isEsriSymbolResource&&e.model.lods.forEach(function(e){if(!s.isSome(e.lodThreshold)){var r=(e.name||"").split("__")[0],o=e.parts.reduce(function(e,t){return e+t.attributes.position.count},0);e.lodThreshold=E(r,o,t)}})}function E(e,t,r){if(void 0===e&&(e=""),1===r)return null;if(e in p.lodThresholdLUT){var o=p.lodThresholdLUT[e].vertexCounts,a=p.lodThresholdLUT[e].thresholds,i=o.length,n=t;if(i<=1)return null;if(n<=o[0]){var s=(o[1]-o[0])/(a[1]-a[0]),u=n-o[0];return Math.max(0,a[0]+u*s)}if(n>=o[i-1]){var s=(o[i-1]-o[i-2])/(a[i-1]-a[i-2]),u=n-o[i-1];return a[i-1]+u*s}for(var l=1;l<o.length;++l){var c=o[l-1],f=o[l],d=a[l-1],m=a[l];if(n<f){var g=(n-c)/(f-c);return d*(1-g)+m*g}}}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=C,t.parseUrl=S,t.gltfToEngineResources=L});