// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../renderers/support/utils","../../support/debugFlags"],function(e,t,o,i,n,a,r,l,s,u,f){function c(e){return null!==e&&void 0!==e}function v(e){return"number"==typeof e}function p(e){return"string"==typeof e}function d(e){return null==e||p(e)}function z(e,t){e&&e.push(t),S(t)}function m(e){P&&console.warn("[FastSymbolUpdates] "+e)}function S(e){P&&console.info("[FastSymbolUpdates] "+e)}function y(e,t,o,i){void 0===i&&(i=r.mat4f64.create());var n=e||0,l=t||0,s=o||0;return 0!==n&&a.mat4.rotateZ(i,i,-n/180*Math.PI),0!==l&&a.mat4.rotateX(i,i,l/180*Math.PI),0!==s&&a.mat4.rotateY(i,i,s/180*Math.PI),i}function b(e,t,o,i,n){var a=e.minSize,r=e.maxSize;if(e.expression)return z(n,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){var l=i.symbolSize[o];return t.minSize[o]=l,t.maxSize[o]=l,t.offset[o]=t.minSize[o],t.factor[o]=0,t.type[o]=1,!0}if(c(e.field))return c(e.stops)?2===e.stops.length&&v(e.stops[0].size)&&v(e.stops[1].size)?(x(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,o),t.type[o]=1,!0):(z(n,"Could not convert size info: stops only supported with 2 elements"),!1):v(a)&&v(r)&&c(e.minDataValue)&&c(e.maxDataValue)?(x(a,r,e.minDataValue,e.maxDataValue,t,o),t.type[o]=1,!0):null!=u.meterIn[e.valueUnit]?(t.minSize[o]=-1/0,t.maxSize[o]=1/0,t.offset[o]=0,t.factor[o]=1/u.meterIn[e.valueUnit],t.type[o]=1,!0):"unknown"===e.valueUnit?(z(n,"Could not convert size info: proportional size not supported"),!1):(z(n,"Could not convert size info: scale-dependent size not supported"),!1);if(!c(e.field)){if(e.stops&&e.stops[0]&&v(e.stops[0].size))return t.minSize[o]=e.stops[0].size,t.maxSize[o]=e.stops[0].size,t.offset[o]=t.minSize[o],t.factor[o]=0,t.type[o]=1,!0;if(v(a))return t.minSize[o]=a,t.maxSize[o]=a,t.offset[o]=a,t.factor[o]=0,t.type[o]=1,!0}return z(n,"Could not convert size info: unsupported variant of sizeInfo"),!1}function x(e,t,o,i,n,a){var r=Math.abs(i-o)>0?(t-e)/(i-o):0;n.minSize[a]=r>0?e:t,n.maxSize[a]=r>0?t:e,n.offset[a]=e-o*r,n.factor[a]=r}function h(e,t,o,i){if(e.normalizationField||e.valueRepresentation)return z(i,"Could not convert size info: unsupported property"),null;if(!d(e.field))return z(i,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return z(i,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};var n;switch(e.axis){case"width":return n=b(e,t.size,0,o,i),n?t:null;case"height":return n=b(e,t.size,2,o,i),n?t:null;case"depth":return n=b(e,t.size,1,o,i),n?t:null;case"width-and-depth":return n=b(e,t.size,0,o,i),n&&b(e,t.size,1,o,i),n?t:null;case null:case void 0:case"all":return n=b(e,t.size,0,o,i),n=n&&b(e,t.size,1,o,i),n=n&&b(e,t.size,2,o,i),n?t:null;default:return z(i,'Could not convert size info: unknown axis "'+e.axis+'""'),null}}function g(e,t,o){for(var i=0;i<3;++i){var n=t.unitInMeters;1===e.type[i]&&(n*=t.modelSize[i],e.type[i]=2),e.minSize[i]=e.minSize[i]/n,e.maxSize[i]=e.maxSize[i]/n,e.offset[i]=e.offset[i]/n,e.factor[i]=e.factor[i]/n}var a;if(0!==e.type[0])a=0;else if(0!==e.type[1])a=1;else{if(0===e.type[2])return z(o,"No size axis contains a valid size or scale"),!1;a=2}for(var i=0;i<3;++i)0===e.type[i]&&(e.minSize[i]=e.minSize[a],e.maxSize[i]=e.maxSize[a],e.offset[i]=e.offset[a],e.factor[i]=e.factor[a],e.type[i]=e.type[a]);return!0}function C(e,t,o){e[4*t+0]=o.r/255,e[4*t+1]=o.g/255,e[4*t+2]=o.b/255,e[4*t+3]=o.a}function M(e,t,o){if(e.normalizationField)return z(o,"Could not convert color info: unsupported property"),null;if(p(e.field)){if(!e.stops)return z(o,"Could not convert color info: missing stops or colors"),null;if(e.stops.length>8)return z(o,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var i=e.stops,n=0;n<8;++n){var a=Math.min(n,i.length-1),r=i[a];t.color.values[n]=r.value,C(t.color.colors,n,r.color)}}else{if(!(e.stops&&e.stops.length>=0))return z(o,"Could not convert color info: no field and no colors/stops"),null;var l=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var n=0;n<8;n++)t.color.values[n]=1/0,C(t.color.colors,n,l)}return t}function V(e,t,o){if(e.normalizationField)return z(o,"Could not convert opacity info: unsupported property"),null;if(p(e.field)){if(!e.stops)return z(o,"Could not convert opacity info: missing stops or opacities"),null;if(e.stops.length>8)return z(o,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(var i=e.stops,n=0;n<8;++n){var a=Math.min(n,i.length-1),r=i[a];t.opacity.values[n]=r.value,t.opacity.opacityValues[n]=r.opacity}}else{if(!(e.stops&&e.stops.length>=0))return z(o,"Could not convert opacity info: no field and no opacities/stops"),null;var l=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(var n=0;n<8;n++)t.opacity.values[n]=1/0,t.opacity.opacityValues[n]=l}return t}function T(e,t,o,i){var n=2===o&&"arithmetic"===e.rotationType;t.offset[o]=n?90:0,t.factor[o]=n?-1:1,t.type[o]=1}function F(e,t,o){if(!p(e.field))return z(o,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return z(o,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return T(e,t.rotation,0,o),t;case"roll":return T(e,t.rotation,1,o),t;case null:case void 0:case"heading":return T(e,t.rotation,2,o),t;default:return z(o,'Could not convert rotation info: unknown axis "'+e.axis+'""'),null}}function O(e,t,i){if(!e)return null;var n=!t.supportedTypes||!!t.supportedTypes.size,a=!t.supportedTypes||!!t.supportedTypes.color,r=!t.supportedTypes||!!t.supportedTypes.rotation,l=!!t.supportedTypes&&!!t.supportedTypes.opacity;P&&(i=i||[]);var s=e.reduce(function(e,s){if(!e)return e;if(s.valueExpression)return z(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(s.type){case"size":return n?h(s,e,t,i):e;case"color":return a?M(s,e,i):e;case"opacity":return l?V(s,e,i):e;case"rotation":return r?F(s,e,i):e;default:return o.neverReached(s),null}},{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s&&s.size&&!g(s.size,t,i)?null:s:null}function E(e){return e&&null!=e.size}function w(e,t){if(D)return m("State not initialized, fast updates disabled (globally disabled)"),{enabled:!1};if(!e)return m("State not initialized, fast updates disabled (no renderer)"),{enabled:!1};if(f.DISABLE_FAST_UPDATES)return m("State not initialized, fast updates disabled (DISABLE_FAST_SYMBOL_UPDATES set)"),{enabled:!1};var o=O(e.visualVariables,t);return o?(S("State initialized, fast updates enabled"),{enabled:!0,visualVariables:o,materialParameters:I(o,t),requiresShaderTransformation:E(o)}):(m("State not initialized, fast updates disabled (conversion failed)"),{enabled:!1})}function U(e,t,o){if(!t||!e.enabled)return!1;var i=e.visualVariables,n=O(t.visualVariables,o);return n?!!(A(i.size,n.size,"size")&&A(i.color,n.color,"color")&&A(i.rotation,n.rotation,"rotation"))&&(e.visualVariables=n,e.materialParameters=I(n,o),e.requiresShaderTransformation=E(n),S("State updated"),!0):(m("State update failed (conversion failed)"),!1)}function A(e,t,o){if(!!e!=!!t)return m("State update failed ({$name} enabled/disabled)"),!1;if(e&&e.field!==t.field)return m("State update failed ({$name} field changed)"),!1;if(e&&"rotation"===o)for(var i=e,n=t,a=0;a<3;a++)if(i.type[a]!==n.type[a]||i.offset[a]!==n.offset[a]||i.factor[a]!==n.factor[a])return!1;return!0}function I(e,t){var o={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=E(e);return e&&e.size?(o.vvSizeEnabled=!0,o.vvSizeMinSize=e.size.minSize,o.vvSizeMaxSize=e.size.maxSize,o.vvSizeOffset=e.size.offset,o.vvSizeFactor=e.size.factor):e&&r&&(o.vvSizeValue=t.transformation.scale),e&&r&&(o.vvSymbolAnchor=t.transformation.anchor,o.vvSymbolRotationMatrix=n.mat3f64.create(),a.mat4.identity(R),y(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],R),i.mat3.fromMat4(o.vvSymbolRotationMatrix,R)),e&&e.color&&(o.vvColorEnabled=!0,o.vvColorValues=e.color.values,o.vvColorColors=e.color.colors),e&&e.opacity&&(o.vvOpacityEnabled=!0,o.vvOpacityValues=e.opacity.values,o.vvOpacityOpacities=e.opacity.opacityValues),o}Object.defineProperty(t,"__esModule",{value:!0});var P=!1,D=!1;t.convertVisualVariables=O,t.initFastSymbolUpdatesState=w,t.updateFastSymbolUpdatesState=U,t.getMaterialParams=I;var _;!function(e){function t(e,t,o){return e<t?t:e>o?o:e}function o(e,o,i){if(!e.vvSizeEnabled)return i;a.mat4.copy(n,i);var r=e.vvSymbolRotationMatrix;a.mat4.set(R,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),a.mat4.multiply(n,n,R);for(var l=0;l<3;++l){var s=e.vvSizeOffset[l]+o[0]*e.vvSizeFactor[l];u[l]=t(s,e.vvSizeMinSize[l],e.vvSizeMaxSize[l])}return a.mat4.scale(n,n,u),a.mat4.translate(n,n,e.vvSymbolAnchor),n}function i(e,o,i){if(!o.vvSizeEnabled)return l.vec3.set(e,1,1,1);for(var n=0;n<3;++n){var a=o.vvSizeOffset[n]+i[0]*o.vvSizeFactor[n];e[n]=t(a,o.vvSizeMinSize[n],o.vvSizeMaxSize[n])}return e}var n=r.mat4f64.create(),u=s.vec3f64.create();e.evaluateModelTransform=o,e.evaluateModelTransformScale=i}(_||(_={}));var R=r.mat4f64.create();t.evaluateModelTransform=_.evaluateModelTransform,t.evaluateModelTransformScale=_.evaluateModelTransformScale});