// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Set","../../../Graphic","../../../core/arrayUtils","../../../core/has","../../../core/Logger","../../../core/PooledArray","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/rbush/PooledRBush","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../renderers/support/renderingInfoUtils","./LayerView3D","./graphics/Graphics3DFeatureLikeLayerView","./graphics/Graphics3DVerticalScale","./i3s/I3SQueryEngine","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/GraphicsMap","../support/orientedBoundingBox","../support/projectionUtils","../../layers/support/FeatureFilter"],function(e,t,r,i,o,n,a,s,d,l,p,u,c,h,g,f,y,v,m,b,_,x,I,E,F,S,w,N,A,O,C,D,G,T,U,R,V){function j(e,t){for(var r=0;r<e.length;r++)for(var i=e[r],o=0,n=i.graphics;o<n.length;o++){var a=n[o];if(a.attributes||(a.attributes={}),t.loadedAttributes)for(var s=0,d=t.loadedAttributes;s<d.length;s++){var l=d[s].name;t.attributeData[l]&&(a.attributes[l]=O.getCachedAttributeValue(t.attributeData[l],r))}}}function M(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var q=u.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),L=function(e){function t(t){var r=e.call(this)||this;return r._nodesAddedToStage=new Map,r.overlayUpdating=!1,r.supportsDraping=!0,r._queryEngine=null,r._memCache=null,r.loadedGraphics=new T.GraphicsMap,r.progressiveLoadFactor=1,r.supportsHeightUnitConversion=!0,r._coordinatesOutsideExtentErrors=0,r._maxCoordinatesOutsideExtentErrors=20,r}return r(t,e),t.prototype.initialize=function(){var e=this;O.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this.handles.add([g.init(this,["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields"],function(){return e._updateRequiredFields()}),g.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),this.layer.watch("renderer",function(t,r){return e._rendererChange(t,r)}),this.watch(["layer.objectIdFilter","parsedDefinitionExpression"],function(){return e._filterChange()})]),this._set("graphics3d",new w({owner:this,layer:this.layer,asyncGraphicsUpdates:!0,scaleVisibilityEnabled:!1,filterVisibilityEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(t){return e._updateClippingExtent(t)},queryGraphicUIDsInExtent:function(t,r,i){return e._queryGraphicUIDsInExtent(t,r,i)}})),this.supportsHeightUnitConversion&&(this._verticalScale=new N({sourceSpatialReference:this.layer.spatialReference,destSpatialReference:this.view.spatialReference})),this.addResolvingPromise(this.graphics3d.setup()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid),this._controller=new I({layerView:this}),this.when(function(){e.handles.add([g.init(e,"maximumNumberOfFeatures",function(t){return e._controller.featureTarget=t}),g.whenTrue(e,"suspended",function(){return e._removeAllNodeData()})])})},t.prototype.destroy=function(){this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null)),this._controller&&(this._controller.destroy(),this._controller=null),this._memCache.destroy(),this._memCache=null,this._elevationUpdateNodes=null,this._nodesAddedToStage=null},Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!this.suspended&&(!!this._controller&&!this._controller.leafsReached)},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=function(e){for(var t=new Map,i=[],o=0,n=e;o<n.length;o++){var a=n[o],s=r._findGraphicNodeAndIndex(a),d=t.get(s.node);d||(d={node:s.node,indices:[],graphics:[]},i.push(d)),d.indices.push(s.index),d.graphics.push(a)}return i};return O.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,i,{ignoreUnavailableFields:!0,populateObjectId:!0})},t.prototype.getGraphicFromGraphicUid=function(e){if(!this.loadedGraphics)return null;var t=x.hydrateGraphic(this.loadedGraphics.find(function(t){return t.uid===e}),this.layer),r=this._getObjectIdField();return t&&t.attributes&&t.attributes[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null},t.prototype.whenGraphicBounds=function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this.overlayUpdating||this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating},t.prototype.getRenderingInfo=function(e,t){var r=F.getRenderingInfo(e,{renderer:t});if(r&&r.color){var i=r.color;i[0]=i[0]/255,i[1]=i[1]/255,i[2]=i[2]/255}return r},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0}),t.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],r=0,i=l.keysOfMap(this._nodesAddedToStage);r<i.length;r++){var o=i[r],n=this._nodesAddedToStage.get(o),a=this._findGraphicIndex(n.bundle,t);if(a>=0)return{node:this._controller.getNode(o),index:a}}return null},t.prototype._forAllFeatures=function(e,t){this._nodesAddedToStage.forEach(function(r,i){for(var o=r.bundle,n=0;n<o.length;n++)for(var a=o[n].graphics,s=0;s<a.length;s++){var d=a[s],l=o[n].featureIds[s];d.visible&&e(l,n,d)}null!=t&&t({nodeId:i})})},t.prototype._getGraphicIndices=function(e,t){for(var r=this._nodesAddedToStage.get(e),i=this._getObjectIdField(),o=[],n=0,a=t;n<a.length;n++){var s=a[n],d=s.attributes[i],l=this._findGraphicIndex(r.bundle,d);l>=0&&o.push(l)}return o},t.prototype._findGraphicIndex=function(e,t){for(var r=0;r<e.length;r++)for(var i=0,o=e[r].featureIds;i<o.length;i++){var n=o[i];if(n===t)return r}return-1},t.prototype._queryGraphicUIDsInExtent=function(e,t,r){if(this._controller){var i=this._controller.crsIndex;R.boundingRectToBoundingRect(e,t,z,i);var o=Q;m.fromRect(o,z),o[2]=-1/0,o[5]=1/0,null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new c);var n=this._elevationUpdateNodes;this._controller.updateElevationChanged(o,i,n);for(var a=0;a<n.length;a++){var s=n.data[a],d=this._nodesAddedToStage.get(s.id);if(null!=d){if(!d.spatialIndex&&d.bundle.length>=P){var l=new v.PooledRBush(9,p("csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]);Y.length=0;for(var u=0,h=d.bundle;u<h.length;u++){for(var g=h[u],f=b.empty(),y=0,_=g.graphics;y<_.length;y++){var I=_[y];x.expandAABR(I.geometry,f)}g.extent=f,Y.push(g)}l.load(Y),d.spatialIndex=l}if(d.spatialIndex){var E=z;R.boundingRectToBoundingRect(e,t,z,this.view.spatialReference),k.minX=E[0],k.minY=E[1],k.maxX=E[2],k.maxY=E[3],d.spatialIndex.search(k,function(e){for(var t=0,i=e.graphics;t<i.length;t++){var o=i[t];r(o.uid)}})}else for(var F=0,S=d.bundle;F<S.length;F++)for(var g=S[F],w=0,N=g.graphics;w<N.length;w++){var I=N[w];r(I.uid)}}}}},t.prototype.highlight=function(e,t){return void 0===t&&(t={}),this.graphics3d.highlight(e,t,this.layer.objectIdField)},t.prototype.addNodeData=function(e,t){if(this._nodesAddedToStage.has(e.id))return void q.error("I3S node "+e.id+" already added");for(var r=t.allGeometryData,i=t.attributeDataInfo,o=this._controller.crsIndex,n=this.view.spatialReference,a=[0,0,0],s=this._getObjectIdField(),l=[],p=this.layer.fullExtent&&M(this.layer.fullExtent.clone(),.5),u=[],c=[],g=0;g<r.length;g++){var f=r[g],y=f.featureDataPosition,v=y.length,m=f.geometries||[B[v]],b=f.featureIds;p&&!_.extentContainsCoords3D(p,y)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&q.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&q.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var I=0;I<m.length;I++){var E=m[I];if("points"===E.params.type){var F=[],S=I<b.length?I:0,w=b[S],N={};null!=w&&(N[s]=w);var A=null==w?d.generateUID():w,O=void 0;"Embedded"===E.type&&(O=E.params.vertexAttributes.position);for(var C=0;C<O.length;C+=v){for(var D=0;D<v;D++)a[D]=y[D]+O[C+D];R.bufferToBuffer(a,o,0,H,n,0,1);var G=x.makeDehydratedPoint(H[0],H[1],H[2],n);v<3&&(G.z=void 0),F.push({uid:A,geometry:G,attributes:N,visible:!0}),e.obb||c.push(G.x,G.y,G.z?G.z:0)}u.push.apply(u,F),l.push({featureIds:f.featureIds,graphics:F})}}}e.numFeatures=u.length,this._updateNodeMemory(e);var T={bundle:l,attributeInfo:i};if(j(T.bundle,T.attributeInfo),c.length>0){var V=this.view.renderSpatialReference,L=this._controller.crsVertex;R.bufferToBuffer(c,n,0,c,V,0,c.length/3);var P={data:c,size:3,offsetIdx:0,strideIdx:3};e.obb=U.compute(P),R.vectorToVector(e.obb.center,V,e.obb.center,L),this._controller.updateVisibility(e.id)}return this._controller.isGeometryVisible(e)?(this._verticalScale&&this._verticalScale.adjust(u),this._nodesAddedToStage.set(e.id,T),this.loadedGraphics.addMany(u),this._filterNode(T),h.resolve()):(this._cacheNodeData(e.id,T),h.resolve())},t.prototype.isNodeLoaded=function(e){return this._nodesAddedToStage.has(e.id)},t.prototype._updateNodeMemory=function(e){e.memory=4096+e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic},t.prototype._cacheNodeData=function(e,t){var r=t.bundle.reduce(function(e,t){return t.graphics.reduce(function(e,t){return x.estimateSize(t)+e},512+8*t.featureIds.length+e)},1024);this._memCache.put(e,t,r)},t.prototype._removeAllNodeData=function(){var e=this;this._nodesAddedToStage.forEach(function(t,r){if(t){var i=e._controller.getNode(r);e._updateNodeMemory(i),e._cacheNodeData(r,t)}}),this._nodesAddedToStage.clear(),this.loadedGraphics.clear()},t.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop(),i=this._removeNodeStageData(r);i&&(this._updateNodeMemory(r),this._cacheNodeData(r.id,i)),t.madeProgress()}},t.prototype._removeNodeStageData=function(e){var t=this._nodesAddedToStage.get(e.id);if(!t)return null;for(var r=0,i=t.bundle;r<i.length;r++){var o=i[r];this.loadedGraphics.removeMany(o.graphics)}return this._nodesAddedToStage.delete(e.id),t},t.prototype.loadCachedNodeData=function(e,t){return h.resolve(this._memCache.pop(e.id))},t.prototype.addCachedNodeData=function(e,t,r){if(this._nodesAddedToStage.has(e.id))return void q.error("I3S node "+e.id+" already added");for(var i=0,o=t.bundle;i<o.length;i++){var n=o[i];this.loadedGraphics.addMany(n.graphics)}return this._nodesAddedToStage.set(e.id,t),this._updateNodeMemory(e),this.setAttributeData(e,r),this._filterNode(t),h.resolve()},t.prototype.getLoadedNodeIDs=function(){return l.keysOfMap(this._nodesAddedToStage)},t.prototype.getLoadedAttributes=function(e){var t=this._nodesAddedToStage.get(e.id);if(t)return t.attributeInfo.loadedAttributes},t.prototype.getAttributeData=function(e){var t=this._nodesAddedToStage.get(e.id);if(t)return t.attributeInfo.attributeData},t.prototype.setAttributeData=function(e,t){var r=this._nodesAddedToStage.get(e.id);if(r&&(r.attributeInfo=t,j(r.bundle,t),this._filterNode(r),this.graphics3d.graphicsCore.labelsEnabled)){var i=r.bundle.map(function(e){return e.graphics.length&&e.graphics[0].uid});this.graphics3d.graphicsCore.updateLabelingInfo(i)}},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){return n(this,void 0,void 0,function(){var r,i,n,d;return o(this,function(o){switch(o.label){case 0:return r=this.layer.fields,i=new s.default,e?[4,e.collectRequiredFields(i,r)]:[3,2];case 1:return o.sent(),n=a.from(i).sort(),[3,3];case 2:n=[],o.label=3;case 3:return i.clear(),t?[4,t.collectRequiredFields(i,r)]:[3,5];case 4:return o.sent(),d=a.from(i).sort(),[3,6];case 5:d=[],o.label=6;case 6:return n.length===d.length&&n.every(function(e,t){return n[t]===d[t]})?[2]:(this._reloadAllNodes(),[2])}})})},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&q.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype._filterChange=function(){var e=this;this._nodesAddedToStage.forEach(function(t){return e._filterNode(t)})},t.prototype._reloadAllNodes=function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()},t.prototype._filterNode=function(e){var t=this._getObjectIdField(),r=null;if(this.layer.objectIdFilter){var i=this.layer.objectIdFilter.ids,o="include"===this.layer.objectIdFilter.method;r=function(e){return i.indexOf(e)>=0===o}}for(var n=this.parsedDefinitionExpression,a=0,s=e.bundle;a<s.length;a++)for(var d=s[a],l=0,p=d.graphics;l<p.length;l++){var u=p[l],c=u.visible;r&&!r(u.attributes[t])?u.visible=!1:u.visible=!n||this._evaluateClause(n,u),c!==u.visible&&(X.graphic=u,X.property="visible",X.oldValue=c,X.newValue=u.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(X))}},t.prototype._updateRequiredFields=function(){return n(this,void 0,void 0,function(){var e,t,r,i,n,d,l,p;return o(this,function(o){switch(o.label){case 0:return e=this,t=e.layer,r=e.layer,i=r.fields,n=r.renderer,d=r.labelsVisible,l=e.definitionExpressionFields,p=new s.default,n?[4,n.collectRequiredFields(p,i)]:[3,2];case 1:o.sent(),o.label=2;case 2:return d?[4,E.collectLabelingFields(p,t)]:[3,4];case 3:o.sent(),o.label=4;case 4:return E.collectFields(p,i,l),this._set("requiredFields",a.from(p).sort()),[2]}})})},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,graphic:null},r=this;return new A(this.layer,{forAll:function(r,i){function o(e,i,o){t.id=e,t.index=i,t.graphic=o,r(t)}e._forAllFeatures(o,i)},createGraphic:function(e){return x.hydrateGraphic(e.graphic,r.layer)},requestFields:function(t,r,i){var o=function(r){var i=e._getGraphicIndices(t.nodeId,r);return[{node:e._controller.getNode(t.nodeId),indices:i,graphics:r}]};return O.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),i,o,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var t=m.empty(),r=e.layer.spatialReference;return{add:function(e){return x.expandAABB(e.graphic.geometry,t)},getExtent:function(){return m.toExtent(t,r)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0},t.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))},t.prototype.ignoresMemoryFactor=function(){return this._controller&&this._controller.fixedFeatureTarget},t.prototype.getNumberOfNodes=function(){return this._nodesAddedToStage.size},t.prototype.getNumberOfFeatures=function(){return this.loadedGraphics.length},t.prototype.getStats=function(){var e=this.graphics3d.graphicsCore.getStats();return e.nodes=this.getNumberOfNodes(),e.features=this.loadedGraphics.length,this._controller&&this._controller.updateStats(e),e},i([f.property()],t.prototype,"graphics3d",void 0),i([f.property()],t.prototype,"drawingOrder",void 0),i([f.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],t.prototype,"hasDraped",void 0),i([f.property({type:Boolean})],t.prototype,"overlayUpdating",void 0),i([f.property({type:Boolean})],t.prototype,"supportsDraping",void 0),i([f.property({type:V})],t.prototype,"filter",void 0),i([f.property()],t.prototype,"loadedGraphics",void 0),i([f.property()],t.prototype,"layer",void 0),i([f.property()],t.prototype,"_controller",void 0),i([f.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],t.prototype,"updating",void 0),i([f.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),i([f.property(D.updatingPercentage)],t.prototype,"updatingPercentage",void 0),i([f.property({aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),i([f.property({readOnly:!0})],t.prototype,"requiredFields",void 0),i([f.property({type:Number,dependsOn:["graphics3d.graphicsCore.displayFeatureLimit"]})],t.prototype,"maximumNumberOfFeatures",null),i([f.property({readOnly:!0,dependsOn:["suspended","_controller.leafsReached"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),i([f.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],t.prototype,"lodFactor",void 0),t=i([f.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(f.declared(S,G.PopupSceneLayerView,C.DefinitionExpressionSceneLayerView)),B={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},P=100,z=b.create(),Q=m.create(m.POSITIVE_INFINITY),k={minX:0,minY:0,maxX:0,maxY:0},H=y.vec3f64.create(),Y=[],X={graphic:null,property:null,oldValue:null,newValue:null};return L});