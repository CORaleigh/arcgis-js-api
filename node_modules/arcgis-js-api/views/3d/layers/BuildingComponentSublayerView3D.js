// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Graphic","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/fieldUtils","./BuildingSublayerView3D","./I3SMeshView3D","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","../../layers/support/popupUtils"],function(e,r,t,i,s,n,o,l,p,a,d,u,c,h,y,f,F,g,v,w){var E=a.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D");return function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.layerView=null,r._elevationContext="scene",r._isIntegratedMesh=!1,r.lodFactor=1,r.progressiveLoadFactor=1,r}return i(r,e),r.prototype.initialize=function(){var e=this;this._layerUid=this.layer.layer.uid,this.handles.add([c.init(this,["layer.renderer","definitionExpressionFields","filterExpressionFields"],function(){return e._updateRequiredFields()}),c.init(this.layer,"renderer",function(r){return e._rendererChange(r)}),this.watch(["parsedDefinitionExpression","parsedFilterExpression"],function(){return e._filterChange()})])},Object.defineProperty(r.prototype,"parsedFilterExpression",{get:function(){if("Overview"===this.layer.modelName)return null;var e=this.layerView.parsedFilterExpression;if(!e)return null;var r=[],t=e.getFields();return g.findFieldsCaseInsensitive(t,this.layer.fields,{missingFields:r}),r.length>0?(E.error("filterExpression references unknown fields: "+r.join(", ")),null):e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"filterExpressionFields",{get:function(){if(this.parsedFilterExpression){var e=this.parsedFilterExpression.getFields();return g.findFieldsCaseInsensitive(e,this.layer.fields)}return null},enumerable:!0,configurable:!0}),r.prototype._createLayerGraphic=function(e){var r=new l(null,null,e);return r.layer=this.layer.layer,r.sourceLayer=this.layer,r},r.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},r.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)},r.prototype.fetchPopupFeatures=function(e,r){return o(this,void 0,void 0,function(){var e,t,i,s,o,l,p,a,c;return n(this,function(n){switch(n.label){case 0:return(e=this._validateFetchPopupFeatures(r))?[2,u.reject(e)]:d.isSome(r)&&r.clientGraphics&&0!==r.clientGraphics.length?(t=[],i=[],o=y.unpackFieldNames,l=[this.layer.fields],[4,w.getRequiredFields(this.layer,w.getFetchPopupTemplate(this.layer,r))]):[2,[]];case 1:for(s=o.apply(void 0,l.concat([n.sent()])),p=0,a=r.clientGraphics;p<a.length;p++)c=a[p],y.featureHasFields(s,c)?t.push(c):i.push(c);return 0===i.length?[2,u.resolve(t)]:[2,this.whenGraphicAttributes(i,s).catch(function(){return i}).then(function(e){return t.concat(e)})]}})})},r.prototype._updateRequiredFields=function(){return o(this,void 0,void 0,function(){var e,r,t,i;return n(this,function(s){switch(s.label){case 0:return r=y.fixFields,t=[this.layer.fields],this.layer.renderer?[4,this.layer.renderer.getRequiredFields(this.layer.fields)]:[3,2];case 1:return i=s.sent(),[3,3];case 2:i=[],s.label=3;case 3:return e=r.apply(void 0,t.concat([i.concat(this.definitionExpressionFields||[],this.filterExpressionFields||[])])),this._set("requiredFields",e),[2]}})})},r.prototype._validateFetchPopupFeatures=function(e){var r=this.layer;return r.popupEnabled?w.getFetchPopupTemplate(r,e)?void 0:new p("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:r}):new p("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:r})},r.prototype.getFilters=function(){var e=this.inherited(arguments);return this.addSqlFilter(e,this.parsedFilterExpression,this.filterExpressionFields,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError),e},s([h.property()],r.prototype,"layer",void 0),s([h.property()],r.prototype,"layerView",void 0),s([h.property({dependsOn:["_controller.updating"]})],r.prototype,"updating",void 0),s([h.property({dependsOn:["_controller.rootNodeVisible"]})],r.prototype,"suspended",void 0),s([h.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],r.prototype,"lodFactor",void 0),s([h.property({readOnly:!0,dependsOn:["layerView.parsedFilterExpression"]})],r.prototype,"parsedFilterExpression",null),s([h.property({type:[String],readOnly:!0,dependsOn:["parsedFilterExpression"]})],r.prototype,"filterExpressionFields",null),s([h.property({readOnly:!0})],r.prototype,"requiredFields",void 0),r=s([h.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],r)}(h.declared(f,F.I3SMeshView3D,v.DefinitionExpressionSceneLayerView))});