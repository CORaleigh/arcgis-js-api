// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/watchUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","./atmosphereUtils","./resources/SimpleAtmosphereTexture","../support/earthUtils","../support/imageUtils","../support/mathUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../webgl-engine/shaders/SimpleAtmospherePrograms","../../webgl/BufferObject","../../webgl/programUtils","../../webgl/renderState","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],function(e,t,r,a,i,n,s,o,l,c,d,h,u,f,p,m,g,v,_,x,b,C,y,V,w){function P(e,t,r,a,i){var n=o.vec3.length(e),s=Math.sqrt(n*n-a*a),l=a*s/n,c=Math.sqrt(a*a-l*l),d=i.silCircleV1,h=i.silCircleV2;return o.vec3.scale(i.silCircleCenter,e,c/n),o.vec3.cross(d,e,t),o.vec3.squaredLength(d)<1&&o.vec3.cross(d,e,r),o.vec3.scale(d,d,l/o.vec3.length(d)),o.vec3.cross(h,d,e),o.vec3.scale(h,h,l/o.vec3.length(h)),l}function D(e,t,r,i){return o.vec3.add(H,i.silCircleCenter,i.silCircleV2),o.vec3.scale(O,H,M),a.mat4.lookAt(T,t,H,r),v.project(H,T,e.projectionMatrix,e.viewport),v.project(O,T,e.projectionMatrix,e.viewport),o.vec3.distance(H,O)/e.height}function U(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}var A=-c.INNER_ATMOSPHERE_DEPTH,R=(h.earthRadius+A)/h.earthRadius,F=(h.earthRadius+0)/h.earthRadius,M=(h.earthRadius+3e5)/h.earthRadius,S=function(e){return 1-511/512},j=f.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,.51171875],[5e4,.4140625]]),q=function(){function e(e){this.needsRender=!1,this.didRender=!0,this.slot=12,this._renderData={texV:s.vec2f64.create(),silCircleCenter:l.vec3f64.create(),silCircleV1:l.vec3f64.create(),silCircleV2:l.vec3f64.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this.view=e}return e.prototype.when=function(e){return this._readyPromise.then(e)},e.prototype.initializeRenderContext=function(e){var t=this,a=e.rctx;this._cameraChangeHandle=r.init(this.view,"state.camera",function(){return t.needsRender=!0},!0),this._program=b.createProgram(a,_.colorPass),this._fadeProgram=b.createProgram(a,_.fadePass),this._vao=this._createRibbon(a),this._vaoCount=V.vertexCount(this._vao,"geometry"),this._fadeVao=g.createQuadVAO(a),this._fadeVaoCount=V.vertexCount(this._fadeVao,"geometry"),this._readyPromise=u.requestImage(d).then(function(e){t._texture=new y(a,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},e),t.needsRender=!0}),this._pipelineState=C.makePipelineState({blending:C.separateBlendingParams(770,1,771,771),depthTest:{func:515},colorWrite:C.defaultColorWriteParams})},e.prototype.uninitializeRenderContext=function(e){this.destroy()},e.prototype.destroy=function(){this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._program&&(this._program.dispose(),this._program=null),this._fadeProgram&&(this._fadeProgram.dispose(),this._fadeProgram=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._readyPromise&&(this._readyPromise.cancel(),this._readyPromise=null)},e.prototype.render=function(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(null==this._texture)return!1;this._update(e.camera);var t=e.rctx;if(t.setPipelineState(this._pipelineState),this._renderData.undergroundFadeAlpha<1){var r=this._program;t.bindProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),t.bindTexture(this._texture,0),r.setUniform1i("tex",0),r.setUniform3fv("lightDirection",e.lightingData.direction),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){var r=this._fadeProgram;t.bindProgram(r),r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),r.setUniform3fv("lightDirection",e.lightingData.direction),r.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return this.needsRender=!1,!0},e.prototype._update=function(e){var t=l.vec3f64.create(),r=h.earthRadius,a=o.vec3.length(e.eye),i=a-r;if(i<0){var s=Math.min(-i/5e3,1);this._renderData.undergroundFadeAlpha=s}else this._renderData.undergroundFadeAlpha=0;var d=Math.max(50,i),u=r+A;this._renderData.innerScale=U(r+d,r,u)-1,this._renderData.altitudeFade=c.computeInnerAltitudeFade(i),o.vec3.scale(t,e.eye,(r+50)/a),P(t,e.center,e.up,r,this._renderData);var p=D(e,t,e.up,this._renderData),m=S(),g=j(i),v=0+1*m,_=0+p*g*1;if(i>50){P(e.eye,e.center,e.up,r,this._renderData);var x=D(e,e.eye,e.up,this._renderData),b=f.clamp((x-1.5)/(p-1.5),0,1);v=0+b*m*1,_=0+1*f.lerp(1,p*g,b)}n.vec2.set(this._renderData.texV,v,_)},e.prototype._createRibbon=function(e){var t=new Float32Array(1155),r=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(var a=0;a<128;a++){var i=9*a+3;t[i+0]=a,t[i+1]=R,t[i+2]=-1,t[i+3]=a,t[i+4]=F,t[i+5]=0,t[i+6]=a,t[i+7]=M,t[i+8]=1;var n=3*a+1,s=127===a?1:n+3,o=15*a;r[o+0]=n,r[o+1]=n+1,r[o+2]=s+1,r[o+3]=s+1,r[o+4]=s,r[o+5]=n,r[o+6]=n+1,r[o+7]=n+2,r[o+8]=s+2,r[o+9]=s+2,r[o+10]=s+1,r[o+11]=n+1,r[o+12]=n,r[o+13]=s,r[o+14]=0}for(var l=L.createBuffer(r.length),c=l.position,a=0;a<r.length;++a){var d=3*r[a];c.set(a,0,t[d]),c.set(a,1,t[d+1]),c.set(a,2,t[d+2])}return new w(e,_.colorPass.attributes,{geometry:p.glLayout(L)},{geometry:x.createVertex(e,35044,l.buffer)})},e}(),T=i.mat4f64.create(),H=l.vec3f64.create(),O=l.vec3f64.create(),L=m.newLayout().vec3f("position");return q});