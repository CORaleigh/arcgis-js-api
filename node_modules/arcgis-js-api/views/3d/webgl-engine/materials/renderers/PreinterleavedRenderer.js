// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/Util","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,r,i,a,n,o,s,g,d,l,h){var u=function(){function e(e,t,r){this._material=r,this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._materialRep=t,this._glMaterials=g.acquireMaterials(this._material,this._materialRep)}return e.prototype.dispose=function(){g.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateHighlightCount()},e.prototype.addAndRemoveGeometries=function(e,t){var l=this,u=this._rctx,c=this._dataByOrigin;e.forEach(function(e){var t=e.data;if(!t.preinterleaved)return void o.assert(!1,"Non-interleaved render geometry processed as pre-interleaved");if(null==t.vertexData)return void o.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");var m=e.origin.id,y=e.origin.vec3,p=e.uniqueName,v=c.get(m);v||(v={origin:y,highlightCount:0,dataByGeometry:new Map},c.set(m,v)),o.setMatrixTranslation3(f,-y[0],-y[1],-y[2]);var x=i.mat4f64.create();r.mat4.multiply(x,f,e.transformation);var b=g.generateRenderGeometryVisibleIndexRanges(e),_=g.generateRenderGeometryHighlightRanges(e);_&&(v.highlightCount=null);var B=t.indexCount,R=t.id,G=new s(e.name,0,B,b,_,x,e.instanceParameters,e.idx,R),w=t.indexData?d.createIndex(u,35044,t.indexData):null,C=l._material.createBufferLayout(),I=new h(u,n.Default3D,{geometry:a.glLayout(C)},{geometry:d.createVertex(u,35044)},w);I.vertexBuffers.geometry.setData(t.vertexData),t.indexData=null,t.vertexData=null,v.dataByGeometry.set(p,{instance:G,vao:I})}),t.forEach(function(e){var t=e.origin,r=t.id,i=e.uniqueName,a=c.get(r);a.dataByGeometry.get(i).vao.dispose(),a.dataByGeometry.delete(i),0===a.dataByGeometry.size&&c.delete(r)})},e.prototype.updateGeometries=function(e){var t=this;e.forEach(function(e){var r=e.updateType,i=e.renderGeometry,a=i.origin.id,n=i.uniqueName,o=t._dataByOrigin.get(a),s=o&&o.dataByGeometry.get(n).instance;s&&(1&r&&(s.displayedIndexRange=g.generateRenderGeometryVisibleIndexRanges(i)),17&r&&(s.highlightedIndexRanges=g.generateRenderGeometryHighlightRanges(i),o.highlightCount=null),2&r&&console.error("Updating Preinterleaved geometry not supported"),4&r&&g.calculateTransformRelToOrigin(i,s.transformation,s.transformationNormal))})},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.dataByGeometry.forEach(function(e){e.instance.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.render=function(e,t,r,i){var a=this,n=this._rctx,o=this._glMaterials.get(t.pass),s=4===t.pass;if(!o||null!=e&&!o.beginSlot(e)||s&&0===this._highlightCount)return!1;o.bind(n,r);var g=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,o.bindView(n,r),s?e.dataByGeometry.forEach(function(e){g=a.renderInstanceHighlight(o,e,i)||g}):e.dataByGeometry.forEach(function(e){g=a.renderInstance(o,e,i)||g}))}),o.release(n,r),n.bindVAO(null),g},e.prototype.renderInstance=function(e,t,r){var i=t.instance,a=t.vao,n=i.displayedIndexRange;if(n&&0===n.length)return!1;var o=this._rctx,s=e.getProgram(),d=e.getDrawMode();l.assertCompatibleVertexAttributeLocations(a,s),o.bindVAO(a),e.bindInstance(o,i);var h=a.indexBuffer&&a.indexBuffer.indexType;if(n)h?g.drawElementsFaceRange(o,n,i.from,d,h,r):g.drawArraysFaceRange(o,n,i.from,d,r);else{var u=i.to-i.from;h?g.drawElements(o,d,h,i.from,u,r):g.drawArrays(o,d,i.from,u,r)}return!0},e.prototype.renderInstanceHighlight=function(e,t,r){var i=t.instance,a=t.vao,n=i.highlightedIndexRanges;if(!n)return!1;var o=this._rctx,s=e.getProgram(),d=e.getDrawMode();l.assertCompatibleVertexAttributeLocations(a,s),o.bindVAO(a),e.bindInstance(o,i);for(var h=a.indexBuffer&&a.indexBuffer.indexType,u=!1,f=0;f<n.length;f++){var c=n[f],m=c.range?c.range[0]+i.from:i.from,y=c.range?c.range[1]-c.range[0]+1:i.to-i.from;h?g.drawElements(o,d,h,m,y,r):g.drawArrays(o,d,m,y,r),u=!0}return u},e}(),f=i.mat4f64.create();return u});