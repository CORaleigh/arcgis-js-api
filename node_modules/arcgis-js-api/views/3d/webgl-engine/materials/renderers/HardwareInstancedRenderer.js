// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/BufferView","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/InstanceBufferData","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(t,e,a,i,r,n,o,s,u,d,f){function h(t,e){var a=new Map,i=function(t,e){var i=t.origin.id,r=t.data.id,n=a.get(i);n||(n={origin:t.origin.vec3,deltaByGeometry:new Map},a.set(i,n));var o=n.deltaByGeometry.get(r);o||(o={renderData:t.data,toAdd:[],toRemove:[]},n.deltaByGeometry.set(r,o)),(e?o.toAdd:o.toRemove).push(t)};return t.forEach(function(t){i(t,!0)}),e.forEach(function(t){i(t,!1)}),a}function l(t,e,a){var i=e.elementCount(t),r=e.allocate(i);e.write({},t,null,r,0),a.setData(r.buffer)}var c=function(){function t(t,e,a,i,s){void 0===s&&(s=0),this.data=new o(a,s),this.instanceBuffer=u.createVertex(t,35044),this.vao=new f(t,n.Default3D,{geometry:r.glLayout(e),instance:r.glLayout(a,{divisor:1})},{geometry:i,instance:this.instanceBuffer})}return t.prototype.dispose=function(){this.vao.dispose(!1),this.instanceBuffer.dispose()},Object.defineProperty(t.prototype,"count",{get:function(){return this.data.getCount()},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this.data.hasSlot(t.idx)},t.prototype.prepareAdd=function(t){this.data.prepareAllocate(t)},t.prototype.add=function(t){var e=this.data.allocate(t.idx);this.writeInstance(t,e)},t.prototype.prepareRemove=function(t){this.data.prepareFree(t)},t.prototype.remove=function(t){this.data.free(t.idx)},t.prototype.updateTransform=function(t,e){void 0===e&&(e=!0);var a=this.data.getSlot(t.idx);null!=a&&(this.writeTransform(t,a),e&&this.uploadSlot(a))},t.prototype.uploadAll=function(){this.data.compact(),this.instanceBuffer.setData(this.data.getBuffer().buffer)},t.prototype.uploadSlot=function(t){var e=this.data,a=e.layout.stride,i=t*a;this.instanceBuffer.setSubData(e.getBuffer().buffer,i,i,i+a)},t.prototype.instanceBufferView=function(){var t=this.data.getBuffer();return this._buffer!==t&&(this._bufferView={transformation:t.getField("model",i.BufferViewMat4f),transformationNormal:t.getField("modelNormal",i.BufferViewMat4f),instanceColor:t.getField("instanceColor",i.BufferViewVec4f),instanceFeatureAttribute:t.getField("instanceFeatureAttribute",i.BufferViewVec4f)}),this._bufferView},t.prototype.writeTransform=function(t,e){var a=this.instanceBufferView();s.calculateTransformRelToOrigin(t,p,m),a.transformation.setMat(e,p),a.transformationNormal.setMat(e,m)},t.prototype.writeInstance=function(t,e){var a=this.instanceBufferView();s.calculateTransformRelToOrigin(t,p,m),a.transformation.setMat(e,p),a.transformationNormal.setMat(e,m),a.instanceColor&&a.instanceColor.setVec(e,t.instanceParameters.color),a.instanceFeatureAttribute&&a.instanceFeatureAttribute.setVec(e,t.instanceParameters.featureAttribute)},t}(),g=function(){function t(t,e,a){this._dataByOrigin=new Map,this._highlightCount=0,this._instanceDataToUploadCache=new Set,this._rctx=t,this._material=a,this._materialRep=e,this._glMaterials=s.acquireMaterials(this._material,this._materialRep),this._bufferWriter=a.createBufferWriter()}return t.prototype.dispose=function(){s.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(t.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),t.prototype.renderPriority=function(){return this._material.renderPriority},t.prototype.modify=function(t){this.updateGeometries(t.toUpdate),this.addAndRemoveGeometries(t.toAdd,t.toRemove),this.updateHighlightCount()},t.prototype.addAndRemoveGeometries=function(t,e){var a=this._rctx,i=this._bufferWriter,r=this._dataByOrigin,n=h(t,e),o=i.vertexBufferLayout,d=i.instanceBufferLayout;n.forEach(function(t,e){var n=r.get(e);n||(n={origin:t.origin,highlightCount:0,dataByGeometry:new Map},r.set(e,n)),t.deltaByGeometry.forEach(function(t,e){var r=n.dataByGeometry.get(e);if(!r&&t.toAdd.length>0){var f=u.createVertex(a,35044);l(t.renderData,i,f),r={count:0,vertexBuffer:f,instanceData:new c(a,o,d,f,t.toAdd.length),highlightInstanceData:new c(a,o,d,f)},n.dataByGeometry.set(e,r)}var h=r.instanceData,g=r.highlightInstanceData;h.prepareAdd(t.toAdd.length),t.toAdd.forEach(function(t){if(!s.isRenderGeometryHidden(t)){h.add(t);s.doesRenderGeometryHaveHighlights(t)&&(g.add(t),n.highlightCount=null)}}),h.prepareRemove(t.toRemove.length),t.toRemove.forEach(function(t){h.remove(t),g.remove(t)}),t.toAdd.length+t.toRemove.length&&(h.uploadAll(),g.uploadAll()),r.count+=t.toAdd.length,r.count-=t.toRemove.length,0===r.count&&(r.instanceData.dispose(),r.highlightInstanceData.dispose(),r.vertexBuffer.dispose(),n.dataByGeometry.delete(e))}),0===n.dataByGeometry.size&&r.delete(e)})},t.prototype.updateGeometries=function(t){var e=this._dataByOrigin,a=this._bufferWriter;this._instanceDataToUploadCache.clear();var i=this._instanceDataToUploadCache;t.forEach(function(t){var r=t.updateType,n=t.renderGeometry,o=e.get(n.origin.id),u=o&&o.dataByGeometry.get(n.data.id);if(u){var d=u.instanceData,f=u.highlightInstanceData,h=1&r;h&&(s.isRenderGeometryHidden(n)?(d.remove(n),i.add(d),f.has(n)&&(f.remove(n),i.add(f))):d.has(n)||(d.add(n),i.add(d),s.doesRenderGeometryHaveHighlights(n)&&!f.has(n)&&(f.add(n),i.add(f))));var c=16&r;if(c){s.doesRenderGeometryHaveHighlights(n)?f.has(n)||(f.add(n),i.add(f)):(f.remove(n),i.add(f)),o.highlightCount=null}2&r&&l(n.data,a,u.vertexBuffer),4&r&&(u.instanceData.updateTransform(n,!h),u.highlightInstanceData.updateTransform(n,!c))}}),i.forEach(function(t){t.uploadAll()})},t.prototype.updateHighlightCount=function(){var t=this;this._highlightCount=0,this._dataByOrigin.forEach(function(e){if(null==e.highlightCount){var a=0;e.dataByGeometry.forEach(function(t){a+=t.highlightInstanceData.count}),e.highlightCount=a}t._highlightCount+=e.highlightCount})},t.prototype.render=function(t,e,a,i){var r=this._rctx,n=r.capabilities.instancing,o=this._glMaterials.get(e.pass),s=4===e.pass;if(!o||null!=t&&!o.beginSlot(t)||s&&0===this._highlightCount)return!1;var u=o.getProgram(),f=o.getDrawMode();o.bind(r,a);var h=!1;return this._dataByOrigin.forEach(function(t){s&&0===t.highlightCount||(a.origin=t.origin,o.bindView(r,a),t.dataByGeometry.forEach(function(t){var e=s?t.highlightInstanceData:t.instanceData,a=e.count;if(!s||0!==a){var o=e.vao;d.assertCompatibleVertexAttributeLocations(o,u),r.bindVAO(o);var l=d.vertexCount(o,"geometry");n.drawArraysInstanced(f,0,l,a),i&&(i.drawCallsInstanced++,4===f&&(i.triangles+=a*(l/3))),h=!0}}))}),r.bindVAO(null),o.release(r,a),h},t}(),p=a.mat4f64.create(),m=a.mat4f64.create();return g});