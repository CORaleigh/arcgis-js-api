// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/TimeProfiler","../../../../core/libs/gl-matrix-2/vec2f64","../../support/debugFlags","../lib/Util","./BoundingInfo","./depthRange","./depthRangeUtils","./FxaaRenderPass","./HighlightHelper","./OffscreenRenderingHelper","./RenderContext","./RenderPluginManager","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./Util","./edgeRendering/EdgeView","../lighting/SceneLighting","../materials/HUDMaterial","../../../webgl/Profiling","../../../webgl/Texture"],function(e,r,t,i,n,s,a,o,d,h,l,p,c,u,g,_,f,m,R,b,P,w,x,y,v){function H(e,r){var t=new Map,i=null,n=null,s=function(e){if(e===i)return n;var r=t.get(e);return r||(r={toAdd:[],toRemove:[],toUpdate:[]},t.set(e,r)),i=e,n=r,r};e.toAdd.forEach(function(e){if(M(e)){s(e.material).toAdd.push(e)}}),e.toRemove.forEach(function(e){if(M(e)){s(e.material).toRemove.push(e)}});var a=0;return e.toUpdate.forEach(function(e){if(M(e.renderGeometry)){s(e.renderGeometry.material).toUpdate.push(e),a|=e.updateType}}),r&&(r.updateTypes=a),t}function M(e){return T(e.data)>=1}function T(e){return!1===e.preinterleaved?b.getFirstObjectValue(e.indices).length:e.indexCount}function S(e,r){return e.isVisible()&&e.isVisibleInPass(r.pass)&&0!=(e.renderOccluded&r.renderOccludedMask)}var D=function(){function e(r,t,i,n,s,a){var o=this;this._materialRenderers=new Map,this._orderedMaterialRenderers=[],this._hasHighlights=!1,this._lighting=new w.SceneLighting,this._content=new Map,this._isRendering=!1,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new e.RenderStats,this._edgeView=null,this.renderOptions={antialiasing:"smaa"},this._programRep=r,this._materialRep=t,this._rctx=n,this._mode=s,this._stage=a,this._fxaaPass=new l(n),this._smaaPass=new m(n),this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null},this._offscreenRendering=new c(r,this._rctx),this._sliceHelper=new f,"scene"===this._mode&&(this._shadowMap=new _(this._rctx),this._ssaoHelper=new R(r,this._rctx,function(){o._needsRender=!0}),this._highlightHelper=new p(r,this._rctx)),this._renderPlugins=new g.RenderPluginManager({rctx:n,programRep:r,textureRep:i,materialRep:t}),this._renderContext=new u(n,this._offscreenRendering,this._lighting.getOld(),this._shadowMap,this._ssaoHelper,this._sliceHelper)}return e.prototype.dispose=function(){this._materialRenderers.forEach(function(e){e.dispose()}),this._materialRenderers=null,this._orderedMaterialRenderers=null,this._edgeView&&(this._edgeView.destroy(),this._edgeView=null),this._offscreenRendering.enabled=!1,this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null),this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose()),this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose()),this._highlightHelper&&(this._highlightHelper.enabled=!1),o.tmpIndices.prune(),this._content.clear(),this._content=null},Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0}),e.prototype.ensureEdgeView=function(){var e=this;return null==this._edgeView&&(this._edgeView=new P.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){return e._needsRender=!0}}),this._edgeView.initialize()),this._edgeView},Object.defineProperty(e.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!0,configurable:!0}),e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setRenderParams=function(e){void 0!==e.shadowMapResolution&&!1===this._shadowMap.enabled&&(this._shadowMap.textureResolution=e.shadowMapResolution),void 0!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._shadowMap.maxCascades=e.shadowMapMaxCascades),this._highlightHelper.enabled=!0,void 0!==e.ssao&&(this._ssaoHelper.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._ssaoHelper.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._ssaoHelper.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._ssaoHelper.samples=e.ssaoSamples),e.background&&(this._offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this.renderOptions.antialiasing=e.antialiasingEnabled?"smaa":"none"),void 0!==e.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),void 0!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane),this._needsRender=!0},Object.defineProperty(e.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0}),e.prototype.getRenderParams=function(){var e={};return this._shadowMap&&(e.shadowMap=this._shadowMap.enabled,e.shadowMapResolution=this._shadowMap.textureResolution,e.shadowMapMaxCascades=this._shadowMap.maxCascades),this._ssaoHelper&&this._ssaoHelper.isSupported&&(e.ssao=this._ssaoHelper.enabled,e.ssaoAttenuation=this._ssaoHelper.attenuation,e.ssaoRadius=this._ssaoHelper.radius,e.ssaoFilterRadius=this._ssaoHelper.filterRadius,e.ssaoSamples=this._ssaoHelper.samples),e},Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0}),e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._renderPlugins.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._renderPlugins.needsRender()},e.prototype.getCombinedStats=function(){return this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0,this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype.getFramebufferTexture=function(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture}return null},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0}),e.prototype.isEmpty=function(){return 0===this._materialRenderers.size},e.prototype.modify=function(e,r,t,i){var n=this;void 0===t&&(t=[]),this._isRendering&&console.warn("Renderer.modify called while rendering");for(var s=0;s<r.length;++s)this._content.delete(r[s].uniqueName);for(var s=0;s<e.length;++s)this._content.set(e[s].uniqueName,e[s]);if(t)for(var s=0;s<t.length;++s)a.assert(this._content.get(t[s].renderGeometry.uniqueName)===t[s].renderGeometry);if(e.length||r.length||t.length){var o=H({toAdd:e,toRemove:r,toUpdate:t}),d=!1;o.forEach(function(e,r){var t=n._materialRenderers.get(r);!t&&e.toAdd.length>0&&(t=r.createRenderer(n._rctx,n._materialRep),n._materialRenderers.set(r,t),n._orderedMaterialRenderers.push(t),n.sortOrderedMaterialRenderers()),t&&(t.modify(e),t.isEmpty&&(d=!0))}),d&&this._materialRenderers.forEach(function(e,r){e.isEmpty&&(n._materialRenderers.delete(r),n._orderedMaterialRenderers.splice(n._orderedMaterialRenderers.indexOf(e),1),e.dispose())});var h=!1;this._materialRenderers.forEach(function(e){h=h||e.hasHighlights}),h!==this._hasHighlights&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(h),this._hasHighlights=h),this._needsRender=!0}i&&(i.forEach(function(e){n._materialRep.updateMaterialParameters(e)}),this._needsRender=!0)},e.prototype.modifyRenderOrder=function(e){"draped"===this._mode&&(this.sortOrderedMaterialRenderers(),this._needsRender=!0)},e.prototype.render=function(e){switch(this._mode){case"scene":this.renderScene(e);break;case"draped":this.renderDraped(e)}this.onPostRender&&this.onPostRender()},e.prototype.renderPass=function(e,r){this.renderGeometryPass(e,r)},e.prototype.renderScene=function(e){var r=this;this._isRendering=!0;var t=this._rctx,i=this._offscreenRendering,n=this._ssaoHelper,s=e.camera,a=e.fbo,o=this._sliceHelper.plane;e.disableSlice&&(this._sliceHelper.plane=null),this.prepareRender(s),this.renderShadowMap(e),i.enabled=!0,i.initializeFrame(s,a),this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth()?i.renderToTargets(function(){r.renderGeometryPass(1,e)},i.linearDepth,i.tmpDepth,[0,0,0,0],!0):i.disposeTarget(i.linearDepth),this._ssaoHelper.enabled?i.renderToTargets(function(){r.renderGeometryPass(2,e)},i.normal,i.tmpDepth,[0,0,0,0],!0):i.disposeTarget(i.normal),this._ssaoHelper.enabled&&n.computeSSAO(s,i.linearDepthTexture,i.normalTexture),n.bindAll(this._programRep),this._stats.reset(),this.updateGlobalUniforms(s.projectionMatrix),this._renderContext.pass=0,this._renderContext.camera=s,this._renderContext.options=this.renderOptions,i.bindTarget(i.mainColor,i.mainDepth),this._renderPlugins.render(0,this._renderContext),this.renderGeometrySlotsPt1(this._renderContext),this._edgeView&&this._edgeView.shouldRender()&&i.renderSeparateAndComposite(function(){return r._edgeView.render(r._bindParameters)},void 0,"alpha");var d={hudVisibility:!1,transparentTerrain:!1};d.hudVisibility=this.renderHUDVisibility(this._renderContext),this.renderInternalSlot(17,this._renderContext),d.transparentTerrain=this.renderTransparentTerrain(this._renderContext),d.transparentTerrain&&d.hudVisibility&&(i.compositeTransparentTerrainOntoHUDVisibility(),i.renderToTargets(function(){return r.renderHUD("occluded")},i.mainColor,i.tmpDepth,void 0,!0)),d.transparentTerrain&&i.compositeTransparentTerrainOntoMain(),i.renderToTargets(function(){r.renderInternalSlot(9,r._renderContext),r._renderPlugins.render(13,r._renderContext),r._renderPlugins.render(14,r._renderContext)},i.mainColor,i.mainDepth),this.renderOccluded();var h=this.renderOptions.antialiasing;"smaa"===h&&this._smaaPass.loadResources(function(){r._needsRender=!0}),"smaa"===h&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:i.colorTexture},a)):"fxaa"===h&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:i.colorTexture},a)):(i.composite(),this._fxaaPass.disable(),this._smaaPass.disable()),t.bindFramebuffer(a),this.renderHUD("notOccluded"),this.renderHighlights(e,a),this._sliceHelper.plane=o,this._isRendering=!1},e.prototype.renderDraped=function(e){this._stats.reset(),this.renderGeometryPass(0,e)},e.prototype.prepareRender=function(e){this._renderPlugins.prepareRender(e)},e.prototype.renderShadowMap=function(e){var r=this._shadowMap,t=e.camera,n=e.fbo,a=e.lightDirection;if(r.enabled){s.ENABLE_PROFILE_DEPTH_RANGE&&i.begin("depthRange");var o=this.computeDepthRange(t);s.ENABLE_PROFILE_DEPTH_RANGE&&i.end("depthRange"),r.prepare(t,a,o);for(var d=r.getCascades(),h=0;h<d.length;++h){var l=d[h];l.camera.setGLViewport(this._rctx),e.camera=l.camera,this.renderGeometryPass(3,e)}e.camera=t,r.finish(n),t.setGLViewport(this._rctx)}r.bindAll(this._programRep)},e.prototype.computeDepthRange=function(e){var r=h.depthRangeFromScene(e,this._content,this._stage.getLayers());return d.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},e.prototype.renderGeometryPass=function(e,r){this._isRendering=!0;var t=r.camera;this.updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,"draped"===this._mode?this.renderGeometryPassDraped(this._renderContext):this.renderGeometryPassScene(this._renderContext),this._isRendering=!1},e.prototype.renderGeometryPassDraped=function(e){var r=this,t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,C[0]=t.near,C[1]=t.far,this._bindParameters.nearFar=C,this._bindParameters.lightingData=e.lightingData,this._bindParameters.viewport=t.fullViewport,this._bindParameters.pixelRatio=t.pixelRatio,this._bindParameters.slicePlane=e.sliceHelper&&e.sliceHelper.plane,this._bindParameters.highlightDepthTexture=this.getFallbackDepthTexture(),this._orderedMaterialRenderers.forEach(function(t){t.render(null,e,r._bindParameters)})},e.prototype.renderGeometryPassScene=function(e){this.renderGeometrySlotsPt1(e),this.renderTransparentTerrain(e)},e.prototype.renderGeometrySlotsPt1=function(e){this._renderPlugins.render(1,e),this.renderInternalSlot(2,e),this._renderPlugins.render(3,e),this.renderInternalSlot(4,e),this._renderPlugins.render(5,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._renderPlugins.render(12,this._renderContext),this.renderInternalSlot(6,e),this._renderPlugins.render(7,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep)},e.prototype.renderTransparentTerrain=function(e){return this._renderPlugins.render(8,e)},e.prototype.renderHUDVisibility=function(e){var r=this,t=x.shouldRenderVisibilityDuringRenderPass(e.pass),i=e.offscreenRenderingHelper&&e.offscreenRenderingHelper.enabled,n=!1;return t&&i&&e.offscreenRenderingHelper.renderHUDVisibility(function(){n=r.renderInternalSlot(10,e)}),n},e.prototype.renderHUD=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(18,this._renderContext),this.renderInternalSlot(15,this._renderContext),this.renderInternalSlot(16,this._renderContext)},e.prototype.renderHighlights=function(e,r){var t=this,i=this._highlightHelper;if(!i||!i.enabled||!this.hasHighlights&&!this._renderPlugins.needsHighlight())return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);var n=null;i.profilingCallback&&(n=y.startMeasurement(this._renderContext.rctx));var s=this._offscreenRendering,a=s.renderToTargets(function(){t.renderGeometryPass(4,e),t._rctx.clearSafe(256),t.renderHUD("both")},s.highlight,s.tmpDepth,[0,0,0,0],!0);i.render(e.camera,a,r),null!==n&&i.profilingCallback&&n.stop(function(e){i.profilingCallback&&i.profilingCallback(e)})},e.prototype.renderOccluded=function(){var e=this;if(this._materialRenderers.forEach(function(e,r){r&&r.isVisible()&&1!==r.renderOccluded&&O.push(r)}),0!==O.length){var r=this._offscreenRendering,t=this._renderContext,i=function(i,n){t.renderOccludedMask=n,r.renderToTargets(function(){e.renderInternalSlot(4,t,O),e.renderInternalSlot(6,t,O),e.renderInternalSlot(9,t,O)},r.tmpColor,r.tmpDepth,[0,0,0,0],!0),t.resetRenderOccludedMask(),r.compositeOccludedOntoMain(i)};t.pass=0,i(.4,4),i(.5,2),i(1,8),O.length=0}},e.prototype.renderInternalSlot=function(e,r,t){this._bindParameters.view=r.camera.viewMatrix,this._bindParameters.proj=r.camera.projectionMatrix,this._bindParameters.viewInvTransp=r.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=r.camera.aboveGround,this._bindParameters.fovY=r.camera.fovY,C[0]=r.camera.near,C[1]=r.camera.far;var i=this._renderContext.offscreenRenderingHelper;return this._bindParameters.nearFar=C,this._bindParameters.lightingData=r.lightingData,this._bindParameters.viewport=r.camera.fullViewport,this._bindParameters.shadowMap=r.shadowMap,this._bindParameters.shadowMappingEnabled=!!r.shadowMap&&r.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!r.ssaoHelper&&r.ssaoHelper.enabled,this._bindParameters.pixelRatio=r.camera.pixelRatio,this._bindParameters.slicePlane=r.sliceHelper&&r.sliceHelper.plane,this._bindParameters.hudVisibilityTexture=i?i.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=i&&i.depthTexture||this.getFallbackDepthTexture(),this.renderInternalSlotMaterials(e,r,t)},e.prototype.renderInternalSlotMaterials=function(e,r,i){var n=this,s=!1;return t.isSome(i)?i.forEach(function(t){if(S(t,r)){var i=n._materialRenderers.get(t);s=i.render(e,r,n._bindParameters)||s}}):this._materialRenderers.forEach(function(t,i){S(i,r)&&(s=t.render(e,r,n._bindParameters)||s)}),s},e.prototype.updateGlobalUniforms=function(e){for(var r=this._programRep.getProgramsUsingUniform("proj"),t=0;t<r.length;t++)r[t].setUniformMatrix4fv("proj",e);if(this._lighting){r=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var t=0;t<r.length;t++)this._lighting.setUniforms(r[t]);r=this._programRep.getProgramsUsingUniform("lightDirection");for(var t=0;t<r.length;t++)this._lighting.setUniforms(r[t])}},e.prototype.sortOrderedMaterialRenderers=function(){"draped"===this._mode&&this._orderedMaterialRenderers.sort(function(e,r){return r.renderPriority()-e.renderPriority()})},e.prototype.getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new v(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}},e.prototype.forEachRenderGeometry=function(e){this._content.forEach(function(r,t){e(r)})},e}();!function(e){var r=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsPreinterleaved=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}();e.RenderStats=r}(D||(D={}));var C=n.vec2f64.create(),O=[];return D});