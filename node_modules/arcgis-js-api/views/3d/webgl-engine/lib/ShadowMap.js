// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../support/mathUtils","./Camera","./glUtil3D","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],function(e,t,a,r,c,i,s,o,n,v,f,h,d,u,l,p,m,x){function b(e,t,a,r,c,s,o,n){i.vec2.set(H,0,0);for(var v=0;v<4;++v)i.vec2.add(H,H,e[v]);i.vec2.scale(H,H,.25),i.vec2.set(V,0,0);for(var v=4;v<8;++v)i.vec2.add(V,V,e[v]);i.vec2.scale(V,V,.25),i.vec2.lerp(I[0],e[4],e[5],.5),i.vec2.lerp(I[1],e[5],e[6],.5),i.vec2.lerp(I[2],e[6],e[7],.5),i.vec2.lerp(I[3],e[7],e[4],.5);for(var f=0,h=i.vec2.squaredDistance(I[0],H),v=1;v<4;++v){var d=i.vec2.squaredDistance(I[v],H);d<h&&(h=d,f=v)}i.vec2.subtract(J,I[f],e[f+4]);var u=J[0];J[0]=-J[1],J[1]=u,i.vec2.subtract(K,V,H),i.vec2.lerp(J,J,K,a),i.vec2.normalize(J,J);var p,m;p=m=i.vec2.dot(i.vec2.subtract(L,e[0],H),J);for(var v=1;v<8;++v){var x=i.vec2.dot(i.vec2.subtract(L,e[v],H),J);x<p?p=x:x>m&&(m=x)}i.vec2.copy(r,H),i.vec2.scale(L,J,p-t),i.vec2.add(r,r,L);for(var b=-1,y=1,g=0,M=0,v=0;v<8;++v){i.vec2.subtract(Q,e[v],r),i.vec2.normalize(Q,Q);var w=J[0]*Q[1]-J[1]*Q[0];w>0?w>b&&(b=w,g=v):w<y&&(y=w,M=v)}l.verify(b>0,"leftArea"),l.verify(y<0,"rightArea"),i.vec2.scale(X,J,p),i.vec2.add(X,X,H),i.vec2.scale(Y,J,m),i.vec2.add(Y,Y,H),Z[0]=-J[1],Z[1]=J[0];var T=l.rayRay2D(r,e[M],Y,i.vec2.add(L,Y,Z),1,c),C=l.rayRay2D(r,e[g],Y,L,1,s),D=l.rayRay2D(r,e[g],X,i.vec2.add(L,X,Z),1,o),R=l.rayRay2D(r,e[M],X,L,1,n);l.verify(T,"rayRay"),l.verify(C,"rayRay"),l.verify(D,"rayRay"),l.verify(R,"rayRay")}function y(e,t){return 3*t+e}function g(e,t){return i.vec2.set($,e[t],e[t+3]),$}function M(e,t,a,r,c){i.vec2.subtract(_,a,r),i.vec2.scale(_,_,.5),ee[0]=_[0],ee[1]=_[1],ee[2]=0,ee[3]=_[1],ee[4]=-_[0],ee[5]=0,ee[6]=_[0]*_[0]+_[1]*_[1],ee[7]=_[0]*_[1]-_[1]*_[0],ee[8]=1,ee[y(0,2)]=-i.vec2.dot(g(ee,0),e),ee[y(1,2)]=-i.vec2.dot(g(ee,1),e);var s=i.vec2.dot(g(ee,0),a)+ee[y(0,2)],o=i.vec2.dot(g(ee,1),a)+ee[y(1,2)],n=i.vec2.dot(g(ee,0),r)+ee[y(0,2)],v=i.vec2.dot(g(ee,1),r)+ee[y(1,2)];s=-(s+n)/(o+v),ee[y(0,0)]+=ee[y(1,0)]*s,ee[y(0,1)]+=ee[y(1,1)]*s,ee[y(0,2)]+=ee[y(1,2)]*s,s=1/(i.vec2.dot(g(ee,0),a)+ee[y(0,2)]),o=1/(i.vec2.dot(g(ee,1),a)+ee[y(1,2)]),ee[y(0,0)]*=s,ee[y(0,1)]*=s,ee[y(0,2)]*=s,ee[y(1,0)]*=o,ee[y(1,1)]*=o,ee[y(1,2)]*=o,ee[y(2,0)]=ee[y(1,0)],ee[y(2,1)]=ee[y(1,1)],ee[y(2,2)]=ee[y(1,2)],ee[y(1,2)]+=1,s=i.vec2.dot(g(ee,1),t)+ee[y(1,2)],o=i.vec2.dot(g(ee,2),t)+ee[y(2,2)],n=i.vec2.dot(g(ee,1),a)+ee[y(1,2)],v=i.vec2.dot(g(ee,2),a)+ee[y(2,2)],s=-.5*(s/o+n/v),ee[y(1,0)]+=ee[y(2,0)]*s,ee[y(1,1)]+=ee[y(2,1)]*s,ee[y(1,2)]+=ee[y(2,2)]*s,s=i.vec2.dot(g(ee,1),t)+ee[y(1,2)],o=i.vec2.dot(g(ee,2),t)+ee[y(2,2)],n=-o/s,ee[y(1,0)]*=n,ee[y(1,1)]*=n,ee[y(1,2)]*=n,c[0]=ee[0],c[1]=ee[1],c[2]=0,c[3]=ee[2],c[4]=ee[3],c[5]=ee[4],c[6]=0,c[7]=ee[5],c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=ee[6],c[13]=ee[7],c[14]=0,c[15]=ee[8]}for(var w=function(){function e(){this.camera=new d,this.lightMat=c.mat4f64.create()}return e}(),T=function(){function e(e){this.doShadowMapMipmapsWork=!1,this.textureRes=4096,this.numCascades=1,this.maxNumCascades=2,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.rctx=e,this.emptyTexture=u.createEmptyTexture(e);for(var t=0;t<4;++t)this.cascades.push(new w)}return e.prototype.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null},Object.defineProperty(e.prototype,"textureResolution",{get:function(){return this.textureRes},set:function(e){this.textureRes=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=h.clamp(Math.floor(e),1,4)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return!!this.depthTexture},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),e.prototype.getDepthTexture=function(){return this.depthTexture},e.prototype.getCascades=function(){for(var e=0;e<this.numCascades;++e)G[e]=this.cascades[e];return G.length=this.numCascades,G},e.prototype.prepare=function(e,t,a){l.assert(this.enabled),r.mat4.multiply(D,e.projectionMatrix,e.viewMatrix);var c=a.near,i=a.far;c<2&&(c=2),i<2&&(i=2),c>=i&&(c=2,i=4),this.numCascades=Math.min(1+Math.floor(l.logWithBase(i/c,4)),this.maxNumCascades);for(var s=Math.pow(i/c,1/this.numCascades),n=0;n<this.numCascades+1;++n)this.cascadeDistances[n]=c*Math.pow(s,n);r.mat4.invert(R,D),r.mat4.lookAt(k,[0,0,0],[-t[0],-t[1],-t[2]],[0,1,0]);for(var f=e.viewMatrix,d=e.projectionMatrix,n=0;n<this.numCascades;++n){var u=this.cascades[n],p=-this.cascadeDistances[n],m=-this.cascadeDistances[n+1],x=(d[10]*p+d[14])/Math.abs(d[11]*p+d[15]),y=(d[10]*m+d[14])/Math.abs(d[11]*m+d[15]);l.assert(x<y);for(var g=0;g<8;++g){var w=g%4==0||g%4==3?-1:1,T=g%4==0||g%4==1?-1:1,O=g<4?x:y;v.vec4.set(U,w,T,O,1),v.vec4.transformMat4(j[g],U,R);for(var G=0;G<3;++G)j[g][G]/=j[g][3]}o.vec3.negate(z,j[0]),r.mat4.translate(C,k,z),u.camera.viewMatrix=C;for(var g=0;g<8;++g)o.vec3.transformMat4(j[g],j[g],u.camera.viewMatrix);o.vec3.copy(A,j[0]),o.vec3.copy(P,j[0]);for(var g=1;g<8;++g)for(var G=0;G<3;++G)A[G]=Math.min(A[G],j[g][G]),P[G]=Math.max(P[G],j[g][G]);A[2]-=200,P[2]+=200,u.camera.near=-P[2],u.camera.far=-A[2];c=1/j[0][3],i=1/j[4][3],l.assert(c<i);var B=c+Math.sqrt(c*i),E=Math.sin(h.acos(f[2]*t[0]+f[6]*t[1]+f[10]*t[2]));B/=E,b(j,B,E,F,N,S,q,W),M(F,N,q,W,u.camera.projectionMatrix),u.camera.projectionMatrix[10]=2/(A[2]-P[2]),u.camera.projectionMatrix[14]=-(A[2]+P[2])/(A[2]-P[2]),r.mat4.multiply(u.lightMat,u.camera.projectionMatrix,u.camera.viewMatrix);var H=this.textureRes/2;u.camera.viewport[0]=n%2==0?0:H,u.camera.viewport[1]=0===Math.floor(n/2)?0:H,u.camera.viewport[2]=H,u.camera.viewport[3]=H}this.lastOrigin=null,this.cascadeDistances[this.numCascades]=100*i;var V=this.rctx;V.bindFramebuffer(this.fbo),V.bindTexture(null,7),V.setClearColor(1,1,1,1),V.clearSafe(16640)},e.prototype.finish=function(e){l.assert(this.enabled),this.rctx.bindFramebuffer(e),this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()},e.prototype.bind=function(e){var t=this.rctx,a=this.enabled;t.bindTexture(a?this.depthTexture:this.emptyTexture,7),t.bindProgram(e),e.setUniform1i("depthTex",7),e.setUniform1f("depthHalfPixelSz",a?.5/this.textureRes:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])},e.prototype.bindAll=function(e){for(var t=e.getProgramsUsingUniform("shadowMapDistance"),a=0;a<t.length;a++)this.bind(t[a])},e.prototype.bindView=function(e,t){if(this.enabled){var a=this.lastOrigin;if(!(a&&a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2])){this.lastOrigin=this.lastOrigin||n.vec3f64.create(),o.vec3.copy(this.lastOrigin,t);for(var c=0;c<this.numCascades;++c){r.mat4.translate(B,this.cascades[c].lightMat,t);for(var i=0;i<16;++i)E[16*c+i]=B[i]}}e.setUniformMatrix4fv("shadowMapMatrix",E)}},e.prototype.enable=function(){if(!this.enabled){var e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureRes,height:this.textureRes};this.depthTexture=new m(this.rctx,e),this.fbo=p.createWithAttachments(this.rctx,this.depthTexture,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes})}},e.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.fbo=null,this.depthTexture=null)},e.prototype.getGpuMemoryUsage=function(){return x.getGpuMemoryUsage(this.fbo)},e}(),C=c.mat4f64.create(),D=c.mat4f64.create(),R=c.mat4f64.create(),U=f.vec4f64.create(),j=[],O=0;O<8;++O)j.push(f.vec4f64.create());var A=n.vec3f64.create(),P=n.vec3f64.create(),F=s.vec2f64.create(),N=s.vec2f64.create(),S=s.vec2f64.create(),q=s.vec2f64.create(),W=s.vec2f64.create(),k=c.mat4f64.create(),z=n.vec3f64.create(),G=[],B=c.mat4f64.create(),E=new Float32Array(64),H=s.vec2f64.create(),V=s.vec2f64.create(),I=[s.vec2f64.create(),s.vec2f64.create(),s.vec2f64.create(),s.vec2f64.create()],J=s.vec2f64.create(),K=s.vec2f64.create(),L=s.vec2f64.create(),Q=s.vec2f64.create(),X=s.vec2f64.create(),Y=s.vec2f64.create(),Z=s.vec2f64.create(),$=s.vec2f64.create(),_=s.vec2f64.create(),ee=a.mat3f64.create();return T});