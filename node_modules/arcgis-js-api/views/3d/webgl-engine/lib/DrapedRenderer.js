// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../support/debugFlags","../../webgl-engine/lib/intersectorUtils","./Camera","./DefaultVertexBufferLayouts","./glUtil3D","./GridLocalOriginFactory","./Renderer","../lighting/Lightsources","../materials/ColorMaterial","../materials/HUDMaterial","../materials/RibbonLineMaterial","../shaders/MiscPrograms","../../../webgl/FramebufferObject","../../../webgl/renderState","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,n,a,s,o,l,d,h,u,g,p,c,f,m,_,y,x,v){var T,w=function(){function e(e,t,r,a,s,o){var l=this;this._renderTargets={},this._clearColor=n.vec4f64.fromValues(0,0,0,0),this._uniqueIdx=0,this._localOrigins=new h,this._rctx=e,this._canvas=t,this._programRep=r,this._modelDirtySet=o,this._modelDirtySet.onMaterialChanged=function(e){return l.materialChanged(e)},this._renderer=new u(r,a,s,this._rctx,"draped"),this._renderer.onHasHighlightsChanged=function(e){l.onHasHighlightsChanged&&l.onHasHighlightsChanged(e)},this._renderer.setLighting({lights:[new g.AmbientLight(i.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})}return e.prototype.dispose=function(){for(var e in this._renderTargets)this._renderTargets[e].dispose();this._renderTargets=null,this._renderer.dispose(),this._renderer=null},e.prototype.createRenderTarget=function(e){return this.createRenderTargetInternal(e,!0)},e.prototype.createHighlightRenderTarget=function(e){return this.createRenderTargetInternal(e,!1)},e.prototype.disposeRenderTarget=function(e){var t=this._renderTargets[e];t&&t.dispose(),delete this._renderTargets[e]},e.prototype.getRenderTargetTexture=function(e){var t=this._renderTargets[e];return t?t.colorTexture:null},e.prototype.addRenderGeometries=function(e){var t=this;e.forEach(function(e){null==e.origin&&(e.origin=t._localOrigins.getOrigin(e.center)),e.idx=t._uniqueIdx++}),this._renderer.modify(e,[]),this.onContentChanged&&this.onContentChanged()},e.prototype.removeRenderGeometries=function(e){this._renderer.modify([],e),this.onContentChanged&&this.onContentChanged()},e.prototype.updateRenderGeometries=function(e,t){var r=e.map(function(e){return{renderGeometry:e,updateType:t}});this._renderer.modify([],[],r),this.onContentChanged&&this.onContentChanged()},e.prototype.updateRenderOrder=function(e){e.size>0&&(this._renderer.modifyRenderOrder(e),this.onContentChanged&&this.onContentChanged())},e.prototype.setBackgroundColor=function(e){this._clearColor=e,this.onContentChanged&&this.onContentChanged()},e.prototype.updateHighlights=function(e){this.updateRenderGeometries(e,16)},e.prototype.isEmpty=function(){return this._renderer.isEmpty()&&!a.OVERLAY_DRAW_TEST_TEXTURE},e.prototype.processDirtyMaterials=function(){var e=this._modelDirtySet.getDirtyMaterials();e&&this._renderer.modify([],[],[],e),this._modelDirtySet.clearDirtyMaterials()},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),e.prototype.draw=function(e,t){return this.drawPass(0,e,t)},e.prototype.drawHighlights=function(e,t){return this.drawPass(4,e,t)},e.prototype.drawPass=function(e,t,i){if(T=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||4===e&&!this.hasHighlights)return!1;if(this.processDirtyMaterials(),!i.views.some(function(e){return e.extent[0]!==e.extent[2]&&e.extent[1]!==e.extent[3]}))return!1;var n=this._renderTargets[t];if(!n)return!1;var s=this._rctx,o=i.width,l=i.height;n.width===o&&n.height===l||(n.resize(o,l),n.colorTexture.setSamplingMode(9729));var d=b.camera;b.fbo=n,d.near=1,d.far=1e4,d.pixelRatio=i.pixelRatio||1,s.bindFramebuffer(n),s.setClearColor.apply(s,this._clearColor),s.clearSafe(16384);for(var h=0;h<i.views.length;h++){var u=i.views[h];d.viewport=u.viewport,r.mat4.ortho(d.projectionMatrix,0,u.extent[2]-u.extent[0],0,u.extent[3]-u.extent[1],d.near,d.far),r.mat4.identity(d.viewMatrix),r.mat4.translate(d.viewMatrix,d.viewMatrix,[-u.extent[0],-u.extent[1],0]),d.setGLViewport(this._rctx),a.OVERLAY_DRAW_TEST_TEXTURE&&this._drawTestTexture(o,l,C[i.index%C.length]),this._renderer.renderPass(e,b)}return s.bindFramebuffer(null),s.setViewport(0,0,this._canvas.width,this._canvas.height),n.colorTexture.descriptor.hasMipmap&&n.colorTexture.generateMipmap(),!0},e.prototype._drawTestTexture=function(e,t,r){var i=this._rctx;if(!this._testPatternTexture){for(var n=new Uint8Array(e*t*4),a=0,s=0;s<t;s++)for(var o=0;o<e;o++){var h=Math.floor(o/10),u=Math.floor(s/10);h<2||u<2||10*h>e-20||10*u>t-20?(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=255):(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=1&h&&1&u?1&o^1&s?0:255:1&h^1&u?0:128)}this._testPatternTexture=new x(i,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},n),this._testPatternProgram=this._programRep.getProgram(m.texOnly),this._testPatternPipelineState=y.makePipelineState({blending:y.separateBlendingParams(770,1,771,771),colorWrite:y.defaultColorWriteParams}),this._quadVAO=d.createQuadVAO(i,l.Pos3Tex)}var g=this._testPatternProgram;i.bindProgram(g),i.setPipelineState(this._testPatternPipelineState),g.setUniform4f("color",r[0],r[1],r[2],1),g.setUniform1i("tex",0),i.bindTexture(this._testPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,v.vertexCount(this._quadVAO,"geometry"))},e.prototype.materialChanged=function(e){this.onContentChanged&&this.onContentChanged()},e.prototype.createRenderTargetInternal=function(e,t){for(var r=e,i=0;this._renderTargets[r];)r=e+"_"+ ++i;return this._renderTargets[r]=_.createWithAttachments(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0},{colorTarget:0,depthStencilTarget:0}),r},e.prototype.getGpuMemoryUsage=function(){var e=0;for(var t in this._renderTargets){var r=this._renderTargets[t];e+=v.getGpuMemoryUsage(r)}return e},e.prototype.intersect=function(e,t,r){var i=this,n=0;this._renderer.forEachRenderGeometry(function(a){if(!r||r(a)){if(a.material instanceof p||a.material instanceof f||a.material instanceof c){var s=a.transformation[12],o=a.transformation[13];R[0]=t[0]-s,R[1]=t[1]-o,R[2]=1,M[0]=t[0]-s,M[1]=t[1]-o,M[2]=0,a.pixelRatio=T,a.material.intersect(a,null,a.getShaderTransformation(),e,R,M,function(t,r,s,o,l,d){i.addIntersectionResult(t,r,s,a.material.renderPriority,n,l,d,e,a.data.layerUid,a.data.graphicUid)},a.calculateShaderTransformation,!0)}n++}})},e.prototype.addIntersectionResult=function(e,t,r,i,n,a,o,l,d,h){var u={type:"external",metadata:{layerUid:d,graphicUid:h}},g=function(e){e.set(u,null,l.results.terrain.dist,l.results.terrain.normal,l.results.terrain.transformation,i,null,null,r,n),e.intersector="DrapedRenderer"};if((null==l.results.min.drapedLayerOrder||i>=l.results.min.drapedLayerOrder)&&(null==l.results.min.dist||l.results.terrain.dist<=l.results.min.dist)&&g(l.results.min),(null==l.results.max.drapedLayerOrder||i<l.results.max.drapedLayerOrder)&&(null==l.results.max.dist||l.results.terrain.dist>l.results.max.dist)&&g(l.results.max),l.enable.storeAll){var p=new s.IntersectorResult(l.ray);g(p),l.results.all.push(p)}},e}(),C=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],b={fbo:null,camera:new o,lightDirection:i.vec3f64.fromValues(0,0,1)},R=i.vec3f64.create(),M=i.vec3f64.create();return w});