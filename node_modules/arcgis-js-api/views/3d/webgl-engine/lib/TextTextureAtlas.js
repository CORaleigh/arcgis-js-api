// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/iteratorUtils","../../../../core/mathUtils","./ModelContentType","./Texture","../../../webgl/Texture"],function(e,t,s,i,r,n,a){Object.defineProperty(t,"__esModule",{value:!0});var o=512,l=function(){function e(e,t){this.dirty=!1,this.elementsToAdd=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.id=n.idGen.gen(e),this.stage=t._stage,this.scheduler=t.resourceController.scheduler,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(r.TEXTURE,this);var s=this.computeAtlasResolution(t.width,t.height);this.createAtlasRegion(s),this.update2DCanvasSize()}return e.prototype.setUnloadFunc=function(e){this.unloadFunc=e},e.prototype.unload=function(){null!=this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=null)},e.prototype.deferredLoading=function(){return!1},e.prototype.getWidth=function(){return this.atlas.size.width},e.prototype.getHeight=function(){return this.atlas.size.height},e.prototype.initializeThroughRender=function(e,t){var s=this;return t.wrapMode=33071,t.samplingMode=9987,t.flipped=!0,t.preMultiplyAlpha=!0,t.hasMipmap=!0,this.glTexture=new a(e,t,this.canvas),this.frameWorker=this.scheduler.registerTask(12,function(e){return s.run(s.makeRunContext(e))},function(){return s.dirty}),this.glTexture},e.prototype.dispose=function(){this.elements=null,this.elementsToAdd=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.glTexture&&(this.glTexture=null,this.stage.remove(r.TEXTURE,this.id))},e.prototype.create2DCanvas=function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",o.toString()),e.setAttribute("height",o.toString()),e},e.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())},e.prototype.createAtlasRegion=function(e){void 0===e&&(e=o),this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}},e.prototype.computeAtlasResolution=function(e,t){var s=Math.max(e,t);return s+=256,s=i.nextHighestPowerOfTwo(s),s=Math.min(s,4096)},e.prototype.resizeAtlas=function(e,t){t=t||e;var s=this.atlas;s.size.width=e,s.size.height=t,this.glTexture&&this.glTexture.resize(e,t),this.update2DCanvasSize()},e.prototype.resetAtlasCursor=function(){var e=this.atlas;e.cursor.x=h,e.cursor.y=h+d,e.lineHeight=0},e.prototype.getAtlasUsage=function(){var e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)},e.prototype.getExpectedAtlasUsage=function(){var e=this.elementsToRemove.size,t=this.elementsToAdd.size,s=this.elements.size;return this.getAtlasUsage()/s*(s+t-e)},e.prototype.addAtlasElement=function(e,t,s,i){var r=this.atlas,n=e.textRenderer,a=n.renderedWidth,o=n.renderedHeight,l=n.displayWidth,h=n.displayHeight;e.placement.offset.x=r.cursor.x,e.placement.offset.y=r.cursor.y,e.placement.size.width=a,e.placement.size.height=o,e.placement.size.displayWidth=l,e.placement.size.displayHeight=h,e.placement.uvMinMax=[e.placement.offset.x/r.size.width,1-(e.placement.offset.y+o)/r.size.height,(e.placement.offset.x+a)/r.size.width,1-e.placement.offset.y/r.size.height],r.cursor.x+=s,r.lineHeight=Math.max(r.lineHeight,i),this.elements.set(t,e)},e.prototype.removeAtlasElement=function(e){if(e&&this.elements.has(e.textId)){var t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),this.elements.delete(e.textId)}},e.prototype.ensureStageObjects=function(e){var t=this.stageObjects.get(e);if(!t){var s=new Set;return this.stageObjects.set(e,s),s}return t},e.prototype.addStageObject=function(e,t){this.ensureStageObjects(e).add(t)},e.prototype.removeStageObject=function(e,t){var s=this.stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),t.geometryVertexAttrsUpdated(0))},e.prototype.processAdditionRequest=function(e,t){var s=this.atlas,i=e.textId,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=r+h,o=n+h+d,l=t.repackingEnabled;if(s.cursor.x+a<s.size.width&&s.cursor.y+o<s.size.height)this.addAtlasElement(e,i,a,o),this.elementsToRender.set(i,e),this.elementsToAdd.delete(i);else{if(!(s.cursor.y+o+s.lineHeight<s.size.height)){var u=this.getExpectedAtlasUsage(),c=u>.85&&s.size.width<4096;return c&&this.resizeAtlas(2*s.size.width,2*s.size.height),!l||!c&&u>.95&&4096===s.size.width?(this.processRemovals(),0):(this.repack(),1)}s.cursor.x=h,s.cursor.y+=s.lineHeight,s.lineHeight=0,this.addAtlasElement(e,i,a,o),this.elementsToRender.set(i,e),this.elementsToAdd.delete(i)}return 0},e.prototype.processRemovals=function(){var e=this;this.elementsToRemove.forEach(function(t,s){var i=e.stageObjects.get(s);i&&0!==i.size||e.removeAtlasElement(t),i&&0===i.size&&e.stageObjects.delete(s)}),this.elementsToRemove.clear()},e.prototype.repack=function(){var e=this;this.processRemovals(),this.elements.forEach(function(t,s){t.rendered=!1,e.elementsToAdd.set(s,t)}),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()},e.prototype.processRenderingRequest=function(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);var t=this.stageObjects.get(e.textId);t&&t.forEach(function(t){t.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(e.placement.uvMinMax),t.geometries[0].data.vertexAttributes.size.data=new Float32Array([e.placement.size.displayWidth,e.placement.size.displayHeight]),t.geometryVertexAttrsUpdated(0)}),e.rendered=!0},e.prototype.run=function(t){var i=this;if(this.dirty&&this.glTexture){var r=t.budget,n=!1;if(s.everyMap(this.elementsToAdd,function(e,s){var r=i.elements.get(s);if(r&&r.rendered){var a=i.stageObjects.get(s);return a&&a.forEach(function(e){var t=e.geometries[0].data.vertexAttributes,r=i.elements.get(s);t.uv0.data=new Float32Array(r.placement.uvMinMax),t.size.data=new Float32Array([r.placement.size.displayWidth,r.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)}),i.elementsToAdd.delete(s),!0}return 1!==i.processAdditionRequest(i.elementsToAdd.get(s),t)||(n=!0,!1)}),n)return t.budget=null,t.repackingEnabled=!1,void this.run(t);var a=!1;s.everyMap(this.elementsToRender,function(e,t){return i.processRenderingRequest(e),i.elementsToRender.delete(t),a=!0,!r||(r.madeProgress(),!r.done)}),a&&this.glTexture.setData(this.canvas),this.dirty=this.elementsToRender.size>0,!this.dirty&&e.test.orderedRepackingEnabled&&this.repackOrdered()}},e.prototype.makeRunContext=function(e){return void 0===e&&(e=null),u.budget=e,u.repackingEnabled=!0,u},e.prototype.addTextTexture=function(e,t){var s=e.key;this.elementsToAdd.has(s)||this.elementsToAdd.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(s,t),this.elementsToRemove.delete(s),this.setDirty()},e.prototype.removeTextTexture=function(e,t){var s=e.key;this.elementsToRemove.set(s,this.elements.get(s)),this.removeStageObject(s,t)},Object.defineProperty(e.prototype,"textureId",{get:function(){return this.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!0,configurable:!0}),e.prototype.setDirty=function(){this.dirty=!0},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{elements:e.elements,stageObjects:e.stageObjects,elementsToRemove:e.elementsToRemove,atlas:e.atlas,resizeAtlas:e.resizeAtlas.bind(this)}},enumerable:!0,configurable:!0}),e.prototype.repackOrdered=function(){if(0!==this.elements.size){var e=[];this.elements.forEach(function(t,s){return e.push({element:t,key:s})});for(var t=!0,s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t){e.sort(function(e,t){return e.key.localeCompare(t.key)}),this.elements.clear();for(var i=0,r=e;i<r.length;i++){var n=r[i],a=n.element,o=n.key;this.elements.set(o,a)}this.repack(),this.setDirty()}}},e.test={orderedRepackingEnabled:!1},e}();t.TextTextureAtlas=l;var h=2,d=2,u={budget:null,repackingEnabled:!0};t.default=l});