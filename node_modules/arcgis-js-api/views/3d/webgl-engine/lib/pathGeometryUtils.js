// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/mathUtils","./GeometryData","./GeometryUtil","./Util"],function(t,e,i,r,s,a,n,o,h,c,u,l,v,f,d,m){var p;!function(t){var e=function(){function t(t){this.pos=t,this.mapPos=c.vec3f32.create(),this.vRight=c.vec3f32.create(),this.vLeft=c.vec3f32.create(),this.frame={forward:c.vec3f32.create(),up:c.vec3f32.create(),right:c.vec3f32.create()},this.rotationAxis=c.vec3f32.create(),this.angle=0}return t.prototype.profileSpaceToVertexSpace=function(t,e){t[0]=e[0]*this.frame.right[0]+e[1]*this.frame.up[0],t[1]=e[0]*this.frame.right[1]+e[1]*this.frame.up[1],t[2]=e[0]*this.frame.right[2]+e[1]*this.frame.up[2]},t}();t.PathVertex=e;var i=function(){function t(){this.vertices=[],this.vertexIndices=[],this.normals=null,this.normalIndices=null,this.uvs=null,this.uvIndices=null}return t.prototype.addVertex=function(t){return this.vertices.push(o.vec2f32.clone(t)),this.vertices.length-1},t.prototype.addNormal=function(t){return this.normals||(this.normals=[],this.normalIndices=[]),this.normals.push(o.vec2f32.clone(t)),this.normals.length-1},t.prototype.addUV=function(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1},t.prototype.addSegment=function(t,e,i,r,s,a){void 0===i&&(i=null),void 0===r&&(r=null),void 0===s&&(s=null),void 0===a&&(a=null),this.vertexIndices.push(t),this.vertexIndices.push(e),null!==i&&null!==r&&(this.normalIndices.push(i),this.normalIndices.push(r)),null!==s&&null!==a&&(this.uvIndices.push(s),this.uvIndices.push(a))},Object.defineProperty(t.prototype,"numSegments",{get:function(){return this.vertexIndices.length/2},enumerable:!0,configurable:!0}),t.prototype.hasNormals=function(){return null!=this.normals},t.prototype.hasUV=function(){return null!=this.uvs},t.prototype.normalize=function(){for(var t=0,e=0,i=this.vertices;e<i.length;e++){var r=i[e];t=Math.max(t,n.vec2.length(r))}for(var s=1/t,a=0,o=this.vertices;a<o.length;a++){var r=o[a];n.vec2.scale(r,r,s)}},t.tube=function(e){void 0===e&&(e=20);for(var i=new t,r=0;r<e;++r){var s=2*r*Math.PI/e;i.addVertex(o.vec2f32.fromValues(1*Math.cos(s),1*Math.sin(s))),i.addUV(r/e)}i.addUV(1);for(var r=0;r<e-1;++r)i.addSegment(r,r+1,null,null,r,r+1);return i.addSegment(e-1,0,null,null,e-1,e),i},t.line=function(e,i){var r=new t,s=i[0]-e[0],a=i[1]-e[1];return r.addVertex(e),r.addVertex(i),r.addNormal(o.vec2f32.fromValues(-a,s)),r.addUV(0),r.addUV(1),r.addSegment(0,1,0,0,0,1),r},t.point=function(e){var i=new t;return i.addVertex(e),i},t.wall=function(e,i){void 0===e&&(e=.2),void 0===i&&(i=1);var r=new t;return r.addVertex(o.vec2f32.fromValues(.5*-e,0)),r.addVertex(o.vec2f32.fromValues(.5*e,0)),r.addVertex(o.vec2f32.fromValues(.5*e,i)),r.addVertex(o.vec2f32.fromValues(.5*-e,i)),r.addNormal(o.vec2f32.fromValues(0,-1)),r.addNormal(o.vec2f32.fromValues(1,0)),r.addNormal(o.vec2f32.fromValues(0,1)),r.addNormal(o.vec2f32.fromValues(-1,0)),r.addUV(0),r.addUV(1),r.addSegment(0,1,0,0,0,1),r.addSegment(1,2,1,1,0,1),r.addSegment(2,3,2,2,0,1),r.addSegment(3,0,3,3,0,1),r},t.strip=function(){return this.line(o.vec2f32.fromValues(-1,0),o.vec2f32.fromValues(1,0))},t.fence=function(){return this.line(o.vec2f32.fromValues(0,0),o.vec2f32.fromValues(0,1))},t}();t.Profile=i;var a=function(){function t(t,i,r,s,a,n){this.vertices=[],this.offset=c.vec3f32.create(),h.vec3.copy(this.offset,n);for(var o=r;o<r+s;++o){var f=new e(c.vec3f32.fromValues(t[3*o+0],t[3*o+1],t[3*o+2]));h.vec3.set(f.mapPos,i[3*o+0],i[3*o+1],i[3*o+2]),this.vertices.push(f)}var m,p,x=c.vec3f32.create(),V=c.vec3f32.create(),g=c.vec3f32.create(),y=c.vec3f32.create(),b=c.vec3f32.create(),D=u.vec3f64.create(),A=c.vec3f32.create(),_=c.vec3f32.create(),N=c.vec3f32.create(),C=c.vec3f32.create(),U=l.plane.create(),S=this.vertices[0];h.vec3.set(A,0,1,0),h.vec3.subtract(V,this.vertices[1].pos,S.pos),m=0,p=h.vec3.length(V),h.vec3.normalize(V,V),a?(h.vec3.add(D,S.pos,this.offset),h.vec3.normalize(g,D)):h.vec3.set(g,0,0,1),d.makeOrthoBasisDirUpFallback(V,g,A,A,b,g,.99619469809),h.vec3.copy(y,g),h.vec3.copy(C,b),h.vec3.copy(S.vRight,V),h.vec3.copy(S.vLeft,x),h.vec3.copy(S.frame.forward,V),h.vec3.copy(S.frame.up,g),h.vec3.copy(S.frame.right,b),S.vLeftLength=m,S.vRightLength=p,S.index=0,h.vec3.cross(S.rotationAxis,S.vLeft,S.vRight),h.vec3.normalize(S.rotationAxis,S.rotationAxis),S.angle=0;for(var O=1;O<s;++O){S=this.vertices[O],h.vec3.copy(x,V),m=p,O<s-1&&(h.vec3.subtract(V,this.vertices[O+1].pos,S.pos),p=h.vec3.length(V),h.vec3.normalize(V,V)),h.vec3.add(_,x,V),h.vec3.normalize(_,_),h.vec3.add(N,this.vertices[O-1].pos,y),l.plane.fromPositionAndNormal(this.vertices[O].pos,_,U);l.plane.intersectRay(U,l.ray.wrap(N,x),D)?(h.vec3.subtract(D,D,this.vertices[O].pos),h.vec3.normalize(g,D),h.vec3.cross(b,_,g),h.vec3.normalize(b,b)):d.makeOrthoBasisDirUpFallback(_,y,C,A,b,g,.99619469809),h.vec3.copy(y,g),h.vec3.copy(C,b),h.vec3.copy(S.vRight,V),h.vec3.copy(S.vLeft,x),h.vec3.copy(S.frame.forward,_),h.vec3.copy(S.frame.up,g),h.vec3.copy(S.frame.right,b),S.vLeftLength=m,S.vRightLength=p,S.index=O,h.vec3.cross(S.rotationAxis,S.vLeft,S.vRight),h.vec3.normalize(S.rotationAxis,S.rotationAxis),h.vec3.negate(I,S.vLeft),S.angle=Math.PI-v.acos(h.vec3.dot(I,S.vRight))}}return t}();t.Path=a;var p=function(){function t(){}return t}();t.Extruder=p;var _=function(){function t(){}return t.prototype.numVertices=function(t){return t.vertices.length},t.prototype.extrude=function(t,e,i){for(var r=0;r<e.vertices.length;++r){var s=e.vertices[r];s.profileSpaceToVertexSpace(x,t),i(s.pos,x,r)}},t}();t.SimpleExtruder=_;var N=function(){function t(t){void 0===t&&(t=1),this._segmentsPerRadian=t/Math.PI}return t.prototype.getNumSegments=function(t){return Math.ceil(t*this._segmentsPerRadian)},t.prototype.numVertices=function(t){for(var e=2,i=1;i<t.vertices.length-1;++i)e+=this.getNumSegments(t.vertices[i].angle)+1;return e},t.prototype.extrude=function(t,e,i){e.vertices[0].profileSpaceToVertexSpace(x,t),i(e.vertices[0].pos,x,0),h.vec3.copy(y,x);for(var r=1;r<e.vertices.length-1;++r){var a=e.vertices[r];a.profileSpaceToVertexSpace(x,t);var n=this.getNumSegments(a.angle);if(s.mat4.identity(A),s.mat4.rotate(A,A,.5*-a.angle,a.rotationAxis),h.vec3.transformMat4(b,x,A),h.vec3.dot(b,a.vRight)>=0){for(var o=0;o<n+1;++o)i(a.pos,x,r);h.vec3.copy(y,x)}else{s.mat4.identity(A),s.mat4.rotate(A,A,a.angle/n,a.rotationAxis),i(a.pos,b,r),h.vec3.copy(D,b);for(var o=0;o<n;++o)h.vec3.transformMat4(D,D,A),i(a.pos,D,r);h.vec3.copy(y,D)}}var c=e.vertices.length-1;e.vertices[c].profileSpaceToVertexSpace(x,t),i(e.vertices[c].pos,x,c)},t}();t.RoundExtruder=N;var C=function(t){function e(){return t.call(this,1)||this}return r(e,t),e}(N);t.BevelExtruder=C;var U={generateUV:!1},S=function(){function t(t,e,i,r){void 0===r&&(r=U),this.options=r,this._extrusionVertexCount=0,this._extrusionNormalCount=0,this._numExtrusionVertices=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this._capNormalsOffset=0,this.profile=e,this.profile.normalize(),this.path=t,this.extruder=i,this._numExtrusionVertices=i.numVertices(t),this.numVerticesTotal=e.vertices.length*this._numExtrusionVertices,this.profile.hasNormals()?this.numNormalsTotal=this.profile.normals.length*this._numExtrusionVertices:this.numNormalsTotal=this.numVerticesTotal,this.numNormalsTotal+=2,this.originData=new Float32Array(3*this.numVerticesTotal),this.directionData=new Float32Array(4*this.numVerticesTotal),this.normalData=new Float32Array(3*this.numNormalsTotal),this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.buildGeometry(),this.buildTopology()}return t.prototype.emitVertex=function(t,e,i){this.originData[3*this._extrusionVertexCount+0]=t[0],this.originData[3*this._extrusionVertexCount+1]=t[1],this.originData[3*this._extrusionVertexCount+2]=t[2],this.directionData[4*this._extrusionVertexCount+0]=e[0],this.directionData[4*this._extrusionVertexCount+1]=e[1],this.directionData[4*this._extrusionVertexCount+2]=e[2],this.directionData[4*this._extrusionVertexCount+3]=i/(this.path.vertices.length-1),this.pathVertexData[this._extrusionVertexCount]=i,++this._extrusionVertexCount},t.prototype.emitNormal=function(t,e,i){h.vec3.normalize(V,e),this.normalData[3*this._extrusionNormalCount+0]=V[0],this.normalData[3*this._extrusionNormalCount+1]=V[1],this.normalData[3*this._extrusionNormalCount+2]=V[2],++this._extrusionNormalCount},t.prototype.buildGeometry=function(){var t=this.emitVertex.bind(this),e=this.emitNormal.bind(this);this._extrusionVertexCount=0,this._extrusionNormalCount=0;for(var i=0;i<this.profile.vertices.length;++i)this.extruder.extrude(this.profile.vertices[i],this.path,t);if(this.profile.hasNormals())for(var r=0;r<this.profile.normals.length;++r)this.extruder.extrude(this.profile.normals[r],this.path,e);else for(var r=0;r<this._extrusionVertexCount;++r)h.vec3.set(V,this.directionData[4*r+0],this.directionData[4*r+1],this.directionData[4*r+2]),h.vec3.normalize(V,V),this.normalData[3*this._extrusionNormalCount+0]=V[0],this.normalData[3*this._extrusionNormalCount+1]=V[1],this.normalData[3*this._extrusionNormalCount+2]=V[2],++this._extrusionNormalCount;this._capNormalsOffset=this._extrusionNormalCount;var s=this.path.vertices[0],a=this.path.vertices[this.path.vertices.length-1];if(this.normalData[3*this._extrusionNormalCount+0]=-s.vRight[0],this.normalData[3*this._extrusionNormalCount+1]=-s.vRight[1],this.normalData[3*this._extrusionNormalCount+2]=-s.vRight[2],++this._extrusionNormalCount,this.normalData[3*this._extrusionNormalCount+0]=a.vRight[0],this.normalData[3*this._extrusionNormalCount+1]=a.vRight[1],this.normalData[3*this._extrusionNormalCount+2]=a.vRight[2],++this._extrusionNormalCount,this.profile.hasUV()&&this.options.generateUV)for(var r=0;r<this.profile.uvs.length;++r)this.uvData[2*r+0]=this.profile.uvs[r],this.uvData[2*r+1]=0},t.prototype.buildTopology=function(){var t=this.profile.numSegments,e=this._numExtrusionVertices-1,i=t*e,r=2*i,s=3*r;this.profile.vertices.length>2&&(s+=2*(this.profile.vertices.length-2)*3),this.vertexIndices=new Uint32Array(s),this.normalIndices=new Uint32Array(s),this.pathVertexIndices=new Uint32Array(s),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(s));for(var a=0,n=0;n<t;++n){var o=this.profile.vertexIndices[2*n],h=this.profile.vertexIndices[2*n+1],c=o,u=h,l=0,v=0;this.profile.hasNormals()&&(c=this.profile.normalIndices[2*n],u=this.profile.normalIndices[2*n+1]),this.profile.hasUV()&&this.options.generateUV&&(l=this.profile.uvIndices[2*n],v=this.profile.uvIndices[2*n+1]);for(var f=0;f<e;++f){var d=o*this._numExtrusionVertices+f,m=o*this._numExtrusionVertices+f+1,p=h*this._numExtrusionVertices+f+1,x=h*this._numExtrusionVertices+f,V=c*this._numExtrusionVertices+f,g=c*this._numExtrusionVertices+f+1,I=u*this._numExtrusionVertices+f+1,y=u*this._numExtrusionVertices+f,b=l,D=l,A=v,_=v;this.vertexIndices[3*a+0]=d,this.vertexIndices[3*a+1]=m,this.vertexIndices[3*a+2]=p,this.pathVertexIndices[3*a+0]=this.pathVertexData[d],this.pathVertexIndices[3*a+1]=this.pathVertexData[m],this.pathVertexIndices[3*a+2]=this.pathVertexData[p],this.normalIndices[3*a+0]=V,this.normalIndices[3*a+1]=g,this.normalIndices[3*a+2]=I,this.vertexIndices[3*a+3]=d,this.vertexIndices[3*a+4]=p,this.vertexIndices[3*a+5]=x,this.pathVertexIndices[3*a+3]=this.pathVertexData[d],this.pathVertexIndices[3*a+4]=this.pathVertexData[p],this.pathVertexIndices[3*a+5]=this.pathVertexData[x],this.normalIndices[3*a+3]=V,this.normalIndices[3*a+4]=I,this.normalIndices[3*a+5]=y,this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices[3*a+0]=b,this.uvIndices[3*a+1]=D,this.uvIndices[3*a+2]=A,this.uvIndices[3*a+3]=b,this.uvIndices[3*a+4]=A,this.uvIndices[3*a+5]=_),a+=2}}if(this.profile.vertices.length>2)for(var N=this.profile.vertices.length-2,o=0,C=o*this._numExtrusionVertices+0,U=(o+1)*this._numExtrusionVertices-1,f=0;f<N;++f){var h=f+1,S=h*this._numExtrusionVertices+0,O=(h+1)*this._numExtrusionVertices-1,P=f+2,T=P*this._numExtrusionVertices+0,E=(P+1)*this._numExtrusionVertices-1;this.vertexIndices[3*a+0]=C,this.vertexIndices[3*a+1]=S,this.vertexIndices[3*a+2]=T,this.normalIndices[3*a+0]=this._capNormalsOffset+0,this.normalIndices[3*a+1]=this._capNormalsOffset+0,this.normalIndices[3*a+2]=this._capNormalsOffset+0,this.pathVertexIndices[3*a+0]=this.pathVertexData[C],this.pathVertexIndices[3*a+1]=this.pathVertexData[S],this.pathVertexIndices[3*a+2]=this.pathVertexData[T],++a,this.vertexIndices[3*a+0]=E,this.vertexIndices[3*a+1]=O,this.vertexIndices[3*a+2]=U,this.normalIndices[3*a+0]=this._capNormalsOffset+1,this.normalIndices[3*a+1]=this._capNormalsOffset+1,this.normalIndices[3*a+2]=this._capNormalsOffset+1,this.pathVertexIndices[3*a+0]=this.pathVertexData[E],this.pathVertexIndices[3*a+1]=this.pathVertexData[O],this.pathVertexIndices[3*a+2]=this.pathVertexData[U],++a}},t}();t.Builder=S;var O=function(){function t(t){this.builder=t}return t.prototype.updateElevation=function(t){for(var e=this.builder.path.offset,i=this.builder.originData,r=0;r<this.builder.numVerticesTotal;++r){var s=this.builder.path.vertices[this.builder.pathVertexData[r]];g[0]=i[3*r+0]+e[0],g[1]=i[3*r+1]+e[1],g[2]=i[3*r+2]+e[2],t.setAltitude(s.elevation,g),i[3*r+0]=g[0]-e[0],i[3*r+1]=g[1]-e[1],i[3*r+2]=g[2]-e[2]}},t}();t.PathGeometry=O;var P=function(t){function e(e,i,r){var s=t.call(this,e)||this;return s.size=i,s.vertexAttributePosition=null,s.vertexAttributeNormal=null,s.vertexAttributeColor=null,s.vertexAttributePosition=new Float32Array(3*s.builder.numVerticesTotal),s.vertexAttributeNormal=s.builder.normalData,s._bakeVertexPositions(),r&&(s.vertexAttributeColor=new Uint8Array(4),s.vertexAttributeColor[0]=255*r[0],s.vertexAttributeColor[1]=255*r[1],s.vertexAttributeColor[2]=255*r[2],s.vertexAttributeColor[3]=255*(r.length>3?r[3]:1)),s}return r(e,t),e.prototype._bakeVertexPositions=function(){for(var t=0;t<this.builder.numVerticesTotal;++t)this.vertexAttributePosition[3*t+0]=this.builder.originData[3*t+0]+this.builder.directionData[4*t+0]*this.size,this.vertexAttributePosition[3*t+1]=this.builder.originData[3*t+1]+this.builder.directionData[4*t+1]*this.size,this.vertexAttributePosition[3*t+2]=this.builder.originData[3*t+2]+this.builder.directionData[4*t+2]*this.size},e.prototype.createGeometryData=function(){var t={};if(t[m.VertexAttrConstants.POSITION]=this.builder.vertexIndices,t[m.VertexAttrConstants.NORMAL]=this.builder.normalIndices,this.vertexAttributeColor){var e=t[m.VertexAttrConstants.POSITION].length;t[m.VertexAttrConstants.COLOR]=new Uint32Array(e)}var i={};return i[m.VertexAttrConstants.POSITION]={size:3,data:this.vertexAttributePosition},i[m.VertexAttrConstants.NORMAL]={size:3,data:this.vertexAttributeNormal},this.vertexAttributeColor&&(i[m.VertexAttrConstants.COLOR]={size:4,data:this.vertexAttributeColor}),new f(i,t,f.DefaultOffsets,"triangle")},e.prototype.updateElevation=function(e){t.prototype.updateElevation.call(this,e),this._bakeVertexPositions()},e}(O);t.StaticPathGeometry=P;var T=function(t){function e(e,i,r,s){var a=t.call(this,e)||this;a.vvData=null,a.vvData=new Float32Array(4*a.builder.path.vertices.length);for(var n=0;n<a.builder.path.vertices.length;++n)a.vvData[4*n+0]=i,a.vvData[4*n+1]=r,a.vvData[4*n+2]=s,a.vvData[4*n+3]=0;return a}return r(e,t),e.prototype.createGeometryData=function(){var t={};t[m.VertexAttrConstants.POSITION]=this.builder.vertexIndices,t[m.VertexAttrConstants.AUXPOS1]=this.builder.vertexIndices,t[m.VertexAttrConstants.NORMAL]=this.builder.normalIndices,t[m.VertexAttrConstants.AUXPOS2]=this.builder.pathVertexIndices;var e={};return e[m.VertexAttrConstants.POSITION]={size:3,data:this.builder.originData},e[m.VertexAttrConstants.AUXPOS1]={size:4,data:this.builder.directionData},e[m.VertexAttrConstants.NORMAL]={size:3,data:this.builder.normalData},e[m.VertexAttrConstants.AUXPOS2]={size:4,data:this.vvData},this.builder.profile.hasUV()&&this.builder.options.generateUV&&(t[m.VertexAttrConstants.UV0]=this.builder.uvIndices,e[m.VertexAttrConstants.UV0]={size:2,data:this.builder.uvData}),new f(e,t,f.DefaultOffsets,"triangle")},e}(O);t.FastUpdatePathGeometry=T}(p||(p={}));var x=c.vec3f32.create(),V=c.vec3f32.create(),g=u.vec3f64.create(),I=c.vec3f32.create(),y=c.vec3f32.create(),b=c.vec3f32.create(),D=c.vec3f32.create(),A=a.mat4f32.create();return p});