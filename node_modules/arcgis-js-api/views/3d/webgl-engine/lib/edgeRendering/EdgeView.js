// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/arrayUtils","../../../../../core/promiseUtils","../../../../../core/requireUtils","../../../../../core/typedArrayUtil","../../../../../core/workers","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4f64","../../../support/mathUtils","../../../support/buffer/BufferView","../../../support/buffer/utils","../GridLocalOriginFactory","../localOriginHelper","../LocalOriginManager","../PreinterleavedGeometryData","../TextureBackedBuffer/BufferManager","./bufferLayouts","./edgeBufferWriters","./EdgeProcessingWorker","./EdgeRenderer","./strokes","./util","../../../../webgl/BufferObject","../../../../webgl/renderState","../../../../webgl/VertexArrayObject","module"],function(e,t,r,i,n,o,s,a,d,c,l,u,f,p,g,h,m,v,b,y,E,x,O,R,T,w,M,C,I,B,k,j){Object.defineProperty(t,"__esModule",{value:!0});var L=function(){function t(e,t,r){this.rctx=e,this.programRepository=t,this.callbacks=r,this.profilingCallback=null,this.perObjectData=new Map,this.renderers=new Map,this.localOrigins=new y.LocalOriginManager(new v),this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.worker=new T,this.workerThread=null,this.destroyed=!1,this.tmpModelPosition=f.vec3f64.create(),this.tmpCameraPosition=f.vec3f64.create(),this.componentColorManager=new x.BufferManager(this.rctx,2)}return t.prototype.initialize=function(){var t=this;c.open(a.getAbsMid("./EdgeProcessingWorker",e,j)).then(function(e){t.destroyed?e.close():t.workerThread=e});for(var r=O.VertexLayout.createBuffer(4),i=0;i<4;i++)r.sideness.set(i,0,0===i||3===i?0:1),r.sideness.set(i,1,0===i||1===i?0:1);this.verticesBufferObject=I.createVertex(this.rctx,35044,r.buffer);var n=this.rctx.capabilities.blendMinMax;this.pipelineState=n?B.makePipelineState({blending:B.separateBlendingParams(1,1,0,1,32774,n.MAX),depthTest:{func:515},colorWrite:B.defaultColorWriteParams}):B.makePipelineState({depthTest:{func:515},depthWrite:B.defaultDepthWriteParams,colorWrite:B.defaultColorWriteParams})},t.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.destroyed=!0)},t.prototype.getUsedMemory=function(){return this.gpuMemoryUsage},Object.defineProperty(t.prototype,"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0}),t.prototype.shouldRender=function(){return this.renderers.size>0},t.prototype.addObject=function(e,t,r,o,a){return i(this,void 0,void 0,function(){var i,d,c,l,u,f,p;return n(this,function(n){switch(n.label){case 0:if(this.hasObject(e))return[2];if(i=new Array,c={loaded:s.create(function(e){return d=e}),renderables:[]},this.perObjectData.set(e,c),a&&a.mergeGeometries&&e.geometries.length>1&&this.canMergeGeometries(e))i.push(this.addObjectMergedGeometries(e,c,t,r));else for(l=0;l<e.geometries.length;l++)u=e.geometries[l],f=e.geometryRecords[l],p=f.material,p.supportsEdges&&(u.data instanceof E?i.push(this.addGeometryPreinterleaved(e,c,u,u.data,f,t,r,o)):i.push(this.addGeometryNonPreinterleaved(e,c,u,u.data,f,t[0],r,o)));return[4,s.all(i)];case 1:return n.sent(),this.callbacks.setNeedsRender(),d(),[2]}})})},t.prototype.hasObject=function(e){return this.perObjectData.has(e)},t.prototype.updateAllComponentOpacities=function(e,t){return i(this,void 0,void 0,function(){var r,i;return n(this,function(n){switch(n.label){case 0:return[4,this.getObjectEntry(e)];case 1:return r=n.sent(),i=t instanceof Array?function(e){return t[e]}:function(e){return t},r.renderables.forEach(function(e){for(var t=e.components.meta.length,r=0;r<t;r++){var n=i(r),o=e.components.meta[r],s=o.index;o.material.opacity=n,e.components.buffer.textureBuffer.setDataElement(s,1,3,255*n)}e.allTransparent=C.determineAllTransparent(e.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})},t.prototype.updateAllComponentMaterials=function(e,t,r,o){return void 0===o&&(o=!0),i(this,void 0,void 0,function(){var i,s,a,d,c=this;return n(this,function(n){switch(n.label){case 0:return[4,this.getObjectEntry(e)];case 1:return i=n.sent(),s=r.slicePlaneEnabled||!1,a=C.determineRendererType(t),d=w.EdgeRenderer.getKey(a,s),i.renderables.forEach(function(e){if(d!==e.rendererKey){var r=c.renderers.get(e.rendererKey),i=c.acquireRenderer(a,s);r.removeRenderable(e),r.refCount.decrement(),e.rendererKey=d,i.addRenderable(e)}for(var n=0;n<t.length;n++)e.components.meta[n].material=t[n];o&&c.updateComponentBuffer(e.components),e.allTransparent=C.determineAllTransparent(e.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})},t.prototype.updateObjectVisibility=function(e,t){return i(this,void 0,void 0,function(){var r;return n(this,function(i){switch(i.label){case 0:return[4,this.getObjectEntry(e)];case 1:return r=i.sent(),r.renderables.forEach(function(e){e.visible=t}),this.callbacks.setNeedsRender(),[2]}})})},t.prototype.removeObject=function(e){var t=this,r=this.perObjectData.get(e);r&&(this.perObjectData.delete(e),r.loaded.then(function(){r.renderables.forEach(function(e){t.removeRenderable(e)}),t.callbacks.setNeedsRender()}))},t.prototype.getObjectEntry=function(e){return i(this,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:if(!(t=this.perObjectData.get(e)))throw"no object";return[4,t.loaded];case 1:return r.sent(),[2,t]}})})},t.prototype.removeAll=function(){var e=this;this.perObjectData.forEach(function(t,r){e.removeObject(r)})},t.prototype.createSolidEdgeMaterial=function(e){return r({},P,e,{type:"solid"})},t.prototype.createSketchEdgeMaterial=function(e){return r({},S,e,{type:"sketch"})},t.prototype.render=function(e){var t=this;this.localOrigins.updateViewMatrices(e.view),this.renderers.forEach(function(e){0===e.refCount.value&&(t.renderers.delete(e.key),e.dispose())}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();var r=e.view,i=0,n=0;this.renderers.forEach(function(e){e.forEachRenderable(function(e){i+=e.statistics.averageEdgeLength,n++})});var o=i/n,s={distanceFalloffFactor:40*o,minimumEdgeLength:C.estimateLengthAtDistance(e.viewport[3],e.fovY,1,3.5*e.pixelRatio)};this.rctx.setPipelineState(this.pipelineState),this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach(function(r){t.renderRegularEdges(r,e,s),t.renderSilhouetteEdges(r,e,s)}),e.view=r},t.prototype.computeModelTransformWithLocalOrigin=function(e,t,r){if(e.getCombinedStaticTransformation(t,r),t.origin)this.localOrigins.register(t.origin);else{var i=u.vec3.set(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.aquire(i)}return b.applyToModelMatrix(t.origin.vec3,r),r},t.prototype.updateComponentBuffer=function(e){for(var t=e.meta,r=e.buffer,i=0;i<t.length;i++){var n=t[i].material,o=t[i].index,s=g.clamp(Math.round(n.size*w.LINE_WIDTH_FRACTION_FACTOR),0,255),a=g.clamp(n.extensionLength,-w.EXTENSION_LENGTH_OFFSET,255-w.EXTENSION_LENGTH_OFFSET)+w.EXTENSION_LENGTH_OFFSET,d="solid"===n.type?0:1,c=255*n.opacity,l=n.color,u=255*l[0],f=255*l[1],p=255*l[2],h=255*l[3];r.textureBuffer.setData(o,0,u,f,p,h),r.textureBuffer.setData(o,1,s,a,d,c)}},t.prototype.createComponentBuffers=function(e){for(var t=[],r=this.componentColorManager.getBuffer(e.length),i=0;i<e.length;i++){var n=e[i],o=r.aquireIndex();t.push({index:o,material:n})}var s={meta:t,buffer:r};return this.updateComponentBuffer(s),s},t.prototype.extractEdges=function(e,t,r,i,n){return this.worker.process({data:t,originalIndices:n,writerSettings:e,skipDeduplicate:r},i?null:this.workerThread)},t.prototype.createEdgeResources=function(e){var t={};if(e.regular.lodInfo.lengths.length>0){var r=new k(this.rctx,O.EdgeShaderAttributeLocations,{vertices:O.glVertexLayout,instances:R.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:I.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){var r=new k(this.rctx,O.EdgeShaderAttributeLocations,{vertices:O.glVertexLayout,instances:R.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:I.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo}}return t},t.prototype.disposeEdgeResources=function(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)},t.prototype.addGeometryNonPreinterleaved=function(e,t,r,o,s,a,d,c){return i(this,void 0,void 0,function(){var r,i,u,f;return n(this,function(n){return r=o.getAttribute("position"),i=this.computeModelTransformWithLocalOrigin(e,s,l.mat4f64.create()),u=s.origin,f={position:r,indices:o.getIndices("position"),modelTransform:i,origin:u},[2,this.addNonPreinterleaved(e,t,f,a,d,c)]})})},t.prototype.addNonPreinterleaved=function(e,t,r,o,s,a){return void 0===a&&(a=!1),i(this,void 0,void 0,function(){var e,i,d,c,l,u,f,p,g,h,m,v,b,y,E;return n(this,function(n){switch(n.label){case 0:for(e=this.acquireRenderer(o.type,s.slicePlaneEnabled||!1),i=r.modelTransform,d=r.origin,c=r.indices,l=r.position,u=l.data.length/l.strideIdx,f=O.EdgeInputBufferLayout.createBuffer(u),p=0;p<u;p++)f.position.set(p,0,l.data[l.offsetIdx+p*l.strideIdx+0]),f.position.set(p,1,l.data[l.offsetIdx+p*l.strideIdx+1]),f.position.set(p,2,l.data[l.offsetIdx+p*l.strideIdx+2]);return g=this.createComponentBuffers([o]),C.fillComponenBufferIndices(g.meta,[0,f.componentIndex.count],f.componentIndex),[4,this.extractEdges(e.writerSettings,f,!1,a,c)];case 1:return h=n.sent(),m=this.createEdgeResources(h),v=m.regular,b=m.silhouette,y=(v?v.vao.size:0)+(b?b.vao.size:0),E={regular:v,silhouette:b,transform:{modelMatrix:i,origin:d},statistics:{gpuMemoryUsage:y,averageEdgeLength:h.averageEdgeLength},components:g,visible:!0,allTransparent:C.determineAllTransparent(g.meta),distanceToCamera:0,rendererKey:e.key},t.renderables.push(E),e.addRenderable(E),this.gpuMemoryUsage+=y,[2]}})})},t.prototype.addGeometryPreinterleaved=function(e,t,r,o,s,a,c,u){return i(this,void 0,void 0,function(){var r,i,f,p,g,v,b,y,E,x,R,T,w,M,I,B;return n(this,function(n){switch(n.label){case 0:return(r=o.getAttribute("position"))&&d.isFloat32Array(r.data)?(i=C.determineRendererType(a),f=this.acquireRenderer(i,c.slicePlaneEnabled||!1),p=this.computeModelTransformWithLocalOrigin(e,s,l.mat4f64.create()),g=s.origin,v=o.getIndices("position"),b=new h.BufferViewVec3f(r.data.buffer,4*r.offsetIdx,4*r.strideIdx),y=O.EdgeInputBufferLayout.createBuffer(b.count),m.vec3.copy(y.position,b),E=this.createComponentBuffers(a),C.fillComponenBufferIndices(E.meta,o.componentOffsets,y.componentIndex,v),x=o.hasPositionData,[4,this.extractEdges(f.writerSettings,y,x,u,v)]):(console.warn("Geometry has no float32 `position` attribute, skipping it."),[2]);case 1:return R=n.sent(),T=this.createEdgeResources(R),w=T.regular,M=T.silhouette,I=(w?w.vao.size:0)+(M?M.vao.size:0),B={regular:w,silhouette:M,transform:{modelMatrix:p,origin:g},statistics:{gpuMemoryUsage:I,averageEdgeLength:R.averageEdgeLength},components:E,visible:!e.isHidden(s),allTransparent:C.determineAllTransparent(E.meta),distanceToCamera:0,rendererKey:f.key},t.renderables.push(B),f.addRenderable(B),this.gpuMemoryUsage+=I,[2]}})})},t.prototype.canMergeGeometries=function(e){for(var t=null,r=null,i=0;i<e.geometries.length;i++){var n=e.geometries[i],s=e.geometryRecords[i];if(s.material.supportsEdges){if(n.data instanceof E)return!1;if(t){if(!o.equals(t,s.transformation))return!1}else t=s.transformation;if(!r&&s.origin)r=s;else if(r&&s.origin&&r.origin.id!==s.origin.id)return!1}}return!0},t.prototype.addObjectMergedGeometries=function(e,t,r,o){return i(this,void 0,void 0,function(){var i,s,a,c,u,f,p,g,h,m,v,b,u,f,y,g,E,h,x,O,R,T,w,M,u,C;return n(this,function(n){switch(n.label){case 0:for(i=new Map,s=0,a=null,c=null,u=0;u<e.geometries.length;u++)f=e.geometries[u],p=e.geometryRecords[u],g=p.material,g.supportsEdges&&(!c&&p.origin&&(c=p),h=f.data.getIndices("position"),s+=h?h.length:0,(h&&null==a||a===Uint16Array)&&(a=d.isUint16Array(h)?Uint16Array:Uint32Array));for(m=s?new a(s):null,v=[],b=0,u=0;u<e.geometries.length;u++)if(f=e.geometries[u],y=e.geometryRecords[u],g=y.material,g.supportsEdges){if(E=f.data.getAttribute("position"),h=f.data.getIndices("position"),null==(x=i.get(E.data))){for(x=v.length/3,O=E.offsetIdx;O<E.data.length;O+=E.strideIdx)v.push(E.data[O+0]),v.push(E.data[O+1]),v.push(E.data[O+2]);i.set(E.data,x)}if(h)for(R=0;R<h.length;R++)m[b++]=x+h[R]}for(T=c||e.geometryRecords[0],w=this.computeModelTransformWithLocalOrigin(e,T,l.mat4f64.create()),M=T.origin,u=0;u<e.geometryRecords.length;u++)e.geometryRecords[u].origin=M;return C={position:{data:v,offsetIdx:0,strideIdx:3},indices:m,modelTransform:w,origin:M},[4,this.addNonPreinterleaved(e,t,C,r[0],o)];case 1:return n.sent(),[2]}})})},t.prototype.acquireRenderer=function(e,t){var r=w.EdgeRenderer.getKey(e,t),i=this.renderers.get(r);return this.strokesTexture||(this.strokesTexture=M.generateStrokesTexture(this.rctx)),i||(i=new w.EdgeRenderer(this.rctx,this.programRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture}),this.renderers.set(r,i)),i.refCount.increment(),i},t.prototype.removeRenderable=function(e){var t=this.renderers.get(e.rendererKey);t.removeRenderable(e),t.refCount.decrement(),this.disposeEdgeResources(e),this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(var r=0,i=e.components.meta;r<i.length;r++){var n=i[r];e.components.buffer.releaseIndex(n.index)}},t.prototype.updateObjectCameraDistances=function(e){var t=this,r=e.viewInvTransp;u.vec3.set(this.tmpCameraPosition,r[3],r[7],r[11]),this.perObjectData.forEach(function(e,r){var i=u.vec3.distance(r.getCenter(),t.tmpCameraPosition);e.renderables.forEach(function(e){return e.distanceToCamera=i})})},t.prototype.renderRegularEdges=function(e,t,r){var i=this;e.bindRegularEdges(t,r),e.forEachRenderable(function(n){if(n.visible&&n.regular&&!n.allTransparent){var o=C.computeEdgeCount(n.regular.lod.lengths,n.distanceToCamera,r);t.view=i.localOrigins.getViewMatrix(n.transform.origin),e.renderRegularEdges(n,t,o),i.numberOfRenderedEdges+=o}})},t.prototype.renderSilhouetteEdges=function(e,t,r){var i=this;e.bindSilhouetteEdges(t,r),e.forEachRenderable(function(n){if(n.visible&&n.silhouette&&!n.allTransparent){var o=C.computeEdgeCount(n.silhouette.lod.lengths,n.distanceToCamera,r);t.view=i.localOrigins.getViewMatrix(n.transform.origin),e.renderSilhouetteEdges(n,t,o),i.numberOfRenderedEdges+=o}})},t}();t.EdgeView=L;var P={color:p.vec4f64.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1},S={color:p.vec4f64.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1}});