// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f64","../../../support/mathUtils","../../materials/internal/MaterialUtil","../../shaders/EdgeRendererPrograms"],function(t,e,r,i,o,s,n,a,p){Object.defineProperty(e,"__esModule",{value:!0}),e.LINE_WIDTH_FRACTION_FACTOR=8,e.EXTENSION_LENGTH_OFFSET=128;var u={type:"uber",slicePlaneEnabled:!1,strokesTexture:null},l=function(){function t(){this._value=0}return Object.defineProperty(t.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),t.prototype.increment=function(){this._value++},t.prototype.decrement=function(){this._value--},t}(),f=function(){function t(e,i,o){this.rctx=e,this.programRepository=i,this.refCount=new l,this.renderables=new Set,this.depthBiasZ=-4e-4,this.depthBiasXY=.5,this.tmpViewToWorldNormalMatrix=s.mat3f64.create(),this.settings=r({},u,o),this.key=t.getKey(this.settings.type,this.settings.slicePlaneEnabled);var n=this.settings.strokesTexture.variants;this.writerSettings={variants:n},this.createPrograms()}return t.prototype.dispose=function(){for(var t in this.programs){var e=this.programs[t];e&&(this.programRepository.decreaseRefCount(e),this.programs[t]=null)}},t.prototype.addRenderable=function(t){this.renderables.add(t)},t.prototype.removeRenderable=function(t){this.renderables.delete(t)},t.prototype.forEachRenderable=function(t){this.renderables.forEach(t)},t.prototype.bindRegularEdges=function(t,e){this.bind(this.programs.regular,t,e)},t.prototype.bindSilhouetteEdges=function(t,e){this.bind(this.programs.silhouette,t,e)},t.prototype.bind=function(t,e,r){this.rctx.bindProgram(t),t.setUniformMatrix4fv("uProj",e.proj),t.setUniform2f("uDepthBias",this.depthBiasXY,this.depthBiasZ),t.setUniform2f("uPixelToNDC",2/e.viewport[2],2/e.viewport[3]),t.setUniform2f("uNDCToPixel",e.viewport[2]/2,e.viewport[3]/2),t.setUniform1f("uDistanceFalloffFactor",r.distanceFalloffFactor),t.setUniform2f("uViewportDimInv",1/e.viewport[2],1/e.viewport[3]),t.setUniform1f("uPixelRatio",e.pixelRatio||1)},t.prototype.renderRegularEdges=function(t,e,r){this.render(this.programs.regular,t,t.regular.vao,e,r)},t.prototype.renderSilhouetteEdges=function(t,e,r){this.render(this.programs.silhouette,t,t.silhouette.vao,e,r)},t.prototype.render=function(t,e,r,i,o){this.setUniforms(t,e,i);var s=this.rctx;s.bindVAO(r),s.capabilities.instancing.drawArraysInstanced(6,0,4,o)},t.prototype.setUniforms=function(t,r,i){r.components.buffer.textureBuffer.bind(t,e.componentDataBindParameters),t.setUniformMatrix4fv("uView",i.view),t.setUniformMatrix4fv("uModel",r.transform.modelMatrix);var s=i.viewInvTransp,n=o.mat3.fromMat4(this.tmpViewToWorldNormalMatrix,s);t.setUniform3f("uCameraPosition",s[3],s[7],s[11]),t.setUniformMatrix3fv("uViewToWorldNormalMatrix",n),"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(t),t.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.fovY/2)/(i.viewport[3]/2)),t.setUniform3fv("uLocalOrigin",r.transform.origin.vec3),this.settings.slicePlaneEnabled&&a.bindSlicePlane(r.transform.origin.vec3,i.slicePlane,t)},t.prototype.setSketchUniforms=function(t){var e=this.settings.strokesTexture,r=e.texture;this.rctx.bindTexture(r,0),t.setUniform1i("uStrokesTexture",0),t.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),t.setUniform1f("uStrokesLog2Resolution",n.log2(e.resolution)),t.setUniform1f("uStrokesNormalizationScale",e.normalizationScale),t.setUniform1f("uStrokesAmplitude",e.amplitude),t.setUniform1f("uStrokeVariants",e.variants)},t.prototype.getOptions=function(t){return r({},t,{antialiasing:!!this.rctx.capabilities.blendMinMax,mode:this.settings.type,slice:this.settings.slicePlaneEnabled})},t.prototype.createPrograms=function(){var t=this.programRepository.getProgram(p.program,this.getOptions({silhouette:!1})),e=this.programRepository.getProgram(p.program,this.getOptions({silhouette:!0}));this.programRepository.increaseRefCount(t),this.programRepository.increaseRefCount(e),this.programs={regular:t,silhouette:e}},t.getKey=function(t,e){return"edges-t:"+t+":"+e},t}();e.EdgeRenderer=f,e.componentDataBindParameters={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2}});