// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","dojo/dom","../Camera","../geometry","../Graphic","../Ground","../Viewpoint","../core/asyncUtils","../core/Collection","../core/Error","../core/Handles","../core/has","../core/Logger","../core/maybe","../core/promiseUtils","../core/scheduling","../core/watchUtils","./../core/screenUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../core/libs/gl-matrix-2/vec3f64","../geometry/HeightModelInfo","../geometry/support/aaBoundingRect","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","./BreakpointsOwner","./DOMContainer","./GroundView","./PopupView","./View","./ViewAnimation","./3d/constraints/Constraints","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/input/SceneInputManager","./3d/layers/graphics/Deconflictor","./3d/layers/graphics/Labeler","./3d/layers/support/FeatureTileTree3D","./3d/layers/support/FeatureTileTree3DDebugger","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/helpers/SceneIntersectionHelper","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/geometryUtils","./3d/support/HighlightOptions","./3d/support/index","./3d/support/MapCoordsHelper","./3d/support/projectionUtils","./3d/support/PropertiesPool","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/SharedSymbolResources","./3d/support/geometryUtils/boundedPlane","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Intersector","./3d/webgl-engine/lib/intersectorUtils","./support/screenshotUtils","./support/WebGLRequirements","./ui/3d/DefaultUI3D","../webscene/Environment"],function(e,t,i,r,n,a,s,o,l,p,c,u,d,h,g,y,f,m,v,_,w,b,S,R,T,O,x,M,P,E,I,V,C,H,D,A,U,G,L,F,j,N,q,z,k,W,B,Q,K,Z,J,X,Y,$,ee,te,ie,re,ne,ae,se,oe,le,pe,ce,ue,de,he,ge,ye,fe){function me(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function ve(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}var _e=v.getLogger("esri.views.SceneView"),we=function(t){function s(e){var i=t.call(this)||this;i._clippingArea=null,i._internallyReady=!1,i._userClippingArea=null,i._initialDefaultSpatialReference=null,i._defaults={},i._externallySet={environment:!1},i._handles=new f,i._createGraphicsViewPromise=null,i._updateDrawingOrderHandle=null,i._stageFrameTask=null,i.onViewExtentUpdateHandle=null,i._resolveWhenReady=[],i.propertiesPool=new ie.default({slicePlane:se.BoundedPlaneClass},i),i._resourceController=$.newResourceController(i),i._defaultToMapOptions={include:new Set},i._defaultHitTestOptions={exclude:new Set},i.deconflictor=new N.Deconflictor(i),i.labeler=new q.Labeler({view:i}),i.renderSpatialReference=null,i.sharedSymbolResources=null,i.basemapTerrain=null,i.elevationProvider=null,i.camera=null,i.canvas=null,i.center=null,i.constraints=new G.default,i.extent=null,i.fullOpacity=1,i.graphicsView=null,i.groundView=null,i.map=null,i.screenSizePerspectiveEnabled=!0,i.state=null,i.scale=null,i.spatialReference=null,i.isHeightModelInfoRequired=!0,i.alphaCompositingEnabled=!1,i.type="3d",i.ui=new ye,i.updating=!1,i.updatingPercentage=0,i.viewpoint=null,i.zoom=null,i.highlightOptions=new Y,e&&e.environment||(i._defaults.environment=new L,i.environment=i._defaults.environment);var r=function(){return i.notifyChange("dataExtent")};i._handles.add([S.when(i,"ready",function(e,t){return i._viewReadyHandler(t)}),S.on(i,"allLayers","change",r,r,r,!0),i.allLayerViews.on("change",function(e){return i._updateUpdatingMonitors(e)}),i.watch("map",function(e){e&&e.load&&e.load()})]),i.inputManager=new j({view:i});var n=function(){return i.notifyChange("pixelRatio")};return i.stateManager=new B.ViewStateManager({view:i,updateDevicePixelRatio:n}),i}return i(s,t),s.prototype.initialize=function(){var e=this;this.groundView=new H({view:this}),this.environmentManager=new F.default({view:this}),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[]}),this._handles.add([this.resourceController.memoryController.events.on("updating-changed",function(){return e._evaluateUpdating()}),S.whenNot(this,"ready",function(t,i){return e._viewUnreadyHandler(i)}),S.init(this.qualitySettings,"memoryLimit",function(t){e.resourceController&&(e.resourceController.memoryController.maxMemory=t)}),S.init(this.qualitySettings,"additionalCacheMemory",function(t){e.resourceController&&(e.resourceController.memoryController.additionalCacheMemory=t)}),S.init(this.qualitySettings,"frameRate",function(e){return b.setFrameDuration(e>0?1e3/Math.ceil(e):0)}),S.init(Z,"SCENEVIEW_LOCKING_LOG",function(t){return e.defaultsFromMap.logDebugInformation=t}),S.on(this,"map.allLayers","after-changes",function(){return e._updateDefaultToMapOptions()},function(){return e._updateDefaultToMapOptions()},function(){return e._updateDefaultToMapOptions()}),S.init(this,"map.ground",function(){return e._updateDefaultToMapOptions()},!0),S.init(this,"map.ground.opacity",function(){return e._updateDefaultHitTestOptions()},!0)])},s.prototype.destroy=function(){this.activeTool=null,this.layerViewManager.clear(),this.stateManager.deinit(),this.groundView.destroy(),this.groundView=null,this.destroyViewData(),this._disposeSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._handles.remove("stage")),this._set("canvas",null),this.labeler.destroy(),this.labeler=null,this.deconflictor.destroy(),this.deconflictor=null,this._resourceController.destroy(),this._resourceController=null,this.environmentManager.destroy(),this._set("environmentManager",null),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this._handles.destroy(),this.propertiesPool.destroy(),this.propertiesPool=null},Object.defineProperty(s.prototype,"clippingArea",{get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof p.Extent?I.canProject(t.spatialReference,this.spatialReference)?(t=I.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(_e.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(_e.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this.ready&&"global"===this.viewingMode&&e?_e.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"dataExtent",{get:function(){var e=[],t=this.spatialReference||p.SpatialReference.WGS84,i=this.clippingArea;i&&(i=I.project(i,t));var r=function(r){if(r){var n=I.project(r,t);n&&(i&&(n=n.intersection(i)),n&&e.push(n))}},n=this._get("basemapTerrain");if(n&&n.spatialReference&&r(new p.Extent({xmin:n.extent[0],ymin:n.extent[1],zmin:0,xmax:n.extent[2],ymax:n.extent[3],zmax:0,spatialReference:n.spatialReference})),this.map&&this.map.allLayers.forEach(function(e){r(e.fullExtent)}),e.length>0){var a=e.reduce(function(e,t){return e.union(t)});return a.hasZ?(a.zmin=Math.min(0,a.zmin),a.zmax=Math.max(0,a.zmax)):(a.zmin=0,a.zmax=0),a}return new p.Extent({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t})},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"environment",{set:function(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)},enumerable:!0,configurable:!0}),s.prototype.castEnvironment=function(e){return e?e instanceof L?e:e instanceof fe?L.fromWebsceneEnvironment(e):O.ensureType(L,e):new L},Object.defineProperty(s.prototype,"pixelRatio",{get:function(){return Math.min(window.devicePixelRatio,this.maximumPixelRatio)},set:function(e){_.isSome(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"maximumPixelRatio",{get:function(){var e=1/0,t=this.qualitySettings,i=t.maximumPixelRatio,r=t.maximumRenderResolution;if(null!=i&&(e=Math.min(e,i)),null!=r){var n=Math.max(this.width,this.height),a=r/n;e=Math.min(e,a)}return e},set:function(e){_.isSome(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"groundExtent",{get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new p.Extent({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var i=this.spatialReference||p.SpatialReference.WGS84;return new p.Extent({spatialReference:i})},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"initialExtentRequired",{get:function(){return this.stateManager&&!this.stateManager.hasInitialView},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"interacting",{get:function(){return!!this.state&&this.state.interacting},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"qualityProfile",{get:function(){return this._get("qualityProfile")||J.getDefaultProfile()},set:function(e){J.isValidProfile(e)&&(J.apply(e,this.qualitySettings),this._set("qualityProfile",e))},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"slicePlane",{set:function(e){if(this._stage.setRenderParams({slicePlane:e}),!e)return void this._set("slicePlane",null);var t=this.propertiesPool.get("slicePlane");X.boundedPlane.copy(e,t),this._set("slicePlane",t)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"resolution",{get:function(){return null!=this.spatialReference?E.getResolutionForScale(this.scale,this.spatialReference):0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"heightModelInfo",{get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?M.deriveUnitFromSR(e,this.spatialReference):null},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"supersampleScreenhotsEnabled",{get:function(){return this._get("supersampleScreenhotsEnabled")},set:function(e){this._set("supersampleScreenhotsEnabled",e),this._stage&&this._stage.setViewParams({supersampleScreenshots:e})},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"viewingMode",{get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){if(this._internallyReady)_e.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"resourceController",{get:function(){return this._resourceController},enumerable:!0,configurable:!0}),s.prototype.on=function(e,t,i){var r=this.inputManager.viewEvents.register(e,t,i);return r||this.inherited(arguments)},s.prototype.hasEventListener=function(e){return this.inherited(arguments)||this.inputManager&&this.inputManager.viewEvents.hasHandler(e)},s.prototype.toMap=function(e,t){if(!this.ready)return _e.error("#toMap()","Scene view cannot be used before it is ready"),null;var i=t?this._externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=_.isSome(i.graphics)&&(_.isSome(i.graphics.include)||_.isSome(i.graphics.exclude));i.allEnabled=r;var n=R.isSupportedScreenPointEvent(e)?R.createScreenPointFromSupportedEvent(this,e):e,a=R.screenPointObjectToArray(n),s=i.include&&!i.include.has(de.TERRAIN_ID)||i.exclude&&i.exclude.has(de.TERRAIN_ID),o=this.sceneIntersectionHelper,l=o.intersectIntersectorScreen(a,null,i,!0,s).results;if(r){for(var p=0,c=l.all;p<c.length;p++){var u=c[p],d=u.toGraphic(this);if(_.isNone(d))return this._intersectResultToMapPoint(u);if(this._testGraphicUidFilter(i.graphics,d))return this._intersectResultToMapPoint(u)}return null}return this._intersectResultToMapPoint(l.min)},s.prototype.toScreen=function(e){if(!this.ready)return _e.error("#toScreen()","Scene view cannot be used before it is ready"),null;var t=null==e.z&&this.basemapTerrain.getElevation(e)||0;return te.pointToVector(e,be,this.renderSpatialReference,t),this.engineToScreen(be)},s.prototype.pixelSizeAt=function(e,t){if(!this.ready)return _e.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("number"==typeof e){var i=this.sceneIntersectionHelper.intersectIntersectorScreen(R.createScreenPointArray(e,t)).results.min;if(!i.getIntersectionPoint(be))return 0}else if(e instanceof p.Point)te.pointToVector(e,be,this.renderSpatialReference);else{var i=this.sceneIntersectionHelper.intersectIntersectorScreen(R.createScreenPointArray(e.x,e.y)).results.min;if(!i.getIntersectionPoint(be))return 0}return this.state.camera.computeScreenPixelSizeAt(be)},s.prototype.hitTest=function(e,t){if(!this.ready)return _e.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i=R.isSupportedScreenPointEvent(e)?R.createScreenPointFromSupportedEvent(this,e):e,r=R.createScreenPointArray(i.x,i.y),n=t?this._externalToInternalIntersectOptions(t):this._defaultHitTestOptions;n.allEnabled=!0,n.terrainLocationFeedbackEnabled=!0;var a=this.sceneIntersectionHelper.intersectIntersectorScreen(r,null,n,!0,!0),s=a.results.all,o=this._intersectResultsToHits(s,n.graphics),l=a.results.terrain,p={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(l),distance:l.hasIntersectionPoint?l.distanceInRenderSpace:0}};return Z.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(p.intersector=a),w.resolve(p)},s.prototype.popupHitTest=function(e){return this.hitTest(e).then(function(t){for(var i=[],r=t.results.length?t.results[0].distance:0,n=0,a=t.results;n<a.length;n++){var s=a[n];if(s.distance!==r)break;i.push(s)}var o=null;return(0===i.length||Math.abs(r-t.ground.distance)<1e-5)&&(o=t.ground.mapPoint),{results:i,screenPoint:e,mapPoint:o}})},s.prototype.goTo=function(e,t){return this.stateManager.goTo(e,t)},s.prototype.takeScreenshot=function(e){var t=this;return this.whenReady().then(function(){var i=he.toRenderSettings(e,t);return i.pixelRatio/=t.pixelRatio,t._stage.takeScreenshot(i)})},s.prototype.forceDOMReadyCycle=function(){this.forceReadyCycle()},s.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},s.prototype.validate=function(){var e=ge.check();return m("safari")&&m("safari")<9&&(e=new y("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:m("safari")})),e?(_e.warn("#validate()",e.message),w.reject(e)):w.resolve()},s.prototype.isSpatialReferenceSupported=function(e,t,i){var r=e.isGeographic,n=e.isWebMercator,a=e.isWGS84,s="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(s&&r)return i&&i("Layer "+t.id+" is ignored because it is GCS and viewing mode is local"),!1;if(!s&&!n&&!a)return i&&i("Layer "+t.id+" is ignored because its spatial reference is not supported in global viewing mode"),!1}else if(r&&!a)return i&&i("Layer "+t.id+" is ignored because its spatial reference is geographic but not WGS84"),!1;if(t)if(pe.isTiledLayer(t)){var l=void 0;if(o){var p=pe.getTiledLayerInfo(t,e,this.viewingMode);l=null!=p.tileInfo}else{var p=pe.getTiledLayerInfo(t,e,"global");null==p.tileInfo&&(p=pe.getTiledLayerInfo(t,e,"local")),l=null!=p.tileInfo}if(!l)return i&&i("Layer "+t.id+" is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode"),!1}else if((a||n)&&!s)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this._internallyReady||(this.viewingMode="global",i&&i("Viewing mode locked to global due to reprojectable layer "+t.id)),i&&i("Layer "+t.id+" is ignored because it supports server-side reprojection"),!1;return!0},s.prototype.whenReady=function(){var e=this;return w.create(function(t){e._internallyReady?t(e):e._resolveWhenReady.push(t)})},s.prototype.computeMapPointFromVec3d=function(e,t){var i=this.spatialReference||p.SpatialReference.WGS84;return te.vectorToVector(e,this.renderSpatialReference,e,i)||(i=p.SpatialReference.WGS84,te.vectorToVector(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new p.Point(e,i),t},s.prototype.engineToScreen=function(e,t){var i=R.createRenderScreenPointArray3();this.state.camera.projectPoint(e,i);var r=R.screenPointArrayToObject(i);return R.renderToScreen(this,r,t)},s.prototype.flushDisplayModifications=function(){this._stage.processDirty()},s.prototype.getDrawingOrder=function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},s.prototype.getViewForGraphic=function(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):null},s.prototype.graphicChanged=function(e){_.isSome(this.graphicsView)&&this.graphicsView.graphicChanged(e)},s.prototype.whenViewForGraphic=function(e){var t=this;return e.layer===this?S.whenOnce(this,"graphicsView").then(function(){return t.graphicsView}):e.layer?this.whenLayerView(e.layer):w.reject()},s.prototype._intersectResultToMapPoint=function(e,t){if(e.getIntersectionPoint(be)){t=this.computeMapPointFromVec3d(be,t);var i=this.basemapTerrain;return"TerrainRenderer"===e.intersector&&i&&(t.z=i.getElevation(t)||0),t}return null},s.prototype._intersectResultsToHits=function(e,t){for(var i=[],r=null,n=0;n<e.length;n++){var a=e[n],s=a.toOwner(this);if(_.isSome(s)&&(s===this.map.ground||"type"in s&&"integrated-mesh"===s.type))break;var o=a.toGraphic(this);if(_.isSome(o)){if(_.isNone(r)&&n!==e.length-1&&(r=new Set),_.isSome(r)){var l=this._getGraphicFilterUid(o);if(r.has(l))continue;r.add(l)}if(this._testGraphicUidFilter(t,o)){var p=this._intersectResultToMapPoint(a),c=a.distanceInRenderSpace;i.push({graphic:o,mapPoint:p,distance:c})}}}return i},s.prototype._getGraphicFilterUid=function(e){if(e.layer&&"objectIdField"in e.layer){var t=e.attributes[e.layer.objectIdField];if(t)return"o-"+e.layer.id+"-"+t}return"u-"+e.uid},s.prototype._testGraphicUidFilter=function(e,t){var i=this._getGraphicFilterUid(t);return _.isNone(e)||(_.isNone(e.include)||e.include.has(i))&&(_.isNone(e.exclude)||!e.exclude.has(i))},s.prototype._externalToInternalRenderItems=function(e,t,i){var r=this;return void 0===i&&(i={layerUids:null,graphicUids:null}),e?(e instanceof c?(ve(i,this._getGraphicFilterUid(e)),0===t&&(_.isSome(this.graphicsView)&&e.layer===this.graphicsView?me(i,this.graphicsView.mockLayerId):e.layer&&me(i,e.layer.uid))):"forEach"in e?e.forEach(function(e){Array.isArray(e)?r._externalToInternalRenderItems(e,t,i):g.isCollection(e)?e===r.graphics&&_.isSome(r.graphicsView)?me(i,r.graphicsView.mockLayerId):r._externalToInternalRenderItems(e,t,i):e instanceof u?e===r.map.ground&&me(i,de.TERRAIN_ID):r._externalToInternalRenderItems(e,t,i)}):me(i,e.uid),i):i},s.prototype._externalToInternalIntersectOptions=function(e){var t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}},s.prototype._viewingModeToManifold=function(e){switch(e){case"global":return"spherical";case"local":return"planar"}},s.prototype._initBasemapTerrain=function(e){var t=this;this._disposeBasemapTerrain(),this._set("basemapTerrain",new le(this,this._viewingModeToManifold(e))),this._set("elevationProvider",new K({view:this})),this.elevationProvider.register("ground",this.basemapTerrain),this._handles.add([S.init(this,"map.ground.opacity",function(e){return t.basemapTerrain.baseOpacity=null==e?1:e},!0),S.init(this,"map.ground.surfaceColor",function(e){t.basemapTerrain.backgroundColor=e})],"basemapTerrain")},s.prototype._initGlobe=function(e){var t=this;this._initCoordinateSystem(),this._initState(),this._stage.setViewParams({backgroundColor:[0,0,0,0]}),this._initBasemapTerrain(e),this._set("pointsOfInterest",new oe.default({view:this})),this._set("featureTiles",new z.default({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler})),this._handles.add(this.featureTiles.watch("updating",function(){return t._evaluateUpdating()})),this._handles.add(S.init(Z,"FEATURE_TILE_TREE_SHOW_TILES",function(e){e&&t.featureTiles&&!t.featureTilesDebugger?t.featureTilesDebugger=new k.FeatureTileTree3DDebugger(t):!e&&t.featureTilesDebugger&&(t.featureTilesDebugger.destroy(),t.featureTilesDebugger=null)}),"feature-tiles"),this._handles.add(S.init(this,["clippingArea","basemapTerrain.extent"],function(){var e=t.basemapTerrain&&t.basemapTerrain.extent;if(t.clippingArea||e)if(e&&t.basemapTerrain.spatialReference){var i=P.toExtent(t.basemapTerrain.extent,t.basemapTerrain.spatialReference);t.clippingArea?t.featureTiles.filterExtent=i.intersection(t.clippingArea):t.featureTiles.filterExtent=i}else t.featureTiles.filterExtent=t.clippingArea;else t.featureTiles.filterExtent=null},!0),"feature-tiles"),this.stateManager.init()},s.prototype._initCoordinateSystem=function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new ee.default(this.map,t));var i="global"===this.viewingMode,r=i?te.SphericalECEFSpatialReference:t;r!==this.renderSpatialReference&&(this.renderSpatialReference=r,this._set("renderCoordsHelper",ne.RenderCoordsHelper.createMode(this.viewingMode,r)),i||this._handles.add(this.watch("basemapTerrain.extent",function(t){0===t[0]&&0===t[1]&&0===t[2]&&0===t[3]||(e.renderCoordsHelper.extent=t)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(ue.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null),this.renderSpatialReference=null},s.prototype._evaluateUpdating=function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(r){if(r.updating){i=!0;var n="updatingPercentage"in r?r.updatingPercentage:null;null!=n&&(++t,e+=n)}}),i=!!(i||this._createGraphicsViewPromise||_.isSome(this.graphicsView)&&this.graphicsView.updating||this._resourceController&&this._resourceController.updating||this.featureTiles&&this.featureTiles.updating||this.labeler&&this.labeler.updating),i!==this.updating&&this._set("updating",i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&this._set("updatingPercentage",e)},s.prototype._updateUpdatingMonitors=function(e){for(var t=this,i=0,r=e.removed;i<r.length;i++){var n=r[i];this._handles.remove(n.uid)}for(var a=0,s=e.added;a<s.length;a++){var n=s[a];n.destroyed||this._handles.add([n.watch(["updating","updatingPercentage"],function(){return t._evaluateUpdating()})],n.uid)}this._evaluateUpdating()},s.prototype._disposeSurface=function(){var e=function(e){return e&&e.remove(),null};this._stageFrameTask=e(this._stageFrameTask),this._updateDrawingOrderHandle=e(this._updateDrawingOrderHandle),this.onViewExtentUpdateHandle=e(this.onViewExtentUpdateHandle),this.pointsOfInterest&&(this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null)),this.featureTiles&&(this.featureTiles.destroy(),this._set("featureTiles",null)),this._handles.remove("feature-tiles"),this._handles.remove("render-coords-helper"),this._disposeBasemapTerrain(),this.environmentManager&&this.environmentManager.disposeRendering()},s.prototype._disposeBasemapTerrain=function(){var e=this._get("basemapTerrain");e&&(this._handles.remove("basemapTerrain"),e.destroy(),this._set("basemapTerrain",null))},s.prototype._renderScreenshotOverlay=function(e,t){if(this.overlay&&this.overlay.hasVisibleItems){var i=e.getContext("2d");i.putImageData(t,0,0),this.overlay.renderCanvas(e);for(var r=i.getImageData(0,0,t.width,t.height),n=0;n<r.data.length;n++)t.data[n]=r.data[n]}},s.prototype._initStage=function(){var e=this,t={};t.renderContext=this.renderContext,t.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,t.viewingMode=this.viewingMode,t.alpha=this.alphaCompositingEnabled,t.supersampleScreenshots=this.supersampleScreenhotsEnabled,t.renderScreenshotOverlay=function(t,i){return e._renderScreenshotOverlay(t,i)},this.renderCanvas&&(t.canvas=this.renderCanvas);var i=new Q.SceneIntersectionHelper(this.viewingMode,{forEachLayer:function(t){var i=e._stage.getLayers();Object.keys(i).forEach(function(e){t(i[e])})}},this);this._set("sceneIntersectionHelper",i),this._stage=new ce(this.viewingMode,o.byId(this.surface),t,i),this._handles.add(S.init(this.qualitySettings,"antialiasingEnabled",function(){e._stage.setRenderParams({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}),"stage");var r=function(){e._stage.setRenderParams({defaultHighlightOptions:Y.toEngineOptions(e.highlightOptions)})};this._handles.add(this.watch(["highlightOptions","highlightOptions.color","highlightOptions.haloOpacity","highlightOptions.fillOpacity"],r),"stage"),r(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(ue.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.getCanvas()),this._stageFrameTask=b.addFrameTask(this._stage.getFrameTask())},s.prototype._initSurface=function(){this._initStage(),this._initGlobe(this.viewingMode),this.sharedSymbolResources=new ae.default({stage:this._stage,viewingMode:this.viewingMode,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})},s.prototype._createGraphicsViewIfNeeded=function(){this.graphicsView||this._createGraphicsViewPromise||0!==this.graphics.length&&(this._handles.remove("graphics-view"),this._createGraphicsViewPromise=h.safeCast(this._createGraphicsViewAsync()),this._createGraphicsViewPromise.isFulfilled()&&(this._createGraphicsViewPromise=null),this._evaluateUpdating())},s.prototype._createGraphicsViewAsync=function(){return a(this,void 0,void 0,function(){var t,i,r=this;return n(this,function(n){switch(n.label){case 0:return[4,w.create(function(t){return e(["./3d/layers/GraphicsView3D"],t)})];case 1:return t=n.sent(),[4,S.whenTrueOnce(this.basemapTerrain,"ready")];case 2:return n.sent(),i=new t({view:this}),this._set("graphicsView",i),this._handles.add([S.init(i,"updating",function(){return r._evaluateUpdating()})],i.mockLayerId),this._createGraphicsViewPromise=null,this._evaluateUpdating(),[2]}})})},s.prototype._disposeGraphicsView=function(){this._createGraphicsViewPromise&&(this._createGraphicsViewPromise.cancel(),this._createGraphicsViewPromise=null),this._handles.remove("graphics-view"),_.isSome(this.graphicsView)&&(this._handles.remove(this.graphicsView.mockLayerId),this.graphicsView.destroy(),this._set("graphicsView",null))},s.prototype._initState=function(){this._set("state",new W.default({viewingMode:this.viewingMode,spatialReference:this.spatialReference}))},s.prototype._viewReadyHandler=function(e){var t=this;if(!e){if("global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._handles.add(S.on(this,"graphics","change",function(){return t._createGraphicsViewIfNeeded()},function(){return t._createGraphicsViewIfNeeded()}),"graphics-view"),this._createGraphicsViewPromise&&this._handles.remove("graphics-view"),this._evaluateUpdating(),!this._externallySet.environment){var i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this._updateDrawingOrderHandle=this.allLayerViews.on("change",function(){return t._updateDrawingOrder()}),this._updateDrawingOrder(),this.labeler.setup(),this.environmentManager.updateReadyChange(!0),this.inputManager.connect();var r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach(function(e){return e(t)})}},s.prototype._viewUnreadyHandler=function(e){e&&(_.isSome(this.activeTool)&&(this.activeTool.deactivate&&this.activeTool.deactivate(),this._set("activeTool",null)),this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this.stateManager.deinit(),this._disposeSurface(),this.state.destroy(),this._set("state",null),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler&&this.labeler.dispose(),this._stage&&(this._stage.dispose(),this._stage=null),this._handles.remove("stage"),this._set("canvas",null))},s.prototype._updateDrawingOrder=function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){"drawingOrder"in t&&(t.drawingOrder=e-i)})},s.prototype._updateDefaultToMapOptions=function(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(de.TERRAIN_ID);for(var e=0,t=this.map.allLayers.items;e<t.length;e++){var i=t[e];"integrated-mesh"===i.type&&this._defaultToMapOptions.include.add(i.uid)}}},s.prototype._updateDefaultHitTestOptions=function(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(de.TERRAIN_ID);for(var e=0,t=this.map.allLayers.items;e<t.length;e++){var i=t[e];"integrated-mesh"===i.type&&i.opacity<1&&this._defaultToMapOptions.exclude.add(i.uid)}}},r([T.property({type:U,readOnly:!0,aliasOf:"state.animation"})],s.prototype,"animation",void 0),r([T.property({readOnly:!0})],s.prototype,"basemapTerrain",void 0),r([T.property({readOnly:!0})],s.prototype,"elevationProvider",void 0),r([T.property({type:l,aliasOf:"stateManager.camera"})],s.prototype,"camera",void 0),r([T.property({readOnly:!0})],s.prototype,"canvas",void 0),r([T.property({type:p.Point,aliasOf:"stateManager.center"})],s.prototype,"center",void 0),r([T.property({type:p.Extent,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],s.prototype,"clippingArea",null),r([T.property({type:G.default})],s.prototype,"constraints",void 0),r([T.property({type:p.Extent,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],s.prototype,"dataExtent",null),r([T.property({value:null,type:L})],s.prototype,"environment",null),r([T.cast("environment")],s.prototype,"castEnvironment",null),r([T.property()],s.prototype,"environmentManager",void 0),r([T.property({type:p.Extent,aliasOf:"stateManager.extent"})],s.prototype,"extent",void 0),r([T.property({readOnly:!0,aliasOf:"stateManager.screenCenter"})],s.prototype,"screenCenter",void 0),r([T.property({type:Number,dependsOn:["maximumPixelRatio"]})],s.prototype,"pixelRatio",null),r([T.property({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],s.prototype,"maximumPixelRatio",null),r([T.property({aliasOf:"stateManager.frustum"})],s.prototype,"frustum",void 0),r([T.property({type:Number,readOnly:!0})],s.prototype,"fullOpacity",void 0),r([T.property({readOnly:!0})],s.prototype,"graphicsView",void 0),r([T.property({type:p.Extent,dependsOn:["basemapTerrain.extent"],readOnly:!0})],s.prototype,"groundExtent",null),
r([T.property()],s.prototype,"groundView",void 0),r([T.property({type:Boolean,dependsOn:["stateManager.hasInitialView"]})],s.prototype,"initialExtentRequired",null),r([T.property({type:Boolean,dependsOn:["state.interacting"],readOnly:!0})],s.prototype,"interacting",null),r([T.property()],s.prototype,"map",void 0),r([T.property({readOnly:!0})],s.prototype,"mapCoordsHelper",void 0),r([T.property({aliasOf:"stateManager.padding"})],s.prototype,"padding",void 0),r([T.property({type:oe.default,readOnly:!0})],s.prototype,"pointsOfInterest",void 0),r([T.property({type:z.default,readOnly:!0})],s.prototype,"featureTiles",void 0),r([T.property({type:k.FeatureTileTree3DDebugger})],s.prototype,"featureTilesDebugger",void 0),r([T.property({type:Boolean})],s.prototype,"screenSizePerspectiveEnabled",void 0),r([T.property({constructOnly:!0})],s.prototype,"deactivatedWebGLExtensions",void 0),r([T.property({constructOnly:!0})],s.prototype,"renderCanvas",void 0),r([T.property({readOnly:!0})],s.prototype,"state",void 0),r([T.property({readOnly:!0})],s.prototype,"inputManager",void 0),r([T.property({readOnly:!0})],s.prototype,"stateManager",void 0),r([T.property({type:["low","medium","high"]})],s.prototype,"qualityProfile",null),r([T.property({type:re,get:function(){var e=this._get("qualitySettings");return e||(e=new re,J.apply(this.qualityProfile,e)),e}})],s.prototype,"qualitySettings",void 0),r([T.property()],s.prototype,"slicePlane",null),r([T.property({dependsOn:["viewingMode"]})],s.prototype,"ready",void 0),r([T.property({readOnly:!0})],s.prototype,"renderCoordsHelper",void 0),r([T.property({readOnly:!0})],s.prototype,"sceneIntersectionHelper",void 0),r([T.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],s.prototype,"resolution",null),r([T.property({type:Number,aliasOf:"stateManager.scale"})],s.prototype,"scale",void 0),r([T.property()],s.prototype,"heightModelInfo",null),r([T.property({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],s.prototype,"spatialReference",void 0),r([T.property({type:Boolean,constructOnly:!0})],s.prototype,"alphaCompositingEnabled",void 0),r([T.property({type:Boolean,value:!0})],s.prototype,"supersampleScreenhotsEnabled",null),r([T.property({readOnly:!0})],s.prototype,"type",void 0),r([T.property({type:ye})],s.prototype,"ui",void 0),r([T.property({type:Boolean,readOnly:!0})],s.prototype,"updating",void 0),r([T.property({type:Number,readOnly:!0})],s.prototype,"updatingPercentage",void 0),r([T.property({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],s.prototype,"viewingMode",null),r([T.property({type:d,aliasOf:"stateManager.viewpoint"})],s.prototype,"viewpoint",void 0),r([T.property({type:Number,aliasOf:"stateManager.zoom"})],s.prototype,"zoom",void 0),r([T.property({type:Y})],s.prototype,"highlightOptions",void 0),s=r([T.subclass("esri.views.SceneView")],s)}(T.declared(C,A,V,D)),be=x.vec3f64.create();return we});