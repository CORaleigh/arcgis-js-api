// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Accessor","../../core/Collection","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","./support/ActiveLayerInfo"],function(e,t,r,i,a,s,n,o,y,l){var d={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},c=s.ofType(l),h=["esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.HeatmapLayer","esri.layers.MapImageLayer","esri.layers.PointCloudLayer","esri.layers.TileLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.GeoRSSLayer","esri.layers.GeoJSONLayer","esri.layers.GroupLayer","esri.layers.ImageryLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer"],p=["view.basemapView.baseLayerViews","view.groundView.layerViews","view.layerViews","view.basemapView.referenceLayerViews"];return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new n,r._layerViewByLayerId={},r._layerInfosByLayerViewId={},r._activeLayerInfosByLayerViewId={},r.activeLayerInfos=new c,r.basemapLegendVisible=!1,r.groundLegendVisible=!1,r.layerInfos=[],r.view=null,r}return r(t,e),t.prototype.initialize=function(){this._handles.add(o.init(this,"view",this._viewHandles),d.view)},t.prototype.destroy=function(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null},Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype._viewHandles=function(){this._handles.remove(d.state),this.view&&this._handles.add(o.init(this,"state",this._stateHandles),d.state)},t.prototype._stateHandles=function(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()},t.prototype._resetAll=function(){this._handles.remove([d.allLayerViews,d.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()},t.prototype._destroyViewActiveLayerInfos=function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)},t.prototype._destroyViewActiveLayerInfo=function(e){this._handles.remove(e),delete this._activeLayerInfosByLayerViewId[e]},t.prototype._watchPropertiesAndAllLayerViews=function(){var e=this.view.allLayerViews;e.length&&this._refresh(),this._handles.add(e.on("change",this._allLayerViewsChangeHandle.bind(this)),d.allLayerViews),this._handles.add(o.watch(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),d.legendProperties)},t.prototype._allLayerViewsChangeHandle=function(e){var t=this;e.removed.forEach(function(e){return t._destroyViewActiveLayerInfo(e.uid)}),this._refresh()},t.prototype._propertiesChangeHandle=function(){this._destroyViewActiveLayerInfos(),this._refresh()},t.prototype._refresh=function(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)},t.prototype._sortActiveLayerInfos=function(e){var t={};this.view.allLayerViews.forEach(function(e,r){return t[e.layer.uid]=r}),e.sort(function(e,r){var i=t[e.layer.uid]||0;return(t[r.layer.uid]||0)-i})},t.prototype._generateLayerViews=function(){var e=[];return p.filter(this._filterLayerViews,this).map(this.get,this).filter(function(e){return null!=e}).forEach(this._collectLayerViews("layerViews",e)),e},t.prototype._filterLayerViews=function(e){var t=!this.basemapLegendVisible&&("view.basemapView.baseLayerViews"===e||"view.basemapView.referenceLayerViews"===e),r=!this.groundLegendVisible&&"view.groundView.layerViews"===e;return!t&&!r},t.prototype._collectLayerViews=function(e,t){var r=function(i){return i&&i.forEach(function(i){t.push(i),r(i[e])}),t};return r},t.prototype._filterLayerViewsByLayerInfos=function(e){var t=this,r=this.layerInfos;return!r||!r.length||r.some(function(r){return t._hasLayerInfo(r,e)})},t.prototype._hasLayerInfo=function(e,t){var r=this._isLayerUIDMatching(e.layer,t.layer.uid);return r&&(this._layerInfosByLayerViewId[t.uid]=e),r},t.prototype._isLayerUIDMatching=function(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))},t.prototype._hasLayerUID=function(e,t){var r=this;return e&&e.some(function(e){return r._isLayerUIDMatching(e,t)})},t.prototype._isLayerViewSupported=function(e){return h.indexOf(e.layer.declaredClass)>-1&&(this._layerViewByLayerId[e.layer.uid]=e,!0)},t.prototype._generateActiveLayerInfo=function(e){var t=this;if(this._isLayerActive(e))return void this._buildActiveLayerInfo(e);this._handles.remove(e.uid),this._handles.add(o.watch(e,"suspended, layer.legendEnabled",function(){return t._layerActiveHandle(e)}),e.uid)},t.prototype._layerActiveHandle=function(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))},t.prototype._isLayerActive=function(e){return!e.suspended&&e.get("layer.legendEnabled")},t.prototype._buildActiveLayerInfo=function(e){var t=this,r=e.layer,i=e.uid,a=this._layerInfosByLayerViewId[i],s=this._activeLayerInfosByLayerViewId[i];if(!s){var n=a&&void 0!==a.title;s=new l({layer:r,title:n?a.title:r.title,view:this.view}),this._activeLayerInfosByLayerViewId[i]=s}if(!s.parent){var y=r.parent,d=y&&this._layerViewByLayerId[y.uid];s.parent=d&&this._activeLayerInfosByLayerViewId[d.uid]}if(!this._handles.has(i)){var c=o.watch(r,"title",function(r){return t._titleHandle(r,s,e)}),h=o.watch(r,"legendEnabled",function(r){return t._legendEnabledHandle(r,s,e)}),p=o.watch(r,"renderer?, opacity",function(){return t._constructLegendElements(s,e)}),u=o.watch(e,"suspended",function(r){return t._suspendedHandle(r,s,e)}),f=o.whenTrue(this.view,"stationary",function(){return t._scaleHandle(s,e)});this._handles.add([c,h,p,u,f],i),this._constructLegendElements(s,e)}this._addActiveLayerInfo(s,e)},t.prototype._titleHandle=function(e,t,r){t.title=e,this._constructLegendElements(t,r)},t.prototype._legendEnabledHandle=function(e,t,r){e?this._addActiveLayerInfo(t,r):this._removeActiveLayerInfo(t)},t.prototype._suspendedHandle=function(e,t,r){e?this._removeActiveLayerInfo(t):this._addActiveLayerInfo(t,r)},t.prototype._scaleHandle=function(e,t){e.scale!==this.view.scale&&e.isScaleDriven&&this._constructLegendElements(e,t)},t.prototype._addActiveLayerInfo=function(e,t){if(this._isLayerActive(t)&&-1===this.activeLayerInfos.indexOf(e)){var r=e.parent;r?-1===r.children.indexOf(e)&&(r.children.push(e),this._sortActiveLayerInfos(r.children)):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}},t.prototype._removeActiveLayerInfo=function(e){var t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)},t.prototype._constructLegendElements=function(e,t){var r=t.layer;e.scale=this.view.scale,r.featureCollections?e.buildLegendElementsForFeatureCollections(r.featureCollections):r.renderer?e.buildLegendElementsForRenderer():r.url&&e.buildLegendElementsForTools()},i([y.property({type:c})],t.prototype,"activeLayerInfos",void 0),i([y.property()],t.prototype,"basemapLegendVisible",void 0),i([y.property()],t.prototype,"groundLegendVisible",void 0),i([y.property()],t.prototype,"layerInfos",void 0),i([y.property({dependsOn:["view.ready"],readOnly:!0})],t.prototype,"state",null),i([y.property()],t.prototype,"view",void 0),t=i([y.subclass("esri.widgets.Legend.LegendViewModel")],t)}(y.declared(a))});