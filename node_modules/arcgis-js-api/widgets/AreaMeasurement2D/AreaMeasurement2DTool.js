// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../Graphic","../../core/Collection","../../core/Handles","../../core/screenUtils","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../views/2d/draw/Draw","../../views/interactive/InteractiveToolBase","../../views/interactive/interactiveToolUtils"],function(e,t,r,i,o,s,n,a,c,p,l,h,d,u,v,y,m,g,f,_){return function(e){function t(t){var r=e.call(this,t)||this;return r._drawActive=!1,r._handles=new n,r._sketchLayer=new m({listMode:"hide"}),r._vertices=null,r._vertexDrag=null,r._vertexHoverIndex=-1,r}return r(t,e),t.prototype.initialize=function(){var e=this;this._draw=new g({view:this.view});var t=this.view;t.map.add(this._sketchLayer),t.focus(),this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){e._updateMeasurements()})),this.projectionEngineRequired&&this.projectionEngineSupported&&(u.isLoaded()||u.load())},t.prototype.destroy=function(){this.detach(),this._handles.removeAll(),this._sketchLayer.removeAll(),this.viewModel.view.map.remove(this._sketchLayer),this.viewModel.measurement=null,this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._sketchLayer&&(this._sketchLayer.destroy(),this._sketchLayer=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._draw.reset(),this._updateMeasurements()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var e=this.view.spatialReference;return!e.isWebMercator&&!e.isWGS84&&!y.isSupported(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineSupported",{get:function(){return u.isSupported()},enumerable:!0,configurable:!0}),t.prototype.show=function(){this._sketchLayer.visible=!0},t.prototype.hide=function(){this._sketchLayer.visible=!1},t.prototype.reset=function(){this._vertices=null,this._vertexDrag=null,this._vertexHoverIndex=-1,this._sketchLayer.removeAll(),this.viewModel.measurement=null},t.prototype.newMeasurement=function(){this.reset(),_.setActive(this,!0),this._startSketch()},t.prototype.clearMeasurement=function(){this.reset(),this._drawActive&&this._startSketch()},t.prototype.onInputEvent=function(e){var t=this,r=this.view;switch(e.type){case"pointer-move":this._updateCursor(a.createScreenPointFromEvent(e));break;case"drag":switch(e.action){case"start":r.hitTest(a.createScreenPointFromEvent(e)).then(function(r){var i=new s(r.results);if(0!==i.length){var o=i.find(function(e){return e.graphic.layer===t._sketchLayer&&"point"===e.graphic.geometry.type});if(o){var n=o.graphic.geometry,a=new s(t._vertices),c=a.findIndex(function(e){return e[0]===n.x&&e[1]===n.y});t._vertexDrag={index:c,origin:n},_.setActive(t,!0),e.stopPropagation()}}});break;case"update":if(this._vertexDrag){var i=r.toMap(a.createScreenPoint(e.origin.x,e.origin.y)),o=r.toMap(e);this._vertices[this._vertexDrag.index]=[this._vertexDrag.origin.x+o.x-i.x,this._vertexDrag.origin.y+o.y-i.y],this._updateMeasurements(),e.stopPropagation()}break;case"end":this._vertexDrag=null,_.setActive(this,!1)}}},t.prototype._startSketch=function(){var e=this;this._drawActive=!0;var t=this._draw.create("polyline",{mode:"click"});t.on("vertex-add",function(t){return e._updateSketch(t.vertices)}),t.on("vertex-update",function(t){return e._updateSketch(t.vertices)}),t.on("vertex-remove",function(t){return e._updateSketch(t.vertices)}),t.on("cursor-update",function(t){return e._updateSketch(t.vertices)}),t.on("undo",function(t){return e._updateSketch(t.vertices)}),t.on("redo",function(t){return e._updateSketch(t.vertices)}),t.on("draw-complete",function(){return e._stopSketch()})},t.prototype._stopSketch=function(){_.setActive(this,!1),this._drawActive=!1},t.prototype._updateSketch=function(e){this._vertices=e,this._updateMeasurements()},t.prototype._updateCursor=function(e){var t=this,r=this.viewModel.view;return this._vertexDrag?void(this.cursor="grabbing"):this._drawActive?void(this.cursor="crosshair"):void r.hitTest(e).then(function(e){var r=-1;if(0!==e.results.length){var i=new s(e.results),o=i.map(function(e){return e.graphic}),n=o.find(function(e){return e&&e.layer===t._sketchLayer&&"point"===e.geometry.type});if(n){var a=n.geometry;r=new s(t._vertices).findIndex(function(e){return e[0]===a.x&&e[1]===a.y})}}r!==t._vertexHoverIndex&&(t._vertexHoverIndex=r,t.cursor=-1===t._vertexHoverIndex?null:"pointer",t._updateMeasurements())})},t.prototype._updateMeasurements=function(){var e=this;if(this._vertices&&(!this.projectionEngineRequired||u.isLoaded())&&(this._sketchLayer.removeAll(),!(this._vertices.length<2))){var t=this._vertices.slice(),r=this.viewModel,i=r.palette,s=r.view.spatialReference,n=[],a=y.isSupported(s),c=!a&&!s.isWebMercator&&!s.isWGS84;if(2===t.length){var m=new d({paths:[t],spatialReference:s});if(c&&(m=u.project(m,v.WGS84)),a||c)m=y.geodesicDensify(m,1e5);else{var g=p.geodesicLength(m,"meters");("geodesic"===r.mode||"auto"===r.mode&&g>=r.geodesicDistanceThreshold)&&(m=p.geodesicDensify(m,1e5,"meters"))}n.push(new o({geometry:m,symbol:{type:"simple-line",color:i.pathColor,width:i.pathWidth}}))}else{t.push(t[0]);var m=new h({rings:[t],spatialReference:s}),f=new d({paths:[t],spatialReference:s}),_=m.clone(),w=p.simplify(m);if(c&&(w=u.project(w,v.WGS84),_=u.project(_,v.WGS84),f=u.project(f,v.WGS84)),a||c)r.measurement={geometry:w,area:y.geodesicAreas([w],"square-meters")[0],perimeter:y.geodesicLengths([w],"meters")[0]},_=y.geodesicDensify(_,1e5),f=y.geodesicDensify(f,1e5);else{var x=p.planarLength(w,"meters");"geodesic"===r.mode||"auto"===r.mode&&x>=r.geodesicDistanceThreshold?(r.measurement={geometry:w,area:p.geodesicArea(w,"square-meters"),perimeter:p.geodesicLength(w,"meters")},_=p.geodesicDensify(_,1e5,"meters"),f=p.geodesicDensify(f,1e5,"meters")):r.measurement={geometry:w,area:p.planarArea(w,"square-meters"),perimeter:x}}n.push(new o({geometry:_,symbol:{type:"simple-fill",style:"solid",color:i.fillColor,outline:{type:"simple-line",width:0}}}),new o({geometry:f,symbol:{type:"simple-line",style:"solid",color:i.pathColor,width:i.pathWidth}})),n.push(new o({geometry:_.centroid,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:r.measurementLabel.area,font:{size:14,family:"sans-serif"}}}))}this.editable&&this._vertices.forEach(function(t,r){var a=e._vertexHoverIndex===r?1.5:1;n.push(new o({geometry:new l({x:t[0],y:t[1],spatialReference:s}),symbol:{type:"simple-marker",style:"circle",color:i.handleColor,size:i.handleWidth*a,outline:{type:"simple-line",width:0}}}))}),this._sketchLayer.addMany(n)}},i([c.property({constructOnly:!0})],t.prototype,"viewModel",void 0),i([c.property()],t.prototype,"cursor",void 0),i([c.property({value:!0})],t.prototype,"editable",null),i([c.property({dependsOn:["view.spatialReference"],readOnly:!0})],t.prototype,"projectionEngineRequired",null),i([c.property({readOnly:!0})],t.prototype,"projectionEngineSupported",null),t=i([c.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],t)}(c.declared(f))});