// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!./Feature/nls/Feature","dojo/keys","../core/lang","../core/watchUtils","../core/accessorSupport/decorators","../layers/support/exifUtils","./Widget","./Feature/FeatureViewModel","./Feature/support/attachmentUtils","./Feature/support/featureUtils","./support/chartUtils","./support/uriUtils","./support/widget"],function(e,t,a,i,n,r,s,o,l,d,c,m,u,p,h,f,_,v){function y(e,t){return void 0===t?g+"__"+e:g+"__"+e+"-"+t}var x={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",showMediaPagination:"esri-feature--media-pagination-visible",attachments:"esri-feature__attachments",attachmentsList:"esri-feature__attachments--list",attachmentsPreview:"esri-feature__attachments--preview",attachmentsTitle:"esri-feature__attachments-title",attachmentsItems:"esri-feature__attachments-items",attachmentsItem:"esri-feature__attachments-item",attachmentsItemMask:"esri-feature__attachment-item-mask",attachmentsItemMaskIcon:"esri-feature__attachment-item-mask--icon",attachmentsItemImage:"esri-feature__attachments-image",attachmentsItemImageOverlay:"esri-feature__attachments-image-overlay",attachmentsItemLinkIcon:"esri-feature__attachments-link-icon esri-icon-link-external",attachmentsItemImageResizable:"esri-feature__attachments-image--resizable",attachmentsItemFilename:"esri-feature__attachments-filename",attachmentsItemLink:"esri-feature__attachments-item-link",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",media:"esri-feature__media",mediaContainer:"esri-feature__media-container",mediaItemContainer:"esri-feature__media-item-container",mediaItem:"esri-feature__media-item",mediaItemTitle:"esri-feature__media-item-title",mediaItemCaption:"esri-feature__media-item-caption",mediaPrevious:"esri-feature__media-previous",mediaPreviousIconLTR:"esri-feature__media-previous-icon",mediaPreviousIconRTL:"esri-feature__media-previous-icon--rtl",mediaNext:"esri-feature__media-next",mediaNextIconLTR:"esri-feature__media-next-icon",mediaNextIconRTL:"esri-feature__media-next-icon--rtl",mediaChart:"esri-feature__media-chart",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},g="esri-feature",I={title:!0,content:!0,lastEditedInfo:!0};return function(e){function t(t){var a=e.call(this)||this;return a._chartMap=new Map,a._activeMediaMap=new Map,a._refreshTimers=new Map,a._mediaInfo=new Map,a.graphic=null,a.defaultPopupTemplateEnabled=!1,a.spatialReference=null,a.title=null,a.visibleElements=n({},I),a.map=null,a.viewModel=new u,a}return a(t,e),t.prototype.postInitialize=function(){var e=this;this.own(l.init(this,"viewModel.content",function(){return e._setupMediaRefreshTimers()}))},t.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._destroyCharts()},t.prototype.castVisibleElements=function(e){return n({},I,e)},t.prototype.render=function(){var e=v.tsx("div",{key:y("loading-container"),class:x.loadingSpinnerContainer},v.tsx("span",{class:this.classes(x.iconLoading,x.spinner)})),t=this.visibleElements,a=this.viewModel,i=a.waitingForContent,n=a.title,r=t.title?v.tsx("h4",{class:x.title,innerHTML:n}):null,s=t.content?v.tsx("div",{class:x.main},[this._renderContent(),this._renderLastEditInfo()]):null;return v.tsx("div",{class:this.classes(x.base,x.esriWidget)},v.tsx("div",{class:x.container},r,i?e:s))},t.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},t.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},t.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},t.prototype._destroyCharts=function(){this._chartMap.forEach(function(e){return e.dispose()}),this._chartMap.clear()},t.prototype._renderContent=function(){var e=this.viewModel.content;return e?"string"==typeof e?v.tsx("div",{key:y("content-string"),innerHTML:e}):v.isWidget(e)?v.tsx("div",{key:y("content-widget")},e.render()):e instanceof HTMLElement?v.tsx("div",{key:y("content-html-element"),bind:e,afterCreate:this._attachToNode}):v.isWidgetBase(e)?v.tsx("div",{key:y("content-dijit"),bind:e.domNode,afterCreate:this._attachToNode}):Array.isArray(e)?e.length?v.tsx("div",{key:y("content-content-elements")},e.map(this._renderContentElement,this)):null:void 0:null},t.prototype._renderContentElement=function(e,t){var a=this.visibleElements;if("boolean"!=typeof a.content&&!a.content[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(e,t);case"fields":return this._renderFields(e,t);case"media":return this._renderMedia(e,t);case"text":return this._renderText(e,t);default:return null}},t.prototype._renderAttachmentInfo=function(e){var t,a,i=e.attachmentInfo,n=e.supportsResizeAttachments,s=i.contentType,o=i.exifInfo,l=i.name,d=i.url,m=c.getExifValue({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:o}),u=h.getOrientationStyles(m),f=n&&p.isSupportedImage(s),_=-1===d.indexOf("?")?"?":"&",y=f?""+d+_+"w=48":p.getIconPath(s),g=(t={},t[x.attachmentsItemMaskIcon]=!f,t),I=(a={},a[x.attachmentsItemImageResizable]=n,a);return v.tsx("li",{class:x.attachmentsItem,key:i},v.tsx("a",{class:x.attachmentsItemLink,href:d,target:"_blank"},v.tsx("div",{class:this.classes(g,x.attachmentsItemMask)},v.tsx("img",{styles:u,alt:"",class:this.classes(I,x.attachmentsItemImage),src:y}),v.tsx("span",{class:x.attachmentsItemImageOverlay},v.tsx("span",{"aria-hidden":"true",class:x.attachmentsItemLinkIcon}))),v.tsx("span",{class:x.attachmentsItemFilename},l||r.noTitle)))},t.prototype._renderAttachments=function(e,t){var a,i=this,n=e.displayType,s=e.attachmentInfos,o=s&&s.length,l=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),d=(a={},a[x.attachmentsList]="preview"!==n,a[x.attachmentsPreview]="preview"===n,a);return o?v.tsx("div",{key:y("attachments-element"),class:this.classes(x.attachments,x.contentElement,d)},v.tsx("div",{class:x.attachmentsTitle},r.attach),v.tsx("ul",{class:x.attachmentsItems},s.map(function(t,a){return i._renderAttachmentInfo({attachmentInfo:t,attachmentInfoIndex:a,supportsResizeAttachments:l,contentElement:e})}))):null},t.prototype._forceLTR=function(e){return"&lrm;"+e},t.prototype._renderFieldInfo=function(e,t){var a,i=this.viewModel,n=i.formattedAttributes,r=n?n.content[t]||n.global:null,s=e.fieldName,o=e.label||s,l=r?null==r[s]?"":r[s]:"",d=!(!e.format||!e.format.dateFormat),c="number"==typeof l&&!d,m=c?this._forceLTR(l):_.autoLink(l),u=(a={},a[x.fieldDataDate]=d,a);return v.tsx("tr",{key:y("fields-element-info-row",t)},v.tsx("th",{key:y("fields-element-info-row-header",t),class:x.fieldHeader,innerHTML:o}),v.tsx("td",{key:y("fields-element-info-row-data",t),class:this.classes(x.fieldData,u),innerHTML:m}))},t.prototype._renderFields=function(e,t){var a=this,i=e.fieldInfos;return i?v.tsx("div",{key:y("fields-element",t),class:this.classes(x.fields,x.contentElement)},v.tsx("table",{class:x.esriTable,summary:r.fieldsSummary,key:y("fields-element-table",t)},v.tsx("tbody",{key:y("fields-element-table-body",t)},i.map(function(e){return a._renderFieldInfo(e,t)})))):null},t.prototype._shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e){return!/^(?:mailto:|tel:)/.test(e.trim().toLowerCase())}},t.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(e){return clearTimeout(e)}),this._refreshTimers.clear()},t.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},t.prototype._getImageSource=function(e,t){var a=-1!==e.indexOf("?")?"&":"?",i=e.split("#"),n=i[0],r=i[1],s=void 0===r?"":r;return""+n+a+"timestamp="+t+(s?"#":"")+s},t.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var a=t[e];if(a&&"media"===a.type){var i=this._activeMediaMap.get(e);isNaN(i)&&(i=0);var n=a.mediaInfos[i];n&&"image"===n.type&&n.refreshInterval&&this._setRefreshTimeout(e,n)}}},t.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach(function(t,a){return e._setupMediaRefreshTimer(a)})},t.prototype._updateMediaInfoTimestamp=function(e,t){var a=Date.now();this._mediaInfo.set(t,{timestamp:a,sourceURL:this._getImageSource(e,a)}),this.scheduleRender()},t.prototype._setRefreshTimeout=function(e,t){var a=this,i=t.refreshInterval,n=t.value;if(i){var r=6e4*i;this._updateMediaInfoTimestamp(n.sourceURL,e);var s=setInterval(function(){a._updateMediaInfoTimestamp(n.sourceURL,e)},r);this._refreshTimers.set(e,s)}},t.prototype._renderMediaInfoType=function(e){var t=e.mediaInfo,a=e.contentElementIndex,i=e.activeMediaIndex,n=t.title,r=void 0===n?"":n;if("image"===t.type){var s=t,o=s.value,l=s.refreshInterval,d=o.sourceURL,c=o.linkURL,m=this._shouldOpenInNewTab(c),u=m?"_blank":"_self",p=l?this._mediaInfo.get(a):null,h=p?p.timestamp:0,f=p?p.sourceURL:d,_=v.tsx("img",{alt:r,key:y("media-image-"+h+"-"+a,i),src:f}),g=c?v.tsx("a",{title:r,href:c,target:u},_):null;return g||_}if(-1!==t.type.indexOf("chart"))return v.tsx("div",{key:y("media-chart-"+a,i),bind:this,"data-media-info":t,"data-content-element-index":a,class:x.mediaChart,afterCreate:this._getChartDependencies})},t.prototype._getChartDependencies=function(e){var t=this,a=e["data-media-info"],i=e["data-content-element-index"],n=a.value,r=a.type;f.loadChartsModule().then(function(a){t._renderChart({chartDiv:e,contentElementIndex:i,type:r,value:n,chartsModule:a})})},t.prototype._createPieChart=function(e){var t=e.chartDiv,a=e.chartsModule,i=a.am4core,n=a.am4charts,r=i.create(t,n.PieChart),s=r.series.push(new n.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value="y",s.dataFields.category="x",r},t.prototype._createXYChart=function(e){var t=e.chartDiv,a=e.type,i=e.value,n=e.chartsModule,r=n.am4core,s=n.am4charts,o=r.create(t,s.XYChart),l=i.series.length>15;if("column-chart"===a){var d=o.xAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,o.yAxes.push(new s.ValueAxis);var c=o.series.push(new s.ColumnSeries);c.dataFields.valueY="y",c.dataFields.categoryX="x",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new r.Scrollbar)}if("bar-chart"===a){var d=o.yAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.inversed=!0,d.renderer.labels.template.disabled=!0,o.xAxes.push(new s.ValueAxis);var c=o.series.push(new s.ColumnSeries);c.dataFields.valueX="y",c.dataFields.categoryY="x",o.cursor=new s.XYCursor,l&&(o.scrollbarY=new r.Scrollbar)}if("line-chart"===a){var d=o.xAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,o.yAxes.push(new s.ValueAxis);var c=o.series.push(new s.LineSeries);c.dataFields.categoryX="x",c.dataFields.valueY="y",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new r.Scrollbar)}return o},t.prototype._renderChart=function(e){var t=e.contentElementIndex,a=e.type,i=e.value,n=e.chartsModule;n.am4core.useTheme(n.am4themes_animated);var r="pie-chart"===a?this._createPieChart(e):this._createXYChart(e);r.data=i.series.map(function(e){return{x:e.tooltip,y:e.y}}),this._chartMap.set(t,r)},t.prototype._renderMediaInfo=function(e){var t=e.mediaInfo,a=e.contentElementIndex,i=e.activeMediaIndex,n=this._renderMediaInfoType({mediaInfo:t,contentElementIndex:a,activeMediaIndex:i}),r=t.title?v.tsx("div",{key:y("media-title",a),class:x.mediaItemTitle,innerHTML:t.title}):null,s=t.caption?v.tsx("div",{key:y("media-caption",a),class:x.mediaItemCaption,innerHTML:t.caption}):null;return v.tsx("div",{key:y("media-container",a),class:x.mediaItemContainer},v.tsx("div",{key:y("media-item-container",a),class:x.mediaItem},n),r,s)},t.prototype._renderMediaPageButton=function(e,t){var a="previous"===e,i=a?r.previous:r.next,n=a?this.classes(x.btn,x.mediaPrevious):this.classes(x.btn,x.mediaNext),s=a?this.classes(x.icon,x.mediaPreviousIconLTR,x.iconLeftTriangleArrow):this.classes(x.icon,x.mediaNextIconLTR,x.iconRightTriangleArrow),o=a?this.classes(x.icon,x.mediaPreviousIconRTL,x.iconRightTriangleArrow):this.classes(x.icon,x.mediaNextIconRTL,x.iconLeftTriangleArrow),l=a?"previous":"next",d=a?this._previousClick:this._nextClick;return v.tsx("div",{key:y(l,t),title:i,tabIndex:0,role:"button",class:n,"data-content-element-index":t,bind:this,onkeydown:d,onclick:d},v.tsx("span",{"aria-hidden":"true",class:s}),v.tsx("span",{"aria-hidden":"true",class:o}),v.tsx("span",{class:x.iconText},i))},t.prototype._handleMediaKeyup=function(e){var t=e.currentTarget,a=t["data-content-element-index"],i=e.keyCode;i===s.LEFT_ARROW&&(e.stopPropagation(),this.previousMedia(a)),i===s.RIGHT_ARROW&&(e.stopPropagation(),this.nextMedia(a))},t.prototype._renderMedia=function(e,t){var a,i=e.mediaInfos,n=i&&i.length||0,r=(a={},a[x.showMediaPagination]=n>1,a),s=this._renderMediaPageButton("previous",t),o=this._renderMediaPageButton("next",t),l=this._activeMediaMap.get(t);return isNaN(l)&&(this._activeMediaMap.set(t,0),l=0),n?v.tsx("div",{key:y("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(x.media,x.contentElement,r)},v.tsx("div",{key:y("media-element-container",t),class:x.mediaContainer},s,this._renderMediaInfo({mediaInfo:i[l],contentElementIndex:t,activeMediaIndex:l}),o)):null},t.prototype._renderLastEditInfo=function(){var e=this.visibleElements,t=this.viewModel.lastEditInfo;if(!t||!e.lastEditedInfo)return null;var a=t.date,i=t.user,n="edit"===t.type?i?r.lastEditedByUser:r.lastEdited:i?r.lastCreatedByUser:r.lastCreated,s=o.substitute({date:a,user:i},n);return v.tsx("div",{key:y("edit-info-element"),class:this.classes(x.lastEditedInfo,x.contentElement)},s)},t.prototype._renderText=function(e,t){return e.text?v.tsx("div",{key:y("text-element",t),innerHTML:e.text,class:this.classes(x.text,x.contentElement)}):null},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var a=this.viewModel.content,i=a&&a[e],n=i&&i.mediaInfos;if(n&&n.length){var r=(t+n.length)%n.length;this._activeMediaMap.set(e,r),this._setupMediaRefreshTimer(e),this.scheduleRender()}},t.prototype._pageContentElementMedia=function(e,t){var a="previous"===t?-1:1,i=this._activeMediaMap.get(e)+a;this._setContentElementMedia(e,i)},t.prototype._previousClick=function(e){var t=e.currentTarget,a=t["data-content-element-index"];this.previousMedia(a)},t.prototype._nextClick=function(e){var t=e.currentTarget,a=t["data-content-element-index"];this.nextMedia(a)},i([d.aliasOf("viewModel.graphic")],t.prototype,"graphic",void 0),i([d.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),i([d.aliasOf("viewModel.spatialReference")],t.prototype,"spatialReference",void 0),i([d.aliasOf("viewModel.title")],t.prototype,"title",void 0),i([d.property(),v.renderable()],t.prototype,"visibleElements",void 0),i([d.cast("visibleElements")],t.prototype,"castVisibleElements",null),i([d.aliasOf("viewModel.map")],t.prototype,"map",void 0),i([d.property({type:u}),v.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo"])],t.prototype,"viewModel",void 0),i([v.accessibleHandler()],t.prototype,"_previousClick",null),i([v.accessibleHandler()],t.prototype,"_nextClick",null),t=i([d.subclass("esri.widgets.Feature")],t)}(d.declared(m))});