// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/kernel","dojo/Deferred","../../../core/lang","../_AppTemplateFiltersMixin","../../../portal/PortalQueryParams","dojo/i18n!../nls/BrowseItems"],function(e,t,s,i,r,n,l){var o=e(null,{declaredClass:"esri.widgets.BrowseItems.plugins.PluginConfigurableApps",_css:{base:"esri-browseitems",button:"esri-button",close:"esri-button esri-close"},infoPanelTemplate:'<div><div class="template-info-showing"><div class="thumbnail"><img src="${item:_formatInfoPanelImage}"></div><h4>${item.title}</h4><div class="template-info"><p class="quiet-scroll">${item.snippet}</p></div></div><div class="panel-actions"><button class="${_css.button}" title="${i18n.items.createApp}"id="create-app">${i18n.items.createApp}</button><button class="${_css.button}" title="${i18n.preview}" id="preview-app">${i18n.preview}</button><button class="${_css.button}" title="${i18n.download}" id="download-app">${i18n.download}</button><button class="${_css.close}" id="close-panel">${i18n.close}</button></div><div>',customGroupInfoPanelTemplate:'<div><div class="template-info-showing"><div class="thumbnail"><img src="${item:_formatInfoPanelImage}"></div><h4>${item.title}</h4><div class="template-info"><p class="quiet-scroll">${item.snippet}</p></div></div><div class="panel-actions"><button class="btn blue btn-main" id="create-app">${i18n.items.createApp}</button><button class="btn btn-secondary btn-wide" id="preview-app">${i18n.preview}</button><button class="btn btn-cancel" id="close-panel">${i18n.close}</button></div><div>',filters:i.mixin({},r.rootNodes.app),filterStrings:l.appTemplateFilters,rowsPerPage:9,extraClasses:[],_portal:null,_user:null,_groups:[],filterType:"all",constructor:function(e){i.mixin(this,e)},fetchData:function(){var e=[];return this._portal=this.parent.get("portal"),this._user=this._portal.user,this.parent.types=['type:"Web Mapping Application"'],this.helpLinkUrl||(this.helpLinkUrl=this._portal?this._portal.helpBase+this._portal.helpMap.m[120001055]:""),this._fetchGroups().then(function(t){return t=t||[],t.forEach(function(t){t&&t.id&&e.push('group:"'+t.id+'"')}),this._fetchGroupItems(e)}.bind(this))},_fetchGroups:function(){var e,t;return e=this._portal.templatesGroupQuery||null,t=e&&e.split("id:")[1],t?this._fetchOrgConfigurableApps():this._fetchEsriConfigurableApps()},_fetchGroup:function(e,t){var i=new s;return this._groups[e]?i.resolve([this._groups[e]]):this._portal.queryGroups(t,!0).then(function(t){var s=t.total&&t.results&&t.results[0]||{};this._groups[e]=s,i.resolve([s])}.bind(this)),i},_fetchGroupItems:function(e){var t={groups:e,persistentTypekeywords:['-typekeywords:"Web AppBuilder"','-typekeywords:"WAB3D"'],types:['type:"Web Mapping Application"']};return"2d"===this.filterType?(t.persistentTypekeywords.push('-typekeywords:"3Dscene"'),delete this.filters.present,delete this.filters["3dscene"]):"3d"===this.filterType&&(t.persistentTypekeywords.push('typekeywords:"3Dscene"'),this.filters=null),this.parent._fetchItems(t)},_fetchEsriConfigurableApps:function(){var e={id:"ind",uk:"ukr"},s=(this._user&&this._user.culture||this._portal&&this._portal.culture||t.locale||"en").split("-")[0].toLowerCase(),i=new n({query:'title:"Web Application Templates" AND owner:"esri_'+(e[s]||s)+'"'});return this._fetchGroup("esriGallery_"+s,i).then(function(e){return e||[]})},_fetchOrgConfigurableApps:function(){var e=this._portal.templatesGroupQuery||null,t=new n({query:e});return this.filters=null,this.rowsPerPage=8,this.extraClasses=["wide"],this.infoPanelTemplate=this.customGroupInfoPanelTemplate,this._fetchGroup("customGallery",t).then(function(e){var t=[];return e&&e.length&&e.length>0&&(this.parent.sortDescending=e[0].sortOrder&&"desc"===e[0].sortOrder,this.parent.sortAttribute=e[0].sortField||"asc",t.push(e[0])),t}.bind(this))}});return i.mixin(o,{add:function(e,t){if(!e.plugin){var s=i.mixin(t,{parent:e,filterType:e.filterType});e.plugin=new o(s)}},remove:function(e){e.plugIn&&(e.plugin.destroy(),delete e.plugIn)}}),o});