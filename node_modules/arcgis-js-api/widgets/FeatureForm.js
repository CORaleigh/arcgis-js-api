// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/date/locale","../moment","../core/accessorSupport/decorators","../layers/support/domains","../layers/support/fieldUtils","./Widget","./FeatureForm/FeatureFormViewModel","./support/widget"],function(e,t,i,a,r,n,l,u,o,d,s,p,c){function f(e){return e&&e.inputFields}var h={base:"esri-feature-form",form:"esri-feature-form__form",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputDisabled:"esri-feature-form__input--disabled",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupDescription:"esri-feature-form__group-description",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",errorIcon:"esri-icon-notice-triangle",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input",select:"esri-select"},v={datePattern:"M/d/y",timePattern:"h:mm:ss a"};return function(e){function t(t){var i=e.call(this)||this;return i._fieldFocusNeeded=!1,i._activeDateEdit=null,i._activeInputName=null,i.feature=null,i.fieldConfig=null,i.groupDisplay="all",i.layer=null,i.strict=null,i.viewModel=new p,i._handleFormKeyDown=i._handleFormKeyDown.bind(i),i._handleInputBlur=i._handleInputBlur.bind(i),i._handleInputFocus=i._handleInputFocus.bind(i),i._handleNumberInputMouseDown=i._handleNumberInputMouseDown.bind(i),i._handleInputKeyDown=i._handleInputKeyDown.bind(i),i._handleOptionChange=i._handleOptionChange.bind(i),i._handleGroupClick=i._handleGroupClick.bind(i),i._handleSubmit=i._handleSubmit.bind(i),i._afterScrollerCreateOrUpdate=i._afterScrollerCreateOrUpdate.bind(i),i}return a(t,e),t.prototype.postInitialize=function(){var e=this;this.own(this.watch("feature",function(){var t=e.viewModel.inputFields[0],i=f(t)?t.inputFields[0]:t;e._activeInputName=i&&i.name,e._fieldFocusNeeded=!0}),this.on("submit",function(t){if(t.invalid.length>0){var i=t.invalid[0];e._activeInputName=i,e._fieldFocusNeeded=!0,e.scheduleRender()}}))},t.prototype.getValues=function(){return null},t.prototype.submit=function(){return null},t.prototype.render=function(){var e=this.viewModel.state;return c.tsx("div",{class:this.classes(h.base,h.widget,h.panel)},"ready"===e?this.renderForm():null)},t.prototype.renderForm=function(){return c.tsx("form",{class:h.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this.renderFields())},t.prototype.renderFields=function(){var e=this;return this.viewModel.inputFields.map(function(t,i){return f(t)?e.renderGroup(t,i):e.renderLabeledField(t)})},t.prototype.renderGroup=function(e,t){var i=this,a=e.description,r=e.label,n=e.inputFields,l=this.viewModel.findField(this._activeInputName),u=l&&l.group===e,o=this.id+"_group_"+t,d=this.id+"_group-label_"+t,s=this.id+"_group-description_"+t,p=a?c.tsx("p",{class:this.classes(h.groupDescription,h.description),id:s},a):null,f="sequential"===this.groupDisplay,v=f?u?"true":"false":void 0;return c.tsx("fieldset",{class:this.classes(h.group,f?h.groupSequential:null,!f||u?null:h.groupCollapsed,u?h.groupActive:null),"aria-expanded":v,"aria-labelledby":d,"aria-describedby":a?s:"","data-group":e,id:o,key:t,onclick:this._handleGroupClick},c.tsx("div",{class:h.groupLabel,id:d},r),p,n.map(function(e){return i.renderLabeledField(e)}))},t.prototype._getFocusableInput=function(e,t){for(var i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse(),r=a.indexOf(t)+1,n=r;n<a.length;n++){var l=a[n];if(l.visible&&l.editable)return l}return null},t.prototype.renderLabeledField=function(e){var t=e.label,i=e.layer,a=e.type;return c.tsx("label",{key:i.id+"-"+e.name,class:h.label},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},t.prototype.renderInputField=function(e){var t=this.viewModel,a=e.domain,r=e.editable,n=e.name,l=e.type,u=t.getValue(n),o=!r,d=this.getCommonInputProps(e);return a&&"coded-value"===a.type&&!o?this.renderSelectInputField(u,a.codedValues.map(function(e){return{value:e.code,name:e.name}}),d):"text"===l&&"text-area"===e.editorType||"rich-text"===e.editorType?c.tsx("textarea",i({},d)):"date"===l?this.renderDateInputField(u,d):c.tsx("input",i({type:"text"===l?"text":"number"},d))},t.prototype.renderDateInputField=function(e,t){var a=this._formatDate(0),r=a.date,n=a.time,l=this.id+"-"+t.key,u=l+"-date",o=l+"-time",d=t["data-field"];return c.tsx("div",{key:t.key+"-date",class:h.dateInputContainer},c.tsx("div",{class:h.dateInputPart},c.tsx("input",i({"aria-label":d.label,"aria-describedby":u,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,h.inputDate),value:this._formatDate(e).date})),c.tsx("div",{class:h.dateFormatHint,id:u},r)),c.tsx("div",{class:h.dateInputPart},c.tsx("input",i({"aria-describedby":o,"aria-label":d.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,h.inputTime),value:this._formatDate(e).time})),c.tsx("div",{class:h.dateFormatHint,id:o},n)))},t.prototype.renderUnsupportedField=function(e){var t=this.viewModel.getValue(e.name);return c.tsx("input",{class:this.classes(h.input,h.inputField,h.inputDisabled),disabled:!0,type:"text",value:""+t})},t.prototype.renderSelectInputField=function(e,t,a){var r=!1,n=t.map(function(t){return t.value===e&&(r=!0),c.tsx("option",{value:""+t.value,key:t.name},t.name)});null==e||""===e||r||n.unshift(c.tsx("option",{value:""+e,key:"outlier-option"},e));var l=a["data-field"];return l.required||null!=l.value||n.unshift(c.tsx("option",{value:"",key:"empty-option"})),c.tsx("select",i({},a,{class:this.classes(a.class,h.select),onchange:this._handleOptionChange}),n)},t.prototype.renderAuxiliaryText=function(e){return e.valid?e.valid&&e.description?c.tsx("div",{key:"description",class:h.description},e.description):void 0:c.tsx("div",{key:"error-message"},c.tsx("span",{class:this.classes(h.inputIconInvalid,h.errorIcon)}),c.tsx("div",{class:h.errorMessage},e.errorMessage))},t.prototype.getCommonInputProps=function(e){var t=this.viewModel,a=e.editable,r=e.name,n=e.required,l=e.maxLength,u=e.hint,o=e.type,d=e.valid,s=t.getValue(r),p=!a;return i({afterCreate:this._afterScrollerCreateOrUpdate,afterUpdate:this._afterScrollerCreateOrUpdate,"aria-invalid":d?"false":"true",class:this.classes(h.input,h.inputField,p?h.inputDisabled:null,d?null:h.inputInvalid),key:r,maxlength:l>-1?""+l:""},this._getNumberFieldConstraints(e),{disabled:p,value:null==s?"":""+s,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===o?this._handleNumberInputMouseDown:null,required:n,title:u})},t.prototype._handleNumberInputMouseDown=function(e){var t=e.target,i=t;i.disabled||i.focus(),this.scheduleRender()},t.prototype._getNumberFieldConstraints=function(e){var t=o.getDomainRange(e.domain)||d.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},t.prototype._afterScrollerCreateOrUpdate=function(e){var t=e["data-field"],i=this.viewModel.findField(this._activeInputName);t.editable&&this._fieldFocusNeeded&&i===t&&(this._fieldFocusNeeded=!1,e.focus())},t.prototype._handleInputFocus=function(e){var t=e.target;this._activeInputName=t["data-field"].name},t.prototype._handleInputBlur=function(e){var t,a=e.target,r=a["data-field"],n=e.relatedTarget,l=n&&n["data-field"];if("date"===r.type){var u=a.getAttribute("data-date-part");this._activeDateEdit=i({},this._activeDateEdit,(t={},t[u]={value:a.value,input:a},t))}if(l&&"date"===r.type&&"date"===l.type&&r.field===l.field){if(""!==a.value&&""===n.value){var u=n.getAttribute("data-date-part");n.value=this._formatDate(Date.now())[u]}}else this._commitValue(a),this.scheduleRender()},t.prototype._commitValue=function(e){var t=e["data-field"];if(this._activeDateEdit){var i=this._activeDateEdit,a=i.date,r=i.time,n=this._getDateEditValue(t,"date"),l=this._getDateEditValue(t,"time"),u=""===n||""===l;if(a){var o=a.input;o.value=u?"":n,this._updateFieldValue(o)}if(r){var d=r.input;d.value=u?"":l,this._updateFieldValue(d)}this._activeDateEdit=null}else this._updateFieldValue(e)},t.prototype._getDateEditValue=function(e,t){var i=this._activeDateEdit[t];if(i){if(""===i.value)return"";var a=this._parseDate(i.value,t);return a?this._formatDate(a.getTime())[t]:this._formatDate(e.value)[t]}},t.prototype._handleInputKeyDown=function(e){var t=e.key,i=e.altKey,a=e.ctrlKey,r=e.metaKey,n=e.shiftKey;if("Tab"===t){var l=e.target,u=l["data-field"],o=n?"backward":"forward",d=l.getAttribute("data-date-part");if(!!("backward"===o&&"time"===d||"forward"===o&&"date"===d))return;this._commitValue(l);var s=this.viewModel.findField(u.name),p=this._getFocusableInput(o,s);return this._activeInputName=p&&p.name,void(p?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._updateFieldValue(e.target),this.scheduleRender();else{var l=e.target,u=l["data-field"],c=u.field.type,f="integer"===c||"small-integer"===c,h="single"===c||"double"===c,v=!i&&!a&&!r;if((f||h)&&v&&1===t.length){var m=Number(t),_=["-","+"],y=["e","."],g=h?_.concat(y):_;isNaN(m)&&-1===g.indexOf(t)&&e.preventDefault()}}},t.prototype._updateFieldValue=function(e){var t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e))},t.prototype._parseValue=function(e){var t=e["data-field"],i=e.value,a=t.required,r=t.type;if(!a&&""===i)return null;if("number"===r)return parseFloat(i);if("date"===r){if(!i)return null;var n=e.getAttribute("data-date-part"),u=Number(i);if(!isNaN(u))return u;var o=this._parseDate(i,n);if(!o)return null;var d=l(o),s=t.domain,p=l(),c=p;if(s&&"range"===s.type){var f=l(s.maxValue);p.isAfter(f)||(c=f)}var h=this.viewModel.getValue(t.name),v=l(null!=h?h:c);return"date"===n?(d.hour(v.hour()),d.minutes(v.minutes()),d.seconds(v.seconds())):(d.date(v.date()),d.month(v.month()),d.year(v.year())),d.valueOf()}return i},t.prototype._handleOptionChange=function(e){this._updateFieldValue(e.target),this.scheduleRender()},t.prototype._handleGroupClick=function(e){var t=e.currentTarget;if("false"===t.getAttribute("aria-expanded")){var i=t["data-group"];this._activeInputName=i.inputFields[0].name,this._fieldFocusNeeded=!0,this.scheduleRender()}},t.prototype._handleSubmit=function(e){e.preventDefault()},t.prototype._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},t.prototype._formatDate=function(e){if(null==e)return{date:"",time:""};var t=new Date(e);return{date:n.format(t,i({selector:"date"},v)),time:n.format(t,i({selector:"time"},v))}},t.prototype._parseDate=function(e,t){return null==e||""===e?null:n.parse(e,i({selector:t},v))},r([u.aliasOf("viewModel.feature")],t.prototype,"feature",void 0),r([u.aliasOf("viewModel.fieldConfig")],t.prototype,"fieldConfig",void 0),r([u.property(),c.renderable()],t.prototype,"groupDisplay",void 0),r([u.aliasOf("viewModel.layer")],t.prototype,"layer",void 0),r([u.aliasOf("viewModel.strict")],t.prototype,"strict",void 0),r([u.property(),c.renderable(["viewModel.inputFields","viewModel.state"]),c.vmEvent(["value-change","submit"])],t.prototype,"viewModel",void 0),r([u.aliasOf("viewModel.getValues")],t.prototype,"getValues",null),r([u.aliasOf("viewModel.submit")],t.prototype,"submit",null),t=r([u.subclass("esri.widgets.FeatureForm")],t)}(u.declared(s))});