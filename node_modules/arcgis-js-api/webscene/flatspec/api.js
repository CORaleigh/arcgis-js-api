// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Basemap","../../Ground","../../WebScene","../../core/compilerUtils","../../core/JSONSupport","../../core/MultiOriginJSONSupport","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/mixins/OperationalLayer","./utils"],function(e,t,n,r,u,a,o,i,s,l,p,y,c,f,d){function m(e){return r(this,void 0,void 0,function(){var t;return n(this,function(n){return t=new d.ScanContext,[2,k(null,{typeName:"json",type:e},t)]})})}function v(e,t,u){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:switch(r=t.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,w(e,t,u)];case 2:return n.sent(),[3,12];case 3:return[4,S(e,t,u)];case 4:return n.sent(),[3,12];case 5:return[4,k(e,t,u)];case 6:return n.sent(),[3,12];case 7:return[4,h(e,t,u)];case 8:return n.sent(),[3,12];case 9:return[4,g(e,t,u)];case 10:return n.sent(),[3,12];case 11:i.neverReached(t),n.label=12;case 12:return[2]}})})}function h(e,t,u){return r(this,void 0,void 0,function(){return n(this,function(n){return u.addProperty({name:e,type:M(t),default:t.default}),[2]})})}function b(e){var t=e.slice();return t.sort(),t}function g(e,t,u){return r(this,void 0,void 0,function(){var r;return n(this,function(n){return r=t.values.slice(),t.nullable&&r.push(null),u.addProperty({name:e,type:M(t),enum:b(r).map(function(e){return"string"==typeof e?'"'+e+'"':""+e}).join("|"),default:t.default}),[2]})})}function w(e,t,u){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return[4,v(e+"[]",t.elementType,u)];case 1:return n.sent(),[2]}})})}function N(e){return z[e]||e}function S(e,t,u){return r(this,void 0,void 0,function(){var r,a,o,i,s,l;return n(this,function(n){switch(n.label){case 0:r=[],a=0,o=t.types,n.label=1;case 1:return a<o.length?(i=o[a],"native"!==i.type.typeName?[3,2]:(r.push(i.type),[3,4])):[3,5];case 2:return s=e+"<"+N(i.value)+">",[4,v(s,i.type,u)];case 3:n.sent(),n.label=4;case 4:return a++,[3,1];case 5:return r.length&&(l=r.map(M),t.nullable&&l.push("null"),l.sort(),u.addProperty({type:l.join("|"),name:e,default:t.default})),[2]}})})}function j(e,t,i){return r(this,void 0,void 0,function(){return n(this,function(n){return e.type===o&&"layers"===t?[2,x("web-scene/operational-layers")]:e.type===u&&"baseLayers"===t?[2,x("web-scene/basemap")]:e.type===a&&"layers"===t?[2,x("web-scene/ground")]:e.type===c&&"layers"===t?[2,x("web-scene/operational-layers",function(e){return e!==c})]:[2,R(i)]})})}function T(e){return e.prototype.declaredClass.replace(/\./g,"/")}function k(e,t,u){return r(this,void 0,void 0,function(){var r,a,o,i,s,l,p,y,c,f,d,m,h;return n(this,function(n){switch(n.label){case 0:if(r=t.type.__accessorMetadata__,a=T(t.type),!(o=r&&r.properties))return e&&u.addProperty({name:e,type:"unknown"}),[2,null];if((i=u.seen.get(t.type))&&e)return u.addProperty({name:e,type:i}),[2,i];s={type:t.type,name:a,properties:[]},e&&u.addProperty({name:e,type:s}),u.push(e,s),l=[];for(p in o)l.push(p);y=0,n.label=1;case 1:return y<l.length?(c=l[y],f=o[c],(d=q(f))&&d.enabled?(m=d.target,"string"!=typeof m&&null!=m?[3,4]:[4,j(t,c,f)]):[3,6]):[3,7];case 2:return h=n.sent(),h?[4,v("string"==typeof m?m:c,h,u)]:[3,6];case 3:return n.sent(),[3,6];case 4:return[4,C(m,u)];case 5:n.sent(),n.label=6;case 6:return y++,[3,1];case 7:return[2,u.pop()]}})})}function C(e,t){return r(this,void 0,void 0,function(){var r,u,a;return n(this,function(n){for(r in e)u=e[r],a=void 0,a=u.types?O(u.types):A(u.type),a.default=u.default,v(r,a,t);return[2]})})}function x(e,t){return r(this,void 0,void 0,function(){var r,u,a,o,i,s,l,p;return n(this,function(n){switch(n.label){case 0:r=f.supportedTypes[e],u={typeName:"union",key:"layerType",types:[]},a=[];for(o in r)a.push(o);i=0,n.label=1;case 1:return i<a.length?(s=a[i],[4,f.typeModuleMap[s]()]):[3,4];case 2:if(!(l=n.sent()))return[3,3];if(t&&!t(l))return[3,3];u.types.push({type:{typeName:"json",type:l},value:s}),n.label=3;case 3:return i++,[3,1];case 4:return 0===u.types.length?[2,null]:(p={typeName:"array",elementType:1===u.types.length?u.types[0].type:u},[2,p])}})})}function M(e){switch(e.typeName){case"array":return M(e.elementType)+"[]";case"union":var t=e.types.map(function(e){return M(e.type)});return e.nullable&&t.push("null"),""+t.join(" | ");case"native":switch(e.type){case Number:return"number";case p.Integer:return"integer";case String:return"string";case Boolean:return"boolean";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:i.neverReached(e)}}function P(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:A(t)};if(t.typeMap){var n=[];for(var r in t.typeMap){var u=t.typeMap[r];n.push({type:A(u),value:I(u)?null:r})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:n}}}}function R(e){return e.types?O(e.types):_(e)}function O(e){if(Array.isArray(e))return{typeName:"array",elementType:O(e[0])};var t=[];for(var n in e.typeMap){var r=e.typeMap[n];t.push({type:A(r),value:I(r)?null:n})}return 1===t.length?t[0].type:{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function _(e){var t=L(e),n=q(e),r=t&&t.type,u=A(r||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(u.default=t.default),n.allowNull&&(u.nullable=!0),u}function A(e){return e?Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map(function(e){return{type:A(e),value:null}})}:{typeName:"array",elementType:A(e[0])}:y.isCollection(e)?P(e):I(e)?{typeName:"native",type:e}:B(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function B(e){var t=e._meta&&e._meta.bases;return!!t&&(-1!==t.indexOf(s)||-1!==t.indexOf(l))}function I(e){return e===String||e===Boolean||e===Number||e===p.Integer}function L(e){if(!e.json)return null;var t=e.json.origins,n=e.json,r=t&&t["web-scene"],u=t&&t["web-document"];return r||u||n||null}function q(e){if(!e.json)return null;var t=e.json.origins,n=e.json.write,r=t&&t["web-scene"]&&t["web-scene"].write,u=t&&t["web-document"]&&t["web-document"].write;return r||u||n||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=m;var z={"unique-value":"uniqueValue","class-breaks":"classBreaks","point-3d":"PointSymbol3D","line-3d":"LineSymbol3D","mesh-3d":"MeshSymbol3D","polygon-3d":"PolygonSymbol3D","label-3d":"LabelSymbol3D","web-style":"styleSymbolReference",text:"Text",object:"Object",icon:"Icon",fill:"Fill",extrude:"Extrude",line:"Line",path:"Path","point-cloud-class-breaks":"pointCloudClassBreaksRenderer","point-cloud-rgb":"pointCloudRGBRenderer","point-cloud-stretch":"pointCloudStretchRenderer","point-cloud-unique-value":"pointCloudUniqueValueRenderer","fixed-size":"pointCloudFixedSizeAlgorithm",splat:"pointCloudSplatAlgorithm",bitfield:"pointCloudBitfieldFilter",return:"pointCloudReturnFilter",value:"pointCloudValueFilter","stay-above":"stayAbove",color:"colorInfo",opacity:"transparencyInfo",size:"sizeInfo",rotation:"rotationInfo"}});