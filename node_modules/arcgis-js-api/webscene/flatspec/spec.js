// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/extendsHelper","../../core/Error","../../core/promiseUtils","../schema","./utils"],function(e,t,n,r,i,s,o,c,u){function a(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}function f(e){var t={count:e.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},n=new Set;for(var r in e){var i=e[r];i.$ref?t.refsCount++:i.type&&(t.typesCount++,n.add(i.type))}return n.forEach(function(e){return t.distinctTypes.push(e)}),t.distinctTypes.sort(),t.refsCount===t.count?t.type="refs":2===t.count&&t.refsCount>0&&1===t.distinctTypes.length&&"null"===t.distinctTypes[0]?t.type="refsAndNull":t.typesCount===t.count?(t.type="types",t.distinctTypes=t.distinctTypes):t.type="mix",t}function l(e){return"array"===e.type||!("properties"in e)}function p(e,t,i,s){return r(this,void 0,void 0,function(){var r,o,c;return n(this,function(n){switch(n.label){case 0:return r=a(e,t),(i=i?i.replace("<?TYPE?>",r?"<"+r+">":""):null,l(t))?(S(t,i,s),[2,null]):(o="drawingInfo_schema.json"!==e&&!s.hasFilteredProperties&&s.seen.get(e))&&i?(s.addProperty({name:i,type:o}),[2,o]):(c={type:e,name:e,properties:[]},i&&s.addProperty({name:i,type:c}),s.push(i,c),[4,S(t,"",s)]);case 1:return n.sent(),[2,s.pop()]}})})}function h(e,t,i){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return[4,i.requestSchema(e.$ref)];case 1:return r=n.sent(),[2,p(r.schemaId,r.schema,t,i)]}})})}function d(e,t){return!!y(e)&&(/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(e.stack.map(function(e){return e.klass.type}).join("/"))&&"renderer"===t)}function m(e,t){return!!y(e)&&(/.*rasterDataLayer_schema\/.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(e.stack.map(function(e){return e.klass.type}).join("/"))&&"renderer"===t)}function y(e){return"drawingInfo_schema.json"===e.currentClass.name}function v(e,t,n){var r=y(n),i=d(n,t),s=m(n,t);return r?e.filter(function(e){var t="#/definitions/pointCloudRenderers_schema.json"===e.$ref||/\#\/definitions\/pointCloud.*Renderer/.test(e.$ref),n="#/definitions/rasterRenderers_schema.json"===e.$ref||/\#\/definitions\/raster.*Renderer/.test(e.$ref);return i===t&&n===s}):e}function w(e,t,i){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return[4,S(e.items,t+"[]",i)];case 1:return n.sent(),[2]}})})}function j(e,t,i){return r(this,void 0,void 0,function(){var s=this;return n(this,function(o){switch(o.label){case 0:return[4,i.withFilteredProperties(null,function(o){return r(s,void 0,void 0,function(){var r,s,c,u,a;return n(this,function(n){switch(n.label){case 0:r=[];for(s in e.properties)r.push(s);c=0,n.label=1;case 1:return c<r.length?(u=r[c],o&&!o.has(u)?[3,3]:(a=t?t+"."+u:u,[4,S(e.properties[u],a,i)])):[3,4];case 2:n.sent(),n.label=3;case 3:return c++,[3,1];case 4:return[2]}})})})];case 1:return o.sent(),[2]}})})}function g(e,t,i){return r(this,void 0,void 0,function(){var r,s,o,c,u,a;return n(this,function(n){switch(n.label){case 0:for(r=null,s=new Set,o=0,c=e.allOf;o<c.length;o++)if("$ref"in(u=c[o])){if(r)throw new Error("Cannot process more than 1 ref in an allOf construct");r=u}else{if(!("properties"in u))throw new Error("allOf construct only allows simple top-level property filters");for(a in u.properties)s.add(a)}return[4,i.withFilteredProperties(s,function(){return h(r,t,i)})];case 1:return n.sent(),[2]}})})}function b(e,t,i){return r(this,void 0,void 0,function(){var r,s,o,c,u,a,l,p,h,d;return n(this,function(n){switch(n.label){case 0:if(r=f(e.oneOf),"refs"!==r.type&&"refsAndNull"!==r.type)return[3,6];s=v(e.oneOf,t,i),o=0,c=s,n.label=1;case 1:return o<c.length?(u=c[o],"null"!==u.type?[3,2]:[3,4]):[3,5];case 2:return[4,S(u,t+"<?TYPE?>",i)];case 3:n.sent(),n.label=4;case 4:return o++,[3,1];case 5:return[2];case 6:if("types"===r.type)return i.addProperty({name:t,type:r.distinctTypes.join("|")}),[2];a=[];for(l in e.oneOf)a.push(l);p=0,n.label=7;case 7:return p<a.length?(h=a[p],d=".oneOf["+h+"]",[4,S(e.oneOf[h],""+t+d,i)]):[3,10];case 8:n.sent(),n.label=9;case 9:return p++,[3,7];case 10:return[2]}})})}function _(e,t,i){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return[4,h(e,t,i)];case 1:return n.sent(),[2]}})})}function P(e,t,i){return r(this,void 0,void 0,function(){var r,s;return n(this,function(n){return r="unknown",e.type&&(r=Array.isArray(e.type)?e.type.join("|"):e.type.replace(/ /g,"").split(",").join("|")),s={name:t,type:r,default:e.default},e.enum&&(s.enum=u.sorted(e.enum).map(function(e){return"string"==typeof e?'"'+e+'"':""+e}).join("|")),i.addProperty(s),[2]})})}function S(e,t,i){return r(this,void 0,void 0,function(){return n(this,function(n){return"array"===e.type?[2,w(e,t,i)]:"properties"in e?[2,j(e,t,i)]:"allOf"in e?[2,g(e,t,i)]:"oneOf"in e?[2,b(e,t,i)]:"$ref"in e?[2,_(e,t,i)]:[2,P(e,t,i)]})})}function R(e){return 0===e.indexOf(T)?e.slice(T.length):e}function O(e,t){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return[4,C.create(e,t)];case 1:return r=n.sent(),[2,p((e||"webScene")+"_schema.json",r.schemaRoot,null,r)]}})})}Object.defineProperty(t,"__esModule",{value:!0});var T="#/definitions/";t.scan=O;var C=function(t){function u(e,n,r){var i=t.call(this)||this;return i.definitions=e,i.schemaRoot=n,i.requestSchema=r,i.filteredProperties=null,i.requestSchema.bind(i),i}return i(u,t),Object.defineProperty(u.prototype,"hasFilteredProperties",{get:function(){return this.filteredProperties&&this.filteredProperties.size>0},enumerable:!0,configurable:!0}),u.prototype.withFilteredProperties=function(e,t){var n=this.filteredProperties;this.filteredProperties=e;var r=t(n);return this.filteredProperties=n,r},u.create=function(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){return t&&t.useRemoteSchema?[2,u.createRemote(e,t.baseUrl)]:[2,u.createLocal(e)]})})},u.createLocal=function(e){var t=e?c.json.definitions[e+"_schema.json"]:c.json;return new u(c.json.definitions,t,u.getLocalSchemaRequest())},u.createRemote=function(e,t){return r(this,void 0,void 0,function(){var r,i,s;return n(this,function(n){switch(n.label){case 0:return[4,u.getRemoteSchemaRequest(t)];case 1:return r=n.sent(),i=new u({},null,r),[4,i.requestSchema((e||"webscene")+"_schema.json")];case 2:return s=n.sent().schema,[2,new u(i.definitions,s,r)]}})})},u.getLocalSchemaRequest=function(){return function(e){var t=R(e),n=this.definitions[t];return n?o.resolve({schemaId:t,schema:n}):o.reject(new s("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}},u.getRemoteSchemaRequest=function(t){return r(this,void 0,void 0,function(){var r,i;return n(this,function(n){switch(n.label){case 0:return t?(r=u.getLocalSchemaRequest(),[4,o.create(function(t){return e(["../../request"],t)})]):[2,o.reject(new s("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];case 1:return i=n.sent(),[2,function(e){var n=this;return r.call(this,e).catch(function(){return i(t+"/"+e,{responseType:"json"}).then(function(t){return n.definitions[R(e)]=t.data,{schemaId:e,schema:t.data}})})}]}})})},u}(u.ScanContext);t.schemaDefinitions=Object.keys(c.json.definitions).map(function(e){return e.replace(/_schema\.json$/,"")})});