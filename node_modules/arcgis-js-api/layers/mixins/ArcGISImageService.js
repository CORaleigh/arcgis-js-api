// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the image service.
       *
       * @type {string}
       */

// We expose "copyrightText" as "copyright" in the SDK.

define(["./ArcGISService","../support/Field","../support/Raster","../support/PixelBlock","../support/MosaicRule","../support/RasterFunction","../support/DimensionalDefinition","../support/imageryRendererUtils","../../geometry/Extent","../../geometry/Point","../../geometry/SpatialReference","../../renderers/support/jsonUtils","../../support/popupUtils","../../tasks/QueryTask","../../tasks/ImageServiceIdentifyTask","../../tasks/support/ImageServiceIdentifyParameters","../../request","../../Graphic","../../PopupTemplate","../../core/lang","../../core/Accessor","../../core/kebabDictionary","../../core/promiseUtils","../../core/Logger","../../core/Error"],function(e,t,r,i,n,a,s,l,o,u,c,p,d,f,h,m,g,y,v,b,x,R,I,T,S){var D=new R.KebabDictionary({S8:"s8",S16:"s16",S32:"s32",U8:"u8",U16:"u16",U32:"u32",F32:"f32",F64:"f64"}),w=T.getLogger("esri.layers.mixins.ArcGISImageService"),j=x.createSubclass({properties:{layer:{},mosaicRule:{dependsOn:["layer.mosaicRule"],get:function(){return this.get("layer.mosaicRule")||null}},version:{value:0,dependsOn:["layer.bandIds","layer.format","layer.compressionQuality","layer.compressionTolerance","layer.interpolation","layer.noData","layer.noDataInterpretation","layer.mosaicRule","layer.renderingRule","layer.adjustAspectRatio","layer.pixelFilter","layer.renderer"],get:function(){var e=this.layer;return e.bandIds,e.format,e.compressionQuality,e.compressionTolerance,e.interpolation,e.noData,e.noDataInterpretation,e.mosaicRule,e.renderingRule,e.adjustAspectRatio,e.pixelFilter,e.renderer,this._get("version")+1}}},getExportImageRenderingRule:function(){var e=this.layer,t=e.renderer;return t&&l.isSupportedRendererType(t)?l.combineRenderingRules(l.convertRendererToRenderingRule(t,{rasterAttributeTable:e.rasterAttributeTable,pixelType:e.pixelType,convertColorRampToColormap:e.version<10.6}),e.renderingRule):e.renderingRule},toJSON:function(){var e=this.layer,t=this.getExportImageRenderingRule();return{bandIds:e.bandIds?e.bandIds.join(","):null,format:e.format,compressionQuality:e.compressionQuality,compressionTolerance:e.compressionTolerance,interpolation:e.interpolation,noData:e.noData,noDataInterpretation:e.noDataInterpretation,mosaicRule:this.mosaicRule?JSON.stringify(this.mosaicRule):null,renderingRule:t?JSON.stringify(t):null,adjustAspectRatio:e.adjustAspectRatio}}});return e.createSubclass({declaredClass:"esri.layers.mixins.ArcGISImageService",constructor:function(){this.exportImageServiceParameters=new j({layer:this})},_raster:null,properties:{adjustAspectRatio:{},bandCount:{},bandIds:{type:[Number],json:{write:!0}},capabilities:{json:{read:function(e){return e&&e.split(",").map(function(e){return e.trim()})}}},compressionQuality:{type:Number,json:{write:!0}},compressionTolerance:.01,copyright:{json:{read:{source:["copyrightText"],reader:function(e,t){return t.copyrightText}}}},definitionExpression:{get:function(){return this.mosaicRule?this.mosaicRule.where:null},set:function(e){var t=this.mosaicRule||new n;t.where=e,this._set("mosaicRule",t)},json:{read:{source:["definitionExpression","layerDefinition.definitionExpression"],reader:function(e,t){return e||t.layerDefinition&&t.layerDefinition.definitionExpression||void 0}}}},domainFields:{value:null,type:[t],dependsOn:["fields"],get:function(){return this.fields&&this.fields.filter(function(e){return null!=e.domain})||[]}},exportImageServiceParameters:{constructOnly:!0},fields:{type:[t]},fullExtent:{type:o,json:{read:{source:["extent"],reader:function(e,t){return o.fromJSON(t.extent)}}}},format:{type:String,dependsOn:["pixelFilter"],get:function(){return null!=this.pixelFilter?"lerc":"jpgpng"},json:{write:!0}},hasRasterAttributeTable:{},hasMultidimensions:{},imageMaxHeight:{value:4100,json:{origins:{service:{read:{source:"maxImageHeight"}}}}},imageMaxWidth:{value:15e3,json:{origins:{service:{read:{source:"maxImageWidth"}}}}},interpolation:{type:String,json:{write:!0}},mosaicRule:{value:null,type:n,json:{origins:{service:{read:{source:["defaultMosaicMethod"],reader:function(e,t){return n.fromJSON(t)}}}},write:!0}},multidimensionalInfo:null,noData:{type:Number,json:{write:!0}},noDataInterpretation:{type:String,json:{write:!0}},objectIdField:{json:{read:{source:["fields"],reader:function(e,t){return!e&&t.fields&&t.fields.some(function(t){return"esriFieldTypeOID"===t.type&&(e=t.name),!!e}),e}}}},pixelFilter:{},pixelType:{type:String,value:null,json:{read:D.read,write:D.write}},pixelSizeX:{value:0},pixelSizeY:{value:0},popupTemplate:{value:null,type:v,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}},defaultPopupTemplate:{readOnly:!0,json:{read:!1},dependsOn:["fields","title"],get:function(){return this.createPopupTemplate()}},queryTask:{readOnly:!0,dependsOn:["url"],get:function(){return new f({url:this.url})}},renderer:{value:null,json:{origins:{service:{read:!1}},read:{source:"layerDefinition.drawingInfo.renderer",reader:function(e,t,r){var i=t&&t.layerDefinition,n=p.read(e,i,r)||void 0;return l.isSupportedRendererType(n)||w.warn("ArcGISImageService","Imagery layer doesn't support given renderer type."),n}},write:{target:"layerDefinition.drawingInfo.renderer"}}},rasterAttributeTable:null,rasterAttributeTableFieldPrefix:"Raster.",rasterFields:{value:null,dependsOn:["fields","rasterAttributeTable","rasterAttributeTableFieldPrefix"],get:function(){var e=this.rasterAttributeTableFieldPrefix,t={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"string"},r={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"string"},i=this.fields?b.clone(this.fields):[],n=i.length;if(i[n]=r,(this.capabilities&&this.capabilities.indexOf("Catalog")>-1||this.fields&&this.fields.length>0)&&(i[n+1]=t),null!=this.pixelFilter&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var a={name:"Raster.Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"double"},s={name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"double"};i[n+2]=a,i[n+3]=s}var l=this.rasterAttributeTable&&this.rasterAttributeTable.fields||null;if(l&&l.length>0){var o=l.filter(function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),u=o.map(function(t){var r=b.clone(t);return r.name=e+t.name,r});i=i.concat(u)}return i}},renderingRule:{value:null,type:a,json:{origins:{service:{read:{source:["rasterFunctionInfos"],reader:function(e,t){var r=t.rasterFunctionInfos;return t.renderingRule||r&&r.length&&"None"!==r[0].name?a.fromJSON(t.renderingRule||{rasterFunctionInfos:t.rasterFunctionInfos}):null}}}},write:!0}},serviceDataType:{},spatialReference:{value:null,readOnly:!0,json:{read:{source:["extent"],reader:function(e,t){return(e=t.extent&&t.extent.spatialReference)&&c.fromJSON(e)}}}},url:{},version:{value:null,readOnly:!0,json:{read:{source:["currentVersion","fields","timeInfo"],reader:function(e,t){return e=t.currentVersion,e||(e=t.hasOwnProperty("fields")||t.hasOwnProperty("objectIdField")||t.hasOwnProperty("timeInfo")?10:9.3),e}}}}},applyFilter:function(e){var t=this._clonePixelData(e);return this.pixelFilter&&this.pixelFilter(t),t},fetchImage:function(e,t,r,i){if(i=i||{},null==this._raster||null==e||null==t||null==r)return I.reject(new Error("Insufficient parameters for requesting an image. A valid extent, width and height values are required."));var n=this.getExportImageServiceParameters(e,t,r,i),a={imageServiceParameters:n,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,requestAsImageElement:i.requestAsImageElement&&!this.pixelFilter||!1};return this._raster.read(a)},fetchKeyProperties:function(e){var t=e&&e.renderingRule&&e.renderingRule.toJSON();return g(this.parsedUrl.path+"/keyProperties",{query:{f:"json",renderingRule:t}}).then(function(e){return e.data})},getExportImageServiceParameters:function(e,t,r,i){var e=e.clone().shiftCentralMeridian(),n=e&&e.spatialReference;return n=n&&(n.wkid||JSON.stringify(n.toJSON())),b.mixin({bbox:e&&e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:n,imageSR:n,size:t+","+r},this.exportImageServiceParameters.toJSON())},fetchRasterAttributeTable:function(e){var t=e&&e.renderingRule;if(this.version>10&&this.hasRasterAttributeTable){var r={f:"json"};return t&&"esri.layers.support.RasterFunction"===t.declaredClass&&this.version>=10.3&&(r.renderingRule=JSON.stringify(t.toJSON())),g(this.parsedUrl.path+"/rasterAttributeTable",{query:r}).then(function(e){return e.data})}return I.reject(new S("#fetchRasterAttributeTable()","Failed to get rasterAttributeTable"))},queryRasters:function(e){return this.queryTask.execute(e)},queryVisibleRasters:function(e,t){this._visibleRasters=[];var r=!1,i=t.popupTemplate||this.popupTemplate;i&&i.fieldInfos&&i.fieldInfos.length>0&&(r=i.fieldInfos.length>1||"raster.servicepixelvalue"!==i.fieldInfos[0].toLowerCase()),i&&!r&&this.rasterFields&&(r=this.rasterFields.some(function(e){var t=e&&e.name?e.name.toLowerCase():null;return t&&"raster.servicepixelvalue"!==t&&(i.title&&i.title.toLowerCase().indexOf(t)>-1||i.content&&i.content.toLowerCase().indexOf(t)>-1)}));var n,a,s,l;if(t.layerView&&t.layerView.view){var o=t.layerView.view;if("2d"===o.type){var c=o.state;n=c.spatialReference.clone(),a=c.resolution}else n=o.spatialReference.clone(),a=o.resolution;a&&(s=new u(.5*a,.5*a,n)),l=n.equals(this.spatialReference)}var p=new m({geometry:e.geometry,returnCatalogItems:r,timeExtent:e.timeExtent,mosaicRule:this.mosaicRule||null,renderingRule:this.renderingRule||null,returnGeometry:l,outSpatialReference:n,pixelSize:s});return new h({url:this.url}).execute(p).then(function(e){return this._processVisibleRastersResponse(e,t)}.bind(this)).catch(function(e){throw new Error("Error querying for visible rasters")})},createPopupTemplate:function(e){return d.createPopupTemplate(this,e)},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_fetchService:function(){return I.resolve().then(function(){return this.resourceInfo||g(this.parsedUrl.path,{query:b.mixin({f:"json"},this.parsedUrl.query),responseType:"json"})}.bind(this)).then(function(e){e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.read(e.data,{origin:"service",url:this.parsedUrl}),this._raster=new r({url:this.url})}.bind(this)).then(function(){if(this.version>10&&this.hasRasterAttributeTable)return g(this.parsedUrl.path+"/rasterAttributeTable",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.features&&t.fields&&this.read({rasterAttributeTable:t},{origin:"service",url:this.parsedUrl})}.bind(this))}.bind(this)).then(function(){if(this.version>=10.3&&this._isScientificData()&&this.hasMultidimensions)return g(this.parsedUrl.path+"/multiDimensionalInfo",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.multidimensionalInfo&&(this._updateMultidimensionalDefinition(t.multidimensionalInfo),this.multidimensionalInfo=t.multidimensionalInfo)}.bind(this))}.bind(this))},_updateMultidimensionalDefinition:function(e){var t,r=e.variables[0].dimensions,i=[];for(t in r)if(r.hasOwnProperty(t)){var a=r[t],l=!0,o=a.extent,u=[o[0]];a.hasRanges&&!0===a.hasRanges?(l=!1,u=[a.values[0]]):"stdz"===a.name.toLowerCase()&&Math.abs(o[1])<=Math.abs(o[0])&&(u=[o[1]]),i.push(new s({variableName:"",dimensionName:r[t].name,isSlice:l,values:u}))}if(i.length>0){this.mosaicRule=this.mosaicRule||new n;var c=this.mosaicRule.multidimensionalDefinition;(!c||c&&c.length<=0)&&(this.mosaicRule.multidimensionalDefinition=i)}},_clonePixelData:function(e){if(null===e||void 0===e)return e;var t={};e.extent&&(t.extent=e.extent.clone());var r=e.pixelBlock;return null===r||void 0===r?t:(t.pixelBlock=r.clone(),t)},_processVisibleRastersResponse:function(e,t){var r,i,n,a,s=e.value,l=0,u=this.objectIdField,c=e.catalogItems&&e.catalogItems.features&&e.catalogItems.features.length||0;if(c){var p,d,f=0,h=0;for(i=[c],r=[c],a=[c],l=0;l<c;l++)e.properties.Values[l].toLowerCase().indexOf("nodata")>-1&&h++;for(p=c-h,l=0;l<c;l++)d=e.properties.Values[l].toLowerCase().indexOf("nodata")>-1?p++:f++,i[d]=e.catalogItems.features[l],r[d]=e.properties.Values[l],a[d]=i[d].attributes[u]}this._visibleRasters=[];var m,g=s.toLowerCase().indexOf("nodata")>-1;if(s&&!i&&!g){u="ObjectId",i=[];var v={};v.ObjectId=0,m=new y(new o(this.fullExtent),null,v),m.sourceLayer=this,i.push(m)}var b=[];if(!i)return b;var x,R,I=t&&t.returnDomainValues||!1;for(l=0,n=i.length;l<n;l++)m=i[l],m.sourceLayer=this,s&&(x=s,r&&r.length>=l&&(R=r[l],x=R.replace(/ /gi,", ")),m.attributes["Raster.ItemPixelValue"]=x,m.attributes["Raster.ServicePixelValue"]=s,this._updateFeatureWithMagDirValues(m,x),this._updateFeatureWithRasterAttributeTableValues(m,x)),I&&this._updateFeatureWithDomainValues(m),b.push(m);return b},_updateFeatureWithRasterAttributeTableValues:function(e,t){var r=this.rasterAttributeTable&&this.rasterAttributeTable.features;if(r&&!(r.length<1)&&this.rasterAttributeTableFieldPrefix){var i=null;if(r.forEach(function(e){e&&e.attributes&&(e.attributes.Value!=t&&e.attributes.VALUE!=t||(i=e))}),i){var n,a,s={};for(n in i.attributes)i.attributes.hasOwnProperty(n)&&(a=this.rasterAttributeTableFieldPrefix+n,s[a]=i.attributes[n]);e.attributes=b.mixin(e.attributes,s)}}},_updateFeatureWithMagDirValues:function(e,t){if(this.pixelFilter&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var r=t.replace(" ","").split(","),n=new i({height:1,width:1,pixelType:"f32",pixels:[],statistics:[]});r.forEach(function(e){n.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:n,extent:new o(0,0,0,0,this.spatialReference)}),e.attributes["Raster.Magnitude"]=n.pixels[0][0],e.attributes["Raster.Direction"]=n.pixels[1][0]}},_updateFeatureWithDomainValues:function(e){var t=this.domainFields;null!=t&&t.forEach(function(t){if(t){var r=e.attributes[t.name];if(null!=r){var i=this._findMatchingDomainValue(t.domain,r);null!=i&&(e.attributes[t.name]=i)}}},this)},_findMatchingDomainValue:function(e,t){var r=e&&e.codedValues;if(r){var i;return r.some(function(e){return e.code===t&&(i=e.name,!0)}),i}}})});