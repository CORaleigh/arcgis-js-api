// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","@dojo/framework/shim/Set","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","./attributeSupport","./spatialQuerySupport","./timeSupport","../../../tasks/support/Query"],function(t,e,i,r,o,s,n,a,l,u,p,h,d,c,y,f){Object.defineProperty(e,"__esModule",{value:!0});var _=a.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter"),m=1,v=2,b=function(){function t(t){var e=this;this._geometryBounds=p.create(),this._idToVisibility=new Map,this.check=function(t){var i=t.objectId,r=e._idToVisibility,o=e._applyFilter(t);return r.set(i,o?m|v:v),!!(r.get(i)&m)},this._serviceInfo=t}return t.prototype.clear=function(){var t=this._resetAllHiddenIds();return this.update(),{show:t,hide:[]}},t.prototype.invalidate=function(){var t=this;this._idToVisibility.forEach(function(e,i){t._idToVisibility.set(i,0)})},t.prototype.setKnownIds=function(t){for(var e=0,i=t;e<i.length;e++){var r=i[e];this._idToVisibility.set(r,m)}},t.prototype.setTrue=function(t){var e=this,i=[],r=[],o=new s.default(t);return this._idToVisibility.forEach(function(t,s){var n=!!(e._idToVisibility.get(s)&m),a=o.has(s);!n&&a?i.push(s):n&&!a&&r.push(s),e._idToVisibility.set(s,a?m|v:0)}),{show:i,hide:r}},t.prototype.createQuery=function(){var t=this,e=t.geometry,i=t.spatialRel,r=t.where,o=t.distance,s=t.units,n=t.timeExtent,a=t.objectIds;return f.fromJSON({geometry:e,spatialRel:i,where:r,distance:o,units:s,timeExtent:n,objectIds:a})},t.prototype.update=function(t){return void 0===t&&(t=null),i(this,void 0,void 0,function(){return o(this,function(e){switch(e.label){case 0:return[4,u.all([this._setGeometryFilter(t),this._setIdFilter(t),this._setAttributeFilter(t),this._setTimeFilter(t)])];case 1:return e.sent(),[2]}})})},t.prototype._setAttributeFilter=function(t){if(!t||!t.where)return this._clause=null,void(this.where=null);var e=d.getWhereClause(t.where);if(e.isStandardized())this._clause=e;else{var i=new n("mapview - bad input","Unable to apply filter's definition expression, as expression is not standardized.",e);_.error(i)}this.where=t.where},t.prototype._setIdFilter=function(t){this._idsToShow=t&&t.objectIds&&new s.default(t.objectIds),this._idsToHide=t&&t.hiddenIds&&new s.default(t.hiddenIds),this.objectIds=t&&t.objectIds},t.prototype._setGeometryFilter=function(t){return i(this,void 0,void 0,function(){var e,i,r;return o(this,function(o){switch(o.label){case 0:return t&&t.geometry?(e=t.geometry,i=t.spatialRel||"esriSpatialRelIntersects",[4,c.getSpatialQueryOperator(i,e,this._serviceInfo)]):(this._spatialQueryOperator=null,this.geometry=null,this.spatialRel=null,[2]);case 1:return r=o.sent(),h.getBoundsXY(this._geometryBounds,e),this._spatialQueryOperator=r,this.geometry=e,this.spatialRel=i,[2]}})})},t.prototype._setTimeFilter=function(t){if(this.timeExtent=this._timeOperator=null,t&&t.timeExtent){if(!this._serviceInfo.timeInfo){var e=new n("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",t.timeExtent);return void _.error(e)}this.timeExtent=t.timeExtent,this._timeOperator=y.getTimeOperator(this._serviceInfo.timeInfo,t.timeExtent)}},t.prototype._applyFilter=function(t){return this._filterByGeometry(t)&&this._filterById(t)&&this._filterByTime(t)&&this._filterByExpression(t)},t.prototype._filterByExpression=function(t){return!this.where||this._clause.testFeature(t.attributes)},t.prototype._filterById=function(t){return(!this._idsToHide||!this._idsToHide.has(t.objectId))&&(!this._idsToShow||this._idsToShow.has(t.objectId))},t.prototype._filterByGeometry=function(t){return!this.geometry||!!this._earlyGeometryReject(t)&&this._spatialQueryOperator(t.geometry)},t.prototype._filterByTime=function(t){return!l.isSome(this._timeOperator)||this._timeOperator(t)},t.prototype._earlyGeometryReject=function(t){return!(!t.geometry||!t.geometry.coords.length)&&(!t.centroid||"esriSpatialRelContains"!==this.spatialRel||p.containsPoint(this._geometryBounds,t.centroid.coords))},t.prototype._resetAllHiddenIds=function(){var t=this,e=[];return this._idToVisibility.forEach(function(i,r){i&m||(t._idToVisibility.set(r,m),e.push(r))}),e},t}();e.default=b});