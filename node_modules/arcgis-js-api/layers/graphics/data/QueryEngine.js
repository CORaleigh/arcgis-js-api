// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","@dojo/framework/shim/array","@dojo/framework/shim/Map","@dojo/framework/shim/Set","../../../core/asyncUtils","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/MemCache","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/PromiseQueue"],function(e,t,r,n,i,u,o,s,a,c,h,f,l,p,d,y,m,_,g,x,v,S,Q,b,E){function I(e,t,r,n,i,u,o,s,a){a||(a=R),o&&!u?n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=b.getCentroid(r,n,s),u=n.attributes;i&&(t.add(n.objectId),e.push(new w(u,null,i,a(n))))}}):u&&!o?n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=n.attributes,u=b.getGeometry(r,n,0,s);u&&(t.add(n.objectId),e.push(new w(i,u,null,a(n))))}}):n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=n.attributes,u=b.getGeometry(r,n,0,s),o=b.getCentroid(r,n,s);u&&o&&(t.add(n.objectId),e.push(new w(i,u,o,a(n))))}})}Object.defineProperty(t,"__esModule",{value:!0});var R=function(e){return 1},F=c.getLogger("esri.layers.graphics.data.QueryEngine"),w=function(){function e(e,t,r,n){this.attributes=e,this.geometry=t,this.centroid=r,this.filterFlags=n}return e}(),T=new u.default,j=new h.Storage(2e6),C=0,M=function(){function e(e){var t=this;this.capabilities={query:x.queryCapabilities},this.fieldsMap=new i.default,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.featureStore=e.featureStore,this.featureStore.setEngine(this),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new h(C+++"$$",j)),e.fields.forEach(function(e){t.fieldsMap.set(e.name.trim(),e),t.fieldsMap.set(e.name.trim().toLowerCase(),e)}),e.scheduler&&e.priority&&(this._frameQueue=new E.PromiseQueue,this._frameTask=e.scheduler.registerTask(e.priority,function(e){return t._update(e)},function(){return t._frameQueue.length>0}))}return e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this.fieldsMap.clear()},Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:b.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:(this._timeExtent=Q.getTimeExtent(this.timeInfo,this.featureStore),this._timeExtent):null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},e.prototype.executeQuery=function(e){var t=this;void 0===e&&(e={});var r=a.clone(e);return o.safeCast(b.normalizeQuery(r,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(r)}).catch(function(e){if(e===b.QUERY_ENGINE_EMPTY_RESULT)return new v.default([],null,t);throw e}).then(function(e){return e.createQueryResponse(r)})},e.prototype.executeQueryForCount=function(e){var t=this;void 0===e&&(e={});var r=a.clone(e);return r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null,o.safeCast(b.normalizeQuery(r,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return e.size}).catch(function(e){if(e===b.QUERY_ENGINE_EMPTY_RESULT)return 0;throw e})},e.prototype.executeQueryForExtent=function(e){var t=this;void 0===e&&(e={});var r=a.clone(e),n=r.outSR;return o.safeCast(b.normalizeQuery(r,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(){return r.returnGeometry=!0,r.returnCentroid=!1,r.outSR=null,r}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){var r=e.size;if(!r)return{count:r,extent:null};var i={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:b.cleanFromGeometryEngine(t.spatialReference)};t.featureStore.forEachBounds(e.items,function(e){i.xmin=Math.min(e[0],i.xmin),i.ymin=Math.min(e[1],i.ymin),i.xmax=Math.max(e[2],i.xmax),i.ymax=Math.max(e[3],i.ymax)});var u=g.project(i,e.spatialReference,n);if(u.spatialReference=b.cleanFromGeometryEngine(n||t.spatialReference),u.xmax-u.xmin==0){var o=l.getMetersPerUnitForSR(u.spatialReference);u.xmin-=o,u.xmax+=o}if(u.ymax-u.ymin==0){var o=l.getMetersPerUnitForSR(u.spatialReference);u.ymin-=o,u.ymax+=o}return{count:r,extent:u}}).catch(function(e){if(e===b.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw e})},e.prototype.executeQueryForIds=function(e){return void 0===e&&(e={}),this.executeQueryForIdSet(e).then(function(e){return n.from(e)})},e.prototype.executeQueryForIdSet=function(e){var t=this;void 0===e&&(e={});var r=a.clone(e);return r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null,o.safeCast(b.normalizeQuery(r,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return t._reschedule(e)}).then(function(e){for(var t=e.items,r=new u.default,n=0,i=t;n<i.length;n++){var o=i[n];r.add(o.objectId)}return r}).catch(function(e){if(e===b.QUERY_ENGINE_EMPTY_RESULT)return new u.default;throw e})},e.prototype.executeTileQuery=function(e,t,r){var n=this;void 0===r&&(r=null);var i=t.returnGeometry,o=t.returnCentroid,s=t.pixelBuffer,a=new u.default,c=[],h=s*e.resolution,f=p.pad(e.bounds,h,p.create());if(I(c,a,this,this.featureStore,f,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r),"esriGeometryPoint"===this.geometryType||o){var l=m.getInfo(this.spatialReference);if(l){var d=l.valid,y=d[0],_=d[1];if(f[0]<y){var g=p.fromValues(_-h,f[1],_,f[3]);I(c,a,this,this.featureStore,g,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[_,e.bounds[3]]},r)}if(f[2]>_){var x=p.fromValues(y,f[1],y+h,f[3]);I(c,a,this,this.featureStore,x,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[y-_+e.bounds[0],e.bounds[3]]},r)}}}return c.sort(function(e,t){return e.attributes[n.objectIdField]-t.attributes[n.objectIdField]}),{features:c,objectIds:a}},e.prototype.executeTileQueryForIds=function(e,t){var r=t.pixelBuffer,n=r*e.resolution,i=p.pad(e.bounds,n,p.create()),u=[];return this.featureStore.forEachInBounds(i,function(e){return u.push(e.objectId)}),u},e.prototype.executeQueryForLatestObservations=function(e){var t=this;return this.timeInfo?this.executeQuery(e).then(function(e){return t._filterLatest(e,t.timeInfo)}):void F.error(new s("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._schedule=function(e){return this._frameQueue?this._frameQueue.push(e).then(function(e){return e}):f.resolve(e)},e.prototype._reschedule=function(e){return this._frameQueue?this._frameQueue.push(e).then(function(e){return e}):f.resolve(e)},e.prototype._update=function(e){for(this._budget=e;!e.done&&this._frameQueue.process();)e.madeProgress();this._budget=null},e.prototype._filterLatest=function(e,t){for(var n=t.trackIdField,u=t.startTimeField,o=t.endTimeField,s=o||u,a=new i.default,c=[],h=0,f=e.features;h<f.length;h++){var l=f[h],p=l.attributes[n],d=l.attributes[s];(!a.has(p)||a.get(p).attributes[s]<d)&&a.set(p,l)}return a.forEach(function(e){return c.push(e)}),r({},e,{features:c})},e.prototype._getAll=function(){if(!this._allItems){var e=[];this.featureStore.forEach(function(t){return e.push(t)}),this._allItems=new v.default(e,null,this)}return this._allItems},e.prototype._executeGeometryQuery=function(e){var t=this,r=e.geometry,n=e.outSR,i=e.spatialRel,o=m.isValid(n)&&!m.equals(this.spatialReference,n),s=this.cacheSpatialQueries?o?JSON.stringify({geometry:r,spatialRelationship:i,outSpatialReference:n}):JSON.stringify({geometry:r,spatialRelationship:i}):null;if(s){var a=this._geometryQueryCache.get(s);if(void 0!==a)return f.resolve(a)}var c=function(r){return o&&(e.returnGeometry||e.returnCentroid)?r.project(n).then(function(e){return s&&t._geometryQueryCache.put(s,e,e.size||1),e}):(s&&t._geometryQueryCache.put(s,r,r.size||1),r)};if(!r)return f.resolve(this._getAll()).then(function(e){return c(e)});if("esriSpatialRelDisjoint"===i){var h=this._searchFeatures(this._getQueryBBoxes(r));if(!h.length)return f.resolve(this._getAll()).then(function(e){return c(e)});var l,p;return this._reschedule(h).then(function(e){return new u.default(e)}).then(function(e){return t._reschedule(e)}).then(function(e){var r=0;l=new Array(e.size),t.featureStore.forEach(function(e){return l[r++]=e}),p=e}).then(function(){return t._reschedule()}).then(function(){return S.getSpatialQueryOperator(i,r,t)}).then(function(e){var n=function(t){return!p.has(t)||e(t.geometry)};return t._runSpatialFilter(l,n).then(function(e){return new v.default(e,r,t)}).then(function(e){return c(e)})})}var d=this._searchFeatures(this._getQueryBBoxes(r));if(!d.length){var y=new v.default([],r,this);return s&&this._geometryQueryCache.put(s,y,y.size||1),f.resolve(y)}return this._canExecuteSoloPass(r,e)?f.resolve(new v.default(d,r,this)).then(function(e){return c(e)}):S.getSpatialQueryOperator(i,r,this).then(function(e){return t._runSpatialFilter(d,function(t){return e(t.geometry)})}).then(function(e){return new v.default(e,r,t)}).then(function(e){return c(e)})},e.prototype._runSpatialFilter=function(e,t){var r=this;if(!t)return f.resolve(e);if(!this._budget)return f.resolve(e.filter(function(e){return t(e)}));var n=0,i=new Array,u=function(){for(;n<e.length;){var o=e[n];if(t(o)&&i.push(o),r._budget.done)return r._reschedule().then(function(){return u()});++n}return f.resolve()};return this._reschedule().then(function(){return u()}).then(function(){return i})},e.prototype._canExecuteSoloPass=function(e,t){var r=this.geometryType,n=t.spatialRel;return S.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===n||"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===n||"esriSpatialRelContains"===n||"esriSpatialRelWithin"===n))},e.prototype._getQueryBBoxes=function(e){if(S.canQueryWithRBush(e)){if(y.isExtent(e))return[p.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(y.isPolygon(e))return e.rings.map(function(e){return p.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}return[d.getBoundsXY(p.create(),e)]},e.prototype._searchFeatures=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];this.featureStore.forEachInBounds(n,function(e){T.add(e)})}var i=new Array(T.size),u=0;return T.forEach(function(e){return i[u++]=e}),T.clear(),i},e.prototype._checkQuerySupport=function(e){return e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text?f.reject(new s("feature-store:unsupported-query","Unsupported query options",{query:e})):f.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),S.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),g.checkProjectionSupport(this.spatialReference,e.outSR)]).then(function(){return e})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,n=e.returnDistinctValues;if(r&&r.length>0){var i=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});_.validateFields(this.fieldsMap,i,"orderByFields contains missing fields")}if(t&&t.length>0)_.validateFields(this.fieldsMap,t,"outFields contains missing fields");else if(n)throw new s("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});_.validateWhere(this.fieldsMap,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics,n=e.having,i=r&&r.length,u=t&&t.length;if(n){if(!i||!u)return f.reject(new s("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e}));_.validateHaving(this.fieldsMap,n,t)}if(u){if(t.some(function(e){return"exceedslimit"===e.statisticType}))return;var o=t.map(function(e){return e.onStatisticField});_.validateFields(this.fieldsMap,o,"onStatisticFields contains missing fields"),i&&_.validateFields(this.fieldsMap,r,"groupByFieldsForStatistics contains missing fields");for(var a=0,c=t;a<c.length;a++){var h=c[a],l=h.onStatisticField,p=h.statisticType;if("exceedslimit"===p)return f.reject(new s("feature-store:unsupported-query","statistic type exceedslimit is not supported",{definition:h,query:e}));if((!i||"count"!==p)&&l&&_.hasInvalidFieldType(l,this.fieldsMap))return f.reject(new s("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:h,query:e}))}}},e}();t.default=M});