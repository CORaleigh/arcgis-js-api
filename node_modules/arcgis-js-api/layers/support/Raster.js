// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["../../core/Accessor","../../core/lang","../../core/urlUtils","../../core/promiseUtils","../../request","../../geometry/Extent","../../geometry/SpatialReference","./PixelBlock","./rasterFormats/LercCodec","./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw"],function(e,t,r,a,i,n,o,s,d,l,h,p){return e.createSubclass({declaredClass:"esri.layers.support.Raster",validPixelTypes:["u1","u2","u4","u8","u16","u32","s8","s16","s32","f32"],validFormats:["lerc","jpeg","jpg","jpgpng","png","png8","png24","png32","bip","bsq"],properties:{parsedUrl:{readOnly:!0,dependsOn:["url"],get:function(){return this.url?r.urlToObject(this.url):null}},url:null},read:function(e){if(!e.imageServiceParameters||!e.nBands)return a.reject(new Error("Insufficient parameters to read data"));var r=t.clone(e.imageServiceParameters),i=e.nBands,n=e.pixelType||"f32",o=e.requestAsImageElement;this.validPixelTypes.indexOf(n.toUpperCase())<=-1&&(r.pixelType="f32"),r.format=r.format||"lerc",this.validFormats.indexOf(r.format.toLowerCase())<=-1&&(r.format="lerc"),this._prepareGetImageParameters(r);var s=t.clone(r);return this._cleanupRequestParams(s),this._requestArrayBuffer(r,s,i,n,o)},_requestArrayBuffer:function(e,r,n,o,s){return i(this.parsedUrl.path+"/exportImage",{responseType:"array-buffer",query:t.mixin(r,{f:"image"})}).then(function(t){var r=t.data;if(!this._isDataValid(r)){var i=new Error(String.fromCharCode.apply(null,new Uint8Array(r)));return a.reject(i)}var d=e.format.toUpperCase(),l=d;if("BSQ"!==l&&"BIP"!==l&&(l=this._getFormat(r)),this.validFormats.indexOf(l.toLowerCase())<=-1)return a.reject(new Error("Cannot decode the pixelBlock. Unsupported Format: "+l));if(!("PNG"!==d&&"JPGPNG"!==d||"PNG"!==l&&"JPEG"!==l)&&s){var h="image/"+("PNG"===l?"png":"jpeg"),p=new Blob([r],{type:h}),c=URL.createObjectURL(p),u=new Image,f=a.createResolver(),m=f.promise;return u.addEventListener("load",f),u.addEventListener("error",f.reject),u.src=c,m.then(function(){return URL.revokeObjectURL(c),{imageElement:u,params:e}},function(e){return URL.revokeObjectURL(c),a.reject(new Error("Failed to load raster"))})}try{return{pixelData:{pixelBlock:this._decodePixelBlock(r,{width:e.width,height:e.height,planes:n,pixelType:o,noDataValue:e.noData,format:l}),extent:e.extent},params:e}}catch(e){return a.reject(e)}}.bind(this))},_prepareGetImageParameters:function(e){if(e.size&&e.bbox){var r=e.size.split(",");if(e.width=parseFloat(r[0]),e.height=parseFloat(r[1]),!e.extent){var a=e.bbox.split(",");e.extent=new n(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),new o(e.bboxSR))}}else{if(!e.width||Math.floor(e.width)!==e.width||!e.height||Math.floor(e.height)!==e.height)throw new Error("Incorrect Image Dimensions");if(!e.extent||"esri.geometry.Extent"!==e.extent.declaredClass)throw new Error("Incorrect extent");var i=e.extent,s=i.spatialReference.wkid||JSON.stringify(i.spatialReference.toJSON());delete e._ts,t.mixin(e,{bbox:i.xmin+","+i.ymin+","+i.xmax+","+i.ymax,imageSR:s,bboxSR:s,size:e.width+","+e.height},e.disableClientCaching?{_ts:Date.now()}:{})}},_adjustExtent:function(e,t,r){var a=e.ymax-e.ymin,i=e.xmax-e.xmin;return r>=t?(a=i*t/r,e.ymax=e.ymin+a):(i=a*r/t,e.xmax=e.xmin+i),e},_cleanupRequestParams:function(e){if(!e)return e;var t,r=["width","height","extent"];for(t in r)e.hasOwnProperty(r[t])&&delete e[r[t]];return e},_getFormat:function(e){var t=new Uint8Array(e,0,10),r="";return 255===t[0]&&216===t[1]?r="JPEG":137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?r="PNG":67===t[0]&&110===t[1]&&116===t[2]&&90===t[3]&&73===t[4]&&109===t[5]&&97===t[6]&&103===t[7]&&101===t[8]&&32===t[9]?r="LERC":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(r="ERROR"),r},_isDataValid:function(e){var t=new Uint8Array(e,0,10);return!(String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1)},_calculateBandStatistics:function(e){var t,r=1/0,a=-1/0,i=e.length,n=0;for(t=0;t<i;t++)n=e[t],r=n<r?n:r,a=n>a?n:a;return{minValue:r,maxValue:a}},_verifyResult:function(e,t){return!(!e||e.height!==t.height||e.width!==t.width)},_getPixelTypeAndNoData:function(e){var t,r=e.noDataValue,a=e.pixelType;return"u1"===a||"u2"===a||"u4"===a||"u8"===a?(a="u8",r=Math.pow(2,8)-1,t=Uint8Array):"u16"===a?(r=r||Math.pow(2,16)-1,t=Uint16Array):"u32"===a?(r=r||Math.pow(2,32)-1,t=Uint32Array):"s8"===a?(r=r||0-Math.pow(2,7),t=Int8Array):"s16"===a?(r=r||0-Math.pow(2,15),t=Int16Array):"s32"===a?(r=r||0-Math.pow(2,31),t=Int32Array):t=Float32Array,{pixelType:a,pixelDataType:t,noDataValue:r}},_decodePixelBlock:function(e,t){if(!e||!t)throw new Error("Cannot decode the pixelBlock. Invalid parameters provided for decoding.");if(!t.height||Math.floor(t.height)!==t.height)throw new Error("Cannot decode the pixelBlock. Height is not provided.");if(!t.width||Math.floor(t.width)!==t.width)throw new Error("Cannot decode the pixelBlock. Width is not provided.");var r=this._decodeLerc;switch(t.format.toUpperCase()){case"JPEG":r=this._decodeJpeg;break;case"PNG":r=this._decodePng;break;case"BSQ":r=this._decodeBsq;break;case"BIP":r=this._decodeBip}r=r.bind(this);var a,i,n=r(e,t),o=n.statistics||[];if(o.length<=0)for(a=0;a<n.pixels.length;a++)i=n.pixels[a],o.push(this._calculateBandStatistics(i));return new s({width:t.width,height:t.height,pixels:n.pixels,pixelType:t.pixelType,mask:n.mask,statistics:o})},_decodeJpeg:function(e,t){if(!l)throw new Error("The jpeg decoder module is not loaded.");var r=new l,a=r.decode(e);if(!this._verifyResult(a,t))throw new Error("Error in decoding the image. The decoded image dimensions are incorrect.");return t.width=a.width,t.height=a.height,t.pixelType="U8",a},_decodePng:function(e,t){if(!h)throw new Error("The png decoder module is not loaded.");var r=new Uint8Array(e),a=new h(r),i=new Uint8Array(t.width*t.height*4);a.copyToImageData(i,a.decodePixels());var n,o=0,s=0,d=new Uint8Array(t.width*t.height);for(o=0;o<t.width*t.height;o++)d[o]=i[4*o+3];var l={pixels:[],mask:d};for(o=0;o<3;o++){for(n=new Uint8Array(t.width*t.height),s=0;s<t.width*t.height;s++)n[s]=i[4*s+o];l.pixels.push(n)}return t.pixelType="U8",l},_decodeBsq:function(e,t){if(!p)throw new Error("The bsq decoder module is not loaded.");var r=this._getPixelTypeAndNoData(t);return p.decodeBSQ(e,{bandCount:t.planes,width:t.width,height:t.height,pixelType:r.pixelDataType,noDataValue:r.noDataValue})},_decodeBip:function(e,t){if(!p)throw new Error("The bsq decoder module is not loaded.");var r=this._getPixelTypeAndNoData(t);return p.decodeBIP(e,{bandCount:t.planes,width:t.width,height:t.height,pixelType:r.pixelDataType,noDataValue:r.noDataValue})},_decodeLerc:function(e,t){var r=this._getPixelTypeAndNoData(t);t.pixelType=r.pixelType;for(var a,i=0,n=0,o=e.byteLength-10,s={pixels:[],statistics:[]};n<o;){var l=d.decode(e,{inputOffset:n,encodedMaskData:a,returnMask:0===i,returnEncodedMask:0===i,returnFileInfo:!0,pixelType:r.pixelDataType,noDataValue:r.noDataValue});if(n=l.fileInfo.eofOffset,0===i&&(a=l.encodedMaskData,s.mask=l.maskData),i++,!this._verifyResult(l,t))throw new Error("Error in decoding the image. The decoded image dimensions are incorrect.");s.pixels.push(l.pixelData),s.statistics.push({minValue:l.minValue,maxValue:l.maxValue,noDataValue:l.noDataValue})}return s}})});