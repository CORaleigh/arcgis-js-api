// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../tsSupport/assignHelper","dojo/_base/kernel","../../config","../has","../Logger","../promiseUtils","./loaderConfig","./utils","./WorkerFallback"],function(e,r,a,t,o,n,s,i,d,f,g){function l(){if(!n("esri-workers"))return c(new g);var e;if(p)try{e=new Worker(p)}catch(r){v.warn(N,event),e=new g}else v.warn(N,event),e=new g;return c(e)}function c(e){return i.create(function(r){function a(o){var n=f.receiveMessage(o);if(n)switch(n.type){case E:u(e);break;case m:e.removeEventListener("message",a),e.removeEventListener("error",t),r(e)}}function t(r){r.preventDefault(),e.removeEventListener("message",a),e.removeEventListener("error",t),v.warn("Failed to create Worker. Fallback to execute module in main thread",r),e=new g,e.addEventListener("message",a),e.addEventListener("error",t)}e.addEventListener("message",a),e.addEventListener("error",t)})}function u(e){var r,s=o.workers.loaderUrl||d.DEFAULT_LOADER_URL;if(null!=o.default){var i=a({},o);delete i.default,r=JSON.parse(JSON.stringify(i))}else r=JSON.parse(JSON.stringify(o));var f=o.workers.loaderConfig,g=d.default({baseUrl:f.baseUrl,locale:t.locale,has:a({"config-deferredInstrumentation":0,"dojo-test-sniff":0,"esri-secure-context":n("esri-secure-context"),"esri-workers-arraybuffer-transfer":n("esri-workers-arraybuffer-transfer"),"events-keypress-typed":0,"host-webworker":1},f.has),map:a({},f.map),paths:a({},f.paths),packages:f.packages||[]});e.postMessage({type:b,configure:{esriConfig:r,loaderUrl:s,loaderConfig:g}})}Object.defineProperty(r,"__esModule",{value:!0});var v=s.getLogger("esri.core.workers");n.add("esri-workers-arraybuffer-transfer",!n("safari")||n("safari")>=12);var p,m=f.MessageType.CONFIGURED,b=f.MessageType.CONFIGURE,E=f.MessageType.HANDSHAKE;try{p=URL.createObjectURL(new Blob(['var globalId=0;var outgoing=new Map;var configured=false;var HANDSHAKE=0;var CONFIGURE=1;var CONFIGURED=2;var OPEN=3;var OPENED=4;var RESPONSE=5;var INVOKE=6;var CANCEL=7;function mapDelete(map,key){map["delete"](key)}function receiveMessage(event){if(!event||!event.data){return null}if(typeof event.data==="string"){return JSON.parse(event.data)}return event.data}function invokeStaticMessage(methodName,data,options){var signal=options&&options.signal;var Deferred=require("dojo/Deferred");var jobId=globalId++;var abortHandler=function(){if(!outgoing.has(jobId)){return}self.postMessage({type:CANCEL,methodName:methodName,jobId:jobId});mapDelete(outgoing,jobId);if(!deferred.isCanceled()){deferred.cancel()}if(signal){signal.removeEventListener("abort",abortHandler)}};if(signal){signal.addEventListener("abort",abortHandler)}var deferred=new Deferred(abortHandler);outgoing.set(jobId,deferred);self.postMessage({type:INVOKE,methodName:methodName,jobId:jobId,data:data});return deferred.promise}function messageHandler(event){var message=receiveMessage(event);if(!message){return}var jobId=message.jobId;switch(message.type){case CONFIGURE:var configuration=message.configure;if(configured){return}self.dojoConfig=configuration.loaderConfig;self.importScripts(configuration.loaderUrl);if(typeof require.config==="function"){require.config(configuration.loaderConfig)}require(["esri/config"],function(esriConfig){for(var name in configuration.esriConfig){if(Object.prototype.hasOwnProperty.call(configuration.esriConfig,name)){esriConfig[name]=configuration.esriConfig[name]}}self.postMessage({type:CONFIGURED})});break;case OPEN:var modulePath=message.modulePath;require(["esri/core/workers/RemoteClient",modulePath],function(RemoteClient,Module){var port=RemoteClient.connect(Module);self.postMessage({type:OPENED,jobId:jobId,data:port},[port])});break;case RESPONSE:if(outgoing.has(jobId)){var deferred=outgoing.get(jobId);mapDelete(outgoing,jobId);if(message.error){deferred.reject(JSON.parse(message.error))}else{deferred.resolve(message.data)}}break}}self.addEventListener("message",messageHandler);self.postMessage({type:HANDSHAKE});'],{type:"text/javascript"}))}catch(e){}var N="Failed to create Worker. Fallback to execute module in main thread";r.createWorker=l});