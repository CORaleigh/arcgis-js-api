// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","./tsSupport/assignHelper","dojo/io-query","dojo/_base/url","../config","../kernel","./Error","./global","./lang","./Logger"],function(r,e,t,n,a,i,o,u,l,s,f){function c(r){var t={path:null,query:null},a=new e.Url(r),i=r.indexOf("?");return null===a.query?t.path=r:(t.path=r.substring(0,i),t.query=n.queryToObject(a.query)),a.fragment&&(t.hash=a.fragment,null===a.query&&(t.path=t.path.substring(0,t.path.length-(a.fragment.length+1)))),t}function p(r){void 0===r&&(r=!1);var e,t=gr.proxyUrl;if("string"==typeof r){e=z(r);var n=g(r);n&&(t=n.proxyUrl)}else e=!!r;if(!t)throw yr.warn(mr),new u("urlutils:proxy-not-set",mr);return e&&M()&&(t=F(t)),c(t)}function h(r){var e,a,i=g(r);if(i){var o=v(i.proxyUrl);e=o.path,a=o.query?n.queryToObject(o.query):null}if(e){var u=c(r);r=e+"?"+u.path;var l=n.objectToQuery(t({},a,u.query));l&&(r=r+"?"+l)}return r}function v(r){var e=r.indexOf("?");return-1!==e?(qr.path=r.slice(0,e),qr.query=r.slice(e+1)):(qr.path=r,qr.query=null),qr}function d(r){return r=v(r).path,r=X(r),r=N(r,!0),r=r.toLowerCase()}function y(r){for(var e={proxyUrl:r.proxyUrl,urlPrefix:d(r.urlPrefix)},t=gr.proxyRules,n=e.urlPrefix,a=t.length,i=0;i<t.length;i++){var o=t[i].urlPrefix;if(0===n.indexOf(o)){if(n.length===o.length)return-1;a=i;break}0===o.indexOf(n)&&(a=i+1)}return t.splice(a,0,e),a}function g(r){for(var e=gr.proxyRules,t=d(r),n=0;n<e.length;n++)if(0===t.indexOf(e[n].urlPrefix))return e[n]}function m(r,e){return r=U(r),e=U(e),N(r)===N(e)}function U(r){r=R(r);var e=r.indexOf("/sharing");return e>0?r.substring(0,e):r.replace(/\/+$/,"")}function x(r){var e=function(e){return null==e||e instanceof RegExp&&e.test(r)||"string"==typeof e&&s.startsWith(r,e)},t=gr.interceptors;if(t)for(var n=0,a=t;n<a.length;n++){var i=a[n];if(Array.isArray(i.urls)){var o=i.urls.some(e);if(o)return i}else if(e(i.urls))return i}return null}function b(r,e,t){void 0===t&&(t=!1);var n=nr(r),a=nr(e);return!(!t&&n.scheme!==a.scheme)&&(n.host.toLowerCase()===a.host.toLowerCase()&&n.port===a.port)}function O(r){if("string"==typeof r){if(!L(r))return!0;r=nr(r)}for(var e=gr.trustedServers||[],t=0;t<e.length;t++)for(var n=e[t],a=w(n),i=0;i<a.length;i++)if(b(r,a[i]))return!0;return!1}function w(r){return e.trustedServersUrlCache[r]||(K(r)||D(r)?e.trustedServersUrlCache[r]=[new e.Url(P(r))]:e.trustedServersUrlCache[r]=[new e.Url("http://"+r),new e.Url("https://"+r)]),e.trustedServersUrlCache[r]}function P(r,t,n){return void 0===t&&(t=e.appBaseUrl),D(r)?n&&n.preserveProtocolRelative?r:"http"===e.appUrl.scheme&&e.appUrl.authority===C(r).slice(2)?"http:"+r:"https:"+r:K(r)?r:T("/"===r[0]?G(t):t,r)}function q(r,t,n){if(void 0===t&&(t=e.appBaseUrl),!L(r))return r;var a=R(r),i=a.toLowerCase(),o=R(t).toLowerCase().replace(/\/+$/,""),u=n?R(n).toLowerCase().replace(/\/+$/,""):null;if(u&&0!==o.indexOf(u))return r;for(var l=function(r,e,t){return t=r.indexOf(e,t),-1===t?r.length:t},s=l(i,"/",i.indexOf("//")+2),f=-1;i.slice(0,s+1)===o.slice(0,s)+"/"&&(f=s+1,s!==i.length);)s=l(i,"/",s+1);if(-1===f)return r;if(u&&f<u.length)return r;r=a.slice(f);var c=o.slice(f-1).replace(/[^\/]+/g,"").length;if(c>0)for(var p=0;p<c;p++)r="../"+r;else r="./"+r;return r}function R(r){return r=r.trim(),r=P(r),r=Z(r),r=rr(r),r=er(r)}function T(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(r&&r.length){var t=[];if(L(r[0])){var n=r[0],a=n.indexOf("//");t.push(n.slice(0,a+1)),W(r[0])&&(t[0]+="/"),r[0]=n.slice(a+2)}else"/"===r[0][0]&&t.push("");for(var i=r.reduce(function(r,e){return e?r.concat(e.split("/")):r},[]),o=0;o<i.length;o++){var u=i[o];".."===u&&t.length>0&&".."!==t[t.length-1]?t.pop():!u||"."===u&&0!==t.length||t.push(u)}return t.join("/")}}function C(r){if(S(r)||j(r))return null;var e=r.indexOf("://");if(-1===e&&D(r))e=2;else{if(-1===e)return null;e+=3}var t=r.indexOf("/",e);return-1===t?r:r.slice(0,t)}function L(r){return D(r)||K(r)}function S(r){return"blob:"===r.slice(0,5)}function j(r){return"data:"===r.slice(0,5)}function B(r){var e=k(r);if(!e||!e.isBase64)return null;for(var t=atob(e.data),n=new Uint8Array(t.length),a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return n.buffer}function k(r){var e=r.match(Rr);return e?{mediaType:e[1],isBase64:!!e[2],data:e[3]}:null}function $(r){return r.isBase64?"data:"+r.mediaType+";base64,"+r.data:"data:"+r.mediaType+","+r.data}function A(r){var e=B(r);if(!e)return null;var t=k(r);return new Blob([e],{type:t.mediaType})}function Q(r,e){H(r,e)||I(r,e)}function H(r,e){var t=document.createElement("a");if(!("download"in t))return!1;var n=null;if(l.URL&&l.URL.createObjectURL){var a=A(r);if(!a)return!1;n=l.URL.createObjectURL(a)}t.download=e,t.href=n||r,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),n&&l.URL.revokeObjectURL(n)}function I(r,e){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(A(r),e)}function D(r){return r&&"/"===r[0]&&"/"===r[1]}function K(r){return Ur.test(r)}function z(r){return br.test(r)||"https"===e.appUrl.scheme&&D(r)}function E(r){return xr.test(r)||"http"===e.appUrl.scheme&&D(r)}function W(r){return Or.test(r)}function _(r){return D(r)?"http:"+r:r.replace(br,"http:")}function F(r){return D(r)?"https:"+r:r.replace(xr,"https:")}function J(){return"http"===e.appUrl.scheme}function M(){return"https"===e.appUrl.scheme}function N(r,e){return void 0===e&&(e=!1),D(r)?r.slice(2):(r=r.replace(Ur,""),e&&r.length>1&&"/"===r[0]&&"/"===r[1]&&(r=r.slice(2)),r)}function G(r){var e=r.indexOf("//"),t=r.indexOf("/",e+2);return-1===t?r:r.slice(0,t)}function V(r){var e=0;if(L(r)){var t=r.indexOf("//");-1!==t&&(e=t+2)}var n=r.lastIndexOf("/");return n<e?r:r.slice(0,n+1)}function X(r){return r&&"/"===r[r.length-1]?r:r+"/"}function Y(r){return r.replace(/\/+$/,"")}function Z(r){if(/^https?:\/\//i.test(r)){var e=v(r);r=e.path.replace(/\/{2,}/g,"/"),r=r.replace("/","//"),e.query&&(r+="?"+e.query)}return r}function rr(r){return r.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function er(r){var t=gr.httpsDomains;if(!E(r))return r;var n,a=r.indexOf("/",7);if(n=-1===a?r:r.slice(0,a),n=n.toLowerCase().slice(7),wr.test(n)){if(!s.endsWith(n,":80"))return r;n=n.slice(0,-3),r=r.replace(":80","")}return J()&&n===e.appUrl.authority&&!Pr.test(r)?r:((M()&&n===e.appUrl.authority||t&&t.some(function(r){return n===r||s.endsWith(n,"."+r)})||M()&&!g(r))&&(r=F(r)),r)}function tr(r,e,t){if(!(e&&t&&r&&L(r)))return r;var n=r.indexOf("//"),a=r.indexOf("/",n+2),i=r.indexOf(":",n+2),o=Math.min(a<0?r.length:a,i<0?r.length:i);return r.slice(n+2,o).toLowerCase()!==e.toLowerCase()?r:""+r.slice(0,n+2)+t+r.slice(o)}function nr(r){return"string"==typeof r?new e.Url(P(r)):(r.scheme||(r.scheme=e.appUrl.scheme),r)}function ar(r,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?tr(r,e.urlKey+"."+e.customBaseUrl,e.portalHostname):r}function ir(r,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return r;var n=t.urlKey+"."+t.customBaseUrl;return b(e.appUrl,e.appUrl.scheme+"://"+n)?tr(r,t.portalHostname,n):tr(r,n,t.portalHostname)}function or(r,e){var t=e&&e.url&&e.url.path;return r&&t&&(r=P(r,t,{preserveProtocolRelative:!0})),ir(r,e&&e.portal)}function ur(r,e,t){return or(r,t)}function lr(r,e){if(!r)return r;!L(r)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(r);var t=P(r);if(e){var n=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;n&&(t=q(t,n,n))!==r&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(t)}return t=ar(t,e&&e.portal),L(t)&&(t=R(t)),t}function sr(r,e,t,n){var a=lr(r,n);a&&(e[t]=a)}function fr(r){return Tr.test(r)}function cr(r,e){var t=c(r),n=Object.keys(t.query||{});return n.length>0&&e&&e.warn("removeQueryParameters()","Url query parameters are not supported, the following parameters have been removed: "+n.join(", ")+"."),t.path}function pr(r,e,t){var a=c(r),i=a.query||{};return i[e]=t,a.path+"?"+n.objectToQuery(i)}function hr(r,e){var t=c(r),a=t.query||{};for(var i in e)a[i]=e[i];var o=n.objectToQuery(a);return o?t.path+"?"+o:t.path}function vr(r,e){var t=c(r),a=t.path,i=t.query;if(!i)return r;delete i[e];var o=n.objectToQuery(i);return o?a+"?"+o:a}function dr(r){var e=o.id&&o.id.findCredential(r);return e&&e.token?pr(r,"token",e.token):r}Object.defineProperty(e,"__esModule",{value:!0}),e.Url=a;var yr=f.getLogger("esri.core.urlUtils"),gr=i.request,mr="esri/config: esriConfig.request.proxyUrl is not set.",Ur=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,xr=/^\s*http:/i,br=/^\s*https:/i,Or=/^\s*file:/i,wr=/:\d+$/,Pr=/^https?:\/\/[^\/]+\.arcgis.com\/sharing(\/|$)/i;e.appUrl=new e.Url(i.applicationUrl),e.trustedServersUrlCache={},e.appBaseUrl=function(){var r=e.appUrl.path,t=r.substring(0,r.lastIndexOf(r.split("/")[r.split("/").length-1]));return e.appUrl.scheme+"://"+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:"")+t}(),e.urlToObject=c,e.getProxyUrl=p,e.addProxy=h;var qr={path:"",query:""};e.addProxyRule=y,e.getProxyRule=g,e.hasSamePortal=m,e.getInterceptor=x,e.hasSameOrigin=b,e.isTrustedServer=O,e.makeAbsolute=P,e.makeRelative=q,e.normalize=R,e.join=T,e.getOrigin=C,e.isAbsolute=L,e.isBlobProtocol=S,e.isDataProtocol=j,e.dataToArrayBuffer=B;var Rr=/^data:(.*?)(;base64)?,(.*)$/;e.dataComponents=k,e.makeData=$,e.dataToBlob=A,e.downloadDataAsFile=Q,e.isProtocolRelative=D,e.hasProtocol=K,e.toHTTP=_,e.toHTTPS=F,e.isAppHTTPS=M,e.removeFile=V,e.removeTrailingSlash=Y,e.changeDomain=tr,e.fromJSON=or,e.read=ur,e.toJSON=lr,e.write=sr,e.isSVG=fr,e.removeQueryParameters=cr,e.addQueryParameter=pr,e.addQueryParameters=hr,e.removeQueryParameter=vr,e.addTokenParameter=dr;var Tr=/(^data:image\/svg|\.svg$)/i});