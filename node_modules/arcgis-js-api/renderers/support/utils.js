// COPYRIGHT © 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["dojo/date/locale","../../Color","../../core/lang","../../core/numberUtils","../../core/unitUtils","dojo/i18n!dojo/cldr/nls/gregorian"],function(e,t,a,n,o,r){function i(e,t,a){var n="";return 0===t?n=l.lt+" ":t===a&&(n=l.gt+" "),n+e}var s={},l={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"–"},m={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},u={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},c={dateOptions:{formatLength:"short",fullYear:!0},timeOptions:{formatLength:"short"}};return a.mixin(s,{meterIn:{inches:o.convertUnit(1,"meters","inches"),feet:o.convertUnit(1,"meters","feet"),"us-feet":o.convertUnit(1,"meters","us-feet"),yards:o.convertUnit(1,"meters","yards"),miles:o.convertUnit(1,"meters","miles"),"nautical-miles":o.convertUnit(1,"meters","nautical-miles"),millimeters:o.convertUnit(1,"meters","millimeters"),centimeters:o.convertUnit(1,"meters","centimeters"),decimeters:o.convertUnit(1,"meters","decimeters"),meters:o.convertUnit(1,"meters","meters"),kilometers:o.convertUnit(1,"meters","kilometers"),"decimal-degrees":1/o.lengthToDegrees(1,"meters")},timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(t,n){var o,i=[];null==t||t instanceof Date||(t=new Date(t)),n=n||{},n=a.mixin({},n);var s=n.selector?n.selector.toLowerCase():null,l=!s||s.indexOf("time")>-1,m=!s||s.indexOf("date")>-1;return l&&(n.timeOptions=n.timeOptions||c.timeOptions,n.timeOptions&&(n.timeOptions=a.mixin({},n.timeOptions),n.timeOptions.selector=n.timeOptions.selector||"time",i.push(n.timeOptions))),m&&(n.dateOptions=n.dateOptions||c.dateOptions,n.dateOptions&&(n.dateOptions=a.mixin({},n.dateOptions),n.dateOptions.selector=n.dateOptions.selector||"date",i.push(n.dateOptions))),i&&i.length?(i=i.map(function(a){return e.format(t,a)}),o=1==i.length?i[0]:r["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(e,t){return i[t]})):o=e.format(t),o},createColorStops:function(e){var t=e.values,a=e.colors,o=e.labelIndexes,r=e.isDate,l=e.dateFormatOptions;return t.map(function(e,m){var u=!o||o.indexOf(m)>-1,c=null;if(u){var d;d=r?s.formatDate(e,l):n.format(e),d&&(c=i(d,m,t.length-1))}return{value:e,color:a[m],label:c}})},updateColorStops:function(e){var t,a=e.stops,o=e.changes,r=e.isDate,l=e.dateFormatOptions,m=[],u=a.map(function(e){return e.value});o.forEach(function(e){m.push(e.index),u[e.index]=e.value}),t=n.round(u,{indexes:m}),a.forEach(function(e,o){if(e.value=u[o],null!=e.label){var m,c=null;m=r?s.formatDate(t[o],l):n.format(t[o]),m&&(c=i(m,o,a.length-1)),e.label=c}})},createClassBreakLabel:function(e){var t=e.minValue,a=e.maxValue,o=e.isFirstBreak,r=e.normalizationType,i=o?"":l.gt+" ",s="percent-of-total"===r?l.pct:"";return t=null==t?"":n.format(t),a=null==a?"":n.format(a),i+t+s+" "+l.ld+" "+a+s},setLabelsForClassBreaks:function(e){var t=e.classBreakInfos,a=e.classificationMethod,o=e.normalizationType,r=[];t&&t.length&&("standard-deviation"===a?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):e.round?(r.push(t[0].minValue),t.forEach(function(e){r.push(e.maxValue)}),r=n.round(r),t.forEach(function(e,t){e.label=s.createClassBreakLabel({minValue:0===t?r[0]:r[t],maxValue:r[t+1],isFirstBreak:0===t,normalizationType:o})})):t.forEach(function(e,t){e.label=s.createClassBreakLabel({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:o})}))},updateClassBreak:function(e){var t,a=e.classBreaks,n=e.classificationMethod,o=e.normalizationType,r=e.change,i=r.index,l=r.value,m=-1,u=-1,c=a.length;if("standard-deviation"===n)return void console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method.");0===i?m=i:i===c?u=i-1:(u=i-1,m=i),m>-1&&m<c&&(t=a[m],t.minValue=l,t.label=s.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===m,normalizationType:o})),u>-1&&u<c&&(t=a[u],t.maxValue=l,t.label=s.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===u,normalizationType:o}))},calculateDateFormatInterval:function(e){var t,a,n,o,r,i,s,l,u,c,d=e.length,f=1/0;for(e=e.map(function(e){return new Date(e)}),t=0;t<d-1;t++){for(n=e[t],r=[],l=1/0,u="",a=t+1;a<d;a++)o=e[a],i=n.getFullYear()!==o.getFullYear()&&"year"||n.getMonth()!==o.getMonth()&&"month"||n.getDate()!==o.getDate()&&"day"||n.getHours()!==o.getHours()&&"hour"||n.getMinutes()!==o.getMinutes()&&"minute"||n.getSeconds()!==o.getSeconds()&&"second"||"millisecond",s=m[i],s<l&&(l=s,u=i),r.push(i);l<f&&(f=l,c=u)}return c},createUniqueValueLabel:function(e){var t=e.value,a=e.fieldInfo,o=e.domain,r=e.dateFormatInterval,i=String(t),l=o&&o.codedValues?o.getName(t):null;return l?i=l:"number"==typeof t&&(i=a&&"date"===a.type?s.formatDate(t,r&&u[r]):n.format(t)),i}}),s});