// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","dojo/i18n!../../nls/smartMapping","../../../core/lang","../../../core/promiseUtils","./type","./support/utils","../support/utils","../symbology/relationship","../../support/AuthoringInfo","../../../symbols/support/utils"],function(e,r,a,n,l,i,s,o,t,u,d,f){function m(e){if(!(e&&e.layer&&e.view&&e.field1&&e.field2))return i.reject(o.createError("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required"));var r=a({},e);if(r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.classificationMethod=r.classificationMethod||"quantile",r.numClasses=r.numClasses||3,r.focus=r.focus||null,-1===L.indexOf(r.classificationMethod))return i.reject(o.createError("relationship-renderer:invalid-parameters","classification method "+r.classificationMethod+" is not supported"));if(r.numClasses<2||r.numClasses>4)return i.reject(o.createError("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4"));if(e.focus&&-1===E.indexOf(e.focus))return i.reject(o.createError("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null"));var n=[0,2,1,3],l=t.createLayerAdapter(r.layer,n);return r.layer=l,l?l.load().then(function(){var e=l.geometryType,a=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(a&&("polyline"===e||"polygon"===e))return i.reject(o.createError("relationship-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))return i.reject(o.createError("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var n=r.field1,s=r.field2,t=[n.field,s.field];n.normalizationField&&t.push(n.normalizationField),s.normalizationField&&t.push(s.normalizationField);var u=o.verifyBasicFieldValidity(l,t,"relationship-renderer:invalid-parameters");return u?i.reject(u):r}):i.reject(o.createError("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(n).join(", ")))}function c(e){if(!(e&&e.renderer&&e.numClasses))return i.reject(o.createError("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required"));var r=e.field1,a=e.field2,n=e.renderer,l=e.numClasses,s=e.colors,t=Math.pow(l,2);return!r&&!a||r&&a&&r.field&&a.field?r&&!r.classBreakInfos||a&&!a.classBreakInfos?i.reject(o.createError("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required")):n.authoringInfo?n.uniqueValueInfos.length!==t?i.reject(o.createError("update-relationship-renderer:invalid-parameters","Renderer must have "+t+" unique value infos to support "+l+" classes")):s&&s.length!==t?i.reject(o.createError("update-relationship-renderer:invalid-parameters","The scheme must have "+t+" colors")):i.resolve(e):i.reject(o.createError("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required")):i.reject(o.createError("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required"))}function p(e){var r=e.relationshipScheme,a=e.basemap;if(r)r=u.cloneScheme(r);else{var n=u.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=n&&n.primaryScheme,a=n&&n.basemapId}return{scheme:r,basemapId:a}}function v(e,r){var a=l.clone(V[e]);return u.flatten2DArray(a,r)}function y(e,r){return v(e,r).map(function(e){return{value:e,count:0}})}function h(e,r,a,n){var l=e.field,i=e.normalizationField,s=r.field,o=r.normalizationField,t=a.map(function(e){return[e.minValue,e.maxValue]}),u=n.map(function(e){return[e.minValue,e.maxValue]}),d=t.length,f=H[d];return"\n  var field1 = $feature['"+l+"'];\n  var field2 = $feature['"+s+"'];\n  var hasNormField1 = "+(i?"true":"false")+";\n  var hasNormField2 = "+(o?"true":"false")+";\n  var normField1 = "+(i?"$feature['"+i+"']":"null")+";\n  var normField2 = "+(o?"$feature['"+o+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||\n    (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))\n  ) {\n    return null;\n  }\n\n  var value1 = IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 = IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 = "+JSON.stringify(t)+";\n  var breaks2 = "+JSON.stringify(u)+";\n  var classCodes = "+JSON.stringify(f)+";\n\n  function getClassCode(value, breaks) {\n    var code = null;\n\n    for (var i in breaks) {\n      var info = breaks[i];\n      if (value >= info[0] && value <= info[1]) {\n        code = classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 = getClassCode(value1, breaks1);\n  var code2 = getClassCode(value2, breaks2);\n\n  var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}function b(e,r,l){var t=e.basemap,f=e.classificationMethod,m=e.field1,c=e.field2,v=e.focus,b=e.numClasses,g=e.layer,M=r.classBreakInfos,I=l.classBreakInfos;if(b!==M.length||M.length!==I.length)return i.reject(o.createError("relationship-renderer:error","incompatible class breaks"));var F=y(b,v),L=h(e.field1,e.field2,M,I),E=p({basemap:t,geometryType:g.geometryType,theme:"default",relationshipScheme:e.relationshipScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),V=E.scheme;return s.createRenderer({layer:g,basemap:t,valueExpression:L,valueExpressionTitle:n.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:e.defaultSymbolEnabled,typeScheme:a({colors:u.getColors(V,b,v)},V),statistics:{uniqueValueInfos:F},legendOptions:e.legendOptions,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view}).then(function(e){for(var a=e.renderer,i=a.uniqueValueInfos,s=n.relationship,o=0,t=i;o<t.length;o++){var u=t[o];u.label=s[u.value]}var p=new d({type:"relationship",classificationMethod:f,numClasses:b,focus:v,field1:{field:m.field,normalizationField:m.normalizationField,classBreakInfos:M.map(C)},field2:{field:c.field,normalizationField:c.normalizationField,classBreakInfos:I.map(C)}});return a.authoringInfo=p,{renderer:a,classBreaks:{field1:r,field2:l},uniqueValueInfos:e.uniqueValueInfos,relationshipScheme:V,basemapId:e.basemapId}})}function g(e,r,a){var n=v(r,a);e.sort(function(e,r){var a=n.indexOf(e.value),l=n.indexOf(r.value),i=0;return a<l?i=-1:a>l&&(i=1),i})}function M(e,r){var a=e.authoringInfo;a.numClasses=r.numClasses,a.focus=r.focus||null,a.focus||delete a.focus;var n=r.field1,l=r.field2;a.field1={field:n.field,normalizationField:n.normalizationField,classBreakInfos:n.classBreakInfos.map(C)},a.field2={field:l.field,normalizationField:l.normalizationField,classBreakInfos:l.classBreakInfos.map(C)},e.authoringInfo=a}function I(e){return c(e).then(function(e){var r=e.field1,a=e.field2,n=e.renderer,l=e.numClasses,i=e.focus,s=e.colors,t=n.clone();if(t.valueExpression=h(r,a,r.classBreakInfos,a.classBreakInfos),g(t.uniqueValueInfos,l,i),s){var u=o.createColors(s,s.length);t.uniqueValueInfos.forEach(function(e,r){return f.applyColorToSymbol(e.symbol,u[r])})}return M(t,e),t})}function F(e){return m(e).then(function(e){var r=e.layer,a=e.classificationMethod,n=e.field1,l=e.field2,s=e.numClasses,t=e.view,u=[o.getClassBreaks({layer:r,classificationMethod:a,field:n.field,normalizationField:n.normalizationField,normalizationType:n.normalizationField?"field":null,minValue:n.minValue,maxValue:n.maxValue,analyzeData:!(null!=n.minValue&&null!=n.maxValue),numClasses:s,view:t}),o.getClassBreaks({layer:r,classificationMethod:a,field:l.field,normalizationField:l.normalizationField,normalizationType:l.normalizationField?"field":null,minValue:l.minValue,maxValue:l.maxValue,analyzeData:!(null!=l.minValue&&null!=l.maxValue),numClasses:s,view:t})];return i.all(u).then(function(r){var a=r[0],n=r[1];return a&&n?b(e,a.result,n.result):i.reject(o.createError("relationship-renderer:error","error when calculating class breaks"))})})}Object.defineProperty(r,"__esModule",{value:!0});var L=["equal-interval","natural-breaks","quantile"],E=["HH","HL","LH","LL"],V={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},H={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},C=function(e){return{minValue:e.minValue,maxValue:e.maxValue}};r.updateRenderer=I,r.createRenderer=F});