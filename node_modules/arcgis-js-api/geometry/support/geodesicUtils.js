// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/object","../../core/Error","../../core/Logger","../../core/unitUtils","../Point","../Polygon","../Polyline","../SpatialReference"],function(e,a,t,r,n,i,s,f,o,h){function l(e){if(!e||!e.isGeographic)return null;if(e.wkid){var a=D[e.wkid];if(a)return a}if(e.wkt){var t=S.exec(e.wkt);if(!t||2!==t.length)return null;var r=t[1].split(",");if(!r||3!==r.length)return null;var n=parseFloat(r[1]),i=parseFloat(r[2]);if(isNaN(n)||isNaN(i))return null;return{a:n,f:0===i?0:1/i}}return null}function p(e){return"b"in e&&"eSq"in e&&"radius"in e}function c(e){var a=l(e||q);if(p(a))return a;var r=a.a*(1-a.f);return t.assign(a,{b:r,eSq:1-Math.pow(r/a.a,2),radius:(2*a.a+r)/3})}function u(e,a,t){var r,n=c(t),i=n.a,s=n.eSq,f=Math.sqrt(s),o=Math.sin(a[1]*R),h=i*a[0]*R;if(s>0){r=i*((1-s)*(o/(1-s*(o*o))-1/(2*f)*Math.log((1-f*o)/(1+f*o))))*.5}else r=i*o;return e[0]=h,e[1]=r,e}function g(e){return null!==l(e)}function M(e,a){if(e.some(function(e){return!g(e.spatialReference)}))throw w.error("invalid spatialreference: the input geometries spatialreference is not supported"),new r("geodesic-areas:invalid-spatial-reference","the input geometries spatial reference is not supported");for(var t=[],n=0;n<e.length;n++){var s=e[n],f=s.spatialReference,o=c(f).radius,h=o*b;t.push(v(s,h))}for(var l=[],p=[0,0],M=[0,0],d=0;d<t.length;d++){for(var y=t[d],m=y.rings,f=y.spatialReference,R=0,q=0;q<m.length;q++){var S=m[q];u(p,S[0],f),u(M,S[S.length-1],f);for(var D=M[0]*p[1]-p[0]*M[1],P=0;P<S.length-1;P++)u(p,S[P+1],f),u(M,S[P],f),D+=M[0]*p[1]-p[0]*M[1];R+=D}R=i.convertUnit(R,"square-meters",a),l.push(R/-2)}return l}function d(e,a){var t=e,n=e;if(!t&&!n)throw w.error("invalid geometry type: the input geometries type is not supported"),new r("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(t?t.some(function(e){return!g(e.spatialReference)}):n.some(function(e){return!g(e.spatialReference)}))throw w.error("invalid spatialreference: the input geometries spatialreference is not supported"),new r("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");for(var s=[],f=0;f<e.length;f++){for(var o=e[f],h=o.spatialReference,l="polyline"===o.type?o.paths:o.rings,p=0,c=0;c<l.length;c++){for(var u=l[c],M=0,d=1;d<u.length;d++){var v=u[d-1][0]*R,y=u[d][0]*R,q=u[d-1][1]*R,S=u[d][1]*R;if(q!==S||v!==y){M+=m(q,v,S,y,h).geodesicDistance}}p+=M}p=i.convertUnit(p,"meters",a),s.push(p)}return s}function v(e,a){if("polyline"!==e.type&&"polygon"!==e.type)throw w.error("invalid geometry: the input geometry is neither polyline nor polygon"),new r("geodesic-densify:invalid-geometry","the input geometry is neither polyline nor polygon");if(!g(e.spatialReference))throw w.error("invalid spatialreference: the input geometry spatialreference is not supported"),new r("geodesic-densify:invalid-spatial-reference","the input geometry spatial reference is not supported");var t=e.spatialReference,n=c(t).radius,i=n/1e4;a<i&&(a=i);for(var s="polyline"===e.type?e.paths:e.rings,h=[],l=0,p=s;l<p.length;l++){var u=p[l],M=[];h.push(M),M.push([u[0][0],u[0][1]]);for(var d=u[0][0]*R,v=u[0][1]*R,q=void 0,S=void 0,b=0;b<u.length-1;b++)if(q=u[b+1][0]*R,S=u[b+1][1]*R,d!==q||v!==S){var D=m(v,d,S,q,t),P=D.azimuth,x=D.geodesicDistance,N=x/a;if(N>1){for(var k=1;k<=N-1;k++){var z=k*a,G=y(v,d,P,z,t);M.push([G.x,G.y])}var U=(x+Math.floor(N-1)*a)/2,j=y(v,d,P,U,t);M.push([j.x,j.y])}var I=y(v,d,P,x,t);M.push([I.x,I.y]),d=I.x*R,v=I.y*R}}return"polyline"===e.type?new o({paths:h,spatialReference:t}):new f({rings:h,spatialReference:t})}function y(e,a,t,r,n){for(var i,f,o,h,l=c(n),p=l.a,u=l.b,g=l.f,M=Math.sin(t),d=Math.cos(t),v=(1-g)*Math.tan(e),y=1/Math.sqrt(1+v*v),m=v*y,w=Math.atan2(v,d),S=y*M,b=S*S,D=1-b,P=D*(p*p-u*u)/(u*u),x=1+P/16384*(4096+P*(P*(320-175*P)-768)),N=P/1024*(256+P*(P*(74-47*P)-128)),k=r/(u*x),z=2*Math.PI;Math.abs(k-z)>1e-12;)o=Math.cos(2*w+k),i=Math.sin(k),f=Math.cos(k),h=N*i*(o+N/4*(f*(2*o*o-1)-N/6*o*(4*i*i-3)*(4*o*o-3))),z=k,k=r/(u*x)+h;var G=m*i-y*f*d,U=Math.atan2(m*f+y*i*d,(1-g)*Math.sqrt(b+G*G)),j=Math.atan2(i*M,y*f-m*i*d),I=g/16*D*(4+g*(4-3*D));return new s((a+(j-(1-I)*g*S*(k+I*i*(o+I*f*(2*o*o-1)))))/R,U/R,n||q)}function m(e,a,t,r,n){var i,s,f,o,h,l,p,u,g,M,d=c(n),v=d.a,y=d.b,m=d.f,w=d.radius,R=r-a,q=Math.atan((1-m)*Math.tan(e)),S=Math.atan((1-m)*Math.tan(t)),b=Math.sin(q),D=Math.cos(q),P=Math.sin(S),x=Math.cos(S),N=1e3,k=R;do{if(p=Math.sin(k),u=Math.cos(k),0===(f=Math.sqrt(x*p*(x*p)+(D*P-b*x*u)*(D*P-b*x*u))))return{geodesicDistance:0};h=b*P+D*x*u,l=Math.atan2(f,h),g=D*x*p/f,s=1-g*g,o=h-2*b*P/s,isNaN(o)&&(o=0),M=m/16*s*(4+m*(4-3*s)),i=k,k=R+(1-M)*m*g*(l+M*f*(o+M*h*(2*o*o-1)))}while(Math.abs(k-i)>1e-12&&--N>0);if(0===N){var z=w,G=Math.acos(Math.sin(e)*Math.sin(t)+Math.cos(e)*Math.cos(t)*Math.cos(r-a))*z,U=r-a,j=Math.sin(U)*Math.cos(t),I=Math.cos(e)*Math.sin(t)-Math.sin(e)*Math.cos(t)*Math.cos(U);return{azimuth:Math.atan2(j,I),geodesicDistance:G}}var L=s*(v*v-y*y)/(y*y),A=1+L/16384*(4096+L*(L*(320-175*L)-768)),E=L/1024*(256+L*(L*(74-47*L)-128)),F=E*f*(o+E/4*(h*(2*o*o-1)-E/6*o*(4*f*f-3)*(4*o*o-3))),O=y*A*(l-F);return{azimuth:Math.atan2(x*Math.sin(k),D*P-b*x*Math.cos(k)),geodesicDistance:O,reverseAzimuth:Math.atan2(D*Math.sin(k),D*P*Math.cos(k)-b*x)}}Object.defineProperty(a,"__esModule",{value:!0});var w=n.getLogger("esri.geometry.support.geodesicUtils"),R=Math.PI/180,q=h.WGS84,S=/SPHEROID\[([^\]]+)]/i,b=.0015696101447650193,D={4326:{a:6378137,f:1/298.257223563},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:1737400,f:0},104904:{a:3393400,f:.005207166853303471},104905:{a:3396190,f:.005886007555525457},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:.09796243445941462},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:.022927344575296365},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0}};a.isSupported=g,a.geodesicAreas=M,a.geodesicLengths=d,a.geodesicDensify=v,a.directGeodeticSolver=y,a.inverseGeodeticSolver=m});