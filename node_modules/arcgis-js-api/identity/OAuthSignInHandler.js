// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["./Credential","../core/domUtils","../core/has","../core/lang","../core/Error","../core/urlUtils","dijit/Dialog","dijit/registry","dojo/Deferred","dojo/dom-attr","dojo/i18n!./nls/identity","dojo/io-query","dijit/form/Button"],function(e,t,r,i,o,n,s,a,d,l,u,c){return{_oAuthIntervalId:0,_oAuthDialogContent:"<div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>{oAuthInfo}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>{invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='dijitDialogPaneActionBar'><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdSubmit\"'>{lblOk}</button><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdCancel\"'>{lblCancel}</button></div>",setOAuthRedirectionHandler:function(e){this._oAuthRedirectFunc=e},oAuthSignIn:function(e,r,i,o){var n=this._oAuthDfd=new d;n.resUrl_=e,n.sinfo_=r,n.oinfo_=i;var s=!o||!1!==o.oAuthPopupConfirmation;if(!i.popup||!s)return this._doOAuthSignIn(e,r,i),n.promise;this._nls||(this._nls=u),this.oAuthDialog||(this.oAuthDialog=this._createOAuthDialog());var a=this.oAuthDialog,c=o&&o.error,h=o&&o.token;return t.hide(a.errMsg_),c&&c.details&&403==c.details.httpStatus&&h&&(l.set(a.errMsg_,"innerHTML",this._nls.forbidden),t.show(a.errMsg_)),l.set(a.serverLink_,{title:r.server,innerHTML:-1!==r.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":r.server}),a.show(),n.promise},setOAuthResponseHash:function(t){var r=this._oAuthDfd;if(this._oAuthDfd=null,r&&t){clearInterval(this._oAuthIntervalId),"#"===t.charAt(0)&&(t=t.substring(1));var i=c.queryToObject(t);if(i.error){var n="access_denied"===i.error,s=new o(n?"identity-manager:user-aborted":"identity-manager:authentication-failed",n?"ABORTED":"OAuth: "+i.error+" - "+i.error_description);r.reject(s)}else{var a=r.sinfo_,d=r.oinfo_,l=d._oAuthCred,u=new e({userId:i.username,server:a.server,token:i.access_token,expires:Date.now()+1e3*Number(i.expires_in),ssl:"true"===i.ssl,_oAuthCred:l});l.storage=i.persist?window.localStorage:window.sessionStorage,l.token=u.token,l.expires=u.expires,l.userId=u.userId,l.ssl=u.ssl,l.save(),r.resolve(u)}}},_createOAuthDialog:function(){var e=this._nls,r=i.substitute(e,this._oAuthDialogContent);r=i.substitute({server:"<span class='serverLink' style='word-wrap: break-word;'></span>"},r);var n=new s({title:e.title,content:r,class:"esri-widget esriOAuthSignInDialog esriIdentityDialog",style:"min-width: 18em;",esriIdMgr_:this,execute_:function(){var e=n.esriIdMgr_._oAuthDfd;n.hide_(),n.esriIdMgr_._doOAuthSignIn(e.resUrl_,e.sinfo_,e.oinfo_)},cancel_:function(){var e=n.esriIdMgr_._oAuthDfd;n.esriIdMgr_._oAuthDfd=null,n.hide_();var t=new o("identity-manager:user-aborted","ABORTED");e.reject(t)},hide_:function(){t.hide(n.errMsg_),n.hide(),s._DialogLevelManager.hide(n)}}),d=n.domNode;return n.btnSubmit_=a.byNode(d.getElementsByClassName("esriIdSubmit")[0]),n.btnCancel_=a.byNode(d.getElementsByClassName("esriIdCancel")[0]),n.serverLink_=d.getElementsByClassName("serverLink")[0],n.errMsg_=d.getElementsByClassName("esriErrorMsg")[0],n.connect(n.btnSubmit_,"onClick",n.execute_),n.connect(n.btnCancel_,"onClick",n.onCancel),n.connect(n,"onCancel",n.cancel_),n},_doOAuthSignIn:function(e,t,i){var s=this,a={client_id:i.appId,response_type:"token",state:JSON.stringify({portalUrl:i.portalUrl}),expiration:i.expiration,locale:i.locale,redirect_uri:i.popup?n.makeAbsolute(i.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};i.forceLogin&&(a.force_login=!0);var d=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",l=d+"?"+c.objectToQuery(a);if(i.popup){var u;if(7===r("ie")?(u=window.open(i.popupCallbackUrl,"esriJSAPIOAuth",i.popupWindowFeatures),u.location=l):u=window.open(l,"esriJSAPIOAuth",i.popupWindowFeatures),u)u.focus(),this._oAuthDfd.oAuthWin_=u,this._oAuthIntervalId=setInterval(function(){if(u.closed){clearInterval(s._oAuthIntervalId);var e=s._oAuthDfd;if(e){var t=new o("identity-manager:user-aborted","ABORTED");e.reject(t)}}},500);else{var h=new o("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(h)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:a,authorizeUrl:d,resourceUrl:e,serverInfo:t,oAuthInfo:i}):window.location=l}}});