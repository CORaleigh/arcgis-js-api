// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../languageUtils","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/WhereClause","../../core/promiseUtils","../../layers/FeatureLayer"],function(e,t,r,n,a,i,l,u,o,s,f,c,y,d,m){function p(e,t,r){void 0===r&&(r=null);for(var n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return r}function h(e){if(null===e)return null;var t={type:p(e,"type",""),name:p(e,"name","")};if("range"===t.type)t.range=p(e,"range",[]);else{t.codedValues=[];for(var r=0,n=p(e,"codedValues",[]);r<n.length;r++){var a=n[r];t.codedValues.push({name:p(a,"name",""),code:p(a,"code",null)})}}return t}function g(e){if(null===e)return null;var t={},r=p(e,"wkt",null);null!==r&&(t.wkt=r);var n=p(e,"wkid",null);return null!==n&&(t.wkid=n),t}function v(e){if(null===e)return null;var t={hasZ:p(e,"hasz",!1),hasM:p(e,"hasm",!1)},r=p(e,"spatialreference",null);r&&(t.spatialReference=g(r));var n=p(e,"x",null);if(null!==n)return t.x=n,t.y=p(e,"y",null),t;var a=p(e,"rings",null);if(null!==a)return t.rings=a,t;var i=p(e,"paths",null);if(null!==i)return t.paths=i,t;var l=p(e,"points",null);if(null!==l)return t.points=l,t;for(var u=0,o=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];u<o.length;u++){var s=o[u],f=p(e,s,null);null!==f&&(t[s]=f)}return t}function b(e,t){for(var r=0,n=t;r<n.length;r++){if(n[r]===e)return!0}return!1}function F(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==b(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==l.isArray(e.layerDefinition.fields)&&(!1!==l.isArray(e.featureSet.features)&&void 0)))))}function w(e){"async"===e.mode&&(e.functions.featuresetbyid=function(t,r){return e.standardFunctionAsync(t,r,function(e,t,r){if(l.pcCheck(r,2,4),r[0]instanceof a){var n=l.toString(r[1]),i=l.defaultUndefined(r[2],null),u=l.toBoolean(l.defaultUndefined(r[3],!0));if(null===i&&(i=["*"]),!1===l.isArray(i))throw new Error("Invalid Parameter");return r[0].featureSetById(n,u,i)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(t,r){return e.standardFunctionAsync(t,r,function(e,r,n){l.pcCheck(n,2,4);var a=l.toString(n[0]),u=l.toString(n[1]),o=l.defaultUndefined(n[2],null),s=l.toBoolean(l.defaultUndefined(n[3],!0));if(null===o&&(o=["*"]),!1===l.isArray(o))throw new Error("Invalid Parameter");if(t.services&&t.services.portal)return i.constructFeatureSetFromPortalItem(a,u,t.spatialReference,o,s,t.services.portal,t.lrucache);throw new Error("Portal is required")})},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"4"}),e.functions.featuresetbyname=function(t,r){return e.standardFunctionAsync(t,r,function(e,t,r){if(l.pcCheck(r,2,4),r[0]instanceof a){var n=l.toString(r[1]),i=l.defaultUndefined(r[2],null),u=l.toBoolean(l.defaultUndefined(r[3],!0));if(null===i&&(i=["*"]),!1===l.isArray(i))throw new Error("Invalid Parameter");return r[0].featureSetByName(n,u,i)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,function(e,n,a){l.pcCheck(a,1,1);var i=a[0],u={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(l.isString(i))i=JSON.parse(i),void 0!==i.layerDefinition?(u.layerDefinition=i.layerDefinition,u.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(u.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(u.featureSet.features=i.features,u.featureSet.geometryType=i.geometryType,u.layerDefinition.geometryType=u.featureSet.geometryType,u.layerDefinition.objectIdField=i.objectIdFieldName,u.layerDefinition.typeIdField=i.typeIdFieldName,u.layerDefinition.fields=i.fields,i.spatialReference&&(u.layerDefinition.spatialReference=i.spatialReference));else{if(!(a[0]instanceof r))throw new Error("Invalid Parameter");i=JSON.parse(a[0].castToText());var o=p(i,"layerdefinition");if(null!==o){u.layerDefinition.geometryType=p(o,"geometrytype",""),u.featureSet.geometryType=u.layerDefinition.geometryType,u.layerDefinition.objectIdField=p(o,"objectidfield",""),u.layerDefinition.typeIdField=p(o,"typeidfield","");var s=p(o,"spatialreference",null);s&&(u.layerDefinition.spatialReference=g(s));for(var c=0,y=p(o,"fields",[]);c<y.length;c++){var d=y[c],m={name:p(d,"name",""),alias:p(d,"alias",""),type:p(d,"type",""),nullable:p(d,"nullable",!0),editable:p(d,"editable",!0),length:p(d,"length",null),domain:h(p(d,"domain"))};u.layerDefinition.fields.push(m)}var b=p(i,"featureset",null);if(b){for(var w={},D=0,S=u.layerDefinition.fields;D<S.length;D++){var I=S[D];w[I.name.toLowerCase()]=I.name}for(var x=0,A=p(b,"features",[]);x<A.length;x++){var C=A[x],T={},k=p(C,"attributes",{});for(var I in k)T[w[I.toLowerCase()]]=k[I];u.featureSet.features.push({attributes:T,geometry:v(p(C,"geometry",null))})}}}else{u.layerDefinition.geometryType=p(i,"geometrytype",""),u.featureSet.geometryType=u.layerDefinition.geometryType,u.layerDefinition.objectIdField=p(i,"objectidfieldname",""),u.layerDefinition.typeIdField=p(i,"typeidfieldname","");var s=p(i,"spatialreference",null);s&&(u.layerDefinition.spatialReference=g(s));for(var P=0,z=p(i,"fields",[]);P<z.length;P++){var d=z[P],m={name:p(d,"name",""),alias:p(d,"alias",""),type:p(d,"type",""),nullable:p(d,"nullable",!0),editable:p(d,"editable",!0),length:p(d,"length",null),domain:h(p(d,"domain"))};u.layerDefinition.fields.push(m)}for(var w={},j=0,R=u.layerDefinition.fields;j<R.length;j++){var I=R[j];w[I.name.toLowerCase()]=I.name}for(var E=0,N=p(i,"features",[]);E<N.length;E++){var C=N[E],T={},k=p(C,"attributes",{});for(var I in k)T[w[I.toLowerCase()]]=k[I];u.featureSet.features.push({attributes:T,geometry:v(p(C,"geometry",null))})}}}if(!1===F(u))throw new Error("Invalid Parameter");return f.create(u,t.spatialReference)})},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,r){return e.standardFunctionAsync(t,r,function(r,n,a){if(l.pcCheck(a,2,2),l.isFeatureSet(a[0])){var i=y.create(a[1]),o=i.getVariables();if(o.length>0){for(var s=[],f=0;f<o.length;f++){var c={name:o[f]};s.push(e.evaluateIdentifier(t,c))}return d.all(s).then(function(e){for(var t={},r=0;r<o.length;r++)t[o[r]]=e[r];return i.setVariablesDictionary(t),new u({parentfeatureset:a[0],whereclause:i})})}return d.resolve(new u({parentfeatureset:a[0],whereclause:i}))}return e.failDefferred("Filter cannot accept this parameter type")})},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,r){return e.standardFunctionAsync(t,r,function(t,r,n){if(l.pcCheck(n,2,2),l.isFeatureSet(n[0])){var a=new c(n[1]);return d.resolve(new o({parentfeatureset:n[0],orderbyclause:a}))}return e.failDefferred("Order cannot accept this parameter type")})},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,r){return e.standardFunctionAsync(t,r,function(t,r,n){return l.pcCheck(n,2,2),l.isFeatureSet(n[0])?d.resolve(new s({parentfeatureset:n[0],topnum:n[1]})):l.isArray(n[0])?l.toNumber(n[1])>=n[0].length?n[0].slice(0):n[0].slice(0,l.toNumber(n[1])):l.isImmutableArray(n[0])?l.toNumber(n[1])>=n[0].length()?n[0].slice(0):n[0].slice(0,l.toNumber(n[1])):e.failDefferred("Top cannot accept this parameter type")})},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,r){return e.standardFunctionAsync(t,r,function(e,t,r){return l.pcCheck(r,1,1),l.isFeatureSet(r[0])?r[0].first(e.progressTracker).then(function(e){if(null!==e){var t=n.createFromGraphicLikeObject(e.geometry,e.attributes,r[0]);t._underlyingGraphic=e,e=t}return e}):l.isArray(r[0])?0===r[0].length?d.resolve(null):d.resolve(r[0][0]):l.isImmutableArray(r[0])?0===r[0].length()?d.resolve(null):d.resolve(r[0].get(0)):null})},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,a){return e.standardFunctionAsync(t,a,function(e,a,u){l.pcCheck(u,1,2);var o={minsize:-1,maxsize:-1,types:null};if(u.length>1)if(u[1]instanceof r){if(u[1].hasField("minsize")&&(o.minsize=l.toNumber(u[1].field("minsize"))),u[1].hasField("maxsize")&&(o.maxsize=l.toNumber(u[1].field("maxsize"))),u[1].hasField("types")){var s=l.toStringArray(u[1].field("types"),!1);s.length>0&&(o.types=s)}}else if(null!==u[1])throw new Error("Invalid Parameter");if(u[0]instanceof n){var f=u[0]._layer;return f instanceof m&&(f=i.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache)),null===f?[]:!1===l.isFeatureSet(f)?[]:f.load().then(function(){return f.queryAttachments(u[0].field(f.objectIdField),o.minsize,o.maxsize,o.types)})}if(null===u[0])return[];throw new Error("Invalid Parameter")})},e.signatures.push({name:"attachments",min:"1",max:"2"}))}Object.defineProperty(t,"__esModule",{value:!0}),t.registerFunctions=w});