// COPYRIGHT © 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","dojo/number","../moment","./FunctionWrapper","./ImmutableArray","./ImmutablePathArray","./ImmutablePointArray","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../geometry/support/coordsUtils"],function(e,n,r,t,i,u,a,o,l,f,s,c,d,g,m){function h(e,n,r){if(""===n)return e;if(null===n)return e;if(void 0===n)return e;if(n===r)return e;if(n===r)return e;do{e=e.replace(n,r)}while(-1!==e.indexOf(n));return e}function v(e){return e instanceof ie||e instanceof i||e instanceof ue}function p(e){return!!x(e)||(!!N(e)||(!!_(e)||(!!S(e)||(null===e||(e===n.voidOperation||"number"==typeof e)))))}function y(e,n){return void 0===e?n:e}function x(e){return"string"==typeof e||e instanceof String}function S(e){return"boolean"==typeof e}function N(e){return"number"==typeof e}function O(e){return e instanceof Array}function T(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureset.support.FeatureSet"===e.declaredRootClass)}function R(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureSetCollection"===e.declaredRootClass)}function b(e){return e instanceof u}function _(e){return e instanceof Date}function C(e,n,r){if(e.length<n||e.length>r)throw new Error("Function called with wrong number of Parameters")}function I(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?r:3&r|8).toString(16)})}function M(e,n){return!1===isNaN(e)?void 0===n||null===n||""===n?e.toString():(n=h(n,"‰",""),n=h(n,"¤",""),r.format(e,{pattern:n})):e.toString()}function w(e,n){var r=t(e);return void 0===n||null===n||""===n?r.format():r.format(A(n))}function A(e){return e.replace(/(LTS)|L|l/g,function(e){return"["+e+"]"})}function F(e,n,r){switch(r){case">":return e>n;case"<":return e<n;case">=":return e>=n;case"<=":return e<=n}return!1}function j(e,r,t){if(null===e){if(null===r||r===n.voidOperation)return F(null,null,t);if(N(r))return F(0,r,t);if(x(r))return F(0,J(r),t);if(S(r))return F(0,J(r),t);if(_(r))return F(0,r.getTime(),t)}if(e===n.voidOperation){if(null===r||r===n.voidOperation)return F(null,null,t);if(N(r))return F(0,r,t);if(x(r))return F(0,J(r),t);if(S(r))return F(0,J(r),t);if(_(r))return F(0,r.getTime(),t)}else if(N(e)){if(N(r))return F(e,r,t);if(S(r))return F(e,J(r),t);if(null===r||r===n.voidOperation)return F(e,0,t);if(x(r))return F(e,J(r),t);if(_(r))return F(e,r.getTime(),t)}else if(x(e)){if(x(r))return F(k(e),k(r),t);if(_(r))return F(J(e),r.getTime(),t);if(N(r))return F(J(e),r,t);if(null===r||r===n.voidOperation)return F(J(e),0,t);if(S(r))return F(J(e),J(r),t)}else if(_(e)){if(_(r))return F(e,r,t);if(null===r||r===n.voidOperation)return F(e.getTime(),0,t);if(N(r))return F(e.getTime(),r,t);if(S(r))return F(e.getTime(),J(r),t);if(x(r))return F(e.getTime(),J(r),t)}else if(S(e)){if(S(r))return F(e,r,t);if(N(r))return F(J(e),J(r),t);if(_(r))return F(J(e),r.getTime(),t);if(null===r||r===n.voidOperation)return F(J(e),0,t);if(x(r))return F(J(e),J(r),t)}return!!Z(e,r)&&("<="===t||">="===t)}function Z(e,r){if(e===r)return!0;if(null===e&&r===n.voidOperation||null===r&&e===n.voidOperation)return!0;if(_(e)&&_(r))return e.getTime()===r.getTime();if(e instanceof a)return e.equalityTest(r);if(e instanceof o)return e.equalityTest(r);if(e instanceof c&&r instanceof c){var t=void 0,i=void 0;if(t=e.cache._arcadeCacheId,i=r.cache._arcadeCacheId,void 0!==t&&null!==t)return t===i}if(void 0!==e&&void 0!==r&&null!==e&&null!==r&&"object"==typeof e&&"object"==typeof r){if(e._arcadeCacheId===r._arcadeCacheId&&void 0!==e._arcadeCacheId&&null!==e._arcadeCacheId)return!0;if(e._underlyingGraphic===r._underlyingGraphic&&void 0!==e._underlyingGraphic&&null!==e._underlyingGraphic)return!0}return!1}function k(e,r){if(x(e))return e;if(null===e)return"";if(N(e))return M(e,r);if(S(e))return e.toString();if(_(e))return w(e,r);if(e instanceof f)return JSON.stringify(e.toJSON());if(O(e)){for(var t=[],i=0;i<e.length;i++)t[i]=E(e[i]);return"["+t.join(",")+"]"}if(e instanceof u){for(var t=[],i=0;i<e.length();i++)t[i]=E(e.get(i));return"["+t.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():v(e)?"object, Function":(n.voidOperation,"")}function D(e){var n=[];if(!1===O(e))return null;if(e instanceof u){for(var r=0;r<e.length();r++)n[r]=J(e.get(r));return n}for(var r=0;r<e.length;r++)n[r]=J(e[r]);return n}function P(e,r){if(x(e))return e;if(null===e)return"";if(N(e))return M(e,r);if(S(e))return e.toString();if(_(e))return w(e,r);if(e instanceof f)return e instanceof l?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+H(e.spatialReference)+"}":H(e.toJSON(),function(e,n){return e.key===n.key?0:"spatialReference"===e.key?1:"spatialReference"===n.key?-1:e.key<n.key?-1:e.key>n.key?1:0});if(O(e)){for(var t=[],i=0;i<e.length;i++)t[i]=E(e[i]);return"["+t.join(",")+"]"}if(e instanceof u){for(var t=[],i=0;i<e.length();i++)t[i]=E(e.get(i));return"["+t.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():v(e)?"object, Function":(n.voidOperation,"")}function E(e){if(null===e)return"null";if(S(e)||N(e)||x(e))return JSON.stringify(e);if(e instanceof f)return P(e);if(e instanceof u)return P(e);if(e instanceof Array)return P(e);if(e instanceof Date)return JSON.stringify(w(e,""));if(null!==e&&"object"==typeof e){if(void 0!==e.castToText)return e.castToText()}else if(e===n.voidOperation)return"null";return"null"}function J(e,t){return N(e)?e:null===e?0:""===e?0:_(e)?NaN:S(e)?e?1:0:O(e)?NaN:""===e?NaN:void 0===e?NaN:void 0!==t&&x(e)?(t=h(t,"‰",""),t=h(t,"¤",""),r.parse(e,{pattern:t})):e===n.voidOperation?0:Number(e)}function z(e,n){if(_(e))return e;if(x(e)){var r=t(e,[void 0===n||null===n||""===n?t.ISO_8601:n]);if(r.isValid())return r.toDate()}return null}function V(e,n){if(_(e))return t(e);if(x(e)){var r=t(e,[void 0===n||null===n||""===n?t.ISO_8601:n]);if(r.isValid())return r}return null}function G(e){return S(e)?e:x(e)?"true"===(e=e.toLowerCase()):!!N(e)&&(0!==e&&!isNaN(e))}function L(e,n){return null===e||void 0===e?null:(null!==e.spatialReference&&void 0!==e.spatialReference||(e.spatialReference=n),e)}function U(e){return null===e?null:e instanceof c?"NaN"===e.x||null===e.x||isNaN(e.x)?null:e:e instanceof d?0===e.rings.length?null:e:e instanceof g?0===e.paths.length?null:e:e instanceof s?0===e.points.length?null:e:e instanceof l?"NaN"===e.xmin||null===e.xmin||isNaN(e.xmin)?null:e:null}function q(e,n){if(!e)return null;if(!e.domain)return null;var r=null;n="string"===e.field.type||"esriFieldTypeString"===e.field.type?k(n):J(n);for(var t=0;t<e.domain.codedValues.length;t++){var i=e.domain.codedValues[t];i.code===n&&(r=i)}return null===r?null:r.name}function B(e,n){if(!e)return null;if(!e.domain)return null;var r=null;n=k(n);for(var t=0;t<e.domain.codedValues.length;t++){var i=e.domain.codedValues[t];i.name===n&&(r=i)}return null===r?null:r.code}function K(e,n,r,t){if(void 0===r&&(r=null),!n)return null;if(!n.fields)return null;for(var i=null,u=0;u<n.fields.length;u++){var a=n.fields[u];a.name.toLowerCase()===e.toString().toLowerCase()&&(i=a)}if(null===i)return null;var o,l;return t||(t=r&&n.typeIdField&&r._field(n.typeIdField)),null!=t&&n.types.some(function(e){return e.id===t&&(o=e.domains&&e.domains[i.name],o&&"inherited"===o.type&&(o=W(i.name,n),l=!0),!0)}),l||o||(o=W(e,n)),{field:i,domain:o}}function W(e,n){var r;return n.fields.some(function(n){return n.name===e&&(r=n.domain),!!r}),r}function H(e,n){n||(n={}),"function"==typeof n&&(n={cmp:n});var r="boolean"==typeof n.cycles&&n.cycles,t=n.cmp&&function(e){return function(n){return function(r,t){var i={key:r,value:n[r]},u={key:t,value:n[t]};return e(i,u)}}}(n.cmp),i=[];return function e(n){if(n&&n.toJSON&&"function"==typeof n.toJSON&&(n=n.toJSON()),void 0!==n){if("number"==typeof n)return isFinite(n)?""+n:"null";if("object"!=typeof n)return JSON.stringify(n);var u,a;if(Array.isArray(n)){for(a="[",u=0;u<n.length;u++)u&&(a+=","),a+=e(n[u])||"null";return a+"]"}if(null===n)return"null";if(-1!==i.indexOf(n)){if(r)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var o=i.push(n)-1,l=Object.keys(n).sort(t&&t(n));for(a="",u=0;u<l.length;u++){var f=l[u],s=e(n[f]);s&&(a&&(a+=","),a+=JSON.stringify(f)+":"+s)}return i.splice(o,1),"{"+a+"}"}}(e)}function Q(e){if(null===e)return null;for(var n=[],r=0,t=e;r<t.length;r++){var i=t[r];i&&i.declaredClass&&"esri.arcade.Feature"===i.declaredClass?n.push(i.geometry()):n.push(i)}return n}function X(e,n){if(!(n instanceof c))throw new Error("Invalid Argument");e.push(n.hasZ?n.hasM?[n.x,n.y,n.z,n.m]:[n.x,n.y,n.z]:[n.x,n.y])}function Y(e,n){if(O(e)||b(e)){var r=!1,t=!1,i=[],u=n;if(O(e)){for(var a=0,l=e;a<l.length;a++){var f=l[a];X(i,f)}i.length>0&&(u=e[0].spatialReference,r=e[0].hasZ,t=e[0].hasM)}else if(e instanceof o)i=e._elements,i.length>0&&(r=e._hasZ,t=e._hasM,u=e.get(0).spatialReference);else{if(!b(e))throw new Error("Invalid Argument");for(var s=0,c=e.toArray();s<c.length;s++){var f=c[s];X(i,f)}i.length>0&&(u=e.get(0).spatialReference,r=!0===e.get(0).hasZ,t=!0===e.get(0).hasM)}if(0===i.length)return null;return!1===m.isClockwise(i,t,r)&&(i=i.slice(0).reverse()),new d({rings:[i],spatialReference:u,hasZ:r,hasM:t})}return e}function $(e,n){if(O(e)||b(e)){var r=!1,t=!1,i=[],u=n;if(O(e)){for(var a=0,l=e;a<l.length;a++){var f=l[a];X(i,f)}i.length>0&&(u=e[0].spatialReference,r=!0===e[0].hasZ,t=!0===e[0].hasM)}else if(e instanceof o)i=e._elements,i.length>0&&(r=e._hasZ,t=e._hasM,u=e.get(0).spatialReference);else if(b(e)){for(var s=0,c=e.toArray();s<c.length;s++){var f=c[s];X(i,f)}i.length>0&&(u=e.get(0).spatialReference,r=!0===e.get(0).hasZ,t=!0===e.get(0).hasM)}return 0===i.length?null:new g({paths:[i],spatialReference:u,hasZ:r,hasM:t})}return e}function ee(e,n){if(O(e)||b(e)){var r=!1,t=!1,i=[],u=n;if(O(e)){for(var a=0,l=e;a<l.length;a++){var f=l[a];X(i,f)}i.length>0&&(u=e[0].spatialReference,r=!0===e[0].hasZ,t=!0===e[0].hasM)}else if(e instanceof o)i=e._elements,i.length>0&&(r=e._hasZ,t=e._hasM,u=e.get(0).spatialReference);else if(b(e)){for(var c=0,d=e.toArray();c<d.length;c++){var f=d[c];X(i,f)}i.length>0&&(u=e.get(0).spatialReference,r=!0===e.get(0).hasZ,t=!0===e.get(0).hasM)}return 0===i.length?null:new s({points:i,spatialReference:u,hasZ:r,hasM:t})}return e}function ne(e,n){void 0===n&&(n=!1);var r=[];if(null===e)return r;if(!0===O(e)){for(var t=0;t<e.length;t++){var i=k(e[t]);""===i&&!0!==n||r.push(i)}return r}if(e instanceof u){for(var t=0;t<e.length();t++){var i=k(e.get(t));""===i&&!0!==n||r.push(i)}return r}if(p(e)){var i=k(e);return""===i&&!0!==n||r.push(i),r}return[]}Object.defineProperty(n,"__esModule",{value:!0});var re=function(){function e(e){this.value=e}return e}();n.ReturnResultE=re;var te=function(){function e(e){this.value=e}return e}();n.ImplicitResultE=te;var ie=function(){function e(e){this.fn=e}return e}();n.NativeFunctionE=ie;var ue=function(){function e(e){this.fn=e}return e}();n.SizzleFunctionE=ue,n.NativeFunction=ie,n.ImplicitResult=te,n.ReturnResult=re,n.SizzleFunction=ue,n.voidOperation={type:"VOID"},n.breakResult={type:"BREAK"},n.continueResult={type:"CONTINUE"},n.multiReplace=h,n.isFunctionParameter=v,n.isSimpleType=p,n.defaultUndefined=y,n.isString=x,n.isBoolean=S,n.isNumber=N,n.isArray=O,n.isFeatureSet=T,n.isFeatureSetCollection=R,n.isImmutableArray=b,n.isDate=_,n.pcCheck=C,n.generateUUID=I,n.formatNumber=M,n.formatDate=w,n.standardiseDateFormat=A,n.greaterThanLessThan=j,n.equalityTest=Z,n.toString=k,n.toNumberArray=D,n.toStringExplicit=P,n.toNumber=J,n.toDate=z,n.toDateM=V,n.toBoolean=G,n.fixSpatialReference=L,n.fixNullGeometry=U,n.getDomainValue=q,n.getDomainCode=B,n.getDomain=K,n.stableStringify=H,n.autoCastFeatureToGeometry=Q,n.autoCastArrayOfPointsToPolygon=Y,n.autoCastArrayOfPointsToPolyline=$,n.autoCastArrayOfPointsToMultiPoint=ee,n.toStringArray=ne});