(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define(["require", "exports", "../../shim/global", "../../has/has"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var global_1 = require("../../shim/global");
    var has_1 = require("../../has/has");
    var trailingSlash = new RegExp(/\/$/);
    var leadingSlash = new RegExp(/^\//);
    function stripBase(base, path) {
        if (base === '/') {
            return path;
        }
        if (path.indexOf(base) === 0) {
            return path.slice(base.length - 1);
        }
        return '/';
    }
    var StateHistory = /** @class */ (function () {
        function StateHistory(_a) {
            var onChange = _a.onChange, _b = _a.window, window = _b === void 0 ? global_1.default.window : _b, base = _a.base;
            var _this = this;
            this._onChange = function () {
                var pathName = _this._window.location.pathname.replace(/\/$/, '');
                var value = stripBase(_this._base, pathName + _this._window.location.search);
                if (_this._current === value) {
                    return;
                }
                _this._current = value;
                _this._onChangeFunction(_this._current);
            };
            if (!base) {
                base = has_1.default('public-path') ? "" + has_1.default('public-path') : '/';
            }
            if (/(#|\?)/.test(base)) {
                throw new TypeError("base must not contain '#' or '?'");
            }
            this._onChangeFunction = onChange;
            this._window = window;
            this._base = base;
            if (!trailingSlash.test(this._base)) {
                this._base = this._base + "/";
            }
            if (!leadingSlash.test(this._base)) {
                this._base = "/" + this._base;
            }
            this._window.addEventListener('popstate', this._onChange, false);
            this._onChange();
        }
        StateHistory.prototype.prefix = function (path) {
            if (path[0] === '#') {
                path = path.slice(1);
            }
            if (path[0] === '/') {
                path = path.slice(1);
            }
            return "" + this._base + path;
        };
        StateHistory.prototype.set = function (path) {
            this._window.history.pushState({}, '', this.prefix(stripBase(this._base, path)));
            this._onChange();
        };
        Object.defineProperty(StateHistory.prototype, "current", {
            get: function () {
                return this._current;
            },
            enumerable: true,
            configurable: true
        });
        return StateHistory;
    }());
    exports.StateHistory = StateHistory;
    exports.default = StateHistory;
});
//# sourceMappingURL=StateHistory.js.map