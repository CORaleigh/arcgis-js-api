(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define(["require", "exports", "tslib", "../core/QueuingEvented", "./history/HashHistory"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var tslib_1 = require("tslib");
    var QueuingEvented_1 = require("../core/QueuingEvented");
    var HashHistory_1 = require("./history/HashHistory");
    var PARAM = '__PARAM__';
    var paramRegExp = new RegExp(/^{.+}$/);
    var ROUTE_SEGMENT_SCORE = 7;
    var DYNAMIC_SEGMENT_PENALTY = 2;
    function matchingParams(_a, _b) {
        var previousParams = _a.params;
        var params = _b.params;
        var matching = Object.keys(previousParams).every(function (key) { return previousParams[key] === params[key]; });
        if (!matching) {
            return false;
        }
        return Object.keys(params).every(function (key) { return previousParams[key] === params[key]; });
    }
    var Router = /** @class */ (function (_super) {
        tslib_1.__extends(Router, _super);
        function Router(config, options) {
            if (options === void 0) { options = {}; }
            var _this = _super.call(this) || this;
            _this._routes = [];
            _this._outletMap = Object.create(null);
            _this._matchedOutlets = Object.create(null);
            _this._currentParams = {};
            _this._currentQueryParams = {};
            /**
             * Called on change of the route by the the registered history manager. Matches the path against
             * the registered outlets.
             *
             * @param requestedPath The path of the requested route
             */
            _this._onChange = function (requestedPath) {
                requestedPath = _this._stripLeadingSlash(requestedPath);
                var previousMatchedOutlets = _this._matchedOutlets;
                _this._matchedOutlets = Object.create(null);
                var _a = tslib_1.__read(requestedPath.split('?'), 2), path = _a[0], queryParamString = _a[1];
                _this._currentQueryParams = _this._getQueryParams(queryParamString);
                var segments = path.split('/');
                var routeConfigs = _this._routes.map(function (route) { return ({
                    route: route,
                    segments: tslib_1.__spread(segments),
                    parent: undefined,
                    params: {}
                }); });
                var routeConfig;
                var matchedRoutes = [];
                var _loop_1 = function () {
                    var route = routeConfig.route, parent_1 = routeConfig.parent, segments_1 = routeConfig.segments, params = routeConfig.params;
                    var segmentIndex = 0;
                    var type = 'index';
                    var paramIndex = 0;
                    var routeMatch = true;
                    if (segments_1.length < route.segments.length) {
                        routeMatch = false;
                    }
                    else {
                        while (segments_1.length > 0) {
                            if (route.segments[segmentIndex] === undefined) {
                                type = 'partial';
                                break;
                            }
                            var segment = segments_1.shift();
                            if (route.segments[segmentIndex] === PARAM) {
                                params[route.params[paramIndex++]] = segment;
                                _this._currentParams = tslib_1.__assign({}, _this._currentParams, params);
                            }
                            else if (route.segments[segmentIndex] !== segment) {
                                routeMatch = false;
                                break;
                            }
                            segmentIndex++;
                        }
                    }
                    if (routeMatch) {
                        routeConfig.type = type;
                        matchedRoutes.push({ route: route, parent: parent_1, type: type, params: params, segments: [] });
                        if (segments_1.length) {
                            routeConfigs = tslib_1.__spread(routeConfigs, route.children.map(function (childRoute) { return ({
                                route: childRoute,
                                segments: tslib_1.__spread(segments_1),
                                parent: routeConfig,
                                type: type,
                                params: tslib_1.__assign({}, params)
                            }); }));
                        }
                    }
                };
                while ((routeConfig = routeConfigs.pop())) {
                    _loop_1();
                }
                var matchedOutletName = undefined;
                var matchedRoute = matchedRoutes.reduce(function (match, matchedRoute) {
                    if (!match) {
                        return matchedRoute;
                    }
                    if (match.route.score > matchedRoute.route.score) {
                        return match;
                    }
                    return matchedRoute;
                }, undefined);
                if (matchedRoute) {
                    if (matchedRoute.type === 'partial') {
                        matchedRoute.type = 'error';
                    }
                    matchedOutletName = matchedRoute.route.outlet;
                    var _loop_2 = function () {
                        var type = matchedRoute.type, params = matchedRoute.params, parent_2 = matchedRoute.parent, route = matchedRoute.route;
                        var matchedOutlet = {
                            id: route.outlet,
                            queryParams: _this._currentQueryParams,
                            params: params,
                            type: type,
                            isError: function () { return type === 'error'; },
                            isExact: function () { return type === 'index'; }
                        };
                        var previousMatchedOutlet = previousMatchedOutlets[route.outlet];
                        _this._matchedOutlets[route.outlet] = matchedOutlet;
                        if (!previousMatchedOutlet || !matchingParams(previousMatchedOutlet, matchedOutlet)) {
                            _this.emit({ type: 'outlet', outlet: matchedOutlet, action: 'enter' });
                        }
                        matchedRoute = parent_2;
                    };
                    while (matchedRoute) {
                        _loop_2();
                    }
                }
                else {
                    _this._matchedOutlets.errorOutlet = {
                        id: 'errorOutlet',
                        queryParams: {},
                        params: {},
                        isError: function () { return true; },
                        isExact: function () { return false; },
                        type: 'error'
                    };
                }
                var previousMatchedOutletKeys = Object.keys(previousMatchedOutlets);
                for (var i = 0; i < previousMatchedOutletKeys.length; i++) {
                    var key = previousMatchedOutletKeys[i];
                    var matchedOutlet = _this._matchedOutlets[key];
                    if (!matchedOutlet || !matchingParams(previousMatchedOutlets[key], matchedOutlet)) {
                        _this.emit({ type: 'outlet', outlet: previousMatchedOutlets[key], action: 'exit' });
                    }
                }
                _this.emit({
                    type: 'nav',
                    outlet: matchedOutletName,
                    context: matchedOutletName ? _this._matchedOutlets[matchedOutletName] : undefined
                });
            };
            var _a = options.HistoryManager, HistoryManager = _a === void 0 ? HashHistory_1.HashHistory : _a, base = options.base, window = options.window;
            _this._register(config);
            _this._history = new HistoryManager({ onChange: _this._onChange, base: base, window: window });
            if (_this._matchedOutlets.errorOutlet && _this._defaultOutlet) {
                var path = _this.link(_this._defaultOutlet);
                if (path) {
                    _this.setPath(path);
                }
            }
            return _this;
        }
        /**
         * Sets the path against the registered history manager
         *
         * @param path The path to set on the history manager
         */
        Router.prototype.setPath = function (path) {
            this._history.set(path);
        };
        /**
         * Generate a link for a given outlet identifier and optional params.
         *
         * @param outlet The outlet to generate a link for
         * @param params Optional Params for the generated link
         */
        Router.prototype.link = function (outlet, params) {
            if (params === void 0) { params = {}; }
            var _a = this, _outletMap = _a._outletMap, _currentParams = _a._currentParams, _currentQueryParams = _a._currentQueryParams;
            var route = _outletMap[outlet];
            if (route === undefined) {
                return;
            }
            var linkPath = route.fullPath;
            if (route.fullQueryParams.length > 0) {
                var queryString = route.fullQueryParams.reduce(function (queryParamString, param, index) {
                    if (index > 0) {
                        return queryParamString + "&" + param + "={" + param + "}";
                    }
                    return "?" + param + "={" + param + "}";
                }, '');
                linkPath = "" + linkPath + queryString;
            }
            params = tslib_1.__assign({}, route.defaultParams, _currentQueryParams, _currentParams, params);
            if (Object.keys(params).length === 0 && route.fullParams.length > 0) {
                return undefined;
            }
            var fullParams = tslib_1.__spread(route.fullParams, route.fullQueryParams);
            for (var i = 0; i < fullParams.length; i++) {
                var param = fullParams[i];
                if (params[param]) {
                    linkPath = linkPath.replace("{" + param + "}", params[param]);
                }
                else {
                    return undefined;
                }
            }
            return this._history.prefix(linkPath);
        };
        /**
         * Returns the outlet context for the outlet identifier if one has been matched
         *
         * @param outletIdentifier The outlet identifer
         */
        Router.prototype.getOutlet = function (outletIdentifier) {
            return this._matchedOutlets[outletIdentifier];
        };
        Object.defineProperty(Router.prototype, "currentParams", {
            /**
             * Returns all the params for the current matched outlets
             */
            get: function () {
                return this._currentParams;
            },
            enumerable: true,
            configurable: true
        });
        /**
         * Strips the leading slash on a path if one exists
         *
         * @param path The path to strip a leading slash
         */
        Router.prototype._stripLeadingSlash = function (path) {
            if (path[0] === '/') {
                return path.slice(1);
            }
            return path;
        };
        /**
         * Registers the routing configuration
         *
         * @param config The configuration
         * @param routes The routes
         * @param parentRoute The parent route
         */
        Router.prototype._register = function (config, routes, parentRoute) {
            routes = routes ? routes : this._routes;
            for (var i = 0; i < config.length; i++) {
                var _a = config[i], path = _a.path, outlet = _a.outlet, children = _a.children, _b = _a.defaultRoute, defaultRoute = _b === void 0 ? false : _b, _c = _a.defaultParams, defaultParams = _c === void 0 ? {} : _c;
                var _d = tslib_1.__read(path.split('?'), 2), parsedPath = _d[0], queryParamString = _d[1];
                var queryParams = [];
                parsedPath = this._stripLeadingSlash(parsedPath);
                var segments = parsedPath.split('/');
                var route = {
                    params: [],
                    outlet: outlet,
                    path: parsedPath,
                    segments: segments,
                    defaultParams: parentRoute ? tslib_1.__assign({}, parentRoute.defaultParams, defaultParams) : defaultParams,
                    children: [],
                    fullPath: parentRoute ? parentRoute.fullPath + "/" + parsedPath : parsedPath,
                    fullParams: [],
                    fullQueryParams: [],
                    score: parentRoute ? parentRoute.score : 0
                };
                if (defaultRoute) {
                    this._defaultOutlet = outlet;
                }
                for (var i_1 = 0; i_1 < segments.length; i_1++) {
                    var segment = segments[i_1];
                    route.score += ROUTE_SEGMENT_SCORE;
                    if (paramRegExp.test(segment)) {
                        route.score -= DYNAMIC_SEGMENT_PENALTY;
                        route.params.push(segment.replace('{', '').replace('}', ''));
                        segments[i_1] = PARAM;
                    }
                }
                if (queryParamString) {
                    queryParams = queryParamString.split('&').map(function (queryParam) {
                        return queryParam.replace('{', '').replace('}', '');
                    });
                }
                route.fullQueryParams = parentRoute ? tslib_1.__spread(parentRoute.fullQueryParams, queryParams) : queryParams;
                route.fullParams = parentRoute ? tslib_1.__spread(parentRoute.fullParams, route.params) : route.params;
                if (children && children.length > 0) {
                    this._register(children, route.children, route);
                }
                this._outletMap[outlet] = route;
                routes.push(route);
            }
        };
        /**
         * Returns an object of query params
         *
         * @param queryParamString The string of query params, e.g `paramOne=one&paramTwo=two`
         */
        Router.prototype._getQueryParams = function (queryParamString) {
            var queryParams = {};
            if (queryParamString) {
                var queryParameters = queryParamString.split('&');
                for (var i = 0; i < queryParameters.length; i++) {
                    var _a = tslib_1.__read(queryParameters[i].split('='), 2), key = _a[0], value = _a[1];
                    queryParams[key] = value;
                }
            }
            return queryParams;
        };
        return Router;
    }(QueuingEvented_1.default));
    exports.Router = Router;
    exports.default = Router;
});
//# sourceMappingURL=Router.js.map