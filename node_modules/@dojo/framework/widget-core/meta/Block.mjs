import { Destroyable } from '../../core/Destroyable';
import Map from '../../shim/Map';
import WeakMap from '../../shim/WeakMap';
export class Block extends Destroyable {
    constructor(properties) {
        super();
        this._moduleMap = new WeakMap();
        this._invalidate = properties.invalidate;
    }
    run(module) {
        const decoratedModule = (...args) => {
            let valueMap = this._moduleMap.get(module);
            if (!valueMap) {
                valueMap = new Map();
                this._moduleMap.set(module, valueMap);
            }
            const argsString = JSON.stringify(args);
            const value = valueMap.get(argsString);
            if (value !== undefined) {
                return value;
            }
            valueMap.set(argsString, null);
            const result = module(...args);
            if (typeof result.then === 'function') {
                result.then((result) => {
                    valueMap.set(argsString, result);
                    this._invalidate();
                });
                return null;
            }
            else {
                valueMap.set(argsString, result);
            }
            return result;
        };
        return decoratedModule;
    }
}
export default Block;
//# sourceMappingURL=Block.mjs.map