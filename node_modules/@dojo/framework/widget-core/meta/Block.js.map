{"version":3,"file":"Block.js","sourceRoot":"","sources":["Block.ts"],"names":[],"mappings":";;;;;;;;;;;;IAAA,sDAAqD;IACrD,sCAAiC;IACjC,8CAAyC;IAGzC;QAA2B,iCAAW;QAIrC,eAAY,UAAgC;YAA5C,YACC,iBAAO,SAEP;YANO,gBAAU,GAAG,IAAI,iBAAO,EAAiB,CAAC;YAKjD,KAAI,CAAC,WAAW,GAAG,UAAU,CAAC,UAAU,CAAC;;QAC1C,CAAC;QAEM,mBAAG,GAAV,UAA+B,MAAS;YAAxC,iBA2BC;YA1BA,IAAM,eAAe,GAAQ;gBAAC,cAAc;qBAAd,UAAc,EAAd,qBAAc,EAAd,IAAc;oBAAd,yBAAc;;gBAC3C,IAAI,QAAQ,GAAG,KAAI,CAAC,UAAU,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;gBAC3C,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACf,QAAQ,GAAG,IAAI,aAAG,EAAE,CAAC;oBACrB,KAAI,CAAC,UAAU,CAAC,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;gBACvC,CAAC;gBACD,IAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;gBACxC,IAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;gBACvC,EAAE,CAAC,CAAC,KAAK,KAAK,SAAS,CAAC,CAAC,CAAC;oBACzB,MAAM,CAAC,KAAK,CAAC;gBACd,CAAC;gBAED,QAAQ,CAAC,GAAG,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;gBAC/B,IAAM,MAAM,GAAG,MAAM,gCAAI,IAAI,EAAC,CAAC;gBAC/B,EAAE,CAAC,CAAC,OAAO,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,CAAC,CAAC;oBACvC,MAAM,CAAC,IAAI,CAAC,UAAC,MAAW;wBACvB,QAAQ,CAAC,GAAG,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;wBACjC,KAAI,CAAC,WAAW,EAAE,CAAC;oBACpB,CAAC,CAAC,CAAC;oBACH,MAAM,CAAC,IAAI,CAAC;gBACb,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACP,QAAQ,CAAC,GAAG,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;gBAClC,CAAC;gBACD,MAAM,CAAC,MAAM,CAAC;YACf,CAAC,CAAC;YACF,MAAM,CAAC,eAAoB,CAAC;QAC7B,CAAC;QACF,YAAC;IAAD,CAAC,AArCD,CAA2B,yBAAW,GAqCrC;IArCY,sBAAK;IAuClB,kBAAe,KAAK,CAAC","sourcesContent":["import { Destroyable } from '../../core/Destroyable';\nimport Map from '../../shim/Map';\nimport WeakMap from '../../shim/WeakMap';\nimport { WidgetMetaProperties, MetaBase } from '../interfaces';\n\nexport class Block extends Destroyable implements MetaBase {\n\tprivate _moduleMap = new WeakMap<Function, any>();\n\tprivate _invalidate: () => void;\n\n\tconstructor(properties: WidgetMetaProperties) {\n\t\tsuper();\n\t\tthis._invalidate = properties.invalidate;\n\t}\n\n\tpublic run<T extends Function>(module: T): T {\n\t\tconst decoratedModule: any = (...args: any[]) => {\n\t\t\tlet valueMap = this._moduleMap.get(module);\n\t\t\tif (!valueMap) {\n\t\t\t\tvalueMap = new Map();\n\t\t\t\tthis._moduleMap.set(module, valueMap);\n\t\t\t}\n\t\t\tconst argsString = JSON.stringify(args);\n\t\t\tconst value = valueMap.get(argsString);\n\t\t\tif (value !== undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tvalueMap.set(argsString, null);\n\t\t\tconst result = module(...args);\n\t\t\tif (typeof result.then === 'function') {\n\t\t\t\tresult.then((result: any) => {\n\t\t\t\t\tvalueMap.set(argsString, result);\n\t\t\t\t\tthis._invalidate();\n\t\t\t\t});\n\t\t\t\treturn null;\n\t\t\t} else {\n\t\t\t\tvalueMap.set(argsString, result);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t\treturn decoratedModule as T;\n\t}\n}\n\nexport default Block;\n"]}