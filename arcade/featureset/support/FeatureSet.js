// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../support/FeatureSetIterator","../support/IdSet","../support/shared","../support/WhereClause","./ArcadeExporter","./BigDataFeatureSetIterator","./cache","./Guid","./stats","../../../core/promiseUtils","../../../geometry/geometryEngineAsync","../../../geometry/SpatialReference"],function(e,t,r,n,a,i,s,o,u,c,p,l,h,d){var f=0;return function(){function e(e){this._bigdCacheId=c.raw(),this.recentlyUsedQueries=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=a.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache)}return e.prototype.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},e.prototype._hasMemorySource=function(){return!0},e.prototype.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},e.prototype.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},e.prototype._ensureLoaded=function(){return this.load()},e.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=l.create(function(t,r){if(!0===e._parent.loaded)return e._initialiseFeatureSet(),void t(e);e._parent.load().then(function(){try{e._initialiseFeatureSet(),t(e)}catch(e){r(e)}},r)})),this._loadPromise},e.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.spatialReference=new d({wkid:4326}),this.geometryType=a.layerGeometryEsriConstants.point)},e.prototype.getField=function(e,t){var r;return t=t||this.fields,t&&(e=e.toLowerCase(),t.some(function(t){return t&&t.name.toLowerCase()===e&&(r=t),!!r})),r},e.prototype._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},e.prototype._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},e.prototype._checkCancelled=function(e){if(null!==e&&e.isCanceled())throw new Error("Operation has been cancelled.")},e.prototype._canDoAggregates=function(e,t,r,n,a){return null===this._parent?l.resolve(!1):this._parent._canDoAggregates(e,t,r,n,a)},e.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,n,a,i,s){return null===this._parent?l.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,r,n,a,i,s)},e.prototype._getAgregagtePhysicalPage=function(e,t,r){return null===this._parent?l.reject(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,r)},e.prototype.databaseType=function(){var e=this;if(this._databaseType===a.FeatureServiceDatabaseType.NotEvaluated){if(null!==u.applicationCache){var t=u.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==t)return t}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;var r=[{thetype:a.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:a.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:a.FeatureServiceDatabaseType.Standardised,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}],n={hasbeenset:!1,dp:null};return n.dp=l.create(function(t,a){null!==u.applicationCache&&!1===n.hasbeenset&&(u.applicationCache.setDatabaseType(e._cacheableFeatureSetSourceKey(),n.dp),n.hasbeenset=!0),e._getDatabaseTypeImpl(r,0).then(function(r){e._databaseType=r,t(e._databaseType)},function(t){null!==u.applicationCache&&u.applicationCache.clearDatabaseType(e._cacheableFeatureSetSourceKey()),a(t)})}),this._databaseTypeProbed=n.dp,!1===n.hasbeenset&&(u.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),n.dp),n.hasbeenset=!0),this._databaseTypeProbed}return l.resolve(this._databaseType)},e.prototype._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},e.prototype._getDatabaseTypeImpl=function(e,t){var r=this;return t>=e.length?l.resolve(a.FeatureServiceDatabaseType.Standardised):this._runDatabaseProbe(e[t].testwhere).then(function(n){return!0===n?e[t].thetype:r._getDatabaseTypeImpl(e,t+1)})},e.prototype._runDatabaseProbe=function(e){return l.reject(new Error("Not Implemented"))},e.prototype._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},e.prototype._isInFeatureSet=function(e){return a.IdState.Unknown},e.prototype._getSet=function(e){throw new Error("Not implemented in abstract class")},e.prototype._getFeature=function(e,t,r){var n=this;try{return this._checkCancelled(r),void 0!==this._featureFromCache(t)?l.resolve(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),r).then(function(){return n._checkCancelled(r),void 0!==n._featureFromCache(t)?n._featureFromCache(t):l.reject(new Error("Feature Not Found"))})}catch(e){return l.reject(e)}},e.prototype._getFeatures=function(e,t,r,n){return l.resolve("success")},e.prototype._getFilteredSet=function(e,t,r,n,a){throw new Error("Not implemented in abstract class")},e.prototype._refineSetBlock=function(e,t,r){var n=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate(),r))return this._expandPagedSet(e,this._maxQueryRate(),0,0,r).then(function(){return n._refineSetBlock(e,t,r)});this._checkCancelled(r);var a=e._candidates.length;this._refineKnowns(e,t);var i=a-e._candidates.length;return 0===e._candidates.length?l.resolve(e):i>=t?l.resolve(e):this._refineIfParentKnown(e,t-i,r).then(function(){if(n._checkCancelled(r),n._refineKnowns(e,t-i),(i=a-e._candidates.length)<t&&e._candidates.length>0){var s=t-i,o=n._prepareFetchAndRefineSet(e._candidates,n._maxQueryRate());return n._fetchAndRefineFeatures(o,o.length>s?s:e._candidates.length,r).then(function(){return n._checkCancelled(r),n._refineKnowns(e,t-i),e})}return e})}catch(e){return l.reject(e)}},e.prototype._fetchAndRefineFeatures=function(e,t,r){return null},e.prototype._prepareFetchAndRefineSet=function(e,t){for(var r=[],n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&r.push(e[n]);return r},e.prototype._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},e.prototype._refineKnowns=function(e,t){var r=0,n=null,i=[];t=this._maxQueryRate();for(var s=0;s<e._candidates.length&&"GETPAGES"!==e._candidates[s];s++){var o=!1,u=this._candidateIdTransform(e._candidates[s]);u!==e._candidates[s]&&(o=!0);var c=this._isInFeatureSet(u);if(c===a.IdState.InFeatureSet)!0===o?e._known.indexOf(u)<0&&(e._known.push(u),r+=1):(e._known.push(e._candidates[s]),r+=1),null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s});else if(c===a.IdState.NotInFeatureSet)null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s}),r+=1;else if(c===a.IdState.Unknown&&(r+=1,!0===e._ordered))break;if(r>=t)break}null!==n&&i.push(n);for(var p=i.length-1;p>=0;p--)e._candidates.splice(i[p].start,i[p].end-i[p].start+1)},e.prototype._refineIfParentKnown=function(e,t,r){var a=this,i=new n([],[],e._ordered,null);return i._candidates=e._candidates.slice(0),this._parent._refineSetBlock(i,t,r).then(function(t){return a._parent._transformSetWithIdChanges(e),t})},e.prototype._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},e.prototype._transformSetWithIdChanges=function(e){this._parent._transformSetWithIdChanges(e)},e.prototype._checkIfNeedToExpandKnownPage=function(e,t,r){if(null===e.pagesDefinition)return!1;for(var n=0,a=e._lastFetchedIndex;a<e._known.length;a++){if("GETPAGES"===e._known[a])return!0;if(void 0===this._featureCache[e._known[a]]&&(n+=1)>=t)break}return!1},e.prototype._checkIfNeedToExpandCandidatePage=function(e,t,r){if(null===e.pagesDefinition)return!1;for(var n=0,a=0;a<e._candidates.length;a++){if("GETPAGES"===e._candidates[a])return!0;if((n+=1)>=t)break}return!1},e.prototype._expandPagedSet=function(e,t,r,n,a){return null===this._parent?l.reject(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,r,n,a)},e.prototype._expandPagedSetFeatureSet=function(e,t,r,n,a){var i=this;return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(n=1),0===n&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(n=2),0===n?l.resolve("finished"):this._getPage(e,n,a).then(function(n){return r+n<t?i._expandPagedSet(e,t,r+n,0,a):"success"})},e.prototype._getPage=function(e,t,r){var n=this,a=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){a.length=a.length-1;for(var i=0,s=0;s<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+s>=e.pagesDefinition.internal.set.length);s++)a[a.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+s],i++;e.pagesDefinition.resultOffset+=e.pagesDefinition.resultRecordCount;var o=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(o=!0),!1===o&&a.push("GETPAGES"),l.resolve(i)}return this._getPhysicalPage(e,t,r).then(function(){return n._getPage(e,t,r)})},e.prototype._getPhysicalPage=function(e,t,r){return null},e.prototype._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},e.prototype._first=function(e){var t=this;return this.shouldBeResolvedAsBigData()?this.expressAsArcadeScript().then(function(e){try{e.script+="\n return first("+e.featuresetIdentifier+")";var r=t.sourceGeoAnalyticsProvider();return null===r?l.reject(new Error("No Big Data Provider")):r.executeScript(e.script,e.globals,e.spatialReference).then(function(e){return e})}catch(e){return l.reject(e)}}):this.iterator(e).next()},e.prototype.first=function(e){return this._first(e)},e.prototype._qStat=function(e,t,r,n){var a=this;return this.shouldBeResolvedAsBigData()?this._qBigDataStat(e,t,r,n):this._ensureLoaded().then(function(){return a._stat(e,t,"",null,null,r,n).then(function(i){return!1===i.calculated?a._manualStat(e,t,r,n).then(function(e){return e.result}):i.result})})},e.prototype._manualStat=function(e,t,r,n){switch(e.toLowerCase()){case"count":return p.count(this,n).then(function(e){return{calculated:!0,result:e}});case"distinct":return p.distinct(this,t,r).then(function(e){return{calculated:!0,result:e}});case"avg":case"mean":return p.mean(this,t,n).then(function(e){return{calculated:!0,result:e}});case"stdev":return p.stdev(this,t,n).then(function(e){return{calculated:!0,result:e}});case"variance":return p.variance(this,t,n).then(function(e){return{calculated:!0,result:e}});case"sum":return p.sum(this,t,n).then(function(e){return{calculated:!0,result:e}});case"min":return p.min(this,t,n).then(function(e){return{calculated:!0,result:e}});case"max":return p.max(this,t,n).then(function(e){return{calculated:!0,result:e}});default:return l.resolve({calculated:!0,result:0})}},e.prototype._stat=function(e,t,r,n,a,i,s){var o=this;return this._parent._stat(e,t,r,n,a,i,s).then(function(u){return!1===u.calculated?null===a&&""===r&&null===n?o._manualStat(e,t,i,s):{calculated:!1}:u})},e.prototype._unionAllGeomSelf=function(e){var t=this;if(this.shouldBeResolvedAsBigData())return this._qBigDataStat("geometryunion",null,-1,this._defaultTracker(e));var r=this.iterator(this._defaultTracker(e)),n=[];return l.create(function(e,a){t._unionShapeInBatches(n,r,e,a)})},e.prototype._unionAllGeom=function(e){var t=this;return l.create(function(r,n){var a=t.iterator(t._defaultTracker(e)),i=[];t._unionShapeInBatches(i,a,r,n)})},e.prototype._unionShapeInBatches=function(e,t,r,n){var a=this;t.next().then(function(i){try{null!==i&&null!==i.geometry&&e.push(i.geometry),e.length>30||null===i&&e.length>1?h.union(e).then(function(s){try{null===i?r(s):(e=[s],a._unionShapeInBatches(e,t,r,n))}catch(e){n(e)}},n):null===i?r(1===e.length?e[0]:null):a._unionShapeInBatches(e,t,r,n)}catch(e){n(e)}},n)},e.prototype.iterator=function(e){return this.shouldBeResolvedAsBigData()?new o(this,e):new r(this,e)},e.prototype.intersection=function(t,r){return void 0===r&&(r=!1),e._featuresetFunctions.intersection.bind(this)(t,r)},e.prototype.difference=function(t,r,n){return void 0===r&&(r=!1),void 0===n&&(n=!0),e._featuresetFunctions.difference.bind(this)(t,r,n)},e.prototype.symmetricDifference=function(t,r,n){return void 0===r&&(r=!1),void 0===n&&(n=!0),e._featuresetFunctions.symmetricDifference.bind(this)(t,r,n)},e.prototype.morphShape=function(t,r,n,a){return void 0===n&&(n="unknown"),void 0===a&&(a=null),e._featuresetFunctions.morphShape.bind(this)(t,r,n,a)},e.prototype.morphShapeAndAttributes=function(t,r,n){return void 0===n&&(n="unknown"),e._featuresetFunctions.morphShapeAndAttributes.bind(this)(t,r,n)},e.prototype.union=function(t,r){return void 0===r&&(r=!1),e._featuresetFunctions.union.bind(this)(t,r)},e.prototype.intersects=function(t){return e._featuresetFunctions.intersects.bind(this)(t)},e.prototype.envelopeIntersects=function(t){return e._featuresetFunctions.envelopeIntersects.bind(this)(t)},e.prototype.contains=function(t){return e._featuresetFunctions.contains.bind(this)(t)},e.prototype.overlaps=function(t){return e._featuresetFunctions.overlaps.bind(this)(t)},e.prototype.relate=function(t,r){return e._featuresetFunctions.relate.bind(this)(t,r)},e.prototype.within=function(t){return e._featuresetFunctions.within.bind(this)(t)},e.prototype.touches=function(t){return e._featuresetFunctions.touches.bind(this)(t)},e.prototype.top=function(t){return e._featuresetFunctions.top.bind(this)(t)},e.prototype.crosses=function(t){return e._featuresetFunctions.crosses.bind(this)(t)},e.prototype.buffer=function(t,r,n,a){return void 0===a&&(a=!0),e._featuresetFunctions.buffer.bind(this)(t,r,n,a)},e.prototype.filter=function(t,r){return void 0===r&&(r=null),e._featuresetFunctions.filter.bind(this)(t,r)},e.prototype.orderBy=function(t){return e._featuresetFunctions.orderBy.bind(this)(t)},e.prototype.dissolve=function(t,r){return e._featuresetFunctions.dissolve.bind(this)(t,r)},e.prototype.summarize=function(t,r){return e._featuresetFunctions.summarize.bind(this)(t,r)},e.prototype.summarizeBins=function(t,r,n,a){return e._featuresetFunctions.summarizeBins.bind(this)(t,r,n,a)},e.prototype.aggregate=function(t,r){return e._featuresetFunctions.aggregate.bind(this)(t,r)},e.prototype.reduce=function(e,t,r){var n=this;return void 0===t&&(t=null),l.create(function(a,i){n._reduceImpl(n.iterator(n._defaultTracker(r)),e,t,0,a,i,0)})},e.prototype._reduceImpl=function(e,t,r,n,a,i,s){var o=this;try{if(++s>1e3)return void setTimeout(function(){s=0,o._reduceImpl(e,t,r,n,a,i,s)});e.next().then(function(u){try{if(null===u)a(r);else{var c=t(r,u,n,o);l.isThenable(c)?c.then(function(r){o._reduceImpl(e,t,r,n+1,a,i,s)},i):o._reduceImpl(e,t,c,n+1,a,i,s)}}catch(e){i(e)}},i)}catch(e){i(e)}},e.prototype.removeField=function(t){return e._featuresetFunctions.removeField.bind(this)(t)},e.prototype.addField=function(t,r,n){return void 0===n&&(n=null),e._featuresetFunctions.addField.bind(this)(t,r,n)},e.prototype.sumArea=function(e,t,r){void 0===t&&(t=!1);var n=a.convertSquareUnitsToCode(e);return this.shouldBeResolvedAsBigData()?this._qBigDataStat(t?"sumareageodesic":"sumarea",null,n,null):this.reduce(function(e,r){return null===r.geometry?0:t?h.geodesicArea(r.geometry,n).then(function(t){return e+t}):h.planarArea(r.geometry,n).then(function(t){return e+t})},0,r)},e.prototype.sumLength=function(e,t,r){void 0===t&&(t=!1);var n=a.convertLinearUnitsToCode(e);return this.shouldBeResolvedAsBigData()?this._qBigDataStat(t?"sumlengthgeodesic":"sumlength",null,n,null):this.reduce(function(e,r){return null===r.geometry?0:t?h.geodesicLength(r.geometry,n).then(function(t){return e+t}):h.planarLength(r.geometry,n).then(function(t){return e+t})},0,r)},e.prototype._substituteVars=function(e,t){if(null!==t){var r={};for(var n in t)r[n.toLowerCase()]=t[n];e.setVariablesDictionary(r)}},e.prototype.distinct=function(e,t,r,n){void 0===t&&(t=1e3),void 0===r&&(r=null);var a=i.create(e);return this._substituteVars(a,r),this._qStat("distinct",a,t,this._defaultTracker(n))},e.prototype.min=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("min",n,-1,this._defaultTracker(r))},e.prototype.max=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("max",n,-1,this._defaultTracker(r))},e.prototype.avg=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("avg",n,-1,this._defaultTracker(r))},e.prototype.sum=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("sum",n,-1,this._defaultTracker(r))},e.prototype.stdev=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("stdev",n,-1,this._defaultTracker(r))},e.prototype.variance=function(e,t,r){void 0===t&&(t=null);var n=i.create(e);return this._substituteVars(n,t),this._qStat("variance",n,-1,this._defaultTracker(r))},e.prototype.count=function(e){return this._qStat("count",i.create("1"),-1,this._defaultTracker(e))},e.prototype._defaultTracker=function(e){return e||l.createDeferred().promise},e.prototype.forEach=function(e,t){var r=this;return l.create(function(n,a){r._forEachImpl(r.iterator(r._defaultTracker(t)),e,r,n,a,0)})},e.prototype._forEachImpl=function(e,t,r,n,a,i){var s=this;try{if(++i>1e3)return void setTimeout(function(){i=0,s._forEachImpl(e,t,r,n,a,i)},0);e.next().then(function(o){try{if(null===o)n(r);else{var u=t(o);void 0===u||null===u?s._forEachImpl(e,t,r,n,a,i):l.isThenable(u)?u.then(function(){try{s._forEachImpl(e,t,r,n,a,i)}catch(e){a(e)}},a):s._forEachImpl(e,t,r,n,a,i)}}catch(e){a(e)}},a)}catch(e){a(e)}},e.prototype.convertToJSON=function(e){for(var t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}},r=0;r<this.fields.length;r++)t.layerDefinition.fields.push(a.esriFieldToJson(this.fields[r]));return this.reduce(function(e){var r={geometry:e.geometry&&e.geometry.toJSON(),attributes:{}};for(var n in e.attributes)r.attributes[n]=e.attributes[n];return t.featureSet.features.push(r),1},0,e)},e.prototype.canBeBigDataFeatureSet=function(){return this._parent.canBeBigDataFeatureSet()},e.prototype.shouldBeResolvedAsBigData=function(){return this._parent.shouldBeResolvedAsBigData()},e.prototype.expressAsArcadeScript=function(){var e=this;return this._ensureLoaded().then(function(){try{var t={featuresetIdentifier:"",script:"",spatialReference:e.spatialReference,globals:{},functions:{stack:[],lkp:{}},symbols:{syms:{},featuresetsyms:[],symc:0}};t.script=e.expressAsArcadeScriptImpl(t.functions,t.globals,t.symbols);for(var r="",n=0,a=t.functions.stack;n<a.length;n++){r+="\n"+a[n].script}return t.script=r+t.script,t.featuresetIdentifier=t.symbols.featuresetsyms[t.symbols.featuresetsyms.length-1],t}catch(e){return l.reject(e)}})},e.prototype.expressAsArcadeScriptImpl=function(e,t,r){return this._parent.expressAsArcadeScriptImpl(e,t,r)+"\n"+this.arcadeScriptStep(e,t,r)},e.prototype.arcadeScriptStep=function(e,t,r){return""},e.prototype.arcadeAssignNextGlobalIdentifier=function(e){for(var t=!1,r="";!1===t;)f++,r="$g_"+f.toString(),void 0===e.syms[r]&&(t=!0);return r},e.prototype.arcadeAssignNextScriptStepIdentifiers=function(e){for(var t=0===e.featuresetsyms.length?"":e.featuresetsyms[e.featuresetsyms.length-1],r=!1,n="";!1===r;)e.symc++,n="$$c_"+e.symc.toString(),void 0===e.syms[n]&&(r=!0);return e.featuresetsyms.push(n),e.syms[n]=n,{currentFeatureSet:t,newFeatureSet:n}},e.prototype.exportArcadeFunctionAndDependencies=function(e,t,r,n){return s.exportFunctionAsArcade(e,t,r,n)},e.prototype.constructArcadeGeom=function(e,t,r){var n=this.arcadeAssignNextGlobalIdentifier(r);return t[n]={name:n,type:"geometry",params:{value:e}},n},e.prototype._qBigDataStat=function(e,t,r,n){var i=this;return void 0===r&&(r=-1),this.expressAsArcadeScript().then(function(n){try{switch(e.toLowerCase()){case"sumlength":n.script+="\n return length("+n.featuresetIdentifier+","+r.toString()+")";break;case"sumlengthgeodesic":n.script+="\n return lengthgeodetic("+n.featuresetIdentifier+","+r.toString()+")";break;case"sumarea":n.script+="\n return area("+n.featuresetIdentifier+","+r.toString()+")";break;case"sumareageodesic":n.script+="\n return areageodetic("+n.featuresetIdentifier+","+r.toString()+")";break;case"geometryunion":n.script+="\n return union("+n.featuresetIdentifier+")";break;case"count":n.script+="\n return Count("+n.featuresetIdentifier+")";break;case"distinct":n.script+="\n return Distinct("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"avg":case"mean":n.script+="\n return Average("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"stdev":n.script+="\n return Stdev("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"variance":n.script+="\n return Variance("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"sum":n.script+="\n return Sum("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"min":n.script+="\n return Min("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;case"max":n.script+="\n return Max("+n.featuresetIdentifier+',"'+t.toWhereClause(a.FeatureServiceDatabaseType.Standardised)+'");';break;default:n.script="BADSTAT"}var s=i.sourceGeoAnalyticsProvider();return"BADSTAT"===n.script?l.reject(new Error("Stat not supported")):null===s?l.reject(new Error("No Big Data Provider")):s.executeScript(n.script,n.globals,n.spatialReference)}catch(e){return l.reject(e)}})},e.prototype.sourceGeoAnalyticsProvider=function(){return this._parent.sourceGeoAnalyticsProvider()},e.prototype.bigDataCachePipeline=function(e){return"ga_pipeline("+e+",'"+this._bigdCacheId+"')"},e.prototype.castToText=function(){return"object, FeatureSet"},e.prototype.queryAttachments=function(e,t,r,n){return this._parent.queryAttachments(e,t,r,n)},e.prototype.schema=function(){for(var e=[],t=0,r=this.fields;t<r.length;t++){var n=r[t];e.push(a.esriFieldToJson(n))}return{objectIdField:this.objectIdField,typeIdField:this.typeIdField,geometryType:void 0===a.layerGeometryEsriConstants[this.geometryType]?"":a.layerGeometryEsriConstants[this.geometryType],hasZ:this.hasZ,hasM:this.hasM,fields:e}},e.prototype.convertToText=function(e,t){var r=this;return"schema"===e?this._ensureLoaded().then(function(){return JSON.stringify(r.schema)}):"featureset"===e?this._ensureLoaded().then(function(){var e=[];return r.reduce(function(t){var r=t.toJson();return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,e.push(r),1},0,t).then(function(){var t=r.schema();return t.features=e,t.spatialReference=r.spatialReference.toJSON(),JSON.stringify(r.schema)})}):l.resolve(this.castToText())},e._featuresetFunctions={},e._polyfill={table:null},e}()});