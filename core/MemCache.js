// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","./iteratorUtils","./lang","./PooledArray"],function(t,e,i,s,r){var o=function(){function t(t,e,i){this._namespace=t,this._storage=e,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",i&&(this._storage.registerRemoveFunc(this._namespace,i),this._removeFunc=!0)}return Object.defineProperty(t.prototype,"namespace",{get:function(){return this._namespace.slice(0,-1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hitRate",{get:function(){return this._hit/(this._hit+this._miss)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._storage.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSize",{get:function(){return this._storage.maxSize},enumerable:!0,configurable:!0}),t.prototype.resetHitRate=function(){this._hit=this._miss=0},t.prototype.destroy=function(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this)},t.prototype.put=function(t,e,i){this._storage.put(this._namespace+t,e,i)},t.prototype.get=function(t){var e=this._storage.get(this._namespace+t);return void 0===e?++this._miss:++this._hit,e},t.prototype.pop=function(t){var e=this._storage.pop(this._namespace+t);return void 0===e?++this._miss:++this._hit,e},t.prototype.clear=function(){this._storage.clear(this._namespace)},t.prototype.clearAll=function(){this._storage.clearAll()},t.prototype.getStats=function(){return this._storage.getStats()},t.prototype.resetStats=function(){this._storage.resetStats()},t}();return function(t){var e=function(){function t(t){void 0===t&&(t=10485760),this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=[],this._users=new r}return t.prototype.register=function(t){this._users.push(t)},t.prototype.deregister=function(t){this._users.removeUnordered(t)},t.prototype.registerRemoveFunc=function(t,e){this._removeFuncs.push([t,e])},t.prototype.deregisterRemoveFunc=function(t){this._removeFuncs=this._removeFuncs.filter(function(e){return e[0]!==t})},Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSize",{get:function(){return this._maxSize},set:function(t){this._maxSize=Math.max(t,0),this._size>this._maxSize&&this._removeEntries()},enumerable:!0,configurable:!0}),t.prototype.put=function(t,e,i){if(this._db.has(t)){var s=this._db.get(t);this._size-=s.size,this._db.delete(t),this._notifyRemoved(t,s.entry)}return i>this._maxSize?void this._notifyRemoved(t,e):void 0===e?void console.warn("Refusing to cache undefined entry "):!i||i<0?void console.warn("Refusing to cache entry with invalid size "+i):(this._db.set(t,{entry:e,size:i}),this._size+=i,void(this._size>this._maxSize&&this._removeEntries()))},t.prototype.pop=function(t){if(this._db.has(t)){var e=this._db.get(t);return this._size-=e.size,this._db.delete(t),++this._hit,e.entry}++this._miss},t.prototype.get=function(t){var e=this._db.get(t);return void 0===e?void++this._miss:(this._db.delete(t),this._db.set(t,e),++this._hit,e.entry)},t.prototype.getStats=function(){var t=this,e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={};this._db.forEach(function(e,r){t._users.forEach(function(t){var o=t.namespace;if(s.startsWith(r,o)){var n=i[o]||0;return i[o]=n+e.size,!1}})});var r={};this._users.forEach(function(t){var e=t.namespace;if(!isNaN(t.hitRate)&&t.hitRate>0){var s=i[e]||0;i[e]=s,r[e]=Math.round(100*t.hitRate)+"%"}else r[e]="0%"});var o=Object.keys(i);return o.forEach(function(e){return i[e]=i[e]/t._size*100}),o.sort(function(t,e){return i[e]-i[t]}),o.forEach(function(t){return e[t]=Math.round(i[t])+"% / "+r[t]}),e},t.prototype.resetStats=function(){this._hit=this._miss=0,this._users.forEach(function(t){return t.resetHitRate()})},t.prototype.clear=function(t){var e=this;this._db.forEach(function(i,r){s.startsWith(r,t)&&(e._size-=i.size,e._db.delete(r),e._notifyRemoved(r,i.entry))})},t.prototype.clearAll=function(){var t=this;this._db.forEach(function(e,i){t._notifyRemoved(i,e.entry)}),this._size=0,this._db.clear()},t.prototype._getHitRate=function(){return this._hit/(this._hit+this._miss)},t.prototype._notifyRemoved=function(t,e){this._removeFuncs.forEach(function(i){s.startsWith(t,i[0])&&i[1](e)})},t.prototype._removeEntries=function(){var t=this;i.everyMap(this._db,function(e,i){return t._size-=e.size,t._db.delete(i),t._notifyRemoved(i,e.entry),t._size>.9*t.maxSize})},t}();t.Storage=e}(o||(o={})),o});