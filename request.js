// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","dojo/Deferred","dojo/has!host-webworker?./core/workers/request","dojo/io-query","./core/urlUtils","dojo/errors/CancelError","dojo/request/xhr","./config","./core/deferredUtils","./core/Error","./core/global","./core/has","./core/lang","./core/promiseUtils","./core/urlUtils"],function(e,r,t,n,o,s,a,i,l,u,d,c,f,p,h,v,g){function m(e,r){void 0===r&&(r=!1),g.isBlobProtocol(e.url)||g.isDataProtocol(e.url)||!e.content||(e.preventCache&&(e.content["request.preventCache"]=Date.now()),e.url=g.addQueryParameters(e.url,e.content));var t=new Image;e.withCredentials?t.crossOrigin="use-credentials":t.crossOrigin="anonymous";var n=!1,o=function(){n=!0,t.onload=t.onerror=t.onabort=null,t.src=""};return v.create(function(o,s){var a=function(){t.onload=t.onerror=t.onabort=null,r&&URL.revokeObjectURL(this.src),n||s(new Error("Unable to load the resource"))};t.onload=function(){t.onload=t.onerror=t.onabort=null,r&&URL.revokeObjectURL(this.src),n||o(this)},t.onerror=a,t.onabort=a,t.alt="",t.src=e.url},o)}function b(e){var r=new a.Url(e);return(r.host+(r.port?":"+r.port:"")).toLowerCase()}function y(){return j||(j=v.create(function(r){e(["./identity/IdentityManager"],r)}).then(function(e){D=e}))}function O(e){if(e)for(var r in e)if(e[r])return!0;return!1}function q(e,r){var n=!!e.useProxy,o=e.method||"auto";e=t({},e),e.content=e.content||{},e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var a=e.url,i=g.isBlobProtocol(a)||g.isDataProtocol(a);e._token&&(e.content.token=e._token);var u,d=0;i||(u=s.objectToQuery(e.content),d=u.length+a.length+1,p("esri-url-encodes-apostrophe")&&(d=u.replace(/'/g,"%27").length+a.length+1)),e.timeout=null!=e.timeout?e.timeout:P.timeout,e.handleAs=e.handleAs||"json";try{var c=void 0,f=void 0,h=!i&&("post"===o||!!e.body||d>P.maxUrlLength),b=!i&&(n||!!g.getProxyRule(e.url));b||"image"!==e.handleAs||!P.proxyUrl||i||x(e.url)||(e.handleAs="blob"),b&&(p("host-browser")||p("host-webworker"))&&(c=g.getProxyUrl(a),f=c.path,!h&&f.length+1+d>P.maxUrlLength&&(h=!0),c.query&&(e.content=t({},c.query,e.content)),h||(e.preventCache&&(e.content["request.preventCache"]=Date.now(),e.preventCache=!1),e.url=g.addQueryParameters(e.url,e.content),e.content=null),e.url=f+"?"+e.url);var y=e.headers;if(!i){if(!p("host-browser")&&!p("host-webworker")||y&&y.hasOwnProperty("X-Requested-With")||(e.headers=y||{},e.headers["X-Requested-With"]=null),p("host-browser")&&r){var q=e.content&&e.content.token;q&&(r.set?r.set("token",q):r.append("token",q)),e.contentType=!1}if(!e.hasOwnProperty("withCredentials")){var w=b?f:a;if(g.isTrustedServer(w))e.withCredentials=!0;else if(D){var _=D.findServerInfo(w);_&&_.webTierAuth&&(e.withCredentials=!0)}}}return h?("image"===e.handleAs&&(e.handleAs="blob"),e.body?(e.data=r||e.body,e.query=e.content):e.data=e.content,delete e.body,delete e.content,!b&&p("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+Date.now()+A++),l.post(e.url,e)):"image"!==e.handleAs||O(y)?("image"===e.handleAs&&(e.handleAs="blob"),e.query=e.content,delete e.content,l.get(e.url,e)):m(e)}catch(e){return v.reject(e)}}function w(e,r,o,s){function a(e){e._pendingDfd=q(o,d);var r=!!e._pendingDfd.response;(e._pendingDfd.response||e._pendingDfd).then(function(e){if(!r||!e.data)return e;P.proxyUrl&&!h.startsWith(e.url,P.proxyUrl)&&k(e.url);var o=e.getHeader("Content-Type");if(o&&(o=o.toLowerCase(),-1===o.indexOf("text/plain")&&-1===o.indexOf("application/json")))return e;var s,a=e.data;if(a instanceof ArrayBuffer&&a.byteLength<=750)s=new Blob([a]);else{if(!(a instanceof Blob&&a.size<=750))return e;s=a}var i=new n,l=new FileReader;return l.readAsText(s),l.onloadend=function(){if(!l.error)try{var r=JSON.parse(l.result);r.error&&(Object.isExtensible(e)||(e=t({},e)),e._jsonData=r)}catch(e){}i.resolve(e)},i.promise}).then(function(e){return r&&!e._jsonData&&"image"===s.requestOptions.responseType&&e.data instanceof Blob?(r=!1,o.url=URL.createObjectURL(e.data),m(o,!0)):e}).then(function(t){var n=r?t.data:t,o=r?t.getHeader.bind(t):L;if(n){var a=r&&t._jsonData||n;if(a.error||"error"===a.status){var i=h.mixin(new Error,a.error||a);throw i.getHeader=o,i}}e.resolve({data:n,url:s.url,requestOptions:s.requestOptions,getHeader:o}),e._pendingDfd=null}).catch(function(r){var t,n,a,i;if(r&&(t=Number(r.code),n=r.hasOwnProperty("subcode")?Number(r.subcode):null,a=r.messageCode,a=a&&a.toUpperCase(),i=r.response),i&&0===i.status&&P.proxyUrl&&!l&&"post"!==o.method&&i.url&&!h.startsWith(i.url,P.proxyUrl))return g.addProxyRule({proxyUrl:P.proxyUrl,urlPrefix:g.removeFile(g.urlToObject(o.url).path)}),void w(e,!0,o,s);if(403===t&&(4===n||r.message&&r.message.toLowerCase().indexOf("ssl")>-1&&-1===r.message.toLowerCase().indexOf("permission"))){if(!o._ssl)return o._ssl=o._sslFromServer=!0,void w(e,!0,o,s)}else if(u&&"no-prompt"!==o.authMode&&D._errorCodes&&-1!==D._errorCodes.indexOf(t)&&!D._isPublic(o.url)&&(403!==t||S&&-1===S.indexOf(a)&&(null==n||2===n&&o._token)))return void _(e,o,s,C("request:server",r,s));i&&i.status>0&&i.url&&P.proxyUrl&&!h.startsWith(i.url,P.proxyUrl)&&k(i.url),e.reject(C("request:server",r,s)),e._pendingDfd=null})}var i,l=o.body,u=o.useIdentity,d=null,f=l instanceof FormData;(f||l&&l.elements)&&(d=f?l:new FormData(l));var p=!!(-1!==o.url.toLowerCase().indexOf("token=")||o.content&&o.content.token||d&&d.get&&d.get("token")||l&&l.elements&&l.elements.token);if(!r){if(u&&!p&&!o._token&&!D._isPublic(o.url)){var v=function(e){e&&(o._token=e.token,o._ssl=e.ssl)};"immediate"===o.authMode?i=D.getCredential(o.url).then(v):"no-prompt"===o.authMode?i=D.checkSignInStatus(o.url).then(v).catch(function(){}):v(D.findCredential(o.url))}var y=function(e){if(delete o._credential,e){var r=!!o._ssl;e instanceof c?e.details.ssl=r:e.ssl=r}};e.then(function(e){(/\/sharing\/rest\/accounts\/self/i.test(o.url)||/\/sharing\/rest\/portals\/self/i.test(o.url))&&!p&&!o._token&&e.data&&e.data.user&&e.data.user.username&&(g.isTrustedServer(o.url)||P.trustedServers.push(b(o.url)));var r=o._credential;if(r){var t=D.findServerInfo(r.server),n=t&&t.owningSystemUrl,s=void 0;n&&(n=n.replace(/\/?$/,"/sharing"),(s=D.findCredential(n,r.userId))&&-1===D._getIdenticalSvcIdx(n,s)&&s.resources.splice(0,0,n))}return e}).then(y,y)}return i?i.then(function(){e.isCanceled()||a(e)}).catch(function(r){e.reject(r)}):a(e),e.promise}function _(e,r,t,n){e._pendingDfd=D.getCredential(r.url,{error:n,token:r._token}),e._pendingDfd.then(function(n){r._token=n.token,r._credential=n,r._ssl=r._sslFromServer||n.ssl,w(e,!0,r,t)}).catch(function(r){e.reject(r),e._pendingDfd=null})}function C(e,r,t){var n="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:L};if(r instanceof c)return r.details?(r.details=h.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var s=r.response,a=s&&s.getHeader,i=s&&s.status,l=r.message,u=r.getHeader||a;l&&(n=l),u&&(o.getHeader=u),o.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||i,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var d=new c(e,n,o);return r&&"cancel"===r.dojoType&&(d.name="AbortError",d.dojoType="cancel"),d}function x(e){var r=g.getOrigin(e);return!r||h.endsWith(r,".arcgis.com")||g.hasSameOrigin(r,g.appUrl)||-1!==U._corsServers.indexOf(r)||g.isTrustedServer(r)}function k(e){if(!g.isBlobProtocol(e)&&!g.isDataProtocol(e)){var r=g.getOrigin(e);r&&-1===U._corsServers.indexOf(r)&&U._corsServers.push(r)}}function U(e,r){if(o&&f.invokeStaticMessage)return o.execute(e,r);g.isBlobProtocol(e)||g.isDataProtocol(e)||(e=g.normalize(e));var n={url:e,requestOptions:t({},r)},s=g.getInterceptor(e);if(s){if(null!=s.responseData)return v.resolve({data:s.responseData,requestOptions:n.requestOptions,getHeader:L,url:e});if(s.headers&&(n.requestOptions.headers=t({},n.requestOptions.headers,s.headers)),s.query&&(n.requestOptions.query=t({},n.requestOptions.query,s.query)),s.before){var l=s.before(n);if(null!=l)return l instanceof Error||l instanceof c?v.reject(C("request:interceptor",l,n)):v.resolve({data:l,requestOptions:n.requestOptions,getHeader:L,url:n.url})}}var u=t({url:n.url},n.requestOptions);if(u.content=u.query,delete u.query,u.preventCache=!!u.cacheBust,delete u.cacheBust,u.handleAs=u.responseType,delete u.responseType,"array-buffer"===u.handleAs&&(u.handleAs="arraybuffer"),"image"===u.handleAs){if(p("host-webworker")||p("host-node"))return v.reject(C("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n))}else if(g.isDataProtocol(e))return v.reject(C("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+u.handleAs),n));var h=P.useIdentity;"anonymous"===u.authMode&&(h=!1),u.useIdentity=h,u.urlObj=new a.Url(u.url);var m,b=d.makeDeferredCancellingPending();if(n.requestOptions.signal){var O=n.requestOptions.signal;m=function(){b.cancel(C("AbortError",new i("Request canceled"),n))},O.aborted?m():O.addEventListener("abort",m)}return v.resolve().then(function(){if(h&&!D)return y()}).catch(function(){}).then(function(){b.isCanceled()||w(b,!1,u,n)}),b.then(function(e){return n.requestOptions.signal&&n.requestOptions.signal.removeEventListener("abort",m),s&&s.after&&s.after(e),e}).catch(function(e){throw n.requestOptions.signal&&n.requestOptions.signal.removeEventListener("abort",m),e})}var D,j,P=u.request,S=["COM_0056","COM_0057"],A=0,L=function(){return null};return function(e){e._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"]}(U||(U={})),U});